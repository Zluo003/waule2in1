const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B-U_h0BA.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-Bp2hAWdT.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Gt,u as Sr,z as Gs,e as xa,d as ba}from"./react-vendor-BvY2dB7B.js";import{u as Er,l as wa,c as Ce,_ as xs,b as h,e as ya}from"./index-B-U_h0BA.js";import{P as pt,H as us,a as Zt,b as Ds,d as Fs,e as zs,g as ka,R as va,f as Na,h as ja,i as Ia,j as Sa,C as Ea}from"./reactflow-D8v6_Qvs.js";import{C as Ca,L as Ms,S as hr,I as Dr,T as zr,V as Aa}from"./video-CPXLMxBS.js";import{c as Ts}from"./createLucideIcon-CK1cQnin.js";import{X as _a,j as Qs,L as Vs,o as Pr,a as Ta,v as or,U as Lr,b as Ua,N as Ra}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Ts("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Ts("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Ts("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Ts("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Ts("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Ts("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Ts("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ir=Ts("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Ts("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Ts("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Br=Ts("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=Ts("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),za="https://api.waule.com";function Ba(s){const{workflowId:N,isSharedWorkflow:n,isReadOnly:F,onNodeAdd:we,onNodeUpdate:U,onNodeDelete:fe,onNodeMove:Q,onNodesMove:re,onEdgeAdd:K,onEdgeDelete:ce,onGroupsUpdate:Ue,onUserJoin:he}=s,se=t.useRef(null),ae=t.useRef(!1),{token:Ie}=Er(),[ne,ge]=t.useState([]);t.useEffect(()=>{if(!n||!N||!Ie)return;const x=wa(za,{auth:{token:Ie},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return se.current=x,x.on("connect",()=>{ae.current=!0,x.emit("join-workflow",N),x.emit("user:join",{workflowId:N})}),x.on("disconnect",c=>{ae.current=!1}),x.on("connect_error",c=>{}),x.on("node:add",c=>{we==null||we(c.node,c.userId)}),x.on("node:update",c=>{U==null||U(c.nodeId,c.changes,c.userId)}),x.on("node:delete",c=>{fe==null||fe(c.nodeId,c.userId)}),x.on("node:move",c=>{Q==null||Q(c.nodeId,c.position,c.userId)}),x.on("nodes:move",c=>{re==null||re(c.nodes,c.userId)}),x.on("edge:add",c=>{K==null||K(c.edge,c.userId)}),x.on("edge:delete",c=>{ce==null||ce(c.edgeId,c.userId)}),x.on("groups:update",c=>{Ue==null||Ue(c.groups,c.userId)}),x.on("user:join",c=>{he==null||he(c.user)}),x.on("users:online",c=>{ge(c.users)}),()=>{se.current&&(se.current.emit("leave-workflow",N),se.current.disconnect(),se.current=null),ae.current=!1,ge([])}},[N,n,Ie]);const de=t.useCallback(x=>{se.current&&ae.current&&N&&!F&&se.current.emit("node:add",{workflowId:N,node:x})},[N,F]),me=t.useCallback((x,c)=>{se.current&&ae.current&&N&&!F&&se.current.emit("node:update",{workflowId:N,nodeId:x,changes:c})},[N,F]),Ee=t.useCallback(x=>{se.current&&ae.current&&N&&!F&&se.current.emit("node:delete",{workflowId:N,nodeId:x})},[N,F]),Z=t.useCallback((x,c)=>{se.current&&ae.current&&N&&!F&&se.current.emit("node:move",{workflowId:N,nodeId:x,position:c})},[N,F]),z=t.useCallback(x=>{se.current&&ae.current&&N&&!F&&se.current.emit("nodes:move",{workflowId:N,nodes:x})},[N,F]),A=t.useCallback(x=>{se.current&&ae.current&&N&&!F&&se.current.emit("edge:add",{workflowId:N,edge:x})},[N,F]),S=t.useCallback(x=>{se.current&&ae.current&&N&&!F&&se.current.emit("edge:delete",{workflowId:N,edgeId:x})},[N,F]),G=t.useCallback(x=>{se.current&&ae.current&&N&&!F&&se.current.emit("groups:update",{workflowId:N,groups:x})},[N,F]);return{isConnected:ae.current,onlineUsers:ne,emitNodeAdd:de,emitNodeUpdate:me,emitNodeDelete:Ee,emitNodeMove:Z,emitNodesMove:z,emitEdgeAdd:A,emitEdgeDelete:S,emitGroupsUpdate:G}}const Cr=1920,Hr=(s,N=Cr,n=.9)=>new Promise((F,we)=>{const U=new Image,fe=URL.createObjectURL(s);U.onload=()=>{URL.revokeObjectURL(fe);let{width:Q,height:re}=U;if(Q>N||re>N){const he=N/Math.max(Q,re);Q=Math.round(Q*he),re=Math.round(re*he)}const K=document.createElement("canvas");K.width=Q,K.height=re;const ce=K.getContext("2d");if(!ce){we(new Error("Failed to get canvas context"));return}ce.drawImage(U,0,0,Q,re);const Ue=K.toDataURL("image/jpeg",n);F(Ue)},U.onerror=()=>{URL.revokeObjectURL(fe),we(new Error("Failed to load image for compression"))},U.src=fe}),Or=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(n=>n.test(s)):!1,Ha=async s=>{try{const N=s.startsWith("/uploads/")?`https://api.waule.com${s}`:s,F=await(await fetch(N)).blob();return await Hr(F,Cr,.9)}catch(N){throw N}},dr=async s=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(s.length>500*1024)try{const n=await(await fetch(s)).blob();return await Hr(n,Cr,.9)}catch{return s}return s}return s.includes("aliyuncs.com")||s.includes("oss-cn-")||s.startsWith("https://")&&!Or(s)?s:Or(s)?await Ha(s):s},St=({type:s,position:N,id:n,className:F="",label:we,isConnectable:U,disabled:fe,style:Q,...re})=>{const K=N===pt.Left,ce=U===!1||fe?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-purple-300 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-purple-300 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${F}`;return e.jsxs("div",{className:`absolute ${K?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...Q||{}},children:[K&&we&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:we}),e.jsx(us,{type:s,position:N,id:n,isConnectable:fe?!1:U,style:{position:"relative",[K?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${ce} !z-[10001]`,...re}),!K&&we&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:we})]})},os=({value:s,onChange:N,options:n,className:F=""})=>{const[we,U]=t.useState(!1),fe=t.useRef(null);t.useEffect(()=>{if(!we)return;const K=ce=>{fe.current&&!fe.current.contains(ce.target)&&U(!1)};return document.addEventListener("mousedown",K,!0),()=>document.removeEventListener("mousedown",K,!0)},[we]);const Q=n.find(K=>K.value===s),re=K=>{K.stopPropagation(),U(!we)};return e.jsxs("div",{className:`relative ${F}`,ref:fe,children:[e.jsxs("div",{onClick:re,onMouseDown:K=>K.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(Q==null?void 0:Q.label)||s}),e.jsx(Ca,{size:12,className:`transition-transform ${we?"rotate-90":""}`})]}),we&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white/90 dark:bg-[#1a1a1a]/90 backdrop-blur-xl border-slate-200 dark:border-white/10",children:n.map(K=>e.jsxs("div",{onClick:ce=>{ce.stopPropagation(),N(K.value),U(!1)},onMouseDown:ce=>ce.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[K.label,s===K.value&&e.jsx(Da,{size:10,className:"text-purple-500"})]},K.value))})]})},Us=s=>{const[N,n]=t.useState(null),[F,we]=t.useState(!1),[U,fe]=t.useState(!1),[Q,re]=t.useState(0),[K,ce]=t.useState(0),Ue=t.useCallback(()=>{ce(he=>he+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){n(null),fe(!1),re(0);return}try{we(!0);const ae=(await Ce.post("/billing/estimate",s)).data,Ie=(ae==null?void 0:ae.data)??ae,ne=(Ie==null?void 0:Ie.originalCredits)??(Ie==null?void 0:Ie.credits)??0;n(ne),fe((Ie==null?void 0:Ie.isFreeUsage)??!1),re((Ie==null?void 0:Ie.freeUsageRemaining)??0)}catch{n(null),fe(!1),re(0)}finally{we(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,K]),{credits:N,loading:F,isFreeUsage:U,freeUsageRemaining:Q,refetch:Ue}},ps=({createdBy:s,isSharedWorkflow:N})=>{if(!N||!s||typeof s=="string")return null;const{nickname:n,avatar:F}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:n||"æœªçŸ¥ç”¨æˆ·",children:F?e.jsx("img",{src:F,alt:n||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(n||"?")[0].toUpperCase()})})},Xa=({data:s,selected:N,id:n})=>{var oe;const[F,we]=t.useState(s.isExpanded!==!1),[U,fe]=t.useState(null),[Q,re]=t.useState(s.config.prompt||""),[K,ce]=t.useState(s.config.ratio||""),[Ue,he]=t.useState(s.config.imageSize||"2K"),[se,ae]=t.useState(s.config.maxImages||1),[Ie,ne]=t.useState(!1),[,ge]=t.useState(0),[,de]=t.useState(s.config.taskId||""),[me,Ee]=t.useState(s.config.referenceImages||[]),[Z,z]=t.useState(null),A=t.useRef(null),S=t.useRef(!1),{setNodes:G,setEdges:x,getNode:c,getEdges:I,getNodes:L}=Zt(),$=Ds(),j=Fs(k=>k.edges.filter(u=>u.target===n)),O=t.useRef(""),r=t.useRef(""),{credits:v,loading:g,isFreeUsage:a,freeUsageRemaining:y,refetch:d}=Us({aiModelId:U==null?void 0:U.id,quantity:1,resolution:Ue}),m=t.useMemo(()=>(s.models||[]).filter(k=>k.type==="IMAGE_GENERATION"&&k.isActive&&!k.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const k=m.find(u=>u.id===s.config.modelId);if(k){fe(k);const u=k.config;u!=null&&u.supportedRatios&&u.supportedRatios.length>0&&!K&&ce(u.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(u==null?void 0:u.acceptedInputs)||["TEXT","IMAGE"]})}}else if(m.length>0){fe(m[0]);const k=m[0].config;k!=null&&k.supportedRatios&&k.supportedRatios.length>0&&!K&&ce(k.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(k==null?void 0:k.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,m]),t.useEffect(()=>{const k=s.config.taskId;(async()=>{if(k)try{const b=(await Ce.tasks.getTaskStatus(k)).task;if(b.status==="SUCCESS"){ne(!1),ge(100);const Y=b.resultUrl;if(!Y){ne(!1),ge(0),l({taskId:""}),Gt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ue=s.config.ratio||"1:1";l({prompt:s.config.prompt||Q,ratio:ue,modelId:s.config.modelId||(U==null?void 0:U.id),generatedImageUrl:Y,taskId:""});const H=L(),pe=I();if(H.filter(Re=>Re.type==="imagePreview"&&pe.some(Ae=>Ae.source===n&&Ae.target===Re.id)).find(Re=>Re.data.imageUrl===Y)){l({taskId:""}),Gt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Gt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const Re=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Re).some($e=>$e.taskId&&$e.taskId===k||$e.sourceNodeId&&$e.sourceNodeId===n)||xe(Y,ue)}catch{xe(Y,ue)}}else b.status==="PROCESSING"||b.status==="PENDING"?(ne(!0),ge(b.progress||0),X(k)):b.status==="FAILURE"&&(ne(!1),ge(0),l({taskId:""}),Gt.error(b.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${b.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ne(!1),ge(0),l({taskId:""}),Gt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const f=()=>{if(!U)return[];const k=U.config;return(k==null?void 0:k.supportedRatios)||[]},w=()=>{var b;const k=(b=s==null?void 0:s.config)==null?void 0:b.modelId,u=m.find(Y=>Y.id===k)||m[0],E=(u==null?void 0:u.config)||{};return E.maxReferenceImages||E.supportedReferenceImagesLimit||E.referenceImagesLimit||10};function R(k){var E,b,Y,ue,H,pe,Se;const u=(k==null?void 0:k.type)||"";if(u==="upload")return(((b=(E=k==null?void 0:k.data)==null?void 0:E.config)==null?void 0:b.uploadedFiles)||[]).reduce((Re,Ae)=>{const _e=((Ae==null?void 0:Ae.type)||"").toUpperCase(),$e=((Ae==null?void 0:Ae.mimeType)||"").toLowerCase();return Re+(_e==="IMAGE"||$e.startsWith("image/")?1:0)},0);if(u==="assetSelector"){const Ne=((Y=k==null?void 0:k.data)==null?void 0:Y.config)||{};if(Ne.selectedAsset){const Re=(Ne.selectedAsset.type||"").toUpperCase(),Ae=(Ne.selectedAsset.mimeType||"").toLowerCase();return Re==="IMAGE"||Ae.startsWith("image/")?1:0}return Array.isArray(Ne.subjects)&&Ne.subjects.length>0&&(((ue=Ne.subjects[0])==null?void 0:ue.images)||[]).length>0?1:0}return u==="aiImage"?((pe=(H=k==null?void 0:k.data)==null?void 0:H.config)==null?void 0:pe.generatedImageUrl)?1:0:u==="imagePreview"&&((Se=k==null?void 0:k.data)==null?void 0:Se.imageUrl)?1:0}function W(k){var b,Y,ue,H;const u=(k==null?void 0:k.type)||"",E=k==null?void 0:k.data;if(u==="upload"&&((Y=(b=E==null?void 0:E.config)==null?void 0:b.uploadedFiles)==null?void 0:Y.length)>0){const pe=E.config.uploadedFiles[0],Se=(pe.type||"").toUpperCase(),Ne=(pe.mimeType||"").toLowerCase();return Se==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Se==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Se==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Se||null}if(u==="assetSelector"){if((ue=E==null?void 0:E.config)!=null&&ue.subjects)return"IMAGE";if((H=E==null?void 0:E.config)!=null&&H.selectedAsset){const pe=E.config.selectedAsset,Se=(pe.type||"").toUpperCase(),Ne=(pe.mimeType||"").toLowerCase();return Se==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Se==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Se==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Se||null}}return u==="aiImage"||u==="imagePreview"?"IMAGE":(u||"").startsWith("aiVideo")||u==="videoPreview"?"VIDEO":u==="agent"?"TEXT":null}const _=t.useMemo(()=>{const k=j,u=k.some(Y=>{const ue=c(Y.source);return((ue==null?void 0:ue.type)||"")==="agent"}),E=w(),b=k.reduce((Y,ue)=>Y+R(c(ue.source)),0);return u&&b>=E},[j,c]),p=k=>{const u=c(k.source);if(!u)return!1;const E=u.type||"",b=I().filter(Ne=>Ne.target===n),Y=W(u);if(Y==="VIDEO"||Y==="AUDIO"||Y==="DOCUMENT")return!1;const ue=b.some(Ne=>{const Re=c(Ne.source);return((Re==null?void 0:Re.type)||"")==="agent"});if(E==="agent"||E==="textPreview")return!ue;const H=b.reduce((Ne,Re)=>Ne+R(c(Re.source)),0),pe=R(u),Se=w();return H+pe<=Se};t.useEffect(()=>{const k=j;let E=w();const b=[];k.forEach(Y=>{const ue=c(Y.source),H=R(ue);H<=0||(E-H>=0?E-=H:b.push(Y.id))}),b.length>0&&(x(Y=>Y.filter(ue=>!b.includes(ue.id))),Gt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[j,c,x]),t.useEffect(()=>{const k=j,u=[];k.forEach(E=>{const b=c(E.source),Y=W(b);(Y==="VIDEO"||Y==="AUDIO"||Y==="DOCUMENT")&&u.push(E.id)}),u.length>0&&(x(E=>E.filter(b=>!u.includes(b.id))),Gt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[j,c,x]),t.useEffect(()=>{const k=j.map(ue=>{var Ne,Re,Ae,_e,$e;const H=c(ue.source);if(!H)return`${ue.id}-${ue.source}`;const pe=H.data||{};let Se=[];if(H.type==="assetSelector"){const le=(Ne=pe.config)==null?void 0:Ne.subjects;if(le&&le.length>0){const Ge=(Re=le[0].images)==null?void 0:Re[0];Se=Ge?[Ge]:[]}else(Ae=pe.config)!=null&&Ae.selectedAsset&&pe.config.selectedAsset.type==="IMAGE"&&(Se=[pe.config.selectedAsset.url])}else if(H.type==="upload")Se=(((_e=pe.config)==null?void 0:_e.uploadedFiles)||[]).filter(Ge=>Ge.type==="IMAGE").map(Ge=>Ge.url);else if(H.type==="aiImage"||H.type==="imagePreview"){const le=(($e=pe.config)==null?void 0:$e.generatedImageUrl)||pe.imageUrl;le&&(Se=[le])}return`${ue.id}-${ue.source}-${Se.join("|")}`}).sort().join(",");if(k===O.current)return;O.current=k;const u=[];let E="";j.forEach(ue=>{var pe,Se,Ne,Re,Ae,_e;const H=c(ue.source);if(H){const $e=H.data;if(H.type==="agent"&&((pe=$e.config)!=null&&pe.generatedText)?E||(E=$e.config.generatedText):H.type==="textPreview"&&$e.content&&(E||(E=$e.content)),H.type==="assetSelector"&&((Se=$e.config)!=null&&Se.subjects)&&$e.config.subjects.length>0){const Ge=(Ne=$e.config.subjects[0].images)==null?void 0:Ne[0];Ge&&!u.includes(Ge)&&u.push(Ge)}let le=((Re=$e.config)==null?void 0:Re.generatedImageUrl)||$e.imageUrl||"";if(!le&&((Ae=$e.config)!=null&&Ae.selectedAsset)){const Ge=$e.config.selectedAsset;Ge.type==="IMAGE"&&(le=Ge.url)}if(!le&&((_e=$e.config)!=null&&_e.uploadedFiles)&&$e.config.uploadedFiles.length>0){const Ge=$e.config.uploadedFiles[0];Ge.type==="IMAGE"&&(le=Ge.url)}le&&!u.includes(le)&&u.push(le)}});const b=w(),Y=u.slice(0,Math.max(0,b));Ee(Y),l({referenceImages:Y}),E&&E!==Q&&(re(E),l({prompt:E}))},[j,c,n,Q,$]),t.useEffect(()=>{if(j.length===0)return;let k="",u="";j.forEach(E=>{var Y;const b=$.find(ue=>ue.id===E.source);if(b&&b.type==="agent"){const ue=b.data;(Y=ue.config)!=null&&Y.generatedText&&(k=ue.config.generatedText,u=`${b.id}-${ue.config.generatedText.substring(0,50)}`)}}),k&&u!==r.current&&(r.current=u,re(k),l({prompt:k}))},[$,j,n]),t.useEffect(()=>{const k=A.current;k&&F&&requestAnimationFrame(()=>{k.style.height="auto";const u=Math.max(60,Math.min(k.scrollHeight,600));k.style.height=`${u}px`})},[Q,F]),t.useEffect(()=>{const k=setTimeout(()=>{Q!==s.config.prompt&&l({prompt:Q})},300);return()=>clearTimeout(k)},[Q]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Q&&re(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{K&&K!==s.config.ratio&&l({ratio:K})},[K]),t.useEffect(()=>{Ue&&Ue!==s.config.imageSize&&l({imageSize:Ue})},[Ue]),t.useEffect(()=>{var k;if((U==null?void 0:U.modelId)==="gemini-3-pro-image-preview"){const u=((k=U==null?void 0:U.config)==null?void 0:k.supportedResolutions)||[];(u.length>0&&!u.includes(Ue)||u.length===1)&&he(u[0])}},[U]),t.useEffect(()=>{se!==s.config.maxImages&&l({maxImages:se})},[se]);const l=k=>{c(n)&&G(E=>E.map(b=>b.id===n?{...b,data:{...b.data,config:{...b.data.config,...k}}}:b))},i=k=>{z(k)},B=(k,u)=>{if(k.preventDefault(),Z===null||Z===u)return;const E=[...me],b=E[Z];E.splice(Z,1),E.splice(u,0,b),Ee(E),z(u)},M=()=>{z(null),l({referenceImages:me})},X=async k=>{let E=0;const b=async()=>{var Y;try{E++;const H=(await Ce.tasks.getTaskStatus(k)).task;if(ge(H.progress||0),H.status==="SUCCESS"){ne(!1),ge(100);const pe=H.resultUrl,Se=(Y=H.metadata)==null?void 0:Y.allImageUrls;l({prompt:Q,ratio:K,modelId:U==null?void 0:U.id,generatedImageUrl:pe,taskId:""}),Se&&Se.length>1?(ie(Se,K),Gt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Se.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(xe(pe,K),Gt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(H.status==="FAILURE"){ne(!1),ge(0),l({taskId:""});const{useAuthStore:pe}=await xs(async()=>{const{useAuthStore:Ne}=await import("./index-B-U_h0BA.js").then(Re=>Re.f);return{useAuthStore:Ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Se}=pe.getState();await Se(),Gt.error(H.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(H.status==="PROCESSING"||H.status==="PENDING")&&(E<600?setTimeout(b,1e3):(ne(!1),ge(0),l({taskId:""}),Gt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ne(!1),ge(0),l({taskId:""}),Gt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};b()},V=async()=>{var k,u,E,b,Y;if(!(!Q.trim()||!U)){ne(!0),ge(0);try{let pe=[];if(me.length>0)try{for(const Ge of me){if(Ge.startsWith("http")||Ge.startsWith("/"))try{const Ct=(await fetch(Ge,{method:"HEAD"})).headers.get("content-length");if(Ct&&parseInt(Ct)>10485760){Gt.error("å‚è€ƒå›¾ç‰‡è¶…è¿‡ 10MB é™åˆ¶ï¼Œè¯·å‹ç¼©åé‡è¯•"),ne(!1);return}}catch{}const Ze=await dr(Ge);pe.push(Ze)}}catch{}let Se=Q.trim();U.modelId==="doubao-seedream-4-5-251128"&&se>1&&(Se=`ç”Ÿæˆä¸€ç»„å…±${se}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${Se}`),U.modelId==="gemini-3-pro-image-preview"&&K&&(Se=`${Se}ï¼Œç”Ÿæˆ${K}çš„æ¯”ä¾‹`);const Ne={modelId:U.id,prompt:Se,ratio:K||"1:1",referenceImages:pe.length>0?pe:void 0};U.modelId==="gemini-3-pro-image-preview"&&(Ne.imageSize=Ue),U.modelId==="doubao-seedream-4-5-251128"&&se>1&&(Ne.maxImages=se);const Re=await Ce.tasks.createImageTask(Ne),Ae=Re.taskId,_e=Re.creditsCharged||0,$e=Re.isFreeUsage,le=Re.freeUsageRemaining??0;if(de(Ae),l({prompt:Q,ratio:K,modelId:U.id,taskId:Ae}),$e)Gt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${le} æ¬¡æœºä¼š`),d();else if(_e>0){const{useAuthStore:Ge}=await xs(async()=>{const{useAuthStore:Wt}=await import("./index-B-U_h0BA.js").then(Ct=>Ct.f);return{useAuthStore:Wt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ze}=Ge.getState();await Ze(),Gt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${_e} ç§¯åˆ†`),d()}else Gt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");X(Ae)}catch(ue){if(ne(!1),ge(0),((k=ue.response)==null?void 0:k.status)===403){const H=((E=(u=ue.response)==null?void 0:u.data)==null?void 0:E.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Gt.error(H)}else{const H=((Y=(b=ue.response)==null?void 0:b.data)==null?void 0:Y.error)||ue.message||"æœªçŸ¥åŸå› ";Gt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${H}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ie=(k,u)=>{!k||k.length===0||k.forEach((E,b)=>{setTimeout(()=>{xe(E,u,b)},b*100)})},xe=(k,u,E)=>{const b=c(n);if(!b)return;const Y=1,ue=L(),H=I(),pe=ue.filter(yt=>yt.type==="imagePreview"&&H.some(Be=>Be.source===n&&Be.target===yt.id));if(pe.find(yt=>yt.data.imageUrl===k))return;const Ne=400,Re=(yt,Be=300)=>{if(!yt||!/^[0-9]+\s*:\s*[0-9]+$/.test(yt))return Be;const[wt,Yt]=yt.split(":").map(ks=>parseFloat(ks));return!wt||!Yt?Be:Math.round(Ne*(Yt/wt))},Ae=document.querySelector(`.react-flow__node[data-id="${n}"]`),_e=(Ae==null?void 0:Ae.getBoundingClientRect().width)||400,$e=Math.round(_e/Y),le=200,Ge=100,Ze=Re(u,300),Wt=b.position.x+$e+le,Ct=b.position.y,_t=E!==void 0?pe.length+E:pe.length,dt=Wt,gt=Ct+_t*(Ze+Ge),vt=Date.now(),lt={id:`preview-${n}-${vt}`,type:"imagePreview",position:{x:dt,y:gt},data:{imageUrl:k,width:Ne,ratio:u,workflowContext:b.data.workflowContext,createdBy:b.data.createdBy}};G(yt=>[...yt,lt]);const Ye={id:`edge-${n}-${lt.id}`,source:n,target:lt.id,targetHandle:`${lt.id}-target`,type:"aurora"};x(yt=>yt.find(wt=>wt.source===n&&wt.target===lt.id)?yt:[...yt,Ye])};if(t.useEffect(()=>{s.isExpanded!==void 0&&we(s.isExpanded)},[s.isExpanded]),!F&&s.config.generatedImageUrl){const[k,u]=(s.config.ratio||"1:1").split(":").map(Number),E=k/u,b=320,Y=b/E;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:b,height:Y},onDoubleClick:()=>{we(!0),c(n)&&G(H=>H.map(pe=>pe.id===n?{...pe,data:{...pe.data,isExpanded:!0}}:pe))},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:_,isValidConnection:p}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),Q&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:Q,children:Q})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!F&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{we(!0),c(n)&&G(u=>u.map(E=>E.id===n?{...E,data:{...E.data,isExpanded:!0}}:E))},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:_,isValidConnection:p}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:Q})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:_,isValidConnection:p}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:(U==null?void 0:U.id)||"",onChange:k=>{const u=m.find(E=>E.id===k);if(fe(u||null),u){const E=u.config;E!=null&&E.supportedRatios&&E.supportedRatios.length>0&&ce(E.supportedRatios[0]),l({modelId:u.id,acceptedInputs:(E==null?void 0:E.acceptedInputs)||["TEXT","IMAGE"]})}},options:m.map(k=>({value:k.id,label:k.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:A,value:Q,onChange:k=>{S.current=!0,re(k.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),me.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",me.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:me.map((k,u)=>e.jsxs("div",{draggable:!0,onDragStart:E=>{E.stopPropagation(),i(u)},onDragEnd:E=>{E.stopPropagation(),M()},onDragOver:E=>{E.stopPropagation(),B(E,u)},className:`nodrag relative group cursor-move aspect-square ${Z===u?"opacity-50":""}`,children:[e.jsx("img",{src:k,alt:`å›¾ç‰‡${u+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-purple-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:u+1})]},u))})]}),(U==null?void 0:U.modelId)==="gemini-3-pro-image-preview"&&(()=>{var u;const k=((u=U==null?void 0:U.config)==null?void 0:u.supportedResolutions)||[];return k.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${k.length} gap-2`,children:k.map(E=>e.jsx("button",{onClick:()=>he(E),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Ue===E?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:E==="4K"?"4k":"hd"}),e.jsx("span",{children:E})]})},E))})]})})(),(U==null?void 0:U.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-purple-500 dark:text-purple-400",children:[se," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:se,onChange:k=>ae(Number(k.target.value)),className:"nodrag w-full h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-500"}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),se>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),f().length>0&&e.jsx("div",{className:"space-y-1",children:((oe=U==null?void 0:U.provider)==null?void 0:oe.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>ce("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${K==="16:9"?"bg-purple-600 text-white border-purple-500":"bg-purple-950/50 text-purple-300 border-purple-700/30 hover:bg-purple-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>ce("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${K==="9:16"?"bg-purple-600 text-white border-purple-500":"bg-purple-950/50 text-purple-300 border-purple-700/30 hover:bg-purple-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(os,{value:K,onChange:k=>ce(k),options:f().map(k=>{const[u,E]=k.split(":");return{value:k,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[k]||`${u}:${E}`}})})]})}),e.jsx("button",{onClick:V,onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),disabled:Ie||!Q.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${Ie?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!g&&(a?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",y,"æ¬¡"]}):v!==null&&v>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[v,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ja=t.memo(Xa),gr="https://api.waule.com",qa=({data:s,selected:N,id:n})=>{var sr,rr,Ps,J,te,De,Ve,qe,Le,tt,it;const[F,we]=t.useState(!0),[,U]=t.useState(0),[fe,Q]=t.useState(s.config.taskId||""),re=s.config.modelId,K=s.config.duration||5,ce=s.config.resolution||"720p",{credits:Ue,loading:he,isFreeUsage:se,freeUsageRemaining:ae,refetch:Ie}=Us({aiModelId:re,duration:K,resolution:ce});t.useEffect(()=>{},[fe]);const{setNodes:ne,setEdges:ge,getNode:de,getNodes:me,getEdges:Ee}=Zt(),Z=zs(),z=Ds(),A=t.useRef(""),S=(sr=s.config)==null?void 0:sr.selectedEditingCapability,G=t.useMemo(()=>{const T=(s.models||[]).filter(P=>{var be;return((be=P.provider)==null?void 0:be.toLowerCase())!=="sora"&&P.id!=="sora-video"});if(S){const P=T.filter(je=>je.type==="VIDEO_EDITING").filter(je=>{var ye;return Array.isArray((ye=je==null?void 0:je.config)==null?void 0:ye.supportedEditingCapabilities)&&je.config.supportedEditingCapabilities.includes(S)}),be=T.filter(je=>je.type==="VIDEO_GENERATION").filter(je=>{var kt,ft;if(S!=="è§†é¢‘æ¢äºº")return!1;const ye=((kt=je==null?void 0:je.config)==null?void 0:kt.supportsVideoEditing)===!0,st=(Array.isArray((ft=je==null?void 0:je.config)==null?void 0:ft.supportedGenerationTypes)?je.config.supportedGenerationTypes:[]).some(We=>(We||"").toLowerCase().includes("æ¢äºº")||(We||"").includes("è§†é¢‘æ¢äºº"));return ye||st}),Te={};return[...P,...be].forEach(je=>{Te[je.id]||(Te[je.id]=je)}),Object.values(Te)}return T.filter(P=>P.type==="VIDEO_GENERATION")},[s.models,S]),[x,c]=t.useState(s.config.prompt||""),I=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==x&&c(s.config.prompt)},[s.config.prompt]);const[L,$]=t.useState(s.config.modelId||((rr=G[0])==null?void 0:rr.id)||""),[j,O]=t.useState(s.config.ratio||"16:9"),[r,v]=t.useState(s.config.resolution||""),g=t.useCallback(T=>{const P=(T||"").toLowerCase();return P?P.includes("æ–‡ç”Ÿ")||P.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":P.includes("é¦–å°¾")?"é¦–å°¾å¸§":P.includes("é¦–å¸§")||P.includes("first frame")||P.includes("start frame")||P.includes("initial frame")||P.includes("keyframe")?"é¦–å¸§":P.includes("å°¾å¸§")||P.includes("last frame")||P.includes("end frame")||P.includes("final frame")?"å°¾å¸§":P.includes("ä¸»ä½“å‚è€ƒ")||P.includes("å‚è€ƒ")||P.includes("reference image")||P.includes("image reference")||P.includes("ref image")?"å‚è€ƒå›¾":P.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":P.includes("first-last")||P.includes("two-frame")||P.includes("frame pair")?"é¦–å°¾å¸§":P.includes("first")?"é¦–å¸§":P.includes("last")?"å°¾å¸§":P.includes("subject")||P.includes("reference")?"å‚è€ƒå›¾":T||"":""},[]),[a,y]=t.useState((s.config.lockedGenerationType?g(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[d,m]=t.useState(s.config.duration||5),[f,w]=t.useState(s.config.audio||!1),[R,W]=t.useState(s.config.movementAmplitude||"auto"),[_,p]=t.useState(!1),[l,i]=t.useState([]),[B,M]=t.useState(null),[X,V]=t.useState(!1),[ie]=t.useState(""),[xe]=t.useState("confirm"),[oe]=t.useState(null),[k,u]=t.useState(!1),[E,b]=t.useState([]),[Y,ue]=t.useState(""),[H,pe]=t.useState(0),[Se,Ne]=t.useState(0),[Re,Ae]=t.useState({}),[_e,$e]=t.useState([]),le=G.find(T=>T.id===L);t.useEffect(()=>{var T,P;if(!G.find(be=>be.id===L)){const be=((T=G[0])==null?void 0:T.id)||"";$(be),dt({modelId:be,modelName:(P=G[0])==null?void 0:P.name})}},[G]),t.useEffect(()=>{var T;if((T=le==null?void 0:le.config.supportedResolutions)!=null&&T.length){const P=le.config.supportedResolutions;if(!r||!P.includes(r)){const be=P[0];v(be),dt({resolution:be})}}},[le==null?void 0:le.id]),t.useEffect(()=>{var be;const T=(be=le==null?void 0:le.modelId)==null?void 0:be.includes("viduq2"),P=g(a)==="é¦–å°¾å¸§";T&&P&&d>8&&(m(8),dt({duration:8}))},[a,le==null?void 0:le.modelId]);const Ge=((Ps=le==null?void 0:le.provider)==null?void 0:Ps.toLowerCase())==="sora",Ze=t.useMemo(()=>{var T,P,be,Te;if((T=le==null?void 0:le.config.supportedDurations)!=null&&T.length){let je=le.config.supportedDurations;const ye=(P=le.modelId)==null?void 0:P.includes("viduq2"),et=g(a)==="é¦–å°¾å¸§";return ye&&et&&(je=je.filter(kt=>kt<=8)),(((be=le.provider)==null?void 0:be.toLowerCase())==="minimax"||((Te=le.modelId)==null?void 0:Te.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(je=je.filter(kt=>kt===6)),je}return[d||5]},[le,d,a,g,r]),Wt=t.useMemo(()=>{var T;return(T=le==null?void 0:le.config.supportedResolutions)!=null&&T.length?le.config.supportedResolutions:[]},[le]),Ct=!le||!((J=le.config.supportedDurations)!=null&&J.length),_t=!le||!((te=le.config.supportedResolutions)!=null&&te.length),dt=t.useCallback(T=>{de(n)&&ne(be=>be.map(Te=>Te.id===n?{...Te,data:{...Te.data,config:{...Te.data.config,...T}}}:Te))},[de,n,ne]);t.useEffect(()=>{if(Ze.length>0&&!Ze.includes(d)){const T=Ze[0];m(T),dt({duration:T})}},[Ze,d,dt]);const gt=(T,P)=>{const be=(kt,ft)=>ft===0?kt:be(ft,kt%ft),Te=be(T,P),je=T/Te,ye=P/Te,et={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},st=`${je}:${ye}`;return et[st]||st},vt=()=>{const T=Z.filter(et=>et.target===n),P=[];T.forEach(et=>{var kt;const st=de(et.source);if(st&&st.type==="upload"&&(((kt=st.data.config)==null?void 0:kt.uploadedFiles)||[]).forEach(We=>{const Dt=We.type||We.mimeType||"";(Dt==="IMAGE"||Dt.startsWith("image/"))&&P.push({id:We.id||We.name,url:We.url,name:We.name||We.originalName,width:We.width,height:We.height,aspectRatio:We.width&&We.height?gt(We.width,We.height):"16:9"})}),st&&st.type==="assetSelector"){const ft=st.data.config||{},We=ft.subjects,Dt=ft.selectedAsset,Xt=g(a);We&&We.length>0?Xt==="é¦–å°¾å¸§"||(We[0].images||[]).forEach((zt,At)=>{P.push({id:`${st.id}-subject-${At}`,url:zt,name:We[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Dt&&Dt.type==="IMAGE"&&P.push({id:Dt.id,url:Dt.url,name:Dt.name||Dt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(st&&st.type==="imagePreview"){const ft=st.data.imageUrl,We=st.data.width,Dt=st.data.height;ft&&P.push({id:st.id,url:ft,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:We,height:Dt,aspectRatio:We&&Dt?gt(We,Dt):"16:9"})}});const be=new Set,Te=[];P.forEach(et=>{const st=et.url;be.has(st)||(be.add(st),Te.push(et))});const je=g(a);let ye=[];return je==="æ–‡ç”Ÿè§†é¢‘"?ye=[]:je==="é¦–å¸§"||je==="å°¾å¸§"?ye=Te.slice(0,1):je==="é¦–å°¾å¸§"?ye=Te.slice(0,2):je==="å‚è€ƒå›¾"?ye=Te.slice(0,7):ye=Te,ye},lt=t.useMemo(()=>vt(),[Z,z,a,n]),Ye=T=>{if(!I.current)return;const P=I.current,be=P.selectionStart||x.length,Te=x.slice(0,be),je=x.slice(be),ye=`@${T} `,et=Te+ye+je;c(et),Ae(st=>({...st,[T]:`image-${T}`})),setTimeout(()=>{const st=be+ye.length;P.setSelectionRange(st,st),P.focus()},0)},yt=t.useCallback(async()=>{var T;if(!(_e.length>0))try{const P=await Ce.assetLibraries.getAll({includeShared:"true"}),be=P.data||P||[],Te=[];for(const je of be)if(je.category==="ROLE")try{const ye=await Ce.assetLibraries.roles.list(je.id),et=ye.data||ye||[];for(const st of et)Te.push({id:st.id,name:((T=st.metadata)==null?void 0:T.name)||st.name||"",thumbnail:st.thumbnail})}catch{}$e(Te)}catch{}},[_e.length]),Be=t.useCallback(T=>{if(!T){b(_e.slice(0,5));return}const P=_e.filter(be=>be.name.toLowerCase().includes(T.toLowerCase())).slice(0,5);b(P),Ne(0)},[_e]),wt=t.useCallback(T=>{const P=T.target.value,be=T.target.selectionStart||0;c(P);const je=P.substring(0,be).match(/@([^@\s]*)$/);if(je){const ye=je[1];ue(ye),pe(be-ye.length-1),u(!0),yt().then(()=>Be(ye))}else u(!1),b([])},[yt,Be]),Yt=t.useCallback(T=>{const P=x.substring(0,H),be=x.substring(H+Y.length+1),Te=`@${T.name} `,je=P+Te+be;c(je),Ae(ye=>({...ye,[T.name]:T.id})),u(!1),b([]),ue(""),setTimeout(()=>{if(I.current){I.current.focus();const ye=P.length+Te.length;I.current.setSelectionRange(ye,ye)}},0)},[x,H,Y]),ks=t.useCallback(T=>{!k||E.length===0||(T.key==="ArrowDown"?(T.preventDefault(),Ne(P=>P<E.length-1?P+1:P)):T.key==="ArrowUp"?(T.preventDefault(),Ne(P=>P>0?P-1:P)):T.key==="Enter"&&E[Se]?(T.preventDefault(),Yt(E[Se])):T.key==="Escape"&&u(!1))},[k,E,Se,Yt]);t.useEffect(()=>{const T=s.config.taskId;(async()=>{if(T){try{const Te=(await Ce.tasks.getTaskStatus(T)).task;if(Te.status==="SUCCESS"){p(!1),U(100);const je=Te.resultUrl;if(!je){p(!1),U(0),dt({taskId:""}),Q(""),h.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ye=s.config.ratio||"16:9";dt({prompt:s.config.prompt||x,ratio:ye,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:je,taskId:""}),Q("");const et=me(),st=Ee();if(et.filter(We=>We.type==="videoPreview"&&st.some(Dt=>Dt.source===n&&Dt.target===We.id)).find(We=>We.data.videoUrl===je)){setTimeout(()=>U(0),1e3);return}h.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const We=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(We).some(Lt=>Lt.taskId&&Lt.taskId===T||Lt.sourceNodeId&&Lt.sourceNodeId===n)||ws(je,ye)}catch{ws(je,ye)}setTimeout(()=>U(0),1e3)}else if(Te.status==="PROCESSING"||Te.status==="PENDING"){p(!0),U(Te.progress||0),Js(T);return}else Te.status==="FAILURE"&&(p(!1),U(0),dt({taskId:""}),Q(""),h.error(`ç”Ÿæˆå¤±è´¥: ${Te.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{p(!1),U(0),dt({taskId:""}),Q(""),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const T=Z.filter(be=>be.target===n);let P="";T.forEach(be=>{var je;const Te=de(be.source);if(Te){const ye=Te.data;Te.type==="agent"&&((je=ye.config)!=null&&je.generatedText)?P||(P=ye.config.generatedText):Te.type==="textPreview"&&ye.content&&(P||(P=ye.content))}}),P&&P!==x&&(c(P),dt({prompt:P}))},[Z,n,de,x,dt]),t.useEffect(()=>{const T=Z.filter(Te=>Te.target===n);if(T.length===0)return;let P="",be="";T.forEach(Te=>{var ye;const je=z.find(et=>et.id===Te.source);if(je&&je.type==="agent"){const et=je.data;(ye=et.config)!=null&&ye.generatedText&&(P=et.config.generatedText,be=`${je.id}-${et.config.generatedText.substring(0,50)}`)}}),P&&be!==A.current&&(A.current=be,c(P),dt({prompt:P}))},[z,Z,n,dt]),t.useEffect(()=>{const T=JSON.stringify(lt),P=JSON.stringify(l);T!==P&&i(lt)},[lt]);const Is=t.useMemo(()=>{const T=l.length,P=g(a);return T===0?!0:T===1?P==="å‚è€ƒå›¾":T===2?P==="é¦–å°¾å¸§"?!1:P==="å‚è€ƒå›¾":T>2?P==="å‚è€ƒå›¾":!1},[l.length,a,g]),Ss=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),vs=t.useMemo(()=>{const T=g(a);return S?G:G.filter(P=>{var Te;const be=(((Te=P.config)==null?void 0:Te.supportedGenerationTypes)||[]).map(je=>g(je));return T==="é¦–å¸§"||T==="å°¾å¸§"?be.includes("é¦–å¸§")||be.includes("å°¾å¸§"):be.includes(T)})},[G,a,g,S]),Bs=t.useMemo(()=>{const T=S?G:vs;return T.length>0?T:S?(s.models||[]).filter(be=>(be.type||"")==="VIDEO_EDITING"):T},[S,G,vs,s.models]);t.useEffect(()=>{var P,be;if(!Bs.find(Te=>Te.id===L)){const Te=((P=Bs[0])==null?void 0:P.id)||"";$(Te),dt({modelId:Te||void 0,modelName:Te?(be=Bs[0])==null?void 0:be.name:void 0})}},[Bs]);const gs=t.useCallback(T=>{const P=g(T);return S?["IMAGE","VIDEO"]:P==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[g,S]);t.useEffect(()=>{if(!Is&&l.length>0){const T=l[0].aspectRatio;T&&j!==T&&(O(T),setTimeout(()=>{dt({ratio:T})},0))}},[Is,l,j]),t.useEffect(()=>{if(!S&&Ss.length>0&&!Ss.includes(a)){const T="æ–‡ç”Ÿè§†é¢‘";y(T),setTimeout(()=>{dt({generationType:T,acceptedInputs:gs(T)})},0)}},[Ss,a,gs,S]),t.useEffect(()=>{g(a)==="é¦–å°¾å¸§"&&f&&(w(!1),dt({audio:!1}))},[a,g]),t.useEffect(()=>{const T=g(a);if(T==="æ–‡ç”Ÿè§†é¢‘")return;const P=Z.filter(ye=>ye.target===n),be=[],Te=[];P.forEach(ye=>{var kt,ft,We,Dt,Xt;const et=de(ye.source);if(!et)return;const st=et.type;if((st||"").startsWith("aiVideo")||st==="videoPreview"){Te.push(ye.id);return}if(st==="upload"){const Lt=(We=(ft=(kt=et.data)==null?void 0:kt.config)==null?void 0:ft.uploadedFiles)==null?void 0:We[0],zt=((Lt==null?void 0:Lt.type)||"").toUpperCase(),At=((Lt==null?void 0:Lt.mimeType)||"").toLowerCase();if(zt==="VIDEO"||At.startsWith("video/")){Te.push(ye.id);return}(zt==="IMAGE"||At.startsWith("image/"))&&be.push(ye.id);return}if(st==="assetSelector"){const Lt=((Dt=et.data)==null?void 0:Dt.config)||{};if(Lt.selectedAsset){const zt=(Lt.selectedAsset.type||"").toUpperCase(),At=(Lt.selectedAsset.mimeType||"").toLowerCase();zt==="VIDEO"||At.startsWith("video/")?Te.push(ye.id):(zt==="IMAGE"||At.startsWith("image/"))&&be.push(ye.id)}else if(Lt.subjects&&Lt.subjects.length>0){const zt=(((Xt=Lt.subjects[0])==null?void 0:Xt.images)||[]).length;T==="å‚è€ƒå›¾"||T==="é¦–å°¾å¸§"?be.push(ye.id):(T==="é¦–å¸§"||T==="å°¾å¸§")&&(zt>1?Te.push(ye.id):be.push(ye.id))}return}(st==="aiImage"||st==="imagePreview")&&be.push(ye.id)});let je=new Set([...Te]);T==="é¦–å¸§"||T==="å°¾å¸§"?be.slice(1).forEach(ye=>je.add(ye)):T==="é¦–å°¾å¸§"&&be.slice(2).forEach(ye=>je.add(ye)),je.size>0&&ge(ye=>ye.filter(et=>!je.has(et.id)))},[a,Z,n,de,ge,g]),t.useEffect(()=>{const T=s.config.generationType;if(!T||g(T)!==g(a)){const P=g(a)||"æ–‡ç”Ÿè§†é¢‘";dt({generationType:P,acceptedInputs:gs(P)})}},[]),t.useEffect(()=>{const T=gs(a);dt({acceptedInputs:T})},[a,gs]);const Hs=T=>{M(T)},Xs=T=>{T.preventDefault()},nr=T=>{if(B===null)return;const P=[...l],[be]=P.splice(B,1);P.splice(T,0,be),i(P),M(null),dt({referenceImages:P})};t.useEffect(()=>{const T=I.current;T&&F&&requestAnimationFrame(()=>{T.style.height="auto";const P=Math.max(60,Math.min(T.scrollHeight,600));T.style.height=`${P}px`})},[x,F]),t.useEffect(()=>{if(x===s.config.prompt)return;const T=setTimeout(()=>{dt({prompt:x})},500);return()=>clearTimeout(T)},[x]);const Tt=T=>{var be,Te,je;$(T);const P=vs.find(ye=>ye.id===T);if(P){const ye=(be=P.config.supportedRatios)!=null&&be.length?P.config.supportedRatios:["16:9"],et=P.config.supportedResolutions||[],st=(Te=P.config.supportedGenerationTypes)!=null&&Te.length?P.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],kt=(je=P.config.supportedDurations)!=null&&je.length?P.config.supportedDurations:[5],ft=ye[0],We=et.length>0?et[0]:r,Dt=g(a||st[0]),Xt=kt[0],Lt=P.config.supportsAudioOutput?f:!1;O(ft),v(We),y(Dt),m(Xt),P.config.supportsAudioOutput||w(!1),dt({modelId:T,modelName:P.name,ratio:ft,resolution:We,generationType:Dt,duration:Xt,audio:Lt,acceptedInputs:gs(Dt)})}};t.useEffect(()=>{var P;const T=(P=s==null?void 0:s.config)==null?void 0:P.generatedVideoUrl;T&&ws(T,s.config.ratio||"16:9")},[(De=s==null?void 0:s.config)==null?void 0:De.generatedVideoUrl]);const Js=async T=>{let be=0;const Te=async()=>{try{be++;const ye=(await Ce.tasks.getTaskStatus(T)).task;if(U(ye.progress||0),ye.status==="SUCCESS"||ye.status==="COMPLETED"||ye.status==="DONE"){p(!1),U(100);const et=ye.resultUrl;ws(et,s.config.ratio||"16:9"),dt({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:et}),Q(""),h.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>U(0),1e3);return}else if(ye.status==="FAILURE"){p(!1),U(0),dt({taskId:""});const{useAuthStore:et}=await xs(async()=>{const{useAuthStore:kt}=await import("./index-B-U_h0BA.js").then(ft=>ft.f);return{useAuthStore:kt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:st}=et.getState();await st(),h.error(ye.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(ye.status==="PROCESSING"||ye.status==="PENDING")&&(be<600?setTimeout(Te,1e3):(p(!1),U(0),dt({taskId:""}),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{p(!1),U(0),dt({taskId:""}),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Te()},bs=async()=>{var be,Te,je,ye,et,st,kt;if(g(a)==="æ–‡ç”Ÿè§†é¢‘"&&!x.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯");return}p(!0);const P=vt();dt({referenceImages:P}),U(0);try{let ft=[],We;const Dt=l.length;if(l.length>0)try{for(const fs of l){let Bt=fs.url;!Bt.startsWith("data:")&&!Bt.startsWith("http")&&(Bt=`${gr}${Bt}`),Bt=Bt.replace(/^https?:\/\/localhost(?::\d+)?/i,gr);const Jt=await dr(Bt);ft.push(Jt)}}catch{h.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=Z.filter(fs=>fs.target===n);let Lt=[];if(g(a)==="å‚è€ƒå›¾"){const fs=/@(\S+)/g,Jt=[...x.matchAll(fs)].map(ds=>ds[1]);for(const ds of Jt){const ss=Re[ds];ss&&Lt.push(ss)}const as=new Map;for(const ds of Xt){const ss=de(ds.source);if((ss==null?void 0:ss.type)==="assetSelector"){const Ls=(be=ss.data.config)==null?void 0:be.roleIds;if(Ls&&Ls.length>0)for(const hs of Ls)Lt.includes(hs)||Lt.push(hs);const Ns=(Te=ss.data.config)==null?void 0:Te.subjects;if(Ns&&Ns.length>0){for(const hs of Ns)if(!as.has(hs.name)){const Ys=(hs.images||[]).map(Os=>Os.startsWith("http")||Os.startsWith("data:")?Os:`${gr}${Os}`);as.set(hs.name,Ys)}}}}if(as.size>0){const ds=Array.from(as.entries());let ss=0;const Ls=[];for(const[Ns,hs]of ds){if(ss>=7)break;const Ys=7-ss,Os=hs.slice(0,Math.max(0,Ys));Os.length>0&&(Ls.push({name:Ns,images:Os}),ss+=Os.length)}We=Ls,ds.some(([,Ns])=>Ns.length>0)&&ss<ds.reduce((Ns,[,hs])=>Ns+hs.length,0)&&h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(ft.length>0){const ds=lt.filter(ss=>!ss.id.includes("subject"));ds.length>0&&(We||(We=[]),ds.forEach((ss,Ls)=>{const Ns=`å›¾${Ls+1}`,hs=ss.url.startsWith("http")||ss.url.startsWith("data:")?ss.url:`${gr}${ss.url}`;We.push({name:Ns,images:[hs]})}))}}const zt=We&&We.length>0?We.reduce((fs,Bt)=>{var Jt;return fs+(((Jt=Bt.images)==null?void 0:Jt.length)||0)},0):Dt,At=Lt.length>0;let Ut=a;if(Ut==="é¦–å¸§"||Ut==="å°¾å¸§"){if(zt!==1&&!At){h.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),p(!1),U(0);return}}else if(Ut==="é¦–å°¾å¸§"){if(zt===1)Ut="é¦–å¸§";else if(zt!==2&&!At){h.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),p(!1),U(0);return}We&&We.length>0?We=[{...We[0],images:We[0].images.slice(0,2)}]:ft=ft.slice(0,2)}else if(Ut==="å‚è€ƒå›¾"||Ut==="ä¸»ä½“å‚è€ƒ"){if(zt<1&&!At){h.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),p(!1),U(0);return}if(We&&We.length>0){if(We.reduce((Bt,Jt)=>{var as;return Bt+(((as=Jt.images)==null?void 0:as.length)||0)},0)>7){let Bt=7;We=We.map(Jt=>({...Jt,images:Jt.images.slice(0,Math.max(0,Bt-=Jt.images.length,Jt.images.length))})),Bt=7,We=We.map(Jt=>{const as=Jt.images.slice(0,Math.min(Jt.images.length,Bt));return Bt-=as.length,{...Jt,images:as}}).filter(Jt=>Jt.images.length>0),h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else ft.length>7&&(ft=ft.slice(0,7),h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}oe==="dropImages"&&(ft=[],We=void 0),(g(a)==="é¦–å¸§"||g(a)==="å°¾å¸§")&&oe==="useFirstImage"&&ft.length>=2&&(ft=[ft[0]]),g(a)==="é¦–å°¾å¸§"&&oe==="useFirstTwoImages"&&ft.length>=3&&(ft=ft.slice(0,2));const Vt={modelId:L,ratio:j,referenceImages:We&&We.length>0?void 0:ft.length>0?ft:void 0,roleIds:Lt.length>0?Lt:void 0,generationType:Ut,sourceNodeId:n,metadata:{duration:d,resolution:r,audio:f,movementAmplitude:R,roleIds:Lt.length>0?Lt:void 0},...We?{subjects:We}:{}};We&&We.length>0;const Ft=g(Ut);if(Ft==="æ–‡ç”Ÿè§†é¢‘"){if(!x.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯"),p(!1),U(0);return}Vt.prompt=x.trim()}else if(Ft==="å‚è€ƒå›¾"){if(!x.trim()){h.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),p(!1),U(0);return}Vt.prompt=x.trim()}else x.trim()&&(Vt.prompt=x.trim());const ts=await Ce.tasks.createVideoTask(Vt),rs=ts.taskId,ys=ts.creditsCharged||0,qs=ts.isFreeUsage,Es=ts.freeUsageRemaining??0;if(Q(rs),dt({prompt:x,ratio:j,resolution:r,generationType:a,duration:d,modelId:L,taskId:rs}),qs)h.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Es} æ¬¡`),Ie();else if(ys>0){const{useAuthStore:fs}=await xs(async()=>{const{useAuthStore:Jt}=await import("./index-B-U_h0BA.js").then(as=>as.f);return{useAuthStore:Jt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Bt}=fs.getState();await Bt(),h.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${ys} ç§¯åˆ†ï¼‰`),Ie()}else h.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Js(rs)}catch(ft){if(p(!1),U(0),((je=ft.response)==null?void 0:je.status)===403){const We=((et=(ye=ft.response)==null?void 0:ye.data)==null?void 0:et.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";h.error(We)}else h.error(`æäº¤å¤±è´¥: ${((kt=(st=ft.response)==null?void 0:st.data)==null?void 0:kt.error)||ft.message}`)}},er=async()=>{const T=g(a),P=vt(),be=P.length,Te=(()=>{var et;const ye=Z.filter(st=>st.target===n);for(const st of ye){const kt=de(st.source);if((kt==null?void 0:kt.type)==="assetSelector"){const ft=(et=kt.data.config)==null?void 0:et.subjects;if(ft&&ft.length>0)return!0}}return!1})(),je=Object.keys(Re).length>0;if((Te||je)&&(T==="é¦–å¸§"||T==="å°¾å¸§"||T==="é¦–å°¾å¸§")){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((T==="é¦–å¸§"||T==="å°¾å¸§")&&be===0&&!je){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(T==="é¦–å°¾å¸§"&&be===0&&!je){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(T==="å‚è€ƒå›¾"&&be===0&&!je){h.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(T==="æ–‡ç”Ÿè§†é¢‘"&&be>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((T==="é¦–å¸§"||T==="å°¾å¸§")&&be>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(T==="é¦–å°¾å¸§"&&be>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(T==="æ–‡ç”Ÿè§†é¢‘"&&!x.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!L){h.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}i(P),dt({referenceImages:P}),p(!0),U(0),await bs()},ws=(T,P)=>{const be=de(n);if(!be||!T)return;const Te=P||j||"16:9",je=me(),ye=Ee(),et=je.filter(Bt=>Bt.type==="videoPreview"&&ye.some(Jt=>Jt.source===n&&Jt.target===Bt.id));if(et.find(Bt=>Bt.data.videoUrl===T))return;const kt=1,ft=400,We=(Bt,Jt=300)=>{if(!Bt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Bt))return Jt;const[as,ds]=Bt.split(":").map(ss=>parseFloat(ss));return!as||!ds?Jt:Math.round(ft*(ds/as))},Dt=document.querySelector(`.react-flow__node[data-id="${n}"]`),Xt=Dt==null?void 0:Dt.getBoundingClientRect(),Lt=Math.round(((Xt==null?void 0:Xt.width)||400)/kt),zt=100,At=200,Ut=We(Te,300),Vt=et.length,Ft=be.position.x+Lt+At,ts=be.position.y,rs=Ft,ys=ts+Vt*(Ut+zt),qs=Date.now(),Es={id:`preview-${n}-${qs}`,type:"videoPreview",position:{x:rs,y:ys},data:{videoUrl:T,width:ft,ratio:Te,workflowContext:be.data.workflowContext,createdBy:be.data.createdBy}};ne(Bt=>[...Bt,Es]);const fs={id:`edge-${n}-${Es.id}`,source:n,target:Es.id,targetHandle:`${Es.id}-target`,type:"aurora"};ge(Bt=>Bt.find(as=>as.source===n&&as.target===Es.id)?Bt:[...Bt,fs])},tr=T=>{const P=T.target;if(P.tagName==="INPUT"||P.tagName==="TEXTAREA"||P.tagName==="SELECT"||P.tagName==="BUTTON"||P.closest("button")||P.closest("input")||P.closest("textarea")||P.closest("select"))return;const be=!F;we(be),ne(Te=>Te.map(je=>je.id===n?{...je,data:{...je.data,isExpanded:be}}:je))};return e.jsxs("div",{onDoubleClick:tr,className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var ft;const T=((ft=de(n))==null?void 0:ft.type)||"",P=g(a),be=P==="æ–‡ç”Ÿè§†é¢‘"||T==="aiVideo_t2v",Te=T==="aiVideo_i2v_first"||T==="aiVideo_i2v_last"||P==="é¦–å¸§"||P==="å°¾å¸§",je=T==="aiVideo_first_last"||P==="é¦–å°¾å¸§",ye=T==="aiVideo_reference"||P==="å‚è€ƒå›¾",et=Z.filter(We=>We.target===n),st=et.some(We=>{const Dt=de(We.source);return(Dt==null?void 0:Dt.type)==="agent"}),kt=et.reduce((We,Dt)=>{var zt,At,Ut,Vt;const Xt=de(Dt.source),Lt=(Xt==null?void 0:Xt.type)||"";if(Lt==="aiImage"||Lt==="imagePreview")return We+1;if(Lt==="upload"){const Ft=(Ut=(At=(zt=Xt==null?void 0:Xt.data)==null?void 0:zt.config)==null?void 0:At.uploadedFiles)==null?void 0:Ut[0],ts=((Ft==null?void 0:Ft.type)||"").toUpperCase(),rs=((Ft==null?void 0:Ft.mimeType)||"").toLowerCase();return We+(ts==="IMAGE"||rs.startsWith("image/")?1:0)}if(Lt==="assetSelector"){const Ft=((Vt=Xt==null?void 0:Xt.data)==null?void 0:Vt.config)||{};if(Ft.selectedAsset)return We+((Ft.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ft.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Ft.subjects&&Ft.subjects.length>0)return We+((Ft.subjects[0].images||[]).length||0)}return We},0);return be?!st:Te?!(st&&kt>=1):je?!(st&&kt>=2):ye?!(st&&kt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),X&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ie}),xe==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{V(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{V(!1),h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{V(!1),await bs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:L,onChange:T=>Tt(T),options:vs.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:vs.map(T=>({value:T.id,label:T.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ge?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:I,value:x,onChange:T=>{var je;const P=(je=le==null?void 0:le.modelId)==null?void 0:je.includes("viduq2"),be=g(a)==="å‚è€ƒå›¾";P&&be?wt(T):(c(T.target.value),u(!1))},onKeyDown:T=>{var Te;const P=(Te=le==null?void 0:le.modelId)==null?void 0:Te.includes("viduq2"),be=g(a)==="å‚è€ƒå›¾";P&&be&&ks(T)},placeholder:(Ve=le==null?void 0:le.modelId)!=null&&Ve.includes("viduq2")&&g(a)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),k&&E.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:E.map((T,P)=>e.jsxs("button",{type:"button",onClick:()=>Yt(T),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${P===Se?"bg-purple-100 dark:bg-purple-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[T.thumbnail?e.jsx("img",{src:T.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-200 dark:bg-purple-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-purple-600 dark:text-purple-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",T.name]})})]},T.id))})]})]}),Object.keys(Re).length>0&&((qe=le==null?void 0:le.modelId)==null?void 0:qe.includes("viduq2"))&&g(a)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys(Re).map(T=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-purple-500/10 dark:bg-purple-500/20 border border-purple-400/50 dark:border-purple-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-purple-500 dark:text-purple-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-purple-700 dark:text-purple-300",children:T}),e.jsx("button",{type:"button",onClick:()=>{Ae(Te=>{const je={...Te};return delete je[T],je});const P=new RegExp(`@${T}\\s*`,"g"),be=x.replace(P,"");c(be)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-purple-500 dark:text-purple-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},T))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ge&&l.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(Le=l[0])!=null&&Le.name&&l[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",a==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",g(a)==="å‚è€ƒå›¾"&&l.some(T=>!T.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:l.map((T,P)=>{const be=l.slice(0,P+1).filter(ye=>!ye.id.includes("subject")).length,Te=!T.id.includes("subject"),je=Te?`å›¾${be}`:T.name;return e.jsxs("div",{draggable:a==="é¦–å°¾å¸§",onDragStart:()=>Hs(P),onDragOver:Xs,onDrop:()=>nr(P),onClick:()=>{Te&&g(a)==="å‚è€ƒå›¾"&&Ye(je)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${a==="é¦–å°¾å¸§"?"cursor-move":Te&&g(a)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${B===P?"opacity-50":""} ${T.id.includes("subject")?"border-purple-400 dark:border-purple-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-purple-400 dark:hover:border-purple-400/50 ${Te&&g(a)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Te&&g(a)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${je}`:T.name,children:[e.jsx("img",{src:`${T.url.startsWith("http")||T.url.startsWith("data:")?T.url:gr+T.url}`,alt:T.name,className:"w-full h-full object-cover"}),T.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),T.name]}),Te&&a!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),je]}),a==="é¦–å°¾å¸§"&&!T.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:P===0?"é¦–":P===1?"å°¾":P+1})]},T.id)})})]}),le&&!Ge&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",Ct?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ze.map(T=>e.jsxs("button",{type:"button",onClick:()=>{m(T),dt({duration:T})},disabled:Ct,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${d===T?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"} disabled:opacity-50 disabled:cursor-not-allowed`,children:[T,"ç§’"]},T))})]}),Is&&(((tt=le==null?void 0:le.config.supportedRatios)==null?void 0:tt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ge?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{O("16:9"),dt({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${j==="16:9"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{O("9:16"),dt({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${j==="9:16"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:j,onChange:T=>{O(T),dt({ratio:T})},options:((le==null?void 0:le.config.supportedRatios)||[]).map(T=>{const[P,be]=T.split(":");return{value:T,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[T]||`${P}:${be}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",_t?"(æœªé…ç½®)":""]}),e.jsx(os,{value:r,onChange:T=>{v(T),dt({resolution:T})},options:Wt.map(T=>({value:T,label:T})),className:_t?"opacity-50 pointer-events-none":""})]}),((it=le==null?void 0:le.provider)==null?void 0:it.toLowerCase())==="vidu"&&(le==null?void 0:le.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(T=>e.jsx("button",{type:"button",onClick:()=>{W(T),dt({movementAmplitude:T})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${R===T?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:T==="auto"?"è‡ªåŠ¨":T==="small"?"å°":T==="medium"?"ä¸­":"å¤§"},T))})]}),(le==null?void 0:le.config.supportsAudioOutput)&&g(a)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const T=!f;w(T),dt({audio:T})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${f?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${f?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:er,disabled:_||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${_?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:_?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!he&&(se?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",ae,"æ¬¡"]}):Ue!==null&&Ue>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[Ue,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:x?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-purple-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-purple-300 line-clamp-6 whitespace-pre-wrap break-words",children:x})]}):e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ur=t.memo(qa),Ya=s=>{const{data:N}=s;return e.jsx(ur,{...s,data:{...N,config:{...N==null?void 0:N.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Ka=t.memo(Ya),Za=s=>{const{data:N}=s;return e.jsx(ur,{...s,data:{...N,config:{...N==null?void 0:N.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},Qa=t.memo(Za),eo=s=>{const{data:N}=s;return e.jsx(ur,{...s,data:{...N,config:{...N==null?void 0:N.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},to=t.memo(eo),so=s=>{const{data:N}=s;return e.jsx(ur,{...s,data:{...N,config:{...N==null?void 0:N.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},ro=t.memo(so),ao=s=>{const N=(s==null?void 0:s.data)||{},n=N.config||{};return e.jsx(ur,{...s,data:{...N,config:{...n,generationType:(n==null?void 0:n.lockedGenerationType)||(n==null?void 0:n.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(n==null?void 0:n.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(n==null?void 0:n.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(n==null?void 0:n.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},oo=t.memo(ao),lr="https://api.waule.com",no=({data:s,selected:N,id:n})=>{var $,j,O,r,v,g;const[F]=t.useState(!0),[we,U]=t.useState(!1),[fe]=t.useState(""),[Q,re]=t.useState("wan-std"),[K,ce]=t.useState(0),Ue=t.useRef(null),{setNodes:he,setEdges:se,getNode:ae,getNodes:Ie,getEdges:ne}=Zt(),ge=zs(),de=s.config.modelId,{credits:me,loading:Ee}=Us({aiModelId:de,duration:K,mode:Q==="wan-pro"?"pro":"standard"}),Z=t.useMemo(()=>{var d;const a=s.models||[],y=(d=s==null?void 0:s.config)==null?void 0:d.selectedEditingCapability;return a.filter(m=>{var f;return(m.type||"")==="VIDEO_EDITING"&&Array.isArray((f=m.config)==null?void 0:f.supportedEditingCapabilities)&&(y?m.config.supportedEditingCapabilities.includes(y):m.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||m.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,($=s==null?void 0:s.config)==null?void 0:$.selectedEditingCapability]),[z,A]=t.useState(s.config.modelId||((j=Z[0])==null?void 0:j.id)||""),S=t.useMemo(()=>Z.find(a=>a.id===z),[Z,z]);t.useEffect(()=>{var a;if(!Z.find(y=>y.id===z)){const y=((a=Z[0])==null?void 0:a.id)||"";A(y),he(d=>d.map(m=>{var f;return m.id===n?{...m,data:{...m.data,config:{...m.data.config,modelId:y||void 0,modelName:y?(f=Z[0])==null?void 0:f.name:void 0}}}:m}))}},[Z]),t.useEffect(()=>{},[S]);const G=t.useMemo(()=>{var R,W,_,p,l,i,B,M,X,V,ie,xe,oe,k,u,E;const a=ge.filter(b=>b.target===n);let y=null,d=0,m=null,f=null,w=null;for(const b of a){const Y=ae(b.source);if(!Y)continue;const ue=String(Y.type||"");if(ue==="upload"){const H=(_=(W=(R=Y.data)==null?void 0:R.config)==null?void 0:W.uploadedFiles)==null?void 0:_[0];if(!H)continue;const pe=String(H.mimeType||"").toLowerCase(),Se=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${lr}${H.url}`;!m&&(Se==="VIDEO"||pe.startsWith("video/"))&&(m=Ne,w=b.id),!y&&(Se==="IMAGE"||pe.startsWith("image/"))&&(y=Ne,d=H.size||0,f=b.id)}else if(ue==="assetSelector"){const H=(l=(p=Y.data)==null?void 0:p.config)==null?void 0:l.selectedAsset;if(H){const Se=String(H.mimeType||"").toLowerCase(),Ne=String(H.type||"").toUpperCase(),Re=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${lr}${H.url}`;!m&&(Ne==="VIDEO"||Se.startsWith("video/"))&&(m=Re,w=b.id),!y&&(Ne==="IMAGE"||Se.startsWith("image/"))&&(y=Re,d=H.size||0,f=b.id)}const pe=((B=(i=Y.data)==null?void 0:i.config)==null?void 0:B.subjects)||[];if(!y&&Array.isArray(pe)&&pe.length>0){const Ne=(((M=pe[0])==null?void 0:M.images)||[])[0];Ne&&(y=Ne.startsWith("http")||Ne.startsWith("data:")?Ne:`${lr}${Ne}`,f=b.id)}}else if(ue==="aiImage"){const H=(V=(X=Y.data)==null?void 0:X.config)==null?void 0:V.generatedImageUrl;!y&&H&&(y=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,f=b.id)}else if(ue==="imagePreview"){const H=((ie=Y.data)==null?void 0:ie.imageUrl)||((xe=Y.data)==null?void 0:xe.url);!y&&H&&(y=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,f=b.id)}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const H=((oe=Y.data)==null?void 0:oe.videoUrl)||((k=Y.data)==null?void 0:k.url)||((E=(u=Y.data)==null?void 0:u.config)==null?void 0:E.generatedVideoUrl);!m&&H&&(m=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,w=b.id)}if(y&&m)break}return{imageUrl:y,videoUrl:m,imageSize:d,imageEdgeId:f,videoEdgeId:w}},[ge,n,ae]);t.useEffect(()=>{if(G.imageSize>5*1024*1024){const y=(G.imageSize/1024/1024).toFixed(2);h.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${y}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),G.imageEdgeId&&se(d=>d.filter(m=>m.id!==G.imageEdgeId))}if(!G.videoUrl){ce(0);return}const a=document.createElement("video");a.src=G.videoUrl,a.onloadedmetadata=()=>{const y=a.duration||0,d=a.videoWidth,m=a.videoHeight;ce(y);let f="";y<2||y>30?f=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${y.toFixed(1)}ç§’ï¼‰`:(d>2048||m>2048)&&(f=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${d}x${m}ï¼‰`),f&&(h.error(f+"ï¼Œè¿æ¥å·²æ–­å¼€"),G.videoEdgeId&&se(w=>w.filter(R=>R.id!==G.videoEdgeId)))},a.onerror=()=>ce(0),a.load()},[G.videoUrl,G.imageSize,G.videoEdgeId,G.imageEdgeId,se]);const x=t.useMemo(()=>!!z&&!!G.videoUrl&&!!G.imageUrl,[z,G.videoUrl,G.imageUrl]),c=t.useCallback(a=>{var k,u,E;const y=ae(n);if(!y||!a)return;const d=Ie(),m=ne(),f=d.filter(b=>b.type==="videoPreview"&&m.some(Y=>Y.source===n&&Y.target===b.id));if(f.find(b=>{var Y;return((Y=b.data)==null?void 0:Y.videoUrl)===a}))return;const R=400,W=(b,Y=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(b))return Y;const[ue,H]=b.split(":").map(pe=>parseFloat(pe));return!ue||!H?Y:Math.round(R*(H/ue))},_=200,p=100,l=W("16:9",300),i=document.querySelector(`.react-flow__node[data-id="${n}"]`),B=Math.round((i==null?void 0:i.getBoundingClientRect().width)||400),M=(((k=y.position)==null?void 0:k.x)||0)+B+_,X=((u=y.position)==null?void 0:u.y)||0,V=f.length,ie=M,xe=X+V*(l+p),oe={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:ie,y:xe},data:{videoUrl:a,width:R,ratio:"16:9",workflowContext:y.data.workflowContext,createdBy:(E=y.data)==null?void 0:E.createdBy}};he(b=>[...b,oe]),se(b=>[...b,{id:`edge-${n}-${oe.id}`,source:n,target:oe.id,type:"aurora"}])},[n,ae,Ie,ne,he,se]);t.useEffect(()=>{var y;const a=(y=s==null?void 0:s.config)==null?void 0:y.generatedVideoUrl;a&&c(a)},[(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl]),t.useEffect(()=>{const a=s.config.taskId;(async()=>{var m,f;let d=!1;if(a)try{const R=(await Ce.tasks.getTaskStatus(a)).task;if(R.status==="SUCCESS"){const W=R.resultUrl||((m=R.previewNodeData)==null?void 0:m.url);if(W){let _=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";_=JSON.parse(p).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}_||c(W),he(p=>p.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:W,taskId:a}}}:l))}U(!1),d=!0}else if(R.status==="PROCESSING"||R.status==="PENDING"){U(!0),await I(a);return}else R.status==="FAILURE"&&(U(!1),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_)))}catch{U(!1)}if(!d)try{const w=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(w.tasks)&&w.tasks.length>0)for(const R of w.tasks){const W=(f=R.previewNodeData)==null?void 0:f.url;if(W){let _=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";_=JSON.parse(p).some(i=>i.taskId&&i.taskId===R.id||i.sourceNodeId&&i.sourceNodeId===n)}catch{}_||c(W),await Ce.tasks.markPreviewNodeCreated(R.id)}}}catch{}})()},[]);const I=async a=>{let y=0;const d=600,m=async()=>{var f;try{y++;const R=(await Ce.tasks.getTaskStatus(a)).task;if(R.status==="SUCCESS"){const W=R.resultUrl||((f=R.previewNodeData)==null?void 0:f.url);if(W){let _=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";_=JSON.parse(p).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}_||c(W),he(p=>p.map(l=>l.id!==n?l:{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:W,taskId:a}}}))}U(!1),h.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(R.status==="PROCESSING"||R.status==="PENDING")if(y<d)setTimeout(m,5e3);else{U(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_));return}else if(R.status==="FAILURE"){U(!1);try{const{useAuthStore:W}=await xs(async()=>{const{useAuthStore:p}=await import("./index-B-U_h0BA.js").then(l=>l.f);return{useAuthStore:p}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_}=W.getState();await _()}catch{}h.error(R.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_));return}else{U(!1),h.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_));return}}catch{U(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),he(R=>R.map(W=>W.id===n?{...W,data:{...W.data,config:{...W.data.config,taskId:""}}}:W));return}};m()},L=async()=>{var a,y;if(!x){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}U(!0);try{const d=await Ce.post("/tasks/video-edit",{modelId:z,prompt:fe||"",referenceImages:G.imageUrl?[G.imageUrl]:[],sourceNodeId:n,duration:K,metadata:{videoUrl:G.videoUrl,wanMode:Q,duration:K}}),m=d.taskId,f=d.creditsCharged||0;if(f>0)try{const{useAuthStore:w}=await xs(async()=>{const{useAuthStore:W}=await import("./index-B-U_h0BA.js").then(_=>_.f);return{useAuthStore:W}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:R}=w.getState();await R(),h.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${f} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");he(w=>w.map(R=>R.id===n?{...R,data:{...R.data,config:{...R.data.config,taskId:m}}}:R)),await I(m)}catch(d){U(!1);const m=((y=(a=d==null?void 0:d.response)==null?void 0:a.data)==null?void 0:y.error)||d.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${m}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:z,onChange:a=>{A(a),he(y=>y.map(d=>{var m;return d.id===n?{...d,data:{...d.data,config:{...d.data.config,modelId:a,modelName:(m=Z.find(f=>f.id===a))==null?void 0:m.name}}}:d}))},options:Z.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Z.map(a=>({value:a.id,label:a.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>re("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Q==="wan-std"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>re("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Q==="wan-pro"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((v=s==null?void 0:s.config)==null?void 0:v.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),G.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Ue,src:G.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:a=>{const y=a.currentTarget;y.duration&&y.duration!==1/0&&ce(y.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((g=s==null?void 0:s.config)==null?void 0:g.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),G.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:G.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:L,disabled:we||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${we?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:we?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ee&&(me!==null&&me>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[me,"ç§¯åˆ†"]}):K===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},io=t.memo(no),br="https://api.waule.com",lo=({data:s,selected:N,id:n})=>{var W,_;const[F]=t.useState(!0),[we,U]=t.useState(!1),[fe,Q]=t.useState(!1),re=t.useRef(null),K=t.useRef(null),ce=t.useRef(null),[Ue,he]=t.useState(!1),[se,ae]=t.useState(0),[Ie,ne]=t.useState(0),[ge,de]=t.useState(0),[me,Ee]=t.useState(null),{setNodes:Z,setEdges:z,getNode:A,getNodes:S,getEdges:G}=Zt(),x=zs(),c=Ds(),I=t.useMemo(()=>`lipSyncTask:${n}`,[n]),L=t.useMemo(()=>(s.models||[]).filter(l=>{var i;return(l.type||"")==="VIDEO_EDITING"&&Array.isArray((i=l.config)==null?void 0:i.supportedEditingCapabilities)&&l.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[$,j]=t.useState(s.config.modelId||((W=L[0])==null?void 0:W.id)||"");t.useEffect(()=>{var p;if(!L.find(l=>l.id===$)){const l=((p=L[0])==null?void 0:p.id)||"";j(l),Z(i=>i.map(B=>{var M;return B.id===n?{...B,data:{...B.data,config:{...B.data.config,modelId:l||void 0,modelName:l?(M=L[0])==null?void 0:M.name:void 0}}}:B}))}},[L]);const O=t.useMemo(()=>!Ie||!se?0:Ie>=se||fe?se:Ie,[Ie,se,fe]),{credits:r,loading:v}=Us({aiModelId:$,duration:O,mode:"standard",operationType:"video_retalk"}),g=t.useMemo(()=>{var M,X,V,ie,xe,oe,k,u,E;const p=x.filter(b=>b.target===n);let l=null,i=null,B=null;for(const b of p){const Y=c.find(H=>H.id===b.source);if(!Y)continue;const ue=String(Y.type||"");if(ue==="upload"){const H=(V=(X=(M=Y.data)==null?void 0:M.config)==null?void 0:X.uploadedFiles)==null?void 0:V[0];if(!H)continue;const pe=String(H.mimeType||"").toLowerCase(),Se=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${br}${H.url}`;!l&&(Se==="VIDEO"||pe.startsWith("video/"))&&(l=Ne),!i&&(Se==="AUDIO"||pe.startsWith("audio/"))&&(i=Ne),!B&&(Se==="IMAGE"||pe.startsWith("image/"))&&(B=Ne)}else if(ue==="assetSelector"){const H=(xe=(ie=Y.data)==null?void 0:ie.config)==null?void 0:xe.selectedAsset;if(H){const pe=String(H.mimeType||"").toLowerCase(),Se=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${br}${H.url}`;!l&&(Se==="VIDEO"||pe.startsWith("video/"))&&(l=Ne),!i&&(Se==="AUDIO"||pe.startsWith("audio/"))&&(i=Ne),!B&&(Se==="IMAGE"||pe.startsWith("image/"))&&(B=Ne)}}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const H=((oe=Y.data)==null?void 0:oe.videoUrl)||((k=Y.data)==null?void 0:k.url)||((E=(u=Y.data)==null?void 0:u.config)==null?void 0:E.generatedVideoUrl);!l&&H&&(l=H.startsWith("http")||H.startsWith("data:")?H:`${br}${H}`)}if(l&&i&&B)break}return{videoUrl:l,audioUrl:i,imageUrl:B}},[x,n,c]),a=t.useMemo(()=>{var l;const p=L.find(i=>i.id===$);return((l=p==null?void 0:p.modelId)==null?void 0:l.toLowerCase().includes("videoretalk"))||!1},[$,L]),y=t.useMemo(()=>!!$&&!!g.videoUrl&&!!g.audioUrl&&!me,[$,g.videoUrl,g.audioUrl,me]);t.useEffect(()=>{const p=re.current;if(!p||!g.audioUrl)return;p.src=g.audioUrl,p.load();const l=()=>{ae(p.duration||0)},i=()=>de(p.duration?p.currentTime/p.duration:0),B=()=>he(!1);return p.addEventListener("loadedmetadata",l),p.addEventListener("timeupdate",i),p.addEventListener("ended",B),()=>{p.removeEventListener("loadedmetadata",l),p.removeEventListener("timeupdate",i),p.removeEventListener("ended",B)}},[g.audioUrl]),t.useEffect(()=>{if(!g.videoUrl){ne(0);return}const p=document.createElement("video");p.src=g.videoUrl,p.onloadedmetadata=()=>{if(ne(p.duration||0),a){const l=p.videoWidth,i=p.videoHeight;l>2048||i>2048?(Ee(`è§†é¢‘åˆ†è¾¨ç‡ ${l}x${i} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),h.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${l}x${i}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),z(B=>B.filter(M=>{var ie,xe,oe,k,u,E,b,Y;if(M.target!==n)return!0;const X=c.find(ue=>ue.id===M.source);return X?!(X.type==="upload"&&((k=(oe=(xe=(ie=X.data)==null?void 0:ie.config)==null?void 0:xe.uploadedFiles)==null?void 0:oe[0])==null?void 0:k.type)==="VIDEO"||X.type==="assetSelector"&&((b=(E=(u=X.data)==null?void 0:u.config)==null?void 0:E.selectedAsset)==null?void 0:b.type)==="VIDEO"||X.type==="videoPreview"||((Y=X.type)==null?void 0:Y.startsWith("aiVideo"))):!0}))):me!=null&&me.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ee(null)}},p.onerror=()=>ne(0),p.load()},[g.videoUrl,a,n,c,z]),t.useEffect(()=>{const p=g.audioUrl,l=ce.current;if(!p||!l)return;const i=M=>{const X=l.getContext("2d");if(!X)return;const V=l.width,ie=l.height;X.clearRect(0,0,V,ie);const xe="#1a1033",oe="#7a0fe8";X.fillStyle=xe,X.fillRect(0,0,V,ie);const k=M.length,u=2,E=Math.max(1,Math.floor((V-(k-1)*u)/k));for(let b=0;b<k;b++){const Y=Math.min(1,Math.max(0,M[b])),ue=Math.max(2,Math.floor(Y*ie)),H=b*(E+u),pe=Math.floor((ie-ue)/2);X.fillStyle=oe,X.fillRect(H,pe,E,ue)}if(ge>0){const b=Math.floor(V*ge);X.fillStyle="#ffffff88",X.fillRect(b,0,2,ie)}};(async()=>{try{let M=p;p.includes("aliyuncs.com")&&(M=`https://api.waule.com/proxy/audio?url=${encodeURIComponent(p)}`);const V=await(await fetch(M,{mode:(p.includes("aliyuncs.com"),"cors"),credentials:p.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ie=window.AudioContext||window.webkitAudioContext,k=(await new ie().decodeAudioData(V)).getChannelData(0),u=120,E=Math.max(1,Math.floor(k.length/u)),b=new Float32Array(u);for(let Y=0;Y<u;Y++){let ue=0,H=0;const pe=Y*E,Se=Math.min(k.length,pe+E);for(let Ne=pe;Ne<Se;Ne++)ue+=Math.abs(k[Ne]),H++;b[Y]=H?ue/H:0}i(b)}catch{const X=new Float32Array(120);for(let V=0;V<120;V++)X[V]=(Math.sin(V/5)+1)/2;i(X)}})()},[g.audioUrl,ge]);const d=()=>{const p=re.current;p&&(Ue?(p.pause(),he(!1)):(p.play(),he(!0)))},m=p=>{if(!p||!isFinite(p))return"0:00";const l=Math.floor(p/60),i=Math.floor(p%60);return`${l}:${i.toString().padStart(2,"0")}`},f=t.useCallback(p=>{var Re,Ae,_e;const l=A(n);if(!l||!p)return;const i=p.startsWith("http")||p.startsWith("data:")?p:`${br}${p}`,B=S(),M=G(),X=B.filter($e=>$e.type==="videoPreview"&&M.some(le=>le.source===n&&le.target===$e.id));if(X.find($e=>{var le;return((le=$e.data)==null?void 0:le.videoUrl)===i}))return;const ie=400,xe=($e,le=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test($e))return le;const[Ge,Ze]=$e.split(":").map(Wt=>parseFloat(Wt));return!Ge||!Ze?le:Math.round(ie*(Ze/Ge))},oe=200,k=100,u=xe("16:9",300),E=document.querySelector(`.react-flow__node[data-id="${n}"]`),b=Math.round((E==null?void 0:E.getBoundingClientRect().width)||400),Y=(((Re=l.position)==null?void 0:Re.x)||0)+b+oe,ue=((Ae=l.position)==null?void 0:Ae.y)||0,H=X.length,pe=Y,Se=ue+H*(u+k),Ne={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:pe,y:Se},data:{videoUrl:i,ratio:"16:9",workflowContext:l.data.workflowContext,createdBy:(_e=l.data)==null?void 0:_e.createdBy}};Z($e=>[...$e,Ne]),z($e=>[...$e,{id:`edge-${n}-${Ne.id}`,source:n,target:Ne.id,type:"aurora"}])},[n,A,S,G,Z,z]);t.useEffect(()=>{var l;const p=(l=s==null?void 0:s.config)==null?void 0:l.generatedVideoUrl;p&&f(p)},[(_=s==null?void 0:s.config)==null?void 0:_.generatedVideoUrl]),t.useEffect(()=>{const p=s.config.taskId||(()=>{try{return localStorage.getItem(I)||""}catch{return""}})();(async()=>{var B,M;let i=!1;if(p)try{const V=(await Ce.tasks.getTaskStatus(p)).task;if(V.status==="PROCESSING"||V.status==="PENDING"){const ie=new Date(V.createdAt);if((new Date().getTime()-ie.getTime())/(1e3*60*60)>1){U(!1),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(I)}catch{}return}}if(V.status==="SUCCESS"||V.status==="COMPLETED"||V.status==="DONE"){const ie=V.resultUrl||((B=V.previewNodeData)==null?void 0:B.url);if(ie){let xe=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";xe=JSON.parse(oe).some(u=>u.taskId&&u.taskId===p||u.sourceNodeId&&u.sourceNodeId===n)}catch{}xe||f(ie),Z(oe=>oe.map(k=>k.id===n?{...k,data:{...k.data,config:{...k.data.config,generatedVideoUrl:ie,taskId:p}}}:k))}U(!1);try{localStorage.removeItem(I)}catch{}i=!0}else if(V.status==="PROCESSING"||V.status==="PENDING"){U(!0),await w(p);return}else if(V.status==="FAILURE"||V.status==="FAILED"){U(!1),Z(ie=>ie.map(xe=>xe.id===n?{...xe,data:{...xe.data,config:{...xe.data.config,taskId:""}}}:xe));try{localStorage.removeItem(I)}catch{}}}catch{U(!1);try{localStorage.removeItem(I)}catch{}}if(!i)try{const X=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(X.tasks)&&X.tasks.length>0)for(const V of X.tasks){const ie=(M=V.previewNodeData)==null?void 0:M.url;if(ie){let xe=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";xe=JSON.parse(oe).some(u=>u.taskId&&u.taskId===V.id||u.sourceNodeId&&u.sourceNodeId===n)}catch{}xe||f(ie),await Ce.tasks.markPreviewNodeCreated(V.id)}}}catch{}})()},[I,n,f]);const w=async p=>{let l=0;const i=600;let B=-1,M=0;const X=60,V=async()=>{var ie;try{l++;const oe=(await Ce.tasks.getTaskStatus(p)).task;if(oe.status==="PROCESSING"||oe.status==="PENDING"){const k=oe.progress||0;if(k===B){if(M++,M>=X){U(!1),h.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),Z(u=>u.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,taskId:""}}}:E));try{localStorage.removeItem(I)}catch{}return}}else B=k,M=0}if(oe.status==="SUCCESS"||oe.status==="COMPLETED"||oe.status==="DONE"){const k=oe.resultUrl||((ie=oe.previewNodeData)==null?void 0:ie.url);k&&(f(k),Z(u=>u.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,generatedVideoUrl:k,taskId:p}}}:E))),U(!1),h.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(I)}catch{}return}else if(oe.status==="PROCESSING"||oe.status==="PENDING")if(l<i)setTimeout(V,5e3);else{U(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(I)}catch{}return}else if(oe.status==="FAILURE"||oe.status==="FAILED"){U(!1);try{const{useAuthStore:k}=await xs(async()=>{const{useAuthStore:E}=await import("./index-B-U_h0BA.js").then(b=>b.f);return{useAuthStore:E}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:u}=k.getState();await u()}catch{}h.error(oe.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(I)}catch{}return}else{U(!1),h.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(I)}catch{}return}}catch{U(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(oe=>oe.map(k=>k.id===n?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));try{localStorage.removeItem(I)}catch{}return}};V()},R=async()=>{var p,l;if(!y){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}U(!0);try{const i=await Ce.post("/tasks/video-edit",{modelId:$,prompt:"",referenceImages:g.imageUrl?[g.imageUrl]:[],sourceNodeId:n,generationType:"å¯¹å£å‹",duration:O,metadata:{videoUrl:g.videoUrl,audioUrl:g.audioUrl,videoExtension:fe,duration:O}}),B=i.taskId,M=i.creditsCharged||0;if(M>0)try{const{useAuthStore:X}=await xs(async()=>{const{useAuthStore:ie}=await import("./index-B-U_h0BA.js").then(xe=>xe.f);return{useAuthStore:ie}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:V}=X.getState();await V(),h.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");Z(X=>X.map(V=>V.id===n?{...V,data:{...V.data,config:{...V.data.config,taskId:B}}}:V));try{localStorage.setItem(I,B)}catch{}await w(B)}catch(i){U(!1);const B=((l=(p=i==null?void 0:i.response)==null?void 0:p.data)==null?void 0:l.error)||i.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(I)}catch{}}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:$,onChange:p=>{j(p),Z(l=>l.map(i=>{var B;return i.id===n?{...i,data:{...i.data,config:{...i.data.config,modelId:p,modelName:(B=L.find(M=>M.id===p))==null?void 0:B.name}}}:i}))},options:L.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:L.map(p=>({value:p.id,label:p.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:g.videoUrl?e.jsx("video",{src:g.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},g.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:g.imageUrl?e.jsx("img",{src:g.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},g.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),g.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:d,className:"nodrag w-7 h-7 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Ue?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:m(se)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:ce,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:re,src:g.audioUrl,className:"hidden"}),e.jsx("video",{ref:K,className:"hidden",muted:!0,onLoadedMetadata:p=>{const l=p.currentTarget;l.duration&&l.duration!==1/0&&ne(l.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:fe,onChange:p=>Q(p.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:R,disabled:we||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${we?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:we?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!v&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[r,"ç§¯åˆ†"]}):O===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},co=t.memo(lo),vr="https://api.waule.com",uo=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],po=({data:s,selected:N,id:n})=>{var L,$;const[F]=t.useState(!0),[we,U]=t.useState(!1),[fe,Q]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[re,K]=t.useState(s.config.videoFps||15),[ce,Ue]=t.useState(0),he=t.useRef(null),{setNodes:se,setEdges:ae,getNode:Ie,getNodes:ne,getEdges:ge}=Zt(),de=zs(),me=t.useMemo(()=>(s.models||[]).filter(O=>{var r;return(O.type||"")==="VIDEO_EDITING"&&Array.isArray((r=O.config)==null?void 0:r.supportedEditingCapabilities)&&O.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ee,Z]=t.useState(s.config.modelId||((L=me[0])==null?void 0:L.id)||""),{credits:z,loading:A}=Us({aiModelId:Ee,duration:ce});t.useMemo(()=>me.find(j=>j.id===Ee),[me,Ee]),t.useEffect(()=>{var j;if(!me.find(O=>O.id===Ee)){const O=((j=me[0])==null?void 0:j.id)||"";Z(O),se(r=>r.map(v=>{var g;return v.id===n?{...v,data:{...v.data,config:{...v.data.config,modelId:O||void 0,modelName:O?(g=me[0])==null?void 0:g.name:void 0}}}:v}))}},[me]);const S=t.useMemo(()=>{var r,v,g,a,y,d,m,f,w;const j=de.filter(R=>R.target===n);let O=null;for(const R of j){const W=Ie(R.source);if(!W)continue;const _=String(W.type||"");if(_==="upload"){const p=(g=(v=(r=W.data)==null?void 0:r.config)==null?void 0:v.uploadedFiles)==null?void 0:g[0];if(!p)continue;const l=String(p.mimeType||"").toLowerCase(),i=String(p.type||"").toUpperCase(),B=p.url.startsWith("http")||p.url.startsWith("data:")?p.url:`${vr}${p.url}`;!O&&(i==="VIDEO"||l.startsWith("video/"))&&(O=B)}else if(_==="assetSelector"){const p=(y=(a=W.data)==null?void 0:a.config)==null?void 0:y.selectedAsset;if(p){const l=String(p.mimeType||"").toLowerCase(),i=String(p.type||"").toUpperCase(),B=p.url.startsWith("http")||p.url.startsWith("data:")?p.url:`${vr}${p.url}`;!O&&(i==="VIDEO"||l.startsWith("video/"))&&(O=B)}}else if(_==="videoPreview"||_.startsWith("aiVideo")){const p=((d=W.data)==null?void 0:d.videoUrl)||((m=W.data)==null?void 0:m.url)||((w=(f=W.data)==null?void 0:f.config)==null?void 0:w.generatedVideoUrl);!O&&p&&(O=p.startsWith("http")||p.startsWith("data:")?p:`${vr}${p}`)}if(O)break}return{videoUrl:O}},[de,n,Ie]);t.useEffect(()=>{if(!S.videoUrl){Ue(0);return}const j=document.createElement("video");j.preload="metadata",j.onloadedmetadata=()=>{j.duration&&j.duration!==1/0&&Ue(j.duration)},j.onerror=()=>Ue(0),j.src=S.videoUrl},[S.videoUrl]);const G=t.useMemo(()=>!!Ee&&!!S.videoUrl,[Ee,S.videoUrl]),x=t.useCallback(j=>{var X,V,ie;const O=Ie(n);if(!O||!j)return;const r=ne(),v=ge(),g=r.filter(xe=>xe.type==="videoPreview"&&v.some(oe=>oe.source===n&&oe.target===xe.id));if(g.find(xe=>{var oe;return((oe=xe.data)==null?void 0:oe.videoUrl)===j}))return;const y=400,d=(xe,oe=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(xe))return oe;const[k,u]=xe.split(":").map(E=>parseFloat(E));return!k||!u?oe:Math.round(y*(u/k))},m=200,f=100,w=d("16:9",300),R=document.querySelector(`.react-flow__node[data-id="${n}"]`),W=Math.round((R==null?void 0:R.getBoundingClientRect().width)||400),_=(((X=O.position)==null?void 0:X.x)||0)+W+m,p=((V=O.position)==null?void 0:V.y)||0,l=g.length,i=_,B=p+l*(w+f),M={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:i,y:B},data:{videoUrl:j,width:y,ratio:"16:9",workflowContext:O.data.workflowContext,createdBy:(ie=O.data)==null?void 0:ie.createdBy}};se(xe=>[...xe,M]),ae(xe=>[...xe,{id:`edge-${n}-${M.id}`,source:n,target:M.id,type:"aurora"}])},[n,Ie,ne,ge,se,ae]);t.useEffect(()=>{var O;const j=(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl;j&&x(j)},[($=s==null?void 0:s.config)==null?void 0:$.generatedVideoUrl]),t.useEffect(()=>{const j=s.config.taskId;(async()=>{var v,g;let r=!1;if(j)try{const y=(await Ce.tasks.getTaskStatus(j)).task;if(y.status==="SUCCESS"){const d=y.resultUrl||((v=y.previewNodeData)==null?void 0:v.url);if(d){let m=!1;try{const f=localStorage.getItem("suppressedPreviewTasks")||"[]";m=JSON.parse(f).some(R=>R.taskId&&R.taskId===j||R.sourceNodeId&&R.sourceNodeId===n)}catch{}m||x(d),se(f=>f.map(w=>w.id===n?{...w,data:{...w.data,config:{...w.data.config,generatedVideoUrl:d,taskId:j}}}:w))}U(!1),r=!0}else if(y.status==="PROCESSING"||y.status==="PENDING"){U(!0),await c(j);return}else y.status==="FAILURE"&&(U(!1),se(d=>d.map(m=>m.id===n?{...m,data:{...m.data,config:{...m.data.config,taskId:""}}}:m)))}catch{U(!1)}if(!r)try{const a=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(a.tasks)&&a.tasks.length>0)for(const y of a.tasks){const d=(g=y.previewNodeData)==null?void 0:g.url;if(d){let m=!1;try{const f=localStorage.getItem("suppressedPreviewTasks")||"[]";m=JSON.parse(f).some(R=>R.taskId&&R.taskId===y.id||R.sourceNodeId&&R.sourceNodeId===n)}catch{}m||x(d),await Ce.tasks.markPreviewNodeCreated(y.id)}}}catch{}})()},[]);const c=async j=>{let O=0;const r=600,v=async()=>{var g;try{O++;const y=(await Ce.tasks.getTaskStatus(j)).task;if(y.status==="SUCCESS"){const d=y.resultUrl||((g=y.previewNodeData)==null?void 0:g.url);d&&(x(d),se(m=>m.map(f=>f.id!==n?f:{...f,data:{...f.data,config:{...f.data.config,generatedVideoUrl:d,taskId:j}}}))),U(!1),h.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else y.status==="PROCESSING"||y.status==="PENDING"?O<r?setTimeout(v,5e3):(U(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),se(d=>d.map(m=>m.id===n?{...m,data:{...m.data,config:{...m.data.config,taskId:""}}}:m))):y.status==="FAILURE"&&(U(!1),h.error(y.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),se(d=>d.map(m=>m.id===n?{...m,data:{...m.data,config:{...m.data.config,taskId:""}}}:m)))}catch{U(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),se(y=>y.map(d=>d.id===n?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d))}};v()},I=async()=>{var j,O;if(!G){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}U(!0);try{const r=await Ce.post("/tasks/video-edit",{modelId:Ee,prompt:"",referenceImages:[],sourceNodeId:n,generationType:"é£æ ¼è½¬æ¢",duration:ce,metadata:{videoUrl:S.videoUrl,styleId:fe,videoFps:re,duration:ce}}),v=r.taskId,g=r.creditsCharged||0;if(g>0)try{const{useAuthStore:a}=await xs(async()=>{const{useAuthStore:d}=await import("./index-B-U_h0BA.js").then(m=>m.f);return{useAuthStore:d}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:y}=a.getState();await y(),h.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${g} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");se(a=>a.map(y=>y.id===n?{...y,data:{...y.data,config:{...y.data.config,taskId:v,styleId:fe,videoFps:re}}}:y)),await c(v)}catch(r){U(!1);const v=((O=(j=r==null?void 0:r.response)==null?void 0:j.data)==null?void 0:O.error)||r.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${v}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(os,{value:Ee,onChange:j=>{Z(j),se(O=>O.map(r=>{var v;return r.id===n?{...r,data:{...r.data,config:{...r.data.config,modelId:j,modelName:(v=me.find(g=>g.id===j))==null?void 0:v.name}}}:r}))},options:me.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:me.map(j=>({value:j.id,label:j.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(os,{value:String(fe),onChange:j=>{const O=parseInt(j,10);Q(O),se(r=>r.map(v=>v.id===n?{...v,data:{...v.data,config:{...v.data.config,styleId:O}}}:v))},options:uo.map(j=>({value:String(j.id),label:j.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:re,min:15,max:25,onChange:j=>{let O=parseInt(j.target.value,10)||15;O<15&&(O=15),O>25&&(O=25),K(O),se(r=>r.map(v=>v.id===n?{...v,data:{...v.data,config:{...v.data.config,videoFps:O}}}:v))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),S.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:he,src:S.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:j=>{const O=j.currentTarget;O.duration&&O.duration!==1/0&&Ue(O.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:I,disabled:we||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${we?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:we?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!A&&(z!==null&&z>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[z,"ç§¯åˆ†"]}):ce===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},go=t.memo(po),fo=({data:s,selected:N,id:n})=>{const[F,we]=t.useState(null),[U,fe]=t.useState(!1),[Q,re]=t.useState(s.config.prompt||""),[K,ce]=t.useState(""),Ue=t.useRef(null),he=t.useRef(!1),[se,ae]=t.useState(!1),{setNodes:Ie,setEdges:ne,getNode:ge,getNodes:de,getEdges:me}=Zt(),Ee=Fs(a=>a.edges.filter(y=>y.target===n)),Z=Ds(),[z,A]=t.useState([]),[S,G]=t.useState([]),x=t.useRef(""),c=t.useMemo(()=>((F==null?void 0:F.roles)||[]).find(a=>a.id===K),[F,K]),{credits:I,loading:L,isFreeUsage:$,freeUsageRemaining:j}=Us({aiModelId:c==null?void 0:c.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&O(s.config.agentId)},[s.config.agentId]);const O=async a=>{var y,d,m,f,w;try{fe(!0);const R=await Ce.agents.getById(a);let W=[];try{W=await Ce.agents.roles.listByAgent(a)||[],we({...R,roles:W});const p=((y=s==null?void 0:s.config)==null?void 0:y.roleId)||"";ce(p||((d=W[0])==null?void 0:d.id)||"")}catch{we(R)}try{const _=await Ce.agents.getAvailableModels(),p=(W||[]).find(l=>{var i;return l.id===((i=s==null?void 0:s.config)==null?void 0:i.roleId)});if(p){const l=(_||[]).find(B=>B.id===p.aiModelId),i=((m=l==null?void 0:l.config)==null?void 0:m.acceptedInputs)||((l==null?void 0:l.type)==="TEXT_GENERATION"&&((w=(f=l==null?void 0:l.provider)==null?void 0:f.toLowerCase())!=null&&w.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:i})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{h.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{fe(!1)}};t.useEffect(()=>{r({roleId:K}),(async()=>{var a,y,d;if(F)try{const m=await Ce.agents.getAvailableModels(),f=(F.roles||[]).find(w=>w.id===K);if(f){const w=(m||[]).find(W=>W.id===f.aiModelId),R=((a=w==null?void 0:w.config)==null?void 0:a.acceptedInputs)||((w==null?void 0:w.type)==="TEXT_GENERATION"&&((d=(y=w==null?void 0:w.provider)==null?void 0:y.toLowerCase())!=null&&d.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:R})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[K,F]);const r=a=>{ge(n)&&Ie(d=>d.map(m=>m.id===n?{...m,data:{...m.data,config:{...m.data.config,...a}}}:m))};t.useEffect(()=>{const a=Ue.current;a&&requestAnimationFrame(()=>{a.style.height="auto";const y=Math.max(60,Math.min(a.scrollHeight,600));a.style.height=`${y}px`})},[Q]),t.useEffect(()=>{const a=setTimeout(()=>{Q!==s.config.prompt&&r({prompt:Q})},500);return()=>clearTimeout(a)},[Q,s.config.prompt]),t.useEffect(()=>{const a=Ee;if(!a||a.length===0)return;let y="";a.some(d=>{const m=Z.find(w=>w.id===d.source);if(!m)return!1;const f=m.data||{};return m.type==="textPreview"&&typeof f.content=="string"&&f.content.trim()?(y=f.content.trim(),!0):!1}),y&&!he.current&&(re(y),r({prompt:y}))},[Ee,Z]),t.useEffect(()=>{const a=Ee.map(m=>`${m.id}-${m.source}`).sort().join(",");if(a===x.current)return;x.current=a;const y=[],d=[];Ee.forEach(m=>{var R,W,_;const f=ge(m.source);if(!f)return;const w=f.data||{};if(f.type==="upload")(((R=w.config)==null?void 0:R.uploadedFiles)||[]).forEach(l=>{l.type==="IMAGE"&&y.push(l.url),l.type==="DOCUMENT"&&d.push({name:l.originalName,url:l.url})});else if(f.type==="assetSelector"){const p=(W=w.config)==null?void 0:W.subjects;if(p&&p.length>0)(p[0].images||[]).map(i=>{const B="https://api.waule.com";return i.startsWith("data:")?i:i.startsWith("http")?i.replace(/^https?:\/\/localhost(?::\d+)?/i,B):`${B}${i}`}).forEach(i=>y.push(i));else{const l=(_=w.config)==null?void 0:_.selectedAsset;if(l){const i="https://api.waule.com",B=M=>M.startsWith("http")?M.replace(/^https?:\/\/localhost(?::\d+)?/i,i):`${i}${M}`;l.type==="IMAGE"&&y.push(B(l.url)),l.type==="DOCUMENT"&&d.push({name:l.originalName,url:B(l.url)})}}}else f.type==="imagePreview"&&w.imageUrl&&y.push(w.imageUrl)}),A(y),G(d)},[Ee,ge,Z]);const v=()=>{if(!F)return null;const a=(F.roles||[]).find(y=>y.id===K);return a?{systemPrompt:a.systemPrompt,aiModelId:a.aiModelId,temperature:a.temperature,maxTokens:a.maxTokens}:null},g=async()=>{var y,d,m,f,w,R,W,_,p,l,i,B,M,X;if(!F){h.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!Q.trim()){h.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let a=(F.roles||[]).find(V=>V.id===K)||(F.roles||[])[0];if(!a){h.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!K||K!==a.id)&&(ce(a.id),r({roleId:a.id}));try{ae(!0);const ie=me().filter(Ae=>Ae.target===n);let xe="";const oe="https://api.waule.com",k=[],u=[],E=[];for(const Ae of ie){const _e=ge(Ae.source);if(_e)if(_e.type==="upload"){const $e=((d=(y=_e.data)==null?void 0:y.config)==null?void 0:d.uploadedFiles)||[];for(const le of $e)if(le.type==="DOCUMENT")k.push({filePath:le.url,mimeType:le.mimeType}),xe+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){const Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;u.push(Ge),xe+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){const Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;E.push(Ge),xe+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}else le.type==="AUDIO"&&(xe+=`[éŸ³é¢‘æ–‡ä»¶: ${le.originalName}]
`)}else if(_e.type==="assetSelector"){const $e=(f=(m=_e.data)==null?void 0:m.config)==null?void 0:f.subjects;if($e&&$e.length>0){const le=($e[0].images||[]).map(Ge=>Ge.startsWith("http")?Ge:`${oe}${Ge}`).map(Ge=>Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe));le.forEach(Ge=>u.push(Ge)),xe+=`[å‚è€ƒå›¾ç‰‡ç»„: ${le.length} å¼ ]
`}else{const le=(R=(w=_e.data)==null?void 0:w.config)==null?void 0:R.selectedAsset;if(le){if(le.type==="DOCUMENT")k.push({filePath:le.url,mimeType:le.mimeType}),xe+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){let Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ge=Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),u.push(Ge),xe+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){let Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ge=Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),E.push(Ge),xe+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}}}}else if(_e.type==="aiImage"){const $e=(_=(W=_e.data)==null?void 0:W.config)==null?void 0:_.generatedImageUrl;if($e){const le=$e.startsWith("http")?$e:`${oe}${$e}`;u.push(le),xe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(_e.type==="imagePreview"){const $e=_e.data.imageUrl;$e&&(u.push($e),xe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(_e.type==="videoPreview"){const $e=_e.data.videoUrl;if($e){const le=$e.startsWith("http")?$e:`${oe}${$e}`;E.push(le),xe+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else _e.type==="textPreview"&&_e.data.content&&(xe+=_e.data.content+`

`)}const b=v();if(!b)return;let Y=b.systemPrompt;xe&&(Y+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${xe}`),Y+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${Q}`;const ue=await Ce.ai.text.generate({modelId:a.aiModel.id||b.aiModelId,prompt:Y,systemPrompt:a.systemPrompt||b.systemPrompt,temperature:a.temperature??b.temperature,maxTokens:a.maxTokens??b.maxTokens,documentFiles:k.length>0?k:void 0,imageUrls:u.length>0?u:void 0,videoUrls:E.length>0?E:void 0}),H=ue&&(((p=ue.data)==null?void 0:p.text)||(ue==null?void 0:ue.text))||"";if(!H||H.trim()===""){h.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:H});const pe=me().filter(Ae=>Ae.source===n),Se=de(),Ne=pe.filter(Ae=>{const _e=Se.find($e=>$e.id===Ae.target);return _e&&_e.type!=="textPreview"});if(Ne.length>0)Ie(Ae=>{const _e=new Set(Ne.map($e=>$e.target));return Ae.map($e=>{var Ge;if(!_e.has($e.id))return $e;const le=((Ge=$e.data)==null?void 0:Ge.config)||{};return $e.type==="midjourney"?{...$e,data:{...$e.data,prompt:H}}:{...$e,data:{...$e.data,config:{...le,prompt:H}}}})});else{const Ae=ge(n);if(Ae){const _e=Date.now(),$e=`text-preview-${n}-${_e}`,le=pe.filter(gt=>{const vt=Se.find(lt=>lt.id===gt.target);return vt&&vt.type==="textPreview"}),Ge=document.querySelector(`.react-flow__node[data-id="${n}"]`),Ze=(Ge==null?void 0:Ge.getBoundingClientRect().width)||300,Wt=Ae.position.x+Ze+100,Ct=Ae.position.y+le.length*700,_t={id:$e,type:"textPreview",position:{x:Wt,y:Ct},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:H,createdBy:(l=Ae.data)==null?void 0:l.createdBy}},dt={id:`edge-${n}-${$e}`,source:n,target:$e,type:"aurora"};Ie(gt=>[...gt,_t]),setTimeout(()=>{ne(gt=>[...gt,dt])},50)}}const Re=(ue==null?void 0:ue.creditsCharged)||0;if(Re>0){const{useAuthStore:Ae}=await xs(async()=>{const{useAuthStore:$e}=await import("./index-B-U_h0BA.js").then(le=>le.f);return{useAuthStore:$e}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_e}=Ae.getState();await _e(),h.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${Re} ç§¯åˆ†ï¼‰`)}else h.success("æ‰§è¡ŒæˆåŠŸ")}catch(V){const ie=((B=(i=V==null?void 0:V.response)==null?void 0:i.data)==null?void 0:B.message)||((X=(M=V==null?void 0:V.response)==null?void 0:M.data)==null?void 0:X.error)||(V==null?void 0:V.message)||"æœªçŸ¥é”™è¯¯";h.error("æ‰§è¡Œå¤±è´¥ï¼š"+ie)}finally{ae(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:U?"LOADING...":((F==null?void 0:F.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[F&&(F.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(os,{value:K,onChange:a=>ce(a),options:[...F.roles||[]].sort((a,y)=>(a.order??0)-(y.order??0)).map(a=>({value:a.id,label:a.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Ue,value:Q,onChange:a=>{he.current=!0,re(a.target.value)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:g,disabled:se||U||!F||!Q.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg dark:hover:from-purple-500/60 dark:hover:to-pink-500/60 border-transparent dark:border-white/10",children:se?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!L&&($?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",j,"æ¬¡"]}):I!==null&&I>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[I,"ç§¯åˆ†"]}):null)]})}),z.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",z.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:z.map((a,y)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:a,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"})},y))})]}),S.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",S.length,")"]}),e.jsx("div",{className:"space-y-1",children:S.map((a,y)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:a.name,children:a.name})]},y))})]})]}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ho=t.memo(fo),Nr="https://api.waule.com",As=400,mo=({data:s,id:N,selected:n})=>{const[F,we]=t.useState(!1),[U,fe]=t.useState(0),[Q,re]=t.useState(s.config.uploadedFiles||[]),[K,ce]=t.useState(null),[Ue,he]=t.useState(null);t.useEffect(()=>()=>{},[N]),t.useEffect(()=>{},[K]),t.useEffect(()=>{},[Ue]);const[se,ae]=t.useState(null),Ie=t.useRef(null),ne=t.useRef(null),ge=t.useRef(null),[de,me]=t.useState(!1),[Ee,Z]=t.useState(0),[z,A]=t.useState(0),[S,G]=t.useState(!1),x=t.useRef(null),{setNodes:c,getNode:I,setEdges:L,getEdges:$}=Zt(),j=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const i=s.createdBy;if(typeof i=="object"&&(i==null||i.id),j.current)return;const B=s.config.uploadedFiles||[];!F&&JSON.stringify(B)!==JSON.stringify(Q)&&(re(B),ce(null),he(null))},[s.config.uploadedFiles,F,s._currentUserId,s.createdBy]);const O=()=>{x.current&&(x.current.paused?(x.current.play(),G(!0)):(x.current.pause(),G(!1)))},r=i=>{I(N)&&(j.current=!0,c(M=>M.map(X=>X.id===N?{...X,data:{...X.data,config:{...X.data.config,uploadedFiles:i}}}:X)))},v=async i=>{var M,X;if(!i||i.length===0)return;we(!0);const B=[];try{for(let V=0;V<i.length;V++){const ie=i[V];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ie.type)){h.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ie.name}`);continue}const oe=await Ce.assets.upload(ie,void 0,{onUploadProgress:k=>{const u=(k==null?void 0:k.total)||0,E=(k==null?void 0:k.loaded)||0;if(u>0){const b=Math.round(E/u*100);fe(b)}}});if(oe.data){const k=(oe.data.type||"").toUpperCase(),u=(oe.data.mimeType||"").toLowerCase(),E=k==="IMAGE"||k==="VIDEO"||k==="AUDIO"?k:u.startsWith("image/")?"IMAGE":u.startsWith("video/")?"VIDEO":u.startsWith("audio/")?"AUDIO":k||"",b=oe.data.url;B.push({id:oe.data.id,name:oe.data.name,originalName:oe.data.originalName,type:E,mimeType:oe.data.mimeType,size:oe.data.size,url:b})}}if(B.length>0){let V=[];const ie=B[0].type;if(se!==null)V=[...Q],V[se]=B[0];else{const oe={};for(const k of Q)oe[k.id]=k;for(const k of B)oe[k.id]=k;V=Object.values(oe)}if(I(N)){const oe=$().filter(u=>u.source===N),k=[];if(oe.forEach(u=>{var Y;const E=I(u.target);if(!E||E.type.startsWith("aiVideo"))return;const b=(Y=E.data.config)==null?void 0:Y.acceptedInputs;if(b&&b.length>0){const ue=ie.toUpperCase();b.map(pe=>typeof pe=="string"?pe.toUpperCase():pe).includes(ue)||k.push(u.id)}}),k.length>0){L(E=>E.filter(b=>!k.includes(b.id)));const u={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.warning(`å·²æ–­å¼€ ${k.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${u[ie]||ie}ç±»å‹ï¼‰`)}}ce(null),he(null),re(V),r(V);try{const oe=$().filter(u=>u.source===N);if(oe.some(u=>{const E=I(u.target);return(E==null?void 0:E.type)==="aiVideo"})){const u=localStorage.getItem("workflow:nodes"),E=u?JSON.parse(u):[],b=oe.filter(ue=>{var H;return((H=I(ue.target))==null?void 0:H.type)==="aiVideo"}).map(ue=>ue.target),Y=E.filter(ue=>b.includes(ue.id));Y.length>0&&c(ue=>ue.map(H=>Y.find(pe=>pe.id===H.id)?{...H,data:{...H.data,config:{...H.data.config,_updatedAt:Date.now()}}}:H))}}catch{}h.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(V){h.error(`ä¸Šä¼ å¤±è´¥: ${((X=(M=V.response)==null?void 0:M.data)==null?void 0:X.message)||V.message}`)}finally{we(!1),fe(0),Ie.current&&(Ie.current.value=""),ae(null)}},g=()=>{c(i=>i.filter(B=>B.id!==N)),L(i=>i.filter(B=>B.source!==N&&B.target!==N)),h.success("èŠ‚ç‚¹å·²åˆ é™¤")},a=()=>{var i;ae(0),(i=Ie.current)==null||i.click()},y=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(2)+" KB":(i/(1024*1024)).toFixed(2)+" MB",d=i=>i.startsWith("image/")?{icon:"image",color:"text-tiffany-400"}:i.startsWith("video/")?{icon:"movie",color:"text-green-400"}:i.startsWith("audio/")?{icon:"audio_file",color:"text-blue-400"}:{icon:"description",color:"text-tiffany-400"};t.useEffect(()=>{if(Q.length>0){const i=Q[0],B=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Nr}${i.url}`).replace(".oss-oss-",".oss-");if(i.type==="IMAGE"){const M=new Image;M.onload=()=>{const X=M.width/M.height,V=As/X;ce({width:As,height:V})},M.onerror=X=>{ce({width:As,height:As*.75})},M.src=B}else if(i.type==="VIDEO"){const M=document.createElement("video");M.onloadedmetadata=()=>{const X=M.videoWidth/M.videoHeight,V=As/X;he({width:As,height:V})},M.onerror=X=>{he({width:As,height:As*.5625})},M.src=B}}},[Q]);const m=()=>{const i=ne.current;i&&(de?(i.pause(),me(!1)):(i.play(),me(!0)))};t.useEffect(()=>{const i=ne.current;if(!i)return;const B=()=>Z(i.duration||0),M=()=>A(i.duration?i.currentTime/i.duration:0),X=()=>me(!1);return i.addEventListener("loadedmetadata",B),i.addEventListener("timeupdate",M),i.addEventListener("ended",X),()=>{i.removeEventListener("loadedmetadata",B),i.removeEventListener("timeupdate",M),i.removeEventListener("ended",X)}},[Q]);const f=t.useRef(null),[w,R]=t.useState(0);t.useEffect(()=>{const i=Q[0];if(!i||i.type!=="AUDIO"){f.current=null;return}const M=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Nr}${i.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let V;/https:\/\/.*aliyuncs\.com\//.test(M)?V=await Ce.assets.proxyDownload(M):V=await(await fetch(M,{mode:"cors"})).arrayBuffer();const ie=window.AudioContext||window.webkitAudioContext,k=(await new ie().decodeAudioData(V)).getChannelData(0),u=120,E=Math.max(1,Math.floor(k.length/u)),b=new Float32Array(u);for(let Y=0;Y<u;Y++){let ue=0,H=0;const pe=Y*E,Se=Math.min(k.length,pe+E);for(let Ne=pe;Ne<Se;Ne++)ue+=Math.abs(k[Ne]),H++;b[Y]=H?ue/H:0}f.current=b,R(Y=>Y+1)}catch{const ie=new Float32Array(120);for(let xe=0;xe<120;xe++)ie[xe]=(Math.sin(xe/5)+1)/2;f.current=ie,R(xe=>xe+1)}})()},[Q]),t.useEffect(()=>{const i=ge.current;if(!i)return;const B=f.current;if(!B)return;const M=i.getContext("2d");if(!M)return;const X=i.width,V=i.height;M.clearRect(0,0,X,V);const ie=B.length,xe=2,oe=Math.max(1,Math.floor((X-(ie-1)*xe)/ie)),k=M.createLinearGradient(0,0,X,0);k.addColorStop(0,"#a855f7"),k.addColorStop(.5,"#d946ef"),k.addColorStop(1,"#ec4899");for(let u=0;u<ie;u++){const E=Math.min(1,Math.max(0,B[u])),b=Math.max(2,Math.floor(E*V)),Y=u*(oe+xe),ue=Math.floor((V-b)/2);M.fillStyle=k,M.fillRect(Y,ue,oe,b)}if(z>0){const u=Math.floor(X*z);M.fillStyle="#ffffff88",M.fillRect(u,0,2,V)}},[z,w]);const W=i=>{if(!i||!isFinite(i))return"0:00";const B=Math.floor(i/60),M=Math.floor(i%60);return`${B}:${M.toString().padStart(2,"0")}`},_=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"tiffany"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"green"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"blue"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"tiffany"}],p=Q[0],l=p?(p.url.startsWith("http")||p.url.startsWith("data:")?p.url:`${Nr}${p.url}`).replace(".oss-oss-",".oss-"):"";return p&&p.type==="IMAGE"&&K?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:As},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:l,alt:"",className:"w-full object-cover",draggable:!1,style:{width:As,height:K.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Ie,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):p&&p.type==="VIDEO"&&Ue?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:As},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${S?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:i=>{i.stopPropagation(),O()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:S?"pause":"play_arrow"})})}),e.jsx("video",{ref:x,src:l,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:As,height:Ue.height},onEnded:()=>G(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Ie,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):p&&p.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:m,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:de?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:W(Ee)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:ge,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ne,src:l,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Ie,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):p&&p.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:p.originalName,children:p.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:y(p.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:Ie,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:Ie,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var i;s._canEdit!==!1&&((i=Ie.current)==null||i.click())},onDragOver:i=>{i.preventDefault(),i.stopPropagation()},onDrop:i=>{i.preventDefault(),i.stopPropagation(),s._canEdit!==!1&&v(i.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-purple-400 dark:hover:border-purple-400/50 transition-colors ${F||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:F?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:F?`ä¸Šä¼ ä¸­... ${U}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),F&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all",style:{width:`${U}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:_.map(i=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${i.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:i.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:i.formats.join(", ")})]},i.type))})]}),Q.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",Q.length,")"]}),Q.map(i=>{const{icon:B,color:M}=d(i.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${M} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:B}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:i.originalName,children:i.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:y(i.size)})]}),e.jsx("button",{onClick:g,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},i.id)})]})]})}),e.jsx(St,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},xo=t.memo(mo),Gr="https://api.waule.com",$s=320,bo=({data:s,id:N,selected:n})=>{const[F,we]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[U,fe]=t.useState([]),{setNodes:Q,getNode:re}=Zt(),[K,ce]=t.useState(null),[Ue,he]=t.useState(null),se=t.useRef(null),ae=t.useRef(null),[Ie,ne]=t.useState(!1),[ge,de]=t.useState(0),[me,Ee]=t.useState(0),Z=t.useRef(null),[z,A]=t.useState(!1),[S,G]=t.useState(!1),x=t.useRef(null),c=()=>{x.current&&(x.current.paused?(x.current.play(),G(!0)):(x.current.pause(),G(!1)))},I=t.useRef(!1);t.useEffect(()=>{const g=s._currentUserId,a=s.createdBy,y=typeof a=="object"?a==null?void 0:a.id:a;if(g&&y&&g===y&&I.current)return;const d=s.config.selectedInput||s.config.selectedAsset||null;if(!d)return;const m=F;(()=>{if(!m)return!1;const w=m.images&&!m.type,R=d.images&&!d.type;if(w&&R){const W=m.images||[],_=d.images||[];if(W.length!==_.length)return!1;for(let p=0;p<W.length;p++)if(W[p].id!==_[p].id||W[p].url!==_[p].url)return!1;return!0}if(m.id&&d.id)return m.id===d.id&&m.url===d.url&&m.type===d.type;try{return JSON.stringify(m)===JSON.stringify(d)}catch{return!1}})()||we(d)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var a,y,d;if(F&&F.images&&!F.type){const m=F,f=(d=(y=(a=re(N))==null?void 0:a.data)==null?void 0:y.config)==null?void 0:d.referenceImages;Array.isArray(f)&&f.length>0?fe(f.map(w=>({id:w.id,url:w.url,name:w.name}))):fe(m.images||[])}else fe([])},[F,re,N]);const L=g=>{const a=re(N);a&&(I.current=!0,Q(y=>y.map(d=>d.id===N?{...d,data:{...d.data,config:{...d.data.config,...g}}}:d)),we((g==null?void 0:g.selectedInput)??(g==null?void 0:g.selectedAsset)??a.data.config.selectedInput??a.data.config.selectedAsset))},$=g=>/^https?:\/\//.test(g)||g.startsWith("data:"),j=g=>!g||g.startsWith("data:")?g:/^https?:\/\/localhost(?::\d+)?\//i.test(g)?g.replace(/^https?:\/\/localhost(?::\d+)?/i,Gr):$(g)?g:`${Gr}${g}`;t.useEffect(()=>{var _,p,l,i,B,M,X,V,ie;if(!(F&&F.images&&!F.type))return;const a=F,y=U.length?U:a.images||[];if(y.length===1){const xe=y[0],oe={id:xe.id,name:xe.name,originalName:xe.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:xe.url};L({selectedInput:oe,selectedAsset:oe,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const d=[{name:a.name,images:y.map(xe=>j(xe.url))}],m=y.map(xe=>({id:xe.id,url:xe.url,name:xe.name})),f=[a.id],w=(l=(p=(_=re(N))==null?void 0:_.data)==null?void 0:p.config)==null?void 0:l.subjects,R=(M=(B=(i=re(N))==null?void 0:i.data)==null?void 0:B.config)==null?void 0:M.referenceImages,W=(ie=(V=(X=re(N))==null?void 0:X.data)==null?void 0:V.config)==null?void 0:ie.roleIds;(JSON.stringify(w)!==JSON.stringify(d)||JSON.stringify(R)!==JSON.stringify(m)||JSON.stringify(W)!==JSON.stringify(f))&&L({subjects:d,referenceImages:m,roleIds:f})},[U]);const O=g=>{if(!(F&&F.images&&!F.type))return;const y=F,d=[...U];if(g<0||g>=d.length)return;if(d.splice(g,1),fe(d),h.success("å·²åˆ é™¤å‚è€ƒå›¾"),d.length===0){we(null),L({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),h.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(d.length===1){const W=d[0],_={id:W.id,name:W.name,originalName:W.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:W.url};we(_),L({selectedInput:_,selectedAsset:_,subjects:void 0,referenceImages:void 0,roleIds:void 0}),h.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const m={id:y.id,name:y.name,coverUrl:j(d[0].url),images:d};we(m);const f=[{name:m.name,images:d.map(W=>j(W.url))}],w=d.map(W=>({id:W.id,url:W.url,name:W.name})),R=[m.id];L({selectedInput:m,subjects:f,referenceImages:w,roleIds:R}),h.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(N)};t.useEffect(()=>{if(F&&F.type){const g=F;if(g.type==="IMAGE"){const a=new Image;a.onload=()=>{const y=a.width/a.height,d=$s/y;ce({width:$s,height:d})},a.src=j(g.url)}else if(g.type==="VIDEO"){const a=document.createElement("video");a.onloadedmetadata=()=>{const y=a.videoWidth/a.videoHeight,d=$s/y;he({width:$s,height:d})},a.src=j(g.url)}}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")){A(!1);return}const y=j(F.url),d=se.current,m=ae.current;if(!d||!m)return;d.src=y,Ee(0),A(!1);const f=()=>de(d.duration||0),w=()=>Ee(d.duration?d.currentTime/d.duration:0),R=()=>ne(!1);return d.addEventListener("loadedmetadata",f),d.addEventListener("timeupdate",w),d.addEventListener("ended",R),(async()=>{try{const p=await(await fetch(y,{mode:"cors"})).arrayBuffer(),l=window.AudioContext||window.webkitAudioContext,M=(await new l().decodeAudioData(p)).getChannelData(0),X=120,V=Math.max(1,Math.floor(M.length/X)),ie=new Float32Array(X);for(let xe=0;xe<X;xe++){let oe=0,k=0;const u=xe*V,E=Math.min(M.length,u+V);for(let b=u;b<E;b++)oe+=Math.abs(M[b]),k++;ie[xe]=k?oe/k:0}Z.current=ie,A(!0)}catch{const p=new Float32Array(120);for(let l=0;l<120;l++)p[l]=(Math.sin(l/5)+1)/2;Z.current=p,A(!0)}})(),()=>{d.removeEventListener("loadedmetadata",f),d.removeEventListener("timeupdate",w),d.removeEventListener("ended",R)}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")||!z)return;const a=ae.current,y=Z.current;if(!a||!y)return;const d=a.getContext("2d");if(!d)return;const m=a.width,f=a.height;d.clearRect(0,0,m,f);const w=y.length,R=2,W=Math.max(1,Math.floor((m-(w-1)*R)/w)),_=d.createLinearGradient(0,0,m,0);_.addColorStop(0,"#a855f7"),_.addColorStop(.5,"#d946ef"),_.addColorStop(1,"#ec4899");for(let p=0;p<w;p++){const l=Math.min(1,Math.max(0,y[p])),i=Math.max(2,Math.floor(l*f)),B=p*(W+R),M=Math.floor((f-i)/2);d.fillStyle=_,d.fillRect(B,M,W,i)}if(me>0){const p=Math.floor(m*me);d.fillStyle="#ffffff88",d.fillRect(p,0,2,f)}},[F,me,z]);const v=g=>g<1024?g+" B":g<1024*1024?(g/1024).toFixed(2)+" KB":(g/(1024*1024)).toFixed(2)+" MB";if(F){if(F.images&&!F.type){const d=F;return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:$s*.5625},children:U[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:m=>m.preventDefault(),src:j(U[0].url),alt:d.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:m=>{m.preventDefault(),m.stopPropagation(),m.nativeEvent&&typeof m.nativeEvent.stopImmediatePropagation=="function"&&m.nativeEvent.stopImmediatePropagation(),O(0)},onClick:m=>{m.preventDefault(),m.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:d.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:U.slice(1).map((m,f)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:w=>w.preventDefault(),src:j(m.url),alt:m.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:w=>{w.preventDefault(),w.stopPropagation(),w.nativeEvent&&typeof w.nativeEvent.stopImmediatePropagation=="function"&&w.nativeEvent.stopImmediatePropagation(),O(f+1)},onClick:w=>{w.preventDefault(),w.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},m.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const a=F,y=j(a.url);if(a.type==="IMAGE"&&K)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:y,alt:a.name,className:"w-full object-cover",style:{width:$s,height:K.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="VIDEO"&&Ue)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${S?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:d=>{d.stopPropagation(),c()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:S?"pause":"play_arrow"})})}),e.jsx("video",{ref:x,src:y,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:$s,height:Ue.height},onEnded:()=>G(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const d=se.current;d&&(Ie?(d.pause(),ne(!1)):(d.play(),ne(!0)))},className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:Ie?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const d=ge;if(!d||!isFinite(d))return"0:00";const m=Math.floor(d/60),f=Math.floor(d%60);return`${m}:${f.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:ae,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:se,src:y,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(a.type==="DOCUMENT"){const d=w=>w.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:w.includes("word")?{icon:"description",color:"text-blue-400"}:w.includes("excel")||w.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:m,color:f}=d(a.mimeType);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${f} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:m}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:a.originalName,children:a.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:v(a.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},wo=t.memo(bo),fr={};function _s(s){const{project:N,episode:n,nodeGroup:F,assetType:we,preview:U=!0}=s;if(!F||!F.scene||!F.shot)return null;const fe=`${F.id}-${we}`;fr[fe]||(fr[fe]=0);let Q;U?Q=fr[fe]+1:(fr[fe]++,Q=fr[fe]);let re=N.name;if(N.type==="DRAMA"&&n){const K=`S${String(n.episodeNumber).padStart(3,"0")}`;re+=`_${K}`}return re+=`_Sc${F.scene}_Sh${F.shot}`,re+=`_${Q}`,re}function Ws(s,N){return N.find(n=>n.nodeIds.includes(s))||null}const yo=({data:s,id:N})=>{var d,m;const{setNodes:n,setEdges:F,getNodes:we}=Zt(),U=Er(f=>f.refreshUser),fe=Sr(),Q=!!((d=s==null?void 0:s.workflowContext)!=null&&d.episode)||fe.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var w,R,W;if(Q)try{const _=(s==null?void 0:s.workflowContext)||{},p=_.episode,l=new URLSearchParams(window.location.search),i=Number(l.get("shot"))||1,B=fe.pathname.split("/").filter(Boolean),M=B.indexOf("projects"),X=B.indexOf("episodes"),V=((w=_.project)==null?void 0:w.id)||(p==null?void 0:p.projectId)||(M>=0?B[M+1]:void 0),ie=(p==null?void 0:p.id)||(X>=0?B[X+1]:void 0);if(!V||!ie)return;const xe=await Ce.episodes.getById(V,ie),oe=(xe==null?void 0:xe.data)??xe,k=(oe==null?void 0:oe.data)??oe,E=(Array.isArray((R=k==null?void 0:k.scriptJson)==null?void 0:R.acts)?k.scriptJson.acts:[]).find(H=>H.actIndex===1),b=(W=E==null?void 0:E.shots)==null?void 0:W.find(H=>Number(H.shotIndex)===i),ue=(Array.isArray(b==null?void 0:b.mediaList)?b.mediaList:[]).some(H=>(H==null?void 0:H.nodeId)===N);n(H=>H.map(pe=>pe.id===N?{...pe,data:{...pe.data,addedToStoryboard:ue}}:pe))}catch{}})()},[N,Q,fe.pathname]);const[re,K]=t.useState(!1),[ce,Ue]=t.useState([]),[he,se]=t.useState(""),[ae,Ie]=t.useState("ALL"),[ne,ge]=t.useState(""),[de,me]=t.useState(!1),Ee=s.width||400,[Z,z]=t.useState(null);t.useEffect(()=>{re&&(v(),setTimeout(()=>{g()},100))},[re]);const A=t.useRef(null),S=t.useRef(!1);t.useEffect(()=>{const f=s.pendingButtonAction;if(f){try{const W=localStorage.getItem("suppressedPreviewTasks")||"[]",_=JSON.parse(W),p=localStorage.getItem("createdPreviewTasks")||"[]",l=JSON.parse(p),i=_.some(V=>V.taskId&&V.taskId===f.newTaskId||V.sourceNodeId&&V.sourceNodeId===f.sourceNodeId),M=we().some(V=>{var ie,xe,oe,k;return V.type==="imagePreview"&&((xe=(ie=V.data)==null?void 0:ie.midjourneyData)==null?void 0:xe.sourceNodeId)===f.sourceNodeId&&((k=(oe=V.data)==null?void 0:oe.midjourneyData)==null?void 0:k.taskId)===f.newTaskId}),X=l.some(V=>V.taskId&&V.taskId===f.newTaskId);if(i||X&&M){z(null),n(V=>V.map(ie=>ie.id===f.sourceNodeId?{...ie,data:{...ie.data,pendingButtonAction:void 0}}:ie));return}}catch{}if(S.current)return;if(S.current=!0,we().some(W=>{var _,p,l,i;return W.type==="imagePreview"&&((p=(_=W.data)==null?void 0:_.midjourneyData)==null?void 0:p.sourceNodeId)===f.sourceNodeId&&((i=(l=W.data)==null?void 0:l.midjourneyData)==null?void 0:i.taskId)===f.newTaskId})){z(null),n(W=>W.map(_=>_.id===f.sourceNodeId?{..._,data:{..._.data,pendingButtonAction:void 0}}:_)),S.current=!1;return}z(f.buttonCustomId),G(f.newTaskId,f.buttonLabel,f.sourceNodeId)}return()=>{S.current=!1,A.current&&(clearTimeout(A.current),A.current=null)}},[]);const G=async(f,w,R)=>{const W=R||N;let _=0;const p=150,l=2e3;S.current=!0;const i=/^[UV]\d$/.test(w)||w.includes("Vary")||w.includes("Upscale")&&w!=="Upscale"||w.includes("Zoom")||w.includes("Pan")||w.includes("Make")||w.includes("Remaster"),B=async()=>{var M,X,V,ie,xe,oe,k,u;if(S.current)try{const E=await Ce.midjourney.fetchTask(f);if(!S.current)return;const b=E.task;if(b.status==="SUCCESS"){if(i&&s.imageUrl&&((M=s.midjourneyData)!=null&&M.messageId)){const gt=b.imageUrl===s.imageUrl,vt=((X=b.properties)==null?void 0:X.messageId)===((V=s.midjourneyData)==null?void 0:V.messageId);if(gt&&vt){_++;try{const lt=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(lt).some(Be=>{var wt;return Be.taskId&&Be.taskId===f||Be.messageId&&Be.messageId===((wt=b.properties)==null?void 0:wt.messageId)})){z(null),n(Be=>Be.map(wt=>wt.id===W?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}_<p?A.current=setTimeout(B,l):(h.error(`${w} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),z(null),n(lt=>lt.map(Ye=>Ye.id===W?{...Ye,data:{...Ye.data,pendingButtonAction:void 0}}:Ye)));return}}if(h.success(`${w} å®Œæˆï¼`),z(null),n(gt=>gt.map(vt=>vt.id===W?{...vt,data:{...vt.data,pendingButtonAction:void 0}}:vt)),we().find(gt=>{var vt,lt,Ye,yt,Be;return gt.type==="imagePreview"&&((vt=gt.data.midjourneyData)==null?void 0:vt.sourceNodeId)===W&&(((lt=gt.data.midjourneyData)==null?void 0:lt.taskId)===f||((Ye=b.properties)==null?void 0:Ye.messageId)&&((yt=gt.data.midjourneyData)==null?void 0:yt.messageId)===((Be=b.properties)==null?void 0:Be.messageId))})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const H=we().find(gt=>gt.id===W);if(!H)return;if(!b.imageUrl){h.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const pe=200,Se=100,Ne=s.width||400,Ae=((gt,vt=300)=>{if(!gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(gt))return vt;const[lt,Ye]=gt.split(":").map(yt=>parseFloat(yt));return!lt||!Ye?vt:Math.round(Ne*(Ye/lt))})(s.ratio,300),_e=document.querySelector(`.react-flow__node[data-id="${H.id}"]`),$e=Math.round((_e==null?void 0:_e.getBoundingClientRect().width)||((ie=H.data)==null?void 0:ie.width)||400),le=we().filter(gt=>{var vt,lt;return gt.type==="imagePreview"&&((lt=(vt=gt.data)==null?void 0:vt.midjourneyData)==null?void 0:lt.sourceNodeId)===W}),Ge=H.position.x+$e+pe,Ze=H.position.y,Wt=Ge,Ct=Ze+le.length*(Ae+Se),_t=`preview-${Date.now()}`,dt={id:_t,type:"imagePreview",position:{x:Wt,y:Ct},data:{imageUrl:b.imageUrl,width:Ne,height:Ae,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(xe=H.data)==null?void 0:xe.createdBy,midjourneyData:{taskId:f,messageId:(oe=b.properties)==null?void 0:oe.messageId,messageHash:(k=b.properties)==null?void 0:k.messageHash,sourceNodeId:W,buttons:b.buttons,action:b.action}}};n(gt=>[...gt,dt]),F(gt=>{const vt={id:`${W}-${_t}`,source:W,target:_t,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...gt,vt]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const vt=we().find(lt=>lt.id===_t)})});try{const gt=localStorage.getItem("createdPreviewTasks")||"[]",lt=[...JSON.parse(gt),{taskId:f,messageId:(u=b.properties)==null?void 0:u.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(lt))}catch{}h.success(`å·²åˆ›å»º${w}é¢„è§ˆèŠ‚ç‚¹`);return}if(b.status==="FAILURE"){h.error(`${w} å¤±è´¥: ${b.failReason||"æœªçŸ¥é”™è¯¯"}`),z(null),n(Y=>Y.map(ue=>ue.id===W?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue));return}if(b.status==="NOT_FOUND"){if(we().some(H=>{var pe,Se,Ne,Re;return H.type==="imagePreview"&&((Se=(pe=H.data)==null?void 0:pe.midjourneyData)==null?void 0:Se.sourceNodeId)===W&&((Re=(Ne=H.data)==null?void 0:Ne.midjourneyData)==null?void 0:Re.taskId)===f})){z(null),n(H=>H.map(pe=>pe.id===W?{...pe,data:{...pe.data,pendingButtonAction:void 0}}:pe));return}h.error(`${w} ä»»åŠ¡ä¸å­˜åœ¨`),z(null),n(H=>H.map(pe=>pe.id===W?{...pe,data:{...pe.data,pendingButtonAction:void 0}}:pe));return}_++,_<p?A.current=setTimeout(B,l):(h.error(`${w} è¶…æ—¶`),z(null),n(Y=>Y.map(ue=>ue.id===N?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue)))}catch(E){h.error(`${w} å¤±è´¥: ${E.message}`),z(null),n(b=>b.map(Y=>Y.id===N?{...Y,data:{...Y.data,pendingButtonAction:void 0}}:Y))}};B()},x=()=>{try{const f=localStorage.getItem("midjourneyButtonConfig");if(f)return JSON.parse(f)}catch{}return{}},c=f=>{const w=x();if(Object.keys(w).length===0)return!0;const R=f.label.replace(/\s+/g,"_");return w.hasOwnProperty(R)?w[R]===!0:!0},I=f=>{if(!f)return"";let w=f.trim();return/^upscale_\d+\s/i.test(w)&&(w=w.replace(/^upscale_\d+\s+/i,"")),w},L=(((m=s.midjourneyData)==null?void 0:m.buttons)||[]).map(f=>String(f.label||"").toLowerCase()),$=L.some(f=>/^[uv][1-4]$/i.test(f)),j=L.some(f=>f.includes("redo")),O=!$&&!j&&L.some(f=>f.includes("upscale")),r=f=>{const w=String(f.label||""),R=w.toLowerCase(),W=String(f.customId||"").toLowerCase(),_=/ğŸ‘|â¤ï¸|â¤/.test(w);return R.includes("animate")||R.includes("web")||W.includes("web")||R.includes("browser")||R.includes("open in web")||R.includes("open web")||R.includes("like")||W.includes("like")||_?!1:$?/^U[1-4]$/i.test(w):O?R.includes("upscale"):!1};t.useEffect(()=>{re&&(v(),g())},[re]);const v=async()=>{try{const f=ae==="ALL"?void 0:{category:ae},R=(await Ce.assetLibraries.getAll(f)).data||[];if(Ue(R),R.length>0){const W=R.find(_=>_.id===he);se(W?W.id:R[0].id)}else se("")}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},g=()=>{const f=window.__workflowContext;if(!f||!f.project||!f.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const w=Ws(N,f.nodeGroups);if(!w&&f.nodeGroups.length>0){const W=f.nodeGroups[0],_=_s({project:f.project,episode:f.episode,nodeGroup:W,assetType:"image"});_?(ge(_),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${_}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const R=_s({project:f.project,episode:f.episode,nodeGroup:w,assetType:"image"});R?(ge(R),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${R}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},a=async()=>{var f,w;if(!he){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ne.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{me(!0),await Ce.assetLibraries.addFromUrl(he,s.imageUrl,ne.trim());const R=window.__workflowContext;if(R&&R.project&&R.nodeGroups){const W=Ws(N,R.nodeGroups)||R.nodeGroups[0];W&&_s({project:R.project,episode:R.episode,nodeGroup:W,nodeId:N,assetType:"image",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),K(!1),ge("");try{n(W=>W.map(_=>_.id===N?{..._,data:{..._.data,addedToLibrary:!0}}:_))}catch{}try{const W=new CustomEvent("asset-library-updated",{detail:{libraryId:he}});window.dispatchEvent(W)}catch{}}catch(R){h.error(((w=(f=R.response)==null?void 0:f.data)==null?void 0:w.message)||"æ·»åŠ å¤±è´¥")}finally{me(!1)}},y=async()=>{var f;try{const w=s.imageUrl;let R=`image-${Date.now()}.jpg`;const W=window.__workflowContext;if(W&&W.project&&W.nodeGroups){const M=Ws(N,W.nodeGroups)||W.nodeGroups[0];if(M){const X=_s({project:W.project,episode:W.episode,nodeGroup:M,nodeId:N,assetType:"image",preview:!0});if(X&&(R=X,!R.includes("."))){const V=((f=w.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:f[0])||".jpg";R+=V}}}h.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const _=`/assets/proxy-download-with-name?url=${encodeURIComponent(w)}&filename=${encodeURIComponent(R)}`,p=await Ce.get(_,{responseType:"blob"}),l=p instanceof Blob?p:p==null?void 0:p.data;if(!l||!(l instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const i=window.URL.createObjectURL(l),B=document.createElement("a");B.href=i,B.download=R,document.body.appendChild(B),B.click(),document.body.removeChild(B),setTimeout(()=>{window.URL.revokeObjectURL(i)},100),h.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${R}`)}catch(w){h.error(`æ“ä½œå¤±è´¥: ${w instanceof Error?w.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const w=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(R=>c(R)&&r(R)):[]).length>0;return e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ee,borderRadius:w?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[Q&&e.jsxs("button",{onClick:async()=>{var R,W;try{const _=s.imageUrl,p=s.workflowContext||{},l=p.episode,i=new URLSearchParams(window.location.search),B=Number(i.get("shot"))||1,M=fe.pathname.split("/").filter(Boolean),X=M.indexOf("projects"),V=M.indexOf("episodes"),ie=((R=p.project)==null?void 0:R.id)||(l==null?void 0:l.projectId)||(X>=0?M[X+1]:void 0),xe=(l==null?void 0:l.id)||(V>=0?M[V+1]:void 0);if(!ie||!xe){h.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const oe=await Ce.episodes.getById(ie,xe),k=(oe==null?void 0:oe.data)??oe,u=(k==null?void 0:k.data)??k;let E=Array.isArray((W=u==null?void 0:u.scriptJson)==null?void 0:W.acts)?[...u.scriptJson.acts]:[],b=E.find(pe=>pe.actIndex===1);b||(b={actIndex:1,shots:[]},E.push(b)),b.shots=Array.isArray(b.shots)?[...b.shots]:[];let Y=b.shots.find(pe=>Number(pe.shotIndex)===B);Y||(Y={shotIndex:B,mediaList:[]},b.shots.push(Y));const ue=Array.isArray(Y.mediaList)?Y.mediaList.slice():[];ue.push({type:"image",url:_,nodeId:N,duration:5}),Y.mediaList=ue;const H={...u.scriptJson||{},acts:E};await Ce.episodes.update(ie,xe,{scriptJson:H});try{n(pe=>pe.map(Se=>Se.id===N?{...Se,data:{...Se.data,addedToStoryboard:!0}}:Se))}catch{}h.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(_){h.error((_==null?void 0:_.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{K(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:y,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const f=(s.midjourneyData.buttons||[]).filter(w=>c(w)&&r(w));return f.length===0?null:e.jsxs("div",{className:"nodrag bg-white/80 dark:bg-black/60 backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ee},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:f.map((w,R)=>{var B;const W=I(w.label),_=((B=s.clickedButtons)==null?void 0:B.includes(w.label))||!1,p=Z===w.customId,l=s._canEdit===!1,i=Z!==null&&Z!==w.customId||_||l;return e.jsx("button",{onClick:async()=>{var M,X,V,ie,xe,oe;if(!((M=s.midjourneyData)!=null&&M.taskId)){h.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(_){h.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}z(w.customId);try{h.info(`æ­£åœ¨æ‰§è¡Œ ${w.label}...`);const k=await Ce.midjourney.action({taskId:s.midjourneyData.taskId,customId:w.customId,messageId:s.midjourneyData.messageId,nodeId:N,mode:s.midjourneyData.mode||"relax"});if(!k.success){h.error(k.description||"æ“ä½œå¤±è´¥"),z(null);return}const u=k.taskId;if(k.creditsCharged&&k.creditsCharged>0&&U(),!u){h.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),z(null);return}n(E=>E.map(b=>b.id===N?{...b,data:{...b.data,pendingButtonAction:{buttonLabel:w.label,buttonCustomId:w.customId,newTaskId:u,sourceNodeId:N},clickedButtons:[...b.data.clickedButtons||[],w.label]}}:b)),h.info(`${W} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),G(u,W)}catch(k){if(((X=k.response)==null?void 0:X.status)===429)h.warning(((ie=(V=k.response)==null?void 0:V.data)==null?void 0:ie.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const u=((oe=(xe=k.response)==null?void 0:xe.data)==null?void 0:oe.error)||k.message;h.error(u)}z(null)}},disabled:i,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${_?"bg-slate-400 dark:bg-slate-600 cursor-not-allowed opacity-50 text-white border-transparent":p?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 cursor-wait text-white border-transparent shadow-md":Z!==null?"bg-slate-300 dark:bg-slate-700 cursor-not-allowed opacity-50 text-white border-transparent":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:_?`${W} (å·²ç‚¹å‡»)`:W,children:e.jsxs("span",{className:"flex items-center gap-1",children:[p&&e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),w.emoji&&!/^upscale_\d+$/i.test(w.emoji)&&e.jsx("span",{children:w.emoji}),W,_&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},R)})})]})})(),re&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:f=>f.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>K(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ne,onChange:f=>ge(f.target.value),onMouseDown:f=>f.stopPropagation(),onTouchStart:f=>f.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const f=ae==="ALL"?ce:ce.filter(w=>(w.category||"OTHER")===ae);return f.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:ae==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:he,onChange:w=>se(w.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:f.map(w=>e.jsxs("option",{value:w.id,children:[w.name," (",w._count.assets," ä¸ªèµ„äº§)"]},w.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(f=>e.jsx("button",{type:"button",onClick:()=>{Ie(f);const w=ce.filter(R=>(R.category||"OTHER")===f);se(w.length>0?w[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${ae===f?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:f==="ROLE"?"person":f==="SCENE"?"landscape":f==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:f==="ROLE"?"è§’è‰²åº“":f==="SCENE"?"åœºæ™¯åº“":f==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},f))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>K(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:a,disabled:de||ce.length===0||!ne.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:de?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ko=t.memo(yo),vo=({data:s,id:N})=>{var L;const n="https://api.waule.com",[F,we]=t.useState(!1),[U,fe]=t.useState([]),[Q,re]=t.useState(""),[K,ce]=t.useState("ALL"),[Ue,he]=t.useState(""),[se,ae]=t.useState(!1),{setNodes:Ie}=Zt(),[ne]=t.useState(s.width||400),[ge,de]=t.useState(null),[me,Ee]=t.useState(!1),Z=t.useRef(null),z=Sr(),A=!!((L=s==null?void 0:s.workflowContext)!=null&&L.episode)||z.pathname.includes("/episodes/");t.useEffect(()=>{F&&(G(),setTimeout(()=>{x()},100))},[F]),t.useEffect(()=>{const $=Z.current;if(!$)return;const j=()=>{const g=$.videoWidth||0,a=$.videoHeight||0;if(g>0&&a>0){const y=g/a;de(Math.round(ne/y))}},O=()=>Ee(!0),r=()=>Ee(!1),v=()=>Ee(!1);return $.addEventListener("loadedmetadata",j),$.addEventListener("play",O),$.addEventListener("pause",r),$.addEventListener("ended",v),()=>{$.removeEventListener("loadedmetadata",j),$.removeEventListener("play",O),$.removeEventListener("pause",r),$.removeEventListener("ended",v)}},[ne,s.videoUrl]);const S=$=>{$.stopPropagation();const j=Z.current;j&&(j.paused?j.play():j.pause())};t.useEffect(()=>{try{const $=localStorage.getItem("suppressedPreviewTasks")||"[]",j=JSON.parse($),O=s==null?void 0:s.pendingButtonAction;if(O&&j.some(v=>v.taskId&&v.taskId===O.newTaskId||v.sourceNodeId&&v.sourceNodeId===O.sourceNodeId)){we(!1);return}}catch{}},[]);const G=async()=>{try{const $=await Ce.assetLibraries.getAll();fe($.data),$.data.length>0&&re($.data[0].id)}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},x=()=>{const $=window.__workflowContext;if(!$||!$.project||!$.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const j=Ws(N,$.nodeGroups);if(!j&&$.nodeGroups.length>0){const r=$.nodeGroups[0],v=_s({project:$.project,episode:$.episode,nodeGroup:r,assetType:"video"});v?(he(v),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${v}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const O=_s({project:$.project,episode:$.episode,nodeGroup:j,assetType:"video"});O?(he(O),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${O}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},c=async()=>{var $,j;if(!Q){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Ue.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ae(!0),await Ce.assetLibraries.addFromUrl(Q,s.videoUrl,Ue.trim());const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const r=Ws(N,O.nodeGroups)||O.nodeGroups[0];r&&_s({project:O.project,episode:O.episode,nodeGroup:r,nodeId:N,assetType:"video",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),we(!1),he("");try{Ie(r=>r.map(v=>v.id===N?{...v,data:{...v.data,addedToLibrary:!0}}:v))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:Q}});window.dispatchEvent(r)}catch{}}catch(O){h.error(((j=($=O.response)==null?void 0:$.data)==null?void 0:j.message)||"æ·»åŠ å¤±è´¥")}finally{ae(!1)}},I=async()=>{var $;try{const j=s.videoUrl;let O=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const m=Ws(N,r.nodeGroups)||r.nodeGroups[0];if(m){const f=_s({project:r.project,episode:r.episode,nodeGroup:m,nodeId:N,assetType:"video",preview:!0});if(f&&(O=f,!O.includes("."))){const w=(($=j.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:$[0])||".mp4";O+=w}}}h.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");const v=`/assets/proxy-download-with-name?url=${encodeURIComponent(j)}&filename=${encodeURIComponent(O)}`,g=await Ce.get(v,{responseType:"blob"}),a=g instanceof Blob?g:g==null?void 0:g.data;if(!a||!(a instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const y=window.URL.createObjectURL(a),d=document.createElement("a");d.href=y,d.download=O,document.body.appendChild(d),d.click(),document.body.removeChild(d),setTimeout(()=>{window.URL.revokeObjectURL(y)},100),h.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${O}`)}catch(j){h.error(`æ“ä½œå¤±è´¥: ${j instanceof Error?j.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ne},children:[e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${me?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:S,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:me?"pause":"play_arrow"})})}),e.jsx("video",{ref:Z,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${n}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:ge?`${ge}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[A&&e.jsxs("button",{onClick:async()=>{var $,j;try{const O=s.videoUrl,r=s.workflowContext||{},v=r.episode,g=(()=>{try{const X=new URLSearchParams(window.location.search);return{scene:Number(X.get("scene")),shot:Number(X.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),a=r.nodeGroup||Ws(N,r.nodeGroups||[]),y=(a==null?void 0:a.scene)??g.scene,d=(a==null?void 0:a.shot)??g.shot,m=(()=>{try{const X=z.pathname.split("/").filter(Boolean),V=X.indexOf("projects"),ie=X.indexOf("episodes"),xe=V>=0?X[V+1]:void 0,oe=ie>=0?X[ie+1]:void 0;return{pid:xe,eid:oe}}catch{return{pid:void 0,eid:void 0}}})(),f=(($=r.project)==null?void 0:$.id)||(v==null?void 0:v.projectId)||m.pid,w=(v==null?void 0:v.id)||m.eid;if(!f||!w||!y||!d){h.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const R=await Ce.episodes.getById(f,w),W=(R==null?void 0:R.data)??R,_=(W==null?void 0:W.data)??W,p=Array.isArray((j=_==null?void 0:_.scriptJson)==null?void 0:j.acts)?[..._.scriptJson.acts]:[];let l=p.find(X=>Number(X.actIndex)===Number(y));l||(l={actIndex:Number(y),shots:[]},p.push(l)),l.shots=Array.isArray(l.shots)?[...l.shots]:[];let i=l.shots.find(X=>Number(X.shotIndex)===Number(d));i||(i={shotIndex:Number(d),mediaList:[]},l.shots.push(i));const B=Array.isArray(i.mediaList)?i.mediaList.slice():[];if(B.length>=4){h.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}B.push({type:"video",url:O,nodeId:N}),i.mediaList=B;const M={..._.scriptJson||{},acts:p};await Ce.episodes.update(f,w,{scriptJson:M});try{Ie(X=>X.map(V=>V.id===N?{...V,data:{...V.data,addedToStoryboard:!0}}:V))}catch{}h.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(O){h.error((O==null?void 0:O.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{we(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:I,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),F&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>we(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Ue,onChange:$=>he($.target.value),onMouseDown:$=>$.stopPropagation(),onTouchStart:$=>$.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const $=K==="ALL"?U:U.filter(j=>(j.category||"OTHER")===K);return $.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:K==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Q,onChange:j=>re(j.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:$.map(j=>e.jsxs("option",{value:j.id,children:[j.name," (",j._count.assets," ä¸ªèµ„äº§)"]},j.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map($=>e.jsx("button",{type:"button",onClick:()=>{ce($);const j=U.filter(O=>(O.category||"OTHER")===$);re(j.length>0?j[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${K===$?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:$==="ROLE"?"person":$==="SCENE"?"landscape":$==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:$==="ROLE"?"è§’è‰²åº“":$==="SCENE"?"åœºæ™¯åº“":$==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},$))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>we(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:c,disabled:se||U.length===0||!Ue.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:se?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`})]})},No=t.memo(vo),jo=({data:s,id:N,selected:n})=>{const{getNodes:F,getEdges:we,setEdges:U,setNodes:fe,getNode:Q}=Zt(),[re,K]=t.useState(s.content||""),ce=t.useRef(null),Ue=t.useRef(null),he=t.useRef(null),se=t.useRef(null);t.useEffect(()=>{const S=I=>{I.stopPropagation()},G=Ue.current,x=he.current;G&&G.addEventListener("wheel",S,{passive:!0}),x&&x.addEventListener("wheel",S,{passive:!0});const c=se.current;return c&&c.addEventListener("wheel",S,{passive:!0}),()=>{G&&G.removeEventListener("wheel",S),x&&x.removeEventListener("wheel",S),c&&c.removeEventListener("wheel",S)}},[]);const ae=t.useRef(null),Ie=async S=>{var G,x;try{const c=(s==null?void 0:s.workflowContext)||{},I=c.episode,L=c.nodeGroup||Array.isArray(c.nodeGroups)&&c.nodeGroups.find(w=>(w.nodeIds||[]).includes(N))||null;let $=L==null?void 0:L.scene,j=L==null?void 0:L.shot;try{const w=new URLSearchParams(window.location.search),R=Number(w.get("scene")),W=Number(w.get("shot"));Number.isFinite(R)&&R>0&&($=$??R),Number.isFinite(W)&&W>0&&(j=j??W)}catch{}const O=((G=c.project)==null?void 0:G.id)||(I==null?void 0:I.projectId),r=I==null?void 0:I.id;if(!O||!r||!$||!j)return;const v=await Ce.episodes.getById(O,r),g=(v==null?void 0:v.data)??v,a=(g==null?void 0:g.data)??g,y=Array.isArray((x=a==null?void 0:a.scriptJson)==null?void 0:x.acts)?[...a.scriptJson.acts]:[];let d=y.find(w=>Number(w.actIndex)===Number($));d||(d={actIndex:Number($),shots:[]},y.push(d)),d.shots=Array.isArray(d.shots)?[...d.shots]:[];let m=d.shots.find(w=>Number(w.shotIndex)===Number(j));m||(m={shotIndex:Number(j)},d.shots.push(m)),Object.keys(S).forEach(w=>{m[w]=S[w]||""});const f={...a.scriptJson||{},acts:y};await Ce.episodes.update(O,r,{scriptJson:f})}catch(c){h.error((c==null?void 0:c.message)||"ä¿å­˜å¤±è´¥")}},ne=()=>{var S,G,x;try{const c=F(),I=we(),L=c.find(g=>g.id===N),$=I.filter(g=>g.source===N).map(g=>g.target),j=c.filter(g=>g.type==="agent");let O="";const r=j.find(g=>$.includes(g.id));if(r)O=r.id;else if(L&&j.length>0)O=((G=(S=j.map(a=>{var y,d,m,f;return{a,dx:(((y=a.position)==null?void 0:y.x)??0)-(((d=L.position)==null?void 0:d.x)??0),dy:Math.abs((((m=a.position)==null?void 0:m.y)??0)-(((f=L.position)==null?void 0:f.y)??0))}}).sort((a,y)=>(a.dx>=0&&y.dx>=0,a.dx-y.dx||a.dy-y.dy))[0])==null?void 0:S.a)==null?void 0:G.id)||j[0].id;else{const g=c.findIndex(a=>a.id===N);O=((x=c[g+1])==null?void 0:x.id)||""}if(!O)return;U(g=>g.some(y=>y.source===N&&y.target===O)?g:[...g,{id:`e-${Date.now()}`,source:N,target:O}]);const v=re||String((s==null?void 0:s.content)||"");fe(g=>g.map(a=>{if(a.id!==O)return a;const y=a.data||{};return a.type==="agent"?{...a,data:{...y,config:{...y.config||{},prompt:v}}}:a.type==="midjourney"?{...a,data:{...y,prompt:v}}:a.type==="aiImage"?{...a,data:{...y,config:{...y.config||{},prompt:v}}}:a.type==="textPreview"?{...a,data:{...y,content:v}}:{...a,data:{...y,config:{...y.config||{},prompt:v}}}}))}catch{}},ge=(s.title||"")==="åˆ†é•œè®¾è®¡",de=(s.title||"")==="æç¤ºè¯",me=(()=>{if(!ge)return[];const S=String(s.content||""),G=S.split(/\r?\n/).map(j=>j.trim()),x=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),c=[];let I=null;for(const j of G){if(!j)continue;const O=j.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(O&&x.has(O[1])){I&&c.push(I),I={label:O[1],content:O[2]||""};continue}if(x.has(j)){I&&c.push(I),I={label:j,content:""};continue}I?I.content=I.content?`${I.content}
${j}`:j:I={label:"æ–‡æœ¬",content:j}}if(I&&c.push(I),c.length===0)return[{label:"æ–‡æœ¬",content:S}];const L=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],$=new Map(L.map((j,O)=>[j,O]));return c.filter(j=>j.content&&j.content.trim().length>0).sort((j,O)=>($.get(j.label)??999)-($.get(O.label)??999))})(),[Ee,Z]=t.useState(me),z=t.useRef(null),A=t.useRef([]);return t.useEffect(()=>{Z(me)},[s.content,ge]),t.useEffect(()=>{requestAnimationFrame(()=>{A.current.forEach(S=>{S&&(S.style.height="auto",S.style.height=`${S.scrollHeight}px`)})})},[Ee]),t.useEffect(()=>{de&&K(s.content||"")},[s.content,de]),e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:ge?e.jsx("div",{ref:he,className:"space-y-2 nowheel",children:Ee.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ee.map((S,G)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:S.label}),e.jsx("textarea",{value:S.content,onChange:x=>{const c=x.target.value;x.target.style.height="auto",x.target.style.height=`${x.target.scrollHeight}px`,Z(I=>{const L=I.map((O,r)=>r===G?{...O,content:c}:O),$=L.map(O=>`${O.label}ï¼š${O.content}`).join(`
`);return Q(N)&&fe(O=>O.map(r=>r.id===N?{...r,data:{...r.data,content:$}}:r)),z.current&&(clearTimeout(z.current),z.current=null),z.current=window.setTimeout(async()=>{const O=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};L.forEach(v=>{O.has(v.label)&&(r[v.label]=v.content)}),await Ie(r)},600),L})},onBlur:async x=>{const c=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),I={};I[S.label]=x.currentTarget.value,c.has(S.label)&&await Ie(I)},onMouseDown:x=>x.stopPropagation(),onTouchStart:x=>x.stopPropagation(),ref:x=>{A.current[G]=x,x&&(x.style.height="auto",x.style.height=`${x.scrollHeight}px`,x.style.overflow="hidden",x.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors",placeholder:`å¡«å†™${S.label}...`})]},`sec-${G}`))}):de?e.jsxs("div",{ref:Ue,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:re,onChange:S=>{const G=S.target.value;K(G);const x=440;S.target.style.height="auto";const c=Math.min(S.target.scrollHeight,x);S.target.style.height=`${c}px`,S.target.style.overflowY=S.target.scrollHeight>x?"auto":"hidden",Q(N)&&fe(L=>L.map($=>$.id===N?{...$,data:{...$.data,content:G}}:$)),ae.current&&(clearTimeout(ae.current),ae.current=null),ae.current=window.setTimeout(async()=>{await Ie({æç¤ºè¯:G})},600)},onBlur:async S=>{const G=S.currentTarget.value;await Ie({æç¤ºè¯:G})},onMouseDown:S=>S.stopPropagation(),onTouchStart:S=>S.stopPropagation(),ref:S=>{if(ce.current=S,S){S.style.wordBreak="break-word",S.style.height="auto";const x=Math.min(S.scrollHeight,440);S.style.height=`${x}px`,S.style.overflowY=S.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ne,onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),disabled:!re.trim(),className:"nodrag relative w-full mt-2 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 disabled:opacity-50 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:se,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(St,{type:"target",position:pt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(St,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Io=t.memo(jo),So=({data:s,selected:N,id:n})=>{const{setNodes:F,setEdges:we,getNode:U,getNodes:fe,getEdges:Q,getViewport:re}=Zt(),K=zs(),ce=Ds(),[Ue]=t.useState(s.isExpanded??!0),[he,se]=t.useState(s.prompt||""),[ae,Ie]=t.useState(s.ratio||"16:9"),[ne,ge]=t.useState(s.mode||"relax"),[de,me]=t.useState(s.chaos??0),[Ee,Z]=t.useState(s.stylize??100),[z,A]=t.useState(s.weird??0),[S,G]=t.useState(s.quality??1),[x,c]=t.useState(s.styleRaw??!1),[I,L]=t.useState(s.omniWeight??100),[$,j]=t.useState(s.styleWeight??100),[,O]=t.useState(s.taskId||""),[r,v]=t.useState(s.status||"idle"),[g,a]=t.useState(s.progress||""),[y,d]=t.useState(s.omniReferenceImages||[]),[m,f]=t.useState(s.styleReferenceImages||[]),[w,R]=t.useState(!0);t.useEffect(()=>{(async()=>{var b;try{const Y=await Ce.midjourney.getSettings();R(((b=Y.settings)==null?void 0:b.fastEnabled)??!0)}catch{}})()},[]);const{credits:W,isFreeUsage:_,freeUsageRemaining:p,refetch:l}=Us({moduleType:"midjourney",operationType:"imagine",mode:ne}),i=t.useRef(null),B=t.useRef(!1),M=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==he&&se(s.prompt)},[s.prompt]);const X=E=>{F(b=>b.map(Y=>Y.id===n?{...Y,data:{...Y.data,...E}}:Y))};t.useEffect(()=>{const E=s.taskId,b=s.status;(async()=>{var ue,H;if(E&&(b==="processing"||b==="submitting"))try{const Se=(await Ce.midjourney.fetchTask(E)).task;if(Se.status==="SUCCESS"){const Ne=Se.imageUrl||"",Re=((ue=Se.properties)==null?void 0:ue.messageId)||"",Ae=((H=Se.properties)==null?void 0:H.messageHash)||"",_e=s.ratio||"16:9";if(v("idle"),a(""),X({status:"idle",progress:"",taskId:""}),fe().find(Ge=>{var Ze,Wt,Ct;return Ge.type==="imagePreview"&&((Ze=Ge.data.midjourneyData)==null?void 0:Ze.sourceNodeId)===n&&(((Wt=Ge.data.midjourneyData)==null?void 0:Wt.taskId)===E||Re&&((Ct=Ge.data.midjourneyData)==null?void 0:Ct.messageId)===Re)})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}h.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(Ne,"4å®«æ ¼",_e,{taskId:E,messageId:Re,messageHash:Ae,mode:s.mode||"relax",buttons:Se.buttons,action:Se.action})}else Se.status==="IN_PROGRESS"||Se.status==="SUBMITTED"?(v("processing"),setTimeout(()=>{M.current(E)},100)):Se.status==="FAILURE"?(v("error"),a(""),X({status:"error",progress:"",taskId:""}),h.error(Se.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Se.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Se.status==="NOT_FOUND"&&(v("idle"),a(""),X({status:"idle",progress:"",taskId:""}))}catch{v("idle"),a(""),X({status:"idle",progress:"",taskId:""}),h.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const V=t.useCallback(()=>{const E=K.filter(Ne=>Ne.target===n),b=[],Y=[];let ue="";E.forEach(Ne=>{var Ae,_e,$e,le,Ge,Ze,Wt,Ct;const Re=U(Ne.source);if(Re){const _t=Re.data,dt=Ne.targetHandle||"omni-ref";if(dt==="text-input"){if(Re.type==="agent"){const gt=((Ae=_t.config)==null?void 0:Ae.generatedText)||"";gt&&typeof gt=="string"&&(ue=gt)}}else{let gt=_t.imageUrl||"";if(!gt&&((_e=_t.config)!=null&&_e.selectedAsset)){const vt=_t.config.selectedAsset;vt.type==="IMAGE"&&(gt=`https://api.waule.com${vt.url}`.replace(".oss-oss-",".oss-"))}if(!gt&&(($e=_t.config)!=null&&$e.generatedImageUrl)&&(gt=_t.config.generatedImageUrl),Re.type==="assetSelector"){const vt="https://api.waule.com",lt=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},Ye=(le=_t.config)==null?void 0:le.subjects,yt=(Ge=_t.config)==null?void 0:Ge.referenceImages;if(dt==="omni-ref"){let Be="";Ye&&Ye.length>0&&Ye[0].images&&Ye[0].images.length>0?Be=lt(Ye[0].images[0]):yt&&yt.length>0?Be=lt(yt[0].url):(Ze=_t.config)!=null&&Ze.selectedAsset&&_t.config.selectedAsset.type==="IMAGE"&&(Be=lt(_t.config.selectedAsset.url)),Be&&!b.includes(Be)&&b.length<1&&b.push(Be)}else if(dt==="style-ref"){let Be="";Ye&&Ye.length>0&&Ye[0].images&&Ye[0].images.length>0?Be=lt(Ye[0].images[0]):yt&&yt.length>0?Be=lt(yt[0].url):(Wt=_t.config)!=null&&Wt.selectedAsset&&_t.config.selectedAsset.type==="IMAGE"&&(Be=lt(_t.config.selectedAsset.url)),Be&&!Y.includes(Be)&&Y.length<1&&Y.push(Be)}}if(Re.type==="upload"){const vt="https://api.waule.com",lt=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},yt=(((Ct=_t.config)==null?void 0:Ct.uploadedFiles)||[]).find(Be=>Be.type==="IMAGE"||(Be.mimeType||"").startsWith("image/"));if(yt){const Be=lt(yt.url);dt==="omni-ref"?Be&&!b.includes(Be)&&b.length<1&&b.push(Be):dt==="style-ref"&&Be&&!Y.includes(Be)&&Y.length<1&&Y.push(Be)}}gt&&(dt==="omni-ref"&&!b.includes(gt)?b.push(gt):dt==="style-ref"&&!Y.includes(gt)&&Y.push(gt))}}}),ue&&ue!==he&&!B.current&&(se(ue),X({prompt:ue}));const H=Ne=>{if(!Ne||typeof Ne!="string")return!1;const Re=Ne.trim();return Re?!!(Re.startsWith("data:image/")||/^https?:\/\//.test(Re)||Re.startsWith("/")):!1},pe=b.filter(H).slice(0,1),Se=Y.filter(H).slice(0,1);JSON.stringify(pe)!==JSON.stringify(y)&&(d(pe),X({omniReferenceImages:pe})),JSON.stringify(Se)!==JSON.stringify(m)&&(f(Se),X({styleReferenceImages:Se}))},[K,n,U,ce,he,B.current]);t.useEffect(()=>{V()},[V]),t.useEffect(()=>{const E=i.current;E&&Ue&&requestAnimationFrame(()=>{E.style.height="auto";const b=Math.max(60,Math.min(E.scrollHeight,600));E.style.height=`${b}px`})},[he,Ue]);const ie=E=>{try{const b=new URL(E),Y=new URLSearchParams(b.search);return Y.has("width")||Y.has("height")?(Y.delete("width"),Y.delete("height"),b.search=Y.toString(),b.toString()):E}catch{return E}},xe=E=>{const[Y,ue]=E.split(":").map(Number);if(!Y||!ue)return{width:512,height:512};const H=Y/ue;return H>=1?{width:512,height:Math.round(512/H)}:{width:Math.round(512*H),height:512}},oe=t.useCallback((E,b,Y,ue)=>{const H=U(n);if(!H)return;const pe=b.startsWith("U")?ie(E):E,Se=fe(),Ne=Q();if(Se.filter(Be=>Be.type==="imagePreview"&&Ne.some(wt=>wt.source===n&&wt.target===Be.id)).find(Be=>Be.data.imageUrl===pe))return;const _e=400,$e=200,le=100,Ge=Be=>{const wt=re().zoom||1,Yt=document.querySelector(`.react-flow__node[data-id="${Be.id}"]`),ks=(Yt==null?void 0:Yt.getBoundingClientRect().width)||Be.data&&Be.data.width||400,Is=(Yt==null?void 0:Yt.getBoundingClientRect().height)||Be.data&&Be.data.height||300,Ss=Math.round(ks/wt),vs=Math.round(Is/wt);return{w:Ss,h:vs}},Ze=(Be,wt=300)=>{if(!Be||!/^[0-9]+\s*:\s*[0-9]+$/.test(Be))return wt;const[Yt,ks]=Be.split(":").map(Is=>parseFloat(Is));return!Yt||!ks?wt:Math.round(_e*(ks/Yt))},Wt=Ge(H),Ct=Ze(Y,300),_t=H.position.x+Wt.w+$e,dt=H.position.y,gt=fe().filter(Be=>{var wt,Yt;return Be.type==="imagePreview"&&((Yt=(wt=Be.data)==null?void 0:wt.midjourneyData)==null?void 0:Yt.sourceNodeId)===n}).length,vt=_t,lt=dt+gt*(Ct+le),Ye=`preview-${Date.now()}`,yt={id:Ye,type:"imagePreview",position:{x:vt,y:lt},data:{imageUrl:pe,width:_e,ratio:Y,workflowContext:H.data.workflowContext,createdBy:H.data.createdBy,midjourneyData:ue?{taskId:ue.taskId,messageId:ue.messageId,messageHash:ue.messageHash,sourceNodeId:n,mode:ue.mode,buttons:ue.buttons,action:ue.action}:void 0}};F(Be=>[...Be,yt]),we(Be=>[...Be,{id:`${n}-${Ye}`,source:n,target:Ye,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),h.success(`âœ¨ å·²åˆ›å»º${b}é¢„è§ˆèŠ‚ç‚¹`)},[n,U,fe,Q,F,we,ie,xe]),k=t.useCallback(async()=>{var E,b,Y,ue,H,pe,Se,Ne,Re,Ae,_e,$e;if(!he.trim()){h.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}v("submitting"),a(""),X({status:"submitting",progress:""});try{const le=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ge=he.toLowerCase(),Ze=le.find(lt=>Ge.includes(lt));if(Ze){h.error(`æ£€æµ‹åˆ°å‚æ•° "${Ze}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),v("idle"),X({status:"idle",progress:"",taskId:""});return}v("submitting");let Wt=he;try{h.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const lt=await Ce.translation.smartTranslate({text:he});lt.success&&(Wt=lt.translatedText,lt.needsTranslation&&h.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{h.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}h.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let Ct=Wt.trim();if(ae&&ae!=="1:1"&&!Ct.includes("--ar")&&(Ct+=` --ar ${ae}`),!Ct.includes("--v")&&!Ct.includes("--version")&&(Ct+=" --v 7.0"),ne==="fast"&&!Ct.includes("--fast")?Ct+=" --fast":ne==="relax"&&!Ct.includes("--relax")&&(Ct+=" --relax"),de>0&&(Ct+=` --chaos ${de}`),Ee!==100&&(Ct+=` --stylize ${Ee}`),z>0&&(Ct+=` --weird ${z}`),S!==1&&(Ct+=` --quality ${S}`),x&&(Ct+=" --style raw"),y.length>0){h.info(`æ­£åœ¨ä¸Šä¼  ${y.length} å¼ å‚è€ƒå›¾...`);const lt=[];for(let Ye=0;Ye<y.length;Ye++){const yt=y[Ye];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)lt.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{h.error(`å‚è€ƒå›¾ ${Ye+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),v("idle");return}}Ct+=` --oref ${lt.join(" ")}`,I!==100&&(Ct+=` --ow ${I}`),h.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(m.length>0){h.info(`æ­£åœ¨ä¸Šä¼  ${m.length} å¼ é£æ ¼å›¾...`);const lt=[];for(let Ye=0;Ye<m.length;Ye++){const yt=m[Ye];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)lt.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{h.error(`é£æ ¼å›¾ ${Ye+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),v("idle");return}}Ct+=` --sref ${lt.join(" ")}`,$!==100&&(Ct+=` --sw ${$}`),h.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const _t=await Ce.midjourney.imagine({prompt:Ct,nodeId:n,mode:ne});if(!_t.success)throw new Error(_t.description||"ä»»åŠ¡æäº¤å¤±è´¥");const dt=_t.taskId;O(dt),v("processing"),X({taskId:dt,status:"processing",progress:"",prompt:he,ratio:ae,mode:ne,chaos:de,stylize:Ee,weird:z,quality:S,styleRaw:x,omniWeight:I,styleWeight:$});const gt=_t.isFreeUsage,vt=_t.creditsCharged||0;if(gt)h.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${p} æ¬¡æœºä¼š`),l();else if(vt>0){const{useAuthStore:lt}=await xs(async()=>{const{useAuthStore:yt}=await import("./index-B-U_h0BA.js").then(Be=>Be.f);return{useAuthStore:yt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ye}=lt.getState();await Ye(),h.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${vt} ç§¯åˆ†`),l()}else h.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");M.current(dt)}catch(le){if(v("error"),a(""),X({status:"error",progress:"",taskId:""}),((E=le.response)==null?void 0:E.status)===403){const Wt=((Y=(b=le.response)==null?void 0:b.data)==null?void 0:Y.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";h.error(Wt);return}if(((ue=le.response)==null?void 0:ue.status)===429){h.warning(((pe=(H=le.response)==null?void 0:H.data)==null?void 0:pe.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ge=((Ne=(Se=le.response)==null?void 0:Se.data)==null?void 0:Ne.description)||((Ae=(Re=le.response)==null?void 0:Re.data)==null?void 0:Ae.error)||le.message,Ze=($e=(_e=le.response)==null?void 0:_e.data)==null?void 0:$e.bannedWord;Ze?h.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${Ze}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):h.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ge}ï¼Œè¯·ç¨åé‡è¯•`)}},[he,ae,ne,de,Ee,z,S,x,y,I,m,$,X,_,p,l]),u=t.useCallback(async E=>{let b=0;const Y=150,ue=2e3,H=async()=>{var pe,Se,Ne,Re;try{const _e=(await Ce.midjourney.fetchTask(E)).task;if(_e.status==="SUCCESS"){const le=_e.imageUrl||"",Ge=((pe=_e.properties)==null?void 0:pe.messageId)||"",Ze=((Se=_e.properties)==null?void 0:Se.messageHash)||"";if(v("idle"),a(""),X({status:"idle",taskId:"",progress:""}),fe().find(_t=>{var dt,gt,vt;return _t.type==="imagePreview"&&((dt=_t.data.midjourneyData)==null?void 0:dt.sourceNodeId)===n&&(((gt=_t.data.midjourneyData)==null?void 0:gt.taskId)===E||Ge&&((vt=_t.data.midjourneyData)==null?void 0:vt.messageId)===Ge)})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}h.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(le,"4å®«æ ¼",ae,{taskId:E,messageId:Ge,messageHash:Ze,mode:ne,buttons:_e.buttons,action:_e.action});return}const $e=_e.progress||"";if(a($e),(_e.status==="IN_PROGRESS"||_e.status==="SUBMITTED")&&(v("processing"),X({status:"processing",progress:$e})),_e.status==="FAILURE"){v("error"),a(""),X({status:"error",progress:"",taskId:""}),h.error(_e.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${_e.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(_e.status==="NOT_FOUND"){v("error"),a(""),X({status:"error",progress:"",taskId:""}),h.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}b++,b<Y?setTimeout(H,ue):(v("error"),a(""),X({status:"error",progress:"",taskId:""}),h.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Ae){if((Ae.code==="ECONNABORTED"||Ae.code==="ERR_NETWORK"||((Ne=Ae.message)==null?void 0:Ne.includes("aborted"))||((Re=Ae.message)==null?void 0:Re.includes("Network Error")))&&b<Y-1){b++,setTimeout(H,ue*2);return}v("error"),a(""),X({status:"error",progress:"",taskId:""}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};H()},[n,ae,oe,X,fe]);return M.current=u,e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Ue&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:i,value:he,onChange:E=>{B.current=!0,se(E.target.value)},onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>ge("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ne==="relax"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!w){h.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}ge("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${w?ne==="fast"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50":"bg-slate-200 dark:bg-white/10 text-slate-400 dark:text-white/30 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:opacity-50 disabled:cursor-not-allowed`,title:w?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!w&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(os,{value:ae,onChange:E=>Ie(E),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:de})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:de,onChange:E=>me(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${de/2}%, #06b6d4 ${de}%, var(--range-bg-color) ${de}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ee})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ee,onChange:E=>Z(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${Ee/1e3*50}%, #06b6d4 ${Ee/1e3*100}%, var(--range-bg-color) ${Ee/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:z})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:z,onChange:E=>A(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${z/3e3*50}%, #06b6d4 ${z/3e3*100}%, var(--range-bg-color) ${z/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:S})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:S===.25?0:S===.5?1:S===1?2:3,onChange:E=>{const b=Number(E.target.value);G(b===0?.25:b===1?.5:b===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${(S===.25?0:S===.5?1:S===1?2:3)/3*50}%, #06b6d4 ${(S===.25?0:S===.5?1:S===1?2:3)/3*100}%, var(--range-bg-color) ${(S===.25?0:S===.5?1:S===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>c(!x),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed ${x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-purple-500 dark:border-purple-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${x?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600"}`})})]})})]}),y.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Dr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",y.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:y.map((E,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Reference ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:I})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:I,onChange:E=>L(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${I/1e3*50}%, #06b6d4 ${I/1e3*100}%, var(--range-bg-color) ${I/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),m.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Dr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",m.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:m.map((E,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Style ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:$})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:$,onChange:E=>j(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${$/1e3*50}%, #06b6d4 ${$/1e3*100}%, var(--range-bg-color) ${$/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:k,onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 relative overflow-hidden bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:opacity-50 disabled:cursor-wait",children:[r==="processing"&&g&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400/30 to-accent-400/30 transition-all duration-300",style:{width:g}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!g||g===""||g==="0%"?ne==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${g}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),_?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",p,"æ¬¡"]}):W!==null&&W>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-blue-500/30 text-blue-200 rounded text-[9px]",children:[W,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(us,{type:"target",position:pt.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>{const b=U(E.source||"");return!!b&&b.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(us,{type:"target",position:pt.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!K.some(Y=>Y.target===n&&Y.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(us,{type:"target",position:pt.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!K.some(Y=>Y.target===n&&Y.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(us,{type:"source",position:pt.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},wr="https://api.waule.com",Eo=({data:s,selected:N,id:n})=>{var bs,er,ws,tr,sr,rr,Ps;const[F,we]=t.useState(!0),[,U]=t.useState(0),[fe,Q]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[fe]);const{setNodes:re,setEdges:K,getNode:ce,getNodes:Ue,getEdges:he}=Zt(),se=zs(),ae=Ds(),Ie=t.useRef(""),ne=(bs=s.config)==null?void 0:bs.selectedEditingCapability,ge=t.useMemo(()=>(s.models||[]).filter(te=>{var De;return te.type==="VIDEO_GENERATION"&&((De=te.provider)==null?void 0:De.toLowerCase())==="sora"}),[s.models]),[de,me]=t.useState(s.config.prompt||""),Ee=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==de&&me(s.config.prompt)},[s.config.prompt]);const[Z,z]=t.useState(s.config.modelId||((er=ge[0])==null?void 0:er.id)||""),[A,S]=t.useState(s.config.ratio||"16:9"),[G,x]=t.useState(s.config.resolution||"1080P"),c=t.useCallback(J=>{const te=(J||"").toLowerCase();return te?te.includes("æ–‡ç”Ÿ")||te.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":te.includes("é¦–å°¾")?"é¦–å°¾å¸§":te.includes("é¦–å¸§")||te.includes("first frame")||te.includes("start frame")||te.includes("initial frame")||te.includes("keyframe")?"é¦–å¸§":te.includes("å°¾å¸§")||te.includes("last frame")||te.includes("end frame")||te.includes("final frame")?"å°¾å¸§":te.includes("ä¸»ä½“å‚è€ƒ")||te.includes("å‚è€ƒ")||te.includes("reference image")||te.includes("image reference")||te.includes("ref image")?"å‚è€ƒå›¾":te.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":te.includes("first-last")||te.includes("two-frame")||te.includes("frame pair")?"é¦–å°¾å¸§":te.includes("first")?"é¦–å¸§":te.includes("last")?"å°¾å¸§":te.includes("subject")||te.includes("reference")?"å‚è€ƒå›¾":J||"":""},[]),[I,L]=t.useState((s.config.lockedGenerationType?c(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[$,j]=t.useState(s.config.duration||10),[O,r]=t.useState(s.config.isGenerating||!1),[v,g]=t.useState([]),[a,y]=t.useState(null),[d,m]=t.useState(!1),[f]=t.useState(""),[w]=t.useState("confirm"),[R]=t.useState(null),[W,_]=t.useState(!1),[p,l]=t.useState([]),[i,B]=t.useState(""),[M,X]=t.useState(0),[V,ie]=t.useState(0),xe=t.useRef(!1),[oe,k]=t.useState(!1),u=ge.find(J=>J.id===Z)||ge[0],{credits:E,loading:b,isFreeUsage:Y,freeUsageRemaining:ue,refetch:H}=Us({aiModelId:u==null?void 0:u.id,duration:$,resolution:G});t.useEffect(()=>{var J,te;if(!ge.find(De=>De.id===Z)){const De=((J=ge[0])==null?void 0:J.id)||"";z(De),Ze({modelId:De,modelName:(te=ge[0])==null?void 0:te.name})}},[ge]);const pe=((ws=u==null?void 0:u.provider)==null?void 0:ws.toLowerCase())==="sora",Se=t.useMemo(()=>{var te;if((te=u==null?void 0:u.config.supportedDurations)!=null&&te.length)return u.config.supportedDurations;const J=((u==null?void 0:u.provider)||"").toLowerCase();return J==="sora"?[10,15]:J==="minimaxi"?[6,10]:[$||10]},[u,$]),Ne=t.useMemo(()=>{var te;return(te=u==null?void 0:u.config.supportedResolutions)!=null&&te.length?u.config.supportedResolutions:((u==null?void 0:u.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[u]),Re=t.useMemo(()=>Math.min(...Se),[Se]),Ae=t.useMemo(()=>Math.max(...Se),[Se]),_e=t.useMemo(()=>Math.max(1,Ae-Re),[Ae,Re]),$e=t.useMemo(()=>{const J=($-Re)/_e*100;return Number.isNaN(J)?0:Math.min(100,Math.max(0,J))},[$,Re,_e]),le=!u||!((tr=u.config.supportedDurations)!=null&&tr.length),Ge=!u||!((sr=u.config.supportedResolutions)!=null&&sr.length),Ze=t.useCallback(J=>{ce(n)&&re(De=>De.map(Ve=>Ve.id===n?{...Ve,data:{...Ve.data,config:{...Ve.data.config,...J}}}:Ve))},[ce,n,re]),Wt=(J,te)=>{const De=(T,P)=>P===0?T:De(P,T%P),Ve=De(J,te),qe=J/Ve,Le=te/Ve,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},it=`${qe}:${Le}`;return tt[it]||it},Ct=()=>{const J=se.filter(Le=>Le.target===n),te=[];J.forEach(Le=>{var it;const tt=ce(Le.source);if(tt&&tt.type==="upload"&&(((it=tt.data.config)==null?void 0:it.uploadedFiles)||[]).forEach(P=>{const be=P.type||P.mimeType||"";(be==="IMAGE"||be.startsWith("image/"))&&te.push({id:P.id||P.name,url:P.url,name:P.name||P.originalName,width:P.width,height:P.height,aspectRatio:P.width&&P.height?Wt(P.width,P.height):"16:9"})}),tt&&tt.type==="assetSelector"){const T=tt.data.config||{},P=T.subjects,be=T.selectedAsset,Te=c(I);P&&P.length>0?Te==="é¦–å°¾å¸§"||(P[0].images||[]).forEach((ye,et)=>{te.push({id:`${tt.id}-subject-${et}`,url:ye,name:P[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):be&&be.type==="IMAGE"&&te.push({id:be.id,url:be.url,name:be.name||be.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const T=tt.data.imageUrl,P=tt.data.width,be=tt.data.height;T&&te.push({id:tt.id,url:T,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:P,height:be,aspectRatio:P&&be?Wt(P,be):"16:9"})}});const De=new Set,Ve=[];te.forEach(Le=>{const tt=Le.url;De.has(tt)||(De.add(tt),Ve.push(Le))});const qe=c(I);return qe==="æ–‡ç”Ÿè§†é¢‘"?pe?Ve:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ve.slice(0,1):qe==="é¦–å°¾å¸§"?Ve.slice(0,2):qe==="å‚è€ƒå›¾"?Ve.slice(0,7):Ve},_t=t.useMemo(()=>Ct(),[se,ae,I,n,pe]);t.useEffect(()=>{const J=s.config.taskId;(async()=>{let De=!1;if(s.config.isGenerating||!J)try{const Ve=await Ce.tasks.getActiveTask(n);if(Ve.task){const qe=Ve.task;Q(qe.id),r(!0),U(qe.progress||0),Hs(qe.id);return}else s.config.isGenerating&&(r(!1),Ze({isGenerating:!1}))}catch{}if(J){const Ve=Ue(),qe=he(),Le=Ve.find(tt=>tt.type==="videoPreview"&&qe.some(it=>it.source===n&&it.target===tt.id));if(Le&&Le.data.videoUrl){De=!0,J&&(Ze({taskId:""}),Q(""));return}try{const it=(await Ce.tasks.getTaskStatus(J)).task;if(it.status==="SUCCESS"){const T=it.resultUrl;U(100),setTimeout(()=>U(0),1e3);try{const P=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(P).some(je=>je.taskId&&je.taskId===J||je.sourceNodeId&&je.sourceNodeId===n)||Tt(T,s.config.ratio||"16:9")}catch{Tt(T,s.config.ratio||"16:9")}De=!0,Ze({taskId:""}),Q(""),h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")}else if(it.status==="PROCESSING"||it.status==="PENDING"){r(!0),U(it.progress||0),Hs(J);return}else it.status==="FAILURE"&&(U(0),Ze({taskId:""}),h.error(it.errorMessage?`è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${it.errorMessage}`:"è§†é¢‘ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{U(0),Ze({taskId:""})}}if(!De)try{const Ve=await Ce.tasks.getPendingPreviewNodes(n);if(Ve.tasks&&Ve.tasks.length>0)for(const qe of Ve.tasks){const{previewNodeData:Le}=qe;if(Le&&Le.url){const tt=Le.ratio||s.config.ratio||"16:9";let it=!1;try{const T=localStorage.getItem("suppressedPreviewTasks")||"[]";it=JSON.parse(T).some(be=>be.taskId&&be.taskId===qe.id||be.sourceNodeId&&be.sourceNodeId===n)}catch{}it||Tt(Le.url,tt),await Ce.tasks.markPreviewNodeCreated(qe.id)}}}catch{}})()},[]),t.useEffect(()=>{const J=se.filter(De=>De.target===n);let te="";J.forEach(De=>{var qe;const Ve=ce(De.source);if(Ve){const Le=Ve.data;Ve.type==="agent"&&((qe=Le.config)!=null&&qe.generatedText)?te||(te=Le.config.generatedText):Ve.type==="textPreview"&&Le.content&&(te||(te=Le.content))}}),te&&te!==de&&(me(te),Ze({prompt:te}))},[se,n,ce,de,Ze]),t.useEffect(()=>{const J=se.filter(Ve=>Ve.target===n);if(J.length===0)return;let te="",De="";J.forEach(Ve=>{var Le;const qe=ae.find(tt=>tt.id===Ve.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Le=tt.config)!=null&&Le.generatedText&&(te=tt.config.generatedText,De=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),te&&De!==Ie.current&&(Ie.current=De,me(te),Ze({prompt:te}))},[ae,se,n,Ze]),t.useEffect(()=>{const J=JSON.stringify(_t),te=JSON.stringify(v);J!==te&&g(_t)},[_t]);const dt=t.useMemo(()=>{if(pe)return!0;const J=v.length,te=c(I);return J===0?!0:J===1?te==="å‚è€ƒå›¾":J===2?te==="é¦–å°¾å¸§"?!1:te==="å‚è€ƒå›¾":J>2?te==="å‚è€ƒå›¾":!1},[v.length,I,c,pe]),gt=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),vt=t.useMemo(()=>{const J=c(I);return ne?ge:ge.filter(te=>{var Ve;const De=(((Ve=te.config)==null?void 0:Ve.supportedGenerationTypes)||[]).map(qe=>c(qe));return J==="é¦–å¸§"||J==="å°¾å¸§"?De.includes("é¦–å¸§")||De.includes("å°¾å¸§"):De.includes(J)})},[ge,I,c,ne]),lt=t.useMemo(()=>{const J=ne?ge:vt;return J.length>0?J:ne?(s.models||[]).filter(De=>(De.type||"")==="VIDEO_EDITING"):J},[ne,ge,vt,s.models]);t.useEffect(()=>{var te,De;if(!lt.find(Ve=>Ve.id===Z)){const Ve=((te=lt[0])==null?void 0:te.id)||"";z(Ve),Ze({modelId:Ve||void 0,modelName:Ve?(De=lt[0])==null?void 0:De.name:void 0})}},[lt]);const Ye=t.useCallback(J=>{const te=c(J);return ne?["IMAGE","VIDEO"]:te==="æ–‡ç”Ÿè§†é¢‘"?pe?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[c,ne,pe]);t.useEffect(()=>{if(!dt&&v.length>0){const J=v[0].aspectRatio;J&&A!==J&&(S(J),setTimeout(()=>{Ze({ratio:J})},0))}},[dt,v,A]),t.useEffect(()=>{if(!ne&&gt.length>0&&!gt.includes(I)){const J="æ–‡ç”Ÿè§†é¢‘";L(J),setTimeout(()=>{Ze({generationType:J,acceptedInputs:Ye(J)})},0)}},[gt,I,Ye,ne]),t.useEffect(()=>{const J=c(I);if(J==="æ–‡ç”Ÿè§†é¢‘")return;const te=se.filter(Le=>Le.target===n),De=[],Ve=[];te.forEach(Le=>{var T,P,be,Te,je;const tt=ce(Le.source);if(!tt)return;const it=tt.type;if((it||"").startsWith("aiVideo")||it==="videoPreview"){Ve.push(Le.id);return}if(it==="upload"){const ye=(be=(P=(T=tt.data)==null?void 0:T.config)==null?void 0:P.uploadedFiles)==null?void 0:be[0],et=((ye==null?void 0:ye.type)||"").toUpperCase(),st=((ye==null?void 0:ye.mimeType)||"").toLowerCase();if(et==="VIDEO"||st.startsWith("video/")){Ve.push(Le.id);return}(et==="IMAGE"||st.startsWith("image/"))&&De.push(Le.id);return}if(it==="assetSelector"){const ye=((Te=tt.data)==null?void 0:Te.config)||{};if(ye.selectedAsset){const et=(ye.selectedAsset.type||"").toUpperCase(),st=(ye.selectedAsset.mimeType||"").toLowerCase();et==="VIDEO"||st.startsWith("video/")?Ve.push(Le.id):(et==="IMAGE"||st.startsWith("image/"))&&De.push(Le.id)}else if(ye.subjects&&ye.subjects.length>0){const et=(((je=ye.subjects[0])==null?void 0:je.images)||[]).length;J==="å‚è€ƒå›¾"||J==="é¦–å°¾å¸§"?De.push(Le.id):(J==="é¦–å¸§"||J==="å°¾å¸§")&&(et>1?Ve.push(Le.id):De.push(Le.id))}return}(it==="aiImage"||it==="imagePreview")&&De.push(Le.id)});let qe=new Set([...Ve]);J==="é¦–å¸§"||J==="å°¾å¸§"?De.slice(1).forEach(Le=>qe.add(Le)):J==="é¦–å°¾å¸§"&&De.slice(2).forEach(Le=>qe.add(Le)),qe.size>0&&K(Le=>Le.filter(tt=>!qe.has(tt.id)))},[I,se,n,ce,K,c]),t.useEffect(()=>{const J=s.config.generationType;if(!J||c(J)!==c(I)){const te=c(I)||"æ–‡ç”Ÿè§†é¢‘";Ze({generationType:te,acceptedInputs:Ye(te)})}},[]),t.useEffect(()=>{const J=Ye(I);Ze({acceptedInputs:J})},[I,Ye]);const yt=J=>{y(J)},Be=J=>{J.preventDefault()},wt=J=>{if(a===null)return;const te=[...v],[De]=te.splice(a,1);te.splice(J,0,De),g(te),y(null),Ze({referenceImages:te})};t.useEffect(()=>{const J=Ee.current;J&&F&&requestAnimationFrame(()=>{J.style.height="auto";const te=Math.max(60,Math.min(J.scrollHeight,600));J.style.height=`${te}px`})},[de,F]),t.useEffect(()=>{if(de===s.config.prompt)return;const J=setTimeout(()=>{Ze({prompt:de})},500);return()=>clearTimeout(J)},[de]);const Yt=t.useCallback(async J=>{if(!J){l([]);return}try{const te=await Ce.soraCharacters.search(J,5);l(te.characters||[]),ie(0)}catch{l([])}},[]),ks=t.useCallback(J=>{const te=J.target.value,De=J.target.selectionStart||0;if(me(te),xe.current)return;const qe=te.substring(0,De).match(/@([^@\s#]*)$/);if(qe){const Le=qe[1];B(Le),X(De-Le.length-1),_(!0),Yt(Le)}else _(!1),l([])},[Yt]),Is=t.useCallback(J=>{const te=de.substring(0,M),De=de.substring(M+i.length+1),Ve=`@#${J.customName}#`,qe=te+Ve+De;me(qe),_(!1),l([]),B(""),setTimeout(()=>{if(Ee.current){Ee.current.focus();const Le=te.length+Ve.length;Ee.current.setSelectionRange(Le,Le)}},0)},[de,M,i]),Ss=t.useCallback(J=>{!W||p.length===0||(J.key==="ArrowDown"?(J.preventDefault(),ie(te=>te<p.length-1?te+1:te)):J.key==="ArrowUp"?(J.preventDefault(),ie(te=>te>0?te-1:te)):J.key==="Enter"&&p[V]?(J.preventDefault(),Is(p[V])):J.key==="Escape"&&_(!1))},[W,p,V,Is]),vs=t.useCallback(async J=>{var qe;const te=/@#([^#]+)#/g,De=[...J.matchAll(te)];if(De.length===0)return J;let Ve=J;for(const Le of De){const tt=Le[1];try{const it=await Ce.soraCharacters.getByCustomName(tt);(qe=it.character)!=null&&qe.characterName&&(Ve=Ve.replace(Le[0],` ${it.character.characterName} `))}catch{}}return Ve},[]),Bs=J=>{var De,Ve,qe,Le;z(J);const te=vt.find(tt=>tt.id===J);if(te){const tt=(De=te.config.supportedRatios)!=null&&De.length?te.config.supportedRatios:["16:9"],it=(Ve=te.config.supportedResolutions)!=null&&Ve.length?te.config.supportedResolutions:["1080P"],T=(qe=te.config.supportedGenerationTypes)!=null&&qe.length?te.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],P=(te.provider||"").toLowerCase(),be=(Le=te.config.supportedDurations)!=null&&Le.length?te.config.supportedDurations:P==="sora"?[10,15]:P==="minimaxi"?[6,10]:[10],Te=tt[0],je=it[0],ye=c(I||T[0]),et=be[0];S(Te),x(je),L(ye),j(et),Ze({modelId:J,modelName:te.name,ratio:Te,resolution:je,generationType:ye,duration:et,acceptedInputs:Ye(ye)})}},gs=t.useMemo(()=>{const J=c(I),te=v.length,qe=se.filter(Le=>Le.target===n).filter(Le=>{var T,P,be,Te,je;const tt=ce(Le.source),it=tt==null?void 0:tt.type;if(!tt)return!1;if(it==="upload"){const ye=(be=(P=(T=tt.data)==null?void 0:T.config)==null?void 0:P.uploadedFiles)==null?void 0:be[0],et=((ye==null?void 0:ye.mimeType)||"").toLowerCase();return((ye==null?void 0:ye.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}if(it==="assetSelector"){const ye=(je=(Te=tt.data)==null?void 0:Te.config)==null?void 0:je.selectedAsset,et=((ye==null?void 0:ye.mimeType)||"").toLowerCase();return((ye==null?void 0:ye.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}return!!((it||"").startsWith("aiVideo")||it==="videoPreview")}).length;return Z?J==="æ–‡ç”Ÿè§†é¢‘"?pe?!0:!!de.trim():J==="é¦–å¸§"||J==="å°¾å¸§"?te>=1:J==="é¦–å°¾å¸§"?te>=2:J==="å‚è€ƒå›¾"?te>=1:J==="è§†é¢‘æ¢äºº"?qe>=1&&te>=1:J==="å¯¹å£å‹"||J==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[I,v.length,de,O,se,n,ce,c,pe]);t.useEffect(()=>{var te;const J=(te=s==null?void 0:s.config)==null?void 0:te.generatedVideoUrl;J&&Tt(J,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const Hs=async J=>{let De=0;const Ve=async()=>{try{De++;const Le=(await Ce.tasks.getTaskStatus(J)).task;if(U(Le.progress||0),Le.status==="SUCCESS"||Le.status==="COMPLETED"||Le.status==="DONE"){U(100);const tt=Le.resultUrl;r(!1),Tt(tt,s.config.ratio||"16:9");try{await Ce.tasks.markPreviewNodeCreated(J)}catch{}Ze({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),Q(""),h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>U(0),1e3);return}else if(Le.status==="FAILURE"){r(!1),U(0),Ze({taskId:"",isGenerating:!1}),h.error(Le.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Le.status==="PROCESSING"||Le.status==="PENDING")&&(De<600?setTimeout(Ve,1e3):(r(!1),U(0),Ze({taskId:"",isGenerating:!1}),h.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),U(0),Ze({taskId:"",isGenerating:!1}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ve()},Xs=async()=>{var De,Ve,qe,Le,tt,it;if(c(I)==="æ–‡ç”Ÿè§†é¢‘"&&!de.trim()){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const te=Ct();Ze({referenceImages:te}),U(0);try{let T=[],P;const be=te.length;if(te.length>0)try{for(const zt of te){let At=zt.url;!At.startsWith("data:")&&!At.startsWith("http")&&(At=`${wr}${At}`),At=At.replace(/^https?:\/\/localhost(?::\d+)?/i,wr);const Ut=await dr(At);T.push(Ut)}}catch{h.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Te=se.filter(zt=>zt.target===n);if(c(I)==="å‚è€ƒå›¾"){const zt=new Map;for(const At of Te){const Ut=ce(At.source);if((Ut==null?void 0:Ut.type)==="assetSelector"){const Vt=(De=Ut.data.config)==null?void 0:De.subjects;if(Vt&&Vt.length>0){for(const Ft of Vt)if(!zt.has(Ft.name)){const ts=(Ft.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${wr}${rs}`);zt.set(Ft.name,ts)}}}}if(zt.size>0){const At=Array.from(zt.entries());let Ut=0;const Vt=[];for(const[Ft,ts]of At){if(Ut>=7)break;const rs=7-Ut,ys=ts.slice(0,Math.max(0,rs));ys.length>0&&(Vt.push({name:Ft,images:ys}),Ut+=ys.length)}P=Vt,At.some(([,Ft])=>Ft.length>0)&&Ut<At.reduce((Ft,[,ts])=>Ft+ts.length,0)&&h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const je=P&&P.length>0?P.reduce((zt,At)=>{var Ut;return zt+(((Ut=At.images)==null?void 0:Ut.length)||0)},0):be;let ye=I;if(ye==="é¦–å¸§"||ye==="å°¾å¸§"){if(je!==1){h.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),U(0);return}}else if(ye==="é¦–å°¾å¸§"){if(je===1)ye="é¦–å¸§";else if(je!==2){h.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),U(0);return}P&&P.length>0?P=[{...P[0],images:P[0].images.slice(0,2)}]:T=T.slice(0,2)}else if(ye==="å‚è€ƒå›¾"||ye==="ä¸»ä½“å‚è€ƒ"){if(je<1){h.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),U(0);return}if(P&&P.length>0){if(P.reduce((At,Ut)=>{var Vt;return At+(((Vt=Ut.images)==null?void 0:Vt.length)||0)},0)>7){let At=7;P=P.map(Ut=>({...Ut,images:Ut.images.slice(0,Math.max(0,At-=Ut.images.length,Ut.images.length))})),At=7,P=P.map(Ut=>{const Vt=Ut.images.slice(0,Math.min(Ut.images.length,At));return At-=Vt.length,{...Ut,images:Vt}}).filter(Ut=>Ut.images.length>0),h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else T.length>7&&(T=T.slice(0,7),h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}R==="dropImages"&&(T=[],P=void 0),(c(I)==="é¦–å¸§"||c(I)==="å°¾å¸§")&&R==="useFirstImage"&&T.length>=2&&(T=[T[0]]),c(I)==="é¦–å°¾å¸§"&&R==="useFirstTwoImages"&&T.length>=3&&(T=T.slice(0,2));const et={modelId:Z,ratio:A,duration:$,referenceImages:T.length>0&&!P?T:void 0,generationType:ye,sourceNodeId:n,...P?{subjects:P}:{}},st=c(ye);let kt=de.trim();if(kt&&kt.includes("@#")&&(kt=await vs(kt)),!oe&&kt&&(kt="No BGM. "+kt),st==="æ–‡ç”Ÿè§†é¢‘"){if(!kt){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),U(0);return}et.prompt=kt}else if(st==="å‚è€ƒå›¾"){if(!kt){h.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),U(0);return}et.prompt=kt}else kt&&(et.prompt=kt);const ft=await Ce.tasks.createVideoTask(et),We=ft.taskId,Dt=ft.creditsCharged||0,Xt=ft.isFreeUsage,Lt=ft.freeUsageRemaining??0;if(Q(We),Ze({prompt:de,ratio:A,resolution:G,generationType:I,duration:$,modelId:Z,taskId:We,isGenerating:!0}),Xt)h.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Lt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),H();else if(Dt>0){const{useAuthStore:zt}=await xs(async()=>{const{useAuthStore:Ut}=await import("./index-B-U_h0BA.js").then(Vt=>Vt.f);return{useAuthStore:Ut}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:At}=zt.getState();await At(),h.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Dt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),H()}else h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Hs(We)}catch(T){if(r(!1),U(0),((Ve=T.response)==null?void 0:Ve.status)===403){const P=((Le=(qe=T.response)==null?void 0:qe.data)==null?void 0:Le.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";h.error(P)}else{const P=((it=(tt=T.response)==null?void 0:tt.data)==null?void 0:it.error)||T.message||"æœªçŸ¥åŸå› ";h.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${P}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const J=c(I),te=Ct(),De=te.length;if((()=>{var Le;const qe=se.filter(tt=>tt.target===n);for(const tt of qe){const it=ce(tt.source);if((it==null?void 0:it.type)==="assetSelector"){const T=(Le=it.data.config)==null?void 0:Le.subjects;if(T&&T.length>0)return!0}}return!1})()&&(J==="é¦–å¸§"||J==="å°¾å¸§"||J==="é¦–å°¾å¸§")){h.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((J==="é¦–å¸§"||J==="å°¾å¸§")&&De===0){h.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(J==="é¦–å°¾å¸§"&&De===0){h.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(J==="å‚è€ƒå›¾"&&De===0){h.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(J==="æ–‡ç”Ÿè§†é¢‘"&&De>0&&!pe&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((J==="é¦–å¸§"||J==="å°¾å¸§")&&De>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(J==="é¦–å°¾å¸§"&&De>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(J==="æ–‡ç”Ÿè§†é¢‘"&&!de.trim()){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!Z){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}g(te),Ze({referenceImages:te}),r(!0),U(0),await Xs()},Tt=(J,te)=>{const De=ce(n);if(!De||!J)return null;const Ve=te||A||"16:9",qe=Ue(),Le=he(),tt=qe.filter(Vt=>Vt.type==="videoPreview"&&Le.some(Ft=>Ft.source===n&&Ft.target===Vt.id)),it=tt.find(Vt=>Vt.data.videoUrl===J);if(it)return it.id;const T=1,P=400,be=(Vt,Ft=300)=>{if(!Vt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Vt))return Ft;const[ts,rs]=Vt.split(":").map(ys=>parseFloat(ys));return!ts||!rs?Ft:Math.round(P*(rs/ts))},Te=document.querySelector(`.react-flow__node[data-id="${n}"]`),je=Te==null?void 0:Te.getBoundingClientRect(),ye=Math.round(((je==null?void 0:je.width)||400)/T),et=100,st=200,kt=be(Ve,300),ft=tt.length,We=De.position.x+ye+st,Dt=De.position.y,Xt=We,Lt=Dt+ft*(kt+et),zt=Date.now(),At={id:`preview-${n}-${zt}`,type:"videoPreview",position:{x:Xt,y:Lt},data:{videoUrl:J,width:P,ratio:Ve,workflowContext:De.data.workflowContext,createdBy:De.data.createdBy}};re(Vt=>[...Vt,At]);const Ut={id:`edge-${n}-${At.id}`,source:n,target:At.id,targetHandle:`${At.id}-target`,type:"aurora"};return K(Vt=>Vt.find(ts=>ts.source===n&&ts.target===At.id)?Vt:[...Vt,Ut]),At.id},Js=J=>{const te=J.target;if(te.tagName==="INPUT"||te.tagName==="TEXTAREA"||te.tagName==="SELECT"||te.tagName==="BUTTON"||te.closest("button")||te.closest("input")||te.closest("textarea")||te.closest("select"))return;const De=!F;we(De),re(Ve=>Ve.map(qe=>qe.id===n?{...qe,data:{...qe.data,isExpanded:De}}:qe))};return e.jsxs("div",{onDoubleClick:Js,className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var P;const J=((P=ce(n))==null?void 0:P.type)||"",te=c(I),De=te==="æ–‡ç”Ÿè§†é¢‘"||J==="aiVideo_t2v",Ve=J==="aiVideo_i2v_first"||J==="aiVideo_i2v_last"||te==="é¦–å¸§"||te==="å°¾å¸§",qe=J==="aiVideo_first_last"||te==="é¦–å°¾å¸§",Le=J==="aiVideo_reference"||te==="å‚è€ƒå›¾",tt=se.filter(be=>be.target===n),it=tt.some(be=>{const Te=ce(be.source);return(Te==null?void 0:Te.type)==="agent"}),T=tt.reduce((be,Te)=>{var et,st,kt,ft;const je=ce(Te.source),ye=(je==null?void 0:je.type)||"";if(ye==="aiImage"||ye==="imagePreview")return be+1;if(ye==="upload"){const We=(kt=(st=(et=je==null?void 0:je.data)==null?void 0:et.config)==null?void 0:st.uploadedFiles)==null?void 0:kt[0],Dt=((We==null?void 0:We.type)||"").toUpperCase(),Xt=((We==null?void 0:We.mimeType)||"").toLowerCase();return be+(Dt==="IMAGE"||Xt.startsWith("image/")?1:0)}if(ye==="assetSelector"){const We=((ft=je==null?void 0:je.data)==null?void 0:ft.config)||{};if(We.selectedAsset)return be+((We.selectedAsset.type||"").toUpperCase()==="IMAGE"||(We.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(We.subjects&&We.subjects.length>0)return be+((We.subjects[0].images||[]).length||0)}return be},0);return De?pe||!it:Ve?!(it&&T>=1):qe?!(it&&T>=2):Le?!(it&&T>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:f}),w==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{m(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{m(!1),h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{m(!1),await Xs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[!pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:Z,onChange:J=>Bs(J),options:vt.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:vt.map(J=>({value:J.id,label:J.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-purple-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ee,value:de,onChange:ks,onKeyDown:Ss,onCompositionStart:()=>{xe.current=!0},onCompositionEnd:J=>{xe.current=!1,ks(J)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),W&&p.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:p.map((J,te)=>e.jsxs("button",{type:"button",onMouseDown:De=>{De.preventDefault(),De.stopPropagation(),Is(J)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${te===V?"bg-purple-100 dark:bg-purple-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[J.avatarUrl?e.jsx("img",{src:J.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-200 dark:bg-purple-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-purple-600 dark:text-purple-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:J.customName}),e.jsx("div",{className:"text-[10px] text-purple-500 dark:text-purple-400 font-mono truncate",children:J.characterName})]})]},J.id))})]})]}),v.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",I==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:v.map((J,te)=>e.jsxs("div",{draggable:I==="é¦–å°¾å¸§",onDragStart:()=>yt(te),onDragOver:Be,onDrop:()=>wt(te),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${I==="é¦–å°¾å¸§"?"cursor-move":""} ${a===te?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50`,children:[e.jsx("img",{src:`${J.url.startsWith("http")||J.url.startsWith("data:")?J.url:wr+J.url}`,alt:J.name,className:"w-full h-full object-cover"}),I==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:te===0?"é¦–":te===1?"å°¾":te+1})]},J.id))})]}),u&&!pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",le?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[$,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:Re,max:Ae,step:"1",value:$,onChange:J=>{const te=parseInt(J.target.value,10);j(te),Ze({duration:te})},disabled:le,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-purple-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #a855f7 ${$e}%, #3b0764 ${$e}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),u&&dt&&(pe||(((Ps=u==null?void 0:u.config.supportedRatios)==null?void 0:Ps.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),pe?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const J="landscape",te=$===15?15:10,De=`sora-video-${J}-${te}s`,Ve=ge.find(Le=>{var tt;return((tt=Le.modelId)==null?void 0:tt.toLowerCase())===De})||ge[0],qe=(Ve==null?void 0:Ve.id)||"";z(qe),S("16:9"),Ze({modelId:qe,ratio:"16:9",modelName:(Ve==null?void 0:Ve.name)||`Sora Video (Landscape ${te}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${A==="16:9"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const J="portrait",te=$===15?15:10,De=`sora-video-${J}-${te}s`,Ve=ge.find(Le=>{var tt;return((tt=Le.modelId)==null?void 0:tt.toLowerCase())===De})||ge[0],qe=(Ve==null?void 0:Ve.id)||"";z(qe),S("9:16"),Ze({modelId:qe,ratio:"9:16",modelName:(Ve==null?void 0:Ve.name)||`Sora Video (Portrait ${te}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${A==="9:16"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:A,onChange:J=>{S(J),Ze({ratio:J})},options:((u==null?void 0:u.config.supportedRatios)||[]).map(J=>{const[te,De]=J.split(":");return{value:J,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[J]||`${te}:${De}`}})})]}),u&&pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const J=A==="9:16"?"portrait":"landscape",te=`sora-video-${J}-10s`,De=ge.find(qe=>{var Le;return((Le=qe.modelId)==null?void 0:Le.toLowerCase())===te})||ge[0],Ve=(De==null?void 0:De.id)||"";j(10),z(Ve),Ze({duration:10,modelId:Ve,modelName:(De==null?void 0:De.name)||`Sora Video (${J==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${$===10?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const J=A==="9:16"?"portrait":"landscape",te=`sora-video-${J}-15s`,De=ge.find(qe=>{var Le;return((Le=qe.modelId)==null?void 0:Le.toLowerCase())===te})||ge[0],Ve=(De==null?void 0:De.id)||"";j(15),z(Ve),Ze({duration:15,modelId:Ve,modelName:(De==null?void 0:De.name)||`Sora Video (${J==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${$===15?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),u&&pe&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>k(!oe),className:`nodrag relative w-10 h-5 rounded-full transition-all ${oe?"bg-gradient-to-r from-purple-500 to-pink-500":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${oe?"left-5":"left-0.5"}`})})]}),u&&!pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ge?"(æœªé…ç½®)":""]}),e.jsx(os,{value:G,onChange:J=>{x(J),Ze({resolution:J})},options:Ne.map(J=>({value:J,label:J})),className:Ge?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:O||!gs||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${O||!gs?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:O?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!b&&(Y?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",ue,"æ¬¡"]}):E!==null&&E>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[E,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:de?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-purple-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-purple-300 line-clamp-6 whitespace-pre-wrap break-words",children:de})]}):e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Co=t.memo(Eo),Vr="https://api.waule.com",Ao=({data:s,selected:N,id:n})=>{var j,O;const[F,we]=t.useState(!0),[U,fe]=t.useState(s.config.customName||""),[Q,re]=t.useState(!1),[K,ce]=t.useState(0),[Ue,he]=t.useState(s.config.taskId||""),[se,ae]=t.useState(null),{credits:Ie,loading:ne}=Us({nodeType:"sora_character"}),{setNodes:ge,getNode:de,setEdges:me}=Zt(),Ee=zs(),Z=Ds(),z=t.useCallback(r=>{var a;if(!r)return!1;const v=r.type||"",g=((a=r.data)==null?void 0:a.config)||{};if(v==="upload")return(g.uploadedFiles||g.files||[]).some(d=>(d.mimeType||d.type||"").toLowerCase().startsWith("video/"));if(v==="videoPreview")return!!g.url;if(v==="assetSelector"){const y=g.selectedAsset;return((y==null?void 0:y.mimeType)||"").toLowerCase().startsWith("video/")&&!!(y!=null&&y.url)}return v.startsWith("aiVideo")||v==="soraVideo"?!!g.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=Ee.filter(a=>a.target===n);if(r.length===0)return;const v=[],g=[];for(const a of r){const y=Z.find(d=>d.id===a.source)||de(a.source);z(y)?v.push(a.id):g.push(a.id)}v.length>1&&(g.push(...v.slice(1)),h.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),g.length>0&&(me(a=>a.filter(y=>!g.includes(y.id))),g.length>0&&v.length<=1&&r.some(y=>{const d=Z.find(m=>m.id===y.source)||de(y.source);return!z(d)})&&h.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ee,n,Z,de,me,z]);const A=t.useMemo(()=>Ee.filter(v=>v.target===n).map(v=>{var a;const g=Z.find(y=>y.id===v.source);return(a=g==null?void 0:g.data)==null?void 0:a.config}),[Ee,n,Z]),S=t.useMemo(()=>(s.models||[]).filter(v=>{var g;return v.type==="VIDEO_GENERATION"&&((g=v.provider)==null?void 0:g.toLowerCase())==="sora"}),[s.models]),G=((j=S.find(r=>{var v;return(v=r.modelId)==null?void 0:v.includes("landscape-10s")}))==null?void 0:j.id)||((O=S[0])==null?void 0:O.id)||"",x=t.useCallback(r=>{ge(v=>v.map(g=>g.id===n?{...g,data:{...g.data,config:{...g.data.config,...r}}}:g))},[n,ge]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!Q&&(ae({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),fe(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,Q]);const c=t.useMemo(()=>{var v;const r=Ee.filter(g=>g.target===n);for(const g of r){const a=Z.find(m=>m.id===g.source)||de(g.source);if(!a)continue;const y=a.type||"",d=((v=a.data)==null?void 0:v.config)||{};if(y==="upload"){const f=(d.uploadedFiles||d.files||[]).find(w=>(w.mimeType||w.type||"").toLowerCase().startsWith("video/"));if(f!=null&&f.url)return{url:f.url,thumbnail:f.thumbnail||f.url,name:f.name||f.originalName||"è§†é¢‘"}}if(y==="videoPreview"&&d.url)return{url:d.url,thumbnail:d.thumbnail||d.url,name:d.name||"è§†é¢‘"};if(y==="assetSelector"){const m=d.selectedAsset;if(((m==null?void 0:m.mimeType)||"").toLowerCase().startsWith("video/")&&(m!=null&&m.url))return{url:m.url,thumbnail:m.thumbnail||m.url,name:m.name||"è§†é¢‘"}}if((y.startsWith("aiVideo")||y==="soraVideo")&&d.generatedVideoUrl)return{url:d.generatedVideoUrl,thumbnail:d.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ee,n,Z,A,de]),I=!!c,L=async r=>{let g=0;const a=async()=>{try{g++;const d=(await Ce.tasks.getTaskStatus(r)).task;if(ce(d.progress||0),d.status==="SUCCESS"||d.status==="COMPLETED"||d.status==="DONE"){re(!1),ce(100);const m=d.metadata||{},f=m.characterName||"",w=m.avatarUrl||d.resultUrl||"";if(!f){h.error("æœªèƒ½è·å–è§’è‰²åç§°"),x({taskId:""}),he("");return}try{const W=(await Ce.soraCharacters.create({customName:U||f,characterName:f,avatarUrl:w,sourceVideoUrl:(c==null?void 0:c.url)||void 0})).character;ae({id:W.id,customName:W.customName,characterName:W.characterName,avatarUrl:W.avatarUrl}),x({customName:W.customName,characterName:W.characterName,avatarUrl:W.avatarUrl,taskId:""}),h.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${W.customName}`)}catch(R){ae({id:"",customName:U||f,characterName:f,avatarUrl:w}),h.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${R.message}`)}he(""),setTimeout(()=>ce(0),1e3);return}else if(d.status==="FAILURE"){re(!1),ce(0),x({taskId:""}),h.error(d.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(d.status==="PROCESSING"||d.status==="PENDING")&&(g<600?setTimeout(a,1e3):(re(!1),ce(0),x({taskId:""}),h.error("åˆ›å»ºè¶…æ—¶")))}catch{re(!1),ce(0),x({taskId:""}),h.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};a()},$=async()=>{var v,g,a,y,d;if(!c){h.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!U.trim()){h.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!G){h.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=c.url;if(!r){h.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const m=await Ce.soraCharacters.getByCustomName(U.trim());if(m!=null&&m.character){h.error(`è‡ªå®šä¹‰åç§°"${U.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}re(!0),ce(5),ae(null);try{const m=await Ce.tasks.createVideoTask({modelId:G,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:n,metadata:{isCharacterCreation:!0,customName:U.trim(),referenceType:"video",nodeType:"sora_character"}}),f=m.taskId,w=m.creditsCharged||0;if(he(f),x({customName:U.trim(),taskId:f}),w>0)try{const{useAuthStore:R}=await xs(async()=>{const{useAuthStore:_}=await import("./index-B-U_h0BA.js").then(p=>p.f);return{useAuthStore:_}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:W}=R.getState();await W(),h.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${w} ç§¯åˆ†ï¼‰`)}catch{h.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else h.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");L(f)}catch(m){if(re(!1),ce(0),((v=m.response)==null?void 0:v.status)===403){const f=((a=(g=m.response)==null?void 0:g.data)==null?void 0:a.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";h.error(f)}else h.error(`æäº¤å¤±è´¥: ${((d=(y=m.response)==null?void 0:y.data)==null?void 0:d.error)||m.message}`)}};return t.useEffect(()=>{Ue&&!Q&&(re(!0),L(Ue))},[]),e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl border-b border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",onClick:()=>we(!F),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${F?"rotate-180":""}`,children:"expand_more"})]})]}),F&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${I?"bg-green-500":"bg-slate-300 dark:bg-white/20"}`}),e.jsx("span",{className:I?"text-green-600 dark:text-green-400":"text-slate-400 dark:text-white/50",children:I?"å·²è¿æ¥è§†é¢‘":"è¯·è¿æ¥è§†é¢‘è¾“å…¥"})]}),c&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${c.url.startsWith("http")||c.url.startsWith("data:")?c.url:Vr+c.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:c.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:U,onChange:r=>fe(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors",disabled:Q})]}),se&&!Q&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[se.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-purple-400 dark:border-purple-400/50 flex-shrink-0",children:e.jsx("img",{src:se.avatarUrl.startsWith("http")?se.avatarUrl:`${Vr}${se.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-purple-400 dark:border-purple-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:se.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:se.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),Q&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[K,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300",style:{width:`${K}%`}})})]}),e.jsx("button",{onClick:$,disabled:Q||!I||!U.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${Q||!I||!U.trim()||s._canEdit===!1?"bg-slate-300 dark:bg-white/10 text-slate-500 dark:text-white/30 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ne&&Ie!==null&&Ie>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[Ie,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},_o=t.memo(Ao),To=({data:s,id:N,selected:n})=>{const{setNodes:F,getNode:we}=Zt(),[U,fe]=t.useState(s.config.modelId||""),[Q,re]=t.useState(s.config.voiceId||""),[K,ce]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Ue,he]=t.useState(s.config.status||""),[se,ae]=t.useState(!1),[Ie,ne]=t.useState([]),[ge]=t.useState(void 0),[de]=t.useState("mp3"),[me]=t.useState(void 0),[Ee]=t.useState(void 0),[Z]=t.useState(void 0),[z]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!U&&fe(s.config.modelId)},[s.config.modelId,U]),t.useEffect(()=>{!Q&&s.config.voiceId&&re(String(s.config.voiceId))},[s.config.voiceId,Q]),t.useEffect(()=>{if(!U){const c=(s.models||[]).filter(I=>I.type==="AUDIO_SYNTHESIS"&&I.isActive)[0];c&&(fe(c.id),S({modelId:c.id}))}},[s.models,U]),t.useEffect(()=>{A()},[]);const A=async()=>{try{const x=await Ce.get("/ai/audio/voices"),c=(x==null?void 0:x.data)??x;ne(Array.isArray(c)?c:[])}catch{}},S=x=>{we(N)&&F(I=>I.map(L=>L.id===N?{...L,data:{...L.data,config:{...L.data.config,...x}}}:L))},G=async()=>{var L,$,j,O;const x=(Q||s.config.voiceId||"").trim(),c=(K||"").trim();if(!x||!c){h.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let I=U;if(!I){const r=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive);if(r[0])I=r[0].id,fe(I),S({modelId:I});else{h.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}ae(!0);try{if(Ue!=="OK"){let a=0,y=!1;for(;a<12;){a++;try{const d=await Ce.ai.audio.queryVoice({voiceId:x,modelId:I}),m=((L=d.data)==null?void 0:L.status)||d.status;if(he(m),S({status:m}),m==="OK"){y=!0;break}if(m==="UNDEPLOYED")break}catch{}await new Promise(d=>setTimeout(d,2500))}if(!y){h.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),ae(!1);return}}const r=await Ce.ai.audio.synthesize({modelId:I,voiceId:x,text:c,format:de,sampleRate:ge,volume:Ee,rate:me,pitch:Z,output_format:z}),v=(($=r.data)==null?void 0:$.url)||r.url;try{const g=v&&v.startsWith("http")?v:`https://api.waule.com${v}`;let a;g?a=await Ce.assets.proxyDownload(g):a=await(await fetch(v,{mode:"cors"})).arrayBuffer();const y=URL.createObjectURL(new Blob([a],{type:de==="wav"?"audio/wav":"audio/mpeg"}));S({outputUrl:y})}catch{S({outputUrl:v})}h.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const v=((O=(j=r==null?void 0:r.response)==null?void 0:j.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(v)?h.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(v)?h.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):h.error(v)}ae(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:U,onChange:x=>{fe(x),S({modelId:x})},options:(s.models||[]).filter(x=>x.type==="AUDIO_SYNTHESIS"&&x.isActive).map(x=>({value:x.id,label:x.name}))})]}),Ie.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",Ie.length,")"]}),e.jsx(os,{value:Q||"",onChange:x=>{re(x),S({voiceId:x})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ie.map(x=>({value:x.voiceId,label:x.prefix||x.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:Q,onChange:x=>{const c=x.target.value;re(c),S({voiceId:c})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:K,onChange:x=>{ce(x.target.value),S({text:x.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:G,disabled:se||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${se?"bg-gray-600 dark:bg-gray-700 text-white":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:se?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Uo=t.memo(To),Ro=({data:s,id:N,selected:n})=>{const{setNodes:F,setEdges:we,getNode:U}=Zt(),[fe,Q]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.voiceId||""),[ce,Ue]=t.useState(s.config.voiceName||""),[he,se]=t.useState(s.config.cloneAudioUrl||""),[ae,Ie]=t.useState(s.config.promptAudioUrl||""),[ne,ge]=t.useState(s.config.promptText||""),[de,me]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ee,Z]=t.useState(!1);t.useEffect(()=>{const I=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!re||!re.startsWith("Waule")&&!re.startsWith("Aivider")||re.startsWith("minimax-")){const L=I();K(L),G({voiceId:L})}},[re]);const z=Fs(I=>I.edges.filter(L=>L.target===N)),A=Ds(),S=t.useRef("");t.useEffect(()=>{if(!fe){const L=(s.models||[]).filter($=>{if($.type!=="AUDIO_SYNTHESIS"||!$.isActive)return!1;const j=String($.provider||"").toLowerCase();return j.includes("minimaxi")||j.includes("hailuo")||j.includes("æµ·èº")})[0];L&&(Q(L.id),G({modelId:L.id}))}},[s.models,fe]),t.useEffect(()=>{try{const I=z.map(j=>`${j.id}-${j.source}-${j.targetHandle||""}`).sort().join(",");if(I===S.current)return;S.current=I;let L="",$="";for(const j of z){const O=U(j.source);if(!O)continue;const r=O.data||{},v=String(O.type||"").toLowerCase(),a=(()=>{var y,d;if(v==="upload"){const m=(((y=r.config)==null?void 0:y.uploadedFiles)||[]).find(f=>{const w=((f==null?void 0:f.type)||"").toUpperCase(),R=((f==null?void 0:f.mimeType)||"").toLowerCase();return w==="AUDIO"||R.startsWith("audio/")});return m==null?void 0:m.url}if(v==="assetSelector"){const m=(d=r.config)==null?void 0:d.selectedAsset,f=((m==null?void 0:m.type)||"").toUpperCase(),w=((m==null?void 0:m.mimeType)||"").toLowerCase();if(f==="AUDIO"||w.startsWith("audio/"))return m==null?void 0:m.url}return null})();a&&(j.targetHandle===`${N}-target-clone`&&(L=a),j.targetHandle===`${N}-target-prompt`&&($=a))}L!==he&&(se(L),G({cloneAudioUrl:L})),$!==ae&&(Ie($),G({promptAudioUrl:$}))}catch{}},[z,A,U,N,he,ae]);const G=I=>{F(L=>L.map($=>$.id===N?{...$,data:{...$.data,config:{...$.data.config,...I}}}:$))},x=async()=>{var I,L;if(!re||!ce){h.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await Ce.ai.audio.voices.add({voiceId:re,prefix:ce}),h.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch($){const j=((L=(I=$==null?void 0:$.response)==null?void 0:I.data)==null?void 0:L.message)||($==null?void 0:$.message)||"ä¿å­˜å¤±è´¥";h.error(j)}},c=async()=>{var I,L,$;if(!fe||!ce||!he){h.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}Z(!0),h.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const O=(s.models||[]).find(m=>m.id===fe),r=(O==null?void 0:O.modelId)||"speech-2.6-hd";let v=he;v.startsWith("http");const g=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;K(g),G({voiceId:g});const a=await Ce.ai.audio.createVoice({modelId:fe,targetModel:r,prefix:ce,url:v,promptUrl:ae||void 0,promptText:ne||void 0,voiceId:g,previewText:de||void 0}),y=(a==null?void 0:a.data)||a,d=y==null?void 0:y.sampleUrl;if(d){G({sampleUrl:d,status:"OK",voiceName:ce}),h.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const m=U(N);if(m){const f=`audioPreview-${Date.now()}`,w={id:f,type:"audioPreview",position:{x:m.position.x+450,y:m.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:d,config:{audioUrl:d,title:`${ce} - è¯•å¬`},models:s.models,createdBy:(I=m.data)==null?void 0:I.createdBy}};F(W=>[...W,w]);const R={id:`e-${N}-source-${f}-target`,source:N,sourceHandle:`${N}-source`,target:f,targetHandle:`${f}-target`,type:"aurora"};we(W=>[...W,R])}}else G({status:"OK",voiceName:ce}),h.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(j){const O=(($=(L=j==null?void 0:j.response)==null?void 0:L.data)==null?void 0:$.message)||(j==null?void 0:j.message)||"åˆ›å»ºå¤±è´¥";h.error(O)}Z(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:I=>{Q(I),G({modelId:I})},options:(s.models||[]).filter(I=>{if(I.type!=="AUDIO_SYNTHESIS"||!I.isActive)return!1;if(Array.isArray(I.capabilities))return I.capabilities.some($=>$.capability==="éŸ³è‰²å…‹éš†"&&$.supported);const L=String(I.provider||"").toLowerCase();return L.includes("minimaxi")||L.includes("hailuo")||L.includes("æµ·èº")}).map(I=>({value:I.id,label:I.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:ce,onChange:I=>{Ue(I.target.value),G({voiceName:I.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:I=>I.stopPropagation()}),e.jsx("button",{onClick:x,disabled:!re||!ce,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!re||!ce?"bg-gray-600 dark:bg-gray-700 text-white opacity-50":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:he?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:he?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:ae?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:ae?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ne,onChange:I=>{ge(I.target.value),G({promptText:I.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:I=>I.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:de,onChange:I=>{me(I.target.value),G({previewText:I.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:I=>I.stopPropagation()})]}),e.jsx("button",{onClick:c,disabled:Ee||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ee||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ee?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},$o=t.memo(Ro),Wr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Mo=({data:s,id:N,selected:n})=>{const{setNodes:F,getNode:we,setEdges:U}=Zt(),[fe,Q]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.voiceId||""),[ce,Ue]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),he=t.useRef(null),[se,ae]=t.useState("zh"),Ie=t.useRef(null),ne=t.useRef(null),ge=t.useRef(null),de=t.useRef(null),me=t.useRef(null),[Ee,Z]=t.useState([]),z=async()=>{try{const g=await Ce.ai.audio.voices.list(),a=(g==null?void 0:g.data)??g;Z(Array.isArray(a)?a:[])}catch{}},A=async()=>{try{const g=window.AudioContext||window.webkitAudioContext;de.current||(de.current=new g);const a=de.current;a.state==="suspended"&&await a.resume()}catch{}},[S,G]=t.useState(!1),[x]=t.useState(""),[c]=t.useState(void 0),[I]=t.useState("mp3"),[L]=t.useState(void 0),[$]=t.useState(void 0),[j]=t.useState(void 0),[O]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!fe&&Q(s.config.modelId)},[s.config.modelId,fe]),t.useEffect(()=>{!re&&s.config.voiceId&&K(String(s.config.voiceId))},[s.config.voiceId,re]),t.useEffect(()=>{if(!fe){const a=(s.models||[]).filter(y=>y.type==="AUDIO_SYNTHESIS"&&y.isActive)[0];a&&(Q(a.id),r({modelId:a.id}))}},[s.models,fe]),t.useEffect(()=>{z()},[]),t.useEffect(()=>{se==="custom"&&z()},[se]),t.useEffect(()=>{const g=he.current;g&&(g.style.height="auto",g.style.height=`${g.scrollHeight}px`)},[ce]);const r=g=>{we(N)&&F(y=>y.map(d=>d.id===N?{...d,data:{...d.data,config:{...d.data.config,...g}}}:d))},v=async(g=!1)=>{var m,f,w,R,W;let a=(re||s.config.voiceId||"").trim();if(g&&!a)if(se==="custom"){const _=Ee[0];_&&(a=String(_.voiceId),K(a),r({voiceId:a}))}else{const _=Wr.find(p=>{const l=p.label;return se==="zh"?l.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):se==="yue"?l.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):se==="en"?l.startsWith("è‹±æ–‡ "):se==="ja"?l.startsWith("æ—¥æ–‡ "):se==="ko"?l.startsWith("éŸ©æ–‡ "):!0});_&&(a=_.id,K(a),r({voiceId:a}))}const y=g?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(ce||"").trim();if(!a||!y){h.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let d=fe;if(!d){const _=(s.models||[]).filter(p=>p.type==="AUDIO_SYNTHESIS"&&p.isActive);if(_[0])d=_[0].id,Q(d),r({modelId:d});else{h.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}G(!0);try{g&&await A();const _={};if(x)try{_.voice_modify={emotion:x}}catch{}const p=await Ce.ai.audio.synthesize({modelId:d,voiceId:a,text:y,format:I,sampleRate:c,volume:$,rate:L,pitch:j,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},..._}),l=((m=p==null?void 0:p.data)==null?void 0:m.url)||(p==null?void 0:p.url),i=window.location.origin,M=(b=>{if(!b)return"";try{if(b.startsWith("http://localhost:3000")||b.startsWith("http://127.0.0.1:3000")){const Y=new URL(b).pathname;return`${i}${Y}`}return b.startsWith("http")?b:b.startsWith("/")?`${i}${b}`:`${i}/${b}`}catch{return b}})(l);let X;const V=b=>{if(b.length>=12){if(b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69)return"audio/wav";if(b[0]===73&&b[1]===68&&b[2]===51||b[0]===255&&(b[1]&224)===224)return"audio/mpeg"}return I==="wav"?"audio/wav":"audio/mpeg"},ie=b=>b.length>=12&&b[4]===102&&b[5]===116&&b[6]===121&&b[7]===112,xe=b=>b.length>=4&&b[0]===79&&b[1]===103&&b[2]===103&&b[3]===83,oe=b=>b.length>=4&&b[0]===102&&b[1]===76&&b[2]===97&&b[3]===67,k=new Uint8Array(X||new ArrayBuffer(0));let u=V(k);(!u||u==="application/octet-stream")&&(ie(k)?u="audio/mp4":xe(k)?u="audio/ogg":oe(k)&&(u="audio/flac"));let E;if(g){if(me.current){try{me.current.stop()}catch{}me.current.disconnect(),me.current=null}const b=ne.current||new Audio;b.preload="auto",b.autoplay=!0,b.playsInline=!0,b.crossOrigin="anonymous",ne.current=b;let Y=!1;const ue=(H,pe,Se=1500)=>new Promise(Ne=>{let Re=!1;const Ae=()=>{Re||(Re=!0,$e(),Ne(!0))},_e=()=>{Re||(Re=!0,$e(),Ne(!1))},$e=()=>{H.removeEventListener(pe,Ae),H.removeEventListener("error",_e)};H.addEventListener(pe,Ae),H.addEventListener("error",_e),setTimeout(()=>{_e()},Se)});try{const H=Ne=>{const Re=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor(Re.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt(Re.substr(_e*2,2),16);return Ae},pe=((f=p==null?void 0:p.data)==null?void 0:f.hex)||(p==null?void 0:p.hex),Se=pe?H(String(pe)).buffer:void 0;if(Se&&Se.byteLength>0){const Ne=new Uint8Array(Se),Re=V(Ne),Ae=new Blob([Se],{type:Re}),_e=URL.createObjectURL(Ae);if(ge.current)try{URL.revokeObjectURL(ge.current)}catch{}if(ge.current=_e,b.src=_e,b.load(),!await ue(b,"canplay"))throw new Error("blob not ready");await b.play(),Y=!0}else throw new Error("no hex")}catch{Y=!1}if(!Y){try{const H=Ne=>{const Re=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor(Re.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt(Re.substr(_e*2,2),16);return Ae},pe=((w=p==null?void 0:p.data)==null?void 0:w.hex)||(p==null?void 0:p.hex),Se=pe?H(String(pe)).buffer:void 0;if(!Se||Se.byteLength===0){const Ne=await Ce.assets.proxyDownload(M);if(!Ne||Ne.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const Re=new Uint8Array(Ne),Ae=V(Re),_e=new Blob([Ne],{type:Ae}),$e=URL.createObjectURL(_e);if(ge.current)try{URL.revokeObjectURL(ge.current)}catch{}if(ge.current=$e,b.src=$e,b.load(),!await ue(b,"canplay"))throw new Error("blob not ready");await b.play(),Y=!0}else{const Ne=new Uint8Array(Se),Re=V(Ne),Ae=new Blob([Se],{type:Re}),_e=URL.createObjectURL(Ae);if(ge.current)try{URL.revokeObjectURL(ge.current)}catch{}if(ge.current=_e,b.src=_e,b.load(),!await ue(b,"canplay"))throw new Error("blob not ready");await b.play(),Y=!0}}catch{}if(!Y)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const b=await Ce.assets.proxyDownload(M),Y=new Uint8Array(b),ue=V(Y);E=URL.createObjectURL(new Blob([b],{type:ue}))}catch{}if(!g&&E){if(Ie.current)try{URL.revokeObjectURL(Ie.current)}catch{}Ie.current=E;const b=M||E;r({outputUrl:b});try{const Y=we(N);if(Y){const H=document.querySelector(`.react-flow__node[data-id="${Y.id}"]`),pe=Math.round((H==null?void 0:H.getBoundingClientRect().width)||420),Se=Y.position.x+pe+160,Ne=`audio-preview-${Date.now()}`;F(Re=>{var le;const Ae=Re.filter(Ge=>{var Ze;return Ge.type==="audioPreview"&&((Ze=Ge.data)==null?void 0:Ze.sourceNodeId)===N}),_e=Y.position.y,$e=Ae.length>0?Math.max(...Ae.map(Ge=>{var Ze;return((Ze=Ge.position)==null?void 0:Ze.y)||_e}))+120:_e;return[...Re,{id:Ne,type:"audioPreview",position:{x:Se,y:$e},data:{audioUrl:b,sourceNodeId:N,createdBy:(le=Y.data)==null?void 0:le.createdBy}}]}),U(Re=>[...Re,{id:`${N}-${Ne}`,source:N,target:Ne}])}}catch{}}g&&ne.current&&!ne.current.paused?h.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!g&&E&&h.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(_){const p=((W=(R=_==null?void 0:_.response)==null?void 0:R.data)==null?void 0:W.message)||(_==null?void 0:_.message)||(g?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");h.error(p)}G(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:g=>{Q(g),r({modelId:g})},options:(s.models||[]).filter(g=>g.type==="AUDIO_SYNTHESIS"&&g.isActive).map(g=>({value:g.id,label:g.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(os,{value:se,onChange:g=>{ae(g),g==="custom"&&z()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(os,{value:re,onChange:g=>{K(g),r({voiceId:g})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...se==="custom"?Ee.map(g=>({value:g.voiceId,label:g.prefix||g.voiceId})):Wr.filter(g=>{const a=g.label;return se==="zh"?a.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):se==="yue"?a.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):se==="en"?a.startsWith("è‹±æ–‡ "):se==="ja"?a.startsWith("æ—¥æ–‡ "):se==="ko"?a.startsWith("éŸ©æ–‡ "):!0}).map(g=>({value:g.id,label:g.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>v(!0),disabled:S,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${S?"bg-gray-600 dark:bg-gray-700":""}`,style:S?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #a855f7, #ec4899)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:he,value:ce,onChange:g=>{Ue(g.target.value),r({text:g.target.value})},onMouseDown:g=>g.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>v(!1),disabled:S||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${S||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700":"border-transparent dark:border-white/10"}`,style:S||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #a855f7, #ec4899)"},children:S?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ne,className:"hidden"}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Do=t.memo(Mo),Po=t.memo(({id:s,sourceX:N,sourceY:n,targetX:F,targetY:we,sourcePosition:U,targetPosition:fe,selected:Q,markerEnd:re})=>{const[K]=ka({sourceX:N,sourceY:n,targetX:F,targetY:we,sourcePosition:U,targetPosition:fe});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ec4899",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#a855f7",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:K,fill:"none",stroke:Q?"#a855f7":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:re}),e.jsx("path",{d:K,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:re}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:K,calcMode:"linear"})}),e.jsx("path",{d:K,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Lo=({data:s,id:N})=>{const n=t.useRef(null),{getNode:F,setNodes:we}=Zt(),[U,fe]=t.useState(!1),[Q,re]=t.useState([]),[K,ce]=t.useState(""),[Ue,he]=t.useState("ALL"),[se,ae]=t.useState(""),[Ie,ne]=t.useState(!1),ge=t.useMemo(()=>window.location.origin,[]),de=t.useMemo(()=>{var S;const A=s.audioUrl||"";if(A.startsWith("blob:")){const G=s.sourceNodeId?F(s.sourceNodeId):null,x=((S=G==null?void 0:G.data)==null?void 0:S.outputUrl)||"";return x.startsWith("http")?x:x.startsWith("/")?`${ge}${x}`:A}return A.startsWith("http")?`${ge}/api/assets/proxy-stream?url=${encodeURIComponent(A)}`:A.startsWith("/")?`${ge}${A}`:A},[s.audioUrl,s.sourceNodeId,ge]);t.useEffect(()=>{const A=n.current;A&&(A.preload="auto",A.playsInline=!0,A.crossOrigin="anonymous",A.load())},[de]),t.useEffect(()=>{U&&(me(),setTimeout(()=>{Ee()},100))},[U]);const me=async()=>{try{const A=Ue==="ALL"?void 0:{category:Ue},G=(await Ce.assetLibraries.getAll(A)).data||[];re(G);const x=Ue==="ALL"?G:G.filter(c=>(c.category||"OTHER")===Ue);if(x.length>0){const c=x.find(I=>I.id===K);ce(c?c.id:x[0].id)}else ce("")}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ee=()=>{const A=window.__workflowContext;if(!A||!A.project||!A.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const S=Ws(N,A.nodeGroups);if(!S&&A.nodeGroups.length>0){const x=A.nodeGroups[0],c=_s({project:A.project,episode:A.episode,nodeGroup:x,assetType:"audio"});c?(ae(c),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${c}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const G=_s({project:A.project,episode:A.episode,nodeGroup:S,assetType:"audio"});G?(ae(G),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${G}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},Z=async()=>{var A,S;if(!K){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!se.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ne(!0),await Ce.assetLibraries.addFromUrl(K,s.audioUrl,se.trim());const G=window.__workflowContext;if(G&&G.project&&G.nodeGroups){const x=Ws(N,G.nodeGroups)||G.nodeGroups[0];x&&_s({project:G.project,episode:G.episode,nodeGroup:x,nodeId:N,assetType:"audio",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),fe(!1),ae("");try{we(x=>x.map(c=>c.id===N?{...c,data:{...c.data,addedToLibrary:!0}}:c))}catch{}try{const x=new CustomEvent("asset-library-updated",{detail:{libraryId:K}});window.dispatchEvent(x)}catch{}}catch(G){h.error(((S=(A=G.response)==null?void 0:A.data)==null?void 0:S.message)||"æ·»åŠ å¤±è´¥")}finally{ne(!1)}},z=async()=>{var G;let A=`audio-${Date.now()}.mp3`;const S=window.__workflowContext;if(S&&S.project&&S.nodeGroups){const x=Ws(N,S.nodeGroups)||S.nodeGroups[0];if(x){const c=_s({project:S.project,episode:S.episode,nodeGroup:x,assetType:"audio",preview:!0});if(c&&(A=c,!A.includes("."))){const I=((G=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:G[0])||".mp3";A+=I}}}try{h.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const x=`/assets/proxy-download-with-name?url=${encodeURIComponent(s.audioUrl)}&filename=${encodeURIComponent(A)}`,c=await Ce.get(x,{responseType:"blob"}),I=c instanceof Blob?c:c==null?void 0:c.data;if(!I||!(I instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const L=window.URL.createObjectURL(I),$=document.createElement("a");$.href=L,$.download=A,document.body.appendChild($),$.click(),document.body.removeChild($),setTimeout(()=>{window.URL.revokeObjectURL(L)},100),h.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${A}`)}catch(x){h.error(`ä¸‹è½½å¤±è´¥: ${x instanceof Error?x.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:n,controls:!0,src:de,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{fe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:z,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),U&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:A=>A.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>fe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:se,onChange:A=>ae(A.target.value),onMouseDown:A=>A.stopPropagation(),onTouchStart:A=>A.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const A=Ue==="ALL"?Q:Q.filter(S=>(S.category||"OTHER")===Ue);return A.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Ue==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:K,onChange:S=>ce(S.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:A.map(S=>e.jsxs("option",{value:S.id,children:[S.name," (",S._count.assets," ä¸ªèµ„äº§)"]},S.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(A=>e.jsx("button",{type:"button",onClick:()=>{he(A);const S=Q.filter(G=>(G.category||"OTHER")===A);ce(S.length>0?S[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Ue===A?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:A==="ROLE"?"person":A==="SCENE"?"landscape":A==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:A==="ROLE"?"è§’è‰²åº“":A==="SCENE"?"åœºæ™¯åº“":A==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},A))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>fe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:Z,disabled:Ie||Q.length===0||!se.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:Ie?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Oo=t.memo(Lo),Go=({data:s,id:N,selected:n})=>{const{setNodes:F,getNode:we,setEdges:U}=Zt(),[fe,Q]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.prompt||""),[ce,Ue]=t.useState(s.config.previewText||""),[he,se]=t.useState(s.config.voiceId||""),[ae,Ie]=t.useState(!1),ne=t.useRef(null),ge=t.useRef(null),de=t.useRef(null),me=t.useRef(null),[Ee,Z]=t.useState([]);t.useEffect(()=>{if(!fe){const I=(s.models||[]).filter(L=>L.type==="AUDIO_SYNTHESIS"&&L.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(L.provider||"").toLowerCase())&&(Array.isArray(L.capabilities)?L.capabilities.some($=>$.capability==="éŸ³è‰²è®¾è®¡"&&$.supported):!0))[0];I&&(Q(I.id),z({modelId:I.id}))}},[s.models,fe]);const z=c=>{we(N)&&F(L=>L.map($=>$.id===N?{...$,data:{...$.data,config:{...$.data.config,...c}}}:$))};t.useEffect(()=>{(async()=>{try{const c=await Ce.ai.audio.voices.list(),I=(c==null?void 0:c.data)??c;Z(Array.isArray(I)?I:[])}catch{}})()},[]);const A=c=>{c&&(c.style.height="auto",c.style.height=`${c.scrollHeight}px`)};t.useEffect(()=>{A(ge.current)},[re]),t.useEffect(()=>{A(de.current)},[ce]);const S=async c=>{if(!c)return!1;try{const I=(c||"").replace(/\s+/g,""),L=new Uint8Array(Math.floor(I.length/2));for(let v=0;v<L.length;v++)L[v]=parseInt(I.substr(v*2,2),16);const $=(()=>{const v=L;return v.length>=12&&v[0]===82&&v[1]===73&&v[2]===70&&v[3]===70&&v[8]===87&&v[9]===65&&v[10]===86&&v[11]===69?"audio/wav":(v.length>=3&&v[0]===73&&v[1]===68&&v[2]===51||v.length>=2&&v[0]===255&&(v[1]&224)===224,"audio/mpeg")})(),j=new Blob([L.buffer],{type:$}),O=URL.createObjectURL(j);if(me.current)try{URL.revokeObjectURL(me.current)}catch{}me.current=O;const r=ne.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=O,ne.current=r,await r.play(),!0}catch{return!1}},G=async()=>{var I,L,$,j,O;if(!re.trim()){h.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let c=fe;if(!c){const r=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(v.provider||"").toLowerCase()));if(r[0])c=r[0].id,Q(c),z({modelId:c});else{h.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}Ie(!0);try{const r=await Ce.ai.audio.design({modelId:c,prompt:re,preview_text:ce,voice_id:he||void 0,aigc_watermark:!1}),v=((I=r==null?void 0:r.data)==null?void 0:I.voice_id)||(r==null?void 0:r.voice_id),g=((L=r==null?void 0:r.data)==null?void 0:L.trial_audio)||(r==null?void 0:r.trial_audio)||(($=r==null?void 0:r.data)==null?void 0:$.hex)||(r==null?void 0:r.hex);v&&(se(String(v)),z({voiceId:String(v)})),g&&typeof g=="string"?(z({trialHex:g}),await S(g),h.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):h.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const a=we(N);if(a){const d=document.querySelector(`.react-flow__node[data-id="${a.id}"]`),m=Math.round((d==null?void 0:d.getBoundingClientRect().width)||420),f=a.position.x+m+160,w=`audio-preview-${Date.now()}`;F(R=>{var W;return[...R,{id:w,type:"audioPreview",position:{x:f,y:a.position.y},data:{audioUrl:me.current||"",sourceNodeId:N,createdBy:(W=a.data)==null?void 0:W.createdBy}}]}),U(R=>[...R,{id:`${N}-${w}`,source:N,target:w}])}}catch{}}catch(r){const v=((O=(j=r==null?void 0:r.response)==null?void 0:j.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";h.error(v)}Ie(!1)},x=async()=>{var I,L;const c=(he||"").trim();if(!c){h.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ee.some(y=>String(y.voiceId)===String(c))){h.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const O=(s.models||[]).find(y=>y.id===fe),r=(O==null?void 0:O.modelId)||"cosyvoice-v2",v=(re||c).slice(0,40);await Ce.ai.audio.voices.add({voiceId:c,prefix:v,targetModel:r,provider:String((O==null?void 0:O.provider)||"")});const g=await Ce.ai.audio.voices.list(),a=(g==null?void 0:g.data)??g;Z(Array.isArray(a)?a:[]),h.success("å·²ä¿å­˜éŸ³è‰²")}catch($){const j=((L=(I=$==null?void 0:$.response)==null?void 0:I.data)==null?void 0:L.message)||($==null?void 0:$.message)||"ä¿å­˜å¤±è´¥";h.error(j)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:c=>{Q(c),z({modelId:c})},options:(s.models||[]).filter(c=>c.type!=="AUDIO_SYNTHESIS"||!c.isActive?!1:Array.isArray(c.capabilities)?c.capabilities.some(I=>I.capability==="éŸ³è‰²è®¾è®¡"&&I.supported):["minimaxi","hailuo","æµ·èº"].includes(String(c.provider||"").toLowerCase())).map(c=>({value:c.id,label:c.name}))})]}),Ee.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(os,{value:he||"",onChange:c=>{se(c),z({voiceId:c})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ee.map(c=>({value:c.voiceId,label:c.prefix||c.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:he,onChange:c=>{const I=c.target.value;se(I),z({voiceId:I})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:ge,value:re,onChange:c=>{K(c.target.value),z({prompt:c.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:de,value:ce,onChange:c=>{Ue(c.target.value),z({previewText:c.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:G,disabled:ae||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ae||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ae?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:x,disabled:ae||!he||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${ae||!he||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white opacity-50":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ne,className:"hidden"}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Vo=t.memo(Go),Wo=({data:s,id:N,selected:n})=>{const F=t.useRef(null),we=t.useRef(null),U=t.useRef(null),{getNodes:fe,getEdges:Q,setNodes:re,setEdges:K,getNode:ce,getViewport:Ue}=Zt(),he=zs(),se=Ds(),[ae,Ie]=t.useState(null),[ne,ge]=t.useState("#7c3aed"),[de,me]=t.useState(100),Ee=t.useRef(!1),Z=t.useRef(null),z=t.useRef(null),A=t.useRef(null),S=t.useRef(new Set),G=t.useRef(null),x=t.useRef(null),c=t.useRef(null),I=4096,L=s.width||800,$=s.width||800,j=I,O=I;return t.useEffect(()=>{var p,l,i,B;if(!F.current||we.current)return;const r=document.createElement("canvas");r.width=j,r.height=O,F.current.appendChild(r);const v=new _a(r,{width:j,height:O,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),g=new Qs({left:0,top:0,width:j,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});v.add(g),v.sendObjectToBack(g),v.perPixelTargetFind=!0,v.targetFindTolerance=8;const a=L/j;v.setDimensions({width:L,height:$}),v.setZoom(a),r.style.width=`${L} px`,r.style.height=`${$} px`,we.current=v,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const y=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;v.rotationCursor=y;const d=Vs.prototype.controls||{};d.tl&&(d.tl.cursorStyle="nwse-resize",d.tl.cornerStyle="square"),d.br&&(d.br.cursorStyle="nwse-resize",d.br.cornerStyle="square"),d.tr&&(d.tr.cursorStyle="nesw-resize",d.tr.cornerStyle="square"),d.bl&&(d.bl.cursorStyle="nesw-resize",d.bl.cornerStyle="square"),d.mtr&&(d.mtr.cursorStyle=y,d.mtr.cornerStyle="circle");const m=M=>{M&&(M.borderColor="#ff2d55",M.cornerColor="#ff2d55",M.cornerStrokeColor="#ff2d55",M.transparentCorners=!1,M.cornerSize=12,M.hasBorders=!0,M.hasControls=!0)},f=()=>{const M=v.getActiveObject();M&&(M.type==="activeSelection"&&Array.isArray(M._objects)&&M._objects.forEach(m),m(M),v.requestRenderAll())};v.on("selection:created",f),v.on("selection:updated",f),v.freeDrawingBrush=new Pr(v);const w=()=>{const M=we.current;if(!M)return;const X=M.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(X.objects)&&(X.objects=X.objects.map(oe=>(oe&&oe.type==="image"&&oe.originalUrl&&(oe.src=oe.originalUrl),oe)));const V={canvasJson:X,appliedCrop:c.current},ie=JSON.stringify(V);try{localStorage.setItem(`superCanvas:${N}`,ie)}catch{}ce(N)&&re(oe=>oe.map(k=>k.id===N?{...k,data:{...k.data,canvasState:ie}}:k))},R=()=>{x.current&&(clearTimeout(x.current),x.current=null),x.current=window.setTimeout(()=>{w()},300)};v.on("object:added",R),v.on("object:modified",R),v.on("object:removed",R),v.on("path:created",R);const W=((l=(p=ce(N))==null?void 0:p.data)==null?void 0:l.canvasState)||localStorage.getItem(`superCanvas:${N}`),_=(B=(i=ce(N))==null?void 0:i.data)==null?void 0:B.canvasJson;if(W||_)try{let M,X=null;if(W){const u=JSON.parse(W);u.canvasJson?(M=u.canvasJson,X=u.appliedCrop):M=u}else _&&(M=JSON.parse(_));const V=M,ie=u=>{var E,b,Y,ue,H,pe,Se,Ne,Re;if(!u||typeof u!="object")return u;if(u.type==="image"){if(u.originalUrl)u.src=u.originalUrl;else if(u.sourceNodeId){const Ae=ce(u.sourceNodeId),_e=((E=Ae==null?void 0:Ae.data)==null?void 0:E.imageUrl)||((b=Ae==null?void 0:Ae.data)==null?void 0:b.url)||((Y=Ae==null?void 0:Ae.data)==null?void 0:Y.output)||((H=(ue=Ae==null?void 0:Ae.data)==null?void 0:ue.config)==null?void 0:H.generatedImageUrl)||((Re=(Ne=(Se=(pe=Ae==null?void 0:Ae.data)==null?void 0:pe.config)==null?void 0:Se.uploadedFiles)==null?void 0:Ne[0])==null?void 0:Re.url);_e&&(u.originalUrl=_e,u.src=_e)}return typeof u.src=="string"&&u.src.startsWith("blob:")?null:u}return Array.isArray(u.objects)&&(u.objects=u.objects.map(ie).filter(Boolean),u.type==="group"&&u.objects.length===0)?null:u},xe=u=>u&&(typeof(u==null?void 0:u.src)=="string"&&u.src.startsWith("blob:")?null:u.type==="image"?ie(u):u),oe=u=>u&&(Array.isArray(u)?u.map(oe).filter(Boolean):typeof u=="object"&&(u.type==="image"&&typeof u.src=="string"&&u.src.startsWith("blob:")||(Object.keys(u).forEach(E=>{const b=u[E];if(typeof b=="string"&&b.startsWith("blob:"))u[E]=void 0;else if(b&&typeof b=="object"){const Y=oe(b);Y===null?delete u[E]:u[E]=Y}}),Array.isArray(u.objects)&&(u.objects=u.objects.map(oe).filter(Boolean),u.type==="group"&&u.objects.length===0)))?null:u);Array.isArray(V.objects)&&(V.objects=V.objects.map(ie).filter(Boolean)),V.backgroundImage&&(V.backgroundImage=xe(V.backgroundImage)),V.overlayImage&&(V.overlayImage=xe(V.overlayImage)),V.clipPath&&(V.clipPath=ie(V.clipPath));const k=oe(V);v.loadFromJSON(k).then(()=>{const u=new Qs({left:0,top:0,width:j,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});v.add(u);const E=v.getObjects().find(b=>b.name==="__background__");if(E&&v.sendObjectToBack(E),X){c.current=X;const{left:b,top:Y,width:ue,height:H}=X,pe=new Qs({left:b,top:Y,width:ue,height:H,absolutePositioned:!0});v.clipPath=pe,E&&E.set({left:b,top:Y,width:ue,height:H})}v.requestRenderAll()})}catch{}return F.current&&F.current.classList.add("nodrag"),()=>{v.dispose(),we.current=null,F.current&&(F.current.innerHTML="")}},[N,j,O,L]),t.useEffect(()=>{ae==="brush"?(de<80||de>400)&&me(100):(ae==="pencil"||ae==="line"||ae==="arrow")&&(de<10||de>30)&&me(15)},[ae,de]),t.useEffect(()=>{const r=we.current;if(!r)return;const v="https://api.waule.com",g=he.filter(d=>d.target===N&&d.targetHandle==="input-image");g.forEach(async d=>{var _,p;const m=se.find(l=>l.id===d.source);if(!m||S.current.has(m.id))return;let f;const w=m.data;if(m.type==="upload"){const l=(_=w==null?void 0:w.config)==null?void 0:_.uploadedFiles;if(l&&l.length>0){const i=l[0];(i.type==="IMAGE"||(p=i.mimeType)!=null&&p.startsWith("image/"))&&(f=i.url)}}else m.type==="imagePreview"?f=w==null?void 0:w.imageUrl:f=(w==null?void 0:w.imageUrl)||(w==null?void 0:w.output)||(w==null?void 0:w.url);if(!f)return;let R=f;if(!f.startsWith("http")&&!f.startsWith("data:")&&(R=`${v}${f}`),R=R.replace(/^https?:\/\/localhost(?::\d+)?/i,v),r.getObjects().find(l=>l.sourceNodeId===m.id)){S.current.add(m.id);return}S.current.add(m.id);try{const l=await Ce.assets.proxyDownload(R),i=new Uint8Array(l);let B="image/png";i.length>=4&&(i[0]===137&&i[1]===80&&i[2]===78&&i[3]===71?B="image/png":i[0]===255&&i[1]===216&&i[2]===255?B="image/jpeg":i[0]===71&&i[1]===73&&i[2]===70?B="image/gif":i[0]===82&&i[1]===73&&i[2]===70&&i[3]===70&&i.length>=12&&i[8]===87&&i[9]===69&&i[10]===66&&i[11]===80&&(B="image/webp"));const M=new Blob([l],{type:B}),X=URL.createObjectURL(M),V=await Ta.fromURL(X);if(!V){URL.revokeObjectURL(X);return}const ie=g.indexOf(d)*20;V.set({scaleX:1,scaleY:1,left:(j-V.width)/2+ie,top:(O-V.height)/2+ie,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:m.id,originalUrl:R,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),V.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(V);const xe=r.getObjects().find(oe=>oe.name==="__background__");xe?(r.sendObjectToBack(V),r.sendObjectToBack(xe)):r.sendObjectToBack(V),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(X),1e3)}catch{}});const a=new Set(g.map(d=>{var m;return(m=se.find(f=>f.id===d.source))==null?void 0:m.id}).filter(Boolean)),y=[];S.current.forEach(d=>{if(!a.has(d)){y.push(d);const m=r.getObjects().find(f=>f.sourceNodeId===d);m&&(r.remove(m),r.requestRenderAll())}}),y.forEach(d=>S.current.delete(d))},[he,se,N,j,O]),t.useEffect(()=>{const r=we.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,ae===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(y=>{y.name!=="__background__"&&y.name!=="__crop__"&&(y.selectable=!1,y.evented=!1)}),G.current&&(G.current.style.display="none"),c.current){const{left:y,top:d,width:m,height:f}=c.current,w=new Qs({left:y,top:d,width:m,height:f,absolutePositioned:!0});r.clipPath=w;const R=r.getObjects().find(W=>W.name==="__background__");R&&R.set({left:y,top:d,width:m,height:f})}return}const v=ne.startsWith("#")?`%23${ne.slice(1)}`:encodeURIComponent(ne),g=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${v}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(ae==="pencil"||ae==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Pr(r);const y=(m,f)=>{const w=m.replace("#",""),R=parseInt(w.substring(0,2),16),W=parseInt(w.substring(2,4),16),_=parseInt(w.substring(4,6),16);return`rgba(${R},${W},${_},${f})`};if(r.freeDrawingBrush.color=y(ne,.7),r.freeDrawingBrush.width=de,c.current){const{left:m,top:f,width:w,height:R}=c.current,W=new Qs({left:m,top:f,width:w,height:R,absolutePositioned:!0});r.clipPath=W;const _=r.getObjects().find(p=>p.name==="__background__");_&&_.set({left:m,top:f,width:w,height:R})}const d=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${v}' stroke-width='2.2'/></svg>") 16 16, crosshair`;ae==="pencil"?(r.freeDrawingCursor=g,r.defaultCursor=g,r.hoverCursor=g,r.moveCursor=g,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=g)):(r.freeDrawingCursor=d,r.defaultCursor=d,r.hoverCursor=d,r.moveCursor=d,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=d)),r.selection=!1,r.getObjects().forEach(m=>{m.name!=="__background__"&&m.name!=="__crop__"&&(m.selectable=!0,m.evented=!0)}),ae==="brush"&&G.current&&(G.current.style.display="block"),ae==="pencil"&&G.current&&(G.current.style.display="none")}else if(ae==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const y=r.getObjects().find(R=>R.name==="__background__");y&&y.set({left:0,top:0,width:j,height:O}),r.requestRenderAll();let d=A.current;const m=j*.1,f=j-m*2,w=O-m*2;if(!d||!r.getObjects().includes(d)){const R=c.current||{left:m,top:m,width:f,height:w};d=new Qs({left:R.left,top:R.top,width:R.width,height:R.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),A.current=d,r.add(d)}d&&(d.visible=!0,d.selectable=!0,d.evented=!0,r.setActiveObject(d),r.requestRenderAll())}else if(ae==="line"||ae==="arrow"||ae==="text"||ae==="eraser"){if(r.selection=!1,c.current){const{left:d,top:m,width:f,height:w}=c.current,R=new Qs({left:d,top:m,width:f,height:w,absolutePositioned:!0});r.clipPath=R;const W=r.getObjects().find(_=>_.name==="__background__");W&&W.set({left:d,top:m,width:f,height:w})}const y=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${v}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=ae==="text"?"text":ae==="eraser"?a:y,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),ae==="line"||ae==="arrow"?(r.hoverCursor=y,r.moveCursor=y,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!1,d.evented=!1)}),G.current&&(G.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!0,d.evented=!0)}),ae==="eraser"&&G.current&&(G.current.style.display="none"),ae==="eraser"&&(r.moveCursor=a,r.hoverCursor=a)),G.current&&(G.current.style.display="none")}else{if(A.current&&(A.current.visible=!1,r.discardActiveObject()),c.current){const{left:y,top:d,width:m,height:f}=c.current,w=new Qs({left:y,top:d,width:m,height:f,absolutePositioned:!0});r.clipPath=w;const R=r.getObjects().find(W=>W.name==="__background__");R&&R.set({left:y,top:d,width:m,height:f})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(y=>{y.name!=="__background__"&&y.name!=="__crop__"&&(y.selectable=!0,y.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),G.current&&(G.current.style.display="none")}},[ae,ne,de,j,O,L,$]),t.useEffect(()=>{const r=v=>{const g=we.current;if(g){if(v.key==="Escape")Ie("select");else if(v.key==="Enter"&&ae==="crop"){const a=A.current;if(a){const y=Math.max(0,Math.floor(a.left??0)),d=Math.max(0,Math.floor(a.top??0)),m=Math.max(1,Math.floor((a.width??0)*(a.scaleX??1))),f=Math.max(1,Math.floor((a.height??0)*(a.scaleY??1)));c.current={left:y,top:d,width:m,height:f};const w=new Qs({left:y,top:d,width:m,height:f,absolutePositioned:!0});g.clipPath=w;const R=g.getObjects().find(_=>_.name==="__background__");R&&R.set({left:y,top:d,width:m,height:f}),a.visible=!1,Ie("select"),g.requestRenderAll();const W=we.current?()=>{const _=we.current;if(!_)return;const p=_.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(p.objects)&&(p.objects=p.objects.map(M=>(M&&M.type==="image"&&M.originalUrl&&(M.src=M.originalUrl),M)));const l={canvasJson:p,appliedCrop:c.current},i=JSON.stringify(l);try{localStorage.setItem(`superCanvas:${N}`,i)}catch{}ce(N)&&re(M=>M.map(X=>X.id===N?{...X,data:{...X.data,canvasState:i}}:X))}:null;W&&W()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[ae]),t.useEffect(()=>{const r=we.current;if(!r)return;const v=f=>{const w=r.getPointer(f.e);if(Ee.current=!0,Z.current={x:w.x,y:w.y},(ae==="line"||ae==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(R=>{R.name!=="__background__"&&R.name!=="__crop__"&&(R.selectable=!1,R.evented=!1)})),ae==="line"){const R=[w.x,w.y,w.x,w.y],W=new or(R,{strokeWidth:de/2,fill:ne,stroke:ne,originX:"center",originY:"center",strokeLineCap:"round"});z.current=W,r.add(W)}else if(ae==="arrow"){const R=[w.x,w.y,w.x,w.y],W=new or(R,{strokeWidth:de/2,fill:ne,stroke:ne,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});z.current=W,r.add(W)}else if(ae==="text"){const R=new Lr("Type here",{left:w.x,top:w.y,fontFamily:"Arial",fill:ne,fontSize:de*10,width:300,splitByGrapheme:!0});R.lockScalingY=!1,R.lockScalingFlip=!0,R.lockUniScaling=!1,R.setControlsVisibility({mt:!1,mb:!1}),r.add(R),r.setActiveObject(R),R.enterEditing(),Ie("select")}else if(ae==="eraser"){const R=r.getObjects();for(let W=R.length-1;W>=0;W--){const _=R[W];if(!(_.name==="__background__"||_.name==="__crop__"||_.name==="__input_image__"||_.sourceNodeId)&&_.containsPoint(w)){r.remove(_);break}}r.requestRenderAll()}},g=f=>{const w=r.getPointer(f.e);if(ae==="brush"&&G.current){const W=r.getZoom(),_=de*W,p=_/2;G.current.style.width=`${_}px`,G.current.style.height=`${_}px`,G.current.style.left=`${w.x*W-p}px`,G.current.style.top=`${w.y*W-p}px`,G.current.style.borderColor=`rgba(${parseInt(ne.slice(1,3),16)},${parseInt(ne.slice(3,5),16)},${parseInt(ne.slice(5,7),16)},0.7)`,G.current.style.borderWidth="1px",G.current.style.background="transparent"}if(!Ee.current)return;const R=z.current;if(ae==="line"&&R&&R instanceof or)R.set({x2:w.x,y2:w.y}),R.setCoords(),r.requestRenderAll();else if(ae==="arrow"&&R&&R instanceof or)R.set({x2:w.x,y2:w.y}),R.setCoords(),r.requestRenderAll();else if(ae==="eraser"){const W=r.getObjects();for(let _=W.length-1;_>=0;_--){const p=W[_];p.name==="__background__"||p.name==="__crop__"||p.name==="__input_image__"||p.sourceNodeId||p.containsPoint(w)&&r.remove(p)}r.requestRenderAll()}},a=()=>{if(Ee.current=!1,ae==="arrow"&&z.current instanceof or){const f=z.current,w=Math.atan2(f.y2-f.y1,f.x2-f.x1),R=Math.max(de*10,120),W=Math.PI/6,_=-Math.cos(w),p=-Math.sin(w),l=Math.cos(W),i=Math.sin(W),B=f.x2+R*(_*l-p*i),M=f.y2+R*(_*i+p*l),X=f.x2+R*(_*l+p*i),V=f.y2+R*(-_*i+p*l),ie=f.strokeWidth||de/2,xe=new or([f.x2,f.y2,B,M],{stroke:ne,strokeWidth:ie,strokeLineCap:"round"}),oe=new or([f.x2,f.y2,X,V],{stroke:ne,strokeWidth:ie,strokeLineCap:"round"});r.add(xe),r.add(oe);const k=new Ua([f,xe,oe],{selectable:!0,evented:!0});r.remove(f),r.remove(xe),r.remove(oe),r.add(k)}z.current=null,(ae==="line"||ae==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(f=>{f.name!=="__background__"&&f.name!=="__crop__"&&(f.selectable=!1,f.evented=!1)}))},y=f=>{var _;const w=f.target;if(!w)return;const R=w.type==="textbox"||w instanceof Lr,W=w.type==="i-text"||w instanceof Ra;if(R||W){const p=(_=f==null?void 0:f.transform)==null?void 0:_.corner;if(p==="ml"||p==="mr"){const l=Math.max(50,(w.width||50)*(w.scaleX||1));w.set({width:l,scaleX:1,scaleY:1})}else{const l=w.scaleX||1,i=w.fontSize||40,B=Math.max(6,Math.min(512,Math.round(i*l)));w.set({fontSize:B,scaleX:1,scaleY:1})}w.setCoords(),r.requestRenderAll()}},d=()=>{ae==="brush"&&G.current&&(G.current.style.display="block")},m=()=>{G.current&&(G.current.style.display="none")};return r.on("mouse:down",v),r.on("mouse:move",g),r.on("mouse:up",a),r.on("mouse:over",d),r.on("mouse:out",m),r.on("object:scaling",y),()=>{r.off("mouse:down",v),r.off("mouse:move",g),r.off("mouse:up",a),r.off("mouse:over",d),r.off("mouse:out",m),r.off("object:scaling",y)}},[ae,ne,de]),e.jsxs("div",{ref:U,className:`relative flex flex-col w-[800px] h-auto bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ir,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:F,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:G,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Ir,label:"Select"},{id:"pencil",icon:Br,label:"Pencil"},{id:"brush",icon:Ma,label:"Brush"},{id:"line",icon:Ga,label:"Line"},{id:"arrow",icon:$a,label:"Arrow"},{id:"text",icon:Fa,label:"Text"},{id:"eraser",icon:La,label:"Eraser"},{id:"crop",icon:Pa,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>Ie(r.id),className:`p-2 rounded-lg transition-all ${ae===r.id?"bg-purple-500/20 text-purple-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=we.current,v=r==null?void 0:r.getActiveObject();v&&(r==null||r.remove(v),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(zr,{size:16})}),e.jsx("button",{onClick:()=>{const r=we.current,v=r==null?void 0:r.getActiveObject();v&&(r==null||r.bringObjectToFront(v),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Wa,{size:16})}),e.jsx("button",{onClick:()=>{const r=we.current,v=r==null?void 0:r.getActiveObject();if(v){r==null||r.sendObjectToBack(v);const g=r==null?void 0:r.getObjects().find(a=>a.name==="__background__");g&&(r==null||r.sendObjectToBack(g)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Va,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ne,onChange:r=>ge(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:ae==="brush"?80:10,max:ae==="brush"?400:30,value:de,onChange:r=>{const v=parseInt(r.target.value);me(v)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:de})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:ae==="crop",onClick:async()=>{var pe,Se,Ne;const r=we.current;if(!r)return;r.discardActiveObject();const v=[...r.viewportTransform],g=r.getWidth(),a=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(I),r.setHeight(I);const y=r.clipPath;r.clipPath=void 0;const d=c.current;let m="",f=j,w=O;d?(f=d.width,w=d.height,m=r.toDataURL({format:"png",quality:1,left:d.left,top:d.top,width:d.width,height:d.height,multiplier:1})):m=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:j,height:O}),r.clipPath=y,r.setViewportTransform(v),r.setWidth(g),r.setHeight(a),r.requestRenderAll();const R=`${f}:${w}`,W=ce(N);if(!W)return;let _=m;try{const Re=m.split(",")[1],Ae=atob(Re),_e=new Array(Ae.length);for(let Wt=0;Wt<Ae.length;Wt++)_e[Wt]=Ae.charCodeAt(Wt);const $e=new Uint8Array(_e),le=new Blob([$e],{type:"image/png"}),Ge=`canvas-export-${Date.now()}.png`,Ze=await Ce.post("/assets/presigned-url",{fileName:Ge,contentType:"image/png"});if(Ze.success&&Ze.data){const{uploadUrl:Wt,publicUrl:Ct}=Ze.data;await(await xs(async()=>{const{default:dt}=await import("./utils-BcyDR7Vi.js");return{default:dt}},[])).default.put(Wt,le,{headers:{"Content-Type":"image/png"},timeout:3e5}),_=Ct}}catch{}const p=Ue&&((pe=Ue())==null?void 0:pe.zoom)||1,l=document.querySelector(`.react-flow__node[data-id="${N}"]`),i=(l==null?void 0:l.getBoundingClientRect().width)||400,B=Math.round(i/p),M=400,X=(Re,Ae=300)=>{if(!Re||!/^[0-9]+\s*:\s*[0-9]+$/.test(Re))return Ae;const[_e,$e]=Re.split(":").map(le=>parseFloat(le));return!_e||!$e?Ae:Math.round(M*($e/_e))},V=200,ie=100,xe=X(R,300),oe=fe(),k=Q(),E=oe.filter(Re=>Re.type==="imagePreview"&&k.some(Ae=>Ae.source===N&&Ae.target===Re.id)).length,b=W.position.x+B+V,Y=W.position.y+E*(xe+ie),ue={id:`preview-${N}-${Date.now()}`,type:"imagePreview",position:{x:b,y:Y},data:{imageUrl:_,width:M,ratio:R,workflowContext:(Se=W.data)==null?void 0:Se.workflowContext,createdBy:(Ne=W.data)==null?void 0:Ne.createdBy}};re(Re=>[...Re,ue]);const H={id:`edge-${N}-${ue.id}`,source:N,target:ue.id,targetHandle:`${ue.id}-target`,type:"aurora"};K(Re=>Re.find(_e=>_e.source===N&&_e.target===ue.id)?Re:[...Re,H])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md",title:ae==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(St,{type:"target",position:pt.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-purple-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(St,{type:"source",position:pt.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-purple-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Fo=t.memo(Wo),zo=({data:s,selected:N,id:n})=>{const[F,we]=t.useState(s.config.upscaleResolution||"1080p"),[U,fe]=t.useState(!1),[Q,re]=t.useState(s.config.inputVideoUrl||""),[,K]=t.useState(s.config.taskId||""),{setNodes:ce,setEdges:Ue}=Zt(),he=Ds(),se=zs(),ae=de=>{ce(me=>me.map(Ee=>Ee.id===n?{...Ee,data:{...Ee.data,config:{...Ee.data.config,...de}}}:Ee))};t.useEffect(()=>{var me,Ee,Z;const de=se.filter(z=>z.target===n);if(de.length>0){const z=he.find(A=>A.id===de[0].source);if(z){const A=z.data,S=A.videoUrl||((me=A.config)==null?void 0:me.videoUrl)||((Ee=A.config)==null?void 0:Ee.outputVideoUrl)||((Z=A.config)==null?void 0:Z.resultUrl);S&&S!==Q&&(re(S),ae({inputVideoUrl:S}))}}else Q&&(re(""),ae({inputVideoUrl:""}))},[se,he,n]),t.useEffect(()=>{const de=s.config.taskId;(async()=>{if(de)try{const Z=(await Ce.get(`/tasks/${de}`)).task;if(Z.status==="SUCCESS"){const z=Z.resultUrl;ae({outputVideoUrl:z,taskId:""}),se.filter(x=>x.source===n).map(x=>he.find(c=>c.id===x.target)).filter(x=>x&&x.type==="videoPreview").find(x=>x.data.videoUrl===z)||ne(z),Gt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),fe(!1)}else Z.status==="PROCESSING"||Z.status==="PENDING"?(fe(!0),Ie(de)):Z.status==="FAILURE"&&(fe(!1),ae({taskId:""}),Gt.error(Z.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${Z.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{fe(!1),ae({taskId:""}),Gt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const Ie=async de=>{let Ee=0;const Z=async()=>{try{Ee++;const A=(await Ce.get(`/tasks/${de}`)).task;if(A.status==="SUCCESS"){const S=A.resultUrl;fe(!1),ae({outputVideoUrl:S,taskId:""}),ne(S),Gt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(A.status==="FAILURE"){fe(!1),ae({taskId:""}),Gt.error(A.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(A.status==="PROCESSING"||A.status==="PENDING")&&(Ee<300?setTimeout(Z,3e3):(fe(!1),ae({taskId:""}),Gt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{fe(!1),ae({taskId:""}),Gt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};Z()},ne=de=>{var Ee;const me=he.find(Z=>Z.id===n);if(me){const Z=`preview-video-${Date.now()}`,z=F==="1080p"?"HD":F,A={id:Z,type:"videoPreview",position:{x:me.position.x+400,y:me.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:de,ratio:"16:9",resolution:z,createdBy:(Ee=me.data)==null?void 0:Ee.createdBy}},S={id:`edge-${n}-${Z}`,source:n,target:Z,type:"aurora"};ce(G=>[...G,A]),setTimeout(()=>{Ue(G=>[...G,S])},100)}},ge=async()=>{var de,me;if(!Q){Gt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}fe(!0);try{const Ee=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!Ee||Ee.length===0){Gt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),fe(!1);return}const Z=Ee[0],A=(await Ce.post("/ai/video-upscale",{video_url:Q,upscale_resolution:F,apiKey:Z.apiKey,apiUrl:Z.apiUrl})).taskId;K(A),ae({taskId:A,upscaleResolution:F}),Gt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),Ie(A)}catch(Ee){const Z=((me=(de=Ee.response)==null?void 0:de.data)==null?void 0:me.error)||Ee.message||"æœªçŸ¥åŸå› ";Gt.error(`å¯åŠ¨å¤±è´¥ï¼š${Z}ï¼Œè¯·ç¨åé‡è¯•`),fe(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(us,{type:"target",position:pt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[Q&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:Q,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(de=>e.jsx("button",{type:"button",onClick:()=>{we(de),ae({upscaleResolution:de})},disabled:U,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${F===de?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${U?"opacity-50 cursor-not-allowed":""}`,children:de},de))})]}),e.jsx("button",{type:"button",onClick:de=>{de.preventDefault(),de.stopPropagation(),ge()},onMouseDown:de=>{de.stopPropagation()},disabled:U||!Q||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${U||!Q||s._canEdit===!1?"bg-slate-300 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[U?e.jsx(Ms,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:U?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(us,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Bo=t.memo(zo),Ho=({data:s,selected:N,id:n})=>{const[F,we]=t.useState(s.config.prompt||""),[U,fe]=t.useState(s.config.duration||30),[Q,re]=t.useState(s.config.ratio||"16:9"),[K,ce]=t.useState(s.config.language||"zh"),[Ue,he]=t.useState(!1),[se,ae]=t.useState(s.config.images||[]),[,Ie]=t.useState(s.config.taskId||""),{credits:ne,loading:ge}=Us({nodeType:"ad_composition",duration:U}),{setNodes:de,setEdges:me}=Zt(),Ee=Ds(),Z=zs(),z=x=>{de(c=>c.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,...x}}}:I))};t.useEffect(()=>{const x=Z.filter(I=>I.target===n),c=[];x.forEach(I=>{var $,j,O,r,v,g,a,y,d,m;const L=Ee.find(f=>f.id===I.source);L&&(L.type==="imagePreview"&&(($=L.data)!=null&&$.imageUrl)?c.push(L.data.imageUrl):L.type==="aiImage"&&((O=(j=L.data)==null?void 0:j.config)!=null&&O.generatedImageUrl)?c.push(L.data.config.generatedImageUrl):L.type==="upload"&&((v=(r=L.data)==null?void 0:r.config)!=null&&v.uploadedFiles)?L.data.config.uploadedFiles.filter(w=>w.type==="IMAGE"||(w.mimeType||"").startsWith("image/")).forEach(w=>c.push(w.url)):L.type==="assetSelector"&&((a=(g=L.data)==null?void 0:g.config)!=null&&a.subjects?L.data.config.subjects.forEach(w=>{Array.isArray(w.images)&&w.images.forEach(R=>c.push(R.url))}):((m=(d=(y=L.data)==null?void 0:y.config)==null?void 0:d.selectedAsset)==null?void 0:m.type)==="IMAGE"&&c.push(L.data.config.selectedAsset.url)))}),JSON.stringify(c)!==JSON.stringify(se)&&(ae(c),z({images:c}))},[Z,Ee,n]),t.useEffect(()=>{const x=s.config.taskId;(async()=>{if(x)try{const L=(await Ce.get(`/tasks/${x}`)).task;if(L.status==="SUCCESS"){const $=L.resultUrl;z({taskId:""}),he(!1)}else L.status==="PROCESSING"||L.status==="PENDING"?(he(!0),A(x)):L.status==="FAILURE"&&(he(!1),z({taskId:""}),Gt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${L.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{he(!1),z({taskId:""})}})()},[]);const A=async x=>{let I=0;const L=async()=>{try{I++;const j=(await Ce.get(`/tasks/${x}`)).task;if(j.status==="SUCCESS"){const O=j.resultUrl;he(!1),z({taskId:""}),S(O),Gt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(j.status==="FAILURE"){he(!1),z({taskId:""}),Gt.error(j.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(j.status==="PROCESSING"||j.status==="PENDING")&&(I<120?setTimeout(L,1e4):(he(!1),z({taskId:""}),Gt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{he(!1),z({taskId:""}),Gt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};L()},S=x=>{var I;const c=Ee.find(L=>L.id===n);if(c){const L=`preview-video-${Date.now()}`,$={id:L,type:"videoPreview",position:{x:c.position.x+400,y:c.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:x,ratio:Q,width:320,createdBy:(I=c.data)==null?void 0:I.createdBy}},j={id:`edge-${n}-${L}`,source:n,target:L,type:"aurora"};de(O=>[...O,$]),setTimeout(()=>{me(O=>[...O,j])},100)}},G=async()=>{var x,c,I,L,$;if(se.length===0){Gt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(se.length>15){Gt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!F.trim()){Gt.error("è¯·è¾“å…¥æç¤ºè¯");return}he(!0);try{const j=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!j||j.length===0){Gt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),he(!1);return}const O=j[0],r={images:se,prompt:F,duration:U,ratio:Q,language:K,apiKey:O.apiKey,apiUrl:O.apiUrl},v=await Ce.post("/ai/commercial-video",r),g=v.taskId,a=v.creditsCharged||0;if(Ie(g),z({taskId:g,images:se,prompt:F,duration:U,ratio:Q,language:K}),a>0)try{const{useAuthStore:y}=await xs(async()=>{const{useAuthStore:m}=await import("./index-B-U_h0BA.js").then(f=>f.f);return{useAuthStore:m}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:d}=y.getState();await d(),Gt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${a} ç§¯åˆ†ï¼‰`)}catch{Gt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Gt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");A(g)}catch(j){((x=j.response)==null?void 0:x.status)===403?Gt.error(((I=(c=j.response)==null?void 0:c.data)==null?void 0:I.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Gt.error((($=(L=j.response)==null?void 0:L.data)==null?void 0:$.error)||j.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),he(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(us,{type:"target",position:pt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",se.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:F,onChange:x=>{we(x.target.value),z({prompt:x.target.value}),x.target.style.height="auto",x.target.style.height=x.target.scrollHeight+"px"},onFocus:x=>{x.target.style.height="auto",x.target.style.height=x.target.scrollHeight+"px"},ref:x=>{x&&F&&(x.style.height="auto",x.style.height=x.scrollHeight+"px")},disabled:Ue,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(x=>e.jsxs("button",{type:"button",onClick:()=>{fe(x),z({duration:x})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${U===x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Ue?"opacity-50 cursor-not-allowed":""}`,children:[x,"s"]},x))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(x=>e.jsx("button",{type:"button",onClick:()=>{re(x),z({ratio:x})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Q===x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Ue?"opacity-50 cursor-not-allowed":""}`,children:x},x))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(x=>e.jsx("button",{type:"button",onClick:()=>{ce(x.value),z({language:x.value})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${K===x.value?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Ue?"opacity-50 cursor-not-allowed":""}`,children:x.label},x.value))})]}),e.jsx("button",{type:"button",onClick:G,disabled:Ue||se.length===0||!F.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Ue||se.length===0||!F.trim()||s._canEdit===!1?"bg-slate-300 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Ue?e.jsx(Ms,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),e.jsx("span",{children:Ue?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Ue&&!ge&&ne!==null&&ne>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[ne,"ç§¯åˆ†"]})]})})]}),e.jsx(us,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Xo=t.memo(Ho),Jo=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],qo=({data:s,selected:N,id:n})=>{const{setNodes:F}=Zt(),[we,U]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[fe,Q]=t.useState(!1),[re,K]=t.useState(!1),[ce,Ue]=t.useState(s.fontSize||36),[he,se]=t.useState(s.width||200),[ae,Ie]=t.useState(s.bold||!1),ne=t.useRef(null),ge=t.useRef(null),de=t.useCallback(Z=>{F(z=>z.map(A=>A.id===n?{...A,data:{...A.data,...Z}}:A))},[n,F]);t.useEffect(()=>{const Z=setTimeout(()=>{we!==s.text&&de({text:we})},300);return()=>clearTimeout(Z)},[we,s.text,de]),t.useEffect(()=>{de({fontSize:ce,width:he,bold:ae})},[ce,he,ae,de]);const me=()=>{Q(!0),setTimeout(()=>{ne.current&&(ne.current.focus(),ne.current.select(),ne.current.style.height="auto",ne.current.style.height=`${ne.current.scrollHeight}px`)},0)},Ee=()=>{Q(!1)};return t.useEffect(()=>{fe&&ne.current&&(ne.current.style.height="auto",ne.current.style.height=`${ne.current.scrollHeight}px`)},[fe,we]),t.useEffect(()=>{const Z=z=>{ge.current&&!ge.current.contains(z.target)&&K(!1)};return re&&document.addEventListener("mousedown",Z),()=>document.removeEventListener("mousedown",Z)},[re]),e.jsxs("div",{className:`relative group ${N?"ring-2 ring-purple-400 ring-offset-2":""}`,style:{width:he},children:[e.jsx(ps,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:Z=>{Z.stopPropagation(),K(!re)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),re&&e.jsxs("div",{ref:ge,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:Z=>Z.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:ce,onChange:Z=>Ue(Number(Z.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-purple-400",children:Jo.map(Z=>e.jsxs("option",{value:Z,children:[Z,"px"]},Z))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>Ie(!ae),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${ae?"bg-purple-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),fe?e.jsx("textarea",{ref:ne,value:we,onChange:Z=>U(Z.target.value),onBlur:Ee,onMouseDown:Z=>Z.stopPropagation(),onKeyDown:Z=>{Z.key==="Escape"&&Q(!1)},className:"nodrag w-full bg-transparent border-2 border-purple-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:ae?"bold":"normal"}}):e.jsx("div",{onDoubleClick:me,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:ae?"bold":"normal"},children:we}),!fe&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:Z=>{Z.stopPropagation(),Z.preventDefault();const z=Z.clientX,A=he,S=x=>{x.preventDefault();const c=Math.max(100,A+(x.clientX-z));se(c)},G=()=>{document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",G)};document.addEventListener("mousemove",S),document.addEventListener("mouseup",G)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Yo=t.memo(qo),Ko=({data:s,id:N,selected:n})=>{const{getNode:F,setNodes:we,setEdges:U}=Zt(),fe=Fs(t.useCallback(l=>l.edges.filter(i=>i.target===N),[N])),[Q,re]=t.useState(s.prompt||""),[K,ce]=t.useState(s.points||[]),[Ue,he]=t.useState(!1),[se,ae]=t.useState(!1),[Ie,ne]=t.useState(null),[ge,de]=t.useState([]),[,me]=t.useState(s.generatedImageUrl||null),[Ee,Z]=t.useState(null),[,z]=t.useState(s.taskId||""),[,A]=t.useState(0),S=t.useRef(null),G=t.useRef(1),{credits:x,loading:c,isFreeUsage:I,freeUsageRemaining:L,refetch:$}=Us({nodeType:"image_editing",quantity:1}),j=t.useCallback(l=>{we(i=>i.map(B=>B.id===N?{...B,data:{...B.data,...l}}:B))},[N,we]),O=Fs(t.useCallback(l=>l.edges.filter(i=>i.source===N),[N])),r=t.useCallback(l=>{var ie,xe;const i=F(N);if(!i)return;const B=O.find(oe=>{const k=F(oe.target);return(k==null?void 0:k.type)==="imagePreview"});if(B){const oe=B.target;we(k=>k.map(u=>u.id===oe?{...u,data:{...u.data,imageUrl:l}}:u));return}const M=Date.now(),X=`preview-${N}-${M}`,V={id:X,type:"imagePreview",position:{x:(((ie=i==null?void 0:i.position)==null?void 0:ie.x)||0)+450,y:((xe=i==null?void 0:i.position)==null?void 0:xe.y)||0},data:{imageUrl:l,width:400}};setTimeout(()=>{we(k=>[...k,V]);const oe={id:`edge-${N}-${X}`,source:N,target:X,targetHandle:`${X}-target`,type:"aurora"};U(k=>k.find(E=>E.source===N&&E.target===X)?k:[...k,oe])},100)},[N,F,we,U,O]),v=t.useRef({active:!1,timeoutId:null}),g=t.useCallback(async l=>{let B=0;v.current.timeoutId&&clearTimeout(v.current.timeoutId),v.current.active=!0;const M=async()=>{if(v.current.active)try{B++;const V=(await Ce.tasks.getTaskStatus(l)).task;if(!v.current.active)return;if(A(V.progress||0),V.status==="SUCCESS"){v.current.active=!1,he(!1),A(100);const ie=V.resultUrl;j({generatedImageUrl:ie,taskId:""}),me(ie),h.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ie&&r(ie);return}else if(V.status==="FAILURE"){v.current.active=!1,he(!1),A(0),j({taskId:""}),h.error(V.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(V.status==="PROCESSING"||V.status==="PENDING")&&(B<300&&v.current.active?v.current.timeoutId=setTimeout(M,1e3):(v.current.active=!1,he(!1),A(0),j({taskId:""}),h.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{v.current.active=!1,he(!1),A(0),j({taskId:""}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};M()},[j,r]);t.useEffect(()=>()=>{v.current.active=!1,v.current.timeoutId&&clearTimeout(v.current.timeoutId)},[]),t.useEffect(()=>{const l=s.taskId;if(!l)return;(async()=>{try{const M=(await Ce.tasks.getTaskStatus(l)).task;if(M.status==="SUCCESS"){he(!1),A(100);const X=M.resultUrl;X?(j({generatedImageUrl:X,taskId:""}),me(X),h.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):j({taskId:""})}else M.status==="PROCESSING"||M.status==="PENDING"?(he(!0),A(M.progress||0),g(l)):M.status==="FAILURE"&&(he(!1),A(0),j({taskId:""}),h.error(M.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${M.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{he(!1),A(0),j({taskId:""})}})()},[]);const a=t.useCallback(l=>{const i=new Image;i.onload=()=>{Z({width:i.naturalWidth,height:i.naturalHeight})},i.src=l},[]);t.useEffect(()=>{try{const l=[];fe.forEach(i=>{var V,ie,xe,oe;const B=F(i.source);if(!B)return;const M=B.data;let X=null;M!=null&&M.url?X=M.url:M!=null&&M.imageUrl?X=M.imageUrl:M!=null&&M.output?X=M.output:(V=M==null?void 0:M.config)!=null&&V.generatedImageUrl?X=M.config.generatedImageUrl:(oe=(xe=(ie=M==null?void 0:M.config)==null?void 0:ie.uploadedFiles)==null?void 0:xe[0])!=null&&oe.url&&(X=M.config.uploadedFiles[0].url),X&&l.push(X)}),l.length>0?(ne(l[0]),de(l.slice(1)),a(l[0])):(ne(null),de([]),Z(null))}catch{}},[fe,F,a]),t.useEffect(()=>{const l=setTimeout(()=>{we(i=>i.map(B=>{if(B.id!==N)return B;const M=B.data;return M.prompt===Q&&JSON.stringify(M.points)===JSON.stringify(K)?B:{...B,data:{...B.data,prompt:Q,points:K}}}))},300);return()=>clearTimeout(l)},[Q,K,N,we]);const y=t.useCallback(l=>{if(!l.ctrlKey&&!l.metaKey||!S.current)return;const i=S.current.getBoundingClientRect(),B=(l.clientX-i.left)/i.width,M=(l.clientY-i.top)/i.height,X={id:G.current++,x:Math.max(0,Math.min(1,B)),y:Math.max(0,Math.min(1,M))};ce(V=>[...V,X])},[]),d=t.useCallback(l=>{ce(i=>i.filter(B=>B.id!==l))},[]),m=t.useCallback((l,i)=>{ce(B=>B.map(M=>M.id===l?{...M,name:i}:M))},[]),f=t.useCallback((l,i)=>{l.stopPropagation();const B=i.name?`@${i.name}`:`@ä½ç½®${i.id}`;l.dataTransfer.setData("text/plain",B),l.dataTransfer.effectAllowed="copy"},[]),w=t.useCallback((l,i)=>{l.stopPropagation();const B=`@å‚è€ƒå›¾${i+1}`;l.dataTransfer.setData("text/plain",B),l.dataTransfer.effectAllowed="copy"},[]),R=t.useCallback(l=>{l.preventDefault(),l.stopPropagation(),l.dataTransfer.dropEffect="copy"},[]),W=t.useCallback(l=>{l.preventDefault(),l.stopPropagation();const i=l.dataTransfer.getData("text/plain");if(i){const B=l.target,M=B.selectionStart,X=B.selectionEnd,V=Q.slice(0,M)+i+Q.slice(X);re(V),setTimeout(()=>{B.selectionStart=B.selectionEnd=M+i.length,B.focus()},0)}},[Q]),_=t.useCallback(async()=>{var l;if(!(!Ie||K.length===0)){ae(!0);try{const i=await Ce.ai.imageEditing.identifyPoints({image:Ie,points:K.map(B=>({id:B.id,x:B.x,y:B.y}))});if(i.success&&((l=i.data)!=null&&l.points)){const B=i.data.points;ce(M=>M.map(X=>{const V=B.find(ie=>ie.id===X.id);return V?{...X,name:V.name}:X})),h.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{h.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{ae(!1)}}},[Ie,K]),p=t.useCallback(async()=>{var l,i,B,M,X;if(!Ie){h.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!Q.trim()){h.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}he(!0),A(0);try{const V=await Ce.tasks.createImageEditTask({prompt:Q.trim(),mainImage:Ie,referenceImages:ge.length>0?ge:void 0,points:K.length>0?K:void 0,sourceImageDimensions:Ee||void 0,sourceNodeId:N}),ie=V.taskId,xe=V.creditsCharged||0,oe=V.isFreeUsage,k=V.freeUsageRemaining??0;if(z(ie),j({prompt:Q.trim(),points:K,taskId:ie}),oe)h.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${k} æ¬¡æœºä¼š`),$();else if(xe>0){const{useAuthStore:u}=await xs(async()=>{const{useAuthStore:b}=await import("./index-B-U_h0BA.js").then(Y=>Y.f);return{useAuthStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:E}=u.getState();await E(),h.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${xe} ç§¯åˆ†`),$()}else h.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");g(ie)}catch(V){if(he(!1),A(0),((l=V.response)==null?void 0:l.status)===403){const ie=((B=(i=V.response)==null?void 0:i.data)==null?void 0:B.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";h.error(ie)}else{const ie=((X=(M=V.response)==null?void 0:M.data)==null?void 0:X.error)||V.message||"æœªçŸ¥åŸå› ";h.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ie}ï¼Œè¯·ç¨åé‡è¯•`)}}},[Ie,Q,ge,K,Ee,N,j,g,$]);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"target",position:pt.Left,id:`${N}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"source",position:pt.Right,id:`${N}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 from-pink-200/50 via-purple-500/20 via-purple-200/50 to-cyan-500/20 to-cyan-200/50 dark:from-pink-500/20 dark:via-purple-500/20 dark:to-cyan-500/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Br,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:S,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:y,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Ie,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),K.map(l=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${l.x*100}%`,top:`${l.y*100}%`},onClick:i=>{i.stopPropagation(),d(l.id)},title:l.name||`ç‚¹å‡»åˆ é™¤ #${l.id}`,children:l.id},l.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ir,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),ge.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[ge.map((l,i)=>e.jsx("img",{src:l,alt:`Ref ${i+1}`,draggable:!0,onDragStart:B=>w(B,i),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},i)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",ge.length," å‚è€ƒå›¾"]})]}),K.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",K.length,")"]}),e.jsxs("button",{onClick:_,disabled:se||!Ie,className:"text-[10px] text-purple-500 hover:text-purple-600 disabled:opacity-50 flex items-center gap-1",children:[se?e.jsx(Ms,{className:"w-3 h-3 animate-spin"}):e.jsx(hr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:K.map(l=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:i=>f(i,l),className:"w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:l.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:l.name||"",onChange:i=>m(l.id,i.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>d(l.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(zr,{className:"w-3 h-3"})})]},l.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:Q,onChange:l=>re(l.target.value),onDragOver:R,onDrop:W,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:p,onPointerDown:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),disabled:Ue||!Ie||!Q.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${Ue?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ue?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!c&&(I?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",L,"æ¬¡"]}):x!==null&&x>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[x,"ç§¯åˆ†"]}):null)]})})]})]})},Zo=t.memo(Ko);async function cr(s){const{resultUrl:N,allImageUrls:n}=s;return{displayUrl:N,allDisplayUrls:n,isLocalStored:!1,originalUrl:N}}const Qo="gemini-3-pro-image-preview",en=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],tn=s=>{const[N,n]=s.split(":").map(Number);return N/n},sn=(s,N)=>{const n=s/N;let F="1:1",we=1/0;for(const U of en){const fe=tn(U),Q=Math.abs(n-fe);Q<we&&(we=Q,F=U)}return F},rn=s=>new Promise((N,n)=>{const F=new Image;F.onload=()=>{N({width:F.naturalWidth,height:F.naturalHeight})},F.onerror=n,F.src=s}),an=({data:s,selected:N,id:n})=>{const[F,we]=t.useState(s.config.imageSize||"2K"),[U,fe]=t.useState(s.config.inputImage),[Q,re]=t.useState(!!s.config.taskId),[K,ce]=t.useState(null),Ue=t.useMemo(()=>{const Z=s.models||[];return Z.find(z=>z.modelId===Qo)||Z.find(z=>{var A;return(A=z.modelId)==null?void 0:A.includes("gemini")})||Z[0]},[s.models]);t.useEffect(()=>{Ue&&ce(Ue)},[Ue]);const{setNodes:he,setEdges:se,getNode:ae,getNodes:Ie}=Zt(),ne=Fs(Z=>Z.edges.filter(z=>z.target===n));t.useEffect(()=>{const Z=Ie();let z;ne.forEach(A=>{var G,x,c,I,L,$;const S=Z.find(j=>j.id===A.source);if(S){const j=((G=S.data)==null?void 0:G.imageUrl)||((c=(x=S.data)==null?void 0:x.config)==null?void 0:c.generatedImageUrl)||((L=(I=S.data)==null?void 0:I.config)==null?void 0:L.imageUrl)||(($=S.data)==null?void 0:$.url);j&&(z=j)}}),z!==U&&(fe(z),ge({inputImage:z}))},[ne,Ie]),t.useEffect(()=>{const Z=s.config.taskId;(async()=>{if(Z)try{const S=(await Ce.tasks.getTaskStatus(Z)).task;if(S.status==="SUCCESS"){re(!1);const G=S.resultUrl;if(!G){ge({taskId:""});return}const c=(await cr({taskId:Z,resultUrl:G,type:"IMAGE"})).displayUrl;ge({generatedImageUrl:c,taskId:""})}else S.status==="PROCESSING"||S.status==="PENDING"?(re(!0),me(Z)):S.status==="FAILURE"&&(re(!1),ge({taskId:""}),Gs.error(`ç”Ÿæˆå¤±è´¥: ${S.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{re(!1),ge({taskId:""}),Gs.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const ge=Z=>{he(z=>z.map(A=>A.id===n?{...A,data:{...A.data,config:{...A.data.config,...Z}}}:A))},de=async()=>{var Z;if(!U){Gs.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}re(!0);try{const z=await dr(U);let A="1:1";try{const c=await rn(U);A=sn(c.width,c.height)}catch{}let S="";try{const c=await Ce.get("/node-prompts/type/hdUpscale");c.success&&((Z=c.data)!=null&&Z.userPromptTemplate)&&(S=c.data.userPromptTemplate)}catch{}if(S||(S="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),S=`${S}ï¼Œç”Ÿæˆ${A}æ¯”ä¾‹çš„å›¾ç‰‡`,!K){Gs.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),re(!1);return}const G=await Ce.tasks.createImageTask({modelId:K.id,prompt:S,ratio:A,referenceImages:[z],sourceNodeId:n,metadata:{imageSize:F}});if(!G.success)throw new Error(G.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const x=G.taskId;ge({taskId:x}),me(x)}catch(z){Gs.error(z.message||"ç”Ÿæˆå¤±è´¥"),re(!1)}},me=async Z=>{let A=0;const S=async()=>{try{const x=(await Ce.tasks.getTaskStatus(Z)).task;if(x.status==="SUCCESS"){re(!1);const c=x.resultUrl;if(!c){Gs.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const L=(await cr({taskId:Z,resultUrl:c,type:"IMAGE"})).displayUrl;ge({generatedImageUrl:L,taskId:"",imageSize:F}),Ee(L),Gs.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else x.status==="FAILURE"?(re(!1),ge({taskId:""}),Gs.error(`ç”Ÿæˆå¤±è´¥: ${x.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(x.status==="PROCESSING"||x.status==="PENDING")&&(A++,A<300?setTimeout(S,2e3):(re(!1),Gs.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{re(!1),Gs.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};S()},Ee=Z=>{const z=ae(n);if(!z)return;const G=Ie().filter($=>$.id.startsWith(`${n}-preview`)&&$.type==="imagePreview").length,I={id:`${n}-preview-${Date.now()}`,type:"imagePreview",position:{x:z.position.x+380,y:z.position.y+G*(220+20)},data:{imageUrl:Z,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:n,createdBy:z.data.createdBy}},L={id:`edge-${n}-to-${I.id}`,source:n,target:I.id,sourceHandle:`${n}-source`,type:"aurora"};he($=>[...$,I]),se($=>[...$,L])};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(us,{type:"target",position:pt.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(us,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[U&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:U,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{we("2K"),ge({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="2K"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{we("4K"),ge({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="4K"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:de,onPointerDown:Z=>Z.stopPropagation(),onMouseDown:Z=>Z.stopPropagation(),disabled:Q||!U||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${Q?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"})]})})]})]})},on=t.memo(an),Xr=async(s,N,n)=>new Promise((F,we)=>{const U=new Image;U.crossOrigin="Anonymous",U.onload=()=>{try{const fe=U.width,Q=U.height,re=Math.floor(fe/n),K=Math.floor(Q/N),ce=[],Ue=document.createElement("canvas");Ue.width=re,Ue.height=K;const he=Ue.getContext("2d");if(!he){we(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let se=0;se<N;se++)for(let ae=0;ae<n;ae++)he.clearRect(0,0,re,K),he.drawImage(U,ae*re,se*K,re,K,0,0,re,K),ce.push(Ue.toDataURL("image/png"));F({slices:ce,fullImage:s,rows:N,cols:n})}catch(fe){we(fe)}},U.onerror=()=>{we(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),U.src=s}),Fr=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},nn=(s,N="image/png")=>{const n=s.includes(",")?s.split(",")[1]:s,F=atob(n),we=new Array(F.length);for(let fe=0;fe<F.length;fe++)we[fe]=F.charCodeAt(fe);const U=new Uint8Array(we);return new Blob([U],{type:N})},ln=({data:s,selected:N,id:n})=>{const[F,we]=t.useState(null),U="single",[fe,Q]=t.useState(s.config.aspectRatio||"16:9"),[re,K]=t.useState(s.config.imageSize||"4K"),[ce,Ue]=t.useState(s.config.userPrompt||""),[he,se]=t.useState(!!s.config.taskId),[ae,Ie]=t.useState(s.config.characterImages||[]),[ne,ge]=t.useState(s.config.sceneImages||[]),[de,me]=t.useState(s.config.styleImage),Ee=t.useRef(null),{setNodes:Z,setEdges:z,getNode:A,getNodes:S,getEdges:G}=Zt(),x=Fs(_=>_.edges.filter(p=>p.target===n)),c=Fs(_=>_.edges.some(p=>p.target===n&&p.targetHandle===`${n}-scene-input`)),I=Fs(_=>_.edges.some(p=>p.target===n&&p.targetHandle===`${n}-style-input`)),L=t.useRef(""),{credits:$,loading:j,isFreeUsage:O,freeUsageRemaining:r}=Us({aiModelId:F==null?void 0:F.id,quantity:1,resolution:re}),v="gemini-3-pro-image-preview",g=t.useMemo(()=>{const _=s.models||[];return _.find(p=>p.modelId===v)||_.find(p=>{var l;return(l=p.modelId)==null?void 0:l.includes("gemini")})||_[0]},[s.models]);t.useEffect(()=>{g&&we(g)},[g]),t.useEffect(()=>{const _=s.config.taskId,p=s.config.generatedImageUrl;(async()=>{if(_)try{const B=(await Ce.tasks.getTaskStatus(_)).task;if(B.status==="SUCCESS"){se(!1);const M=B.resultUrl;if(!M){a({taskId:""}),h.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let X=M;p?X=p:X=(await cr({taskId:_,resultUrl:M,type:"IMAGE"})).displayUrl,a({generatedImageUrl:X,taskId:""});const V=S(),ie=G();if(V.filter(k=>k.type==="imagePreview"&&ie.some(u=>u.source===n&&u.target===k.id)).find(k=>k.data.imageUrl===X||k.data.imageUrl===M)){h.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}h.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),R(X,fe,0)}else B.status==="PROCESSING"||B.status==="PENDING"?(se(!0),f(_)):B.status==="FAILURE"&&(se(!1),a({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${B.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{se(!1),a({taskId:""}),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ee.current&&ce){const _=Ee.current;_.style.height="auto",_.style.height=`${_.scrollHeight}px`}},[]);const a=_=>{Z(p=>p.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,..._}}}:l))};t.useEffect(()=>{const _=JSON.stringify(x.map(B=>({source:B.source,sourceHandle:B.sourceHandle,targetHandle:B.targetHandle})));if(_===L.current)return;L.current=_;const p=[],l=[];let i;x.forEach(B=>{const M=A(B.source);if(!M)return;const X=B.targetHandle||"",V=y(M);X.includes("character")?p.push(...V):X.includes("scene")?l.length===0&&V.length>0&&l.push(V[0]):X.includes("style")&&V.length>0&&(i=V[0])}),Ie(p),ge(l),me(i),a({characterImages:p,sceneImages:l,styleImage:i})},[x,A]);const y=_=>{var i,B,M,X;const p=(_==null?void 0:_.type)||"",l=_==null?void 0:_.data;if(p==="upload"&&((i=l==null?void 0:l.config)!=null&&i.uploadedFiles))return l.config.uploadedFiles.filter(V=>{var ie;return V.type==="IMAGE"||((ie=V.mimeType)==null?void 0:ie.startsWith("image/"))}).map(V=>V.url||V.localUrl);if(p==="assetSelector"&&((B=l==null?void 0:l.config)!=null&&B.selectedAsset)){const V=l.config.selectedAsset;if(V.type==="IMAGE"||(M=V.mimeType)!=null&&M.startsWith("image/"))return[V.url]}return p==="imagePreview"&&(l!=null&&l.imageUrl)?[l.imageUrl]:p==="aiImage"&&((X=l==null?void 0:l.config)!=null&&X.generatedImageUrl)?[l.config.generatedImageUrl]:[]},d=()=>{let _=ce;if(de){const p=ae.length+ne.length+1;_+=`ï¼Œå‚è€ƒå›¾ç‰‡${p}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${p}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return _+=`ï¼Œç”Ÿæˆ${fe}æ¯”ä¾‹çš„å›¾ç‰‡`,_},m=async()=>{if(!ce.trim()){h.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!F){h.error("è¯·é€‰æ‹©æ¨¡å‹");return}se(!0);try{const _=d(),p=[...ae,...ne,...de?[de]:[]],l=await Promise.all(p.map(async M=>{try{return await dr(M)}catch{return M}})),i=await Ce.tasks.createImageTask({modelId:F.id,prompt:_,ratio:fe,referenceImages:l.filter(Boolean),sourceNodeId:n,metadata:{imageSize:re}});if(!i.success)throw new Error(i.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const B=i.taskId;a({taskId:B}),f(B)}catch(_){h.error(_.message||"ç”Ÿæˆå¤±è´¥"),se(!1)}},f=async _=>{let l=0;const i=async()=>{try{const M=(await Ce.tasks.getTaskStatus(_)).task;if(M.status==="SUCCESS"){se(!1);const X=M.resultUrl;if(!X){h.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ie=(await cr({taskId:_,resultUrl:X,type:"IMAGE"})).displayUrl;a({generatedImageUrl:ie,taskId:"",modelId:F==null?void 0:F.id,mode:U,aspectRatio:fe,imageSize:re,userPrompt:ce}),U!=="single"||R(ie,fe,0),h.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else M.status==="FAILURE"?(se(!1),a({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${M.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(M.status==="PROCESSING"||M.status==="PENDING")&&(l++,l<300?setTimeout(i,2e3):(se(!1),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{se(!1),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};i()},w=async _=>{try{const{rows:p,cols:l}=Fr(U),i=await Xr(_,p,l);a({slicedImages:i.slices}),i.slices.forEach((B,M)=>{R(B,fe,M)})}catch(p){h.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+p.message)}},R=(_,p,l)=>{const i=A(n);if(!i)return;const{rows:B,cols:M}=Fr(U),X=B*M,V=280,ie=320,xe=20,oe=l%M,k=Math.floor(l/M),u=i.position.x+400,E=i.position.y-(X-1)*(ie+xe)/2,b={id:`${n}-preview-${l}-${Date.now()}`,type:"imagePreview",position:{x:u+oe*(V+xe),y:E+k*(ie+xe)},data:{imageUrl:_,ratio:p,label:`æº¶å›¾ ${l+1}`,fromStoryboard:!0,sourceNodeId:n}},Y={id:`edge-${n}-to-${b.id}`,source:n,target:b.id,sourceHandle:`${n}-source`,type:"aurora"};Z(ue=>[...ue,b]),z(ue=>[...ue,Y])},W=ae.length+ne.length+(de?1:0);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-slate-800 dark:text-white whitespace-nowrap",children:["è§’è‰² ",ae.length>0&&`(${ae.length})`]}),e.jsx(us,{type:"target",position:pt.Left,id:`${n}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-slate-800 dark:text-white whitespace-nowrap",children:["åœºæ™¯ ",ne.length>0?"âœ“":""]}),e.jsx(us,{type:"target",position:pt.Left,id:`${n}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!c})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-slate-800 dark:text-white whitespace-nowrap",children:["é£æ ¼ ",de?"âœ“":""]}),e.jsx(us,{type:"target",position:pt.Left,id:`${n}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!I})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(ps,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[W>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",W,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let _=1;const p=[];return ae.forEach(l=>{p.push({url:l,type:"char",index:_++})}),ne.forEach(l=>{p.push({url:l,type:"scene",index:_++})}),de&&p.push({url:de,type:"style",index:_++}),p.map(l=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:l.url,alt:`å›¾${l.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-purple-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:l.index})]},`${l.type}-${l.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{K("2K"),a({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="2K"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{K("4K"),a({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="4K"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(_=>e.jsx("button",{onClick:()=>{Q(_),a({aspectRatio:_})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${fe===_?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:_},_))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ee,value:ce,onChange:_=>{Ue(_.target.value),a({userPrompt:_.target.value});const p=_.target;p.style.height="auto",p.style.height=`${p.scrollHeight}px`},onFocus:_=>{const p=_.target;p.style.height="auto",p.style.height=`${p.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:m,onPointerDown:_=>_.stopPropagation(),onMouseDown:_=>_.stopPropagation(),disabled:he||!ce.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${he?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:he?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!j&&(O?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",r,"æ¬¡"]}):$!==null&&$>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[$,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(us,{type:"source",position:pt.Right,id:`${n}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},cn=t.memo(ln),dn=["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"],un="gemini-3-pro-preview",pn="gemini-3-pro-image-preview",jr=5,gn=({data:s,selected:N,id:n})=>{const[F,we]=t.useState(s.config.aspectRatio||"1:1"),[U,fe]=t.useState(s.config.inputImages||[]),[Q,re]=t.useState(s.config.userPrompt||""),[K,ce]=t.useState(!!s.config.taskId),[Ue,he]=t.useState(null),[se,ae]=t.useState(null),Ie=t.useMemo(()=>{const c=s.models||[];return c.find(I=>I.modelId===pn)||c.find(I=>{var L;return(L=I.modelId)==null?void 0:L.includes("gemini")})||c[0]},[s.models]);t.useEffect(()=>{Ie&&ae(Ie)},[Ie]);const{setNodes:ne,setEdges:ge,getNode:de,getNodes:me}=Zt(),Ee=Fs(c=>c.edges.filter(I=>I.target===n)),Z=t.useRef("");t.useEffect(()=>{const c=me(),I=[];Ee.forEach($=>{var O,r,v,g,a,y,d,m;if(I.length>=jr)return;const j=c.find(f=>f.id===$.source);if(j){const f=(r=(O=j.data)==null?void 0:O.config)==null?void 0:r.uploadedFiles;Array.isArray(f)&&f.forEach(R=>{I.length>=jr||R!=null&&R.url&&!I.includes(R.url)&&I.push(R.url)});const w=((v=j.data)==null?void 0:v.imageUrl)||((a=(g=j.data)==null?void 0:g.config)==null?void 0:a.generatedImageUrl)||((d=(y=j.data)==null?void 0:y.config)==null?void 0:d.imageUrl)||((m=j.data)==null?void 0:m.url);w&&!I.includes(w)&&I.push(w)}});const L=I.join(",");L!==Z.current&&(Z.current=L,fe(I),z({inputImages:I}))},[Ee,me]),t.useEffect(()=>{const c=s.config.taskId;(async()=>{if(c)try{const $=(await Ce.tasks.getTaskStatus(c)).task;if($.status==="SUCCESS"){ce(!1);const j=$.resultUrl;if(!j){z({taskId:""});return}const r=(await cr({taskId:c,resultUrl:j,type:"IMAGE"})).displayUrl;z({generatedImageUrl:r,taskId:""}),me().some(a=>{var y;return((y=a.data)==null?void 0:y.sourceNodeId)===n&&a.type==="imagePreview"})||await G(r)}else $.status==="PROCESSING"||$.status==="PENDING"?(ce(!0),S(c)):$.status==="FAILURE"&&(ce(!1),z({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${$.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ce(!1),z({taskId:""}),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const z=c=>{ne(I=>I.map(L=>L.id===n?{...L,data:{...L.data,config:{...L.data.config,...c}}}:L))},A=async()=>{var c,I;if(U.length===0){h.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!Q.trim()){h.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}ce(!0),he("text");try{const L=await Promise.all(U.map(y=>dr(y))),$="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",j="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚",O=await Ce.ai.text.generate({modelId:un,systemPrompt:$,prompt:Q,imageUrls:L});if(!O.success)throw new Error(O.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const r=((c=O.data)==null?void 0:c.text)||((I=O.data)==null?void 0:I.content)||O.content;if(!r||typeof r!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(he("image"),!se){h.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),ce(!1),he(null);return}const v=`${j}

åˆ†é•œæè¿°ï¼š
${r}

ç”Ÿæˆ${F}æ¯”ä¾‹çš„å›¾ç‰‡`,g=await Ce.tasks.createImageTask({modelId:se.id,prompt:v,ratio:F,referenceImages:L,sourceNodeId:n,metadata:{imageSize:"4K"}});if(!g.success)throw new Error(g.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const a=g.taskId;z({taskId:a,userPrompt:Q}),S(a)}catch(L){h.error(L.message||"ç”Ÿæˆå¤±è´¥"),ce(!1),he(null)}},S=async c=>{let L=0;const $=async()=>{try{const O=(await Ce.tasks.getTaskStatus(c)).task;if(O.status==="SUCCESS"){ce(!1),he(null);const r=O.resultUrl;if(!r){h.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const g=(await cr({taskId:c,resultUrl:r,type:"IMAGE"})).displayUrl;z({generatedImageUrl:g,taskId:"",aspectRatio:F}),await G(g),h.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else O.status==="FAILURE"?(ce(!1),he(null),z({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${O.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(O.status==="PROCESSING"||O.status==="PENDING")&&(L++,L<300?setTimeout($,2e3):(ce(!1),he(null),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ce(!1),he(null),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};$()},G=async c=>{var I;try{let L=c;if(!c.startsWith("data:"))try{const O=await Ce.assets.proxyDownload(c),r=new Blob([O],{type:"image/png"});L=await new Promise((v,g)=>{const a=new FileReader;a.onloadend=()=>v(a.result),a.onerror=g,a.readAsDataURL(r)})}catch{}const $=await Xr(L,3,3),j=[];for(let O=0;O<$.slices.length;O++)try{const r=$.slices[O],v=nn(r,"image/png"),g=new File([v],`storyboard_${n}_slice_${O+1}_${Date.now()}.png`,{type:"image/png"}),a=await Ce.assets.upload(g);a.success&&((I=a.data)!=null&&I.url)?j.push(a.data.url):j.push(r)}catch{j.push($.slices[O])}z({slicedImages:j}),x(j,F)}catch(L){h.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+L.message)}},x=(c,I)=>{const L=de(n);if(!L)return;const $=220,j=20,O=Date.now(),r=L.position.x+350,v=c.length*$+(c.length-1)*j,g=L.position.y-v/2+150,a=[],y=[];c.forEach((d,m)=>{const f={id:`${n}-slice-${O}-${m}`,type:"imagePreview",position:{x:r,y:g+m*($+j)},data:{imageUrl:d,ratio:I,label:`åˆ†é•œ ${m+1}`,fromStoryboard:!0,sourceNodeId:n,createdBy:L.data.createdBy}},w={id:`edge-${n}-to-slice-${O}-${m}`,source:n,target:f.id,sourceHandle:`${n}-source`,type:"aurora"};a.push(f),y.push(w)}),ne(d=>[...d,...a]),ge(d=>[...d,...y])};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${N?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(us,{type:"target",position:pt.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(us,{type:"source",position:pt.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[U.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",U.length,"/",jr,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:U.map((c,I)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:c,alt:`å›¾ç‰‡${I+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-purple-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:I+1})]},I))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:Q,onChange:c=>{re(c.target.value),z({userPrompt:c.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-purple-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:dn.map(c=>e.jsx("button",{onClick:()=>{we(c),z({aspectRatio:c})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${F===c?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:c},c))})]}),e.jsx("button",{type:"button",onClick:c=>{c.stopPropagation(),A()},disabled:K,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${K?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:K?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Ue==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"})]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},fn=t.memo(gn),hn="https://api.waule.com",mn=({isOpen:s,onClose:N,onAssetSelect:n})=>{const[F,we]=t.useState([]),[U,fe]=t.useState(""),[Q,re]=t.useState([]),[K,ce]=t.useState([]),[Ue,he]=t.useState(!1),[se,ae]=t.useState("ALL"),[Ie,ne]=t.useState("ALL");t.useEffect(()=>{s&&ge()},[s]),t.useEffect(()=>{U&&me(U)},[U]),t.useEffect(()=>{if(!s)return;const z=Ie==="ALL"?F:F.filter(A=>(A.category||"OTHER")===Ie);fe(z.length>0?z[0].id:"")},[Ie,F,s]);const ge=async()=>{try{const A=(await Ce.assetLibraries.getAll({includeShared:"true"})).data||[];if(we(A),A.length>0&&!U){const S=Ie==="ALL"?A:A.filter(G=>(G.category||"OTHER")===Ie);fe((S[0]||A[0]).id)}}catch{h.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const z=A=>{var G;const S=((G=A==null?void 0:A.detail)==null?void 0:G.libraryId)||U;ge(),S&&me(S)};return window.addEventListener("asset-library-updated",z),()=>window.removeEventListener("asset-library-updated",z)},[U]);const de=z=>(/^https?:\/\//.test(z)?z:`${hn}${z}`).replace(".oss-oss-",".oss-"),me=async z=>{var A,S,G,x,c;he(!0);try{const I=F.find($=>$.id===z);if(I&&(I.category||"OTHER")==="ROLE"){const j=(await Ce.assetLibraries.roles.list(z)).data||[],O=[];for(const r of j){const v=r.metadata||{},g=[(A=v.images)==null?void 0:A.frontAssetId,(S=v.images)==null?void 0:S.sideAssetId,(G=v.images)==null?void 0:G.backAssetId,(x=v.images)==null?void 0:x.faceAssetId].filter(Boolean),a=[];for(const d of g)try{const f=(await Ce.assets.getById(d)).data;a.push({id:f.id,url:de(f.url),name:f.name})}catch{}const y=r.thumbnail?de(r.thumbnail):((c=a[0])==null?void 0:c.url)||"";O.push({id:r.id,name:r.name,coverUrl:y,images:a})}ce(O),re([])}else{const j=(await Ce.assetLibraries.getAssets(z)).data||[];re(j),ce([])}}catch{h.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{he(!1)}},Ee=z=>{fe(z)},Z=z=>{n?(n(z),setTimeout(()=>{ge(),U&&me(U)},0)):h.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:N}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-purple-500/30 via-pink-500/50 to-cyan-500/30"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:N,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:F.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(z=>e.jsx("button",{onClick:()=>ae(z),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${se===z?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"}`,children:z==="IMAGE"?"å›¾ç‰‡":z==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},z))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(z=>e.jsx("button",{onClick:()=>ne(z),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${Ie===z?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"}`,children:z==="ROLE"?"è§’è‰²":z==="SCENE"?"åœºæ™¯":z==="PROP"?"é“å…·":z==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},z))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const z=Ie==="ALL"?F:F.filter(A=>(A.category||"OTHER")===Ie);return e.jsx("select",{value:U,onChange:A=>Ee(A.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:z.map(A=>{var S;return e.jsxs("option",{value:A.id,children:[A.isShared?`[å…±äº«] ${A.name}`:A.name," (",A._count.assets,")",A.isShared&&((S=A.owner)!=null&&S.nickname)?` - ${A.owner.nickname}`:""]},A.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Ue?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const z=F.find(G=>G.id===U);if(z&&(z.category||"OTHER")==="ROLE")return K.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:K.map(G=>e.jsxs("div",{onClick:()=>n&&n(G),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[G.coverUrl?e.jsx("img",{src:G.coverUrl,alt:G.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:G.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[G.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},G.id))});const S=Q.filter(G=>se==="ALL"||G.type===se);return S.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:S.map(G=>e.jsxs("div",{onClick:()=>Z(G),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[G.type==="IMAGE"?e.jsx("img",{src:de(G.url),alt:G.name,className:"w-full h-full object-cover"}):G.type==="VIDEO"?e.jsx("video",{src:de(G.url),className:"w-full h-full object-cover"}):G.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:G.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:G.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:G.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(G.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:G.type==="IMAGE"?"image":G.type==="VIDEO"?"video_file":G.type==="AUDIO"?"audio_file":"description"})})]},G.id))})})()})]})})]})]}):null},xn={agent:ho,aiImage:Ja,aiVideo:ur,soraVideo:Co,soraCharacter:_o,aiVideo_t2v:Ka,aiVideo_i2v_first:Qa,aiVideo_i2v_last:to,aiVideo_first_last:ro,aiVideo_reference:oo,aiVideo_swap:io,aiVideo_lipsync:co,aiVideo_style:go,upload:xo,assetSelector:wo,imagePreview:ko,videoPreview:No,textPreview:Io,midjourney:So,audioVoice:Uo,voiceClone:$o,audioSynthesize:Do,audioDesign:Vo,audioPreview:Oo,superCanvas:Fo,videoUpscale:Bo,commercialVideo:Xo,textAnnotation:Yo,imageEditing:Zo,hdUpscale:on,imageFusion:cn,smartStoryboard:fn},bn={aurora:Po},wn=()=>{const{id:s,projectId:N,episodeId:n,workflowId:F}=xa(),we=!!F,U=ba(),fe=Sr(),Q=t.useMemo(()=>new URLSearchParams(fe.search),[fe.search]),re=t.useMemo(()=>{const o=Number(Q.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[Q]),K=t.useMemo(()=>{const o=Number(Q.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[Q]),ce=t.useMemo(()=>{try{const o=Q.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[Q]),{screenToFlowPosition:Ue,setCenter:he,getViewport:se,fitView:ae}=Zt(),{setTitle:Ie}=ya(),ne=Er(o=>o.user),[ge,de]=t.useState(null),[me,Ee]=t.useState(null),[Z,z]=t.useState(!0),[A,S,G]=Na([]),[x,c,I]=ja([]),[L,$]=t.useState(!1),j=t.useRef(!1),[O,r]=t.useState(null),[v,g]=t.useState(null),[a,y]=t.useState(!0),d=t.useRef(null),[m,f]=t.useState(!1),w=t.useRef(null),R=t.useRef(null),[W,_]=t.useState(!1),[p,l]=t.useState(null),[i,B]=t.useState([]),[M,X]=t.useState([]),[V,ie]=t.useState(null),[xe,oe]=t.useState(null),k=t.useRef(null),u=t.useRef(null),E=V==="video",b=V==="edit",Y=V==="imageEdit",ue=o=>ie(null),H=o=>ie(o?"video":null),pe=o=>ie(o?"edit":null),Se=o=>ie(o?"imageEdit":null),Ne=k,Re=xe==="agent",Ae=o=>oe(o?"agent":null),_e=u,$e=u,le=t.useCallback(o=>{const C=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return C?C.includes("æ–‡ç”Ÿ")||C.includes("text to video")||C.includes("t2v")||C.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":C.includes("é¦–å°¾")||C.includes("first last")||C.includes("two frame")||C.includes("frame pair")||C.includes("first-last")?"é¦–å°¾å¸§":C.includes("é¦–å¸§")||C.includes("first frame")||C.includes("start frame")||C.includes("initial frame")||C.includes("keyframe")?"é¦–å¸§":C.includes("å°¾å¸§")||C.includes("last frame")||C.includes("end frame")||C.includes("final frame")?"å°¾å¸§":C.includes("ä¸»ä½“å‚è€ƒ")||C.includes("subject reference")||C.includes("å‚è€ƒ")||C.includes("reference image")||C.includes("image reference")||C.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ge=t.useMemo(()=>{const o=new Set;return(i||[]).filter(D=>(D.type||"")==="VIDEO_GENERATION").forEach(D=>{var ee;(Array.isArray((ee=D==null?void 0:D.config)==null?void 0:ee.supportedGenerationTypes)?D.config.supportedGenerationTypes:[]).forEach(ve=>{const Me=le(ve);Me&&o.add(Me)})}),o},[i,le]),Ze=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Wt=t.useCallback(o=>{const C=(i||[]).filter(ee=>(ee.type||"")==="VIDEO_EDITING").filter(ee=>{var ve;return Array.isArray((ve=ee==null?void 0:ee.config)==null?void 0:ve.supportedEditingCapabilities)&&ee.config.supportedEditingCapabilities.includes(o)}),D=(i||[]).filter(ee=>(ee.type||"")==="VIDEO_GENERATION").filter(ee=>{var He,Fe;if(o!=="è§†é¢‘æ¢äºº")return!1;const ve=((He=ee==null?void 0:ee.config)==null?void 0:He.supportsVideoEditing)===!0,Pe=(Array.isArray((Fe=ee==null?void 0:ee.config)==null?void 0:Fe.supportedGenerationTypes)?ee.config.supportedGenerationTypes:[]).some(rt=>le(rt)==="è§†é¢‘æ¢äºº");return ve||Pe}),q={};return[...C,...D].forEach(ee=>{q[ee.id]||(q[ee.id]=ee)}),Object.values(q)},[i,le]),[Ct,_t]=t.useState(!1),[dt,gt]=t.useState(null),vt=t.useRef(null),lt=t.useRef(),[Ye,yt]=t.useState([]),[Be,wt]=t.useState(null),[Yt,ks]=t.useState(null),[Is,Ss]=t.useState(!1),[vs,Bs]=t.useState(null),[gs,Hs]=t.useState(null),[Xs,nr]=t.useState(null),Tt=t.useRef([]),Js=t.useRef(null),[bs,er]=t.useState(!1),[ws,tr]=t.useState(!1),[sr,rr]=t.useState(0),Ps=t.useRef(null),J=t.useRef(null),te=t.useRef([]),De=t.useRef([]),Ve=t.useRef(0),qe=!!n,Le=qe&&!!re&&!!K,tt=we?F:Le?`${n}-${re}-${K}`:qe?n:s,it=Le,[T,P]=t.useState(!1),be=t.useRef(new Set),Te=t.useRef(new Set),je=t.useRef(new Set),ye=t.useRef(new Set),et=t.useRef(new Map),st=t.useRef(new Set),kt=t.useCallback((o,C)=>{C!==d.current&&(be.current.add(o.id),S(D=>D.some(q=>q.id===o.id)?D:[...D,{...o,data:{...o.data,models:i}}]))},[i,S]),ft=t.useCallback((o,C,D)=>{D!==d.current&&(st.current.add(o),S(q=>q.map(ee=>ee.id===o?{...ee,data:{...ee.data,...C}}:ee)),setTimeout(()=>st.current.delete(o),100))},[S]),We=t.useCallback((o,C)=>{C!==d.current&&(S(D=>D.filter(q=>q.id!==o)),c(D=>D.filter(q=>q.source!==o&&q.target!==o)))},[S,c]),Dt=t.useCallback((o,C,D)=>{D!==d.current&&S(q=>q.map(ee=>ee.id===o?{...ee,position:C}:ee))},[S]),Xt=t.useCallback((o,C)=>{C!==d.current&&S(D=>D.map(q=>{const ee=o.find(ve=>ve.id===q.id);return ee?{...q,position:ee.position}:q}))},[S]),Lt=t.useCallback((o,C)=>{C!==d.current&&(Te.current.add(o.id),c(D=>D.some(q=>q.id===o.id)?D:[...D,o]))},[c]),zt=t.useCallback((o,C)=>{C!==d.current&&c(D=>D.filter(q=>q.id!==o))},[c]),At=t.useCallback((o,C)=>{C!==d.current&&(yt(o),Tt.current=o)},[]),{emitNodeAdd:Ut,emitNodeUpdate:Vt,emitNodeDelete:Ft,emitNodesMove:ts,emitEdgeAdd:rs,emitEdgeDelete:ys,emitGroupsUpdate:qs,onlineUsers:Es}=Ba({workflowId:w.current,isSharedWorkflow:m,isReadOnly:L,onNodeAdd:kt,onNodeUpdate:ft,onNodeDelete:We,onNodeMove:Dt,onNodesMove:Xt,onEdgeAdd:Lt,onEdgeDelete:zt,onGroupsUpdate:At});t.useEffect(()=>{Tt.current=Ye},[Ye]),t.useEffect(()=>{te.current=A,Ve.current=A.length},[A]),t.useEffect(()=>{De.current=x},[x]),t.useEffect(()=>{if(!T){je.current=new Set(A.map(ee=>ee.id));const q=new Map;A.forEach(ee=>{var ve;try{q.set(ee.id,JSON.stringify(((ve=ee.data)==null?void 0:ve.config)||{}))}catch{q.set(ee.id,"{}")}}),et.current=q;return}if(!m||j.current){je.current=new Set(A.map(q=>q.id));return}const o=new Set(A.map(q=>q.id)),C=je.current;A.forEach(q=>{var ee,ve;if(!C.has(q.id))be.current.has(q.id)||Ut(q);else if(!st.current.has(q.id))try{const Me=JSON.stringify(((ee=q.data)==null?void 0:ee.config)||{}),Pe=et.current.get(q.id)||"{}";Me!==Pe&&Vt(q.id,{config:(ve=q.data)==null?void 0:ve.config})}catch{}}),je.current=o;const D=new Map;A.forEach(q=>{var ee;try{D.set(q.id,JSON.stringify(((ee=q.data)==null?void 0:ee.config)||{}))}catch{D.set(q.id,"{}")}}),et.current=D,be.current=new Set([...be.current].filter(q=>o.has(q)))},[A,m,T,Ut,Vt]),t.useEffect(()=>{if(!T){ye.current=new Set(x.map(D=>D.id));return}if(!m||j.current){ye.current=new Set(x.map(D=>D.id));return}const o=new Set(x.map(D=>D.id)),C=ye.current;x.forEach(D=>{C.has(D.id)||Te.current.has(D.id)||rs(D)}),ye.current=o,Te.current=new Set([...Te.current].filter(D=>o.has(D)))},[x,m,T,rs]);const fs=t.useCallback(o=>{var ee;if(j.current)return!1;if(a)return!0;if(Tt.current.some(ve=>{var Me;return!ve.hidden&&((Me=ve.nodeIds)==null?void 0:Me.includes(o.id))}))return!1;if(Le)return!0;const D=(ee=o.data)==null?void 0:ee.createdBy;return(typeof D=="object"?D==null?void 0:D.id:D)===d.current},[a,Le]),Bt=t.useMemo(()=>{const o=new Set(Ye.filter(C=>!C.hidden).flatMap(C=>C.nodeIds||[]));return A.map(C=>{const D=o.has(C.id),q=D?!1:a?!0:fs(C);return{...C,draggable:C.draggable!==!1,connectable:D?!1:C.connectable!==!1,data:{...C.data,_canEdit:q,_isGrouped:D,_currentUserId:v,_isSharedWorkflow:m}}})},[A,Ye,a,fs,v,m,L]),Jt=t.useRef(null),as=t.useRef(new Map),ds=t.useCallback(o=>{if(j.current){G(o);return}const C=o.filter(q=>{var He;if(q.type!=="position")return!0;if(Tt.current.find(Fe=>{var rt;return!Fe.hidden&&((rt=Fe.nodeIds)==null?void 0:rt.includes(q.id))}))return a;if(a)return!0;const ve=te.current.find(Fe=>Fe.id===q.id);if(!ve)return!0;const Me=(He=ve.data)==null?void 0:He.createdBy;return(typeof Me=="object"?Me==null?void 0:Me.id:Me)===d.current});G(C);const D=C.filter(q=>q.type==="position"&&q.position);D.length>0&&(D.forEach(q=>{as.current.set(q.id,q.position)}),Jt.current&&clearTimeout(Jt.current),Jt.current=setTimeout(()=>{const q=Array.from(as.current.entries()).map(([ee,ve])=>({id:ee,position:ve}));q.length>0&&(ts(q),as.current.clear())},100))},[a,G,ts]);t.useEffect(()=>{Js.current=gs},[gs]),t.useEffect(()=>{const o=C=>{C.key==="Escape"&&(bs&&er(!1),ws&&tr(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,ws]),t.useEffect(()=>{tt&&(_(!1),P(!1),Os(),Jr(),qr(),ss().finally(()=>{P(!0)}))},[tt]),t.useEffect(()=>{if(!Z&&!W&&A.length>0){const o=setTimeout(()=>{ae({padding:.1,duration:800,maxZoom:1.5}),_(!0)},100);return()=>clearTimeout(o)}},[Z,W,A.length,ae]),t.useEffect(()=>{var q;if(!Le||!me||!ge||!T)return;const o=Ye.find(ee=>ee.scene===re&&ee.shot===K),C=`${re}-${K}`;if(o){ks(o.id),wt(o.id);try{if(R.current===C)return;if(Array.isArray(ce)&&ce.length>0){R.current=C;const ee=A,ve=[],Me=280,Pe=320,He=350,Fe={role:0,scene:0,prop:0,audio:0};ee.forEach(Oe=>{var mt;if(Oe.type==="assetSelector"){const Pt=((mt=Oe.data)==null?void 0:mt.label)||"";Pt.startsWith("è§’è‰²")?Fe.role++:Pt.startsWith("åœºæ™¯")?Fe.scene++:Pt.startsWith("é“å…·")?Fe.prop++:Pt.startsWith("éŸ³é¢‘")&&Fe.audio++}});const rt={...Fe},Xe=[];ce.forEach((Oe,mt)=>{const Pt=Oe.thumbnail||Oe.url||"";let Rt=null;const Ot=ee.some(ot=>{var Mt,Ke;if(ot.type!=="assetSelector")return!1;const Qe=(Mt=ot.data)==null?void 0:Mt.config,ke=Qe==null?void 0:Qe.selectedAsset;if((ke==null?void 0:ke.id)===Oe.id)return Rt=ot.id,!0;const Je=((Ke=ot.data)==null?void 0:Ke.label)||"",jt=Oe.type==="role"?"è§’è‰²":Oe.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${jt}: ${Oe.name}`||(ke==null?void 0:ke.name)===Oe.name?(Rt=ot.id,!0):!1});if(Ot&&Rt&&Pt&&Xe.push({nodeId:Rt,newUrl:Pt}),Ot)return;const ht=Oe.type,xt=ht==="role"?0:ht==="scene"?1:ht==="prop"?2:3,Nt=rt[ht]||0;rt[ht]=(rt[ht]||0)+1;const Ht={x:xt*Me,y:He+Nt*Pe},ct=Oe.thumbnail||Oe.url||"",ze=`assetSelector-${Date.now()}-${mt}`,nt=ht==="role"?"è§’è‰²":ht==="scene"?"åœºæ™¯":ht==="prop"?"é“å…·":"éŸ³é¢‘",ut=Oe.metadata,at=ht==="role"&&(ut==null?void 0:ut.images);let qt=[];if(at){const ot=ut.images;ot.frontUrl&&qt.push({id:"front",url:ot.frontUrl,name:`${Oe.name}-æ­£é¢`}),ot.sideUrl&&qt.push({id:"side",url:ot.sideUrl,name:`${Oe.name}-ä¾§é¢`}),ot.backUrl&&qt.push({id:"back",url:ot.backUrl,name:`${Oe.name}-èƒŒé¢`}),ot.faceUrl&&qt.push({id:"face",url:ot.faceUrl,name:`${Oe.name}-é¢éƒ¨`})}let $t;at&&qt.length>0?$t={selectedInput:{id:Oe.id,name:Oe.name,coverUrl:ct,images:qt}}:ht==="audio"?$t={selectedAsset:{id:Oe.id,name:Oe.name,originalName:Oe.name,url:Oe.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:$t={selectedAsset:{id:Oe.id,name:Oe.name,originalName:Oe.name,url:ct,type:"IMAGE",mimeType:"image/png",size:0}},ve.push({id:ze,type:"assetSelector",position:Ht,data:{id:ze,label:`${nt}: ${Oe.name}`,config:$t,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:ge,episode:me,nodeGroup:o,nodeGroups:Ye}}})}),Xe.length>0&&S(Oe=>Oe.map(mt=>{var Rt;const Pt=Xe.find(Ot=>Ot.nodeId===mt.id);if(Pt&&mt.type==="assetSelector"){const Ot=((Rt=mt.data)==null?void 0:Rt.config)||{},ht=Ot.selectedAsset||{};return{...mt,data:{...mt.data,config:{...Ot,selectedAsset:{...ht,url:Pt.newUrl}}}}}return mt})),ve.length>0&&S(Oe=>[...Oe,...ve])}}catch{}return}if(R.current===C)return;const D={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${re}å¹•-ç¬¬${K}é•œ`,scene:re,shot:K,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};yt(ee=>[...ee,D]),Tt.current=[...Tt.current,D],ks(D.id),wt(D.id),R.current=C;try{const ee=((q=me==null?void 0:me.scriptJson)==null?void 0:q.acts)||[],ve=Array.isArray(ee)?ee.find(ze=>Number(ze.actIndex)===Number(re)):null,Me=ve?(ve.shots||[]).find(ze=>Number(ze.shotIndex)===Number(K)):null,He=Me?[`ç”»é¢ï¼š${(Me.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(Me["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(Me["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(Me["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(Me.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=Me&&(Me.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,Oe=280,mt=320,Pt=350,Rt={x:0,y:0},Ot={x:rt+Xe,y:0},ht=`textPreview-${Date.now()}-a`,xt=`textPreview-${Date.now()}-b`,Nt=[{id:ht,type:"textPreview",position:Rt,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:ht,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:ge,episode:me,nodeGroup:D,nodeGroups:[...Ye,D]}}},{id:xt,type:"textPreview",position:Ot,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:xt,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:ge,episode:me,nodeGroup:D,nodeGroups:[...Ye,D]}}}],Ht=[];if(Array.isArray(ce)&&ce.length>0){const ze={role:0,scene:0,prop:0,audio:0};ce.forEach((nt,ut)=>{const at=nt.type,qt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,$t=ze[at]||0;ze[at]=(ze[at]||0)+1;const ot={x:qt*Oe,y:Pt+$t*mt},Qe=`assetSelector-${Date.now()}-${ut}`;Ht.push(Qe);const ke=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=nt.thumbnail||nt.url||"",jt=nt.metadata,Mt=at==="role"&&(jt==null?void 0:jt.images);let Ke=[];if(Mt){const bt=jt.images;bt.frontUrl&&Ke.push({id:"front",url:bt.frontUrl,name:`${nt.name}-æ­£é¢`}),bt.sideUrl&&Ke.push({id:"side",url:bt.sideUrl,name:`${nt.name}-ä¾§é¢`}),bt.backUrl&&Ke.push({id:"back",url:bt.backUrl,name:`${nt.name}-èƒŒé¢`}),bt.faceUrl&&Ke.push({id:"face",url:bt.faceUrl,name:`${nt.name}-é¢éƒ¨`})}let It;Mt&&Ke.length>0?It={selectedInput:{id:nt.id,name:nt.name,coverUrl:Je,images:Ke}}:at==="audio"?It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:nt.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},Nt.push({id:Qe,type:"assetSelector",position:ot,data:{id:Qe,label:`${ke}: ${nt.name}`,config:It,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:ge,episode:me,nodeGroup:D,nodeGroups:[...Ye,D]}}})})}S(ze=>[...ze,...Nt]);const ct=[ht,xt,...Ht];yt(ze=>ze.map(nt=>{if(nt.id!==D.id)return nt;const ut=Array.from(new Set([...nt.nodeIds||[],...ct])),at=nt.bounds;return{...nt,nodeIds:ut,bounds:at}})),Tt.current=Tt.current.map(ze=>{if(ze.id!==D.id)return ze;const nt=Array.from(new Set([...ze.nodeIds||[],...ct])),ut=ze.bounds;return{...ze,nodeIds:nt,bounds:ut}})}catch{}},[qe,re,K,me,ge,Ye,S,T,ce]),t.useEffect(()=>{if(ge)if(qe&&me){const o=`${ge.name} - ${me.name||`ç¬¬${me.episodeNumber}é›†`}`,C=re&&K?`ç¬¬${re}å¹•ç¬¬${K}é•œ`:"";Ie(Le?o:`${o} ${C}`.trim())}else Ie(ge.name);return()=>Ie("")},[ge,me,qe,Le,re,K,Ie]),t.useEffect(()=>{if(!(!tt||Z||j.current))return lt.current&&clearTimeout(lt.current),lt.current=setTimeout(()=>{Ys()},2e3),()=>{lt.current&&clearTimeout(lt.current)}},[A,x,Ye]);const ss=async()=>{var o,C,D,q,ee,ve;try{let Me;if(we&&F)Me=await Ce.workflows.getById(F);else if(Le)Me=await Ce.workflows.getOrCreateByShot(N,n,re,K);else if(qe)Me=await Ce.workflows.getOrCreateByEpisode(N,n);else{if(!s)return;Me=await Ce.workflows.getOrCreateByProject(s)}const Pe=Me.data;Pe.canEdit===!1||Pe.canEdit===void 0&&Pe.isOwner===!1?($(!0),j.current=!0,(o=Pe.shareInfo)!=null&&o.owner&&r(Pe.shareInfo.owner)):($(!1),j.current=!1,r(null)),Pe.currentUserId&&(g(Pe.currentUserId),d.current=Pe.currentUserId);const Fe=Pe.isOwner!==!1||Le&&Pe.canEdit===!0;y(Fe);const rt=we||Pe.hasCollaborators===!0;if(f(rt),w.current=Pe.id,we&&de({id:Pe.projectId||F,name:Pe.name||"å…±äº«å·¥ä½œæµ",description:Pe.description,type:"QUICK",status:"DRAFT"}),Pe.data){const{nodes:Xe,edges:Oe,nodeGroups:mt}=Pe.data;if(mt&&mt.length>0&&(yt(mt),Tt.current=mt),Xe&&Xe.length>0){let Pt=Xe;if(Le&&((C=me==null?void 0:me.scriptJson)!=null&&C.acts))try{const Nt=me.scriptJson.acts.find(ze=>Number(ze.actIndex)===Number(re)),Ht=(D=Nt==null?void 0:Nt.shots)==null?void 0:D.find(ze=>Number(ze.shotIndex)===Number(K)),ct=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(ze=>{ze.nodeId&&ct.add(ze.nodeId)}),(q=Ht.media)!=null&&q.nodeId&&ct.add(Ht.media.nodeId)),Pt=Xe.map(ze=>{var nt;return ze.type==="videoPreview"&&((nt=ze.data)!=null&&nt.addedToStoryboard)&&!ct.has(ze.id)?{...ze,data:{...ze.data,addedToStoryboard:!1}}:ze})}catch{}let Rt;if(Le&&((ee=me==null?void 0:me.scriptJson)!=null&&ee.acts))try{const Nt=me.scriptJson.acts.find(ct=>Number(ct.actIndex)===Number(re)),Ht=(ve=Nt==null?void 0:Nt.shots)==null?void 0:ve.find(ct=>Number(ct.shotIndex)===Number(K));Rt=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Ot=new Set((mt||[]).filter(xt=>!xt.hidden).flatMap(xt=>xt.nodeIds||[])),ht=Pt.map(xt=>{const Nt=mt?mt.find(ze=>ze.nodeIds.includes(xt.id)):null,Ht=i.length>0?i:xt.data.models||[],ct=xt.type==="agent"&&Rt?{...xt.data,output:Rt,lastOutput:Rt}:xt.data;return{...xt,data:{...ct,models:Ht,onOpenAssetPanel:xt.type==="assetSelector"?xt.data.onOpenAssetPanel||ar:xt.data.onOpenAssetPanel,workflowContext:{project:ge,episode:me,nodeGroup:Nt,nodeGroups:mt||[]}},draggable:xt.draggable!==!1,connectable:Ot.has(xt.id)?!1:xt.connectable!==!1,deletable:Ot.has(xt.id)?!1:xt.deletable!==!1}});S(ht)}if(Oe&&Oe.length>0){const Pt=new Set(Xe.map(ht=>ht.id)),Rt=new Map(Xe.map(ht=>[ht.id,ht.type])),Ot=Oe.filter(ht=>{if(!Pt.has(ht.source)||!Pt.has(ht.target))return!1;const xt=Rt.get(ht.target),Nt=Rt.get(ht.source);return!(xt==="midjourney"&&ht.targetHandle==="text-input"&&Nt!=="agent")}).map(ht=>({...ht,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:ht.targetHandle||void 0}));c(Ot)}}}catch{}};t.useEffect(()=>{i.length>0&&A.length>0&&S(o=>o.map(C=>({...C,data:{...C.data,models:i},draggable:C.draggable!==void 0?C.draggable:!0,deletable:C.deletable!==void 0?C.deletable:!0})))},[i,A.length]),t.useEffect(()=>{if(!ge&&!me||A.length===0)return;if(A.some(C=>{var Me,Pe;const D=C.data.workflowContext,q=((Me=D==null?void 0:D.project)==null?void 0:Me.id)!==(ge==null?void 0:ge.id),ee=((Pe=D==null?void 0:D.episode)==null?void 0:Pe.id)!==(me==null?void 0:me.id),ve=(D==null?void 0:D.nodeGroups)!==Tt.current;return!D||q||ee||ve})){const C=re&&K&&Tt.current.find(D=>D.scene===re&&D.shot===K)||null;S(D=>D.map(q=>{const ee=Tt.current.find(Me=>Me.nodeIds.includes(q.id))||null,ve=C||ee;return{...q,data:{...q.data,workflowContext:{project:ge,episode:me,nodeGroup:ve,nodeGroups:Tt.current}}}}))}},[ge,me,re,K,A.length,Ye]);const Ls=async(o,C,D)=>{var q;if(!(!N||!n))try{const ee=o.find(Fe=>Fe.type==="agent");if(!ee)return;const ve=((q=ee.data)==null?void 0:q.output)||"",Pe=(await Ce.episodes.getById(N,n)).scriptJson;if(!Pe||!Pe.acts)return;const He=Pe.acts.map(Fe=>{var rt;return Fe.actIndex===C?{...Fe,shots:(rt=Fe.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===D&&Xe.æç¤ºè¯!==ve?{...Xe,æç¤ºè¯:ve}:Xe)}:Fe});await Ce.episodes.update(N,n,{scriptJson:{acts:He}})}catch{}},Ns=async()=>{if(!(L||j.current)&&!(te.current.length===0&&De.current.length===0))try{const o=te.current.map(D=>{const{data:q,...ee}=D,{workflowContext:ve,_canEdit:Me,_currentUserId:Pe,...He}=q||{};return{...ee,data:He}}),C=De.current.map(D=>({id:D.id,source:D.source,target:D.target,sourceHandle:D.sourceHandle,targetHandle:D.targetHandle,type:D.type}));if(Le){await Ce.workflows.saveShot(N,n,re,K,{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}});try{await Ls(te.current,re,K)}catch{}}else qe?await Ce.workflows.saveEpisode(N,n,{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}}):we&&F?await Ce.workflows.update(F,{data:{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}}}):s&&await Ce.workflows.save(s,{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}})}catch{}},hs=t.useRef(null),Ys=t.useCallback(()=>{hs.current&&clearTimeout(hs.current),hs.current=setTimeout(()=>{Ns()},2e3)},[]);t.useEffect(()=>{if(ge||me){let o=Tt.current;Le&&re&&K&&(o=Tt.current.filter(C=>C.scene===re&&C.shot===K)),window.__workflowContext={project:ge,episode:me,nodeGroups:o}}},[ge,me,Ye,Le,re,K]);const Os=async()=>{try{if(we){window.__workflowContext={project:null,episode:null,nodeGroups:Tt.current};return}if(qe){const[o,C]=await Promise.all([Ce.episodes.getById(N,n),Ce.projects.getById(N)]);Ee(o.data),de(C.data);let D=Tt.current;Le&&re&&K&&(D=Tt.current.filter(q=>q.scene===re&&q.shot===K)),window.__workflowContext={project:C.data,episode:o.data,nodeGroups:D}}else{const o=await Ce.projects.getById(s);de(o.data);let C=Tt.current;Le&&re&&K&&(C=Tt.current.filter(D=>D.scene===re&&D.shot===K)),window.__workflowContext={project:o.data,episode:null,nodeGroups:C}}}catch{h.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),U("/quick")}finally{z(!1)}},Jr=async()=>{try{const o=await Ce.get("/ai/models",{params:{isActive:"true"}});B(o||[])}catch{}};t.useEffect(()=>{S(o=>o.map(C=>{const D=String(C.type||"");return!D.startsWith("aiVideo")&&D!=="audioVoice"&&D!=="voiceClone"&&D!=="audioSynthesize"&&D!=="audioDesign"?C:{...C,data:{...C.data,models:i}}}))},[i,S]);const qr=async()=>{try{const C=(await Ce.agents.getAll()).filter(D=>D.isActive);X(C)}catch{}};t.useEffect(()=>{S(o=>o.map(C=>{var Pe,He,Fe,rt,Xe;if(C.type!=="agent")return C;const D=(He=(Pe=C.data)==null?void 0:Pe.config)==null?void 0:He.agentId,q=M.find(Oe=>Oe.id===D),ee=q==null?void 0:q.aiModelId,ve=i.find(Oe=>Oe.id===ee);let Me=(Fe=ve==null?void 0:ve.config)==null?void 0:Fe.acceptedInputs;if((!Me||Me.length===0)&&ve){const Oe=(ve.provider||"").toLowerCase(),mt=(ve.name||"").toLowerCase();(Oe.includes("google")||mt.includes("gemini"))&&(Me=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(Me)&&Me.length>0){const Oe=(Xe=(rt=C.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,mt=Pt=>Pt.map(Rt=>Rt.toUpperCase()).sort().join(",");if(!Oe||mt(Oe)!==mt(Me))return{...C,data:{...C.data,config:{...C.data.config,acceptedInputs:Me}}}}return C}))},[M,i,S]);const Yr=t.useCallback(o=>{var Pe,He,Fe,rt,Xe,Oe,mt,Pt,Rt,Ot,ht,xt,Nt,Ht,ct,ze,nt;Qt.current=!1;const C=Tt.current.some(ut=>{var at;return!ut.hidden&&((at=ut.nodeIds)==null?void 0:at.includes(o.source||""))}),D=Tt.current.some(ut=>{var at;return!ut.hidden&&((at=ut.nodeIds)==null?void 0:at.includes(o.target||""))});if(C||D){h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Qt.current=!1;return}const q=A.find(ut=>ut.id===o.source),ee=A.find(ut=>ut.id===o.target);if(q&&ee){const ut=$t=>{var ke,Je,jt;const ot=$t.type,Qe=$t.data;if(ot==="upload"&&Array.isArray((ke=Qe.config)==null?void 0:ke.uploadedFiles)&&Qe.config.uploadedFiles.length>0){const Mt=Qe.config.uploadedFiles,Ke=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="VIDEO"||js.startsWith("video/")}),It=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="IMAGE"||js.startsWith("image/")}),bt=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="AUDIO"||js.startsWith("audio/")});return(ee==null?void 0:ee.type)==="aiVideo_swap"?Ke?"VIDEO":It?"IMAGE":bt?"AUDIO":null:It?"IMAGE":Ke?"VIDEO":bt?"AUDIO":null}if(ot==="assetSelector"){if((Je=Qe.config)!=null&&Je.subjects)return"IMAGE";if((jt=Qe.config)!=null&&jt.selectedAsset){const Mt=Qe.config.selectedAsset,Ke=(Mt.type||"").toUpperCase(),It=(Mt.mimeType||"").toLowerCase();return Ke==="IMAGE"||It.startsWith("image/")?"IMAGE":Ke==="VIDEO"||It.startsWith("video/")?"VIDEO":Ke==="AUDIO"||It.startsWith("audio/")?"AUDIO":Ke||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=ut(q);let qt=(Pe=ee.data.config)==null?void 0:Pe.acceptedInputs;if(ee.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const $t={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${$t[at]||at}è¾“å…¥`),Qt.current=!1;return}if((!qt||qt.length===0)&&ee.data.type==="agent"){const $t=(He=ee.data.config)==null?void 0:He.agentId,ot=M.find(jt=>jt.id===$t),Qe=ot==null?void 0:ot.aiModelId,ke=i.find(jt=>jt.id===Qe),Je=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)qt=Je;else{const jt=((rt=ke==null?void 0:ke.provider)==null?void 0:rt.toLowerCase())||"",Mt=((ke==null?void 0:ke.name)||"").toLowerCase();(jt.includes("google")||Mt.includes("gemini"))&&(qt=["TEXT","IMAGE","DOCUMENT"])}}if(ee.type!=="agent"){if(!ee.type.startsWith("aiVideo")&&qt&&qt.length>0&&at){const $t=qt.map(Qe=>typeof Qe=="string"?Qe.toUpperCase():Qe),ot=typeof at=="string"?at.toUpperCase():at;if(!$t.includes(ot)){const Qe={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${Qe[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${$t.map(ke=>Qe[ke]||ke).join("ã€")}ï¼‰`),Qt.current=!1;return}}}if(ee.type==="aiVideo_swap"){const $t=x.filter(jt=>jt.target===ee.id),ot=$t.filter(jt=>{const Mt=A.find(It=>It.id===jt.source);return ut(Mt)==="VIDEO"}).length,Qe=$t.filter(jt=>{const Mt=A.find(It=>It.id===jt.source);return ut(Mt)==="IMAGE"}).length,ke=ot+(at==="VIDEO"?1:0),Je=Qe+(at==="IMAGE"?1:0);if(ke>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){h.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Qt.current=!1;return}}if(ee.type==="aiVideo_lipsync"){const $t=x.filter(Mt=>Mt.target===ee.id),ot=$t.filter(Mt=>{const Ke=A.find(bt=>bt.id===Mt.source);return ut(Ke)==="VIDEO"}).length,Qe=$t.filter(Mt=>{const Ke=A.find(bt=>bt.id===Mt.source);return ut(Ke)==="AUDIO"}).length,ke=ot+(at==="VIDEO"?1:0),Je=Qe+(at==="AUDIO"?1:0),jt=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ke>1||Je>1||!jt){h.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Qt.current=!1;return}}if(ee.type.startsWith("aiVideo")&&ee.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(Qe=>{const ke=(Qe||"").toLowerCase().replace(/[_\-\s]+/g," ");return ke?ke.includes("æ–‡ç”Ÿ")||ke.includes("text to video")||ke.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")||ke.includes("first last")||ke.includes("two frame")||ke.includes("frame pair")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")||ke.includes("first frame")||ke.includes("start frame")||ke.includes("initial frame")||ke.includes("keyframe")?"é¦–å¸§":ke.includes("å°¾å¸§")||ke.includes("last frame")||ke.includes("end frame")||ke.includes("final frame")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")||ke.includes("subject reference")||ke.includes("å‚è€ƒ")||ke.includes("reference image")||ke.includes("image reference")||ke.includes("ref image")?"å‚è€ƒå›¾":Qe||"":""})((Oe=(Xe=ee.data)==null?void 0:Xe.config)==null?void 0:Oe.generationType);if(ee.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){h.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Qt.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&q.type==="assetSelector"){const Qe=((mt=q.data)==null?void 0:mt.config)||{};if(Qe.subjects&&Qe.subjects.length>0&&(Qe.subjects[0].images||[]).length>1){h.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Qt.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&q.type==="assetSelector"){const Qe=((Pt=q.data)==null?void 0:Pt.config)||{};if(Qe.subjects&&Qe.subjects.length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Qt.current=!1;return}}}if(ee.type==="aiVideo_style"){const Qe=x.filter(ke=>ke.target===ee.id).filter(ke=>{const Je=A.find(Mt=>Mt.id===ke.source);return ut(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){h.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Qt.current=!1;return}if(Qe>1){h.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Qt.current=!1;return}}if(ee.type.startsWith("aiVideo")&&at==="TEXT"&&x.filter(Qe=>Qe.target===ee.id).find(Qe=>{const ke=A.find(Je=>Je.id===Qe.source);return(ke==null?void 0:ke.type)==="agent"})){h.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}if(ee.type==="aiImage"){if(at==="TEXT"){if(x.filter(Qe=>Qe.target===ee.id).some(Qe=>{const ke=A.find(Je=>Je.id===Qe.source);return(ke==null?void 0:ke.type)==="agent"})){h.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}}else if(at==="IMAGE"){const ot=x.filter(Ke=>Ke.target===ee.id).reduce((Ke,It)=>{var Kt,js,es,Rs,Cs,$r,Mr;const bt=A.find(cs=>cs.id===It.source),Et=(bt==null?void 0:bt.type)||"";if(Et==="upload"){const cs=((es=(js=(Kt=bt==null?void 0:bt.data)==null?void 0:Kt.config)==null?void 0:js.uploadedFiles)==null?void 0:es[0])||null,ha=((cs==null?void 0:cs.type)||"").toUpperCase(),ma=((cs==null?void 0:cs.mimeType)||"").toLowerCase();return Ke+(ha==="IMAGE"||ma.startsWith("image/")?1:0)}if(Et==="assetSelector"){const cs=((Rs=bt==null?void 0:bt.data)==null?void 0:Rs.config)||{};return cs.selectedAsset&&(Ke+=(cs.selectedAsset.type||"").toUpperCase()==="IMAGE"||(cs.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(cs.subjects)&&cs.subjects.length>0?Ke+((cs.subjects[0].images||[]).length||0):Ke}if(Et==="aiImage"){const cs=($r=(Cs=bt==null?void 0:bt.data)==null?void 0:Cs.config)==null?void 0:$r.generatedImageUrl;return Ke+(cs?1:0)}if(Et==="imagePreview"){const cs=(Mr=bt==null?void 0:bt.data)==null?void 0:Mr.imageUrl;return Ke+(cs?1:0)}return Ke},0);let Qe=1;if(q.type==="assetSelector"){const Ke=((Rt=q==null?void 0:q.data)==null?void 0:Rt.config)||{};Ke.selectedAsset?Qe=(Ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Ke.subjects)&&Ke.subjects.length>0&&(Qe=(Ke.subjects[0].images||[]).length||0)}else if(q.type==="upload"){const Ke=((xt=(ht=(Ot=q==null?void 0:q.data)==null?void 0:Ot.config)==null?void 0:ht.uploadedFiles)==null?void 0:xt[0])||null,It=((Ke==null?void 0:Ke.type)||"").toUpperCase(),bt=((Ke==null?void 0:Ke.mimeType)||"").toLowerCase();Qe=It==="IMAGE"||bt.startsWith("image/")?1:0}else q.type==="aiImage"?Qe=((Ht=(Nt=q==null?void 0:q.data)==null?void 0:Nt.config)==null?void 0:Ht.generatedImageUrl)?1:0:q.type==="imagePreview"&&(Qe=((ct=q==null?void 0:q.data)==null?void 0:ct.imageUrl)?1:0);const ke=(nt=(ze=ee==null?void 0:ee.data)==null?void 0:ze.config)==null?void 0:nt.modelId,Je=i.find(Ke=>Ke.id===ke),jt=(Je==null?void 0:Je.config)||{},Mt=jt.maxReferenceImages||jt.supportedReferenceImagesLimit||jt.referenceImagesLimit||10;if(ot+Qe>Mt){h.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Mt}å¼ ï¼‰`),Qt.current=!1;return}}}}try{const ut=A.find(ot=>ot.id===o.target),at=A.find(ot=>ot.id===o.source),qt=ot=>{var ke,Je,jt,Mt;if(!ot)return null;const Qe=String(ot.type||"").toLowerCase();if(Qe==="upload"){const Ke=(((Je=(ke=ot.data)==null?void 0:ke.config)==null?void 0:Je.uploadedFiles)||[]).find(It=>{const bt=((It==null?void 0:It.type)||"").toUpperCase(),Et=((It==null?void 0:It.mimeType)||"").toLowerCase();return bt==="AUDIO"||Et.startsWith("audio/")});return(Ke==null?void 0:Ke.url)||null}if(Qe==="assetSelector"){const Ke=(Mt=(jt=ot.data)==null?void 0:jt.config)==null?void 0:Mt.selectedAsset,It=((Ke==null?void 0:Ke.type)||"").toUpperCase(),bt=((Ke==null?void 0:Ke.mimeType)||"").toLowerCase();if(It==="AUDIO"||bt.startsWith("audio/"))return(Ke==null?void 0:Ke.url)||null}return null};if(String((ut==null?void 0:ut.type)||"")==="audioVoice"){const ot=qt(at);ot&&S(Qe=>Qe.map(ke=>ke.id===ut.id?{...ke,data:{...ke.data,config:{...ke.data.config,audioUrl:ot}}}:ke))}}catch{}const Me={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{c(ut=>Ia(Me,ut)),rs(Me)},0),ms.current=null,Qt.current=!0},[c,A,M,i,x,rs]),Kr=t.useCallback((o,C)=>{const D=Tt.current.some(ee=>{var ve;return!ee.hidden&&((ve=ee.nodeIds)==null?void 0:ve.includes(C.source))}),q=Tt.current.some(ee=>{var ve;return!ee.hidden&&((ve=ee.nodeIds)==null?void 0:ve.includes(C.target))});if(D||q){h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}c(ee=>ee.filter(ve=>ve.id!==C.id)),ys(C.id),h.success("å·²æ–­å¼€è¿æ¥")},[c,ys]),yr=t.useCallback(o=>{var q,ee,ve,Me,Pe,He,Fe,rt,Xe,Oe,mt,Pt,Rt,Ot,ht;lt.current&&clearTimeout(lt.current);try{const xt=localStorage.getItem("suppressedPreviewTasks")||"[]",Nt=JSON.parse(xt),Ht=ze=>{Nt.push(ze)};for(const ze of Array.isArray(o)?o:[])if((ze==null?void 0:ze.type)==="imagePreview"){const nt=(ee=(q=ze==null?void 0:ze.data)==null?void 0:q.midjourneyData)==null?void 0:ee.sourceNodeId,ut=(Me=(ve=ze==null?void 0:ze.data)==null?void 0:ve.midjourneyData)==null?void 0:Me.taskId,at=(He=(Pe=ze==null?void 0:ze.data)==null?void 0:Pe.midjourneyData)==null?void 0:He.messageId;if(nt||ut||at)Ht({sourceNodeId:nt,taskId:ut,messageId:at});else{const qt=De.current.find($t=>$t.target===ze.id);if(qt){const $t=te.current.find(Qe=>Qe.id===qt.source),ot=(rt=(Fe=$t==null?void 0:$t.data)==null?void 0:Fe.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((ze==null?void 0:ze.type)==="videoPreview"){const nt=De.current.find(ut=>ut.target===ze.id);if(nt){const ut=te.current.find(qt=>qt.id===nt.source),at=(Oe=(Xe=ut==null?void 0:ut.data)==null?void 0:Xe.config)==null?void 0:Oe.taskId;at&&Ht({taskId:at})}}const ct=Nt.slice(Math.max(0,Nt.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(ct))}catch{}try{const xt=[];for(const Nt of Array.isArray(o)?o:[]){const Ht=(Rt=(Pt=(mt=Nt==null?void 0:Nt.data)==null?void 0:mt.workflowContext)==null?void 0:Pt.project)==null?void 0:Rt.name;(Nt==null?void 0:Nt.type)==="imagePreview"&&((Ot=Nt==null?void 0:Nt.data)!=null&&Ot.imageUrl)?xt.push(Ce.post("/assets/recycle/record",{url:Nt.data.imageUrl,type:"IMAGE",projectName:Ht})):(Nt==null?void 0:Nt.type)==="videoPreview"&&((ht=Nt==null?void 0:Nt.data)!=null&&ht.videoUrl)&&xt.push(Ce.post("/assets/recycle/record",{url:Nt.data.videoUrl,type:"VIDEO",projectName:Ht}))}xt.length>0&&Promise.allSettled(xt).then(()=>{})}catch{}const C=Array.isArray(o)?o.length:0,D=Ve.current;setTimeout(()=>{const xt=te.current.length,Nt=Math.max(D-C,0);xt===Nt&&Ns()},100)},[]),Zr=t.useCallback(o=>{const C=o.filter(q=>Tt.current.some(ve=>{var Me;return!ve.hidden&&((Me=ve.nodeIds)==null?void 0:Me.includes(q.id))})?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(C.length===0)return;if(a){yr(C),C.forEach(q=>Ft(q.id));return}const D=C.filter(q=>{var Me;const ee=(Me=q.data)==null?void 0:Me.createdBy;return(typeof ee=="object"?ee==null?void 0:ee.id:ee)===d.current});D.length>0&&(yr(D),D.forEach(q=>Ft(q.id)))},[a,yr,Ft]),Ar=t.useCallback(o=>{lt.current&&clearTimeout(lt.current),setTimeout(()=>{Ys()},250)},[]),Qr=t.useCallback(o=>{const C=o.filter(D=>{if(D.type!=="remove")return!0;const q=De.current.find(Me=>Me.id===D.id);if(!q)return!0;const ee=Tt.current.some(Me=>{var Pe;return!Me.hidden&&((Pe=Me.nodeIds)==null?void 0:Pe.includes(q.source))}),ve=Tt.current.some(Me=>{var Pe;return!Me.hidden&&((Pe=Me.nodeIds)==null?void 0:Pe.includes(q.target))});return ee||ve?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});I(C)},[I]),ea=t.useCallback(o=>{const C=o.filter(D=>{const q=Tt.current.some(ve=>{var Me;return!ve.hidden&&((Me=ve.nodeIds)==null?void 0:Me.includes(D.source))}),ee=Tt.current.some(ve=>{var Me;return!ve.hidden&&((Me=ve.nodeIds)==null?void 0:Me.includes(D.target))});return q||ee?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});C.length>0&&(Ar(C),C.forEach(D=>ys(D.id)))},[Ar,ys]),ta=t.useCallback(o=>{if(o.preventDefault(),L)return;const C=200,D=400,q=10;let ee=o.clientX,ve=o.clientY;ee+C+q>window.innerWidth&&(ee=window.innerWidth-C-q),ve+D+q>window.innerHeight&&(ve=window.innerHeight-D-q),ee=Math.max(q,ee),ve=Math.max(q,ve),l({x:ee,y:ve})},[L]),pr=t.useCallback(()=>{l(null),ue(),H(!1)},[]),ar=t.useCallback(o=>{gt(o),_t(!0)},[]);t.useEffect(()=>{A.length>0&&A.some(C=>C.type==="assetSelector"&&!C.data.onOpenAssetPanel)&&S(C=>C.map(D=>D.type==="assetSelector"&&!D.data.onOpenAssetPanel?{...D,data:{...D.data,onOpenAssetPanel:ar,models:D.data.models||i}}:D))},[A.length,ar,i]);const sa=t.useCallback(o=>{dt&&(S(C=>C.map(q=>q.id===dt?{...q,data:{...q.data,config:{...q.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(ee=>ee.url)}],referenceImages:o.images.map(ee=>({id:ee.id,url:ee.url,name:ee.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:q)),_t(!1),gt(null),h.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[dt,S]),_r=o=>{const D={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",q=D==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:D==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:D==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:D==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],ee=i.filter(He=>He.type==="VIDEO_GENERATION"),ve=i.filter(He=>He.type==="VIDEO_EDITING"),Me=He=>{const Fe=(He||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Pe=null;return D==="è§†é¢‘æ¢äºº"?Pe=ve.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||ee.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Oe=>Me(Oe)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):D==="å¯¹å£å‹"?Pe=ve.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:D==="é£æ ¼è½¬æ¢"?Pe=ve.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Pe=ee.find(He=>{var rt;const Fe=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>Me(Xe)):[];return D==="é¦–å¸§"||D==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(D)}),{modelId:Pe==null?void 0:Pe.id,modelName:Pe==null?void 0:Pe.name,generationType:D,lockedGenerationType:D,hideGenerationTypeSelector:!0,acceptedInputs:q}},ns=(o,C,D,q,ee,ve,Me,Pe)=>{if(!p)return;const He=Ue({x:p.x,y:p.y}),Fe=`${o}-${Date.now()}`,rt=Yt?Ye.find(Rt=>Rt.id===Yt)||null:Ye.find(Rt=>Rt.nodeIds.includes(Fe))||null,Xe=D==="aiImage"||D.startsWith("aiVideo")||D==="midjourney",Oe=D.startsWith("aiVideo")?_r(D):{},mt=q?{agentId:q}:Oe;D.startsWith("aiVideo"),D.startsWith("aiVideo")&&Pe&&Object.assign(mt,Pe);const Pt={id:Fe,type:D,position:He,data:{label:ee||C,type:o,config:mt,models:i,isExpanded:Xe,onOpenAssetPanel:D==="assetSelector"?ar:void 0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:ge,episode:me,nodeGroup:rt,nodeGroups:Ye}}};S(Rt=>[...Rt,Pt]),Ut(Pt),Yt&&(yt(Rt=>Rt.map(Ot=>{if(Ot.id!==Yt)return Ot;const ht=Array.from(new Set([...Ot.nodeIds||[],Fe])),xt=mr(ht)||Ot.bounds;return{...Ot,nodeIds:ht,bounds:xt}})),Tt.current=Tt.current.map(Rt=>{if(Rt.id!==Yt)return Rt;const Ot=Array.from(new Set([...Rt.nodeIds||[],Fe])),ht=mr(Ot)||Rt.bounds;return{...Rt,nodeIds:Ot,bounds:ht}})),pr(),h.success(`å·²æ·»åŠ ${ee||C}èŠ‚ç‚¹`),D==="assetSelector"&&setTimeout(()=>{ar(Pt.id)},100)},[is,Ks]=t.useState(null),Qt=t.useRef(!1),ms=t.useRef(null),Zs=t.useMemo(()=>{var Pe,He,Fe,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const C=is.handleType==="target",D=Xe=>{const Oe=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return Oe?Oe.includes("æ–‡ç”Ÿ")||Oe.includes("text to video")||Oe.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Oe.includes("é¦–å°¾")||Oe.includes("first last")||Oe.includes("two frame")||Oe.includes("frame pair")?"é¦–å°¾å¸§":Oe.includes("é¦–å¸§")||Oe.includes("first frame")||Oe.includes("start frame")||Oe.includes("initial frame")||Oe.includes("keyframe")?"é¦–å¸§":Oe.includes("å°¾å¸§")||Oe.includes("last frame")||Oe.includes("end frame")||Oe.includes("final frame")?"å°¾å¸§":Oe.includes("ä¸»ä½“å‚è€ƒ")||Oe.includes("subject reference")||Oe.includes("å‚è€ƒ")||Oe.includes("reference image")||Oe.includes("image reference")||Oe.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(C){const Xe=A.find(Ot=>Ot.id===is.sourceNodeId),Oe=(Xe==null?void 0:Xe.type)||"",mt=Oe.startsWith("aiVideo"),Pt=D((He=(Pe=Xe==null?void 0:Xe.data)==null?void 0:Pe.config)==null?void 0:He.generationType),Rt=Oe==="aiVideo_t2v"||Pt==="æ–‡ç”Ÿè§†é¢‘";if(Oe==="aiImage"){const Ot=x.filter(nt=>nt.target===(Xe==null?void 0:Xe.id)),ht=Ot.some(nt=>{const ut=A.find(at=>at.id===nt.source);return((ut==null?void 0:ut.type)||"")==="agent"}),xt=Ot.reduce((nt,ut)=>{var $t,ot,Qe,ke;const at=A.find(Je=>Je.id===ut.source),qt=(at==null?void 0:at.type)||"";if(qt==="upload"){const Je=((Qe=(ot=($t=at==null?void 0:at.data)==null?void 0:$t.config)==null?void 0:ot.uploadedFiles)==null?void 0:Qe[0])||null,jt=((Je==null?void 0:Je.type)||"").toUpperCase(),Mt=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return nt+(jt==="IMAGE"||Mt.startsWith("image/")?1:0)}if(qt==="assetSelector"){const Je=((ke=at==null?void 0:at.data)==null?void 0:ke.config)||{};if(Je.selectedAsset)return nt+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return nt+((Je.subjects[0].images||[]).length||0)}return nt},0),Nt=(rt=(Fe=Xe==null?void 0:Xe.data)==null?void 0:Fe.config)==null?void 0:rt.modelId,Ht=i.find(nt=>nt.id===Nt),ct=(Ht==null?void 0:Ht.config)||{},ze=ct.maxReferenceImages||ct.supportedReferenceImagesLimit||ct.referenceImagesLimit||10;return ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:xt>=ze?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(mt){const Ot=x.filter(ze=>ze.target===(Xe==null?void 0:Xe.id)),ht=Ot.some(ze=>{const nt=A.find(ut=>ut.id===ze.source);return((nt==null?void 0:nt.type)||"")==="agent"}),xt=Ot.reduce((ze,nt)=>{var qt,$t,ot,Qe;const ut=A.find(ke=>ke.id===nt.source),at=(ut==null?void 0:ut.type)||"";if(at==="aiImage"||at==="imagePreview")return ze+1;if(at==="upload"){const ke=((ot=($t=(qt=ut==null?void 0:ut.data)==null?void 0:qt.config)==null?void 0:$t.uploadedFiles)==null?void 0:ot[0])||null,Je=((ke==null?void 0:ke.type)||"").toUpperCase(),jt=((ke==null?void 0:ke.mimeType)||"").toLowerCase();return ze+(Je==="IMAGE"||jt.startsWith("image/")?1:0)}if(at==="assetSelector"){const ke=((Qe=ut==null?void 0:ut.data)==null?void 0:Qe.config)||{};if(ke.selectedAsset)return ze+((ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ke.subjects&&ke.subjects.length>0)return ze+((ke.subjects[0].images||[]).length||0)}return ze},0);return Rt?ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Oe==="aiVideo_i2v_first"||Oe==="aiVideo_i2v_last"||Pt==="é¦–å¸§"||Pt==="å°¾å¸§"?ht&&xt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:xt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Oe==="aiVideo_first_last"||Pt==="é¦–å°¾å¸§"?ht&&xt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:xt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:xt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Oe==="aiVideo_reference"||Pt==="å‚è€ƒå›¾"?ht&&xt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:xt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const q=A.find(Xe=>Xe.id===is.sourceNodeId),ve=(Xe=>{var Pt,Rt,Ot;if(!Xe)return null;const Oe=Xe.type,mt=Xe.data;if(Oe==="upload"&&Array.isArray((Pt=mt.config)==null?void 0:Pt.uploadedFiles)&&mt.config.uploadedFiles.length>0){const ht=mt.config.uploadedFiles;return ht.some(ct=>{const ze=((ct==null?void 0:ct.type)||"").toUpperCase(),nt=((ct==null?void 0:ct.mimeType)||"").toLowerCase();return ze==="IMAGE"||nt.startsWith("image/")})?"IMAGE":ht.some(ct=>{const ze=((ct==null?void 0:ct.type)||"").toUpperCase(),nt=((ct==null?void 0:ct.mimeType)||"").toLowerCase();return ze==="VIDEO"||nt.startsWith("video/")})?"VIDEO":ht.some(ct=>{const ze=((ct==null?void 0:ct.type)||"").toUpperCase(),nt=((ct==null?void 0:ct.mimeType)||"").toLowerCase();return ze==="AUDIO"||nt.startsWith("audio/")})?"AUDIO":null}if(Oe==="assetSelector"){if((Rt=mt.config)!=null&&Rt.subjects)return"IMAGE";if((Ot=mt.config)!=null&&Ot.selectedAsset){const ht=mt.config.selectedAsset,xt=(ht.type||"").toUpperCase(),Nt=(ht.mimeType||"").toLowerCase();return xt==="IMAGE"||Nt.startsWith("image/")?"IMAGE":xt==="VIDEO"||Nt.startsWith("video/")?"VIDEO":xt==="AUDIO"||Nt.startsWith("audio/")?"AUDIO":xt||null}}return Oe==="aiImage"||Oe==="imagePreview"||Oe==="midjourney"?"IMAGE":(Oe||"").startsWith("aiVideo")||Oe==="videoPreview"?"VIDEO":Oe==="agent"||Oe==="textPreview"?"TEXT":null})(q),Me=q==null?void 0:q.type;return Me==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:Me==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ve==="TEXT",showAiImage:ve==="IMAGE"||ve==="TEXT",showAudio:ve==="AUDIO",showVideo:ve==="VIDEO"||ve==="IMAGE"||ve==="TEXT",showEdit:ve==="VIDEO",showImageEditing:ve==="IMAGE",showMidjourney:ve==="IMAGE"||ve==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ve==="IMAGE"}},[is,A,x,i]),ra=t.useCallback((o,{nodeId:C,handleType:D})=>{if(!C){ms.current=null;return}if(D==="target"){const q=A.find(ve=>ve.id===C),ee=(q==null?void 0:q.type)||"";if(ee==="agent"||ee==="aiImage"||ee==="midjourney"||ee.startsWith("aiVideo")){h.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),ms.current=null;return}}if(D==="source"){const q=A.find(ee=>ee.id===C);if(q&&(q.type==="aiImage"||q.type.startsWith("aiVideo"))){ms.current=null;return}}Qt.current=!1,ms.current={nodeId:C,handleType:D==="target"?"target":"source"},pr(),Ks(null)},[pr,A]),aa=t.useCallback(o=>{const C=ms.current;if(!C)return;let D=0,q=0;"changedTouches"in o&&o.changedTouches.length>0?(D=o.changedTouches[0].clientX,q=o.changedTouches[0].clientY):"clientX"in o&&(D=o.clientX,q=o.clientY),setTimeout(()=>{if(Qt.current){Qt.current=!1,ms.current=null;return}const ee=o.target,ve=!!ee&&!!ee.closest(".react-flow__pane"),Me=!!ee&&(ee.closest(".react-flow__node")||ee.closest(".react-flow__handle"));if(!ve||Me){Qt.current=!1,ms.current=null;return}Ks({x:D,y:q,sourceNodeId:C.nodeId,handleType:C.handleType}),Qt.current=!1},100),ms.current=null},[]),ls=(o,C,D,q,ee,ve)=>{var Pt,Rt,Ot,ht,xt,Nt,Ht;if(!is)return;const Me=Ue({x:is.x,y:is.y}),Pe=`${D}-${Date.now()}`,He=A.find(ct=>ct.id===is.sourceNodeId),Fe=He?Ye.find(ct=>ct.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?_r(o):{},Oe=q?{agentId:q}:Xe;o.startsWith("aiVideo")&&ve&&Object.assign(Oe,ve);const mt={id:Pe,type:o,position:Me,data:{label:ee||C,type:D,config:Oe,models:i,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:ge,episode:me,nodeGroup:Fe,nodeGroups:Ye}}};if(S(ct=>[...ct,mt]),Fe&&(yt(ct=>ct.map(ze=>{if(ze.id!==Fe.id)return ze;const nt=Array.from(new Set([...ze.nodeIds,Pe]));return{...ze,nodeIds:nt}})),Tt.current=Tt.current.map(ct=>{if(ct.id!==Fe.id)return ct;const ze=Array.from(new Set([...ct.nodeIds,Pe]));return{...ct,nodeIds:ze}})),is.handleType==="source"){const ct=A.find(ke=>ke.id===is.sourceNodeId),ze=mt,nt=ke=>{const Je=(ke||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ke||"":""},ut=ke=>{var Mt,Ke,It;const Je=ke.type,jt=ke.data;if(Je==="upload"&&Array.isArray((Mt=jt.config)==null?void 0:Mt.uploadedFiles)&&jt.config.uploadedFiles.length>0){const bt=jt.config.uploadedFiles,Et=bt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),Cs=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="VIDEO"||Cs.startsWith("video/")}),Kt=bt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),Cs=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="IMAGE"||Cs.startsWith("image/")}),js=bt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),Cs=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="AUDIO"||Cs.startsWith("audio/")});return(ze==null?void 0:ze.type)==="aiVideo_swap"?Et?"VIDEO":Kt?"IMAGE":js?"AUDIO":null:Kt?"IMAGE":Et?"VIDEO":js?"AUDIO":null}if(Je==="assetSelector"){if((Ke=jt.config)!=null&&Ke.subjects)return"IMAGE";if((It=jt.config)!=null&&It.selectedAsset){const bt=jt.config.selectedAsset,Et=(bt.type||"").toUpperCase(),Kt=(bt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ke=>{var jt,Mt,Ke;if(ut(ke)!=="IMAGE")return 0;if(ke.type==="upload")return(((Mt=(jt=ke.data)==null?void 0:jt.config)==null?void 0:Mt.uploadedFiles)||[]).filter(bt=>bt.type==="IMAGE"||(bt.mimeType||"").startsWith("image/")).length;if(ke.type==="assetSelector"){const It=((Ke=ke.data)==null?void 0:Ke.config)||{};return It.subjects&&It.subjects.length>0?(It.subjects[0].images||[]).length:It.selectedAsset&&It.selectedAsset.type==="IMAGE"?1:0}return ke.type==="imagePreview"||ke.type==="aiImage",1},qt=ke=>{var bt,Et,Kt,js,es,Rs;const Je=nt((Et=(bt=ke.data)==null?void 0:bt.config)==null?void 0:Et.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const jt=(js=(Kt=ke.data)==null?void 0:Kt.config)==null?void 0:js.modelId,Ke=(((es=ke.data)==null?void 0:es.models)||i).find(Cs=>Cs.id===jt),It=Array.isArray((Rs=Ke==null?void 0:Ke.config)==null?void 0:Rs.supportedGenerationTypes)?Ke.config.supportedGenerationTypes.map(Cs=>nt(Cs)):[];return It.includes("å‚è€ƒå›¾")||It.includes("ä¸»ä½“å‚è€ƒ")?7:It.includes("é¦–å°¾å¸§")?2:It.includes("é¦–å¸§")||It.includes("å°¾å¸§")?1:(It.includes("æ–‡ç”Ÿè§†é¢‘"),0)},$t=ct?ut(ct):null;if(ze.type.startsWith("aiVideo")&&$t==="IMAGE"){if(nt((Rt=(Pt=ze.data)==null?void 0:Pt.config)==null?void 0:Rt.generationType)==="é¦–å°¾å¸§"&&ct&&ct.type==="assetSelector"){const bt=((Ot=ct.data)==null?void 0:Ot.config)||{};if(bt.subjects&&(((ht=bt.subjects[0])==null?void 0:ht.images)||[]).length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ks(null),ms.current=null,Qt.current=!1;return}}const Je=x.filter(bt=>bt.target===ze.id);let jt=0;Je.forEach(bt=>{const Et=A.find(Kt=>Kt.id===bt.source);Et&&(jt+=at(Et))});const Mt=ct?at(ct):0,Ke=qt(ze),It=jt+Mt;if(Ke===0){h.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ks(null),ms.current=null,Qt.current=!1;return}if(It>Ke){h.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Ke}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${It}å¼ ï¼‰`),Ks(null),ms.current=null,Qt.current=!1;return}}let ot;mt.type==="superCanvas"?ot="input-image":mt.type==="midjourney"&&($t==="IMAGE"?ot="omni-ref":$t==="TEXT"&&(ot="text-input"));const Qe={id:`edge-${is.sourceNodeId}-${mt.id}`,source:is.sourceNodeId,target:mt.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};c(ke=>[...ke,Qe])}else if(is.handleType==="target"){const ct=A.find(Qe=>Qe.id===is.sourceNodeId),ze=(ct==null?void 0:ct.type)||"";if(ze==="agent"||ze==="aiImage"||ze==="midjourney"||ze.startsWith("aiVideo")){h.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ks(null),ms.current=null,Qt.current=!1;return}const nt=mt,ut=A.find(Qe=>Qe.id===is.sourceNodeId),at=Qe=>{const ke=(Qe||"").toLowerCase();return ke?ke.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")?"é¦–å¸§":ke.includes("å°¾å¸§")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ke.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ke.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("first-last")?"é¦–å°¾å¸§":ke.includes("first")?"é¦–å¸§":ke.includes("last")?"å°¾å¸§":ke.includes("subject")?"ä¸»ä½“å‚è€ƒ":ke.includes("reference")?"å‚è€ƒå›¾":Qe||"":""},$t=(Qe=>{var jt,Mt,Ke,It;const ke=Qe.type,Je=Qe.data;if(ke==="upload"&&((Mt=(jt=Je.config)==null?void 0:jt.uploadedFiles)==null?void 0:Mt.length)>0){const bt=Je.config.uploadedFiles[0],Et=(bt.type||"").toUpperCase(),Kt=(bt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}if(ke==="assetSelector"){if((Ke=Je.config)!=null&&Ke.subjects)return"IMAGE";if((It=Je.config)!=null&&It.selectedAsset){const bt=Je.config.selectedAsset,Et=(bt.type||"").toUpperCase(),Kt=(bt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}}return ke==="aiImage"||ke==="imagePreview"?"IMAGE":ke==="aiVideo"||ke==="videoPreview"?"VIDEO":ke==="agent"?"TEXT":null})(nt);if(ut&&ut.type==="aiVideo"&&$t==="IMAGE"&&at((Nt=(xt=ut.data)==null?void 0:xt.config)==null?void 0:Nt.generationType)==="é¦–å°¾å¸§"&&nt&&nt.type==="assetSelector"){const ke=((Ht=nt.data)==null?void 0:Ht.config)||{};if(ke.subjects&&ke.subjects.length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ks(null),ms.current=null,Qt.current=!1;return}}const ot={id:`edge-${mt.id}-${is.sourceNodeId}`,source:mt.id,sourceHandle:mt.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};c(Qe=>[...Qe,ot])}Ks(null),ms.current=null,Qt.current=!1,h.success(`å·²æ·»åŠ ${C}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(mt.id)},100)},mr=t.useCallback(o=>{const C=A.filter(Pe=>o.includes(Pe.id));if(C.length===0)return null;const D=50;let q=1/0,ee=1/0,ve=-1/0,Me=-1/0;return C.forEach(Pe=>{const He=Pe.position.x,Fe=Pe.position.y,rt=Pe.width||320,Xe=Pe.height||200;q=Math.min(q,He),ee=Math.min(ee,Fe),ve=Math.max(ve,He+rt),Me=Math.max(Me,Fe+Xe)}),{x:q-D,y:ee-D,width:ve-q+D*2,height:Me-ee+D*2}},[A]),oa=t.useCallback(()=>{tr(o=>!o),er(!1)},[]),Tr=t.useCallback((o,C)=>{const D={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:C-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0}};S(q=>[...q,D]),tr(!1)},[S,ne]),na=t.useCallback(()=>{if(!a){h.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=A.filter(ve=>ve.selected);if(o.length===0){h.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){h.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const C=o.map(ve=>ve.id);if(Ye.some(ve=>ve.nodeIds.some(Me=>C.includes(Me)))){h.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const q=mr(C);if(!q){h.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const ee={id:`group-${Date.now()}`,nodeIds:C,bounds:q};yt(ve=>{const Me=[...ve,ee];return qs(Me),setTimeout(()=>{Ys()},100),Me}),wt(ee.id),S(ve=>{const Me=new Set;return x.forEach(Pe=>{if(C.includes(Pe.source)){const He=ve.find(Fe=>Fe.id===Pe.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&Me.add(Pe.target)}}),ve.map(Pe=>C.includes(Pe.id)?{...Pe,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:ee,nodeGroups:[...Ye,ee]}}}:Me.has(Pe.id)?{...Pe,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:ee,nodeGroups:[...Ye,ee]}}}:Pe)}),h.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${C.length} ä¸ªèŠ‚ç‚¹`)},[A,mr,Ye,S]),ia=t.useCallback(()=>{if(!a){h.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Be){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ye.find(C=>C.id===Be);o&&(S(C=>C.map(D=>o.nodeIds.includes(D.id)?{...D,draggable:!0,connectable:!0,deletable:!0,data:{...D.data,workflowContext:{...D.data.workflowContext,nodeGroup:null,nodeGroups:Ye.filter(q=>q.id!==Be)}}}:D)),yt(C=>{const D=C.filter(q=>q.id!==Be);return qs(D),setTimeout(()=>{Ys()},100),D}),wt(null),h.success("å·²è§£é™¤ç¼–ç»„"))},[Be,Ye,S,qs]),la=t.useCallback(()=>{if(!Be){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Bs(Be),Ss(!0)},[Be]),Ur=t.useCallback((o,C)=>{o.stopPropagation(),o.preventDefault(),Hs(null),wt(C),nr(null)},[]);t.useEffect(()=>{if(!gs||!Xs)return;let o=Xs.x,C=Xs.y;const D=ee=>{const ve=Js.current;if(!ve)return;const Me=se(),Pe=(ee.clientX-o)/Me.zoom,He=(ee.clientY-C)/Me.zoom;if(Math.abs(Pe)<.01&&Math.abs(He)<.01)return;const Fe=Tt.current.find(rt=>rt.id===ve);Fe&&(yt(rt=>rt.map(Xe=>Xe.id===ve?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Pe,y:Xe.bounds.y+He}}:Xe)),S(rt=>rt.map(Xe=>Fe.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Pe,y:Xe.position.y+He}}:Xe)),o=ee.clientX,C=ee.clientY)},q=()=>{Hs(null),nr(null)};return document.addEventListener("mousemove",D),document.addEventListener("mouseup",q),()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",q)}},[gs,Xs]);const ca=t.useCallback(o=>{if(ws){const C=Ue({x:o.clientX,y:o.clientY});Tr(C.x,C.y);return}pr(),Ks(null),ms.current=null,wt(null),Qt.current=!1},[pr,ws,Ue,Tr]),kr=t.useRef(null),da=t.useCallback(()=>{Ye.length>0&&!kr.current&&(kr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),kr.current=null}))},[Ye.length]),ir=t.useCallback(o=>Ye.find(C=>C.nodeIds.includes(o))||null,[Ye]),ua=t.useCallback((o,C)=>{var q;if(it||(q=C==null?void 0:C.data)!=null&&q.freeDrag)return;const D=ir(C.id);if(D){if(!D.hidden&&!a)return;Ps.current=C.id,J.current={x:C.position.x,y:C.position.y}}},[ir,a]),pa=t.useCallback((o,C)=>{var ee;if(it||(ee=C==null?void 0:C.data)!=null&&ee.freeDrag||!J.current||Ps.current!==C.id)return;const D=ir(C.id);if(!D)return;const q=!D.hidden;if(!(q&&!a))if(q){const ve=C.position.x-J.current.x,Me=C.position.y-J.current.y,Pe=[],He=D.nodeIds||[];te.current.forEach(Fe=>{if(He.includes(Fe.id)){const rt={x:Fe.id===C.id?C.position.x:Fe.position.x+ve,y:Fe.id===C.id?C.position.y:Fe.position.y+Me};Pe.push({id:Fe.id,position:rt})}}),S(Fe=>Fe.map(rt=>{const Xe=Pe.find(Oe=>Oe.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Pe.length>0&&ts(Pe),yt(Fe=>{const rt=Fe.map(Xe=>Xe.id===D.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ve,y:Xe.bounds.y+Me}}:Xe);return Tt.current=rt,rt}),J.current={x:C.position.x,y:C.position.y}}else{const ve=D.bounds.x,Me=D.bounds.y,Pe=D.bounds.width,He=D.bounds.height,Fe=(Oe,mt,Pt)=>Math.max(mt,Math.min(Oe,Pt)),rt=Fe(C.position.x,ve+10,ve+Pe-10),Xe=Fe(C.position.y,Me+10,Me+He-10);S(Oe=>Oe.map(mt=>mt.id===C.id?{...mt,position:{x:rt,y:Xe}}:mt)),J.current={x:rt,y:Xe}}},[S,yt,ir,a,ts]),ga=t.useCallback(()=>{Ps.current=null,J.current=null,Js.current=null,Ps.current=null,J.current=null,Js.current=null,Hs(null),Tt.current.length>0&&qs(Tt.current)},[qs]),fa=t.useCallback((o,C)=>{const D=ir(C.id);D&&wt(D.id)},[ir]);if(t.useEffect(()=>{if(x.length===0||A.length===0)return;const o=x.filter(C=>{const D=A.find(ee=>ee.id===C.source),q=A.find(ee=>ee.id===C.target);return(q==null?void 0:q.type)==="midjourney"&&C.targetHandle==="text-input"&&(D==null?void 0:D.type)!=="agent"});o.length>0&&(c(C=>C.filter(D=>!o.some(q=>q.id===D.id))),h.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[x,A,c]),Z)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!ge)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Rr=A.filter(o=>o.selected).length>=2,xr=!!Be;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:vt,className:"flex-1 relative overflow-hidden",children:[L&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:O?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${O.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),ge&&e.jsx("div",{className:`absolute left-4 ${L?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&me?`ã€Š${ge.name}ã€‹ç¬¬${me.episodeNumber}é›†${!Le&&re&&K?` ç¬¬${re}å¹•ç¬¬${K}é•œ`:""}`:`ã€Š${ge.name}ã€‹`})}),!Le&&Ye.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-4 top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ye.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,C)=>o.scene!==C.scene?(o.scene||0)-(C.scene||0):(o.shot||0)-(C.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const C=o.bounds.x+o.bounds.width/2,D=o.bounds.y+o.bounds.height/2,q=vt.current;if(q){const ee=q.clientWidth,ve=q.clientHeight,Me=.2,Pe=ee*(1-Me),He=ve*(1-Me),Fe=Pe/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(Fe,rt,1.5),Oe=Math.max(Xe,.3);he(C,D,{zoom:Oe,duration:800})}else he(C,D,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Be===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-white/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-white dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:`absolute ${L?"top-14":"top-5"} left-1/2 transform -translate-x-1/2 z-[100] flex gap-2`,children:[e.jsx("button",{onClick:()=>{if(qe&&N&&n){const o=Le&&re&&K?`?shot=${K}`:"";U(`/projects/${N}/episodes/${n}${o}`)}else U("/quick")},className:"w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"arrow_back"})}),!L&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!it&&a&&er(!bs)},disabled:it||!a,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${it||!a?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":bs?"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg shadow-md hover:scale-105":"bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105"}`,title:a?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!it&&a&&na()},disabled:it||!a||!Rr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${it||!a?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":Rr?"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:a?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"group_work"})}),e.jsx("button",{onClick:()=>{!it&&a&&ia()},disabled:it||!a||!xr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${it||!a?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":xr?"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:a?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"group_off"})}),e.jsx("button",{onClick:()=>{!it&&a&&la()},disabled:it||!a||!xr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${it||!a?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":xr?"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:a?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"edit"})}),e.jsx("button",{onClick:()=>oa(),className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${ws?"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg shadow-md hover:scale-105":"bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105"}`,title:ws?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"text_fields"})})]})]}),m&&Es.length>0&&e.jsxs("div",{className:`absolute ${L?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:Es.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-purple-200 dark:bg-purple-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.com${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-purple-600 dark:text-purple-300",children:"person"})},o.id))}),Es.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",Es.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${ws?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Sa,{nodes:Bt,edges:x,onNodesChange:L?void 0:ds,onEdgesChange:L?void 0:Qr,onNodesDelete:L?void 0:Zr,onEdgesDelete:L?void 0:ea,onConnect:L?void 0:Yr,onConnectStart:L?void 0:ra,onConnectEnd:L?void 0:aa,onEdgeDoubleClick:L?void 0:Kr,onPaneContextMenu:L?void 0:ta,onPaneClick:L?void 0:ca,onMove:da,onNodeClick:L?void 0:fa,onNodeDragStart:L?void 0:ua,onNodeDrag:L?void 0:pa,onNodeDragStop:L?void 0:ga,nodeTypes:xn,edgeTypes:bn,nodesDraggable:!L,nodesConnectable:!L,elementsSelectable:!L,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${L?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#a855f7",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:L?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Ea,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#a855f7"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#ec4899"})]})}),Ye.filter(o=>!o.hidden).map(o=>{const C=se(),D=o.bounds.x*C.zoom+C.x,q=o.bounds.y*C.zoom+C.y,ee=o.bounds.width*C.zoom,ve=o.bounds.height*C.zoom,Me=12*C.zoom,Pe=Math.max(1.25,1.25*C.zoom),He=document.documentElement.classList.contains("dark"),Fe=Be===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:D,y:q,width:ee,height:ve,rx:Me,ry:Me,fill:"none",stroke:Fe?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Pe,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:D,y:q,width:ee,height:ve,rx:Me,ry:Me,fill:"transparent",stroke:"transparent",strokeWidth:Pe*3,style:{pointerEvents:"stroke",cursor:gs===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),Ur(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ye.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const C=se(),D=o.bounds.x*C.zoom+C.x,q=o.bounds.y*C.zoom+C.y,ee=40*C.zoom,ve=10*C.zoom,Me=15*C.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Pe=>{Pe.stopPropagation(),Ur(Pe,o.id)},onClick:Pe=>{Pe.stopPropagation(),wt(o.id)},style:{left:D+ve,top:q-ee-ve-Me,fontSize:`${ee}px`,cursor:gs===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),p&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:p.x,top:p.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("agent")},onMouseLeave:()=>{k.current=window.setTimeout(()=>{ie(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ie("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),V==="agent"&&e.jsx("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("agent")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(k.current=window.setTimeout(()=>{ie(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-purple-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),Se(!0)},onMouseLeave:()=>{k.current=window.setTimeout(()=>{Se(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ie("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),Y&&e.jsxs("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),Se(!0)},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(k.current=window.setTimeout(()=>{Se(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),H(!0)},onMouseLeave:()=>{Ne.current=window.setTimeout(()=>{H(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ie("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),E&&e.jsxs("div",{onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),H(!0)},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(Ne.current=window.setTimeout(()=>{H(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ge.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ge.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ge.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ge.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ge.has("å‚è€ƒå›¾")||Ge.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ge.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("edit")},onMouseLeave:()=>{k.current=window.setTimeout(()=>{ie(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ie("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),V==="edit"&&e.jsxs("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("edit")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(k.current=window.setTimeout(()=>{ie(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Ze.filter(o=>Wt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),pe(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),Ze.every(o=>Wt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Zs.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Ae(!0),onMouseLeave:()=>Ae(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),Re&&e.jsx("div",{onMouseEnter:()=>{_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),ls("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-purple-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Zs.showAiImage&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Zs.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("imageEdit")},onMouseLeave:()=>{u.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),xe==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("imageEdit")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(u.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Zs.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("video")},onMouseLeave:()=>{u.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),xe==="video"&&e.jsxs("div",{onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("video")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(u.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ls("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ge.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ls("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ge.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ge.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ge.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ge.has("å‚è€ƒå›¾")||Ge.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ls("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ge.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ls("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Zs.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),$e.current&&(clearTimeout($e.current),$e.current=null),pe(!0)},onMouseLeave:()=>{$e.current=window.setTimeout(()=>{pe(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>pe(!0),onMouseLeave:()=>pe(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),pe(!0)},onMouseOver:()=>oe(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),b&&e.jsxs("div",{onMouseEnter:()=>{$e.current&&(clearTimeout($e.current),$e.current=null),pe(!0)},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&($e.current=window.setTimeout(()=>{pe(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Ze.filter(o=>Wt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),o==="å¯¹å£å‹"?ls("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?ls("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ls("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),pe(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),Ze.every(o=>Wt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Zs.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Zs.showUpload&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Zs.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Zs.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(mn,{isOpen:Ct,onClose:()=>{_t(!1),gt(null)},onAssetSelect:sa}),Is&&vs&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Ss(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Ss(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),C=document.getElementById("shot-input"),D=parseInt((o==null?void 0:o.value)||"0"),q=parseInt((C==null?void 0:C.value)||"0");if(D>0&&q>0){if(Ye.find(ve=>ve.id!==vs&&ve.scene===D&&ve.shot===q)){h.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${D}å¹•-ç¬¬${q}é•œ`);return}yt(ve=>{const Me=ve.map(He=>He.id===vs?{...He,scene:D,shot:q,name:`ç¬¬${D}å¹•-ç¬¬${q}é•œ`}:He),Pe=Me.find(He=>He.id===vs);return Pe&&S(He=>{const Fe=new Set;return x.forEach(rt=>{if(Pe.nodeIds.includes(rt.source)){const Xe=He.find(Oe=>Oe.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&Fe.add(rt.target)}}),He.map(rt=>Pe.nodeIds.includes(rt.id)||Fe.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Pe,nodeGroups:Me}}}:rt)}),setTimeout(()=>{Ys()},100),Me}),Ss(!1),Bs(null),h.success(`å·²å‘½åä¸ºï¼šç¬¬${D}å¹•-ç¬¬${q}é•œ`)}else h.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},En=()=>e.jsx(va,{children:e.jsx(wn,{})});export{En as default};
