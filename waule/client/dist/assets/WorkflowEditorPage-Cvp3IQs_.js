const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B7LKGTE9.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-VryCahj8.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Vt,u as Cr,z as $s,e as xa,d as ba}from"./react-vendor-BvY2dB7B.js";import{u as Ar,l as wa,b as Ce,_ as ds,c as m,e as ya}from"./index-B7LKGTE9.js";import{P as ut,H as gs,a as Qt,b as Ls,d as Fs,e as zs,g as ka,R as va,f as Na,h as ja,i as Ia,j as Sa,C as Ea}from"./reactflow-D8v6_Qvs.js";import{C as Ca,L as Ds,S as mr,I as Lr,T as Br,V as Aa}from"./video-CPXLMxBS.js";import{c as Us}from"./createLucideIcon-CK1cQnin.js";import{X as _a,j as Qs,L as Vs,o as Pr,a as Ta,v as or,U as Or,b as Ua,N as Ra}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Us("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Us("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Us("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Us("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Us("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Us("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Us("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Er=Us("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Us("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Us("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hr=Us("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=Us("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),za="https://api.waule.ai";function Ba(s){const{workflowId:j,isSharedWorkflow:l,isReadOnly:W,onNodeAdd:fe,onNodeUpdate:T,onNodeDelete:pe,onNodeMove:Y,onNodesMove:se,onEdgeAdd:Q,onEdgeDelete:ce,onGroupsUpdate:Re,onUserJoin:de}=s,Z=t.useRef(null),re=t.useRef(!1),{token:je}=Ar(),[le,be]=t.useState([]);t.useEffect(()=>{if(!l||!j||!je)return;const p=wa(za,{auth:{token:je},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return Z.current=p,p.on("connect",()=>{re.current=!0,p.emit("join-workflow",j),p.emit("user:join",{workflowId:j})}),p.on("disconnect",b=>{re.current=!1}),p.on("connect_error",b=>{}),p.on("node:add",b=>{fe==null||fe(b.node,b.userId)}),p.on("node:update",b=>{T==null||T(b.nodeId,b.changes,b.userId)}),p.on("node:delete",b=>{pe==null||pe(b.nodeId,b.userId)}),p.on("node:move",b=>{Y==null||Y(b.nodeId,b.position,b.userId)}),p.on("nodes:move",b=>{se==null||se(b.nodes,b.userId)}),p.on("edge:add",b=>{Q==null||Q(b.edge,b.userId)}),p.on("edge:delete",b=>{ce==null||ce(b.edgeId,b.userId)}),p.on("groups:update",b=>{Re==null||Re(b.groups,b.userId)}),p.on("user:join",b=>{de==null||de(b.user)}),p.on("users:online",b=>{be(b.users)}),()=>{Z.current&&(Z.current.emit("leave-workflow",j),Z.current.disconnect(),Z.current=null),re.current=!1,be([])}},[j,l,je]);const ge=t.useCallback(p=>{Z.current&&re.current&&j&&!W&&Z.current.emit("node:add",{workflowId:j,node:p})},[j,W]),xe=t.useCallback((p,b)=>{Z.current&&re.current&&j&&!W&&Z.current.emit("node:update",{workflowId:j,nodeId:p,changes:b})},[j,W]),Ie=t.useCallback(p=>{Z.current&&re.current&&j&&!W&&Z.current.emit("node:delete",{workflowId:j,nodeId:p})},[j,W]),ae=t.useCallback((p,b)=>{Z.current&&re.current&&j&&!W&&Z.current.emit("node:move",{workflowId:j,nodeId:p,position:b})},[j,W]),ee=t.useCallback(p=>{Z.current&&re.current&&j&&!W&&Z.current.emit("nodes:move",{workflowId:j,nodes:p})},[j,W]),U=t.useCallback(p=>{Z.current&&re.current&&j&&!W&&Z.current.emit("edge:add",{workflowId:j,edge:p})},[j,W]),R=t.useCallback(p=>{Z.current&&re.current&&j&&!W&&Z.current.emit("edge:delete",{workflowId:j,edgeId:p})},[j,W]),D=t.useCallback(p=>{Z.current&&re.current&&j&&!W&&Z.current.emit("groups:update",{workflowId:j,groups:p})},[j,W]);return{isConnected:re.current,onlineUsers:le,emitNodeAdd:ge,emitNodeUpdate:xe,emitNodeDelete:Ie,emitNodeMove:ae,emitNodesMove:ee,emitEdgeAdd:U,emitEdgeDelete:R,emitGroupsUpdate:D}}const cr=2560,Ha=10,kr=(s,j=cr,l=.9)=>new Promise((W,fe)=>{const T=new Image,pe=URL.createObjectURL(s);T.onload=()=>{URL.revokeObjectURL(pe);let{width:Y,height:se}=T;const Q=Math.min(Y,se);if(Q>j){const Z=j/Q;Y=Math.round(Y*Z),se=Math.round(se*Z)}const ce=document.createElement("canvas");ce.width=Y,ce.height=se;const Re=ce.getContext("2d");if(!Re){fe(new Error("Failed to get canvas context"));return}Re.drawImage(T,0,0,Y,se);const de=ce.toDataURL("image/jpeg",l);W(de)},T.onerror=()=>{URL.revokeObjectURL(pe),fe(new Error("Failed to load image for compression"))},T.src=pe}),Gr=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(l=>l.test(s)):!1,Xa=async s=>{try{const j=s.startsWith("/uploads/")?`https://api.waule.ai${s}`:s,W=await(await fetch(j)).blob();return await kr(W,cr,.9)}catch(j){throw j}},ur=async(s,j)=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(j!=null&&j.skipCompression)return s;if(s.length>500*1024)try{const T=await(await fetch(s)).blob();return await kr(T,cr,.9)}catch{return s}return s}const l=s.includes("aliyuncs.com")||s.includes("oss-cn-"),W=s.startsWith("https://")&&!Gr(s);if(l||W){if(j!=null&&j.skipCompression)return s;try{const fe=new AbortController,T=setTimeout(()=>fe.abort(),3e4);let pe=0;try{const Z=(await fetch(s,{method:"HEAD",signal:fe.signal})).headers.get("content-length");Z&&(pe=parseInt(Z)/(1024*1024))}catch{}const Y=await fetch(s,{signal:fe.signal});clearTimeout(T);const se=await Y.blob();if(se.size/(1024*1024)>Ha)return await kr(se,cr,.85);const ce=await Ja(se);return Math.min(ce.width,ce.height)>cr?await kr(se,cr,.9):s}catch(fe){if(fe.name==="AbortError")throw new Error("å›¾ç‰‡ä¸‹è½½è¶…æ—¶");return s}}return Gr(s)?await Xa(s):s},Ja=s=>new Promise((j,l)=>{const W=new Image,fe=URL.createObjectURL(s);W.onload=()=>{URL.revokeObjectURL(fe),j({width:W.width,height:W.height})},W.onerror=()=>{URL.revokeObjectURL(fe),l(new Error("Failed to load image"))},W.src=fe}),St=({type:s,position:j,id:l,className:W="",label:fe,isConnectable:T,disabled:pe,style:Y,...se})=>{const Q=j===ut.Left,ce=T===!1||pe?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${W}`;return e.jsxs("div",{className:`absolute ${Q?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...Y||{}},children:[Q&&fe&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:fe}),e.jsx(gs,{type:s,position:j,id:l,isConnectable:pe?!1:T,style:{position:"relative",[Q?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${ce} !z-[10001]`,...se}),!Q&&fe&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:fe})]})},os=({value:s,onChange:j,options:l,className:W=""})=>{const[fe,T]=t.useState(!1),pe=t.useRef(null);t.useEffect(()=>{if(!fe)return;const Q=ce=>{pe.current&&!pe.current.contains(ce.target)&&T(!1)};return document.addEventListener("mousedown",Q,!0),()=>document.removeEventListener("mousedown",Q,!0)},[fe]);const Y=l.find(Q=>Q.value===s),se=Q=>{Q.stopPropagation(),T(!fe)};return e.jsxs("div",{className:`relative ${W}`,ref:pe,children:[e.jsxs("div",{onClick:se,onMouseDown:Q=>Q.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(Y==null?void 0:Y.label)||s}),e.jsx(Ca,{size:12,className:`transition-transform ${fe?"rotate-90":""}`})]}),fe&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white dark:bg-[#18181b] backdrop-blur-xl border-slate-200 dark:border-white/10",children:l.map(Q=>e.jsxs("div",{onClick:ce=>{ce.stopPropagation(),j(Q.value),T(!1)},onMouseDown:ce=>ce.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[Q.label,s===Q.value&&e.jsx(Da,{size:10,className:"text-neutral-500"})]},Q.value))})]})},Is=s=>{const[j,l]=t.useState(null),[W,fe]=t.useState(!1),[T,pe]=t.useState(!1),[Y,se]=t.useState(0),[Q,ce]=t.useState(0),Re=t.useCallback(()=>{ce(de=>de+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){l(null),pe(!1),se(0);return}try{fe(!0);const re=(await Ce.post("/billing/estimate",s)).data,je=(re==null?void 0:re.data)??re,le=(je==null?void 0:je.originalCredits)??(je==null?void 0:je.credits)??0;l(le),pe((je==null?void 0:je.isFreeUsage)??!1),se((je==null?void 0:je.freeUsageRemaining)??0)}catch{l(null),pe(!1),se(0)}finally{fe(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,Q]),{credits:j,loading:W,isFreeUsage:T,freeUsageRemaining:Y,refetch:Re}},hs=({createdBy:s,isSharedWorkflow:j})=>{if(!j||!s||typeof s=="string")return null;const{nickname:l,avatar:W}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:l||"æœªçŸ¥ç”¨æˆ·",children:W?e.jsx("img",{src:W,alt:l||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-neutral-800 to-neutral-700 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(l||"?")[0].toUpperCase()})})},qa=({data:s,selected:j,id:l})=>{var oe;const[W,fe]=t.useState(s.isExpanded!==!1),[T,pe]=t.useState(null),[Y,se]=t.useState(s.config.prompt||""),[Q,ce]=t.useState(s.config.ratio||""),[Re,de]=t.useState(s.config.imageSize||"2K"),[Z,re]=t.useState(s.config.maxImages||1),[je,le]=t.useState(!1),[,be]=t.useState(0),[,ge]=t.useState(s.config.taskId||""),[xe,Ie]=t.useState(s.config.referenceImages||[]),[ae,ee]=t.useState(null),U=t.useRef(null),R=t.useRef(!1),{setNodes:D,setEdges:p,getNode:b,getEdges:_,getNodes:z}=Qt(),P=Ls(),E=Fs(k=>k.edges.filter(h=>h.target===l)),V=t.useRef(""),a=t.useRef(""),{credits:v,loading:c,isFreeUsage:r,freeUsageRemaining:f,refetch:d}=Is({aiModelId:T==null?void 0:T.id,quantity:1,resolution:Re}),x=t.useMemo(()=>(s.models||[]).filter(k=>k.type==="IMAGE_GENERATION"&&k.isActive&&!k.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const k=x.find(h=>h.id===s.config.modelId);if(k){pe(k);const h=k.config;h!=null&&h.supportedRatios&&h.supportedRatios.length>0&&!Q&&ce(h.supportedRatios[0]),s.config.acceptedInputs||i({acceptedInputs:(h==null?void 0:h.acceptedInputs)||["TEXT","IMAGE"]})}}else if(x.length>0){pe(x[0]);const k=x[0].config;k!=null&&k.supportedRatios&&k.supportedRatios.length>0&&!Q&&ce(k.supportedRatios[0]),s.config.acceptedInputs||i({acceptedInputs:(k==null?void 0:k.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,x]),t.useEffect(()=>{const k=s.config.taskId;(async()=>{if(k)try{const y=(await Ce.tasks.getTaskStatus(k)).task;if(y.status==="SUCCESS"){le(!1),be(100);const J=y.resultUrl;if(!J){le(!1),be(0),i({taskId:""}),Vt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ue=s.config.ratio||"1:1";i({prompt:s.config.prompt||Y,ratio:ue,modelId:s.config.modelId||(T==null?void 0:T.id),generatedImageUrl:J,taskId:""});const H=z(),he=_();if(H.filter($e=>$e.type==="imagePreview"&&he.some(Ae=>Ae.source===l&&Ae.target===$e.id)).find($e=>$e.data.imageUrl===J)){i({taskId:""}),Vt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Vt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const $e=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse($e).some(Ue=>Ue.taskId&&Ue.taskId===k||Ue.sourceNodeId&&Ue.sourceNodeId===l)||me(J,ue)}catch{me(J,ue)}}else y.status==="PROCESSING"||y.status==="PENDING"?(le(!0),be(y.progress||0),B(k)):y.status==="FAILURE"&&(le(!1),be(0),i({taskId:""}),Vt.error(y.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${y.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{le(!1),be(0),i({taskId:""}),Vt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const g=()=>{if(!T)return[];const k=T.config;return(k==null?void 0:k.supportedRatios)||[]},w=()=>{var y;const k=(y=s==null?void 0:s.config)==null?void 0:y.modelId,h=x.find(J=>J.id===k)||x[0],S=(h==null?void 0:h.config)||{};return S.maxReferenceImages||S.supportedReferenceImagesLimit||S.referenceImagesLimit||10};function A(k){var S,y,J,ue,H,he,Ee;const h=(k==null?void 0:k.type)||"";if(h==="upload")return(((y=(S=k==null?void 0:k.data)==null?void 0:S.config)==null?void 0:y.uploadedFiles)||[]).reduce(($e,Ae)=>{const _e=((Ae==null?void 0:Ae.type)||"").toUpperCase(),Ue=((Ae==null?void 0:Ae.mimeType)||"").toLowerCase();return $e+(_e==="IMAGE"||Ue.startsWith("image/")?1:0)},0);if(h==="assetSelector"){const Ne=((J=k==null?void 0:k.data)==null?void 0:J.config)||{};if(Ne.selectedAsset){const $e=(Ne.selectedAsset.type||"").toUpperCase(),Ae=(Ne.selectedAsset.mimeType||"").toLowerCase();return $e==="IMAGE"||Ae.startsWith("image/")?1:0}return Array.isArray(Ne.subjects)&&Ne.subjects.length>0&&(((ue=Ne.subjects[0])==null?void 0:ue.images)||[]).length>0?1:0}return h==="aiImage"?((he=(H=k==null?void 0:k.data)==null?void 0:H.config)==null?void 0:he.generatedImageUrl)?1:0:h==="imagePreview"&&((Ee=k==null?void 0:k.data)==null?void 0:Ee.imageUrl)?1:0}function $(k){var y,J,ue,H;const h=(k==null?void 0:k.type)||"",S=k==null?void 0:k.data;if(h==="upload"&&((J=(y=S==null?void 0:S.config)==null?void 0:y.uploadedFiles)==null?void 0:J.length)>0){const he=S.config.uploadedFiles[0],Ee=(he.type||"").toUpperCase(),Ne=(he.mimeType||"").toLowerCase();return Ee==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ee==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ee==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ee||null}if(h==="assetSelector"){if((ue=S==null?void 0:S.config)!=null&&ue.subjects)return"IMAGE";if((H=S==null?void 0:S.config)!=null&&H.selectedAsset){const he=S.config.selectedAsset,Ee=(he.type||"").toUpperCase(),Ne=(he.mimeType||"").toLowerCase();return Ee==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ee==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ee==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ee||null}}return h==="aiImage"||h==="imagePreview"?"IMAGE":(h||"").startsWith("aiVideo")||h==="videoPreview"?"VIDEO":h==="agent"?"TEXT":null}const N=t.useMemo(()=>{const k=E,h=k.some(J=>{const ue=b(J.source);return((ue==null?void 0:ue.type)||"")==="agent"}),S=w(),y=k.reduce((J,ue)=>J+A(b(ue.source)),0);return h&&y>=S},[E,b]),u=k=>{const h=b(k.source);if(!h)return!1;const S=h.type||"",y=_().filter(Ne=>Ne.target===l),J=$(h);if(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")return!1;const ue=y.some(Ne=>{const $e=b(Ne.source);return(($e==null?void 0:$e.type)||"")==="agent"});if(S==="agent"||S==="textPreview")return!ue;const H=y.reduce((Ne,$e)=>Ne+A(b($e.source)),0),he=A(h),Ee=w();return H+he<=Ee};t.useEffect(()=>{const k=E;let S=w();const y=[];k.forEach(J=>{const ue=b(J.source),H=A(ue);H<=0||(S-H>=0?S-=H:y.push(J.id))}),y.length>0&&(p(J=>J.filter(ue=>!y.includes(ue.id))),Vt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[E,b,p]),t.useEffect(()=>{const k=E,h=[];k.forEach(S=>{const y=b(S.source),J=$(y);(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")&&h.push(S.id)}),h.length>0&&(p(S=>S.filter(y=>!h.includes(y.id))),Vt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[E,b,p]),t.useEffect(()=>{const k=E.map(ue=>{var Ne,$e,Ae,_e,Ue;const H=b(ue.source);if(!H)return`${ue.id}-${ue.source}`;const he=H.data||{};let Ee=[];if(H.type==="assetSelector"){const ie=(Ne=he.config)==null?void 0:Ne.subjects;if(ie&&ie.length>0){const Ve=($e=ie[0].images)==null?void 0:$e[0];Ee=Ve?[Ve]:[]}else(Ae=he.config)!=null&&Ae.selectedAsset&&he.config.selectedAsset.type==="IMAGE"&&(Ee=[he.config.selectedAsset.url])}else if(H.type==="upload")Ee=(((_e=he.config)==null?void 0:_e.uploadedFiles)||[]).filter(Ve=>Ve.type==="IMAGE").map(Ve=>Ve.url);else if(H.type==="aiImage"||H.type==="imagePreview"){const ie=((Ue=he.config)==null?void 0:Ue.generatedImageUrl)||he.imageUrl;ie&&(Ee=[ie])}return`${ue.id}-${ue.source}-${Ee.join("|")}`}).sort().join(",");if(k===V.current)return;V.current=k;const h=[];let S="";E.forEach(ue=>{var he,Ee,Ne,$e,Ae,_e;const H=b(ue.source);if(H){const Ue=H.data;if(H.type==="agent"&&((he=Ue.config)!=null&&he.generatedText)?S||(S=Ue.config.generatedText):H.type==="textPreview"&&Ue.content&&(S||(S=Ue.content)),H.type==="assetSelector"&&((Ee=Ue.config)!=null&&Ee.subjects)&&Ue.config.subjects.length>0){const Ve=(Ne=Ue.config.subjects[0].images)==null?void 0:Ne[0];Ve&&!h.includes(Ve)&&h.push(Ve)}let ie=(($e=Ue.config)==null?void 0:$e.generatedImageUrl)||Ue.imageUrl||"";if(!ie&&((Ae=Ue.config)!=null&&Ae.selectedAsset)){const Ve=Ue.config.selectedAsset;Ve.type==="IMAGE"&&(ie=Ve.url)}if(!ie&&((_e=Ue.config)!=null&&_e.uploadedFiles)&&Ue.config.uploadedFiles.length>0){const Ve=Ue.config.uploadedFiles[0];Ve.type==="IMAGE"&&(ie=Ve.url)}ie&&!h.includes(ie)&&h.push(ie)}});const y=w(),J=h.slice(0,Math.max(0,y));Ie(J),i({referenceImages:J}),S&&S!==Y&&(se(S),i({prompt:S}))},[E,b,l,Y,P]),t.useEffect(()=>{if(E.length===0)return;let k="",h="";E.forEach(S=>{var J;const y=P.find(ue=>ue.id===S.source);if(y&&y.type==="agent"){const ue=y.data;(J=ue.config)!=null&&J.generatedText&&(k=ue.config.generatedText,h=`${y.id}-${ue.config.generatedText.substring(0,50)}`)}}),k&&h!==a.current&&(a.current=h,se(k),i({prompt:k}))},[P,E,l]),t.useEffect(()=>{const k=U.current;k&&W&&requestAnimationFrame(()=>{k.style.height="auto";const h=Math.max(60,Math.min(k.scrollHeight,600));k.style.height=`${h}px`})},[Y,W]),t.useEffect(()=>{const k=setTimeout(()=>{Y!==s.config.prompt&&i({prompt:Y})},300);return()=>clearTimeout(k)},[Y]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Y&&se(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{Q&&Q!==s.config.ratio&&i({ratio:Q})},[Q]),t.useEffect(()=>{Re&&Re!==s.config.imageSize&&i({imageSize:Re})},[Re]),t.useEffect(()=>{var k;if((T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"){const h=((k=T==null?void 0:T.config)==null?void 0:k.supportedResolutions)||[];(h.length>0&&!h.includes(Re)||h.length===1)&&de(h[0])}},[T]),t.useEffect(()=>{Z!==s.config.maxImages&&i({maxImages:Z})},[Z]);const i=k=>{b(l)&&D(S=>S.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,...k}}}:y))},n=k=>{ee(k)},F=(k,h)=>{if(k.preventDefault(),ae===null||ae===h)return;const S=[...xe],y=S[ae];S.splice(ae,1),S.splice(h,0,y),Ie(S),ee(h)},M=()=>{ee(null),i({referenceImages:xe})},B=async k=>{let S=0;const y=async()=>{var J;try{S++;const H=(await Ce.tasks.getTaskStatus(k)).task;if(be(H.progress||0),H.status==="SUCCESS"){le(!1),be(100);const he=H.resultUrl,Ee=(J=H.metadata)==null?void 0:J.allImageUrls;i({prompt:Y,ratio:Q,modelId:T==null?void 0:T.id,generatedImageUrl:he,taskId:""}),Ee&&Ee.length>1?(ne(Ee,Q),Vt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Ee.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(me(he,Q),Vt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(H.status==="FAILURE"){le(!1),be(0),i({taskId:""});const{useAuthStore:he}=await ds(async()=>{const{useAuthStore:Ne}=await import("./index-B7LKGTE9.js").then($e=>$e.f);return{useAuthStore:Ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ee}=he.getState();await Ee(),Vt.error(H.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(H.status==="PROCESSING"||H.status==="PENDING")&&(S<600?setTimeout(y,1e3):(le(!1),be(0),i({taskId:""}),Vt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{le(!1),be(0),i({taskId:""}),Vt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};y()},G=async()=>{var k,h,S,y,J;if(!(!Y.trim()||!T)){le(!0),be(0);try{let ue=[];if(xe.length>0){const Ue=T.modelId==="gemini-3-pro-image-preview";try{for(let ie=0;ie<xe.length;ie++){const Ve=xe[ie];try{const Qe=await ur(Ve,{skipCompression:Ue});ue.push(Qe)}catch{}}}catch{}}let H=Y.trim();T.modelId==="doubao-seedream-4-5-251128"&&Z>1&&(H=`ç”Ÿæˆä¸€ç»„å…±${Z}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${H}`),T.modelId==="gemini-3-pro-image-preview"&&Q&&(H=`${H}ï¼Œç”Ÿæˆ${Q}çš„æ¯”ä¾‹`);const he={modelId:T.id,prompt:H,ratio:Q||"1:1",referenceImages:ue.length>0?ue:void 0};T.modelId==="gemini-3-pro-image-preview"&&(he.imageSize=Re),T.modelId==="doubao-seedream-4-5-251128"&&Z>1&&(he.maxImages=Z);const Ee=await Ce.tasks.createImageTask(he),Ne=Ee.taskId,$e=Ee.creditsCharged||0,Ae=Ee.isFreeUsage,_e=Ee.freeUsageRemaining??0;if(ge(Ne),i({prompt:Y,ratio:Q,modelId:T.id,taskId:Ne}),Ae)Vt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${_e} æ¬¡æœºä¼š`),d();else if($e>0){const{useAuthStore:Ue}=await ds(async()=>{const{useAuthStore:Ve}=await import("./index-B7LKGTE9.js").then(Qe=>Qe.f);return{useAuthStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:ie}=Ue.getState();await ie(),Vt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${$e} ç§¯åˆ†`),d()}else Vt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");B(Ne)}catch(ue){if(le(!1),be(0),((k=ue.response)==null?void 0:k.status)===403){const H=((S=(h=ue.response)==null?void 0:h.data)==null?void 0:S.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Vt.error(H)}else{const H=((J=(y=ue.response)==null?void 0:y.data)==null?void 0:J.error)||ue.message||"æœªçŸ¥åŸå› ";Vt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${H}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ne=(k,h)=>{!k||k.length===0||k.forEach((S,y)=>{setTimeout(()=>{me(S,h,y)},y*100)})},me=(k,h,S)=>{const y=b(l);if(!y)return;const J=1,ue=z(),H=_(),he=ue.filter(yt=>yt.type==="imagePreview"&&H.some(Be=>Be.source===l&&Be.target===yt.id));if(he.find(yt=>yt.data.imageUrl===k))return;const Ne=400,$e=(yt,Be=300)=>{if(!yt||!/^[0-9]+\s*:\s*[0-9]+$/.test(yt))return Be;const[wt,Kt]=yt.split(":").map(vs=>parseFloat(vs));return!wt||!Kt?Be:Math.round(Ne*(Kt/wt))},Ae=document.querySelector(`.react-flow__node[data-id="${l}"]`),_e=(Ae==null?void 0:Ae.getBoundingClientRect().width)||400,Ue=Math.round(_e/J),ie=200,Ve=100,Qe=$e(h,300),Ft=y.position.x+Ue+ie,Mt=y.position.y,At=S!==void 0?he.length+S:he.length,ct=Ft,gt=Mt+At*(Qe+Ve),vt=Date.now(),it={id:`preview-${l}-${vt}`,type:"imagePreview",position:{x:ct,y:gt},data:{imageUrl:k,width:Ne,ratio:h,workflowContext:y.data.workflowContext,createdBy:y.data.createdBy}};D(yt=>[...yt,it]);const Ke={id:`edge-${l}-${it.id}`,source:l,target:it.id,targetHandle:`${it.id}-target`,type:"aurora"};p(yt=>yt.find(wt=>wt.source===l&&wt.target===it.id)?yt:[...yt,Ke])};if(t.useEffect(()=>{s.isExpanded!==void 0&&fe(s.isExpanded)},[s.isExpanded]),!W&&s.config.generatedImageUrl){const[k,h]=(s.config.ratio||"1:1").split(":").map(Number),S=k/h,y=320,J=y/S;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:y,height:J},onDoubleClick:()=>{fe(!0),b(l)&&D(H=>H.map(he=>he.id===l?{...he,data:{...he.data,isExpanded:!0}}:he))},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:N,isValidConnection:u}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),Y&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:Y,children:Y})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!W&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{fe(!0),b(l)&&D(h=>h.map(S=>S.id===l?{...S,data:{...S.data,isExpanded:!0}}:S))},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:N,isValidConnection:u}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Y?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:Y})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:N,isValidConnection:u}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:W?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:(T==null?void 0:T.id)||"",onChange:k=>{const h=x.find(S=>S.id===k);if(pe(h||null),h){const S=h.config;S!=null&&S.supportedRatios&&S.supportedRatios.length>0&&ce(S.supportedRatios[0]),i({modelId:h.id,acceptedInputs:(S==null?void 0:S.acceptedInputs)||["TEXT","IMAGE"]})}},options:x.map(k=>({value:k.id,label:k.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:U,value:Y,onChange:k=>{R.current=!0,se(k.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),xe.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",xe.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:xe.map((k,h)=>e.jsxs("div",{draggable:!0,onDragStart:S=>{S.stopPropagation(),n(h)},onDragEnd:S=>{S.stopPropagation(),M()},onDragOver:S=>{S.stopPropagation(),F(S,h)},className:`nodrag relative group cursor-move aspect-square ${ae===h?"opacity-50":""}`,children:[e.jsx("img",{src:k,alt:`å›¾ç‰‡${h+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:h+1})]},h))})]}),(T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"&&(()=>{var h;const k=((h=T==null?void 0:T.config)==null?void 0:h.supportedResolutions)||[];return k.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${k.length} gap-2`,children:k.map(S=>e.jsx("button",{onClick:()=>de(S),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Re===S?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:S==="4K"?"4k":"hd"}),e.jsx("span",{children:S})]})},S))})]})})(),(T==null?void 0:T.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-neutral-500 dark:text-neutral-400",children:[Z," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:Z,onChange:k=>re(Number(k.target.value)),className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(Z-1)/14*50}%, #06b6d4 ${(Z-1)/14*100}%, var(--range-bg-color) ${(Z-1)/14*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),Z>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),g().length>0&&e.jsx("div",{className:"space-y-1",children:((oe=T==null?void 0:T.provider)==null?void 0:oe.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>ce("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Q==="16:9"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>ce("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Q==="9:16"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(os,{value:Q,onChange:k=>ce(k),options:g().map(k=>{const[h,S]=k.split(":");return{value:k,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[k]||`${h}:${S}`}})})]})}),e.jsx("button",{onClick:k=>{k.stopPropagation(),G()},onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),disabled:je||!Y.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${je||!Y.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:je?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!c&&(r?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(f),"æ¬¡"]}):v!==null&&v>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[v,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ka=t.memo(qa),pr="https://api.waule.ai",Ya=({data:s,selected:j,id:l})=>{var sr,rr,Ps,q,te,Me,Ge,qe,Oe,tt,bt;const[W,fe]=t.useState(!0),[,T]=t.useState(0),[pe,Y]=t.useState(s.config.taskId||""),se=s.config.modelId,Q=s.config.duration||5,ce=s.config.resolution||"720p",{credits:Re,loading:de,isFreeUsage:Z,freeUsageRemaining:re,refetch:je}=Is({aiModelId:se,duration:Q,resolution:ce});t.useEffect(()=>{},[pe]);const{setNodes:le,setEdges:be,getNode:ge,getNodes:xe,getEdges:Ie}=Qt(),ae=zs(),ee=Ls(),U=t.useRef(""),R=(sr=s.config)==null?void 0:sr.selectedEditingCapability,D=t.useMemo(()=>{const C=(s.models||[]).filter(O=>{var we;return((we=O.provider)==null?void 0:we.toLowerCase())!=="sora"&&O.id!=="sora-video"});if(R){const O=C.filter(Se=>Se.type==="VIDEO_EDITING").filter(Se=>{var ye;return Array.isArray((ye=Se==null?void 0:Se.config)==null?void 0:ye.supportedEditingCapabilities)&&Se.config.supportedEditingCapabilities.includes(R)}),we=C.filter(Se=>Se.type==="VIDEO_GENERATION").filter(Se=>{var kt,ht;if(R!=="è§†é¢‘æ¢äºº")return!1;const ye=((kt=Se==null?void 0:Se.config)==null?void 0:kt.supportsVideoEditing)===!0,st=(Array.isArray((ht=Se==null?void 0:Se.config)==null?void 0:ht.supportedGenerationTypes)?Se.config.supportedGenerationTypes:[]).some(We=>(We||"").toLowerCase().includes("æ¢äºº")||(We||"").includes("è§†é¢‘æ¢äºº"));return ye||st}),Te={};return[...O,...we].forEach(Se=>{Te[Se.id]||(Te[Se.id]=Se)}),Object.values(Te)}return C.filter(O=>O.type==="VIDEO_GENERATION")},[s.models,R]),[p,b]=t.useState(s.config.prompt||""),_=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==p&&b(s.config.prompt)},[s.config.prompt]);const[z,P]=t.useState(s.config.modelId||((rr=D[0])==null?void 0:rr.id)||""),[E,V]=t.useState(s.config.ratio||"16:9"),[a,v]=t.useState(s.config.resolution||""),c=t.useCallback(C=>{const O=(C||"").toLowerCase();return O?O.includes("æ–‡ç”Ÿ")||O.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":O.includes("é¦–å°¾")?"é¦–å°¾å¸§":O.includes("é¦–å¸§")||O.includes("first frame")||O.includes("start frame")||O.includes("initial frame")||O.includes("keyframe")?"é¦–å¸§":O.includes("å°¾å¸§")||O.includes("last frame")||O.includes("end frame")||O.includes("final frame")?"å°¾å¸§":O.includes("ä¸»ä½“å‚è€ƒ")||O.includes("å‚è€ƒ")||O.includes("reference image")||O.includes("image reference")||O.includes("ref image")?"å‚è€ƒå›¾":O.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":O.includes("first-last")||O.includes("two-frame")||O.includes("frame pair")?"é¦–å°¾å¸§":O.includes("first")?"é¦–å¸§":O.includes("last")?"å°¾å¸§":O.includes("subject")||O.includes("reference")?"å‚è€ƒå›¾":C||"":""},[]),[r,f]=t.useState((s.config.lockedGenerationType?c(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[d,x]=t.useState(s.config.duration||5),[g,w]=t.useState(s.config.audio||!1),[A,$]=t.useState(s.config.movementAmplitude||"auto"),[N,u]=t.useState(!1),[i,n]=t.useState([]),[F,M]=t.useState(null),[B,G]=t.useState(!1),[ne]=t.useState(""),[me]=t.useState("confirm"),[oe]=t.useState(null),[k,h]=t.useState(!1),[S,y]=t.useState([]),[J,ue]=t.useState(""),[H,he]=t.useState(0),[Ee,Ne]=t.useState(0),[$e,Ae]=t.useState({}),[_e,Ue]=t.useState([]),ie=D.find(C=>C.id===z);t.useEffect(()=>{var C,O;if(!D.find(we=>we.id===z)){const we=((C=D[0])==null?void 0:C.id)||"";P(we),ct({modelId:we,modelName:(O=D[0])==null?void 0:O.name})}},[D]),t.useEffect(()=>{var C;if((C=ie==null?void 0:ie.config.supportedResolutions)!=null&&C.length){const O=ie.config.supportedResolutions;if(!a||!O.includes(a)){const we=O[0];v(we),ct({resolution:we})}}},[ie==null?void 0:ie.id]),t.useEffect(()=>{var we;const C=(we=ie==null?void 0:ie.modelId)==null?void 0:we.includes("viduq2"),O=c(r)==="é¦–å°¾å¸§";C&&O&&d>8&&(x(8),ct({duration:8}))},[r,ie==null?void 0:ie.modelId]);const Ve=((Ps=ie==null?void 0:ie.provider)==null?void 0:Ps.toLowerCase())==="sora",Qe=t.useMemo(()=>{var C,O,we,Te;if((C=ie==null?void 0:ie.config.supportedDurations)!=null&&C.length){let Se=ie.config.supportedDurations;const ye=(O=ie.modelId)==null?void 0:O.includes("viduq2"),et=c(r)==="é¦–å°¾å¸§";return ye&&et&&(Se=Se.filter(kt=>kt<=8)),(((we=ie.provider)==null?void 0:we.toLowerCase())==="minimax"||((Te=ie.modelId)==null?void 0:Te.toLowerCase().includes("minimax")))&&a&&a.includes("1080")&&(Se=Se.filter(kt=>kt===6)),Se}return[d||5]},[ie,d,r,c,a]),Ft=t.useMemo(()=>{var C;return(C=ie==null?void 0:ie.config.supportedResolutions)!=null&&C.length?ie.config.supportedResolutions:[]},[ie]),Mt=!ie||!((q=ie.config.supportedDurations)!=null&&q.length),At=!ie||!((te=ie.config.supportedResolutions)!=null&&te.length),ct=t.useCallback(C=>{ge(l)&&le(we=>we.map(Te=>Te.id===l?{...Te,data:{...Te.data,config:{...Te.data.config,...C}}}:Te))},[ge,l,le]);t.useEffect(()=>{if(Qe.length>0&&!Qe.includes(d)){const C=Qe[0];x(C),ct({duration:C})}},[Qe,d,ct]);const gt=(C,O)=>{const we=(kt,ht)=>ht===0?kt:we(ht,kt%ht),Te=we(C,O),Se=C/Te,ye=O/Te,et={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},st=`${Se}:${ye}`;return et[st]||st},vt=()=>{const C=ae.filter(et=>et.target===l),O=[];C.forEach(et=>{var kt;const st=ge(et.source);if(st&&st.type==="upload"&&(((kt=st.data.config)==null?void 0:kt.uploadedFiles)||[]).forEach(We=>{const Dt=We.type||We.mimeType||"";(Dt==="IMAGE"||Dt.startsWith("image/"))&&O.push({id:We.id||We.name,url:We.url,name:We.name||We.originalName,width:We.width,height:We.height,aspectRatio:We.width&&We.height?gt(We.width,We.height):"16:9"})}),st&&st.type==="assetSelector"){const ht=st.data.config||{},We=ht.subjects,Dt=ht.selectedAsset,Xt=c(r);We&&We.length>0?Xt==="é¦–å°¾å¸§"||(We[0].images||[]).forEach((zt,Ct)=>{O.push({id:`${st.id}-subject-${Ct}`,url:zt,name:We[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Dt&&Dt.type==="IMAGE"&&O.push({id:Dt.id,url:Dt.url,name:Dt.name||Dt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(st&&st.type==="imagePreview"){const ht=st.data.imageUrl,We=st.data.width,Dt=st.data.height;ht&&O.push({id:st.id,url:ht,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:We,height:Dt,aspectRatio:We&&Dt?gt(We,Dt):"16:9"})}});const we=new Set,Te=[];O.forEach(et=>{const st=et.url;we.has(st)||(we.add(st),Te.push(et))});const Se=c(r);let ye=[];return Se==="æ–‡ç”Ÿè§†é¢‘"?ye=[]:Se==="é¦–å¸§"||Se==="å°¾å¸§"?ye=Te.slice(0,1):Se==="é¦–å°¾å¸§"?ye=Te.slice(0,2):Se==="å‚è€ƒå›¾"?ye=Te.slice(0,7):ye=Te,ye},it=t.useMemo(()=>vt(),[ae,ee,r,l]),Ke=C=>{if(!_.current)return;const O=_.current,we=O.selectionStart||p.length,Te=p.slice(0,we),Se=p.slice(we),ye=`@${C} `,et=Te+ye+Se;b(et),Ae(st=>({...st,[C]:`image-${C}`})),setTimeout(()=>{const st=we+ye.length;O.setSelectionRange(st,st),O.focus()},0)},yt=t.useCallback(async()=>{var C;if(!(_e.length>0))try{const O=await Ce.assetLibraries.getAll({includeShared:"true"}),we=O.data||O||[],Te=[];for(const Se of we)if(Se.category==="ROLE")try{const ye=await Ce.assetLibraries.roles.list(Se.id),et=ye.data||ye||[];for(const st of et)Te.push({id:st.id,name:((C=st.metadata)==null?void 0:C.name)||st.name||"",thumbnail:st.thumbnail})}catch{}Ue(Te)}catch{}},[_e.length]),Be=t.useCallback(C=>{if(!C){y(_e.slice(0,5));return}const O=_e.filter(we=>we.name.toLowerCase().includes(C.toLowerCase())).slice(0,5);y(O),Ne(0)},[_e]),wt=t.useCallback(C=>{const O=C.target.value,we=C.target.selectionStart||0;b(O);const Se=O.substring(0,we).match(/@([^@\s]*)$/);if(Se){const ye=Se[1];ue(ye),he(we-ye.length-1),h(!0),yt().then(()=>Be(ye))}else h(!1),y([])},[yt,Be]),Kt=t.useCallback(C=>{const O=p.substring(0,H),we=p.substring(H+J.length+1),Te=`@${C.name} `,Se=O+Te+we;b(Se),Ae(ye=>({...ye,[C.name]:C.id})),h(!1),y([]),ue(""),setTimeout(()=>{if(_.current){_.current.focus();const ye=O.length+Te.length;_.current.setSelectionRange(ye,ye)}},0)},[p,H,J]),vs=t.useCallback(C=>{!k||S.length===0||(C.key==="ArrowDown"?(C.preventDefault(),Ne(O=>O<S.length-1?O+1:O)):C.key==="ArrowUp"?(C.preventDefault(),Ne(O=>O>0?O-1:O)):C.key==="Enter"&&S[Ee]?(C.preventDefault(),Kt(S[Ee])):C.key==="Escape"&&h(!1))},[k,S,Ee,Kt]);t.useEffect(()=>{const C=s.config.taskId;(async()=>{if(C){try{const Te=(await Ce.tasks.getTaskStatus(C)).task;if(Te.status==="SUCCESS"){u(!1),T(100);const Se=Te.resultUrl;if(!Se){u(!1),T(0),ct({taskId:""}),Y(""),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ye=s.config.ratio||"16:9";ct({prompt:s.config.prompt||p,ratio:ye,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:Se,taskId:""}),Y("");const et=xe(),st=Ie();if(et.filter(We=>We.type==="videoPreview"&&st.some(Dt=>Dt.source===l&&Dt.target===We.id)).find(We=>We.data.videoUrl===Se)){setTimeout(()=>T(0),1e3);return}m.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const We=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(We).some(Pt=>Pt.taskId&&Pt.taskId===C||Pt.sourceNodeId&&Pt.sourceNodeId===l)||ws(Se,ye)}catch{ws(Se,ye)}setTimeout(()=>T(0),1e3)}else if(Te.status==="PROCESSING"||Te.status==="PENDING"){u(!0),T(Te.progress||0),Xs(C);return}else Te.status==="FAILURE"&&(u(!1),T(0),ct({taskId:""}),Y(""),m.error(`ç”Ÿæˆå¤±è´¥: ${Te.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{u(!1),T(0),ct({taskId:""}),Y(""),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const C=ae.filter(we=>we.target===l);let O="";C.forEach(we=>{var Se;const Te=ge(we.source);if(Te){const ye=Te.data;Te.type==="agent"&&((Se=ye.config)!=null&&Se.generatedText)?O||(O=ye.config.generatedText):Te.type==="textPreview"&&ye.content&&(O||(O=ye.content))}}),O&&O!==p&&(b(O),ct({prompt:O}))},[ae,l,ge,p,ct]),t.useEffect(()=>{const C=ae.filter(Te=>Te.target===l);if(C.length===0)return;let O="",we="";C.forEach(Te=>{var ye;const Se=ee.find(et=>et.id===Te.source);if(Se&&Se.type==="agent"){const et=Se.data;(ye=et.config)!=null&&ye.generatedText&&(O=et.config.generatedText,we=`${Se.id}-${et.config.generatedText.substring(0,50)}`)}}),O&&we!==U.current&&(U.current=we,b(O),ct({prompt:O}))},[ee,ae,l,ct]),t.useEffect(()=>{const C=JSON.stringify(it),O=JSON.stringify(i);C!==O&&n(it)},[it]);const Ss=t.useMemo(()=>{const C=i.length,O=c(r);return C===0?!0:C===1?O==="å‚è€ƒå›¾":C===2?O==="é¦–å°¾å¸§"?!1:O==="å‚è€ƒå›¾":C>2?O==="å‚è€ƒå›¾":!1},[i.length,r,c]),Es=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Ns=t.useMemo(()=>{const C=c(r);return R?D:D.filter(O=>{var Te;const we=(((Te=O.config)==null?void 0:Te.supportedGenerationTypes)||[]).map(Se=>c(Se));return C==="é¦–å¸§"||C==="å°¾å¸§"?we.includes("é¦–å¸§")||we.includes("å°¾å¸§"):we.includes(C)})},[D,r,c,R]),Bs=t.useMemo(()=>{const C=R?D:Ns;return C.length>0?C:R?(s.models||[]).filter(we=>(we.type||"")==="VIDEO_EDITING"):C},[R,D,Ns,s.models]);t.useEffect(()=>{var O,we;if(!Bs.find(Te=>Te.id===z)){const Te=((O=Bs[0])==null?void 0:O.id)||"";P(Te),ct({modelId:Te||void 0,modelName:Te?(we=Bs[0])==null?void 0:we.name:void 0})}},[Bs]);const ps=t.useCallback(C=>{const O=c(C);return R?["IMAGE","VIDEO"]:O==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[c,R]);t.useEffect(()=>{if(!Ss&&i.length>0){const C=i[0].aspectRatio;C&&E!==C&&(V(C),setTimeout(()=>{ct({ratio:C})},0))}},[Ss,i,E]),t.useEffect(()=>{if(!R&&Es.length>0&&!Es.includes(r)){const C="æ–‡ç”Ÿè§†é¢‘";f(C),setTimeout(()=>{ct({generationType:C,acceptedInputs:ps(C)})},0)}},[Es,r,ps,R]),t.useEffect(()=>{c(r)==="é¦–å°¾å¸§"&&g&&(w(!1),ct({audio:!1}))},[r,c]),t.useEffect(()=>{const C=c(r);if(C==="æ–‡ç”Ÿè§†é¢‘")return;const O=ae.filter(ye=>ye.target===l),we=[],Te=[];O.forEach(ye=>{var kt,ht,We,Dt,Xt;const et=ge(ye.source);if(!et)return;const st=et.type;if((st||"").startsWith("aiVideo")||st==="videoPreview"){Te.push(ye.id);return}if(st==="upload"){const Pt=(We=(ht=(kt=et.data)==null?void 0:kt.config)==null?void 0:ht.uploadedFiles)==null?void 0:We[0],zt=((Pt==null?void 0:Pt.type)||"").toUpperCase(),Ct=((Pt==null?void 0:Pt.mimeType)||"").toLowerCase();if(zt==="VIDEO"||Ct.startsWith("video/")){Te.push(ye.id);return}(zt==="IMAGE"||Ct.startsWith("image/"))&&we.push(ye.id);return}if(st==="assetSelector"){const Pt=((Dt=et.data)==null?void 0:Dt.config)||{};if(Pt.selectedAsset){const zt=(Pt.selectedAsset.type||"").toUpperCase(),Ct=(Pt.selectedAsset.mimeType||"").toLowerCase();zt==="VIDEO"||Ct.startsWith("video/")?Te.push(ye.id):(zt==="IMAGE"||Ct.startsWith("image/"))&&we.push(ye.id)}else if(Pt.subjects&&Pt.subjects.length>0){const zt=(((Xt=Pt.subjects[0])==null?void 0:Xt.images)||[]).length;C==="å‚è€ƒå›¾"||C==="é¦–å°¾å¸§"?we.push(ye.id):(C==="é¦–å¸§"||C==="å°¾å¸§")&&(zt>1?Te.push(ye.id):we.push(ye.id))}return}(st==="aiImage"||st==="imagePreview")&&we.push(ye.id)});let Se=new Set([...Te]);C==="é¦–å¸§"||C==="å°¾å¸§"?we.slice(1).forEach(ye=>Se.add(ye)):C==="é¦–å°¾å¸§"&&we.slice(2).forEach(ye=>Se.add(ye)),Se.size>0&&be(ye=>ye.filter(et=>!Se.has(et.id)))},[r,ae,l,ge,be,c]),t.useEffect(()=>{const C=s.config.generationType;if(!C||c(C)!==c(r)){const O=c(r)||"æ–‡ç”Ÿè§†é¢‘";ct({generationType:O,acceptedInputs:ps(O)})}},[]),t.useEffect(()=>{const C=ps(r);ct({acceptedInputs:C})},[r,ps]);const Zs=C=>{M(C)},Hs=C=>{C.preventDefault()},nr=C=>{if(F===null)return;const O=[...i],[we]=O.splice(F,1);O.splice(C,0,we),n(O),M(null),ct({referenceImages:O})};t.useEffect(()=>{const C=_.current;C&&W&&requestAnimationFrame(()=>{C.style.height="auto";const O=Math.max(60,Math.min(C.scrollHeight,600));C.style.height=`${O}px`})},[p,W]),t.useEffect(()=>{if(p===s.config.prompt)return;const C=setTimeout(()=>{ct({prompt:p})},500);return()=>clearTimeout(C)},[p]);const _t=C=>{var we,Te,Se;P(C);const O=Ns.find(ye=>ye.id===C);if(O){const ye=(we=O.config.supportedRatios)!=null&&we.length?O.config.supportedRatios:["16:9"],et=O.config.supportedResolutions||[],st=(Te=O.config.supportedGenerationTypes)!=null&&Te.length?O.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],kt=(Se=O.config.supportedDurations)!=null&&Se.length?O.config.supportedDurations:[5],ht=ye[0],We=et.length>0?et[0]:a,Dt=c(r||st[0]),Xt=kt[0],Pt=O.config.supportsAudioOutput?g:!1;V(ht),v(We),f(Dt),x(Xt),O.config.supportsAudioOutput||w(!1),ct({modelId:C,modelName:O.name,ratio:ht,resolution:We,generationType:Dt,duration:Xt,audio:Pt,acceptedInputs:ps(Dt)})}};t.useEffect(()=>{var O;const C=(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl;C&&ws(C,s.config.ratio||"16:9")},[(Me=s==null?void 0:s.config)==null?void 0:Me.generatedVideoUrl]);const Xs=async C=>{let we=0;const Te=async()=>{try{we++;const ye=(await Ce.tasks.getTaskStatus(C)).task;if(T(ye.progress||0),ye.status==="SUCCESS"||ye.status==="COMPLETED"||ye.status==="DONE"){u(!1),T(100);const et=ye.resultUrl;ws(et,s.config.ratio||"16:9"),ct({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:et}),Y(""),m.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>T(0),1e3);return}else if(ye.status==="FAILURE"){u(!1),T(0),ct({taskId:""});const{useAuthStore:et}=await ds(async()=>{const{useAuthStore:kt}=await import("./index-B7LKGTE9.js").then(ht=>ht.f);return{useAuthStore:kt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:st}=et.getState();await st(),m.error(ye.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(ye.status==="PROCESSING"||ye.status==="PENDING")&&(we<900?setTimeout(Te,1e3):(u(!1),T(0),ct({taskId:""}),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{u(!1),T(0),ct({taskId:""}),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Te()},bs=async()=>{var we,Te,Se,ye,et,st,kt;if(c(r)==="æ–‡ç”Ÿè§†é¢‘"&&!p.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯");return}u(!0);const O=vt();ct({referenceImages:O}),T(0);try{let ht=[],We;const Dt=i.length;if(i.length>0)try{for(const fs of i){let Bt=fs.url;!Bt.startsWith("data:")&&!Bt.startsWith("http")&&(Bt=`${pr}${Bt}`),Bt=Bt.replace(/^https?:\/\/localhost(?::\d+)?/i,pr);const Jt=await ur(Bt);ht.push(Jt)}}catch{m.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=ae.filter(fs=>fs.target===l);let Pt=[];if(c(r)==="å‚è€ƒå›¾"){const fs=/@(\S+)/g,Jt=[...p.matchAll(fs)].map(us=>us[1]);for(const us of Jt){const ss=$e[us];ss&&Pt.push(ss)}const as=new Map;for(const us of Xt){const ss=ge(us.source);if((ss==null?void 0:ss.type)==="assetSelector"){const Os=(we=ss.data.config)==null?void 0:we.roleIds;if(Os&&Os.length>0)for(const ms of Os)Pt.includes(ms)||Pt.push(ms);const ks=(Te=ss.data.config)==null?void 0:Te.subjects;if(ks&&ks.length>0){for(const ms of ks)if(!as.has(ms.name)){const qs=(ms.images||[]).map(Gs=>Gs.startsWith("http")||Gs.startsWith("data:")?Gs:`${pr}${Gs}`);as.set(ms.name,qs)}}}}if(as.size>0){const us=Array.from(as.entries());let ss=0;const Os=[];for(const[ks,ms]of us){if(ss>=7)break;const qs=7-ss,Gs=ms.slice(0,Math.max(0,qs));Gs.length>0&&(Os.push({name:ks,images:Gs}),ss+=Gs.length)}We=Os,us.some(([,ks])=>ks.length>0)&&ss<us.reduce((ks,[,ms])=>ks+ms.length,0)&&m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(ht.length>0){const us=it.filter(ss=>!ss.id.includes("subject"));us.length>0&&(We||(We=[]),us.forEach((ss,Os)=>{const ks=`å›¾${Os+1}`,ms=ss.url.startsWith("http")||ss.url.startsWith("data:")?ss.url:`${pr}${ss.url}`;We.push({name:ks,images:[ms]})}))}}const zt=We&&We.length>0?We.reduce((fs,Bt)=>{var Jt;return fs+(((Jt=Bt.images)==null?void 0:Jt.length)||0)},0):Dt,Ct=Pt.length>0;let Tt=r;if(Tt==="é¦–å¸§"||Tt==="å°¾å¸§"){if(zt!==1&&!Ct){m.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),u(!1),T(0);return}}else if(Tt==="é¦–å°¾å¸§"){if(zt===1)Tt="é¦–å¸§";else if(zt!==2&&!Ct){m.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),u(!1),T(0);return}We&&We.length>0?We=[{...We[0],images:We[0].images.slice(0,2)}]:ht=ht.slice(0,2)}else if(Tt==="å‚è€ƒå›¾"||Tt==="ä¸»ä½“å‚è€ƒ"){if(zt<1&&!Ct){m.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),u(!1),T(0);return}if(We&&We.length>0){if(We.reduce((Bt,Jt)=>{var as;return Bt+(((as=Jt.images)==null?void 0:as.length)||0)},0)>7){let Bt=7;We=We.map(Jt=>({...Jt,images:Jt.images.slice(0,Math.max(0,Bt-=Jt.images.length,Jt.images.length))})),Bt=7,We=We.map(Jt=>{const as=Jt.images.slice(0,Math.min(Jt.images.length,Bt));return Bt-=as.length,{...Jt,images:as}}).filter(Jt=>Jt.images.length>0),m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else ht.length>7&&(ht=ht.slice(0,7),m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}oe==="dropImages"&&(ht=[],We=void 0),(c(r)==="é¦–å¸§"||c(r)==="å°¾å¸§")&&oe==="useFirstImage"&&ht.length>=2&&(ht=[ht[0]]),c(r)==="é¦–å°¾å¸§"&&oe==="useFirstTwoImages"&&ht.length>=3&&(ht=ht.slice(0,2));const Gt={modelId:z,ratio:E,referenceImages:We&&We.length>0?void 0:ht.length>0?ht:void 0,roleIds:Pt.length>0?Pt:void 0,generationType:Tt,sourceNodeId:l,metadata:{duration:d,resolution:a,audio:g,movementAmplitude:A,roleIds:Pt.length>0?Pt:void 0},...We?{subjects:We}:{}};We&&We.length>0;const Wt=c(Tt);if(Wt==="æ–‡ç”Ÿè§†é¢‘"){if(!p.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯"),u(!1),T(0);return}Gt.prompt=p.trim()}else if(Wt==="å‚è€ƒå›¾"){if(!p.trim()){m.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),u(!1),T(0);return}Gt.prompt=p.trim()}else p.trim()&&(Gt.prompt=p.trim());const ts=await Ce.tasks.createVideoTask(Gt),rs=ts.taskId,ys=ts.creditsCharged||0,Js=ts.isFreeUsage,Cs=ts.freeUsageRemaining??0;if(Y(rs),ct({prompt:p,ratio:E,resolution:a,generationType:r,duration:d,modelId:z,taskId:rs}),Js)m.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Cs} æ¬¡`),je();else if(ys>0){const{useAuthStore:fs}=await ds(async()=>{const{useAuthStore:Jt}=await import("./index-B7LKGTE9.js").then(as=>as.f);return{useAuthStore:Jt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Bt}=fs.getState();await Bt(),m.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${ys} ç§¯åˆ†ï¼‰`),je()}else m.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Xs(rs)}catch(ht){if(u(!1),T(0),((Se=ht.response)==null?void 0:Se.status)===403){const We=((et=(ye=ht.response)==null?void 0:ye.data)==null?void 0:et.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";m.error(We)}else m.error(`æäº¤å¤±è´¥: ${((kt=(st=ht.response)==null?void 0:st.data)==null?void 0:kt.error)||ht.message}`)}},er=async()=>{const C=c(r),O=vt(),we=O.length,Te=(()=>{var et;const ye=ae.filter(st=>st.target===l);for(const st of ye){const kt=ge(st.source);if((kt==null?void 0:kt.type)==="assetSelector"){const ht=(et=kt.data.config)==null?void 0:et.subjects;if(ht&&ht.length>0)return!0}}return!1})(),Se=Object.keys($e).length>0;if((Te||Se)&&(C==="é¦–å¸§"||C==="å°¾å¸§"||C==="é¦–å°¾å¸§")){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((C==="é¦–å¸§"||C==="å°¾å¸§")&&we===0&&!Se){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(C==="é¦–å°¾å¸§"&&we===0&&!Se){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(C==="å‚è€ƒå›¾"&&we===0&&!Se){m.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(C==="æ–‡ç”Ÿè§†é¢‘"&&we>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((C==="é¦–å¸§"||C==="å°¾å¸§")&&we>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(C==="é¦–å°¾å¸§"&&we>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(C==="æ–‡ç”Ÿè§†é¢‘"&&!p.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!z){m.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}n(O),ct({referenceImages:O}),u(!0),T(0),await bs()},ws=(C,O)=>{const we=ge(l);if(!we||!C)return;const Te=O||E||"16:9",Se=xe(),ye=Ie(),et=Se.filter(Bt=>Bt.type==="videoPreview"&&ye.some(Jt=>Jt.source===l&&Jt.target===Bt.id));if(et.find(Bt=>Bt.data.videoUrl===C))return;const kt=1,ht=400,We=(Bt,Jt=300)=>{if(!Bt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Bt))return Jt;const[as,us]=Bt.split(":").map(ss=>parseFloat(ss));return!as||!us?Jt:Math.round(ht*(us/as))},Dt=document.querySelector(`.react-flow__node[data-id="${l}"]`),Xt=Dt==null?void 0:Dt.getBoundingClientRect(),Pt=Math.round(((Xt==null?void 0:Xt.width)||400)/kt),zt=100,Ct=200,Tt=We(Te,300),Gt=et.length,Wt=we.position.x+Pt+Ct,ts=we.position.y,rs=Wt,ys=ts+Gt*(Tt+zt),Js=Date.now(),Cs={id:`preview-${l}-${Js}`,type:"videoPreview",position:{x:rs,y:ys},data:{videoUrl:C,width:ht,ratio:Te,workflowContext:we.data.workflowContext,createdBy:we.data.createdBy}};le(Bt=>[...Bt,Cs]);const fs={id:`edge-${l}-${Cs.id}`,source:l,target:Cs.id,targetHandle:`${Cs.id}-target`,type:"aurora"};be(Bt=>Bt.find(as=>as.source===l&&as.target===Cs.id)?Bt:[...Bt,fs])},tr=C=>{const O=C.target;if(O.tagName==="INPUT"||O.tagName==="TEXTAREA"||O.tagName==="SELECT"||O.tagName==="BUTTON"||O.closest("button")||O.closest("input")||O.closest("textarea")||O.closest("select"))return;const we=!W;fe(we),le(Te=>Te.map(Se=>Se.id===l?{...Se,data:{...Se.data,isExpanded:we}}:Se))};return e.jsxs("div",{onDoubleClick:tr,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var ht;const C=((ht=ge(l))==null?void 0:ht.type)||"",O=c(r),we=O==="æ–‡ç”Ÿè§†é¢‘"||C==="aiVideo_t2v",Te=C==="aiVideo_i2v_first"||C==="aiVideo_i2v_last"||O==="é¦–å¸§"||O==="å°¾å¸§",Se=C==="aiVideo_first_last"||O==="é¦–å°¾å¸§",ye=C==="aiVideo_reference"||O==="å‚è€ƒå›¾",et=ae.filter(We=>We.target===l),st=et.some(We=>{const Dt=ge(We.source);return(Dt==null?void 0:Dt.type)==="agent"}),kt=et.reduce((We,Dt)=>{var zt,Ct,Tt,Gt;const Xt=ge(Dt.source),Pt=(Xt==null?void 0:Xt.type)||"";if(Pt==="aiImage"||Pt==="imagePreview")return We+1;if(Pt==="upload"){const Wt=(Tt=(Ct=(zt=Xt==null?void 0:Xt.data)==null?void 0:zt.config)==null?void 0:Ct.uploadedFiles)==null?void 0:Tt[0],ts=((Wt==null?void 0:Wt.type)||"").toUpperCase(),rs=((Wt==null?void 0:Wt.mimeType)||"").toLowerCase();return We+(ts==="IMAGE"||rs.startsWith("image/")?1:0)}if(Pt==="assetSelector"){const Wt=((Gt=Xt==null?void 0:Xt.data)==null?void 0:Gt.config)||{};if(Wt.selectedAsset)return We+((Wt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Wt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Wt.subjects&&Wt.subjects.length>0)return We+((Wt.subjects[0].images||[]).length||0)}return We},0);return we?!st:Te?!(st&&kt>=1):Se?!(st&&kt>=2):ye?!(st&&kt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),B&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ne}),me==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{G(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{G(!1),m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{G(!1),await bs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:z,onChange:C=>_t(C),options:Ns.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Ns.map(C=>({value:C.id,label:C.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ve?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:_,value:p,onChange:C=>{var Se;const O=(Se=ie==null?void 0:ie.modelId)==null?void 0:Se.includes("viduq2"),we=c(r)==="å‚è€ƒå›¾";O&&we?wt(C):(b(C.target.value),h(!1))},onKeyDown:C=>{var Te;const O=(Te=ie==null?void 0:ie.modelId)==null?void 0:Te.includes("viduq2"),we=c(r)==="å‚è€ƒå›¾";O&&we&&vs(C)},placeholder:(Ge=ie==null?void 0:ie.modelId)!=null&&Ge.includes("viduq2")&&c(r)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),k&&S.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:S.map((C,O)=>e.jsxs("button",{type:"button",onClick:()=>Kt(C),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${O===Ee?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[C.thumbnail?e.jsx("img",{src:C.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",C.name]})})]},C.id))})]})]}),Object.keys($e).length>0&&((qe=ie==null?void 0:ie.modelId)==null?void 0:qe.includes("viduq2"))&&c(r)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys($e).map(C=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-neutral-500/10 dark:bg-neutral-500/20 border border-neutral-400/50 dark:border-neutral-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-neutral-700 dark:text-neutral-300",children:C}),e.jsx("button",{type:"button",onClick:()=>{Ae(Te=>{const Se={...Te};return delete Se[C],Se});const O=new RegExp(`@${C}\\s*`,"g"),we=p.replace(O,"");b(we)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},C))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ve&&i.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(Oe=i[0])!=null&&Oe.name&&i[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",r==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",c(r)==="å‚è€ƒå›¾"&&i.some(C=>!C.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:i.map((C,O)=>{const we=i.slice(0,O+1).filter(ye=>!ye.id.includes("subject")).length,Te=!C.id.includes("subject"),Se=Te?`å›¾${we}`:C.name;return e.jsxs("div",{draggable:r==="é¦–å°¾å¸§",onDragStart:()=>Zs(O),onDragOver:Hs,onDrop:()=>nr(O),onClick:()=>{Te&&c(r)==="å‚è€ƒå›¾"&&Ke(Se)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${r==="é¦–å°¾å¸§"?"cursor-move":Te&&c(r)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${F===O?"opacity-50":""} ${C.id.includes("subject")?"border-neutral-400 dark:border-neutral-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-neutral-400 dark:hover:border-neutral-400/50 ${Te&&c(r)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Te&&c(r)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${Se}`:C.name,children:[e.jsx("img",{src:`${C.url.startsWith("http")||C.url.startsWith("data:")?C.url:pr+C.url}`,alt:C.name,className:"w-full h-full object-cover"}),C.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),C.name]}),Te&&r!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),Se]}),r==="é¦–å°¾å¸§"&&!C.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:O===0?"é¦–":O===1?"å°¾":O+1})]},C.id)})})]}),ie&&!Ve&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",Mt?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Qe.map(C=>e.jsxs("button",{type:"button",onClick:()=>{x(C),ct({duration:C})},disabled:Mt,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${d===C?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:[C,"ç§’"]},C))})]}),Ss&&(((tt=ie==null?void 0:ie.config.supportedRatios)==null?void 0:tt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ve?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{V("16:9"),ct({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${E==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{V("9:16"),ct({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${E==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:E,onChange:C=>{V(C),ct({ratio:C})},options:((ie==null?void 0:ie.config.supportedRatios)||[]).map(C=>{const[O,we]=C.split(":");return{value:C,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[C]||`${O}:${we}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",At?"(æœªé…ç½®)":""]}),e.jsx(os,{value:a,onChange:C=>{v(C),ct({resolution:C})},options:Ft.map(C=>({value:C,label:C})),className:At?"opacity-50 pointer-events-none":""})]}),((bt=ie==null?void 0:ie.provider)==null?void 0:bt.toLowerCase())==="vidu"&&(ie==null?void 0:ie.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(C=>e.jsx("button",{type:"button",onClick:()=>{$(C),ct({movementAmplitude:C})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${A===C?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:C==="auto"?"è‡ªåŠ¨":C==="small"?"å°":C==="medium"?"ä¸­":"å¤§"},C))})]}),(ie==null?void 0:ie.config.supportsAudioOutput)&&c(r)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const C=!g;w(C),ct({audio:C})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${g?"bg-neutral-800 dark:bg-white text-white dark:text-black":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${g?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:er,disabled:N||s._canEdit===!1||c(r)==="æ–‡ç”Ÿè§†é¢‘"&&!(p!=null&&p.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${N||c(r)==="æ–‡ç”Ÿè§†é¢‘"&&!(p!=null&&p.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:N?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!de&&(Z?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(re),"æ¬¡"]}):Re!==null&&Re>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Re,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:p?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:p})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},gr=t.memo(Ya),Qa=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Za=t.memo(Qa),eo=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},to=t.memo(eo),so=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},ro=t.memo(so),ao=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},oo=t.memo(ao),no=s=>{const j=(s==null?void 0:s.data)||{},l=j.config||{};return e.jsx(gr,{...s,data:{...j,config:{...l,generationType:(l==null?void 0:l.lockedGenerationType)||(l==null?void 0:l.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(l==null?void 0:l.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(l==null?void 0:l.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(l==null?void 0:l.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},io=t.memo(no),lr="https://api.waule.ai",lo=({data:s,selected:j,id:l})=>{var P,E,V,a,v,c;const[W]=t.useState(!0),[fe,T]=t.useState(!1),[pe]=t.useState(""),[Y,se]=t.useState("wan-std"),[Q,ce]=t.useState(0),Re=t.useRef(null),{setNodes:de,setEdges:Z,getNode:re,getNodes:je,getEdges:le}=Qt(),be=zs(),ge=s.config.modelId,{credits:xe,loading:Ie}=Is({aiModelId:ge,duration:Q,mode:Y==="wan-pro"?"pro":"standard"}),ae=t.useMemo(()=>{var d;const r=s.models||[],f=(d=s==null?void 0:s.config)==null?void 0:d.selectedEditingCapability;return r.filter(x=>{var g;return(x.type||"")==="VIDEO_EDITING"&&Array.isArray((g=x.config)==null?void 0:g.supportedEditingCapabilities)&&(f?x.config.supportedEditingCapabilities.includes(f):x.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||x.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(P=s==null?void 0:s.config)==null?void 0:P.selectedEditingCapability]),[ee,U]=t.useState(s.config.modelId||((E=ae[0])==null?void 0:E.id)||""),R=t.useMemo(()=>ae.find(r=>r.id===ee),[ae,ee]);t.useEffect(()=>{var r;if(!ae.find(f=>f.id===ee)){const f=((r=ae[0])==null?void 0:r.id)||"";U(f),de(d=>d.map(x=>{var g;return x.id===l?{...x,data:{...x.data,config:{...x.data.config,modelId:f||void 0,modelName:f?(g=ae[0])==null?void 0:g.name:void 0}}}:x}))}},[ae]),t.useEffect(()=>{},[R]);const D=t.useMemo(()=>{var A,$,N,u,i,n,F,M,B,G,ne,me,oe,k,h,S;const r=be.filter(y=>y.target===l);let f=null,d=0,x=null,g=null,w=null;for(const y of r){const J=re(y.source);if(!J)continue;const ue=String(J.type||"");if(ue==="upload"){const H=(N=($=(A=J.data)==null?void 0:A.config)==null?void 0:$.uploadedFiles)==null?void 0:N[0];if(!H)continue;const he=String(H.mimeType||"").toLowerCase(),Ee=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${lr}${H.url}`;!x&&(Ee==="VIDEO"||he.startsWith("video/"))&&(x=Ne,w=y.id),!f&&(Ee==="IMAGE"||he.startsWith("image/"))&&(f=Ne,d=H.size||0,g=y.id)}else if(ue==="assetSelector"){const H=(i=(u=J.data)==null?void 0:u.config)==null?void 0:i.selectedAsset;if(H){const Ee=String(H.mimeType||"").toLowerCase(),Ne=String(H.type||"").toUpperCase(),$e=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${lr}${H.url}`;!x&&(Ne==="VIDEO"||Ee.startsWith("video/"))&&(x=$e,w=y.id),!f&&(Ne==="IMAGE"||Ee.startsWith("image/"))&&(f=$e,d=H.size||0,g=y.id)}const he=((F=(n=J.data)==null?void 0:n.config)==null?void 0:F.subjects)||[];if(!f&&Array.isArray(he)&&he.length>0){const Ne=(((M=he[0])==null?void 0:M.images)||[])[0];Ne&&(f=Ne.startsWith("http")||Ne.startsWith("data:")?Ne:`${lr}${Ne}`,g=y.id)}}else if(ue==="aiImage"){const H=(G=(B=J.data)==null?void 0:B.config)==null?void 0:G.generatedImageUrl;!f&&H&&(f=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,g=y.id)}else if(ue==="imagePreview"){const H=((ne=J.data)==null?void 0:ne.imageUrl)||((me=J.data)==null?void 0:me.url);!f&&H&&(f=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,g=y.id)}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const H=((oe=J.data)==null?void 0:oe.videoUrl)||((k=J.data)==null?void 0:k.url)||((S=(h=J.data)==null?void 0:h.config)==null?void 0:S.generatedVideoUrl);!x&&H&&(x=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,w=y.id)}if(f&&x)break}return{imageUrl:f,videoUrl:x,imageSize:d,imageEdgeId:g,videoEdgeId:w}},[be,l,re]);t.useEffect(()=>{if(D.imageSize>5*1024*1024){const f=(D.imageSize/1024/1024).toFixed(2);m.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${f}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),D.imageEdgeId&&Z(d=>d.filter(x=>x.id!==D.imageEdgeId))}if(!D.videoUrl){ce(0);return}const r=document.createElement("video");r.src=D.videoUrl,r.onloadedmetadata=()=>{const f=r.duration||0,d=r.videoWidth,x=r.videoHeight;ce(f);let g="";f<2||f>30?g=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${f.toFixed(1)}ç§’ï¼‰`:(d>2048||x>2048)&&(g=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${d}x${x}ï¼‰`),g&&(m.error(g+"ï¼Œè¿æ¥å·²æ–­å¼€"),D.videoEdgeId&&Z(w=>w.filter(A=>A.id!==D.videoEdgeId)))},r.onerror=()=>ce(0),r.load()},[D.videoUrl,D.imageSize,D.videoEdgeId,D.imageEdgeId,Z]);const p=t.useMemo(()=>!!ee&&!!D.videoUrl&&!!D.imageUrl,[ee,D.videoUrl,D.imageUrl]),b=t.useCallback(r=>{var k,h,S;const f=re(l);if(!f||!r)return;const d=je(),x=le(),g=d.filter(y=>y.type==="videoPreview"&&x.some(J=>J.source===l&&J.target===y.id));if(g.find(y=>{var J;return((J=y.data)==null?void 0:J.videoUrl)===r}))return;const A=400,$=(y,J=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(y))return J;const[ue,H]=y.split(":").map(he=>parseFloat(he));return!ue||!H?J:Math.round(A*(H/ue))},N=200,u=100,i=$("16:9",300),n=document.querySelector(`.react-flow__node[data-id="${l}"]`),F=Math.round((n==null?void 0:n.getBoundingClientRect().width)||400),M=(((k=f.position)==null?void 0:k.x)||0)+F+N,B=((h=f.position)==null?void 0:h.y)||0,G=g.length,ne=M,me=B+G*(i+u),oe={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:ne,y:me},data:{videoUrl:r,width:A,ratio:"16:9",workflowContext:f.data.workflowContext,createdBy:(S=f.data)==null?void 0:S.createdBy}};de(y=>[...y,oe]),Z(y=>[...y,{id:`edge-${l}-${oe.id}`,source:l,target:oe.id,type:"aurora"}])},[l,re,je,le,de,Z]);t.useEffect(()=>{var f;const r=(f=s==null?void 0:s.config)==null?void 0:f.generatedVideoUrl;r&&b(r)},[(V=s==null?void 0:s.config)==null?void 0:V.generatedVideoUrl]),t.useEffect(()=>{const r=s.config.taskId;(async()=>{var x,g;let d=!1;if(r)try{const A=(await Ce.tasks.getTaskStatus(r)).task;if(A.status==="SUCCESS"){const $=A.resultUrl||((x=A.previewNodeData)==null?void 0:x.url);if($){let N=!1;try{const u=localStorage.getItem("suppressedPreviewTasks")||"[]";N=JSON.parse(u).some(n=>n.taskId&&n.taskId===r||n.sourceNodeId&&n.sourceNodeId===l)}catch{}N||b($),de(u=>u.map(i=>i.id===l?{...i,data:{...i.data,config:{...i.data.config,generatedVideoUrl:$,taskId:r}}}:i))}T(!1),d=!0}else if(A.status==="PROCESSING"||A.status==="PENDING"){T(!0),await _(r);return}else A.status==="FAILURE"&&(T(!1),de($=>$.map(N=>N.id===l?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N)))}catch{T(!1)}if(!d)try{const w=await Ce.tasks.getPendingPreviewNodes(l);if(Array.isArray(w.tasks)&&w.tasks.length>0)for(const A of w.tasks){const $=(g=A.previewNodeData)==null?void 0:g.url;if($){let N=!1;try{const u=localStorage.getItem("suppressedPreviewTasks")||"[]";N=JSON.parse(u).some(n=>n.taskId&&n.taskId===A.id||n.sourceNodeId&&n.sourceNodeId===l)}catch{}N||b($),await Ce.tasks.markPreviewNodeCreated(A.id)}}}catch{}})()},[]);const _=async r=>{let f=0;const d=600,x=async()=>{var g;try{f++;const A=(await Ce.tasks.getTaskStatus(r)).task;if(A.status==="SUCCESS"){const $=A.resultUrl||((g=A.previewNodeData)==null?void 0:g.url);if($){let N=!1;try{const u=localStorage.getItem("suppressedPreviewTasks")||"[]";N=JSON.parse(u).some(n=>n.taskId&&n.taskId===r||n.sourceNodeId&&n.sourceNodeId===l)}catch{}N||b($),de(u=>u.map(i=>i.id!==l?i:{...i,data:{...i.data,config:{...i.data.config,generatedVideoUrl:$,taskId:r}}}))}T(!1),m.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(A.status==="PROCESSING"||A.status==="PENDING")if(f<d)setTimeout(x,5e3);else{T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),de($=>$.map(N=>N.id===l?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N));return}else if(A.status==="FAILURE"){T(!1);try{const{useAuthStore:$}=await ds(async()=>{const{useAuthStore:u}=await import("./index-B7LKGTE9.js").then(i=>i.f);return{useAuthStore:u}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:N}=$.getState();await N()}catch{}m.error(A.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),de($=>$.map(N=>N.id===l?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N));return}else{T(!1),m.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),de($=>$.map(N=>N.id===l?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N));return}}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),de(A=>A.map($=>$.id===l?{...$,data:{...$.data,config:{...$.data.config,taskId:""}}}:$));return}};x()},z=async()=>{var r,f;if(!p){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}T(!0);try{const d=await Ce.post("/tasks/video-edit",{modelId:ee,prompt:pe||"",referenceImages:D.imageUrl?[D.imageUrl]:[],sourceNodeId:l,duration:Q,metadata:{videoUrl:D.videoUrl,wanMode:Y,duration:Q}}),x=d.taskId,g=d.creditsCharged||0;if(g>0)try{const{useAuthStore:w}=await ds(async()=>{const{useAuthStore:$}=await import("./index-B7LKGTE9.js").then(N=>N.f);return{useAuthStore:$}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:A}=w.getState();await A(),m.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${g} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");de(w=>w.map(A=>A.id===l?{...A,data:{...A.data,config:{...A.data.config,taskId:x}}}:A)),await _(x)}catch(d){T(!1);const x=((f=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:f.error)||d.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${x}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((a=s==null?void 0:s.config)==null?void 0:a.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:ee,onChange:r=>{U(r),de(f=>f.map(d=>{var x;return d.id===l?{...d,data:{...d.data,config:{...d.data.config,modelId:r,modelName:(x=ae.find(g=>g.id===r))==null?void 0:x.name}}}:d}))},options:ae.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:ae.map(r=>({value:r.id,label:r.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>se("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Y==="wan-std"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>se("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Y==="wan-pro"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((v=s==null?void 0:s.config)==null?void 0:v.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),D.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Re,src:D.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:r=>{const f=r.currentTarget;f.duration&&f.duration!==1/0&&ce(f.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((c=s==null?void 0:s.config)==null?void 0:c.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),D.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:D.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:z,disabled:fe||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${fe?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ie&&(xe!==null&&xe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[xe,"ç§¯åˆ†"]}):Q===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},co=t.memo(lo),wr="https://api.waule.ai",uo=({data:s,selected:j,id:l})=>{var $,N;const[W]=t.useState(!0),[fe,T]=t.useState(!1),[pe,Y]=t.useState(!1),se=t.useRef(null),Q=t.useRef(null),ce=t.useRef(null),[Re,de]=t.useState(!1),[Z,re]=t.useState(0),[je,le]=t.useState(0),[be,ge]=t.useState(0),[xe,Ie]=t.useState(null),{setNodes:ae,setEdges:ee,getNode:U,getNodes:R,getEdges:D}=Qt(),p=zs(),b=Ls(),_=t.useMemo(()=>`lipSyncTask:${l}`,[l]),z=t.useMemo(()=>(s.models||[]).filter(i=>{var n;return(i.type||"")==="VIDEO_EDITING"&&Array.isArray((n=i.config)==null?void 0:n.supportedEditingCapabilities)&&i.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[P,E]=t.useState(s.config.modelId||(($=z[0])==null?void 0:$.id)||"");t.useEffect(()=>{var u;if(!z.find(i=>i.id===P)){const i=((u=z[0])==null?void 0:u.id)||"";E(i),ae(n=>n.map(F=>{var M;return F.id===l?{...F,data:{...F.data,config:{...F.data.config,modelId:i||void 0,modelName:i?(M=z[0])==null?void 0:M.name:void 0}}}:F}))}},[z]);const V=t.useMemo(()=>!je||!Z?0:je>=Z||pe?Z:je,[je,Z,pe]),{credits:a,loading:v}=Is({aiModelId:P,duration:V,mode:"standard",operationType:"video_retalk"}),c=t.useMemo(()=>{var M,B,G,ne,me,oe,k,h,S;const u=p.filter(y=>y.target===l);let i=null,n=null,F=null;for(const y of u){const J=b.find(H=>H.id===y.source);if(!J)continue;const ue=String(J.type||"");if(ue==="upload"){const H=(G=(B=(M=J.data)==null?void 0:M.config)==null?void 0:B.uploadedFiles)==null?void 0:G[0];if(!H)continue;const he=String(H.mimeType||"").toLowerCase(),Ee=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${wr}${H.url}`;!i&&(Ee==="VIDEO"||he.startsWith("video/"))&&(i=Ne),!n&&(Ee==="AUDIO"||he.startsWith("audio/"))&&(n=Ne),!F&&(Ee==="IMAGE"||he.startsWith("image/"))&&(F=Ne)}else if(ue==="assetSelector"){const H=(me=(ne=J.data)==null?void 0:ne.config)==null?void 0:me.selectedAsset;if(H){const he=String(H.mimeType||"").toLowerCase(),Ee=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${wr}${H.url}`;!i&&(Ee==="VIDEO"||he.startsWith("video/"))&&(i=Ne),!n&&(Ee==="AUDIO"||he.startsWith("audio/"))&&(n=Ne),!F&&(Ee==="IMAGE"||he.startsWith("image/"))&&(F=Ne)}}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const H=((oe=J.data)==null?void 0:oe.videoUrl)||((k=J.data)==null?void 0:k.url)||((S=(h=J.data)==null?void 0:h.config)==null?void 0:S.generatedVideoUrl);!i&&H&&(i=H.startsWith("http")||H.startsWith("data:")?H:`${wr}${H}`)}if(i&&n&&F)break}return{videoUrl:i,audioUrl:n,imageUrl:F}},[p,l,b]),r=t.useMemo(()=>{var i;const u=z.find(n=>n.id===P);return((i=u==null?void 0:u.modelId)==null?void 0:i.toLowerCase().includes("videoretalk"))||!1},[P,z]),f=t.useMemo(()=>!!P&&!!c.videoUrl&&!!c.audioUrl&&!xe,[P,c.videoUrl,c.audioUrl,xe]);t.useEffect(()=>{const u=se.current;if(!u||!c.audioUrl)return;u.src=c.audioUrl,u.load();const i=()=>{re(u.duration||0)},n=()=>ge(u.duration?u.currentTime/u.duration:0),F=()=>de(!1);return u.addEventListener("loadedmetadata",i),u.addEventListener("timeupdate",n),u.addEventListener("ended",F),()=>{u.removeEventListener("loadedmetadata",i),u.removeEventListener("timeupdate",n),u.removeEventListener("ended",F)}},[c.audioUrl]),t.useEffect(()=>{if(!c.videoUrl){le(0);return}const u=document.createElement("video");u.src=c.videoUrl,u.onloadedmetadata=()=>{if(le(u.duration||0),r){const i=u.videoWidth,n=u.videoHeight;i>2048||n>2048?(Ie(`è§†é¢‘åˆ†è¾¨ç‡ ${i}x${n} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),m.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${i}x${n}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),ee(F=>F.filter(M=>{var ne,me,oe,k,h,S,y,J;if(M.target!==l)return!0;const B=b.find(ue=>ue.id===M.source);return B?!(B.type==="upload"&&((k=(oe=(me=(ne=B.data)==null?void 0:ne.config)==null?void 0:me.uploadedFiles)==null?void 0:oe[0])==null?void 0:k.type)==="VIDEO"||B.type==="assetSelector"&&((y=(S=(h=B.data)==null?void 0:h.config)==null?void 0:S.selectedAsset)==null?void 0:y.type)==="VIDEO"||B.type==="videoPreview"||((J=B.type)==null?void 0:J.startsWith("aiVideo"))):!0}))):xe!=null&&xe.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ie(null)}},u.onerror=()=>le(0),u.load()},[c.videoUrl,r,l,b,ee]),t.useEffect(()=>{const u=c.audioUrl,i=ce.current;if(!u||!i)return;const n=M=>{const B=i.getContext("2d");if(!B)return;const G=i.width,ne=i.height;B.clearRect(0,0,G,ne);const me="#1a1033",oe="#7a0fe8";B.fillStyle=me,B.fillRect(0,0,G,ne);const k=M.length,h=2,S=Math.max(1,Math.floor((G-(k-1)*h)/k));for(let y=0;y<k;y++){const J=Math.min(1,Math.max(0,M[y])),ue=Math.max(2,Math.floor(J*ne)),H=y*(S+h),he=Math.floor((ne-ue)/2);B.fillStyle=oe,B.fillRect(H,he,S,ue)}if(be>0){const y=Math.floor(G*be);B.fillStyle="#ffffff88",B.fillRect(y,0,2,ne)}};(async()=>{try{let M=u;u.includes("aliyuncs.com")&&(M=`https://api.waule.ai/proxy/audio?url=${encodeURIComponent(u)}`);const G=await(await fetch(M,{mode:(u.includes("aliyuncs.com"),"cors"),credentials:u.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ne=window.AudioContext||window.webkitAudioContext,k=(await new ne().decodeAudioData(G)).getChannelData(0),h=120,S=Math.max(1,Math.floor(k.length/h)),y=new Float32Array(h);for(let J=0;J<h;J++){let ue=0,H=0;const he=J*S,Ee=Math.min(k.length,he+S);for(let Ne=he;Ne<Ee;Ne++)ue+=Math.abs(k[Ne]),H++;y[J]=H?ue/H:0}n(y)}catch{const B=new Float32Array(120);for(let G=0;G<120;G++)B[G]=(Math.sin(G/5)+1)/2;n(B)}})()},[c.audioUrl,be]);const d=()=>{const u=se.current;u&&(Re?(u.pause(),de(!1)):(u.play(),de(!0)))},x=u=>{if(!u||!isFinite(u))return"0:00";const i=Math.floor(u/60),n=Math.floor(u%60);return`${i}:${n.toString().padStart(2,"0")}`},g=t.useCallback(u=>{var $e,Ae,_e;const i=U(l);if(!i||!u)return;const n=u.startsWith("http")||u.startsWith("data:")?u:`${wr}${u}`,F=R(),M=D(),B=F.filter(Ue=>Ue.type==="videoPreview"&&M.some(ie=>ie.source===l&&ie.target===Ue.id));if(B.find(Ue=>{var ie;return((ie=Ue.data)==null?void 0:ie.videoUrl)===n}))return;const ne=400,me=(Ue,ie=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(Ue))return ie;const[Ve,Qe]=Ue.split(":").map(Ft=>parseFloat(Ft));return!Ve||!Qe?ie:Math.round(ne*(Qe/Ve))},oe=200,k=100,h=me("16:9",300),S=document.querySelector(`.react-flow__node[data-id="${l}"]`),y=Math.round((S==null?void 0:S.getBoundingClientRect().width)||400),J=((($e=i.position)==null?void 0:$e.x)||0)+y+oe,ue=((Ae=i.position)==null?void 0:Ae.y)||0,H=B.length,he=J,Ee=ue+H*(h+k),Ne={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:he,y:Ee},data:{videoUrl:n,ratio:"16:9",workflowContext:i.data.workflowContext,createdBy:(_e=i.data)==null?void 0:_e.createdBy}};ae(Ue=>[...Ue,Ne]),ee(Ue=>[...Ue,{id:`edge-${l}-${Ne.id}`,source:l,target:Ne.id,type:"aurora"}])},[l,U,R,D,ae,ee]);t.useEffect(()=>{var i;const u=(i=s==null?void 0:s.config)==null?void 0:i.generatedVideoUrl;u&&g(u)},[(N=s==null?void 0:s.config)==null?void 0:N.generatedVideoUrl]),t.useEffect(()=>{const u=s.config.taskId||(()=>{try{return localStorage.getItem(_)||""}catch{return""}})();(async()=>{var F,M;let n=!1;if(u)try{const G=(await Ce.tasks.getTaskStatus(u)).task;if(G.status==="PROCESSING"||G.status==="PENDING"){const ne=new Date(G.createdAt);if((new Date().getTime()-ne.getTime())/(1e3*60*60)>1){T(!1),ae(k=>k.map(h=>h.id===l?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}}if(G.status==="SUCCESS"||G.status==="COMPLETED"||G.status==="DONE"){const ne=G.resultUrl||((F=G.previewNodeData)==null?void 0:F.url);if(ne){let me=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";me=JSON.parse(oe).some(h=>h.taskId&&h.taskId===u||h.sourceNodeId&&h.sourceNodeId===l)}catch{}me||g(ne),ae(oe=>oe.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,generatedVideoUrl:ne,taskId:u}}}:k))}T(!1);try{localStorage.removeItem(_)}catch{}n=!0}else if(G.status==="PROCESSING"||G.status==="PENDING"){T(!0),await w(u);return}else if(G.status==="FAILURE"||G.status==="FAILED"){T(!1),ae(ne=>ne.map(me=>me.id===l?{...me,data:{...me.data,config:{...me.data.config,taskId:""}}}:me));try{localStorage.removeItem(_)}catch{}}}catch{T(!1);try{localStorage.removeItem(_)}catch{}}if(!n)try{const B=await Ce.tasks.getPendingPreviewNodes(l);if(Array.isArray(B.tasks)&&B.tasks.length>0)for(const G of B.tasks){const ne=(M=G.previewNodeData)==null?void 0:M.url;if(ne){let me=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";me=JSON.parse(oe).some(h=>h.taskId&&h.taskId===G.id||h.sourceNodeId&&h.sourceNodeId===l)}catch{}me||g(ne),await Ce.tasks.markPreviewNodeCreated(G.id)}}}catch{}})()},[_,l,g]);const w=async u=>{let i=0;const n=600;let F=-1,M=0;const B=60,G=async()=>{var ne;try{i++;const oe=(await Ce.tasks.getTaskStatus(u)).task;if(oe.status==="PROCESSING"||oe.status==="PENDING"){const k=oe.progress||0;if(k===F){if(M++,M>=B){T(!1),m.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),ae(h=>h.map(S=>S.id===l?{...S,data:{...S.data,config:{...S.data.config,taskId:""}}}:S));try{localStorage.removeItem(_)}catch{}return}}else F=k,M=0}if(oe.status==="SUCCESS"||oe.status==="COMPLETED"||oe.status==="DONE"){const k=oe.resultUrl||((ne=oe.previewNodeData)==null?void 0:ne.url);k&&(g(k),ae(h=>h.map(S=>S.id===l?{...S,data:{...S.data,config:{...S.data.config,generatedVideoUrl:k,taskId:u}}}:S))),T(!1),m.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(_)}catch{}return}else if(oe.status==="PROCESSING"||oe.status==="PENDING")if(i<n)setTimeout(G,5e3);else{T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ae(k=>k.map(h=>h.id===l?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}else if(oe.status==="FAILURE"||oe.status==="FAILED"){T(!1);try{const{useAuthStore:k}=await ds(async()=>{const{useAuthStore:S}=await import("./index-B7LKGTE9.js").then(y=>y.f);return{useAuthStore:S}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:h}=k.getState();await h()}catch{}m.error(oe.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ae(k=>k.map(h=>h.id===l?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}else{T(!1),m.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),ae(k=>k.map(h=>h.id===l?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ae(oe=>oe.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));try{localStorage.removeItem(_)}catch{}return}};G()},A=async()=>{var u,i;if(!f){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}T(!0);try{const n=await Ce.post("/tasks/video-edit",{modelId:P,prompt:"",referenceImages:c.imageUrl?[c.imageUrl]:[],sourceNodeId:l,generationType:"å¯¹å£å‹",duration:V,metadata:{videoUrl:c.videoUrl,audioUrl:c.audioUrl,videoExtension:pe,duration:V}}),F=n.taskId,M=n.creditsCharged||0;if(M>0)try{const{useAuthStore:B}=await ds(async()=>{const{useAuthStore:ne}=await import("./index-B7LKGTE9.js").then(me=>me.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:G}=B.getState();await G(),m.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ae(B=>B.map(G=>G.id===l?{...G,data:{...G.data,config:{...G.data.config,taskId:F}}}:G));try{localStorage.setItem(_,F)}catch{}await w(F)}catch(n){T(!1);const F=((i=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:i.error)||n.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${F}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(_)}catch{}}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:P,onChange:u=>{E(u),ae(i=>i.map(n=>{var F;return n.id===l?{...n,data:{...n.data,config:{...n.data.config,modelId:u,modelName:(F=z.find(M=>M.id===u))==null?void 0:F.name}}}:n}))},options:z.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:z.map(u=>({value:u.id,label:u.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:c.videoUrl?e.jsx("video",{src:c.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},c.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:c.imageUrl?e.jsx("img",{src:c.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},c.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),c.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:d,className:"nodrag w-7 h-7 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Re?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:x(Z)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:ce,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:se,src:c.audioUrl,className:"hidden"}),e.jsx("video",{ref:Q,className:"hidden",muted:!0,onLoadedMetadata:u=>{const i=u.currentTarget;i.duration&&i.duration!==1/0&&le(i.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:pe,onChange:u=>Y(u.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:A,disabled:fe||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${fe?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!v&&(a!==null&&a>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[a,"ç§¯åˆ†"]}):V===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},go=t.memo(uo),jr="https://api.waule.ai",ho=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],po=({data:s,selected:j,id:l})=>{var z,P;const[W]=t.useState(!0),[fe,T]=t.useState(!1),[pe,Y]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[se,Q]=t.useState(s.config.videoFps||15),[ce,Re]=t.useState(0),de=t.useRef(null),{setNodes:Z,setEdges:re,getNode:je,getNodes:le,getEdges:be}=Qt(),ge=zs(),xe=t.useMemo(()=>(s.models||[]).filter(V=>{var a;return(V.type||"")==="VIDEO_EDITING"&&Array.isArray((a=V.config)==null?void 0:a.supportedEditingCapabilities)&&V.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ie,ae]=t.useState(s.config.modelId||((z=xe[0])==null?void 0:z.id)||""),{credits:ee,loading:U}=Is({aiModelId:Ie,duration:ce});t.useMemo(()=>xe.find(E=>E.id===Ie),[xe,Ie]),t.useEffect(()=>{var E;if(!xe.find(V=>V.id===Ie)){const V=((E=xe[0])==null?void 0:E.id)||"";ae(V),Z(a=>a.map(v=>{var c;return v.id===l?{...v,data:{...v.data,config:{...v.data.config,modelId:V||void 0,modelName:V?(c=xe[0])==null?void 0:c.name:void 0}}}:v}))}},[xe]);const R=t.useMemo(()=>{var a,v,c,r,f,d,x,g,w;const E=ge.filter(A=>A.target===l);let V=null;for(const A of E){const $=je(A.source);if(!$)continue;const N=String($.type||"");if(N==="upload"){const u=(c=(v=(a=$.data)==null?void 0:a.config)==null?void 0:v.uploadedFiles)==null?void 0:c[0];if(!u)continue;const i=String(u.mimeType||"").toLowerCase(),n=String(u.type||"").toUpperCase(),F=u.url.startsWith("http")||u.url.startsWith("data:")?u.url:`${jr}${u.url}`;!V&&(n==="VIDEO"||i.startsWith("video/"))&&(V=F)}else if(N==="assetSelector"){const u=(f=(r=$.data)==null?void 0:r.config)==null?void 0:f.selectedAsset;if(u){const i=String(u.mimeType||"").toLowerCase(),n=String(u.type||"").toUpperCase(),F=u.url.startsWith("http")||u.url.startsWith("data:")?u.url:`${jr}${u.url}`;!V&&(n==="VIDEO"||i.startsWith("video/"))&&(V=F)}}else if(N==="videoPreview"||N.startsWith("aiVideo")){const u=((d=$.data)==null?void 0:d.videoUrl)||((x=$.data)==null?void 0:x.url)||((w=(g=$.data)==null?void 0:g.config)==null?void 0:w.generatedVideoUrl);!V&&u&&(V=u.startsWith("http")||u.startsWith("data:")?u:`${jr}${u}`)}if(V)break}return{videoUrl:V}},[ge,l,je]);t.useEffect(()=>{if(!R.videoUrl){Re(0);return}const E=document.createElement("video");E.preload="metadata",E.onloadedmetadata=()=>{E.duration&&E.duration!==1/0&&Re(E.duration)},E.onerror=()=>Re(0),E.src=R.videoUrl},[R.videoUrl]);const D=t.useMemo(()=>!!Ie&&!!R.videoUrl,[Ie,R.videoUrl]),p=t.useCallback(E=>{var B,G,ne;const V=je(l);if(!V||!E)return;const a=le(),v=be(),c=a.filter(me=>me.type==="videoPreview"&&v.some(oe=>oe.source===l&&oe.target===me.id));if(c.find(me=>{var oe;return((oe=me.data)==null?void 0:oe.videoUrl)===E}))return;const f=400,d=(me,oe=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(me))return oe;const[k,h]=me.split(":").map(S=>parseFloat(S));return!k||!h?oe:Math.round(f*(h/k))},x=200,g=100,w=d("16:9",300),A=document.querySelector(`.react-flow__node[data-id="${l}"]`),$=Math.round((A==null?void 0:A.getBoundingClientRect().width)||400),N=(((B=V.position)==null?void 0:B.x)||0)+$+x,u=((G=V.position)==null?void 0:G.y)||0,i=c.length,n=N,F=u+i*(w+g),M={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:n,y:F},data:{videoUrl:E,width:f,ratio:"16:9",workflowContext:V.data.workflowContext,createdBy:(ne=V.data)==null?void 0:ne.createdBy}};Z(me=>[...me,M]),re(me=>[...me,{id:`edge-${l}-${M.id}`,source:l,target:M.id,type:"aurora"}])},[l,je,le,be,Z,re]);t.useEffect(()=>{var V;const E=(V=s==null?void 0:s.config)==null?void 0:V.generatedVideoUrl;E&&p(E)},[(P=s==null?void 0:s.config)==null?void 0:P.generatedVideoUrl]),t.useEffect(()=>{const E=s.config.taskId;(async()=>{var v,c;let a=!1;if(E)try{const f=(await Ce.tasks.getTaskStatus(E)).task;if(f.status==="SUCCESS"){const d=f.resultUrl||((v=f.previewNodeData)==null?void 0:v.url);if(d){let x=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";x=JSON.parse(g).some(A=>A.taskId&&A.taskId===E||A.sourceNodeId&&A.sourceNodeId===l)}catch{}x||p(d),Z(g=>g.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,generatedVideoUrl:d,taskId:E}}}:w))}T(!1),a=!0}else if(f.status==="PROCESSING"||f.status==="PENDING"){T(!0),await b(E);return}else f.status==="FAILURE"&&(T(!1),Z(d=>d.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x)))}catch{T(!1)}if(!a)try{const r=await Ce.tasks.getPendingPreviewNodes(l);if(Array.isArray(r.tasks)&&r.tasks.length>0)for(const f of r.tasks){const d=(c=f.previewNodeData)==null?void 0:c.url;if(d){let x=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";x=JSON.parse(g).some(A=>A.taskId&&A.taskId===f.id||A.sourceNodeId&&A.sourceNodeId===l)}catch{}x||p(d),await Ce.tasks.markPreviewNodeCreated(f.id)}}}catch{}})()},[]);const b=async E=>{let V=0;const a=600,v=async()=>{var c;try{V++;const f=(await Ce.tasks.getTaskStatus(E)).task;if(f.status==="SUCCESS"){const d=f.resultUrl||((c=f.previewNodeData)==null?void 0:c.url);d&&(p(d),Z(x=>x.map(g=>g.id!==l?g:{...g,data:{...g.data,config:{...g.data.config,generatedVideoUrl:d,taskId:E}}}))),T(!1),m.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else f.status==="PROCESSING"||f.status==="PENDING"?V<a?setTimeout(v,5e3):(T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(d=>d.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x))):f.status==="FAILURE"&&(T(!1),m.error(f.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),Z(d=>d.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x)))}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(f=>f.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d))}};v()},_=async()=>{var E,V;if(!D){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}T(!0);try{const a=await Ce.post("/tasks/video-edit",{modelId:Ie,prompt:"",referenceImages:[],sourceNodeId:l,generationType:"é£æ ¼è½¬æ¢",duration:ce,metadata:{videoUrl:R.videoUrl,styleId:pe,videoFps:se,duration:ce}}),v=a.taskId,c=a.creditsCharged||0;if(c>0)try{const{useAuthStore:r}=await ds(async()=>{const{useAuthStore:d}=await import("./index-B7LKGTE9.js").then(x=>x.f);return{useAuthStore:d}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:f}=r.getState();await f(),m.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${c} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");Z(r=>r.map(f=>f.id===l?{...f,data:{...f.data,config:{...f.data.config,taskId:v,styleId:pe,videoFps:se}}}:f)),await b(v)}catch(a){T(!1);const v=((V=(E=a==null?void 0:a.response)==null?void 0:E.data)==null?void 0:V.error)||a.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${v}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(os,{value:Ie,onChange:E=>{ae(E),Z(V=>V.map(a=>{var v;return a.id===l?{...a,data:{...a.data,config:{...a.data.config,modelId:E,modelName:(v=xe.find(c=>c.id===E))==null?void 0:v.name}}}:a}))},options:xe.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:xe.map(E=>({value:E.id,label:E.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(os,{value:String(pe),onChange:E=>{const V=parseInt(E,10);Y(V),Z(a=>a.map(v=>v.id===l?{...v,data:{...v.data,config:{...v.data.config,styleId:V}}}:v))},options:ho.map(E=>({value:String(E.id),label:E.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:se,min:15,max:25,onChange:E=>{let V=parseInt(E.target.value,10)||15;V<15&&(V=15),V>25&&(V=25),Q(V),Z(a=>a.map(v=>v.id===l?{...v,data:{...v.data,config:{...v.data.config,videoFps:V}}}:v))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),R.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:de,src:R.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:E=>{const V=E.currentTarget;V.duration&&V.duration!==1/0&&Re(V.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:_,disabled:fe||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${fe?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!U&&(ee!==null&&ee>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ee,"ç§¯åˆ†"]}):ce===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},fo=t.memo(po),mo=({data:s,selected:j,id:l})=>{const[W,fe]=t.useState(null),[T,pe]=t.useState(!1),[Y,se]=t.useState(s.config.prompt||""),[Q,ce]=t.useState(""),Re=t.useRef(null),de=t.useRef(!1),[Z,re]=t.useState(!1),{setNodes:je,setEdges:le,getNode:be,getNodes:ge,getEdges:xe}=Qt(),Ie=Fs(r=>r.edges.filter(f=>f.target===l)),ae=Ls(),[ee,U]=t.useState([]),[R,D]=t.useState([]),p=t.useRef(""),b=t.useMemo(()=>((W==null?void 0:W.roles)||[]).find(r=>r.id===Q),[W,Q]),{credits:_,loading:z,isFreeUsage:P,freeUsageRemaining:E}=Is({aiModelId:b==null?void 0:b.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&V(s.config.agentId)},[s.config.agentId]);const V=async r=>{var f,d,x,g,w;try{pe(!0);const A=await Ce.agents.getById(r);let $=[];try{$=await Ce.agents.roles.listByAgent(r)||[],fe({...A,roles:$});const u=((f=s==null?void 0:s.config)==null?void 0:f.roleId)||"";ce(u||((d=$[0])==null?void 0:d.id)||"")}catch{fe(A)}try{const N=await Ce.agents.getAvailableModels(),u=($||[]).find(i=>{var n;return i.id===((n=s==null?void 0:s.config)==null?void 0:n.roleId)});if(u){const i=(N||[]).find(F=>F.id===u.aiModelId),n=((x=i==null?void 0:i.config)==null?void 0:x.acceptedInputs)||((i==null?void 0:i.type)==="TEXT_GENERATION"&&((w=(g=i==null?void 0:i.provider)==null?void 0:g.toLowerCase())!=null&&w.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);a({acceptedInputs:n})}else a({acceptedInputs:["TEXT"]})}catch{}}catch{m.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{pe(!1)}};t.useEffect(()=>{a({roleId:Q}),(async()=>{var r,f,d;if(W)try{const x=await Ce.agents.getAvailableModels(),g=(W.roles||[]).find(w=>w.id===Q);if(g){const w=(x||[]).find($=>$.id===g.aiModelId),A=((r=w==null?void 0:w.config)==null?void 0:r.acceptedInputs)||((w==null?void 0:w.type)==="TEXT_GENERATION"&&((d=(f=w==null?void 0:w.provider)==null?void 0:f.toLowerCase())!=null&&d.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);a({acceptedInputs:A})}else a({acceptedInputs:["TEXT"]})}catch{}})()},[Q,W]);const a=r=>{be(l)&&je(d=>d.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,...r}}}:x))};t.useEffect(()=>{const r=Re.current;r&&requestAnimationFrame(()=>{r.style.height="auto";const f=Math.max(60,Math.min(r.scrollHeight,600));r.style.height=`${f}px`})},[Y]),t.useEffect(()=>{const r=setTimeout(()=>{Y!==s.config.prompt&&a({prompt:Y})},500);return()=>clearTimeout(r)},[Y,s.config.prompt]),t.useEffect(()=>{const r=Ie;if(!r||r.length===0)return;let f="";r.some(d=>{const x=ae.find(w=>w.id===d.source);if(!x)return!1;const g=x.data||{};return x.type==="textPreview"&&typeof g.content=="string"&&g.content.trim()?(f=g.content.trim(),!0):!1}),f&&!de.current&&(se(f),a({prompt:f}))},[Ie,ae]),t.useEffect(()=>{const r=Ie.map(x=>`${x.id}-${x.source}`).sort().join(",");if(r===p.current)return;p.current=r;const f=[],d=[];Ie.forEach(x=>{var A,$,N;const g=be(x.source);if(!g)return;const w=g.data||{};if(g.type==="upload")(((A=w.config)==null?void 0:A.uploadedFiles)||[]).forEach(i=>{i.type==="IMAGE"&&f.push(i.url),i.type==="DOCUMENT"&&d.push({name:i.originalName,url:i.url})});else if(g.type==="assetSelector"){const u=($=w.config)==null?void 0:$.subjects;if(u&&u.length>0)(u[0].images||[]).map(n=>{const F="https://api.waule.ai";return n.startsWith("data:")?n:n.startsWith("http")?n.replace(/^https?:\/\/localhost(?::\d+)?/i,F):`${F}${n}`}).forEach(n=>f.push(n));else{const i=(N=w.config)==null?void 0:N.selectedAsset;if(i){const n="https://api.waule.ai",F=M=>M.startsWith("http")?M.replace(/^https?:\/\/localhost(?::\d+)?/i,n):`${n}${M}`;i.type==="IMAGE"&&f.push(F(i.url)),i.type==="DOCUMENT"&&d.push({name:i.originalName,url:F(i.url)})}}}else g.type==="imagePreview"&&w.imageUrl&&f.push(w.imageUrl)}),U(f),D(d)},[Ie,be,ae]);const v=()=>{if(!W)return null;const r=(W.roles||[]).find(f=>f.id===Q);return r?{systemPrompt:r.systemPrompt,aiModelId:r.aiModelId,temperature:r.temperature,maxTokens:r.maxTokens}:null},c=async()=>{var f,d,x,g,w,A,$,N,u,i,n,F,M,B;if(!W){m.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!Y.trim()){m.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let r=(W.roles||[]).find(G=>G.id===Q)||(W.roles||[])[0];if(!r){m.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!Q||Q!==r.id)&&(ce(r.id),a({roleId:r.id}));try{re(!0);const ne=xe().filter(Ae=>Ae.target===l);let me="";const oe="https://api.waule.ai",k=[],h=[],S=[];for(const Ae of ne){const _e=be(Ae.source);if(_e)if(_e.type==="upload"){const Ue=((d=(f=_e.data)==null?void 0:f.config)==null?void 0:d.uploadedFiles)||[];for(const ie of Ue)if(ie.type==="DOCUMENT")k.push({filePath:ie.url,mimeType:ie.mimeType}),me+=`[æ–‡æ¡£æ–‡ä»¶: ${ie.originalName}]
`;else if(ie.type==="IMAGE"){const Ve=ie.url.startsWith("http")?ie.url:`${oe}${ie.url}`;h.push(Ve),me+=`[å›¾ç‰‡æ–‡ä»¶: ${ie.originalName}]
`}else if(ie.type==="VIDEO"){const Ve=ie.url.startsWith("http")?ie.url:`${oe}${ie.url}`;S.push(Ve),me+=`[è§†é¢‘æ–‡ä»¶: ${ie.originalName}]
`}else ie.type==="AUDIO"&&(me+=`[éŸ³é¢‘æ–‡ä»¶: ${ie.originalName}]
`)}else if(_e.type==="assetSelector"){const Ue=(g=(x=_e.data)==null?void 0:x.config)==null?void 0:g.subjects;if(Ue&&Ue.length>0){const ie=(Ue[0].images||[]).map(Ve=>Ve.startsWith("http")?Ve:`${oe}${Ve}`).map(Ve=>Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe));ie.forEach(Ve=>h.push(Ve)),me+=`[å‚è€ƒå›¾ç‰‡ç»„: ${ie.length} å¼ ]
`}else{const ie=(A=(w=_e.data)==null?void 0:w.config)==null?void 0:A.selectedAsset;if(ie){if(ie.type==="DOCUMENT")k.push({filePath:ie.url,mimeType:ie.mimeType}),me+=`[æ–‡æ¡£æ–‡ä»¶: ${ie.originalName}]
`;else if(ie.type==="IMAGE"){let Ve=ie.url.startsWith("http")?ie.url:`${oe}${ie.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),h.push(Ve),me+=`[å›¾ç‰‡æ–‡ä»¶: ${ie.originalName}]
`}else if(ie.type==="VIDEO"){let Ve=ie.url.startsWith("http")?ie.url:`${oe}${ie.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),S.push(Ve),me+=`[è§†é¢‘æ–‡ä»¶: ${ie.originalName}]
`}}}}else if(_e.type==="aiImage"){const Ue=(N=($=_e.data)==null?void 0:$.config)==null?void 0:N.generatedImageUrl;if(Ue){const ie=Ue.startsWith("http")?Ue:`${oe}${Ue}`;h.push(ie),me+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(_e.type==="imagePreview"){const Ue=_e.data.imageUrl;Ue&&(h.push(Ue),me+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(_e.type==="videoPreview"){const Ue=_e.data.videoUrl;if(Ue){const ie=Ue.startsWith("http")?Ue:`${oe}${Ue}`;S.push(ie),me+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else _e.type==="textPreview"&&_e.data.content&&(me+=_e.data.content+`

`)}const y=v();if(!y)return;let J=y.systemPrompt;me&&(J+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${me}`),J+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${Y}`;const ue=await Ce.ai.text.generate({modelId:r.aiModel.id||y.aiModelId,prompt:J,systemPrompt:r.systemPrompt||y.systemPrompt,temperature:r.temperature??y.temperature,maxTokens:r.maxTokens??y.maxTokens,documentFiles:k.length>0?k:void 0,imageUrls:h.length>0?h:void 0,videoUrls:S.length>0?S:void 0}),H=ue&&(((u=ue.data)==null?void 0:u.text)||(ue==null?void 0:ue.text))||"";if(!H||H.trim()===""){m.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}a({generatedText:H});const he=xe().filter(Ae=>Ae.source===l),Ee=ge(),Ne=he.filter(Ae=>{const _e=Ee.find(Ue=>Ue.id===Ae.target);return _e&&_e.type!=="textPreview"});if(Ne.length>0)je(Ae=>{const _e=new Set(Ne.map(Ue=>Ue.target));return Ae.map(Ue=>{var Ve;if(!_e.has(Ue.id))return Ue;const ie=((Ve=Ue.data)==null?void 0:Ve.config)||{};return Ue.type==="midjourney"?{...Ue,data:{...Ue.data,prompt:H}}:{...Ue,data:{...Ue.data,config:{...ie,prompt:H}}}})});else{const Ae=be(l);if(Ae){const _e=Date.now(),Ue=`text-preview-${l}-${_e}`,ie=he.filter(gt=>{const vt=Ee.find(it=>it.id===gt.target);return vt&&vt.type==="textPreview"}),Ve=document.querySelector(`.react-flow__node[data-id="${l}"]`),Qe=(Ve==null?void 0:Ve.getBoundingClientRect().width)||300,Ft=Ae.position.x+Qe+100,Mt=Ae.position.y+ie.length*700,At={id:Ue,type:"textPreview",position:{x:Ft,y:Mt},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:H,createdBy:(i=Ae.data)==null?void 0:i.createdBy}},ct={id:`edge-${l}-${Ue}`,source:l,target:Ue,type:"aurora"};je(gt=>[...gt,At]),setTimeout(()=>{le(gt=>[...gt,ct])},50)}}const $e=(ue==null?void 0:ue.creditsCharged)||0;if($e>0){const{useAuthStore:Ae}=await ds(async()=>{const{useAuthStore:Ue}=await import("./index-B7LKGTE9.js").then(ie=>ie.f);return{useAuthStore:Ue}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_e}=Ae.getState();await _e(),m.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${$e} ç§¯åˆ†ï¼‰`)}else m.success("æ‰§è¡ŒæˆåŠŸ")}catch(G){const ne=((F=(n=G==null?void 0:G.response)==null?void 0:n.data)==null?void 0:F.message)||((B=(M=G==null?void 0:G.response)==null?void 0:M.data)==null?void 0:B.error)||(G==null?void 0:G.message)||"æœªçŸ¥é”™è¯¯";m.error("æ‰§è¡Œå¤±è´¥ï¼š"+ne)}finally{re(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:T?"LOADING...":((W==null?void 0:W.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[W&&(W.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(os,{value:Q,onChange:r=>ce(r),options:[...W.roles||[]].sort((r,f)=>(r.order??0)-(f.order??0)).map(r=>({value:r.id,label:r.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Re,value:Y,onChange:r=>{de.current=!0,se(r.target.value)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:c,disabled:Z||T||!W||!Y.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:cursor-not-allowed bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg  border-transparent dark:border-white/10",children:Z?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!z&&(P?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(E),"æ¬¡"]}):_!==null&&_>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[_,"ç§¯åˆ†"]}):null)]})}),ee.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",ee.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:ee.map((r,f)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:r,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"})},f))})]}),R.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",R.length,")"]}),e.jsx("div",{className:"space-y-1",children:R.map((r,f)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:r.name,children:r.name})]},f))})]})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},xo=t.memo(mo),Ir="https://api.waule.ai",_s=400,bo=({data:s,id:j,selected:l})=>{const[W,fe]=t.useState(!1),[T,pe]=t.useState(0),[Y,se]=t.useState(s.config.uploadedFiles||[]),[Q,ce]=t.useState(null),[Re,de]=t.useState(null);t.useEffect(()=>()=>{},[j]),t.useEffect(()=>{},[Q]),t.useEffect(()=>{},[Re]);const[Z,re]=t.useState(null),je=t.useRef(null),le=t.useRef(null),be=t.useRef(null),[ge,xe]=t.useState(!1),[Ie,ae]=t.useState(0),[ee,U]=t.useState(0),[R,D]=t.useState(!1),p=t.useRef(null),{setNodes:b,getNode:_,setEdges:z,getEdges:P}=Qt(),E=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const n=s.createdBy;if(typeof n=="object"&&(n==null||n.id),E.current)return;const F=s.config.uploadedFiles||[];!W&&JSON.stringify(F)!==JSON.stringify(Y)&&(se(F),ce(null),de(null))},[s.config.uploadedFiles,W,s._currentUserId,s.createdBy]);const V=()=>{p.current&&(p.current.paused?(p.current.play(),D(!0)):(p.current.pause(),D(!1)))},a=n=>{_(j)&&(E.current=!0,b(M=>M.map(B=>B.id===j?{...B,data:{...B.data,config:{...B.data.config,uploadedFiles:n}}}:B)))},v=async n=>{var M,B;if(!n||n.length===0)return;fe(!0);const F=[];try{for(let G=0;G<n.length;G++){const ne=n[G];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ne.type)){m.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ne.name}`);continue}const oe=await Ce.assets.upload(ne,void 0,{onUploadProgress:k=>{const h=(k==null?void 0:k.total)||0,S=(k==null?void 0:k.loaded)||0;if(h>0){const y=Math.round(S/h*100);pe(y)}}});if(oe.data){const k=(oe.data.type||"").toUpperCase(),h=(oe.data.mimeType||"").toLowerCase(),S=k==="IMAGE"||k==="VIDEO"||k==="AUDIO"?k:h.startsWith("image/")?"IMAGE":h.startsWith("video/")?"VIDEO":h.startsWith("audio/")?"AUDIO":k||"",y=oe.data.url;F.push({id:oe.data.id,name:oe.data.name,originalName:oe.data.originalName,type:S,mimeType:oe.data.mimeType,size:oe.data.size,url:y})}}if(F.length>0){let G=[];const ne=F[0].type;if(Z!==null)G=[...Y],G[Z]=F[0];else{const oe={};for(const k of Y)oe[k.id]=k;for(const k of F)oe[k.id]=k;G=Object.values(oe)}if(_(j)){const oe=P().filter(h=>h.source===j),k=[];if(oe.forEach(h=>{var J;const S=_(h.target);if(!S||S.type.startsWith("aiVideo"))return;const y=(J=S.data.config)==null?void 0:J.acceptedInputs;if(y&&y.length>0){const ue=ne.toUpperCase();y.map(he=>typeof he=="string"?he.toUpperCase():he).includes(ue)||k.push(h.id)}}),k.length>0){z(S=>S.filter(y=>!k.includes(y.id)));const h={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.warning(`å·²æ–­å¼€ ${k.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${h[ne]||ne}ç±»å‹ï¼‰`)}}ce(null),de(null),se(G),a(G);try{const oe=P().filter(h=>h.source===j);if(oe.some(h=>{const S=_(h.target);return(S==null?void 0:S.type)==="aiVideo"})){const h=localStorage.getItem("workflow:nodes"),S=h?JSON.parse(h):[],y=oe.filter(ue=>{var H;return((H=_(ue.target))==null?void 0:H.type)==="aiVideo"}).map(ue=>ue.target),J=S.filter(ue=>y.includes(ue.id));J.length>0&&b(ue=>ue.map(H=>J.find(he=>he.id===H.id)?{...H,data:{...H.data,config:{...H.data.config,_updatedAt:Date.now()}}}:H))}}catch{}m.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(G){m.error(`ä¸Šä¼ å¤±è´¥: ${((B=(M=G.response)==null?void 0:M.data)==null?void 0:B.message)||G.message}`)}finally{fe(!1),pe(0),je.current&&(je.current.value=""),re(null)}},c=()=>{b(n=>n.filter(F=>F.id!==j)),z(n=>n.filter(F=>F.source!==j&&F.target!==j)),m.success("èŠ‚ç‚¹å·²åˆ é™¤")},r=()=>{var n;re(0),(n=je.current)==null||n.click()},f=n=>n<1024?n+" B":n<1024*1024?(n/1024).toFixed(2)+" KB":(n/(1024*1024)).toFixed(2)+" MB",d=n=>n.startsWith("image/")?{icon:"image",color:"text-neutral-500 dark:text-neutral-400"}:n.startsWith("video/")?{icon:"movie",color:"text-neutral-500 dark:text-neutral-400"}:n.startsWith("audio/")?{icon:"audio_file",color:"text-neutral-500 dark:text-neutral-400"}:{icon:"description",color:"text-neutral-500 dark:text-neutral-400"};t.useEffect(()=>{if(Y.length>0){const n=Y[0],F=(n.url.startsWith("http")||n.url.startsWith("data:")?n.url:`${Ir}${n.url}`).replace(".oss-oss-",".oss-");if(n.type==="IMAGE"){const M=new Image;M.onload=()=>{const B=M.width/M.height,G=_s/B;ce({width:_s,height:G})},M.onerror=B=>{ce({width:_s,height:_s*.75})},M.src=F}else if(n.type==="VIDEO"){const M=document.createElement("video");M.onloadedmetadata=()=>{const B=M.videoWidth/M.videoHeight,G=_s/B;de({width:_s,height:G})},M.onerror=B=>{de({width:_s,height:_s*.5625})},M.src=F}}},[Y]);const x=()=>{const n=le.current;n&&(ge?(n.pause(),xe(!1)):(n.play(),xe(!0)))};t.useEffect(()=>{const n=le.current;if(!n)return;const F=()=>ae(n.duration||0),M=()=>U(n.duration?n.currentTime/n.duration:0),B=()=>xe(!1);return n.addEventListener("loadedmetadata",F),n.addEventListener("timeupdate",M),n.addEventListener("ended",B),()=>{n.removeEventListener("loadedmetadata",F),n.removeEventListener("timeupdate",M),n.removeEventListener("ended",B)}},[Y]);const g=t.useRef(null),[w,A]=t.useState(0);t.useEffect(()=>{const n=Y[0];if(!n||n.type!=="AUDIO"){g.current=null;return}const M=(n.url.startsWith("http")||n.url.startsWith("data:")?n.url:`${Ir}${n.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let G;/https:\/\/.*aliyuncs\.com\//.test(M)?G=await Ce.assets.proxyDownload(M):G=await(await fetch(M,{mode:"cors"})).arrayBuffer();const ne=window.AudioContext||window.webkitAudioContext,k=(await new ne().decodeAudioData(G)).getChannelData(0),h=120,S=Math.max(1,Math.floor(k.length/h)),y=new Float32Array(h);for(let J=0;J<h;J++){let ue=0,H=0;const he=J*S,Ee=Math.min(k.length,he+S);for(let Ne=he;Ne<Ee;Ne++)ue+=Math.abs(k[Ne]),H++;y[J]=H?ue/H:0}g.current=y,A(J=>J+1)}catch{const ne=new Float32Array(120);for(let me=0;me<120;me++)ne[me]=(Math.sin(me/5)+1)/2;g.current=ne,A(me=>me+1)}})()},[Y]),t.useEffect(()=>{const n=be.current;if(!n)return;const F=g.current;if(!F)return;const M=n.getContext("2d");if(!M)return;const B=n.width,G=n.height;M.clearRect(0,0,B,G);const ne=F.length,me=2,oe=Math.max(1,Math.floor((B-(ne-1)*me)/ne)),k=M.createLinearGradient(0,0,B,0);k.addColorStop(0,"#525252"),k.addColorStop(.5,"#d946ef"),k.addColorStop(1,"#404040");for(let h=0;h<ne;h++){const S=Math.min(1,Math.max(0,F[h])),y=Math.max(2,Math.floor(S*G)),J=h*(oe+me),ue=Math.floor((G-y)/2);M.fillStyle=k,M.fillRect(J,ue,oe,y)}if(ee>0){const h=Math.floor(B*ee);M.fillStyle="#ffffff88",M.fillRect(h,0,2,G)}},[ee,w]);const $=n=>{if(!n||!isFinite(n))return"0:00";const F=Math.floor(n/60),M=Math.floor(n%60);return`${F}:${M.toString().padStart(2,"0")}`},N=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"neutral"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"neutral"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"neutral"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"neutral"}],u=Y[0],i=u?(u.url.startsWith("http")||u.url.startsWith("data:")?u.url:`${Ir}${u.url}`).replace(".oss-oss-",".oss-"):"";return u&&u.type==="IMAGE"&&Q?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:i,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:Q.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>v(n.target.files),className:"hidden"})]}):u&&u.type==="VIDEO"&&Re?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${R?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:n=>{n.stopPropagation(),V()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:R?"pause":"play_arrow"})})}),e.jsx("video",{ref:p,src:i,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Re.height},onEnded:()=>D(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>v(n.target.files),className:"hidden"})]}):u&&u.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:x,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:ge?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:$(Ie)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:be,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:le,src:i,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>v(n.target.files),className:"hidden"})]}):u&&u.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:u.originalName,children:u.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:f(u.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>v(n.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:je,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>v(n.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var n;s._canEdit!==!1&&((n=je.current)==null||n.click())},onDragOver:n=>{n.preventDefault(),n.stopPropagation()},onDrop:n=>{n.preventDefault(),n.stopPropagation(),s._canEdit!==!1&&v(n.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-neutral-400 dark:hover:border-neutral-400/50 transition-colors ${W||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:W?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:W?`ä¸Šä¼ ä¸­... ${T}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),W&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all",style:{width:`${T}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:N.map(n=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${n.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:n.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:n.formats.join(", ")})]},n.type))})]}),Y.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",Y.length,")"]}),Y.map(n=>{const{icon:F,color:M}=d(n.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${M} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:F}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:n.originalName,children:n.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:f(n.size)})]}),e.jsx("button",{onClick:c,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},n.id)})]})]})}),e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},wo=t.memo(bo),Vr="https://api.waule.ai",Ms=320,yo=({data:s,id:j,selected:l})=>{const[W,fe]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[T,pe]=t.useState([]),{setNodes:Y,getNode:se}=Qt(),[Q,ce]=t.useState(null),[Re,de]=t.useState(null),Z=t.useRef(null),re=t.useRef(null),[je,le]=t.useState(!1),[be,ge]=t.useState(0),[xe,Ie]=t.useState(0),ae=t.useRef(null),[ee,U]=t.useState(!1),[R,D]=t.useState(!1),p=t.useRef(null),b=()=>{p.current&&(p.current.paused?(p.current.play(),D(!0)):(p.current.pause(),D(!1)))},_=t.useRef(!1);t.useEffect(()=>{const c=s._currentUserId,r=s.createdBy,f=typeof r=="object"?r==null?void 0:r.id:r;if(c&&f&&c===f&&_.current)return;const d=s.config.selectedInput||s.config.selectedAsset||null;if(!d)return;const x=W;(()=>{if(!x)return!1;const w=x.images&&!x.type,A=d.images&&!d.type;if(w&&A){const $=x.images||[],N=d.images||[];if($.length!==N.length)return!1;for(let u=0;u<$.length;u++)if($[u].id!==N[u].id||$[u].url!==N[u].url)return!1;return!0}if(x.id&&d.id)return x.id===d.id&&x.url===d.url&&x.type===d.type;try{return JSON.stringify(x)===JSON.stringify(d)}catch{return!1}})()||fe(d)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var r,f,d;if(W&&W.images&&!W.type){const x=W,g=(d=(f=(r=se(j))==null?void 0:r.data)==null?void 0:f.config)==null?void 0:d.referenceImages;Array.isArray(g)&&g.length>0?pe(g.map(w=>({id:w.id,url:w.url,name:w.name}))):pe(x.images||[])}else pe([])},[W,se,j]);const z=c=>{const r=se(j);r&&(_.current=!0,Y(f=>f.map(d=>d.id===j?{...d,data:{...d.data,config:{...d.data.config,...c}}}:d)),fe((c==null?void 0:c.selectedInput)??(c==null?void 0:c.selectedAsset)??r.data.config.selectedInput??r.data.config.selectedAsset))},P=c=>/^https?:\/\//.test(c)||c.startsWith("data:"),E=c=>!c||c.startsWith("data:")?c:/^https?:\/\/localhost(?::\d+)?\//i.test(c)?c.replace(/^https?:\/\/localhost(?::\d+)?/i,Vr):P(c)?c:`${Vr}${c}`;t.useEffect(()=>{var N,u,i,n,F,M,B,G,ne;if(!(W&&W.images&&!W.type))return;const r=W,f=T.length?T:r.images||[];if(f.length===1){const me=f[0],oe={id:me.id,name:me.name,originalName:me.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:me.url};z({selectedInput:oe,selectedAsset:oe,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const d=[{name:r.name,images:f.map(me=>E(me.url))}],x=f.map(me=>({id:me.id,url:me.url,name:me.name})),g=[r.id],w=(i=(u=(N=se(j))==null?void 0:N.data)==null?void 0:u.config)==null?void 0:i.subjects,A=(M=(F=(n=se(j))==null?void 0:n.data)==null?void 0:F.config)==null?void 0:M.referenceImages,$=(ne=(G=(B=se(j))==null?void 0:B.data)==null?void 0:G.config)==null?void 0:ne.roleIds;(JSON.stringify(w)!==JSON.stringify(d)||JSON.stringify(A)!==JSON.stringify(x)||JSON.stringify($)!==JSON.stringify(g))&&z({subjects:d,referenceImages:x,roleIds:g})},[T]);const V=c=>{if(!(W&&W.images&&!W.type))return;const f=W,d=[...T];if(c<0||c>=d.length)return;if(d.splice(c,1),pe(d),m.success("å·²åˆ é™¤å‚è€ƒå›¾"),d.length===0){fe(null),z({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),m.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(d.length===1){const $=d[0],N={id:$.id,name:$.name,originalName:$.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:$.url};fe(N),z({selectedInput:N,selectedAsset:N,subjects:void 0,referenceImages:void 0,roleIds:void 0}),m.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const x={id:f.id,name:f.name,coverUrl:E(d[0].url),images:d};fe(x);const g=[{name:x.name,images:d.map($=>E($.url))}],w=d.map($=>({id:$.id,url:$.url,name:$.name})),A=[x.id];z({selectedInput:x,subjects:g,referenceImages:w,roleIds:A}),m.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},a=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(j)};t.useEffect(()=>{if(W&&W.type){const c=W;if(c.type==="IMAGE"){const r=new Image;r.onload=()=>{const f=r.width/r.height,d=Ms/f;ce({width:Ms,height:d})},r.src=E(c.url)}else if(c.type==="VIDEO"){const r=document.createElement("video");r.onloadedmetadata=()=>{const f=r.videoWidth/r.videoHeight,d=Ms/f;de({width:Ms,height:d})},r.src=E(c.url)}}},[W]),t.useEffect(()=>{if(!(W&&W.type==="AUDIO")){U(!1);return}const f=E(W.url),d=Z.current,x=re.current;if(!d||!x)return;d.src=f,Ie(0),U(!1);const g=()=>ge(d.duration||0),w=()=>Ie(d.duration?d.currentTime/d.duration:0),A=()=>le(!1);return d.addEventListener("loadedmetadata",g),d.addEventListener("timeupdate",w),d.addEventListener("ended",A),(async()=>{try{const u=await(await fetch(f,{mode:"cors"})).arrayBuffer(),i=window.AudioContext||window.webkitAudioContext,M=(await new i().decodeAudioData(u)).getChannelData(0),B=120,G=Math.max(1,Math.floor(M.length/B)),ne=new Float32Array(B);for(let me=0;me<B;me++){let oe=0,k=0;const h=me*G,S=Math.min(M.length,h+G);for(let y=h;y<S;y++)oe+=Math.abs(M[y]),k++;ne[me]=k?oe/k:0}ae.current=ne,U(!0)}catch{const u=new Float32Array(120);for(let i=0;i<120;i++)u[i]=(Math.sin(i/5)+1)/2;ae.current=u,U(!0)}})(),()=>{d.removeEventListener("loadedmetadata",g),d.removeEventListener("timeupdate",w),d.removeEventListener("ended",A)}},[W]),t.useEffect(()=>{if(!(W&&W.type==="AUDIO")||!ee)return;const r=re.current,f=ae.current;if(!r||!f)return;const d=r.getContext("2d");if(!d)return;const x=r.width,g=r.height;d.clearRect(0,0,x,g);const w=f.length,A=2,$=Math.max(1,Math.floor((x-(w-1)*A)/w)),N=d.createLinearGradient(0,0,x,0);N.addColorStop(0,"#525252"),N.addColorStop(.5,"#d946ef"),N.addColorStop(1,"#404040");for(let u=0;u<w;u++){const i=Math.min(1,Math.max(0,f[u])),n=Math.max(2,Math.floor(i*g)),F=u*($+A),M=Math.floor((g-n)/2);d.fillStyle=N,d.fillRect(F,M,$,n)}if(xe>0){const u=Math.floor(x*xe);d.fillStyle="#ffffff88",d.fillRect(u,0,2,g)}},[W,xe,ee]);const v=c=>c<1024?c+" B":c<1024*1024?(c/1024).toFixed(2)+" KB":(c/(1024*1024)).toFixed(2)+" MB";if(W){if(W.images&&!W.type){const d=W;return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ms*.5625},children:T[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:x=>x.preventDefault(),src:E(T[0].url),alt:d.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:x=>{x.preventDefault(),x.stopPropagation(),x.nativeEvent&&typeof x.nativeEvent.stopImmediatePropagation=="function"&&x.nativeEvent.stopImmediatePropagation(),V(0)},onClick:x=>{x.preventDefault(),x.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:d.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:T.slice(1).map((x,g)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:w=>w.preventDefault(),src:E(x.url),alt:x.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:w=>{w.preventDefault(),w.stopPropagation(),w.nativeEvent&&typeof w.nativeEvent.stopImmediatePropagation=="function"&&w.nativeEvent.stopImmediatePropagation(),V(g+1)},onClick:w=>{w.preventDefault(),w.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},x.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const r=W,f=E(r.url);if(r.type==="IMAGE"&&Q)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:f,alt:r.name,className:"w-full object-cover",style:{width:Ms,height:Q.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(r.type==="VIDEO"&&Re)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${R?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:d=>{d.stopPropagation(),b()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:R?"pause":"play_arrow"})})}),e.jsx("video",{ref:p,src:f,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ms,height:Re.height},onEnded:()=>D(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(r.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:r.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const d=Z.current;d&&(je?(d.pause(),le(!1)):(d.play(),le(!0)))},className:"nodrag w-8 h-8 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:je?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const d=be;if(!d||!isFinite(d))return"0:00";const x=Math.floor(d/60),g=Math.floor(d%60);return`${x}:${g.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:re,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:Z,src:f,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(r.type==="DOCUMENT"){const d=w=>w.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:w.includes("word")?{icon:"description",color:"text-blue-400"}:w.includes("excel")||w.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:x,color:g}=d(r.mimeType);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${g} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:x}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:r.originalName,children:r.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:v(r.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:a,className:"nodrag w-full px-4 py-2.5 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},ko=t.memo(yo),fr={};function Ts(s){const{project:j,episode:l,nodeGroup:W,assetType:fe,preview:T=!0}=s;if(!W||!W.scene||!W.shot)return null;const pe=`${W.id}-${fe}`;fr[pe]||(fr[pe]=0);let Y;T?Y=fr[pe]+1:(fr[pe]++,Y=fr[pe]);let se=j.name;if(j.type==="DRAMA"&&l){const Q=`S${String(l.episodeNumber).padStart(3,"0")}`;se+=`_${Q}`}return se+=`_Sc${W.scene}_Sh${W.shot}`,se+=`_${Y}`,se}function Ws(s,j){return j.find(l=>l.nodeIds.includes(s))||null}const vo=({data:s,id:j})=>{var d,x;const{setNodes:l,setEdges:W,getNodes:fe}=Qt(),T=Ar(g=>g.refreshUser),pe=Cr(),Y=!!((d=s==null?void 0:s.workflowContext)!=null&&d.episode)||pe.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var w,A,$;if(Y)try{const N=(s==null?void 0:s.workflowContext)||{},u=N.episode,i=new URLSearchParams(window.location.search),n=Number(i.get("shot"))||1,F=pe.pathname.split("/").filter(Boolean),M=F.indexOf("projects"),B=F.indexOf("episodes"),G=((w=N.project)==null?void 0:w.id)||(u==null?void 0:u.projectId)||(M>=0?F[M+1]:void 0),ne=(u==null?void 0:u.id)||(B>=0?F[B+1]:void 0);if(!G||!ne)return;const me=await Ce.episodes.getById(G,ne),oe=(me==null?void 0:me.data)??me,k=(oe==null?void 0:oe.data)??oe,S=(Array.isArray((A=k==null?void 0:k.scriptJson)==null?void 0:A.acts)?k.scriptJson.acts:[]).find(H=>H.actIndex===1),y=($=S==null?void 0:S.shots)==null?void 0:$.find(H=>Number(H.shotIndex)===n),ue=(Array.isArray(y==null?void 0:y.mediaList)?y.mediaList:[]).some(H=>(H==null?void 0:H.nodeId)===j);l(H=>H.map(he=>he.id===j?{...he,data:{...he.data,addedToStoryboard:ue}}:he))}catch{}})()},[j,Y,pe.pathname]);const[se,Q]=t.useState(!1),[ce,Re]=t.useState([]),[de,Z]=t.useState(""),[re,je]=t.useState("ALL"),[le,be]=t.useState(""),[ge,xe]=t.useState(!1),Ie=s.width||400,[ae,ee]=t.useState(null);t.useEffect(()=>{se&&(v(),setTimeout(()=>{c()},100))},[se]);const U=t.useRef(null),R=t.useRef(!1);t.useEffect(()=>{const g=s.pendingButtonAction;if(g){try{const $=localStorage.getItem("suppressedPreviewTasks")||"[]",N=JSON.parse($),u=localStorage.getItem("createdPreviewTasks")||"[]",i=JSON.parse(u),n=N.some(G=>G.taskId&&G.taskId===g.newTaskId||G.sourceNodeId&&G.sourceNodeId===g.sourceNodeId),M=fe().some(G=>{var ne,me,oe,k;return G.type==="imagePreview"&&((me=(ne=G.data)==null?void 0:ne.midjourneyData)==null?void 0:me.sourceNodeId)===g.sourceNodeId&&((k=(oe=G.data)==null?void 0:oe.midjourneyData)==null?void 0:k.taskId)===g.newTaskId}),B=i.some(G=>G.taskId&&G.taskId===g.newTaskId);if(n||B&&M){ee(null),l(G=>G.map(ne=>ne.id===g.sourceNodeId?{...ne,data:{...ne.data,pendingButtonAction:void 0}}:ne));return}}catch{}if(R.current)return;if(R.current=!0,fe().some($=>{var N,u,i,n;return $.type==="imagePreview"&&((u=(N=$.data)==null?void 0:N.midjourneyData)==null?void 0:u.sourceNodeId)===g.sourceNodeId&&((n=(i=$.data)==null?void 0:i.midjourneyData)==null?void 0:n.taskId)===g.newTaskId})){ee(null),l($=>$.map(N=>N.id===g.sourceNodeId?{...N,data:{...N.data,pendingButtonAction:void 0}}:N)),R.current=!1;return}ee(g.buttonCustomId),D(g.newTaskId,g.buttonLabel,g.sourceNodeId)}return()=>{R.current=!1,U.current&&(clearTimeout(U.current),U.current=null)}},[]);const D=async(g,w,A)=>{const $=A||j;let N=0;const u=150,i=2e3;R.current=!0;const n=/^[UV]\d$/.test(w)||w.includes("Vary")||w.includes("Upscale")&&w!=="Upscale"||w.includes("Zoom")||w.includes("Pan")||w.includes("Make")||w.includes("Remaster"),F=async()=>{var M,B,G,ne,me,oe,k,h;if(R.current)try{const S=await Ce.midjourney.fetchTask(g);if(!R.current)return;const y=S.task;if(y.status==="SUCCESS"){if(n&&s.imageUrl&&((M=s.midjourneyData)!=null&&M.messageId)){const gt=y.imageUrl===s.imageUrl,vt=((B=y.properties)==null?void 0:B.messageId)===((G=s.midjourneyData)==null?void 0:G.messageId);if(gt&&vt){N++;try{const it=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(it).some(Be=>{var wt;return Be.taskId&&Be.taskId===g||Be.messageId&&Be.messageId===((wt=y.properties)==null?void 0:wt.messageId)})){ee(null),l(Be=>Be.map(wt=>wt.id===$?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}N<u?U.current=setTimeout(F,i):(m.error(`${w} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),ee(null),l(it=>it.map(Ke=>Ke.id===$?{...Ke,data:{...Ke.data,pendingButtonAction:void 0}}:Ke)));return}}if(m.success(`${w} å®Œæˆï¼`),ee(null),l(gt=>gt.map(vt=>vt.id===$?{...vt,data:{...vt.data,pendingButtonAction:void 0}}:vt)),fe().find(gt=>{var vt,it,Ke,yt,Be;return gt.type==="imagePreview"&&((vt=gt.data.midjourneyData)==null?void 0:vt.sourceNodeId)===$&&(((it=gt.data.midjourneyData)==null?void 0:it.taskId)===g||((Ke=y.properties)==null?void 0:Ke.messageId)&&((yt=gt.data.midjourneyData)==null?void 0:yt.messageId)===((Be=y.properties)==null?void 0:Be.messageId))})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const H=fe().find(gt=>gt.id===$);if(!H)return;if(!y.imageUrl){m.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const he=200,Ee=100,Ne=s.width||400,Ae=((gt,vt=300)=>{if(!gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(gt))return vt;const[it,Ke]=gt.split(":").map(yt=>parseFloat(yt));return!it||!Ke?vt:Math.round(Ne*(Ke/it))})(s.ratio,300),_e=document.querySelector(`.react-flow__node[data-id="${H.id}"]`),Ue=Math.round((_e==null?void 0:_e.getBoundingClientRect().width)||((ne=H.data)==null?void 0:ne.width)||400),ie=fe().filter(gt=>{var vt,it;return gt.type==="imagePreview"&&((it=(vt=gt.data)==null?void 0:vt.midjourneyData)==null?void 0:it.sourceNodeId)===$}),Ve=H.position.x+Ue+he,Qe=H.position.y,Ft=Ve,Mt=Qe+ie.length*(Ae+Ee),At=`preview-${Date.now()}`,ct={id:At,type:"imagePreview",position:{x:Ft,y:Mt},data:{imageUrl:y.imageUrl,width:Ne,height:Ae,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(me=H.data)==null?void 0:me.createdBy,midjourneyData:{taskId:g,messageId:(oe=y.properties)==null?void 0:oe.messageId,messageHash:(k=y.properties)==null?void 0:k.messageHash,sourceNodeId:$,buttons:y.buttons,action:y.action}}};l(gt=>[...gt,ct]),W(gt=>{const vt={id:`${$}-${At}`,source:$,target:At,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...gt,vt]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const vt=fe().find(it=>it.id===At)})});try{const gt=localStorage.getItem("createdPreviewTasks")||"[]",it=[...JSON.parse(gt),{taskId:g,messageId:(h=y.properties)==null?void 0:h.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(it))}catch{}m.success(`å·²åˆ›å»º${w}é¢„è§ˆèŠ‚ç‚¹`);return}if(y.status==="FAILURE"){m.error(`${w} å¤±è´¥: ${y.failReason||"æœªçŸ¥é”™è¯¯"}`),ee(null),l(J=>J.map(ue=>ue.id===$?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue));return}if(y.status==="NOT_FOUND"){if(fe().some(H=>{var he,Ee,Ne,$e;return H.type==="imagePreview"&&((Ee=(he=H.data)==null?void 0:he.midjourneyData)==null?void 0:Ee.sourceNodeId)===$&&(($e=(Ne=H.data)==null?void 0:Ne.midjourneyData)==null?void 0:$e.taskId)===g})){ee(null),l(H=>H.map(he=>he.id===$?{...he,data:{...he.data,pendingButtonAction:void 0}}:he));return}m.error(`${w} ä»»åŠ¡ä¸å­˜åœ¨`),ee(null),l(H=>H.map(he=>he.id===$?{...he,data:{...he.data,pendingButtonAction:void 0}}:he));return}N++,N<u?U.current=setTimeout(F,i):(m.error(`${w} è¶…æ—¶`),ee(null),l(J=>J.map(ue=>ue.id===j?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue)))}catch(S){m.error(`${w} å¤±è´¥: ${S.message}`),ee(null),l(y=>y.map(J=>J.id===j?{...J,data:{...J.data,pendingButtonAction:void 0}}:J))}};F()},p=()=>{try{const g=localStorage.getItem("midjourneyButtonConfig");if(g)return JSON.parse(g)}catch{}return{}},b=g=>{const w=p();if(Object.keys(w).length===0)return!0;const A=g.label.replace(/\s+/g,"_");return w.hasOwnProperty(A)?w[A]===!0:!0},_=g=>{if(!g)return"";let w=g.trim();return/^upscale_\d+\s/i.test(w)&&(w=w.replace(/^upscale_\d+\s+/i,"")),w},z=(((x=s.midjourneyData)==null?void 0:x.buttons)||[]).map(g=>String(g.label||"").toLowerCase()),P=z.some(g=>/^[uv][1-4]$/i.test(g)),E=z.some(g=>g.includes("redo")),V=!P&&!E&&z.some(g=>g.includes("upscale")),a=g=>{const w=String(g.label||""),A=w.toLowerCase(),$=String(g.customId||"").toLowerCase(),N=/ğŸ‘|â¤ï¸|â¤/.test(w);return A.includes("animate")||A.includes("web")||$.includes("web")||A.includes("browser")||A.includes("open in web")||A.includes("open web")||A.includes("like")||$.includes("like")||N?!1:P?/^U[1-4]$/i.test(w):V?A.includes("upscale"):!1};t.useEffect(()=>{se&&(v(),c())},[se]);const v=async()=>{try{const g=re==="ALL"?void 0:{category:re},A=(await Ce.assetLibraries.getAll(g)).data||[];if(Re(A),A.length>0){const $=A.find(N=>N.id===de);Z($?$.id:A[0].id)}else Z("")}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},c=()=>{const g=window.__workflowContext;if(!g||!g.project||!g.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const w=Ws(j,g.nodeGroups);if(!w&&g.nodeGroups.length>0){const $=g.nodeGroups[0],N=Ts({project:g.project,episode:g.episode,nodeGroup:$,assetType:"image"});N?(be(N),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${N}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const A=Ts({project:g.project,episode:g.episode,nodeGroup:w,assetType:"image"});A?(be(A),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${A}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},r=async()=>{var g,w;if(!de){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!le.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{xe(!0),await Ce.assetLibraries.addFromUrl(de,s.imageUrl,le.trim());const A=window.__workflowContext;if(A&&A.project&&A.nodeGroups){const $=Ws(j,A.nodeGroups)||A.nodeGroups[0];$&&Ts({project:A.project,episode:A.episode,nodeGroup:$,nodeId:j,assetType:"image",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),Q(!1),be("");try{l($=>$.map(N=>N.id===j?{...N,data:{...N.data,addedToLibrary:!0}}:N))}catch{}try{const $=new CustomEvent("asset-library-updated",{detail:{libraryId:de}});window.dispatchEvent($)}catch{}}catch(A){m.error(((w=(g=A.response)==null?void 0:g.data)==null?void 0:w.message)||"æ·»åŠ å¤±è´¥")}finally{xe(!1)}},f=async()=>{var g;try{const w=s.imageUrl;let A=`image-${Date.now()}.jpg`;const $=window.__workflowContext;if($&&$.project&&$.nodeGroups){const N=Ws(j,$.nodeGroups)||$.nodeGroups[0];if(N){const u=Ts({project:$.project,episode:$.episode,nodeGroup:N,nodeId:j,assetType:"image",preview:!0});if(u&&(A=u,!A.includes("."))){const i=((g=w.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:g[0])||".jpg";A+=i}}}m.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");try{const N=await fetch(w);if(!N.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${N.status}`);const u=await N.blob(),i=window.URL.createObjectURL(u),n=document.createElement("a");n.href=i,n.download=A,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>{window.URL.revokeObjectURL(i)},100),m.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${A}`)}catch{const u=`/api/assets/proxy-download-with-name?url=${encodeURIComponent(w)}&filename=${encodeURIComponent(A)}`,i=document.createElement("a");i.href=u,i.download=A,document.body.appendChild(i),i.click(),document.body.removeChild(i),m.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${A}`)}}catch(w){m.error(`æ“ä½œå¤±è´¥: ${w instanceof Error?w.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const w=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(A=>b(A)&&a(A)):[]).length>0;return e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ie,borderRadius:w?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[Y&&e.jsxs("button",{onClick:async()=>{var A,$;try{const N=s.imageUrl,u=s.workflowContext||{},i=u.episode,n=new URLSearchParams(window.location.search),F=Number(n.get("shot"))||1,M=pe.pathname.split("/").filter(Boolean),B=M.indexOf("projects"),G=M.indexOf("episodes"),ne=((A=u.project)==null?void 0:A.id)||(i==null?void 0:i.projectId)||(B>=0?M[B+1]:void 0),me=(i==null?void 0:i.id)||(G>=0?M[G+1]:void 0);if(!ne||!me){m.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const oe=await Ce.episodes.getById(ne,me),k=(oe==null?void 0:oe.data)??oe,h=(k==null?void 0:k.data)??k;let S=Array.isArray(($=h==null?void 0:h.scriptJson)==null?void 0:$.acts)?[...h.scriptJson.acts]:[],y=S.find(he=>he.actIndex===1);y||(y={actIndex:1,shots:[]},S.push(y)),y.shots=Array.isArray(y.shots)?[...y.shots]:[];let J=y.shots.find(he=>Number(he.shotIndex)===F);J||(J={shotIndex:F,mediaList:[]},y.shots.push(J));const ue=Array.isArray(J.mediaList)?J.mediaList.slice():[];ue.push({type:"image",url:N,nodeId:j,duration:5}),J.mediaList=ue;const H={...h.scriptJson||{},acts:S};await Ce.episodes.update(ne,me,{scriptJson:H});try{l(he=>he.map(Ee=>Ee.id===j?{...Ee,data:{...Ee.data,addedToStoryboard:!0}}:Ee))}catch{}m.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(N){m.error((N==null?void 0:N.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{Q(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:f,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const g=(s.midjourneyData.buttons||[]).filter(w=>b(w)&&a(w));return g.length===0?null:e.jsxs("div",{className:"nodrag bg-white dark:bg-[#18181b] backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ie},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((w,A)=>{var F;const $=_(w.label),N=((F=s.clickedButtons)==null?void 0:F.includes(w.label))||!1,u=ae===w.customId,i=s._canEdit===!1,n=ae!==null&&ae!==w.customId||N||i;return e.jsx("button",{onClick:async()=>{var M,B,G,ne,me,oe;if(!((M=s.midjourneyData)!=null&&M.taskId)){m.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(N){m.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}ee(w.customId);try{m.info(`æ­£åœ¨æ‰§è¡Œ ${w.label}...`);const k=await Ce.midjourney.action({taskId:s.midjourneyData.taskId,customId:w.customId,messageId:s.midjourneyData.messageId,nodeId:j,mode:s.midjourneyData.mode||"relax"});if(!k.success){m.error(k.description||"æ“ä½œå¤±è´¥"),ee(null);return}const h=k.taskId;if(k.creditsCharged&&k.creditsCharged>0&&T(),!h){m.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),ee(null);return}l(S=>S.map(y=>y.id===j?{...y,data:{...y.data,pendingButtonAction:{buttonLabel:w.label,buttonCustomId:w.customId,newTaskId:h,sourceNodeId:j},clickedButtons:[...y.data.clickedButtons||[],w.label]}}:y)),m.info(`${$} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),D(h,$)}catch(k){if(((B=k.response)==null?void 0:B.status)===429)m.warning(((ne=(G=k.response)==null?void 0:G.data)==null?void 0:ne.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const h=((oe=(me=k.response)==null?void 0:me.data)==null?void 0:oe.error)||k.message;m.error(h)}ee(null)}},disabled:n,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${N?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":u?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-wait text-white border-transparent shadow-md":ae!==null?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:N?`${$} (å·²ç‚¹å‡»)`:$,children:e.jsxs("span",{className:"flex items-center gap-1",children:[u&&e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),w.emoji&&!/^upscale_\d+$/i.test(w.emoji)&&e.jsx("span",{children:w.emoji}),$,N&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},A)})})]})})(),se&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>Q(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:le,onChange:g=>be(g.target.value),onMouseDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const g=re==="ALL"?ce:ce.filter(w=>(w.category||"OTHER")===re);return g.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:re==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:de,onChange:w=>Z(w.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:g.map(w=>e.jsxs("option",{value:w.id,children:[w.name," (",w._count.assets," ä¸ªèµ„äº§)"]},w.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(g=>e.jsx("button",{type:"button",onClick:()=>{je(g);const w=ce.filter(A=>(A.category||"OTHER")===g);Z(w.length>0?w[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${re===g?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:g==="ROLE"?"person":g==="SCENE"?"landscape":g==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:g==="ROLE"?"è§’è‰²åº“":g==="SCENE"?"åœºæ™¯åº“":g==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},g))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Q(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:r,disabled:ge||ce.length===0||!le.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:ge?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},No=t.memo(vo),jo=({data:s,id:j})=>{var z;const l="https://api.waule.ai",[W,fe]=t.useState(!1),[T,pe]=t.useState([]),[Y,se]=t.useState(""),[Q,ce]=t.useState("ALL"),[Re,de]=t.useState(""),[Z,re]=t.useState(!1),{setNodes:je}=Qt(),[le]=t.useState(s.width||400),[be,ge]=t.useState(null),[xe,Ie]=t.useState(!1),ae=t.useRef(null),ee=Cr(),U=!!((z=s==null?void 0:s.workflowContext)!=null&&z.episode)||ee.pathname.includes("/episodes/");t.useEffect(()=>{W&&(D(),setTimeout(()=>{p()},100))},[W]),t.useEffect(()=>{const P=ae.current;if(!P)return;const E=()=>{const c=P.videoWidth||0,r=P.videoHeight||0;if(c>0&&r>0){const f=c/r;ge(Math.round(le/f))}},V=()=>Ie(!0),a=()=>Ie(!1),v=()=>Ie(!1);return P.addEventListener("loadedmetadata",E),P.addEventListener("play",V),P.addEventListener("pause",a),P.addEventListener("ended",v),()=>{P.removeEventListener("loadedmetadata",E),P.removeEventListener("play",V),P.removeEventListener("pause",a),P.removeEventListener("ended",v)}},[le,s.videoUrl]);const R=P=>{P.stopPropagation();const E=ae.current;E&&(E.paused?E.play():E.pause())};t.useEffect(()=>{try{const P=localStorage.getItem("suppressedPreviewTasks")||"[]",E=JSON.parse(P),V=s==null?void 0:s.pendingButtonAction;if(V&&E.some(v=>v.taskId&&v.taskId===V.newTaskId||v.sourceNodeId&&v.sourceNodeId===V.sourceNodeId)){fe(!1);return}}catch{}},[]);const D=async()=>{try{const P=await Ce.assetLibraries.getAll();pe(P.data),P.data.length>0&&se(P.data[0].id)}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},p=()=>{const P=window.__workflowContext;if(!P||!P.project||!P.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const E=Ws(j,P.nodeGroups);if(!E&&P.nodeGroups.length>0){const a=P.nodeGroups[0],v=Ts({project:P.project,episode:P.episode,nodeGroup:a,assetType:"video"});v?(de(v),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${v}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const V=Ts({project:P.project,episode:P.episode,nodeGroup:E,assetType:"video"});V?(de(V),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${V}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},b=async()=>{var P,E;if(!Y){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Re.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{re(!0),await Ce.assetLibraries.addFromUrl(Y,s.videoUrl,Re.trim());const V=window.__workflowContext;if(V&&V.project&&V.nodeGroups){const a=Ws(j,V.nodeGroups)||V.nodeGroups[0];a&&Ts({project:V.project,episode:V.episode,nodeGroup:a,nodeId:j,assetType:"video",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),fe(!1),de("");try{je(a=>a.map(v=>v.id===j?{...v,data:{...v.data,addedToLibrary:!0}}:v))}catch{}try{const a=new CustomEvent("asset-library-updated",{detail:{libraryId:Y}});window.dispatchEvent(a)}catch{}}catch(V){m.error(((E=(P=V.response)==null?void 0:P.data)==null?void 0:E.message)||"æ·»åŠ å¤±è´¥")}finally{re(!1)}},_=async()=>{var P;try{const E=s.videoUrl;let V=`video-${Date.now()}.mp4`;const a=window.__workflowContext;if(a&&a.project&&a.nodeGroups){const v=Ws(j,a.nodeGroups)||a.nodeGroups[0];if(v){const c=Ts({project:a.project,episode:a.episode,nodeGroup:v,nodeId:j,assetType:"video",preview:!0});if(c&&(V=c,!V.includes("."))){const r=((P=E.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:P[0])||".mp4";V+=r}}}m.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");try{const v=await fetch(E);if(!v.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${v.status}`);const c=await v.blob(),r=window.URL.createObjectURL(c),f=document.createElement("a");f.href=r,f.download=V,document.body.appendChild(f),f.click(),document.body.removeChild(f),setTimeout(()=>{window.URL.revokeObjectURL(r)},100),m.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${V}`)}catch{const c=`/api/assets/proxy-download-with-name?url=${encodeURIComponent(E)}&filename=${encodeURIComponent(V)}`,r=document.createElement("a");r.href=c,r.download=V,document.body.appendChild(r),r.click(),document.body.removeChild(r),m.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${V}`)}}catch(E){m.error(`æ“ä½œå¤±è´¥: ${E instanceof Error?E.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:le},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",onContextMenu:P=>{P.preventDefault(),P.stopPropagation()},onMouseDown:P=>{if(P.button===2){const E=P.currentTarget;E.style.pointerEvents="none",setTimeout(()=>{E.style.pointerEvents=""},100)}},children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${xe?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:R,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:xe?"pause":"play_arrow"})})}),e.jsx("video",{ref:ae,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${l}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:be?`${be}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[U&&e.jsxs("button",{onClick:async()=>{var P,E;try{const V=s.videoUrl,a=s.workflowContext||{},v=a.episode,c=(()=>{try{const B=new URLSearchParams(window.location.search);return{scene:Number(B.get("scene")),shot:Number(B.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),r=a.nodeGroup||Ws(j,a.nodeGroups||[]),f=(r==null?void 0:r.scene)??c.scene,d=(r==null?void 0:r.shot)??c.shot,x=(()=>{try{const B=ee.pathname.split("/").filter(Boolean),G=B.indexOf("projects"),ne=B.indexOf("episodes"),me=G>=0?B[G+1]:void 0,oe=ne>=0?B[ne+1]:void 0;return{pid:me,eid:oe}}catch{return{pid:void 0,eid:void 0}}})(),g=((P=a.project)==null?void 0:P.id)||(v==null?void 0:v.projectId)||x.pid,w=(v==null?void 0:v.id)||x.eid;if(!g||!w||!f||!d){m.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const A=await Ce.episodes.getById(g,w),$=(A==null?void 0:A.data)??A,N=($==null?void 0:$.data)??$,u=Array.isArray((E=N==null?void 0:N.scriptJson)==null?void 0:E.acts)?[...N.scriptJson.acts]:[];let i=u.find(B=>Number(B.actIndex)===Number(f));i||(i={actIndex:Number(f),shots:[]},u.push(i)),i.shots=Array.isArray(i.shots)?[...i.shots]:[];let n=i.shots.find(B=>Number(B.shotIndex)===Number(d));n||(n={shotIndex:Number(d),mediaList:[]},i.shots.push(n));const F=Array.isArray(n.mediaList)?n.mediaList.slice():[];if(F.length>=4){m.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}F.push({type:"video",url:V,nodeId:j}),n.mediaList=F;const M={...N.scriptJson||{},acts:u};await Ce.episodes.update(g,w,{scriptJson:M});try{je(B=>B.map(G=>G.id===j?{...G,data:{...G.data,addedToStoryboard:!0}}:G))}catch{}m.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(V){m.error((V==null?void 0:V.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{fe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:_,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),W&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>fe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Re,onChange:P=>de(P.target.value),onMouseDown:P=>P.stopPropagation(),onTouchStart:P=>P.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const P=Q==="ALL"?T:T.filter(E=>(E.category||"OTHER")===Q);return P.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Q==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Y,onChange:E=>se(E.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:P.map(E=>e.jsxs("option",{value:E.id,children:[E.name," (",E._count.assets," ä¸ªèµ„äº§)"]},E.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(P=>e.jsx("button",{type:"button",onClick:()=>{ce(P);const E=T.filter(V=>(V.category||"OTHER")===P);se(E.length>0?E[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Q===P?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:P==="ROLE"?"person":P==="SCENE"?"landscape":P==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:P==="ROLE"?"è§’è‰²åº“":P==="SCENE"?"åœºæ™¯åº“":P==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},P))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>fe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:b,disabled:Z||T.length===0||!Re.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:Z?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`})]})},Io=t.memo(jo),So=({data:s,id:j,selected:l})=>{const{getNodes:W,getEdges:fe,setEdges:T,setNodes:pe,getNode:Y}=Qt(),[se,Q]=t.useState(s.content||""),ce=t.useRef(null),Re=t.useRef(null),de=t.useRef(null),Z=t.useRef(null);t.useEffect(()=>{const R=_=>{_.stopPropagation()},D=Re.current,p=de.current;D&&D.addEventListener("wheel",R,{passive:!0}),p&&p.addEventListener("wheel",R,{passive:!0});const b=Z.current;return b&&b.addEventListener("wheel",R,{passive:!0}),()=>{D&&D.removeEventListener("wheel",R),p&&p.removeEventListener("wheel",R),b&&b.removeEventListener("wheel",R)}},[]);const re=t.useRef(null),je=async R=>{var D,p;try{const b=(s==null?void 0:s.workflowContext)||{},_=b.episode,z=b.nodeGroup||Array.isArray(b.nodeGroups)&&b.nodeGroups.find(w=>(w.nodeIds||[]).includes(j))||null;let P=z==null?void 0:z.scene,E=z==null?void 0:z.shot;try{const w=new URLSearchParams(window.location.search),A=Number(w.get("scene")),$=Number(w.get("shot"));Number.isFinite(A)&&A>0&&(P=P??A),Number.isFinite($)&&$>0&&(E=E??$)}catch{}const V=((D=b.project)==null?void 0:D.id)||(_==null?void 0:_.projectId),a=_==null?void 0:_.id;if(!V||!a||!P||!E)return;const v=await Ce.episodes.getById(V,a),c=(v==null?void 0:v.data)??v,r=(c==null?void 0:c.data)??c,f=Array.isArray((p=r==null?void 0:r.scriptJson)==null?void 0:p.acts)?[...r.scriptJson.acts]:[];let d=f.find(w=>Number(w.actIndex)===Number(P));d||(d={actIndex:Number(P),shots:[]},f.push(d)),d.shots=Array.isArray(d.shots)?[...d.shots]:[];let x=d.shots.find(w=>Number(w.shotIndex)===Number(E));x||(x={shotIndex:Number(E)},d.shots.push(x)),Object.keys(R).forEach(w=>{x[w]=R[w]||""});const g={...r.scriptJson||{},acts:f};await Ce.episodes.update(V,a,{scriptJson:g})}catch(b){m.error((b==null?void 0:b.message)||"ä¿å­˜å¤±è´¥")}},le=()=>{var R,D,p;try{const b=W(),_=fe(),z=b.find(c=>c.id===j),P=_.filter(c=>c.source===j).map(c=>c.target),E=b.filter(c=>c.type==="agent");let V="";const a=E.find(c=>P.includes(c.id));if(a)V=a.id;else if(z&&E.length>0)V=((D=(R=E.map(r=>{var f,d,x,g;return{a:r,dx:(((f=r.position)==null?void 0:f.x)??0)-(((d=z.position)==null?void 0:d.x)??0),dy:Math.abs((((x=r.position)==null?void 0:x.y)??0)-(((g=z.position)==null?void 0:g.y)??0))}}).sort((r,f)=>(r.dx>=0&&f.dx>=0,r.dx-f.dx||r.dy-f.dy))[0])==null?void 0:R.a)==null?void 0:D.id)||E[0].id;else{const c=b.findIndex(r=>r.id===j);V=((p=b[c+1])==null?void 0:p.id)||""}if(!V)return;T(c=>c.some(f=>f.source===j&&f.target===V)?c:[...c,{id:`e-${Date.now()}`,source:j,target:V}]);const v=se||String((s==null?void 0:s.content)||"");pe(c=>c.map(r=>{if(r.id!==V)return r;const f=r.data||{};return r.type==="agent"?{...r,data:{...f,config:{...f.config||{},prompt:v}}}:r.type==="midjourney"?{...r,data:{...f,prompt:v}}:r.type==="aiImage"?{...r,data:{...f,config:{...f.config||{},prompt:v}}}:r.type==="textPreview"?{...r,data:{...f,content:v}}:{...r,data:{...f,config:{...f.config||{},prompt:v}}}}))}catch{}},be=(s.title||"")==="åˆ†é•œè®¾è®¡",ge=(s.title||"")==="æç¤ºè¯",xe=(()=>{if(!be)return[];const R=String(s.content||""),D=R.split(/\r?\n/).map(E=>E.trim()),p=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),b=[];let _=null;for(const E of D){if(!E)continue;const V=E.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(V&&p.has(V[1])){_&&b.push(_),_={label:V[1],content:V[2]||""};continue}if(p.has(E)){_&&b.push(_),_={label:E,content:""};continue}_?_.content=_.content?`${_.content}
${E}`:E:_={label:"æ–‡æœ¬",content:E}}if(_&&b.push(_),b.length===0)return[{label:"æ–‡æœ¬",content:R}];const z=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],P=new Map(z.map((E,V)=>[E,V]));return b.filter(E=>E.content&&E.content.trim().length>0).sort((E,V)=>(P.get(E.label)??999)-(P.get(V.label)??999))})(),[Ie,ae]=t.useState(xe),ee=t.useRef(null),U=t.useRef([]);return t.useEffect(()=>{ae(xe)},[s.content,be]),t.useEffect(()=>{requestAnimationFrame(()=>{U.current.forEach(R=>{R&&(R.style.height="auto",R.style.height=`${R.scrollHeight}px`)})})},[Ie]),t.useEffect(()=>{ge&&Q(s.content||"")},[s.content,ge]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:be?e.jsx("div",{ref:de,className:"space-y-2 nowheel",children:Ie.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ie.map((R,D)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:R.label}),e.jsx("textarea",{value:R.content,onChange:p=>{const b=p.target.value;p.target.style.height="auto",p.target.style.height=`${p.target.scrollHeight}px`,ae(_=>{const z=_.map((V,a)=>a===D?{...V,content:b}:V),P=z.map(V=>`${V.label}ï¼š${V.content}`).join(`
`);return Y(j)&&pe(V=>V.map(a=>a.id===j?{...a,data:{...a.data,content:P}}:a)),ee.current&&(clearTimeout(ee.current),ee.current=null),ee.current=window.setTimeout(async()=>{const V=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),a={};z.forEach(v=>{V.has(v.label)&&(a[v.label]=v.content)}),await je(a)},600),z})},onBlur:async p=>{const b=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),_={};_[R.label]=p.currentTarget.value,b.has(R.label)&&await je(_)},onMouseDown:p=>p.stopPropagation(),onTouchStart:p=>p.stopPropagation(),ref:p=>{U.current[D]=p,p&&(p.style.height="auto",p.style.height=`${p.scrollHeight}px`,p.style.overflow="hidden",p.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",placeholder:`å¡«å†™${R.label}...`})]},`sec-${D}`))}):ge?e.jsxs("div",{ref:Re,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:se,onChange:R=>{const D=R.target.value;Q(D);const p=440;R.target.style.height="auto";const b=Math.min(R.target.scrollHeight,p);R.target.style.height=`${b}px`,R.target.style.overflowY=R.target.scrollHeight>p?"auto":"hidden",Y(j)&&pe(z=>z.map(P=>P.id===j?{...P,data:{...P.data,content:D}}:P)),re.current&&(clearTimeout(re.current),re.current=null),re.current=window.setTimeout(async()=>{await je({æç¤ºè¯:D})},600)},onBlur:async R=>{const D=R.currentTarget.value;await je({æç¤ºè¯:D})},onMouseDown:R=>R.stopPropagation(),onTouchStart:R=>R.stopPropagation(),ref:R=>{if(ce.current=R,R){R.style.wordBreak="break-word",R.style.height="auto";const p=Math.min(R.scrollHeight,440);R.style.height=`${p}px`,R.style.overflowY=R.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:le,onPointerDown:R=>R.stopPropagation(),onMouseDown:R=>R.stopPropagation(),disabled:!se.trim(),className:"nodrag relative w-full mt-2 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:Z,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(St,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Eo=t.memo(So),Co=({data:s,selected:j,id:l})=>{const{setNodes:W,setEdges:fe,getNode:T,getNodes:pe,getEdges:Y,getViewport:se}=Qt(),Q=zs(),ce=Ls(),[Re]=t.useState(s.isExpanded??!0),[de,Z]=t.useState(s.prompt||""),[re,je]=t.useState(s.ratio||"16:9"),[le,be]=t.useState(s.mode||"relax"),[ge,xe]=t.useState(s.chaos??0),[Ie,ae]=t.useState(s.stylize??100),[ee,U]=t.useState(s.weird??0),[R,D]=t.useState(s.quality??1),[p,b]=t.useState(s.styleRaw??!1),[_,z]=t.useState(s.omniWeight??100),[P,E]=t.useState(s.styleWeight??100),[,V]=t.useState(s.taskId||""),[a,v]=t.useState(s.status||"idle"),[c,r]=t.useState(s.progress||""),[f,d]=t.useState(s.omniReferenceImages||[]),[x,g]=t.useState(s.styleReferenceImages||[]),[w,A]=t.useState(!0);t.useEffect(()=>{(async()=>{var y;try{const J=await Ce.midjourney.getSettings();A(((y=J.settings)==null?void 0:y.fastEnabled)??!0)}catch{}})()},[]);const{credits:$,isFreeUsage:N,freeUsageRemaining:u,refetch:i}=Is({moduleType:"midjourney",operationType:"imagine",mode:le}),n=t.useRef(null),F=t.useRef(!1),M=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==de&&Z(s.prompt)},[s.prompt]);const B=S=>{W(y=>y.map(J=>J.id===l?{...J,data:{...J.data,...S}}:J))};t.useEffect(()=>{const S=s.taskId,y=s.status;(async()=>{var ue,H;if(S&&(y==="processing"||y==="submitting"))try{const Ee=(await Ce.midjourney.fetchTask(S)).task;if(Ee.status==="SUCCESS"){const Ne=Ee.imageUrl||"",$e=((ue=Ee.properties)==null?void 0:ue.messageId)||"",Ae=((H=Ee.properties)==null?void 0:H.messageHash)||"",_e=s.ratio||"16:9";if(v("idle"),r(""),B({status:"idle",progress:"",taskId:""}),pe().find(Ve=>{var Qe,Ft,Mt;return Ve.type==="imagePreview"&&((Qe=Ve.data.midjourneyData)==null?void 0:Qe.sourceNodeId)===l&&(((Ft=Ve.data.midjourneyData)==null?void 0:Ft.taskId)===S||$e&&((Mt=Ve.data.midjourneyData)==null?void 0:Mt.messageId)===$e)})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}m.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(Ne,"4å®«æ ¼",_e,{taskId:S,messageId:$e,messageHash:Ae,mode:s.mode||"relax",buttons:Ee.buttons,action:Ee.action})}else Ee.status==="IN_PROGRESS"||Ee.status==="SUBMITTED"?(v("processing"),setTimeout(()=>{M.current(S)},100)):Ee.status==="FAILURE"?(v("error"),r(""),B({status:"error",progress:"",taskId:""}),m.error(Ee.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ee.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Ee.status==="NOT_FOUND"&&(v("idle"),r(""),B({status:"idle",progress:"",taskId:""}))}catch{v("idle"),r(""),B({status:"idle",progress:"",taskId:""}),m.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const G=t.useCallback(()=>{const S=Q.filter(Ne=>Ne.target===l),y=[],J=[];let ue="";S.forEach(Ne=>{var Ae,_e,Ue,ie,Ve,Qe,Ft,Mt;const $e=T(Ne.source);if($e){const At=$e.data,ct=Ne.targetHandle||"omni-ref";if(ct==="text-input"){if($e.type==="agent"){const gt=((Ae=At.config)==null?void 0:Ae.generatedText)||"";gt&&typeof gt=="string"&&(ue=gt)}}else{let gt=At.imageUrl||"";if(!gt&&((_e=At.config)!=null&&_e.selectedAsset)){const vt=At.config.selectedAsset;vt.type==="IMAGE"&&(gt=`https://api.waule.ai${vt.url}`.replace(".oss-oss-",".oss-"))}if(!gt&&((Ue=At.config)!=null&&Ue.generatedImageUrl)&&(gt=At.config.generatedImageUrl),$e.type==="assetSelector"){const vt="https://api.waule.ai",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},Ke=(ie=At.config)==null?void 0:ie.subjects,yt=(Ve=At.config)==null?void 0:Ve.referenceImages;if(ct==="omni-ref"){let Be="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?Be=it(Ke[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Qe=At.config)!=null&&Qe.selectedAsset&&At.config.selectedAsset.type==="IMAGE"&&(Be=it(At.config.selectedAsset.url)),Be&&!y.includes(Be)&&y.length<1&&y.push(Be)}else if(ct==="style-ref"){let Be="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?Be=it(Ke[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Ft=At.config)!=null&&Ft.selectedAsset&&At.config.selectedAsset.type==="IMAGE"&&(Be=it(At.config.selectedAsset.url)),Be&&!J.includes(Be)&&J.length<1&&J.push(Be)}}if($e.type==="upload"){const vt="https://api.waule.ai",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},yt=(((Mt=At.config)==null?void 0:Mt.uploadedFiles)||[]).find(Be=>Be.type==="IMAGE"||(Be.mimeType||"").startsWith("image/"));if(yt){const Be=it(yt.url);ct==="omni-ref"?Be&&!y.includes(Be)&&y.length<1&&y.push(Be):ct==="style-ref"&&Be&&!J.includes(Be)&&J.length<1&&J.push(Be)}}gt&&(ct==="omni-ref"&&!y.includes(gt)?y.push(gt):ct==="style-ref"&&!J.includes(gt)&&J.push(gt))}}}),ue&&ue!==de&&!F.current&&(Z(ue),B({prompt:ue}));const H=Ne=>{if(!Ne||typeof Ne!="string")return!1;const $e=Ne.trim();return $e?!!($e.startsWith("data:image/")||/^https?:\/\//.test($e)||$e.startsWith("/")):!1},he=y.filter(H).slice(0,1),Ee=J.filter(H).slice(0,1);JSON.stringify(he)!==JSON.stringify(f)&&(d(he),B({omniReferenceImages:he})),JSON.stringify(Ee)!==JSON.stringify(x)&&(g(Ee),B({styleReferenceImages:Ee}))},[Q,l,T,ce,de,F.current]);t.useEffect(()=>{G()},[G]),t.useEffect(()=>{const S=n.current;S&&Re&&requestAnimationFrame(()=>{S.style.height="auto";const y=Math.max(60,Math.min(S.scrollHeight,600));S.style.height=`${y}px`})},[de,Re]);const ne=S=>{try{const y=new URL(S),J=new URLSearchParams(y.search);return J.has("width")||J.has("height")?(J.delete("width"),J.delete("height"),y.search=J.toString(),y.toString()):S}catch{return S}},me=S=>{const[J,ue]=S.split(":").map(Number);if(!J||!ue)return{width:512,height:512};const H=J/ue;return H>=1?{width:512,height:Math.round(512/H)}:{width:Math.round(512*H),height:512}},oe=t.useCallback((S,y,J,ue)=>{const H=T(l);if(!H)return;const he=y.startsWith("U")?ne(S):S,Ee=pe(),Ne=Y();if(Ee.filter(Be=>Be.type==="imagePreview"&&Ne.some(wt=>wt.source===l&&wt.target===Be.id)).find(Be=>Be.data.imageUrl===he))return;const _e=400,Ue=200,ie=100,Ve=Be=>{const wt=se().zoom||1,Kt=document.querySelector(`.react-flow__node[data-id="${Be.id}"]`),vs=(Kt==null?void 0:Kt.getBoundingClientRect().width)||Be.data&&Be.data.width||400,Ss=(Kt==null?void 0:Kt.getBoundingClientRect().height)||Be.data&&Be.data.height||300,Es=Math.round(vs/wt),Ns=Math.round(Ss/wt);return{w:Es,h:Ns}},Qe=(Be,wt=300)=>{if(!Be||!/^[0-9]+\s*:\s*[0-9]+$/.test(Be))return wt;const[Kt,vs]=Be.split(":").map(Ss=>parseFloat(Ss));return!Kt||!vs?wt:Math.round(_e*(vs/Kt))},Ft=Ve(H),Mt=Qe(J,300),At=H.position.x+Ft.w+Ue,ct=H.position.y,gt=pe().filter(Be=>{var wt,Kt;return Be.type==="imagePreview"&&((Kt=(wt=Be.data)==null?void 0:wt.midjourneyData)==null?void 0:Kt.sourceNodeId)===l}).length,vt=At,it=ct+gt*(Mt+ie),Ke=`preview-${Date.now()}`,yt={id:Ke,type:"imagePreview",position:{x:vt,y:it},data:{imageUrl:he,width:_e,ratio:J,workflowContext:H.data.workflowContext,createdBy:H.data.createdBy,midjourneyData:ue?{taskId:ue.taskId,messageId:ue.messageId,messageHash:ue.messageHash,sourceNodeId:l,mode:ue.mode,buttons:ue.buttons,action:ue.action}:void 0}};W(Be=>[...Be,yt]),fe(Be=>[...Be,{id:`${l}-${Ke}`,source:l,target:Ke,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),m.success(`âœ¨ å·²åˆ›å»º${y}é¢„è§ˆèŠ‚ç‚¹`)},[l,T,pe,Y,W,fe,ne,me]),k=t.useCallback(async()=>{var S,y,J,ue,H,he,Ee,Ne,$e,Ae,_e,Ue;if(!de.trim()){m.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}v("submitting"),r(""),B({status:"submitting",progress:""});try{const ie=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ve=de.toLowerCase(),Qe=ie.find(it=>Ve.includes(it));if(Qe){m.error(`æ£€æµ‹åˆ°å‚æ•° "${Qe}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),v("idle"),B({status:"idle",progress:"",taskId:""});return}v("submitting");let Ft=de;try{m.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const it=await Ce.translation.smartTranslate({text:de});it.success&&(Ft=it.translatedText,it.needsTranslation&&m.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{m.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}m.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let Mt=Ft.trim();if(re&&re!=="1:1"&&!Mt.includes("--ar")&&(Mt+=` --ar ${re}`),!Mt.includes("--v")&&!Mt.includes("--version")&&(Mt+=" --v 7.0"),le==="fast"&&!Mt.includes("--fast")?Mt+=" --fast":le==="relax"&&!Mt.includes("--relax")&&(Mt+=" --relax"),ge>0&&(Mt+=` --chaos ${ge}`),Ie!==100&&(Mt+=` --stylize ${Ie}`),ee>0&&(Mt+=` --weird ${ee}`),R!==1&&(Mt+=` --quality ${R}`),p&&(Mt+=" --style raw"),f.length>0){m.info(`æ­£åœ¨ä¸Šä¼  ${f.length} å¼ å‚è€ƒå›¾...`);const it=[];for(let Ke=0;Ke<f.length;Ke++){const yt=f[Ke];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{m.error(`å‚è€ƒå›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),v("idle");return}}Mt+=` --oref ${it.join(" ")}`,_!==100&&(Mt+=` --ow ${_}`),m.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(x.length>0){m.info(`æ­£åœ¨ä¸Šä¼  ${x.length} å¼ é£æ ¼å›¾...`);const it=[];for(let Ke=0;Ke<x.length;Ke++){const yt=x[Ke];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{m.error(`é£æ ¼å›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),v("idle");return}}Mt+=` --sref ${it.join(" ")}`,P!==100&&(Mt+=` --sw ${P}`),m.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const At=await Ce.midjourney.imagine({prompt:Mt,nodeId:l,mode:le});if(!At.success)throw new Error(At.description||"ä»»åŠ¡æäº¤å¤±è´¥");const ct=At.taskId;V(ct),v("processing"),B({taskId:ct,status:"processing",progress:"",prompt:de,ratio:re,mode:le,chaos:ge,stylize:Ie,weird:ee,quality:R,styleRaw:p,omniWeight:_,styleWeight:P});const gt=At.isFreeUsage,vt=At.creditsCharged||0;if(gt)m.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${u} æ¬¡æœºä¼š`),i();else if(vt>0){const{useAuthStore:it}=await ds(async()=>{const{useAuthStore:yt}=await import("./index-B7LKGTE9.js").then(Be=>Be.f);return{useAuthStore:yt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ke}=it.getState();await Ke(),m.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${vt} ç§¯åˆ†`),i()}else m.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");M.current(ct)}catch(ie){if(v("error"),r(""),B({status:"error",progress:"",taskId:""}),((S=ie.response)==null?void 0:S.status)===403){const Ft=((J=(y=ie.response)==null?void 0:y.data)==null?void 0:J.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";m.error(Ft);return}if(((ue=ie.response)==null?void 0:ue.status)===429){m.warning(((he=(H=ie.response)==null?void 0:H.data)==null?void 0:he.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ve=((Ne=(Ee=ie.response)==null?void 0:Ee.data)==null?void 0:Ne.description)||((Ae=($e=ie.response)==null?void 0:$e.data)==null?void 0:Ae.error)||ie.message,Qe=(Ue=(_e=ie.response)==null?void 0:_e.data)==null?void 0:Ue.bannedWord;Qe?m.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${Qe}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):m.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ve}ï¼Œè¯·ç¨åé‡è¯•`)}},[de,re,le,ge,Ie,ee,R,p,f,_,x,P,B,N,u,i]),h=t.useCallback(async S=>{let y=0;const J=150,ue=2e3,H=async()=>{var he,Ee,Ne,$e;try{const _e=(await Ce.midjourney.fetchTask(S)).task;if(_e.status==="SUCCESS"){const ie=_e.imageUrl||"",Ve=((he=_e.properties)==null?void 0:he.messageId)||"",Qe=((Ee=_e.properties)==null?void 0:Ee.messageHash)||"";if(v("idle"),r(""),B({status:"idle",taskId:"",progress:""}),pe().find(At=>{var ct,gt,vt;return At.type==="imagePreview"&&((ct=At.data.midjourneyData)==null?void 0:ct.sourceNodeId)===l&&(((gt=At.data.midjourneyData)==null?void 0:gt.taskId)===S||Ve&&((vt=At.data.midjourneyData)==null?void 0:vt.messageId)===Ve)})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}m.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(ie,"4å®«æ ¼",re,{taskId:S,messageId:Ve,messageHash:Qe,mode:le,buttons:_e.buttons,action:_e.action});return}const Ue=_e.progress||"";if(r(Ue),(_e.status==="IN_PROGRESS"||_e.status==="SUBMITTED")&&(v("processing"),B({status:"processing",progress:Ue})),_e.status==="FAILURE"){v("error"),r(""),B({status:"error",progress:"",taskId:""}),m.error(_e.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${_e.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(_e.status==="NOT_FOUND"){v("error"),r(""),B({status:"error",progress:"",taskId:""}),m.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}y++,y<J?setTimeout(H,ue):(v("error"),r(""),B({status:"error",progress:"",taskId:""}),m.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Ae){if((Ae.code==="ECONNABORTED"||Ae.code==="ERR_NETWORK"||((Ne=Ae.message)==null?void 0:Ne.includes("aborted"))||(($e=Ae.message)==null?void 0:$e.includes("Network Error")))&&y<J-1){y++,setTimeout(H,ue*2);return}v("error"),r(""),B({status:"error",progress:"",taskId:""}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};H()},[l,re,oe,B,pe]);return M.current=h,e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Re&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:n,value:de,onChange:S=>{F.current=!0,Z(S.target.value)},onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:a==="processing"||a==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>be("relax"),disabled:a==="processing"||a==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${le==="relax"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!w){m.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}be("fast")},disabled:a==="processing"||a==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${w?le==="fast"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50":"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:cursor-not-allowed`,title:w?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!w&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(os,{value:re,onChange:S=>je(S),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:a==="processing"||a==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:ge})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:ge,onChange:S=>xe(Number(S.target.value)),disabled:a==="processing"||a==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${ge/2}%, #06b6d4 ${ge}%, var(--range-bg-color) ${ge}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ie})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ie,onChange:S=>ae(Number(S.target.value)),disabled:a==="processing"||a==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Ie/1e3*50}%, #06b6d4 ${Ie/1e3*100}%, var(--range-bg-color) ${Ie/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:ee})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:ee,onChange:S=>U(Number(S.target.value)),disabled:a==="processing"||a==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${ee/3e3*50}%, #06b6d4 ${ee/3e3*100}%, var(--range-bg-color) ${ee/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:R})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:R===.25?0:R===.5?1:R===1?2:3,onChange:S=>{const y=Number(S.target.value);D(y===0?.25:y===1?.5:y===2?1:2)},disabled:a==="processing"||a==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(R===.25?0:R===.5?1:R===1?2:3)/3*50}%, #06b6d4 ${(R===.25?0:R===.5?1:R===1?2:3)/3*100}%, var(--range-bg-color) ${(R===.25?0:R===.5?1:R===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>b(!p),disabled:a==="processing"||a==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:cursor-not-allowed ${p?"bg-neutral-800 dark:bg-white text-white dark:text-black border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-neutral-500 dark:border-neutral-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${p?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-neutral-800 dark:bg-white text-white dark:text-black"}`})})]})})]}),f.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Lr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",f.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:f.map((S,y)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:S,alt:`Reference ${y+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",y+1]})})]},y))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:_})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:_,onChange:S=>z(Number(S.target.value)),disabled:a==="processing"||a==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${_/1e3*50}%, #06b6d4 ${_/1e3*100}%, var(--range-bg-color) ${_/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),x.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Lr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",x.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:x.map((S,y)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:S,alt:`Style ${y+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",y+1]})})]},y))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:P})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:P,onChange:S=>E(Number(S.target.value)),disabled:a==="processing"||a==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${P/1e3*50}%, #06b6d4 ${P/1e3*100}%, var(--range-bg-color) ${P/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:k,onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),disabled:a==="processing"||a==="submitting"||s._canEdit===!1||!(de!=null&&de.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 relative overflow-hidden ${a==="processing"||a==="submitting"||!(de!=null&&de.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:[a==="processing"&&c&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-neutral-400/30 to-accent-400/30 transition-all duration-300",style:{width:c}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:a==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):a==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!c||c===""||c==="0%"?le==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${c}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),N?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(u),"æ¬¡"]}):$!==null&&$>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:[$,"ç§¯åˆ†"]})]})})]}),a==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(gs,{type:"target",position:ut.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:S=>{const y=T(S.source||"");return!!y&&y.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(gs,{type:"target",position:ut.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:S=>!Q.some(J=>J.target===l&&J.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(gs,{type:"target",position:ut.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:S=>!Q.some(J=>J.target===l&&J.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(gs,{type:"source",position:ut.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},yr="https://api.waule.ai",Ao=({data:s,selected:j,id:l})=>{var bs,er,ws,tr,sr,rr,Ps;const[W,fe]=t.useState(!0),[,T]=t.useState(0),[pe,Y]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[pe]);const{setNodes:se,setEdges:Q,getNode:ce,getNodes:Re,getEdges:de}=Qt(),Z=zs(),re=Ls(),je=t.useRef(""),le=(bs=s.config)==null?void 0:bs.selectedEditingCapability,be=t.useMemo(()=>(s.models||[]).filter(te=>{var Me;return te.type==="VIDEO_GENERATION"&&((Me=te.provider)==null?void 0:Me.toLowerCase())==="sora"}),[s.models]),[ge,xe]=t.useState(s.config.prompt||""),Ie=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ge&&xe(s.config.prompt)},[s.config.prompt]);const[ae,ee]=t.useState(s.config.modelId||((er=be[0])==null?void 0:er.id)||""),[U,R]=t.useState(s.config.ratio||"16:9"),[D,p]=t.useState(s.config.resolution||"1080P"),b=t.useCallback(q=>{const te=(q||"").toLowerCase();return te?te.includes("æ–‡ç”Ÿ")||te.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":te.includes("é¦–å°¾")?"é¦–å°¾å¸§":te.includes("é¦–å¸§")||te.includes("first frame")||te.includes("start frame")||te.includes("initial frame")||te.includes("keyframe")?"é¦–å¸§":te.includes("å°¾å¸§")||te.includes("last frame")||te.includes("end frame")||te.includes("final frame")?"å°¾å¸§":te.includes("ä¸»ä½“å‚è€ƒ")||te.includes("å‚è€ƒ")||te.includes("reference image")||te.includes("image reference")||te.includes("ref image")?"å‚è€ƒå›¾":te.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":te.includes("first-last")||te.includes("two-frame")||te.includes("frame pair")?"é¦–å°¾å¸§":te.includes("first")?"é¦–å¸§":te.includes("last")?"å°¾å¸§":te.includes("subject")||te.includes("reference")?"å‚è€ƒå›¾":q||"":""},[]),[_,z]=t.useState((s.config.lockedGenerationType?b(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[P,E]=t.useState(s.config.duration||10),[V,a]=t.useState(s.config.isGenerating||!1),[v,c]=t.useState([]),[r,f]=t.useState(null),[d,x]=t.useState(!1),[g]=t.useState(""),[w]=t.useState("confirm"),[A]=t.useState(null),[$,N]=t.useState(!1),[u,i]=t.useState([]),[n,F]=t.useState(""),[M,B]=t.useState(0),[G,ne]=t.useState(0),me=t.useRef(!1),[oe,k]=t.useState(!1),h=be.find(q=>q.id===ae)||be[0],{credits:S,loading:y,isFreeUsage:J,freeUsageRemaining:ue,refetch:H}=Is({aiModelId:h==null?void 0:h.id,duration:P,resolution:D});t.useEffect(()=>{var q,te;if(!be.find(Me=>Me.id===ae)){const Me=((q=be[0])==null?void 0:q.id)||"";ee(Me),Qe({modelId:Me,modelName:(te=be[0])==null?void 0:te.name})}},[be]);const he=((ws=h==null?void 0:h.provider)==null?void 0:ws.toLowerCase())==="sora",Ee=t.useMemo(()=>{var te;if((te=h==null?void 0:h.config.supportedDurations)!=null&&te.length)return h.config.supportedDurations;const q=((h==null?void 0:h.provider)||"").toLowerCase();return q==="sora"?[10,15]:q==="minimaxi"?[6,10]:[P||10]},[h,P]),Ne=t.useMemo(()=>{var te;return(te=h==null?void 0:h.config.supportedResolutions)!=null&&te.length?h.config.supportedResolutions:((h==null?void 0:h.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[h]),$e=t.useMemo(()=>Math.min(...Ee),[Ee]),Ae=t.useMemo(()=>Math.max(...Ee),[Ee]),_e=t.useMemo(()=>Math.max(1,Ae-$e),[Ae,$e]),Ue=t.useMemo(()=>{const q=(P-$e)/_e*100;return Number.isNaN(q)?0:Math.min(100,Math.max(0,q))},[P,$e,_e]),ie=!h||!((tr=h.config.supportedDurations)!=null&&tr.length),Ve=!h||!((sr=h.config.supportedResolutions)!=null&&sr.length),Qe=t.useCallback(q=>{ce(l)&&se(Me=>Me.map(Ge=>Ge.id===l?{...Ge,data:{...Ge.data,config:{...Ge.data.config,...q}}}:Ge))},[ce,l,se]),Ft=(q,te)=>{const Me=(C,O)=>O===0?C:Me(O,C%O),Ge=Me(q,te),qe=q/Ge,Oe=te/Ge,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},bt=`${qe}:${Oe}`;return tt[bt]||bt},Mt=()=>{const q=Z.filter(Oe=>Oe.target===l),te=[];q.forEach(Oe=>{var bt;const tt=ce(Oe.source);if(tt&&tt.type==="upload"&&(((bt=tt.data.config)==null?void 0:bt.uploadedFiles)||[]).forEach(O=>{const we=O.type||O.mimeType||"";(we==="IMAGE"||we.startsWith("image/"))&&te.push({id:O.id||O.name,url:O.url,name:O.name||O.originalName,width:O.width,height:O.height,aspectRatio:O.width&&O.height?Ft(O.width,O.height):"16:9"})}),tt&&tt.type==="assetSelector"){const C=tt.data.config||{},O=C.subjects,we=C.selectedAsset,Te=b(_);O&&O.length>0?Te==="é¦–å°¾å¸§"||(O[0].images||[]).forEach((ye,et)=>{te.push({id:`${tt.id}-subject-${et}`,url:ye,name:O[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):we&&we.type==="IMAGE"&&te.push({id:we.id,url:we.url,name:we.name||we.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const C=tt.data.imageUrl,O=tt.data.width,we=tt.data.height;C&&te.push({id:tt.id,url:C,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:O,height:we,aspectRatio:O&&we?Ft(O,we):"16:9"})}});const Me=new Set,Ge=[];te.forEach(Oe=>{const tt=Oe.url;Me.has(tt)||(Me.add(tt),Ge.push(Oe))});const qe=b(_);return qe==="æ–‡ç”Ÿè§†é¢‘"?he?Ge:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ge.slice(0,1):qe==="é¦–å°¾å¸§"?Ge.slice(0,2):qe==="å‚è€ƒå›¾"?Ge.slice(0,7):Ge},At=t.useMemo(()=>Mt(),[Z,re,_,l,he]);t.useEffect(()=>{const q=s.config.taskId;(async()=>{if(q){try{const Ge=(await Ce.tasks.getTaskStatus(q)).task;if(Ge.status==="SUCCESS"){a(!1),T(100);const qe=Ge.resultUrl;if(!qe){a(!1),T(0),Qe({taskId:"",isGenerating:!1}),Y(""),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Oe=s.config.ratio||"16:9";Qe({taskId:"",isGenerating:!1}),Y("");const tt=Re(),bt=de();if(tt.filter(we=>we.type==="videoPreview"&&bt.some(Te=>Te.source===l&&Te.target===we.id)).find(we=>we.data.videoUrl===qe)){setTimeout(()=>T(0),1e3);return}m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼");try{const we=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(we).some(ye=>ye.taskId&&ye.taskId===q||ye.sourceNodeId&&ye.sourceNodeId===l)||_t(qe,Oe)}catch{_t(qe,Oe)}setTimeout(()=>T(0),1e3)}else if(Ge.status==="PROCESSING"||Ge.status==="PENDING"){a(!0),T(Ge.progress||0),Zs(q);return}else Ge.status==="FAILURE"&&(a(!1),T(0),Qe({taskId:"",isGenerating:!1}),Y(""),m.error(`ç”Ÿæˆå¤±è´¥: ${Ge.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{a(!1),T(0),Qe({taskId:"",isGenerating:!1}),Y("")}return}try{const Me=await Ce.tasks.getPendingPreviewNodes(l);if(Me.tasks&&Me.tasks.length>0)for(const Ge of Me.tasks){const{previewNodeData:qe}=Ge;if(qe&&qe.url){const Oe=qe.ratio||s.config.ratio||"16:9";let tt=!1;try{const bt=localStorage.getItem("suppressedPreviewTasks")||"[]";tt=JSON.parse(bt).some(O=>O.taskId&&O.taskId===Ge.id||O.sourceNodeId&&O.sourceNodeId===l)}catch{}tt||(_t(qe.url,Oe),m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")),await Ce.tasks.markPreviewNodeCreated(Ge.id)}}}catch{}})()},[]),t.useEffect(()=>{const q=Z.filter(Me=>Me.target===l);let te="";q.forEach(Me=>{var qe;const Ge=ce(Me.source);if(Ge){const Oe=Ge.data;Ge.type==="agent"&&((qe=Oe.config)!=null&&qe.generatedText)?te||(te=Oe.config.generatedText):Ge.type==="textPreview"&&Oe.content&&(te||(te=Oe.content))}}),te&&te!==ge&&(xe(te),Qe({prompt:te}))},[Z,l,ce,ge,Qe]),t.useEffect(()=>{const q=Z.filter(Ge=>Ge.target===l);if(q.length===0)return;let te="",Me="";q.forEach(Ge=>{var Oe;const qe=re.find(tt=>tt.id===Ge.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Oe=tt.config)!=null&&Oe.generatedText&&(te=tt.config.generatedText,Me=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),te&&Me!==je.current&&(je.current=Me,xe(te),Qe({prompt:te}))},[re,Z,l,Qe]),t.useEffect(()=>{const q=JSON.stringify(At),te=JSON.stringify(v);q!==te&&c(At)},[At]);const ct=t.useMemo(()=>{if(he)return!0;const q=v.length,te=b(_);return q===0?!0:q===1?te==="å‚è€ƒå›¾":q===2?te==="é¦–å°¾å¸§"?!1:te==="å‚è€ƒå›¾":q>2?te==="å‚è€ƒå›¾":!1},[v.length,_,b,he]),gt=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),vt=t.useMemo(()=>{const q=b(_);return le?be:be.filter(te=>{var Ge;const Me=(((Ge=te.config)==null?void 0:Ge.supportedGenerationTypes)||[]).map(qe=>b(qe));return q==="é¦–å¸§"||q==="å°¾å¸§"?Me.includes("é¦–å¸§")||Me.includes("å°¾å¸§"):Me.includes(q)})},[be,_,b,le]),it=t.useMemo(()=>{const q=le?be:vt;return q.length>0?q:le?(s.models||[]).filter(Me=>(Me.type||"")==="VIDEO_EDITING"):q},[le,be,vt,s.models]);t.useEffect(()=>{var te,Me;if(!it.find(Ge=>Ge.id===ae)){const Ge=((te=it[0])==null?void 0:te.id)||"";ee(Ge),Qe({modelId:Ge||void 0,modelName:Ge?(Me=it[0])==null?void 0:Me.name:void 0})}},[it]);const Ke=t.useCallback(q=>{const te=b(q);return le?["IMAGE","VIDEO"]:te==="æ–‡ç”Ÿè§†é¢‘"?he?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[b,le,he]);t.useEffect(()=>{if(!ct&&v.length>0){const q=v[0].aspectRatio;q&&U!==q&&(R(q),setTimeout(()=>{Qe({ratio:q})},0))}},[ct,v,U]),t.useEffect(()=>{if(!le&&gt.length>0&&!gt.includes(_)){const q="æ–‡ç”Ÿè§†é¢‘";z(q),setTimeout(()=>{Qe({generationType:q,acceptedInputs:Ke(q)})},0)}},[gt,_,Ke,le]),t.useEffect(()=>{const q=b(_);if(q==="æ–‡ç”Ÿè§†é¢‘")return;const te=Z.filter(Oe=>Oe.target===l),Me=[],Ge=[];te.forEach(Oe=>{var C,O,we,Te,Se;const tt=ce(Oe.source);if(!tt)return;const bt=tt.type;if((bt||"").startsWith("aiVideo")||bt==="videoPreview"){Ge.push(Oe.id);return}if(bt==="upload"){const ye=(we=(O=(C=tt.data)==null?void 0:C.config)==null?void 0:O.uploadedFiles)==null?void 0:we[0],et=((ye==null?void 0:ye.type)||"").toUpperCase(),st=((ye==null?void 0:ye.mimeType)||"").toLowerCase();if(et==="VIDEO"||st.startsWith("video/")){Ge.push(Oe.id);return}(et==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id);return}if(bt==="assetSelector"){const ye=((Te=tt.data)==null?void 0:Te.config)||{};if(ye.selectedAsset){const et=(ye.selectedAsset.type||"").toUpperCase(),st=(ye.selectedAsset.mimeType||"").toLowerCase();et==="VIDEO"||st.startsWith("video/")?Ge.push(Oe.id):(et==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id)}else if(ye.subjects&&ye.subjects.length>0){const et=(((Se=ye.subjects[0])==null?void 0:Se.images)||[]).length;q==="å‚è€ƒå›¾"||q==="é¦–å°¾å¸§"?Me.push(Oe.id):(q==="é¦–å¸§"||q==="å°¾å¸§")&&(et>1?Ge.push(Oe.id):Me.push(Oe.id))}return}(bt==="aiImage"||bt==="imagePreview")&&Me.push(Oe.id)});let qe=new Set([...Ge]);q==="é¦–å¸§"||q==="å°¾å¸§"?Me.slice(1).forEach(Oe=>qe.add(Oe)):q==="é¦–å°¾å¸§"&&Me.slice(2).forEach(Oe=>qe.add(Oe)),qe.size>0&&Q(Oe=>Oe.filter(tt=>!qe.has(tt.id)))},[_,Z,l,ce,Q,b]),t.useEffect(()=>{const q=s.config.generationType;if(!q||b(q)!==b(_)){const te=b(_)||"æ–‡ç”Ÿè§†é¢‘";Qe({generationType:te,acceptedInputs:Ke(te)})}},[]),t.useEffect(()=>{const q=Ke(_);Qe({acceptedInputs:q})},[_,Ke]);const yt=q=>{f(q)},Be=q=>{q.preventDefault()},wt=q=>{if(r===null)return;const te=[...v],[Me]=te.splice(r,1);te.splice(q,0,Me),c(te),f(null),Qe({referenceImages:te})};t.useEffect(()=>{const q=Ie.current;q&&W&&requestAnimationFrame(()=>{q.style.height="auto";const te=Math.max(60,Math.min(q.scrollHeight,600));q.style.height=`${te}px`})},[ge,W]),t.useEffect(()=>{if(ge===s.config.prompt)return;const q=setTimeout(()=>{Qe({prompt:ge})},500);return()=>clearTimeout(q)},[ge]);const Kt=t.useCallback(async q=>{if(!q){i([]);return}try{const te=await Ce.soraCharacters.search(q,5);i(te.characters||[]),ne(0)}catch{i([])}},[]),vs=t.useCallback(q=>{const te=q.target.value,Me=q.target.selectionStart||0;if(xe(te),me.current)return;const qe=te.substring(0,Me).match(/@([^@\s#]*)$/);if(qe){const Oe=qe[1];F(Oe),B(Me-Oe.length-1),N(!0),Kt(Oe)}else N(!1),i([])},[Kt]),Ss=t.useCallback(q=>{const te=ge.substring(0,M),Me=ge.substring(M+n.length+1),Ge=`@#${q.customName}#`,qe=te+Ge+Me;xe(qe),N(!1),i([]),F(""),setTimeout(()=>{if(Ie.current){Ie.current.focus();const Oe=te.length+Ge.length;Ie.current.setSelectionRange(Oe,Oe)}},0)},[ge,M,n]),Es=t.useCallback(q=>{!$||u.length===0||(q.key==="ArrowDown"?(q.preventDefault(),ne(te=>te<u.length-1?te+1:te)):q.key==="ArrowUp"?(q.preventDefault(),ne(te=>te>0?te-1:te)):q.key==="Enter"&&u[G]?(q.preventDefault(),Ss(u[G])):q.key==="Escape"&&N(!1))},[$,u,G,Ss]),Ns=t.useCallback(async q=>{var qe;const te=/@#([^#]+)#/g,Me=[...q.matchAll(te)];if(Me.length===0)return q;let Ge=q;for(const Oe of Me){const tt=Oe[1];try{const bt=await Ce.soraCharacters.getByCustomName(tt);(qe=bt.character)!=null&&qe.characterName&&(Ge=Ge.replace(Oe[0],` ${bt.character.characterName} `))}catch{}}return Ge},[]),Bs=q=>{var Me,Ge,qe,Oe;ee(q);const te=vt.find(tt=>tt.id===q);if(te){const tt=(Me=te.config.supportedRatios)!=null&&Me.length?te.config.supportedRatios:["16:9"],bt=(Ge=te.config.supportedResolutions)!=null&&Ge.length?te.config.supportedResolutions:["1080P"],C=(qe=te.config.supportedGenerationTypes)!=null&&qe.length?te.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],O=(te.provider||"").toLowerCase(),we=(Oe=te.config.supportedDurations)!=null&&Oe.length?te.config.supportedDurations:O==="sora"?[10,15]:O==="minimaxi"?[6,10]:[10],Te=tt[0],Se=bt[0],ye=b(_||C[0]),et=we[0];R(Te),p(Se),z(ye),E(et),Qe({modelId:q,modelName:te.name,ratio:Te,resolution:Se,generationType:ye,duration:et,acceptedInputs:Ke(ye)})}},ps=t.useMemo(()=>{const q=b(_),te=v.length,qe=Z.filter(Oe=>Oe.target===l).filter(Oe=>{var C,O,we,Te,Se;const tt=ce(Oe.source),bt=tt==null?void 0:tt.type;if(!tt)return!1;if(bt==="upload"){const ye=(we=(O=(C=tt.data)==null?void 0:C.config)==null?void 0:O.uploadedFiles)==null?void 0:we[0],et=((ye==null?void 0:ye.mimeType)||"").toLowerCase();return((ye==null?void 0:ye.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}if(bt==="assetSelector"){const ye=(Se=(Te=tt.data)==null?void 0:Te.config)==null?void 0:Se.selectedAsset,et=((ye==null?void 0:ye.mimeType)||"").toLowerCase();return((ye==null?void 0:ye.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}return!!((bt||"").startsWith("aiVideo")||bt==="videoPreview")}).length;return ae?q==="æ–‡ç”Ÿè§†é¢‘"?he?!0:!!ge.trim():q==="é¦–å¸§"||q==="å°¾å¸§"?te>=1:q==="é¦–å°¾å¸§"?te>=2:q==="å‚è€ƒå›¾"?te>=1:q==="è§†é¢‘æ¢äºº"?qe>=1&&te>=1:q==="å¯¹å£å‹"||q==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[_,v.length,ge,V,Z,l,ce,b,he]);t.useEffect(()=>{var te;const q=(te=s==null?void 0:s.config)==null?void 0:te.generatedVideoUrl;q&&_t(q,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const Zs=async q=>{let Me=0;const Ge=async()=>{try{Me++;const Oe=(await Ce.tasks.getTaskStatus(q)).task;if(T(Oe.progress||0),Oe.status==="SUCCESS"||Oe.status==="COMPLETED"||Oe.status==="DONE"){T(100);const tt=Oe.resultUrl;a(!1),_t(tt,s.config.ratio||"16:9");try{await Ce.tasks.markPreviewNodeCreated(q)}catch{}Qe({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),Y(""),m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>T(0),1e3);return}else if(Oe.status==="FAILURE"){a(!1),T(0),Qe({taskId:"",isGenerating:!1}),m.error(Oe.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Oe.status==="PROCESSING"||Oe.status==="PENDING")&&(Me<600?setTimeout(Ge,1e3):(a(!1),T(0),Qe({taskId:"",isGenerating:!1}),m.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{a(!1),T(0),Qe({taskId:"",isGenerating:!1}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ge()},Hs=async()=>{var Me,Ge,qe,Oe,tt,bt;if(b(_)==="æ–‡ç”Ÿè§†é¢‘"&&!ge.trim()){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}a(!0);const te=Mt();Qe({referenceImages:te}),T(0);try{let C=[],O;const we=te.length;if(te.length>0)try{for(const zt of te){let Ct=zt.url;!Ct.startsWith("data:")&&!Ct.startsWith("http")&&(Ct=`${yr}${Ct}`),Ct=Ct.replace(/^https?:\/\/localhost(?::\d+)?/i,yr);const Tt=await ur(Ct);C.push(Tt)}}catch{m.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Te=Z.filter(zt=>zt.target===l);if(b(_)==="å‚è€ƒå›¾"){const zt=new Map;for(const Ct of Te){const Tt=ce(Ct.source);if((Tt==null?void 0:Tt.type)==="assetSelector"){const Gt=(Me=Tt.data.config)==null?void 0:Me.subjects;if(Gt&&Gt.length>0){for(const Wt of Gt)if(!zt.has(Wt.name)){const ts=(Wt.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${yr}${rs}`);zt.set(Wt.name,ts)}}}}if(zt.size>0){const Ct=Array.from(zt.entries());let Tt=0;const Gt=[];for(const[Wt,ts]of Ct){if(Tt>=7)break;const rs=7-Tt,ys=ts.slice(0,Math.max(0,rs));ys.length>0&&(Gt.push({name:Wt,images:ys}),Tt+=ys.length)}O=Gt,Ct.some(([,Wt])=>Wt.length>0)&&Tt<Ct.reduce((Wt,[,ts])=>Wt+ts.length,0)&&m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const Se=O&&O.length>0?O.reduce((zt,Ct)=>{var Tt;return zt+(((Tt=Ct.images)==null?void 0:Tt.length)||0)},0):we;let ye=_;if(ye==="é¦–å¸§"||ye==="å°¾å¸§"){if(Se!==1){m.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),a(!1),T(0);return}}else if(ye==="é¦–å°¾å¸§"){if(Se===1)ye="é¦–å¸§";else if(Se!==2){m.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),a(!1),T(0);return}O&&O.length>0?O=[{...O[0],images:O[0].images.slice(0,2)}]:C=C.slice(0,2)}else if(ye==="å‚è€ƒå›¾"||ye==="ä¸»ä½“å‚è€ƒ"){if(Se<1){m.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),a(!1),T(0);return}if(O&&O.length>0){if(O.reduce((Ct,Tt)=>{var Gt;return Ct+(((Gt=Tt.images)==null?void 0:Gt.length)||0)},0)>7){let Ct=7;O=O.map(Tt=>({...Tt,images:Tt.images.slice(0,Math.max(0,Ct-=Tt.images.length,Tt.images.length))})),Ct=7,O=O.map(Tt=>{const Gt=Tt.images.slice(0,Math.min(Tt.images.length,Ct));return Ct-=Gt.length,{...Tt,images:Gt}}).filter(Tt=>Tt.images.length>0),m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else C.length>7&&(C=C.slice(0,7),m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}A==="dropImages"&&(C=[],O=void 0),(b(_)==="é¦–å¸§"||b(_)==="å°¾å¸§")&&A==="useFirstImage"&&C.length>=2&&(C=[C[0]]),b(_)==="é¦–å°¾å¸§"&&A==="useFirstTwoImages"&&C.length>=3&&(C=C.slice(0,2));const et={modelId:ae,ratio:U,duration:P,referenceImages:C.length>0&&!O?C:void 0,generationType:ye,sourceNodeId:l,...O?{subjects:O}:{}},st=b(ye);let kt=ge.trim();if(kt&&kt.includes("@#")&&(kt=await Ns(kt)),!oe&&kt&&(kt="No BGM. "+kt),st==="æ–‡ç”Ÿè§†é¢‘"){if(!kt){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),a(!1),T(0);return}et.prompt=kt}else if(st==="å‚è€ƒå›¾"){if(!kt){m.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),a(!1),T(0);return}et.prompt=kt}else kt&&(et.prompt=kt);const ht=await Ce.tasks.createVideoTask(et),We=ht.taskId,Dt=ht.creditsCharged||0,Xt=ht.isFreeUsage,Pt=ht.freeUsageRemaining??0;if(Y(We),Qe({prompt:ge,ratio:U,resolution:D,generationType:_,duration:P,modelId:ae,taskId:We,isGenerating:!0}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),Xt)m.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Pt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),H();else if(Dt>0){const{useAuthStore:zt}=await ds(async()=>{const{useAuthStore:Tt}=await import("./index-B7LKGTE9.js").then(Gt=>Gt.f);return{useAuthStore:Tt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ct}=zt.getState();await Ct(),m.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Dt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),H()}else m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Zs(We)}catch(C){if(a(!1),T(0),((Ge=C.response)==null?void 0:Ge.status)===403){const O=((Oe=(qe=C.response)==null?void 0:qe.data)==null?void 0:Oe.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";m.error(O)}else{const O=((bt=(tt=C.response)==null?void 0:tt.data)==null?void 0:bt.error)||C.message||"æœªçŸ¥åŸå› ";m.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${O}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const q=b(_),te=Mt(),Me=te.length;if((()=>{var Oe;const qe=Z.filter(tt=>tt.target===l);for(const tt of qe){const bt=ce(tt.source);if((bt==null?void 0:bt.type)==="assetSelector"){const C=(Oe=bt.data.config)==null?void 0:Oe.subjects;if(C&&C.length>0)return!0}}return!1})()&&(q==="é¦–å¸§"||q==="å°¾å¸§"||q==="é¦–å°¾å¸§")){m.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&Me===0){m.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(q==="é¦–å°¾å¸§"&&Me===0){m.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(q==="å‚è€ƒå›¾"&&Me===0){m.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&Me>0&&!he&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&Me>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="é¦–å°¾å¸§"&&Me>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&!ge.trim()){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!ae){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}c(te),Qe({referenceImages:te}),a(!0),T(0),await Hs()},_t=(q,te)=>{const Me=ce(l);if(!Me||!q)return null;const Ge=te||U||"16:9",qe=Re(),Oe=de(),tt=qe.filter(Gt=>Gt.type==="videoPreview"&&Oe.some(Wt=>Wt.source===l&&Wt.target===Gt.id)),bt=tt.find(Gt=>Gt.data.videoUrl===q);if(bt)return bt.id;const C=1,O=400,we=(Gt,Wt=300)=>{if(!Gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Gt))return Wt;const[ts,rs]=Gt.split(":").map(ys=>parseFloat(ys));return!ts||!rs?Wt:Math.round(O*(rs/ts))},Te=document.querySelector(`.react-flow__node[data-id="${l}"]`),Se=Te==null?void 0:Te.getBoundingClientRect(),ye=Math.round(((Se==null?void 0:Se.width)||400)/C),et=100,st=200,kt=we(Ge,300),ht=tt.length,We=Me.position.x+ye+st,Dt=Me.position.y,Xt=We,Pt=Dt+ht*(kt+et),zt=Date.now(),Ct={id:`preview-${l}-${zt}`,type:"videoPreview",position:{x:Xt,y:Pt},data:{videoUrl:q,width:O,ratio:Ge,workflowContext:Me.data.workflowContext,createdBy:Me.data.createdBy}};se(Gt=>[...Gt,Ct]);const Tt={id:`edge-${l}-${Ct.id}`,source:l,target:Ct.id,targetHandle:`${Ct.id}-target`,type:"aurora"};return Q(Gt=>Gt.find(ts=>ts.source===l&&ts.target===Ct.id)?Gt:[...Gt,Tt]),Ct.id},Xs=q=>{const te=q.target;if(te.tagName==="INPUT"||te.tagName==="TEXTAREA"||te.tagName==="SELECT"||te.tagName==="BUTTON"||te.closest("button")||te.closest("input")||te.closest("textarea")||te.closest("select"))return;const Me=!W;fe(Me),se(Ge=>Ge.map(qe=>qe.id===l?{...qe,data:{...qe.data,isExpanded:Me}}:qe))};return e.jsxs("div",{onDoubleClick:Xs,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var O;const q=((O=ce(l))==null?void 0:O.type)||"",te=b(_),Me=te==="æ–‡ç”Ÿè§†é¢‘"||q==="aiVideo_t2v",Ge=q==="aiVideo_i2v_first"||q==="aiVideo_i2v_last"||te==="é¦–å¸§"||te==="å°¾å¸§",qe=q==="aiVideo_first_last"||te==="é¦–å°¾å¸§",Oe=q==="aiVideo_reference"||te==="å‚è€ƒå›¾",tt=Z.filter(we=>we.target===l),bt=tt.some(we=>{const Te=ce(we.source);return(Te==null?void 0:Te.type)==="agent"}),C=tt.reduce((we,Te)=>{var et,st,kt,ht;const Se=ce(Te.source),ye=(Se==null?void 0:Se.type)||"";if(ye==="aiImage"||ye==="imagePreview")return we+1;if(ye==="upload"){const We=(kt=(st=(et=Se==null?void 0:Se.data)==null?void 0:et.config)==null?void 0:st.uploadedFiles)==null?void 0:kt[0],Dt=((We==null?void 0:We.type)||"").toUpperCase(),Xt=((We==null?void 0:We.mimeType)||"").toLowerCase();return we+(Dt==="IMAGE"||Xt.startsWith("image/")?1:0)}if(ye==="assetSelector"){const We=((ht=Se==null?void 0:Se.data)==null?void 0:ht.config)||{};if(We.selectedAsset)return we+((We.selectedAsset.type||"").toUpperCase()==="IMAGE"||(We.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(We.subjects&&We.subjects.length>0)return we+((We.subjects[0].images||[]).length||0)}return we},0);return Me?he||!bt:Ge?!(bt&&C>=1):qe?!(bt&&C>=2):Oe?!(bt&&C>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:g}),w==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{x(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{x(!1),m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{x(!1),await Hs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:ae,onChange:q=>Bs(q),options:vt.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:vt.map(q=>({value:q.id,label:q.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-neutral-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ie,value:ge,onChange:vs,onKeyDown:Es,onCompositionStart:()=>{me.current=!0},onCompositionEnd:q=>{me.current=!1,vs(q)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),$&&u.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:u.map((q,te)=>e.jsxs("button",{type:"button",onMouseDown:Me=>{Me.preventDefault(),Me.stopPropagation(),Ss(q)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${te===G?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[q.avatarUrl?e.jsx("img",{src:q.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:q.customName}),e.jsx("div",{className:"text-[10px] text-neutral-500 dark:text-neutral-400 font-mono truncate",children:q.characterName})]})]},q.id))})]})]}),v.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",_==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:v.map((q,te)=>e.jsxs("div",{draggable:_==="é¦–å°¾å¸§",onDragStart:()=>yt(te),onDragOver:Be,onDrop:()=>wt(te),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${_==="é¦–å°¾å¸§"?"cursor-move":""} ${r===te?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50`,children:[e.jsx("img",{src:`${q.url.startsWith("http")||q.url.startsWith("data:")?q.url:yr+q.url}`,alt:q.name,className:"w-full h-full object-cover"}),_==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:te===0?"é¦–":te===1?"å°¾":te+1})]},q.id))})]}),h&&!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",ie?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[P,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:$e,max:Ae,step:"1",value:P,onChange:q=>{const te=parseInt(q.target.value,10);E(te),Qe({duration:te})},disabled:ie,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-neutral-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-neutral-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #525252 ${Ue}%, #3b0764 ${Ue}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),h&&ct&&(he||(((Ps=h==null?void 0:h.config.supportedRatios)==null?void 0:Ps.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),he?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q="landscape",te=P===15?15:10,Me=`sora-video-${q}-${te}s`,Ge=be.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||be[0],qe=(Ge==null?void 0:Ge.id)||"";ee(qe),R("16:9"),Qe({modelId:qe,ratio:"16:9",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Landscape ${te}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${U==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const q="portrait",te=P===15?15:10,Me=`sora-video-${q}-${te}s`,Ge=be.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||be[0],qe=(Ge==null?void 0:Ge.id)||"";ee(qe),R("9:16"),Qe({modelId:qe,ratio:"9:16",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Portrait ${te}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${U==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:U,onChange:q=>{R(q),Qe({ratio:q})},options:((h==null?void 0:h.config.supportedRatios)||[]).map(q=>{const[te,Me]=q.split(":");return{value:q,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[q]||`${te}:${Me}`}})})]}),h&&he&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q=U==="9:16"?"portrait":"landscape",te=`sora-video-${q}-10s`,Me=be.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===te})||be[0],Ge=(Me==null?void 0:Me.id)||"";E(10),ee(Ge),Qe({duration:10,modelId:Ge,modelName:(Me==null?void 0:Me.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${P===10?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const q=U==="9:16"?"portrait":"landscape",te=`sora-video-${q}-15s`,Me=be.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===te})||be[0],Ge=(Me==null?void 0:Me.id)||"";E(15),ee(Ge),Qe({duration:15,modelId:Ge,modelName:(Me==null?void 0:Me.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${P===15?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),h&&he&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>k(!oe),className:`nodrag relative w-10 h-5 rounded-full transition-all ${oe?"bg-gradient-to-r from-neutral-800 to-neutral-700":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${oe?"left-5":"left-0.5"}`})})]}),h&&!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ve?"(æœªé…ç½®)":""]}),e.jsx(os,{value:D,onChange:q=>{p(q),Qe({resolution:q})},options:Ne.map(q=>({value:q,label:q})),className:Ve?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:V||!ps||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${V||!ps?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:V?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!y&&(J?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ue),"æ¬¡"]}):S!==null&&S>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[S,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:ge?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:ge})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},_o=t.memo(Ao),Wr="https://api.waule.ai",To=({data:s,selected:j,id:l})=>{var E,V;const[W,fe]=t.useState(!0),[T,pe]=t.useState(s.config.customName||""),[Y,se]=t.useState(!1),[Q,ce]=t.useState(0),[Re,de]=t.useState(s.config.taskId||""),[Z,re]=t.useState(null),{credits:je,loading:le}=Is({nodeType:"sora_character"}),{setNodes:be,getNode:ge,setEdges:xe}=Qt(),Ie=zs(),ae=Ls(),ee=t.useCallback(a=>{var r;if(!a)return!1;const v=a.type||"",c=((r=a.data)==null?void 0:r.config)||{};if(v==="upload")return(c.uploadedFiles||c.files||[]).some(d=>(d.mimeType||d.type||"").toLowerCase().startsWith("video/"));if(v==="videoPreview")return!!c.url;if(v==="assetSelector"){const f=c.selectedAsset;return((f==null?void 0:f.mimeType)||"").toLowerCase().startsWith("video/")&&!!(f!=null&&f.url)}return v.startsWith("aiVideo")||v==="soraVideo"?!!c.generatedVideoUrl:!1},[]);t.useEffect(()=>{const a=Ie.filter(r=>r.target===l);if(a.length===0)return;const v=[],c=[];for(const r of a){const f=ae.find(d=>d.id===r.source)||ge(r.source);ee(f)?v.push(r.id):c.push(r.id)}v.length>1&&(c.push(...v.slice(1)),m.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),c.length>0&&(xe(r=>r.filter(f=>!c.includes(f.id))),c.length>0&&v.length<=1&&a.some(f=>{const d=ae.find(x=>x.id===f.source)||ge(f.source);return!ee(d)})&&m.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ie,l,ae,ge,xe,ee]);const U=t.useMemo(()=>Ie.filter(v=>v.target===l).map(v=>{var r;const c=ae.find(f=>f.id===v.source);return(r=c==null?void 0:c.data)==null?void 0:r.config}),[Ie,l,ae]),R=t.useMemo(()=>(s.models||[]).filter(v=>{var c;return v.type==="VIDEO_GENERATION"&&((c=v.provider)==null?void 0:c.toLowerCase())==="sora"}),[s.models]),D=((E=R.find(a=>{var v;return(v=a.modelId)==null?void 0:v.includes("landscape-10s")}))==null?void 0:E.id)||((V=R[0])==null?void 0:V.id)||"",p=t.useCallback(a=>{be(v=>v.map(c=>c.id===l?{...c,data:{...c.data,config:{...c.data.config,...a}}}:c))},[l,be]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!Y&&(re({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),pe(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,Y]);const b=t.useMemo(()=>{var v;const a=Ie.filter(c=>c.target===l);for(const c of a){const r=ae.find(x=>x.id===c.source)||ge(c.source);if(!r)continue;const f=r.type||"",d=((v=r.data)==null?void 0:v.config)||{};if(f==="upload"){const g=(d.uploadedFiles||d.files||[]).find(w=>(w.mimeType||w.type||"").toLowerCase().startsWith("video/"));if(g!=null&&g.url)return{url:g.url,thumbnail:g.thumbnail||g.url,name:g.name||g.originalName||"è§†é¢‘"}}if(f==="videoPreview"&&d.url)return{url:d.url,thumbnail:d.thumbnail||d.url,name:d.name||"è§†é¢‘"};if(f==="assetSelector"){const x=d.selectedAsset;if(((x==null?void 0:x.mimeType)||"").toLowerCase().startsWith("video/")&&(x!=null&&x.url))return{url:x.url,thumbnail:x.thumbnail||x.url,name:x.name||"è§†é¢‘"}}if((f.startsWith("aiVideo")||f==="soraVideo")&&d.generatedVideoUrl)return{url:d.generatedVideoUrl,thumbnail:d.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ie,l,ae,U,ge]),_=!!b,z=async a=>{let c=0;const r=async()=>{try{c++;const d=(await Ce.tasks.getTaskStatus(a)).task;if(ce(d.progress||0),d.status==="SUCCESS"||d.status==="COMPLETED"||d.status==="DONE"){se(!1),ce(100);const x=d.metadata||{},g=x.characterName||"",w=x.avatarUrl||d.resultUrl||"";if(!g){m.error("æœªèƒ½è·å–è§’è‰²åç§°"),p({taskId:""}),de("");return}try{const $=(await Ce.soraCharacters.create({customName:T||g,characterName:g,avatarUrl:w,sourceVideoUrl:(b==null?void 0:b.url)||void 0})).character;re({id:$.id,customName:$.customName,characterName:$.characterName,avatarUrl:$.avatarUrl}),p({customName:$.customName,characterName:$.characterName,avatarUrl:$.avatarUrl,taskId:""}),m.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${$.customName}`)}catch(A){re({id:"",customName:T||g,characterName:g,avatarUrl:w}),m.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${A.message}`)}de(""),setTimeout(()=>ce(0),1e3);return}else if(d.status==="FAILURE"){se(!1),ce(0),p({taskId:""}),m.error(d.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(d.status==="PROCESSING"||d.status==="PENDING")&&(c<600?setTimeout(r,1e3):(se(!1),ce(0),p({taskId:""}),m.error("åˆ›å»ºè¶…æ—¶")))}catch{se(!1),ce(0),p({taskId:""}),m.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};r()},P=async()=>{var v,c,r,f,d;if(!b){m.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!T.trim()){m.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!D){m.error("Soraæ¨¡å‹æœªé…ç½®");return}const a=b.url;if(!a){m.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const x=await Ce.soraCharacters.getByCustomName(T.trim());if(x!=null&&x.character){m.error(`è‡ªå®šä¹‰åç§°"${T.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}se(!0),ce(5),re(null);try{const x=await Ce.tasks.createVideoTask({modelId:D,prompt:"",ratio:"16:9",referenceImages:[a],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:l,metadata:{isCharacterCreation:!0,customName:T.trim(),referenceType:"video",nodeType:"sora_character"}}),g=x.taskId,w=x.creditsCharged||0;if(de(g),p({customName:T.trim(),taskId:g}),w>0)try{const{useAuthStore:A}=await ds(async()=>{const{useAuthStore:N}=await import("./index-B7LKGTE9.js").then(u=>u.f);return{useAuthStore:N}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:$}=A.getState();await $(),m.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${w} ç§¯åˆ†ï¼‰`)}catch{m.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else m.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");z(g)}catch(x){if(se(!1),ce(0),((v=x.response)==null?void 0:v.status)===403){const g=((r=(c=x.response)==null?void 0:c.data)==null?void 0:r.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";m.error(g)}else m.error(`æäº¤å¤±è´¥: ${((d=(f=x.response)==null?void 0:f.data)==null?void 0:d.error)||x.message}`)}};return t.useEffect(()=>{Re&&!Y&&(se(!0),z(Re))},[]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl rounded-t-2xl",onClick:()=>fe(!W),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${W?"rotate-180":""}`,children:"expand_more"})]})]}),W&&e.jsxs("div",{className:"p-4 space-y-3",children:[b&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${b.url.startsWith("http")||b.url.startsWith("data:")?b.url:Wr+b.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:b.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:T,onChange:a=>pe(a.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",disabled:Y})]}),Z&&!Y&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[Z.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("img",{src:Z.avatarUrl.startsWith("http")?Z.avatarUrl:`${Wr}${Z.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:a=>{a.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:Z.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:Z.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),Y&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[Q,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all duration-300",style:{width:`${Q}%`}})})]}),e.jsx("button",{onClick:P,disabled:Y||!_||!T.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${Y||!_||!T.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95"}`,children:Y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!le&&je!==null&&je>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[je,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},Uo=t.memo(To),Ro=({data:s,id:j,selected:l})=>{const{setNodes:W,getNode:fe}=Qt(),[T,pe]=t.useState(s.config.modelId||""),[Y,se]=t.useState(s.config.voiceId||""),[Q,ce]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Re,de]=t.useState(s.config.status||""),[Z,re]=t.useState(!1),[je,le]=t.useState([]),[be]=t.useState(void 0),[ge]=t.useState("mp3"),[xe]=t.useState(void 0),[Ie]=t.useState(void 0),[ae]=t.useState(void 0),[ee]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!T&&pe(s.config.modelId)},[s.config.modelId,T]),t.useEffect(()=>{!Y&&s.config.voiceId&&se(String(s.config.voiceId))},[s.config.voiceId,Y]),t.useEffect(()=>{if(!T){const b=(s.models||[]).filter(_=>_.type==="AUDIO_SYNTHESIS"&&_.isActive)[0];b&&(pe(b.id),R({modelId:b.id}))}},[s.models,T]),t.useEffect(()=>{U()},[]);const U=async()=>{try{const p=await Ce.get("/ai/audio/voices"),b=(p==null?void 0:p.data)??p;le(Array.isArray(b)?b:[])}catch{}},R=p=>{fe(j)&&W(_=>_.map(z=>z.id===j?{...z,data:{...z.data,config:{...z.data.config,...p}}}:z))},D=async()=>{var z,P,E,V;const p=(Y||s.config.voiceId||"").trim(),b=(Q||"").trim();if(!p||!b){m.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let _=T;if(!_){const a=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive);if(a[0])_=a[0].id,pe(_),R({modelId:_});else{m.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}re(!0);try{if(Re!=="OK"){let r=0,f=!1;for(;r<12;){r++;try{const d=await Ce.ai.audio.queryVoice({voiceId:p,modelId:_}),x=((z=d.data)==null?void 0:z.status)||d.status;if(de(x),R({status:x}),x==="OK"){f=!0;break}if(x==="UNDEPLOYED")break}catch{}await new Promise(d=>setTimeout(d,2500))}if(!f){m.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),re(!1);return}}const a=await Ce.ai.audio.synthesize({modelId:_,voiceId:p,text:b,format:ge,sampleRate:be,volume:Ie,rate:xe,pitch:ae,output_format:ee}),v=((P=a.data)==null?void 0:P.url)||a.url;try{const c=v&&v.startsWith("http")?v:`https://api.waule.ai${v}`;let r;c?r=await Ce.assets.proxyDownload(c):r=await(await fetch(v,{mode:"cors"})).arrayBuffer();const f=URL.createObjectURL(new Blob([r],{type:ge==="wav"?"audio/wav":"audio/mpeg"}));R({outputUrl:f})}catch{R({outputUrl:v})}m.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(a){const v=((V=(E=a==null?void 0:a.response)==null?void 0:E.data)==null?void 0:V.message)||(a==null?void 0:a.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(v)?m.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(v)?m.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):m.error(v)}re(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:T,onChange:p=>{pe(p),R({modelId:p})},options:(s.models||[]).filter(p=>p.type==="AUDIO_SYNTHESIS"&&p.isActive).map(p=>({value:p.id,label:p.name}))})]}),je.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",je.length,")"]}),e.jsx(os,{value:Y||"",onChange:p=>{se(p),R({voiceId:p})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...je.map(p=>({value:p.voiceId,label:p.prefix||p.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:Y,onChange:p=>{const b=p.target.value;se(b),R({voiceId:b})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:Q,onChange:p=>{ce(p.target.value),R({text:p.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:D,disabled:Z||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Z?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Z?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},$o=t.memo(Ro),Mo=({data:s,id:j,selected:l})=>{const{setNodes:W,setEdges:fe,getNode:T}=Qt(),[pe,Y]=t.useState(s.config.modelId||""),[se,Q]=t.useState(s.config.voiceId||""),[ce,Re]=t.useState(s.config.voiceName||""),[de,Z]=t.useState(s.config.cloneAudioUrl||""),[re,je]=t.useState(s.config.promptAudioUrl||""),[le,be]=t.useState(s.config.promptText||""),[ge,xe]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ie,ae]=t.useState(!1);t.useEffect(()=>{const _=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!se||!se.startsWith("Waule")&&!se.startsWith("Aivider")||se.startsWith("minimax-")){const z=_();Q(z),D({voiceId:z})}},[se]);const ee=Fs(_=>_.edges.filter(z=>z.target===j)),U=Ls(),R=t.useRef("");t.useEffect(()=>{if(!pe){const z=(s.models||[]).filter(P=>{if(P.type!=="AUDIO_SYNTHESIS"||!P.isActive)return!1;const E=String(P.provider||"").toLowerCase();return E.includes("minimaxi")||E.includes("hailuo")||E.includes("æµ·èº")})[0];z&&(Y(z.id),D({modelId:z.id}))}},[s.models,pe]),t.useEffect(()=>{try{const _=ee.map(E=>`${E.id}-${E.source}-${E.targetHandle||""}`).sort().join(",");if(_===R.current)return;R.current=_;let z="",P="";for(const E of ee){const V=T(E.source);if(!V)continue;const a=V.data||{},v=String(V.type||"").toLowerCase(),r=(()=>{var f,d;if(v==="upload"){const x=(((f=a.config)==null?void 0:f.uploadedFiles)||[]).find(g=>{const w=((g==null?void 0:g.type)||"").toUpperCase(),A=((g==null?void 0:g.mimeType)||"").toLowerCase();return w==="AUDIO"||A.startsWith("audio/")});return x==null?void 0:x.url}if(v==="assetSelector"){const x=(d=a.config)==null?void 0:d.selectedAsset,g=((x==null?void 0:x.type)||"").toUpperCase(),w=((x==null?void 0:x.mimeType)||"").toLowerCase();if(g==="AUDIO"||w.startsWith("audio/"))return x==null?void 0:x.url}return null})();r&&(E.targetHandle===`${j}-target-clone`&&(z=r),E.targetHandle===`${j}-target-prompt`&&(P=r))}z!==de&&(Z(z),D({cloneAudioUrl:z})),P!==re&&(je(P),D({promptAudioUrl:P}))}catch{}},[ee,U,T,j,de,re]);const D=_=>{W(z=>z.map(P=>P.id===j?{...P,data:{...P.data,config:{...P.data.config,..._}}}:P))},p=async()=>{var _,z;if(!se||!ce){m.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await Ce.ai.audio.voices.add({voiceId:se,prefix:ce}),m.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(P){const E=((z=(_=P==null?void 0:P.response)==null?void 0:_.data)==null?void 0:z.message)||(P==null?void 0:P.message)||"ä¿å­˜å¤±è´¥";m.error(E)}},b=async()=>{var _,z,P;if(!pe||!ce||!de){m.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}ae(!0),m.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const V=(s.models||[]).find(x=>x.id===pe),a=(V==null?void 0:V.modelId)||"speech-2.6-hd";let v=de;v.startsWith("http");const c=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;Q(c),D({voiceId:c});const r=await Ce.ai.audio.createVoice({modelId:pe,targetModel:a,prefix:ce,url:v,promptUrl:re||void 0,promptText:le||void 0,voiceId:c,previewText:ge||void 0}),f=(r==null?void 0:r.data)||r,d=f==null?void 0:f.sampleUrl;if(d){D({sampleUrl:d,status:"OK",voiceName:ce}),m.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const x=T(j);if(x){const g=`audioPreview-${Date.now()}`,w={id:g,type:"audioPreview",position:{x:x.position.x+450,y:x.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:d,config:{audioUrl:d,title:`${ce} - è¯•å¬`},models:s.models,createdBy:(_=x.data)==null?void 0:_.createdBy}};W($=>[...$,w]);const A={id:`e-${j}-source-${g}-target`,source:j,sourceHandle:`${j}-source`,target:g,targetHandle:`${g}-target`,type:"aurora"};fe($=>[...$,A])}}else D({status:"OK",voiceName:ce}),m.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(E){const V=((P=(z=E==null?void 0:E.response)==null?void 0:z.data)==null?void 0:P.message)||(E==null?void 0:E.message)||"åˆ›å»ºå¤±è´¥";m.error(V)}ae(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:pe,onChange:_=>{Y(_),D({modelId:_})},options:(s.models||[]).filter(_=>{if(_.type!=="AUDIO_SYNTHESIS"||!_.isActive)return!1;if(Array.isArray(_.capabilities))return _.capabilities.some(P=>P.capability==="éŸ³è‰²å…‹éš†"&&P.supported);const z=String(_.provider||"").toLowerCase();return z.includes("minimaxi")||z.includes("hailuo")||z.includes("æµ·èº")}).map(_=>({value:_.id,label:_.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:ce,onChange:_=>{Re(_.target.value),D({voiceName:_.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:_=>_.stopPropagation()}),e.jsx("button",{onClick:p,disabled:!se||!ce,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!se||!ce?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:de?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:de?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:re?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:re?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:le,onChange:_=>{be(_.target.value),D({promptText:_.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:ge,onChange:_=>{xe(_.target.value),D({previewText:_.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsx("button",{onClick:b,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Do=t.memo(Mo),Fr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Lo=({data:s,id:j,selected:l})=>{const{setNodes:W,getNode:fe,setEdges:T}=Qt(),[pe,Y]=t.useState(s.config.modelId||""),[se,Q]=t.useState(s.config.voiceId||""),[ce,Re]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),de=t.useRef(null),[Z,re]=t.useState("zh"),je=t.useRef(null),le=t.useRef(null),be=t.useRef(null),ge=t.useRef(null),xe=t.useRef(null),[Ie,ae]=t.useState([]),ee=async()=>{try{const c=await Ce.ai.audio.voices.list(),r=(c==null?void 0:c.data)??c;ae(Array.isArray(r)?r:[])}catch{}},U=async()=>{try{const c=window.AudioContext||window.webkitAudioContext;ge.current||(ge.current=new c);const r=ge.current;r.state==="suspended"&&await r.resume()}catch{}},[R,D]=t.useState(!1),[p]=t.useState(""),[b]=t.useState(void 0),[_]=t.useState("mp3"),[z]=t.useState(void 0),[P]=t.useState(void 0),[E]=t.useState(void 0),[V]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!pe&&Y(s.config.modelId)},[s.config.modelId,pe]),t.useEffect(()=>{!se&&s.config.voiceId&&Q(String(s.config.voiceId))},[s.config.voiceId,se]),t.useEffect(()=>{if(!pe){const r=(s.models||[]).filter(f=>f.type==="AUDIO_SYNTHESIS"&&f.isActive)[0];r&&(Y(r.id),a({modelId:r.id}))}},[s.models,pe]),t.useEffect(()=>{ee()},[]),t.useEffect(()=>{Z==="custom"&&ee()},[Z]),t.useEffect(()=>{const c=de.current;c&&(c.style.height="auto",c.style.height=`${c.scrollHeight}px`)},[ce]);const a=c=>{fe(j)&&W(f=>f.map(d=>d.id===j?{...d,data:{...d.data,config:{...d.data.config,...c}}}:d))},v=async(c=!1)=>{var x,g,w,A,$;let r=(se||s.config.voiceId||"").trim();if(c&&!r)if(Z==="custom"){const N=Ie[0];N&&(r=String(N.voiceId),Q(r),a({voiceId:r}))}else{const N=Fr.find(u=>{const i=u.label;return Z==="zh"?i.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):Z==="yue"?i.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):Z==="en"?i.startsWith("è‹±æ–‡ "):Z==="ja"?i.startsWith("æ—¥æ–‡ "):Z==="ko"?i.startsWith("éŸ©æ–‡ "):!0});N&&(r=N.id,Q(r),a({voiceId:r}))}const f=c?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(ce||"").trim();if(!r||!f){m.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let d=pe;if(!d){const N=(s.models||[]).filter(u=>u.type==="AUDIO_SYNTHESIS"&&u.isActive);if(N[0])d=N[0].id,Y(d),a({modelId:d});else{m.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}D(!0);try{c&&await U();const N={};if(p)try{N.voice_modify={emotion:p}}catch{}const u=await Ce.ai.audio.synthesize({modelId:d,voiceId:r,text:f,format:_,sampleRate:b,volume:P,rate:z,pitch:E,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...N}),i=((x=u==null?void 0:u.data)==null?void 0:x.url)||(u==null?void 0:u.url),n=window.location.origin,M=(y=>{if(!y)return"";try{if(y.startsWith("http://localhost:3000")||y.startsWith("http://127.0.0.1:3000")){const J=new URL(y).pathname;return`${n}${J}`}return y.startsWith("http")?y:y.startsWith("/")?`${n}${y}`:`${n}/${y}`}catch{return y}})(i);let B;const G=y=>{if(y.length>=12){if(y[0]===82&&y[1]===73&&y[2]===70&&y[3]===70&&y[8]===87&&y[9]===65&&y[10]===86&&y[11]===69)return"audio/wav";if(y[0]===73&&y[1]===68&&y[2]===51||y[0]===255&&(y[1]&224)===224)return"audio/mpeg"}return _==="wav"?"audio/wav":"audio/mpeg"},ne=y=>y.length>=12&&y[4]===102&&y[5]===116&&y[6]===121&&y[7]===112,me=y=>y.length>=4&&y[0]===79&&y[1]===103&&y[2]===103&&y[3]===83,oe=y=>y.length>=4&&y[0]===102&&y[1]===76&&y[2]===97&&y[3]===67,k=new Uint8Array(B||new ArrayBuffer(0));let h=G(k);(!h||h==="application/octet-stream")&&(ne(k)?h="audio/mp4":me(k)?h="audio/ogg":oe(k)&&(h="audio/flac"));let S;if(c){if(xe.current){try{xe.current.stop()}catch{}xe.current.disconnect(),xe.current=null}const y=le.current||new Audio;y.preload="auto",y.autoplay=!0,y.playsInline=!0,y.crossOrigin="anonymous",le.current=y;let J=!1;const ue=(H,he,Ee=1500)=>new Promise(Ne=>{let $e=!1;const Ae=()=>{$e||($e=!0,Ue(),Ne(!0))},_e=()=>{$e||($e=!0,Ue(),Ne(!1))},Ue=()=>{H.removeEventListener(he,Ae),H.removeEventListener("error",_e)};H.addEventListener(he,Ae),H.addEventListener("error",_e),setTimeout(()=>{_e()},Ee)});try{const H=Ne=>{const $e=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor($e.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt($e.substr(_e*2,2),16);return Ae},he=((g=u==null?void 0:u.data)==null?void 0:g.hex)||(u==null?void 0:u.hex),Ee=he?H(String(he)).buffer:void 0;if(Ee&&Ee.byteLength>0){const Ne=new Uint8Array(Ee),$e=G(Ne),Ae=new Blob([Ee],{type:$e}),_e=URL.createObjectURL(Ae);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}if(be.current=_e,y.src=_e,y.load(),!await ue(y,"canplay"))throw new Error("blob not ready");await y.play(),J=!0}else throw new Error("no hex")}catch{J=!1}if(!J){try{const H=Ne=>{const $e=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor($e.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt($e.substr(_e*2,2),16);return Ae},he=((w=u==null?void 0:u.data)==null?void 0:w.hex)||(u==null?void 0:u.hex),Ee=he?H(String(he)).buffer:void 0;if(!Ee||Ee.byteLength===0){const Ne=await Ce.assets.proxyDownload(M);if(!Ne||Ne.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const $e=new Uint8Array(Ne),Ae=G($e),_e=new Blob([Ne],{type:Ae}),Ue=URL.createObjectURL(_e);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}if(be.current=Ue,y.src=Ue,y.load(),!await ue(y,"canplay"))throw new Error("blob not ready");await y.play(),J=!0}else{const Ne=new Uint8Array(Ee),$e=G(Ne),Ae=new Blob([Ee],{type:$e}),_e=URL.createObjectURL(Ae);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}if(be.current=_e,y.src=_e,y.load(),!await ue(y,"canplay"))throw new Error("blob not ready");await y.play(),J=!0}}catch{}if(!J)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const y=await Ce.assets.proxyDownload(M),J=new Uint8Array(y),ue=G(J);S=URL.createObjectURL(new Blob([y],{type:ue}))}catch{}if(!c&&S){if(je.current)try{URL.revokeObjectURL(je.current)}catch{}je.current=S;const y=M||S;a({outputUrl:y});try{const J=fe(j);if(J){const H=document.querySelector(`.react-flow__node[data-id="${J.id}"]`),he=Math.round((H==null?void 0:H.getBoundingClientRect().width)||420),Ee=J.position.x+he+160,Ne=`audio-preview-${Date.now()}`;W($e=>{var ie;const Ae=$e.filter(Ve=>{var Qe;return Ve.type==="audioPreview"&&((Qe=Ve.data)==null?void 0:Qe.sourceNodeId)===j}),_e=J.position.y,Ue=Ae.length>0?Math.max(...Ae.map(Ve=>{var Qe;return((Qe=Ve.position)==null?void 0:Qe.y)||_e}))+120:_e;return[...$e,{id:Ne,type:"audioPreview",position:{x:Ee,y:Ue},data:{audioUrl:y,sourceNodeId:j,createdBy:(ie=J.data)==null?void 0:ie.createdBy}}]}),T($e=>[...$e,{id:`${j}-${Ne}`,source:j,target:Ne}])}}catch{}}c&&le.current&&!le.current.paused?m.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!c&&S&&m.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(N){const u=(($=(A=N==null?void 0:N.response)==null?void 0:A.data)==null?void 0:$.message)||(N==null?void 0:N.message)||(c?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");m.error(u)}D(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:pe,onChange:c=>{Y(c),a({modelId:c})},options:(s.models||[]).filter(c=>c.type==="AUDIO_SYNTHESIS"&&c.isActive).map(c=>({value:c.id,label:c.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(os,{value:Z,onChange:c=>{re(c),c==="custom"&&ee()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(os,{value:se,onChange:c=>{Q(c),a({voiceId:c})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Z==="custom"?Ie.map(c=>({value:c.voiceId,label:c.prefix||c.voiceId})):Fr.filter(c=>{const r=c.label;return Z==="zh"?r.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):Z==="yue"?r.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):Z==="en"?r.startsWith("è‹±æ–‡ "):Z==="ja"?r.startsWith("æ—¥æ–‡ "):Z==="ko"?r.startsWith("éŸ©æ–‡ "):!0}).map(c=>({value:c.id,label:c.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>v(!0),disabled:R,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${R?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":""}`,style:R?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:de,value:ce,onChange:c=>{Re(c.target.value),a({text:c.target.value})},onMouseDown:c=>c.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>v(!1),disabled:R||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${R||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"border-transparent dark:border-white/10"}`,style:R||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:R?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:le,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Po=t.memo(Lo),Oo=t.memo(({id:s,sourceX:j,sourceY:l,targetX:W,targetY:fe,sourcePosition:T,targetPosition:pe,selected:Y,markerEnd:se})=>{const[Q]=ka({sourceX:j,sourceY:l,targetX:W,targetY:fe,sourcePosition:T,targetPosition:pe});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#404040",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#525252",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:Q,fill:"none",stroke:Y?"#525252":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:se}),e.jsx("path",{d:Q,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:se}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:Q,calcMode:"linear"})}),e.jsx("path",{d:Q,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Go=({data:s,id:j})=>{const l=t.useRef(null),{getNode:W,setNodes:fe}=Qt(),[T,pe]=t.useState(!1),[Y,se]=t.useState([]),[Q,ce]=t.useState(""),[Re,de]=t.useState("ALL"),[Z,re]=t.useState(""),[je,le]=t.useState(!1),be=t.useMemo(()=>window.location.origin,[]),ge=t.useMemo(()=>{var R;const U=s.audioUrl||"";if(U.startsWith("blob:")){const D=s.sourceNodeId?W(s.sourceNodeId):null,p=((R=D==null?void 0:D.data)==null?void 0:R.outputUrl)||"";return p.startsWith("http")?p:p.startsWith("/")?`${be}${p}`:U}return U.startsWith("http")?`${be}/api/assets/proxy-stream?url=${encodeURIComponent(U)}`:U.startsWith("/")?`${be}${U}`:U},[s.audioUrl,s.sourceNodeId,be]);t.useEffect(()=>{const U=l.current;U&&(U.preload="auto",U.playsInline=!0,U.crossOrigin="anonymous",U.load())},[ge]),t.useEffect(()=>{T&&(xe(),setTimeout(()=>{Ie()},100))},[T]);const xe=async()=>{try{const U=Re==="ALL"?void 0:{category:Re},D=(await Ce.assetLibraries.getAll(U)).data||[];se(D);const p=Re==="ALL"?D:D.filter(b=>(b.category||"OTHER")===Re);if(p.length>0){const b=p.find(_=>_.id===Q);ce(b?b.id:p[0].id)}else ce("")}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ie=()=>{const U=window.__workflowContext;if(!U||!U.project||!U.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const R=Ws(j,U.nodeGroups);if(!R&&U.nodeGroups.length>0){const p=U.nodeGroups[0],b=Ts({project:U.project,episode:U.episode,nodeGroup:p,assetType:"audio"});b?(re(b),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${b}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const D=Ts({project:U.project,episode:U.episode,nodeGroup:R,assetType:"audio"});D?(re(D),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${D}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},ae=async()=>{var U,R;if(!Q){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Z.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{le(!0),await Ce.assetLibraries.addFromUrl(Q,s.audioUrl,Z.trim());const D=window.__workflowContext;if(D&&D.project&&D.nodeGroups){const p=Ws(j,D.nodeGroups)||D.nodeGroups[0];p&&Ts({project:D.project,episode:D.episode,nodeGroup:p,nodeId:j,assetType:"audio",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),pe(!1),re("");try{fe(p=>p.map(b=>b.id===j?{...b,data:{...b.data,addedToLibrary:!0}}:b))}catch{}try{const p=new CustomEvent("asset-library-updated",{detail:{libraryId:Q}});window.dispatchEvent(p)}catch{}}catch(D){m.error(((R=(U=D.response)==null?void 0:U.data)==null?void 0:R.message)||"æ·»åŠ å¤±è´¥")}finally{le(!1)}},ee=async()=>{var D;let U=`audio-${Date.now()}.mp3`;const R=window.__workflowContext;if(R&&R.project&&R.nodeGroups){const p=Ws(j,R.nodeGroups)||R.nodeGroups[0];if(p){const b=Ts({project:R.project,episode:R.episode,nodeGroup:p,assetType:"audio",preview:!0});if(b&&(U=b,!U.includes("."))){const _=((D=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:D[0])||".mp3";U+=_}}}try{m.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const p=await fetch(s.audioUrl);if(!p.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${p.status}`);const b=await p.blob(),_=window.URL.createObjectURL(b),z=document.createElement("a");z.href=_,z.download=U,document.body.appendChild(z),z.click(),document.body.removeChild(z),setTimeout(()=>{window.URL.revokeObjectURL(_)},100),m.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${U}`)}catch(p){m.error(`ä¸‹è½½å¤±è´¥: ${p instanceof Error?p.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:l,controls:!0,src:ge,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{pe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:ee,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),T&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:U=>U.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>pe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Z,onChange:U=>re(U.target.value),onMouseDown:U=>U.stopPropagation(),onTouchStart:U=>U.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const U=Re==="ALL"?Y:Y.filter(R=>(R.category||"OTHER")===Re);return U.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Re==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Q,onChange:R=>ce(R.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:U.map(R=>e.jsxs("option",{value:R.id,children:[R.name," (",R._count.assets," ä¸ªèµ„äº§)"]},R.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(U=>e.jsx("button",{type:"button",onClick:()=>{de(U);const R=Y.filter(D=>(D.category||"OTHER")===U);ce(R.length>0?R[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Re===U?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:U==="ROLE"?"person":U==="SCENE"?"landscape":U==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:U==="ROLE"?"è§’è‰²åº“":U==="SCENE"?"åœºæ™¯åº“":U==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},U))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>pe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:ae,disabled:je||Y.length===0||!Z.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:je?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Vo=t.memo(Go),Wo=({data:s,id:j,selected:l})=>{const{setNodes:W,getNode:fe,setEdges:T}=Qt(),[pe,Y]=t.useState(s.config.modelId||""),[se,Q]=t.useState(s.config.prompt||""),[ce,Re]=t.useState(s.config.previewText||""),[de,Z]=t.useState(s.config.voiceId||""),[re,je]=t.useState(!1),le=t.useRef(null),be=t.useRef(null),ge=t.useRef(null),xe=t.useRef(null),[Ie,ae]=t.useState([]);t.useEffect(()=>{if(!pe){const _=(s.models||[]).filter(z=>z.type==="AUDIO_SYNTHESIS"&&z.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(z.provider||"").toLowerCase())&&(Array.isArray(z.capabilities)?z.capabilities.some(P=>P.capability==="éŸ³è‰²è®¾è®¡"&&P.supported):!0))[0];_&&(Y(_.id),ee({modelId:_.id}))}},[s.models,pe]);const ee=b=>{fe(j)&&W(z=>z.map(P=>P.id===j?{...P,data:{...P.data,config:{...P.data.config,...b}}}:P))};t.useEffect(()=>{(async()=>{try{const b=await Ce.ai.audio.voices.list(),_=(b==null?void 0:b.data)??b;ae(Array.isArray(_)?_:[])}catch{}})()},[]);const U=b=>{b&&(b.style.height="auto",b.style.height=`${b.scrollHeight}px`)};t.useEffect(()=>{U(be.current)},[se]),t.useEffect(()=>{U(ge.current)},[ce]);const R=async b=>{if(!b)return!1;try{const _=(b||"").replace(/\s+/g,""),z=new Uint8Array(Math.floor(_.length/2));for(let v=0;v<z.length;v++)z[v]=parseInt(_.substr(v*2,2),16);const P=(()=>{const v=z;return v.length>=12&&v[0]===82&&v[1]===73&&v[2]===70&&v[3]===70&&v[8]===87&&v[9]===65&&v[10]===86&&v[11]===69?"audio/wav":(v.length>=3&&v[0]===73&&v[1]===68&&v[2]===51||v.length>=2&&v[0]===255&&(v[1]&224)===224,"audio/mpeg")})(),E=new Blob([z.buffer],{type:P}),V=URL.createObjectURL(E);if(xe.current)try{URL.revokeObjectURL(xe.current)}catch{}xe.current=V;const a=le.current||new Audio;return a.preload="auto",a.autoplay=!0,a.playsInline=!0,a.crossOrigin="anonymous",a.src=V,le.current=a,await a.play(),!0}catch{return!1}},D=async()=>{var _,z,P,E,V;if(!se.trim()){m.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let b=pe;if(!b){const a=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(v.provider||"").toLowerCase()));if(a[0])b=a[0].id,Y(b),ee({modelId:b});else{m.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}je(!0);try{const a=await Ce.ai.audio.design({modelId:b,prompt:se,preview_text:ce,voice_id:de||void 0,aigc_watermark:!1}),v=((_=a==null?void 0:a.data)==null?void 0:_.voice_id)||(a==null?void 0:a.voice_id),c=((z=a==null?void 0:a.data)==null?void 0:z.trial_audio)||(a==null?void 0:a.trial_audio)||((P=a==null?void 0:a.data)==null?void 0:P.hex)||(a==null?void 0:a.hex);v&&(Z(String(v)),ee({voiceId:String(v)})),c&&typeof c=="string"?(ee({trialHex:c}),await R(c),m.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):m.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const r=fe(j);if(r){const d=document.querySelector(`.react-flow__node[data-id="${r.id}"]`),x=Math.round((d==null?void 0:d.getBoundingClientRect().width)||420),g=r.position.x+x+160,w=`audio-preview-${Date.now()}`;W(A=>{var $;return[...A,{id:w,type:"audioPreview",position:{x:g,y:r.position.y},data:{audioUrl:xe.current||"",sourceNodeId:j,createdBy:($=r.data)==null?void 0:$.createdBy}}]}),T(A=>[...A,{id:`${j}-${w}`,source:j,target:w}])}}catch{}}catch(a){const v=((V=(E=a==null?void 0:a.response)==null?void 0:E.data)==null?void 0:V.message)||(a==null?void 0:a.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";m.error(v)}je(!1)},p=async()=>{var _,z;const b=(de||"").trim();if(!b){m.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ie.some(f=>String(f.voiceId)===String(b))){m.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const V=(s.models||[]).find(f=>f.id===pe),a=(V==null?void 0:V.modelId)||"cosyvoice-v2",v=(se||b).slice(0,40);await Ce.ai.audio.voices.add({voiceId:b,prefix:v,targetModel:a,provider:String((V==null?void 0:V.provider)||"")});const c=await Ce.ai.audio.voices.list(),r=(c==null?void 0:c.data)??c;ae(Array.isArray(r)?r:[]),m.success("å·²ä¿å­˜éŸ³è‰²")}catch(P){const E=((z=(_=P==null?void 0:P.response)==null?void 0:_.data)==null?void 0:z.message)||(P==null?void 0:P.message)||"ä¿å­˜å¤±è´¥";m.error(E)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:pe,onChange:b=>{Y(b),ee({modelId:b})},options:(s.models||[]).filter(b=>b.type!=="AUDIO_SYNTHESIS"||!b.isActive?!1:Array.isArray(b.capabilities)?b.capabilities.some(_=>_.capability==="éŸ³è‰²è®¾è®¡"&&_.supported):["minimaxi","hailuo","æµ·èº"].includes(String(b.provider||"").toLowerCase())).map(b=>({value:b.id,label:b.name}))})]}),Ie.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(os,{value:de||"",onChange:b=>{Z(b),ee({voiceId:b})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ie.map(b=>({value:b.voiceId,label:b.prefix||b.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:de,onChange:b=>{const _=b.target.value;Z(_),ee({voiceId:_})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:be,value:se,onChange:b=>{Q(b.target.value),ee({prompt:b.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:ge,value:ce,onChange:b=>{Re(b.target.value),ee({previewText:b.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:D,disabled:re||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${re||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:re?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:p,disabled:re||!de||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${re||!de||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:le,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Fo=t.memo(Wo),zo=({data:s,id:j,selected:l})=>{const W=t.useRef(null),fe=t.useRef(null),T=t.useRef(null),{getNodes:pe,getEdges:Y,setNodes:se,setEdges:Q,getNode:ce,getViewport:Re}=Qt(),de=zs(),Z=Ls(),[re,je]=t.useState(null),[le,be]=t.useState("#7c3aed"),[ge,xe]=t.useState(100),Ie=t.useRef(!1),ae=t.useRef(null),ee=t.useRef(null),U=t.useRef(null),R=t.useRef(new Set),D=t.useRef(null),p=t.useRef(null),b=t.useRef(null),_=4096,z=s.width||800,P=s.width||800,E=_,V=_;return t.useEffect(()=>{var u,i,n,F;if(!W.current||fe.current)return;const a=document.createElement("canvas");a.width=E,a.height=V,W.current.appendChild(a);const v=new _a(a,{width:E,height:V,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),c=new Qs({left:0,top:0,width:E,height:V,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});v.add(c),v.sendObjectToBack(c),v.perPixelTargetFind=!0,v.targetFindTolerance=8;const r=z/E;v.setDimensions({width:z,height:P}),v.setZoom(r),a.style.width=`${z} px`,a.style.height=`${P} px`,fe.current=v,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const f=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;v.rotationCursor=f;const d=Vs.prototype.controls||{};d.tl&&(d.tl.cursorStyle="nwse-resize",d.tl.cornerStyle="square"),d.br&&(d.br.cursorStyle="nwse-resize",d.br.cornerStyle="square"),d.tr&&(d.tr.cursorStyle="nesw-resize",d.tr.cornerStyle="square"),d.bl&&(d.bl.cursorStyle="nesw-resize",d.bl.cornerStyle="square"),d.mtr&&(d.mtr.cursorStyle=f,d.mtr.cornerStyle="circle");const x=M=>{M&&(M.borderColor="#ff2d55",M.cornerColor="#ff2d55",M.cornerStrokeColor="#ff2d55",M.transparentCorners=!1,M.cornerSize=12,M.hasBorders=!0,M.hasControls=!0)},g=()=>{const M=v.getActiveObject();M&&(M.type==="activeSelection"&&Array.isArray(M._objects)&&M._objects.forEach(x),x(M),v.requestRenderAll())};v.on("selection:created",g),v.on("selection:updated",g),v.freeDrawingBrush=new Pr(v);const w=()=>{const M=fe.current;if(!M)return;const B=M.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(B.objects)&&(B.objects=B.objects.map(oe=>(oe&&oe.type==="image"&&oe.originalUrl&&(oe.src=oe.originalUrl),oe)));const G={canvasJson:B,appliedCrop:b.current},ne=JSON.stringify(G);try{localStorage.setItem(`superCanvas:${j}`,ne)}catch{}ce(j)&&se(oe=>oe.map(k=>k.id===j?{...k,data:{...k.data,canvasState:ne}}:k))},A=()=>{p.current&&(clearTimeout(p.current),p.current=null),p.current=window.setTimeout(()=>{w()},300)};v.on("object:added",A),v.on("object:modified",A),v.on("object:removed",A),v.on("path:created",A);const $=((i=(u=ce(j))==null?void 0:u.data)==null?void 0:i.canvasState)||localStorage.getItem(`superCanvas:${j}`),N=(F=(n=ce(j))==null?void 0:n.data)==null?void 0:F.canvasJson;if($||N)try{let M,B=null;if($){const h=JSON.parse($);h.canvasJson?(M=h.canvasJson,B=h.appliedCrop):M=h}else N&&(M=JSON.parse(N));const G=M,ne=h=>{var S,y,J,ue,H,he,Ee,Ne,$e;if(!h||typeof h!="object")return h;if(h.type==="image"){if(h.originalUrl)h.src=h.originalUrl;else if(h.sourceNodeId){const Ae=ce(h.sourceNodeId),_e=((S=Ae==null?void 0:Ae.data)==null?void 0:S.imageUrl)||((y=Ae==null?void 0:Ae.data)==null?void 0:y.url)||((J=Ae==null?void 0:Ae.data)==null?void 0:J.output)||((H=(ue=Ae==null?void 0:Ae.data)==null?void 0:ue.config)==null?void 0:H.generatedImageUrl)||(($e=(Ne=(Ee=(he=Ae==null?void 0:Ae.data)==null?void 0:he.config)==null?void 0:Ee.uploadedFiles)==null?void 0:Ne[0])==null?void 0:$e.url);_e&&(h.originalUrl=_e,h.src=_e)}return typeof h.src=="string"&&h.src.startsWith("blob:")?null:h}return Array.isArray(h.objects)&&(h.objects=h.objects.map(ne).filter(Boolean),h.type==="group"&&h.objects.length===0)?null:h},me=h=>h&&(typeof(h==null?void 0:h.src)=="string"&&h.src.startsWith("blob:")?null:h.type==="image"?ne(h):h),oe=h=>h&&(Array.isArray(h)?h.map(oe).filter(Boolean):typeof h=="object"&&(h.type==="image"&&typeof h.src=="string"&&h.src.startsWith("blob:")||(Object.keys(h).forEach(S=>{const y=h[S];if(typeof y=="string"&&y.startsWith("blob:"))h[S]=void 0;else if(y&&typeof y=="object"){const J=oe(y);J===null?delete h[S]:h[S]=J}}),Array.isArray(h.objects)&&(h.objects=h.objects.map(oe).filter(Boolean),h.type==="group"&&h.objects.length===0)))?null:h);Array.isArray(G.objects)&&(G.objects=G.objects.map(ne).filter(Boolean)),G.backgroundImage&&(G.backgroundImage=me(G.backgroundImage)),G.overlayImage&&(G.overlayImage=me(G.overlayImage)),G.clipPath&&(G.clipPath=ne(G.clipPath));const k=oe(G);v.loadFromJSON(k).then(()=>{const h=new Qs({left:0,top:0,width:E,height:V,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});v.add(h);const S=v.getObjects().find(y=>y.name==="__background__");if(S&&v.sendObjectToBack(S),B){b.current=B;const{left:y,top:J,width:ue,height:H}=B,he=new Qs({left:y,top:J,width:ue,height:H,absolutePositioned:!0});v.clipPath=he,S&&S.set({left:y,top:J,width:ue,height:H})}v.requestRenderAll()})}catch{}return W.current&&W.current.classList.add("nodrag"),()=>{v.dispose(),fe.current=null,W.current&&(W.current.innerHTML="")}},[j,E,V,z]),t.useEffect(()=>{re==="brush"?(ge<80||ge>400)&&xe(100):(re==="pencil"||re==="line"||re==="arrow")&&(ge<10||ge>30)&&xe(15)},[re,ge]),t.useEffect(()=>{const a=fe.current;if(!a)return;const v="https://api.waule.ai",c=de.filter(d=>d.target===j&&d.targetHandle==="input-image");c.forEach(async d=>{var N,u;const x=Z.find(i=>i.id===d.source);if(!x||R.current.has(x.id))return;let g;const w=x.data;if(x.type==="upload"){const i=(N=w==null?void 0:w.config)==null?void 0:N.uploadedFiles;if(i&&i.length>0){const n=i[0];(n.type==="IMAGE"||(u=n.mimeType)!=null&&u.startsWith("image/"))&&(g=n.url)}}else x.type==="imagePreview"?g=w==null?void 0:w.imageUrl:g=(w==null?void 0:w.imageUrl)||(w==null?void 0:w.output)||(w==null?void 0:w.url);if(!g)return;let A=g;if(!g.startsWith("http")&&!g.startsWith("data:")&&(A=`${v}${g}`),A=A.replace(/^https?:\/\/localhost(?::\d+)?/i,v),a.getObjects().find(i=>i.sourceNodeId===x.id)){R.current.add(x.id);return}R.current.add(x.id);try{const i=await Ce.assets.proxyDownload(A),n=new Uint8Array(i);let F="image/png";n.length>=4&&(n[0]===137&&n[1]===80&&n[2]===78&&n[3]===71?F="image/png":n[0]===255&&n[1]===216&&n[2]===255?F="image/jpeg":n[0]===71&&n[1]===73&&n[2]===70?F="image/gif":n[0]===82&&n[1]===73&&n[2]===70&&n[3]===70&&n.length>=12&&n[8]===87&&n[9]===69&&n[10]===66&&n[11]===80&&(F="image/webp"));const M=new Blob([i],{type:F}),B=URL.createObjectURL(M),G=await Ta.fromURL(B);if(!G){URL.revokeObjectURL(B);return}const ne=c.indexOf(d)*20;G.set({scaleX:1,scaleY:1,left:(E-G.width)/2+ne,top:(V-G.height)/2+ne,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:x.id,originalUrl:A,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),G.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),a.add(G);const me=a.getObjects().find(oe=>oe.name==="__background__");me?(a.sendObjectToBack(G),a.sendObjectToBack(me)):a.sendObjectToBack(G),a.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(B),1e3)}catch{}});const r=new Set(c.map(d=>{var x;return(x=Z.find(g=>g.id===d.source))==null?void 0:x.id}).filter(Boolean)),f=[];R.current.forEach(d=>{if(!r.has(d)){f.push(d);const x=a.getObjects().find(g=>g.sourceNodeId===d);x&&(a.remove(x),a.requestRenderAll())}}),f.forEach(d=>R.current.delete(d))},[de,Z,j,E,V]),t.useEffect(()=>{const a=fe.current;if(!a)return;if(a.isDrawingMode=!1,a.defaultCursor="default",a.selection=!0,a.skipTargetFind=!1,re===null){if(a.isDrawingMode=!1,a.selection=!1,a.skipTargetFind=!0,a.defaultCursor="default",a.getObjects().forEach(f=>{f.name!=="__background__"&&f.name!=="__crop__"&&(f.selectable=!1,f.evented=!1)}),D.current&&(D.current.style.display="none"),b.current){const{left:f,top:d,width:x,height:g}=b.current,w=new Qs({left:f,top:d,width:x,height:g,absolutePositioned:!0});a.clipPath=w;const A=a.getObjects().find($=>$.name==="__background__");A&&A.set({left:f,top:d,width:x,height:g})}return}const v=le.startsWith("#")?`%23${le.slice(1)}`:encodeURIComponent(le),c=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${v}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,r=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(re==="pencil"||re==="brush"){a.isDrawingMode=!0,a.freeDrawingBrush=new Pr(a);const f=(x,g)=>{const w=x.replace("#",""),A=parseInt(w.substring(0,2),16),$=parseInt(w.substring(2,4),16),N=parseInt(w.substring(4,6),16);return`rgba(${A},${$},${N},${g})`};if(a.freeDrawingBrush.color=f(le,.7),a.freeDrawingBrush.width=ge,b.current){const{left:x,top:g,width:w,height:A}=b.current,$=new Qs({left:x,top:g,width:w,height:A,absolutePositioned:!0});a.clipPath=$;const N=a.getObjects().find(u=>u.name==="__background__");N&&N.set({left:x,top:g,width:w,height:A})}const d=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${v}' stroke-width='2.2'/></svg>") 16 16, crosshair`;re==="pencil"?(a.freeDrawingCursor=c,a.defaultCursor=c,a.hoverCursor=c,a.moveCursor=c,a.upperCanvasEl&&(a.upperCanvasEl.style.cursor=c)):(a.freeDrawingCursor=d,a.defaultCursor=d,a.hoverCursor=d,a.moveCursor=d,a.upperCanvasEl&&(a.upperCanvasEl.style.cursor=d)),a.selection=!1,a.getObjects().forEach(x=>{x.name!=="__background__"&&x.name!=="__crop__"&&(x.selectable=!0,x.evented=!0)}),re==="brush"&&D.current&&(D.current.style.display="block"),re==="pencil"&&D.current&&(D.current.style.display="none")}else if(re==="crop"){a.selection=!1,a.defaultCursor="crosshair",a.clipPath=void 0;const f=a.getObjects().find(A=>A.name==="__background__");f&&f.set({left:0,top:0,width:E,height:V}),a.requestRenderAll();let d=U.current;const x=E*.1,g=E-x*2,w=V-x*2;if(!d||!a.getObjects().includes(d)){const A=b.current||{left:x,top:x,width:g,height:w};d=new Qs({left:A.left,top:A.top,width:A.width,height:A.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),U.current=d,a.add(d)}d&&(d.visible=!0,d.selectable=!0,d.evented=!0,a.setActiveObject(d),a.requestRenderAll())}else if(re==="line"||re==="arrow"||re==="text"||re==="eraser"){if(a.selection=!1,b.current){const{left:d,top:x,width:g,height:w}=b.current,A=new Qs({left:d,top:x,width:g,height:w,absolutePositioned:!0});a.clipPath=A;const $=a.getObjects().find(N=>N.name==="__background__");$&&$.set({left:d,top:x,width:g,height:w})}const f=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${v}' stroke-width='2.2'/></svg>") 16 16, crosshair`;a.defaultCursor=re==="text"?"text":re==="eraser"?r:f,a.upperCanvasEl&&(a.upperCanvasEl.style.cursor=a.defaultCursor),re==="line"||re==="arrow"?(a.hoverCursor=f,a.moveCursor=f,a.skipTargetFind=!0,a.discardActiveObject(),a.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!1,d.evented=!1)}),D.current&&(D.current.style.display="none")):(a.skipTargetFind=!1,a.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!0,d.evented=!0)}),re==="eraser"&&D.current&&(D.current.style.display="none"),re==="eraser"&&(a.moveCursor=r,a.hoverCursor=r)),D.current&&(D.current.style.display="none")}else{if(U.current&&(U.current.visible=!1,a.discardActiveObject()),b.current){const{left:f,top:d,width:x,height:g}=b.current,w=new Qs({left:f,top:d,width:x,height:g,absolutePositioned:!0});a.clipPath=w;const A=a.getObjects().find($=>$.name==="__background__");A&&A.set({left:f,top:d,width:x,height:g})}a.requestRenderAll(),a.skipTargetFind=!1,a.getObjects().forEach(f=>{f.name!=="__background__"&&f.name!=="__crop__"&&(f.selectable=!0,f.evented=!0)}),a.defaultCursor="default",a.hoverCursor="default",a.moveCursor="default",a.upperCanvasEl&&(a.upperCanvasEl.style.cursor="default"),D.current&&(D.current.style.display="none")}},[re,le,ge,E,V,z,P]),t.useEffect(()=>{const a=v=>{const c=fe.current;if(c){if(v.key==="Escape")je("select");else if(v.key==="Enter"&&re==="crop"){const r=U.current;if(r){const f=Math.max(0,Math.floor(r.left??0)),d=Math.max(0,Math.floor(r.top??0)),x=Math.max(1,Math.floor((r.width??0)*(r.scaleX??1))),g=Math.max(1,Math.floor((r.height??0)*(r.scaleY??1)));b.current={left:f,top:d,width:x,height:g};const w=new Qs({left:f,top:d,width:x,height:g,absolutePositioned:!0});c.clipPath=w;const A=c.getObjects().find(N=>N.name==="__background__");A&&A.set({left:f,top:d,width:x,height:g}),r.visible=!1,je("select"),c.requestRenderAll();const $=fe.current?()=>{const N=fe.current;if(!N)return;const u=N.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(u.objects)&&(u.objects=u.objects.map(M=>(M&&M.type==="image"&&M.originalUrl&&(M.src=M.originalUrl),M)));const i={canvasJson:u,appliedCrop:b.current},n=JSON.stringify(i);try{localStorage.setItem(`superCanvas:${j}`,n)}catch{}ce(j)&&se(M=>M.map(B=>B.id===j?{...B,data:{...B.data,canvasState:n}}:B))}:null;$&&$()}}}};return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[re]),t.useEffect(()=>{const a=fe.current;if(!a)return;const v=g=>{const w=a.getPointer(g.e);if(Ie.current=!0,ae.current={x:w.x,y:w.y},(re==="line"||re==="arrow")&&(a.discardActiveObject(),a.skipTargetFind=!0,a.getObjects().forEach(A=>{A.name!=="__background__"&&A.name!=="__crop__"&&(A.selectable=!1,A.evented=!1)})),re==="line"){const A=[w.x,w.y,w.x,w.y],$=new or(A,{strokeWidth:ge/2,fill:le,stroke:le,originX:"center",originY:"center",strokeLineCap:"round"});ee.current=$,a.add($)}else if(re==="arrow"){const A=[w.x,w.y,w.x,w.y],$=new or(A,{strokeWidth:ge/2,fill:le,stroke:le,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});ee.current=$,a.add($)}else if(re==="text"){const A=new Or("Type here",{left:w.x,top:w.y,fontFamily:"Arial",fill:le,fontSize:ge*10,width:300,splitByGrapheme:!0});A.lockScalingY=!1,A.lockScalingFlip=!0,A.lockUniScaling=!1,A.setControlsVisibility({mt:!1,mb:!1}),a.add(A),a.setActiveObject(A),A.enterEditing(),je("select")}else if(re==="eraser"){const A=a.getObjects();for(let $=A.length-1;$>=0;$--){const N=A[$];if(!(N.name==="__background__"||N.name==="__crop__"||N.name==="__input_image__"||N.sourceNodeId)&&N.containsPoint(w)){a.remove(N);break}}a.requestRenderAll()}},c=g=>{const w=a.getPointer(g.e);if(re==="brush"&&D.current){const $=a.getZoom(),N=ge*$,u=N/2;D.current.style.width=`${N}px`,D.current.style.height=`${N}px`,D.current.style.left=`${w.x*$-u}px`,D.current.style.top=`${w.y*$-u}px`,D.current.style.borderColor=`rgba(${parseInt(le.slice(1,3),16)},${parseInt(le.slice(3,5),16)},${parseInt(le.slice(5,7),16)},0.7)`,D.current.style.borderWidth="1px",D.current.style.background="transparent"}if(!Ie.current)return;const A=ee.current;if(re==="line"&&A&&A instanceof or)A.set({x2:w.x,y2:w.y}),A.setCoords(),a.requestRenderAll();else if(re==="arrow"&&A&&A instanceof or)A.set({x2:w.x,y2:w.y}),A.setCoords(),a.requestRenderAll();else if(re==="eraser"){const $=a.getObjects();for(let N=$.length-1;N>=0;N--){const u=$[N];u.name==="__background__"||u.name==="__crop__"||u.name==="__input_image__"||u.sourceNodeId||u.containsPoint(w)&&a.remove(u)}a.requestRenderAll()}},r=()=>{if(Ie.current=!1,re==="arrow"&&ee.current instanceof or){const g=ee.current,w=Math.atan2(g.y2-g.y1,g.x2-g.x1),A=Math.max(ge*10,120),$=Math.PI/6,N=-Math.cos(w),u=-Math.sin(w),i=Math.cos($),n=Math.sin($),F=g.x2+A*(N*i-u*n),M=g.y2+A*(N*n+u*i),B=g.x2+A*(N*i+u*n),G=g.y2+A*(-N*n+u*i),ne=g.strokeWidth||ge/2,me=new or([g.x2,g.y2,F,M],{stroke:le,strokeWidth:ne,strokeLineCap:"round"}),oe=new or([g.x2,g.y2,B,G],{stroke:le,strokeWidth:ne,strokeLineCap:"round"});a.add(me),a.add(oe);const k=new Ua([g,me,oe],{selectable:!0,evented:!0});a.remove(g),a.remove(me),a.remove(oe),a.add(k)}ee.current=null,(re==="line"||re==="arrow")&&(a.skipTargetFind=!0,a.getObjects().forEach(g=>{g.name!=="__background__"&&g.name!=="__crop__"&&(g.selectable=!1,g.evented=!1)}))},f=g=>{var N;const w=g.target;if(!w)return;const A=w.type==="textbox"||w instanceof Or,$=w.type==="i-text"||w instanceof Ra;if(A||$){const u=(N=g==null?void 0:g.transform)==null?void 0:N.corner;if(u==="ml"||u==="mr"){const i=Math.max(50,(w.width||50)*(w.scaleX||1));w.set({width:i,scaleX:1,scaleY:1})}else{const i=w.scaleX||1,n=w.fontSize||40,F=Math.max(6,Math.min(512,Math.round(n*i)));w.set({fontSize:F,scaleX:1,scaleY:1})}w.setCoords(),a.requestRenderAll()}},d=()=>{re==="brush"&&D.current&&(D.current.style.display="block")},x=()=>{D.current&&(D.current.style.display="none")};return a.on("mouse:down",v),a.on("mouse:move",c),a.on("mouse:up",r),a.on("mouse:over",d),a.on("mouse:out",x),a.on("object:scaling",f),()=>{a.off("mouse:down",v),a.off("mouse:move",c),a.off("mouse:up",r),a.off("mouse:over",d),a.off("mouse:out",x),a.off("object:scaling",f)}},[re,le,ge]),e.jsxs("div",{ref:T,className:`relative flex flex-col w-[800px] h-auto bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Er,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:W,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:D,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Er,label:"Select"},{id:"pencil",icon:Hr,label:"Pencil"},{id:"brush",icon:Ma,label:"Brush"},{id:"line",icon:Ga,label:"Line"},{id:"arrow",icon:$a,label:"Arrow"},{id:"text",icon:Fa,label:"Text"},{id:"eraser",icon:Pa,label:"Eraser"},{id:"crop",icon:La,label:"Crop"}].map(a=>e.jsx("button",{onClick:()=>je(a.id),className:`p-2 rounded-lg transition-all ${re===a.id?"bg-neutral-500/20 text-neutral-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:a.label,children:e.jsx(a.icon,{size:16})},a.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const a=fe.current,v=a==null?void 0:a.getActiveObject();v&&(a==null||a.remove(v),a==null||a.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(Br,{size:16})}),e.jsx("button",{onClick:()=>{const a=fe.current,v=a==null?void 0:a.getActiveObject();v&&(a==null||a.bringObjectToFront(v),a==null||a.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Wa,{size:16})}),e.jsx("button",{onClick:()=>{const a=fe.current,v=a==null?void 0:a.getActiveObject();if(v){a==null||a.sendObjectToBack(v);const c=a==null?void 0:a.getObjects().find(r=>r.name==="__background__");c&&(a==null||a.sendObjectToBack(c)),a==null||a.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Va,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:le,onChange:a=>be(a.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:re==="brush"?80:10,max:re==="brush"?400:30,value:ge,onChange:a=>{const v=parseInt(a.target.value);xe(v)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:ge})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:re==="crop",onClick:async()=>{var he,Ee,Ne;const a=fe.current;if(!a)return;a.discardActiveObject();const v=[...a.viewportTransform],c=a.getWidth(),r=a.getHeight();a.setViewportTransform([1,0,0,1,0,0]),a.setWidth(_),a.setHeight(_);const f=a.clipPath;a.clipPath=void 0;const d=b.current;let x="",g=E,w=V;d?(g=d.width,w=d.height,x=a.toDataURL({format:"png",quality:1,left:d.left,top:d.top,width:d.width,height:d.height,multiplier:1})):x=a.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:E,height:V}),a.clipPath=f,a.setViewportTransform(v),a.setWidth(c),a.setHeight(r),a.requestRenderAll();const A=`${g}:${w}`,$=ce(j);if(!$)return;let N=x;try{const $e=x.split(",")[1],Ae=atob($e),_e=new Array(Ae.length);for(let Ft=0;Ft<Ae.length;Ft++)_e[Ft]=Ae.charCodeAt(Ft);const Ue=new Uint8Array(_e),ie=new Blob([Ue],{type:"image/png"}),Ve=`canvas-export-${Date.now()}.png`,Qe=await Ce.post("/assets/presigned-url",{fileName:Ve,contentType:"image/png"});if(Qe.success&&Qe.data){const{uploadUrl:Ft,publicUrl:Mt}=Qe.data;await(await ds(async()=>{const{default:ct}=await import("./utils-BcyDR7Vi.js");return{default:ct}},[])).default.put(Ft,ie,{headers:{"Content-Type":"image/png"},timeout:3e5}),N=Mt}}catch{}const u=Re&&((he=Re())==null?void 0:he.zoom)||1,i=document.querySelector(`.react-flow__node[data-id="${j}"]`),n=(i==null?void 0:i.getBoundingClientRect().width)||400,F=Math.round(n/u),M=400,B=($e,Ae=300)=>{if(!$e||!/^[0-9]+\s*:\s*[0-9]+$/.test($e))return Ae;const[_e,Ue]=$e.split(":").map(ie=>parseFloat(ie));return!_e||!Ue?Ae:Math.round(M*(Ue/_e))},G=200,ne=100,me=B(A,300),oe=pe(),k=Y(),S=oe.filter($e=>$e.type==="imagePreview"&&k.some(Ae=>Ae.source===j&&Ae.target===$e.id)).length,y=$.position.x+F+G,J=$.position.y+S*(me+ne),ue={id:`preview-${j}-${Date.now()}`,type:"imagePreview",position:{x:y,y:J},data:{imageUrl:N,width:M,ratio:A,workflowContext:(Ee=$.data)==null?void 0:Ee.workflowContext,createdBy:(Ne=$.data)==null?void 0:Ne.createdBy}};se($e=>[...$e,ue]);const H={id:`edge-${j}-${ue.id}`,source:j,target:ue.id,targetHandle:`${ue.id}-target`,type:"aurora"};Q($e=>$e.find(_e=>_e.source===j&&_e.target===ue.id)?$e:[...$e,H])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:cursor-not-allowed disabled:hover:shadow-md",title:re==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(St,{type:"target",position:ut.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(St,{type:"source",position:ut.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Bo=t.memo(zo),Ho=({data:s,selected:j,id:l})=>{const[W,fe]=t.useState(s.config.upscaleResolution||"1080p"),[T,pe]=t.useState(!1),[Y,se]=t.useState(s.config.inputVideoUrl||""),[,Q]=t.useState(s.config.taskId||""),{setNodes:ce,setEdges:Re}=Qt(),de=Ls(),Z=zs(),re=ge=>{ce(xe=>xe.map(Ie=>Ie.id===l?{...Ie,data:{...Ie.data,config:{...Ie.data.config,...ge}}}:Ie))};t.useEffect(()=>{var xe,Ie,ae;const ge=Z.filter(ee=>ee.target===l);if(ge.length>0){const ee=de.find(U=>U.id===ge[0].source);if(ee){const U=ee.data,R=U.videoUrl||((xe=U.config)==null?void 0:xe.videoUrl)||((Ie=U.config)==null?void 0:Ie.outputVideoUrl)||((ae=U.config)==null?void 0:ae.resultUrl);R&&R!==Y&&(se(R),re({inputVideoUrl:R}))}}else Y&&(se(""),re({inputVideoUrl:""}))},[Z,de,l]),t.useEffect(()=>{const ge=s.config.taskId;(async()=>{if(ge)try{const ae=(await Ce.get(`/tasks/${ge}`)).task;if(ae.status==="SUCCESS"){const ee=ae.resultUrl;re({outputVideoUrl:ee,taskId:""}),Z.filter(p=>p.source===l).map(p=>de.find(b=>b.id===p.target)).filter(p=>p&&p.type==="videoPreview").find(p=>p.data.videoUrl===ee)||le(ee),Vt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),pe(!1)}else ae.status==="PROCESSING"||ae.status==="PENDING"?(pe(!0),je(ge)):ae.status==="FAILURE"&&(pe(!1),re({taskId:""}),Vt.error(ae.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${ae.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{pe(!1),re({taskId:""}),Vt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const je=async ge=>{let Ie=0;const ae=async()=>{try{Ie++;const U=(await Ce.get(`/tasks/${ge}`)).task;if(U.status==="SUCCESS"){const R=U.resultUrl;pe(!1),re({outputVideoUrl:R,taskId:""}),le(R),Vt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(U.status==="FAILURE"){pe(!1),re({taskId:""}),Vt.error(U.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(U.status==="PROCESSING"||U.status==="PENDING")&&(Ie<300?setTimeout(ae,3e3):(pe(!1),re({taskId:""}),Vt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{pe(!1),re({taskId:""}),Vt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};ae()},le=ge=>{var Ie;const xe=de.find(ae=>ae.id===l);if(xe){const ae=`preview-video-${Date.now()}`,ee=W==="1080p"?"HD":W,U={id:ae,type:"videoPreview",position:{x:xe.position.x+400,y:xe.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:ge,ratio:"16:9",resolution:ee,createdBy:(Ie=xe.data)==null?void 0:Ie.createdBy}},R={id:`edge-${l}-${ae}`,source:l,target:ae,type:"aurora"};ce(D=>[...D,U]),setTimeout(()=>{Re(D=>[...D,R])},100)}},be=async()=>{var ge,xe;if(!Y){Vt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}pe(!0);try{const Ie=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!Ie||Ie.length===0){Vt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),pe(!1);return}const ae=Ie[0],U=(await Ce.post("/ai/video-upscale",{video_url:Y,upscale_resolution:W,apiKey:ae.apiKey,apiUrl:ae.apiUrl})).taskId;Q(U),re({taskId:U,upscaleResolution:W}),Vt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),je(U)}catch(Ie){const ae=((xe=(ge=Ie.response)==null?void 0:ge.data)==null?void 0:xe.error)||Ie.message||"æœªçŸ¥åŸå› ";Vt.error(`å¯åŠ¨å¤±è´¥ï¼š${ae}ï¼Œè¯·ç¨åé‡è¯•`),pe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[Y&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:Y,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(ge=>e.jsx("button",{type:"button",onClick:()=>{fe(ge),re({upscaleResolution:ge})},disabled:T,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${W===ge?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${T?"cursor-not-allowed":""}`,children:ge},ge))})]}),e.jsx("button",{type:"button",onClick:ge=>{ge.preventDefault(),ge.stopPropagation(),be()},onMouseDown:ge=>{ge.stopPropagation()},disabled:T||!Y||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${T||!Y||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[T?e.jsx(Ds,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:T?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(gs,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Xo=t.memo(Ho),Jo=({data:s,selected:j,id:l})=>{const[W,fe]=t.useState(s.config.prompt||""),[T,pe]=t.useState(s.config.duration||30),[Y,se]=t.useState(s.config.ratio||"16:9"),[Q,ce]=t.useState(s.config.language||"zh"),[Re,de]=t.useState(!1),[Z,re]=t.useState(s.config.images||[]),[,je]=t.useState(s.config.taskId||""),{credits:le,loading:be}=Is({nodeType:"ad_composition",duration:T}),{setNodes:ge,setEdges:xe}=Qt(),Ie=Ls(),ae=zs(),ee=p=>{ge(b=>b.map(_=>_.id===l?{..._,data:{..._.data,config:{..._.data.config,...p}}}:_))};t.useEffect(()=>{const p=ae.filter(_=>_.target===l),b=[];p.forEach(_=>{var P,E,V,a,v,c,r,f,d,x;const z=Ie.find(g=>g.id===_.source);z&&(z.type==="imagePreview"&&((P=z.data)!=null&&P.imageUrl)?b.push(z.data.imageUrl):z.type==="aiImage"&&((V=(E=z.data)==null?void 0:E.config)!=null&&V.generatedImageUrl)?b.push(z.data.config.generatedImageUrl):z.type==="upload"&&((v=(a=z.data)==null?void 0:a.config)!=null&&v.uploadedFiles)?z.data.config.uploadedFiles.filter(w=>w.type==="IMAGE"||(w.mimeType||"").startsWith("image/")).forEach(w=>b.push(w.url)):z.type==="assetSelector"&&((r=(c=z.data)==null?void 0:c.config)!=null&&r.subjects?z.data.config.subjects.forEach(w=>{Array.isArray(w.images)&&w.images.forEach(A=>b.push(A.url))}):((x=(d=(f=z.data)==null?void 0:f.config)==null?void 0:d.selectedAsset)==null?void 0:x.type)==="IMAGE"&&b.push(z.data.config.selectedAsset.url)))}),JSON.stringify(b)!==JSON.stringify(Z)&&(re(b),ee({images:b}))},[ae,Ie,l]),t.useEffect(()=>{const p=s.config.taskId;(async()=>{if(p)try{const z=(await Ce.get(`/tasks/${p}`)).task;if(z.status==="SUCCESS"){const P=z.resultUrl;ee({taskId:""}),de(!1)}else z.status==="PROCESSING"||z.status==="PENDING"?(de(!0),U(p)):z.status==="FAILURE"&&(de(!1),ee({taskId:""}),Vt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${z.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{de(!1),ee({taskId:""})}})()},[]);const U=async p=>{let _=0;const z=async()=>{try{_++;const E=(await Ce.get(`/tasks/${p}`)).task;if(E.status==="SUCCESS"){const V=E.resultUrl;de(!1),ee({taskId:""}),R(V),Vt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(E.status==="FAILURE"){de(!1),ee({taskId:""}),Vt.error(E.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(E.status==="PROCESSING"||E.status==="PENDING")&&(_<120?setTimeout(z,1e4):(de(!1),ee({taskId:""}),Vt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{de(!1),ee({taskId:""}),Vt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};z()},R=p=>{var _;const b=Ie.find(z=>z.id===l);if(b){const z=`preview-video-${Date.now()}`,P={id:z,type:"videoPreview",position:{x:b.position.x+400,y:b.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:p,ratio:Y,width:320,createdBy:(_=b.data)==null?void 0:_.createdBy}},E={id:`edge-${l}-${z}`,source:l,target:z,type:"aurora"};ge(V=>[...V,P]),setTimeout(()=>{xe(V=>[...V,E])},100)}},D=async()=>{var p,b,_,z,P;if(Z.length===0){Vt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(Z.length>15){Vt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!W.trim()){Vt.error("è¯·è¾“å…¥æç¤ºè¯");return}de(!0);try{const E=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!E||E.length===0){Vt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),de(!1);return}const V=E[0],a={images:Z,prompt:W,duration:T,ratio:Y,language:Q,apiKey:V.apiKey,apiUrl:V.apiUrl},v=await Ce.post("/ai/commercial-video",a),c=v.taskId,r=v.creditsCharged||0;if(je(c),ee({taskId:c,images:Z,prompt:W,duration:T,ratio:Y,language:Q}),r>0)try{const{useAuthStore:f}=await ds(async()=>{const{useAuthStore:x}=await import("./index-B7LKGTE9.js").then(g=>g.f);return{useAuthStore:x}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:d}=f.getState();await d(),Vt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${r} ç§¯åˆ†ï¼‰`)}catch{Vt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Vt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");U(c)}catch(E){((p=E.response)==null?void 0:p.status)===403?Vt.error(((_=(b=E.response)==null?void 0:b.data)==null?void 0:_.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Vt.error(((P=(z=E.response)==null?void 0:z.data)==null?void 0:P.error)||E.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),de(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",Z.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:W,onChange:p=>{fe(p.target.value),ee({prompt:p.target.value}),p.target.style.height="auto",p.target.style.height=p.target.scrollHeight+"px"},onFocus:p=>{p.target.style.height="auto",p.target.style.height=p.target.scrollHeight+"px"},ref:p=>{p&&W&&(p.style.height="auto",p.style.height=p.scrollHeight+"px")},disabled:Re,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(p=>e.jsxs("button",{type:"button",onClick:()=>{pe(p),ee({duration:p})},disabled:Re,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${T===p?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Re?"cursor-not-allowed":""}`,children:[p,"s"]},p))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(p=>e.jsx("button",{type:"button",onClick:()=>{se(p),ee({ratio:p})},disabled:Re,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Y===p?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Re?"cursor-not-allowed":""}`,children:p},p))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(p=>e.jsx("button",{type:"button",onClick:()=>{ce(p.value),ee({language:p.value})},disabled:Re,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Q===p.value?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Re?"cursor-not-allowed":""}`,children:p.label},p.value))})]}),e.jsx("button",{type:"button",onClick:D,disabled:Re||Z.length===0||!W.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Re||Z.length===0||!W.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Re?e.jsx(Ds,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),e.jsx("span",{children:Re?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Re&&!be&&le!==null&&le>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[le,"ç§¯åˆ†"]})]})})]}),e.jsx(gs,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},qo=t.memo(Jo),Ko=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],Yo=({data:s,selected:j,id:l})=>{const{setNodes:W}=Qt(),[fe,T]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[pe,Y]=t.useState(!1),[se,Q]=t.useState(!1),[ce,Re]=t.useState(s.fontSize||36),[de,Z]=t.useState(s.width||200),[re,je]=t.useState(s.bold||!1),le=t.useRef(null),be=t.useRef(null),ge=t.useCallback(ae=>{W(ee=>ee.map(U=>U.id===l?{...U,data:{...U.data,...ae}}:U))},[l,W]);t.useEffect(()=>{const ae=setTimeout(()=>{fe!==s.text&&ge({text:fe})},300);return()=>clearTimeout(ae)},[fe,s.text,ge]),t.useEffect(()=>{ge({fontSize:ce,width:de,bold:re})},[ce,de,re,ge]);const xe=()=>{Y(!0),setTimeout(()=>{le.current&&(le.current.focus(),le.current.select(),le.current.style.height="auto",le.current.style.height=`${le.current.scrollHeight}px`)},0)},Ie=()=>{Y(!1)};return t.useEffect(()=>{pe&&le.current&&(le.current.style.height="auto",le.current.style.height=`${le.current.scrollHeight}px`)},[pe,fe]),t.useEffect(()=>{const ae=ee=>{be.current&&!be.current.contains(ee.target)&&Q(!1)};return se&&document.addEventListener("mousedown",ae),()=>document.removeEventListener("mousedown",ae)},[se]),e.jsxs("div",{className:`relative group ${j?"ring-2 ring-neutral-400 ring-offset-2":""}`,style:{width:de},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:ae=>{ae.stopPropagation(),Q(!se)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),se&&e.jsxs("div",{ref:be,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:ae=>ae.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:ce,onChange:ae=>Re(Number(ae.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-neutral-400",children:Ko.map(ae=>e.jsxs("option",{value:ae,children:[ae,"px"]},ae))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>je(!re),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${re?"bg-neutral-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),pe?e.jsx("textarea",{ref:le,value:fe,onChange:ae=>T(ae.target.value),onBlur:Ie,onMouseDown:ae=>ae.stopPropagation(),onKeyDown:ae=>{ae.key==="Escape"&&Y(!1)},className:"nodrag w-full bg-transparent border-2 border-neutral-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:re?"bold":"normal"}}):e.jsx("div",{onDoubleClick:xe,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:re?"bold":"normal"},children:fe}),!pe&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:ae=>{ae.stopPropagation(),ae.preventDefault();const ee=ae.clientX,U=de,R=p=>{p.preventDefault();const b=Math.max(100,U+(p.clientX-ee));Z(b)},D=()=>{document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",D)};document.addEventListener("mousemove",R),document.addEventListener("mouseup",D)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Qo=t.memo(Yo),Zo=({data:s,id:j,selected:l})=>{const{getNode:W,setNodes:fe,setEdges:T}=Qt(),pe=Fs(t.useCallback(i=>i.edges.filter(n=>n.target===j),[j])),[Y,se]=t.useState(s.prompt||""),[Q,ce]=t.useState(s.points||[]),[Re,de]=t.useState(!1),[Z,re]=t.useState(!1),[je,le]=t.useState(null),[be,ge]=t.useState([]),[,xe]=t.useState(s.generatedImageUrl||null),[Ie,ae]=t.useState(null),[,ee]=t.useState(s.taskId||""),[,U]=t.useState(0),R=t.useRef(null),D=t.useRef(1),{credits:p,loading:b,isFreeUsage:_,freeUsageRemaining:z,refetch:P}=Is({nodeType:"image_editing",quantity:1}),E=t.useCallback(i=>{fe(n=>n.map(F=>F.id===j?{...F,data:{...F.data,...i}}:F))},[j,fe]),V=Fs(t.useCallback(i=>i.edges.filter(n=>n.source===j),[j])),a=t.useCallback(i=>{var ne,me;const n=W(j);if(!n)return;const F=V.find(oe=>{const k=W(oe.target);return(k==null?void 0:k.type)==="imagePreview"});if(F){const oe=F.target;fe(k=>k.map(h=>h.id===oe?{...h,data:{...h.data,imageUrl:i}}:h));return}const M=Date.now(),B=`preview-${j}-${M}`,G={id:B,type:"imagePreview",position:{x:(((ne=n==null?void 0:n.position)==null?void 0:ne.x)||0)+450,y:((me=n==null?void 0:n.position)==null?void 0:me.y)||0},data:{imageUrl:i,width:400}};setTimeout(()=>{fe(k=>[...k,G]);const oe={id:`edge-${j}-${B}`,source:j,target:B,targetHandle:`${B}-target`,type:"aurora"};T(k=>k.find(S=>S.source===j&&S.target===B)?k:[...k,oe])},100)},[j,W,fe,T,V]),v=t.useRef({active:!1,timeoutId:null}),c=t.useCallback(async i=>{let F=0;v.current.timeoutId&&clearTimeout(v.current.timeoutId),v.current.active=!0;const M=async()=>{if(v.current.active)try{F++;const G=(await Ce.tasks.getTaskStatus(i)).task;if(!v.current.active)return;if(U(G.progress||0),G.status==="SUCCESS"){v.current.active=!1,de(!1),U(100);const ne=G.resultUrl;E({generatedImageUrl:ne,taskId:""}),xe(ne),m.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ne&&a(ne);return}else if(G.status==="FAILURE"){v.current.active=!1,de(!1),U(0),E({taskId:""}),m.error(G.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(G.status==="PROCESSING"||G.status==="PENDING")&&(F<300&&v.current.active?v.current.timeoutId=setTimeout(M,1e3):(v.current.active=!1,de(!1),U(0),E({taskId:""}),m.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{v.current.active=!1,de(!1),U(0),E({taskId:""}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};M()},[E,a]);t.useEffect(()=>()=>{v.current.active=!1,v.current.timeoutId&&clearTimeout(v.current.timeoutId)},[]),t.useEffect(()=>{const i=s.taskId;if(!i)return;(async()=>{try{const M=(await Ce.tasks.getTaskStatus(i)).task;if(M.status==="SUCCESS"){de(!1),U(100);const B=M.resultUrl;B?(E({generatedImageUrl:B,taskId:""}),xe(B),m.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):E({taskId:""})}else M.status==="PROCESSING"||M.status==="PENDING"?(de(!0),U(M.progress||0),c(i)):M.status==="FAILURE"&&(de(!1),U(0),E({taskId:""}),m.error(M.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${M.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{de(!1),U(0),E({taskId:""})}})()},[]);const r=t.useCallback(i=>{const n=new Image;n.onload=()=>{ae({width:n.naturalWidth,height:n.naturalHeight})},n.src=i},[]);t.useEffect(()=>{try{const i=[];pe.forEach(n=>{var G,ne,me,oe;const F=W(n.source);if(!F)return;const M=F.data;let B=null;M!=null&&M.url?B=M.url:M!=null&&M.imageUrl?B=M.imageUrl:M!=null&&M.output?B=M.output:(G=M==null?void 0:M.config)!=null&&G.generatedImageUrl?B=M.config.generatedImageUrl:(oe=(me=(ne=M==null?void 0:M.config)==null?void 0:ne.uploadedFiles)==null?void 0:me[0])!=null&&oe.url&&(B=M.config.uploadedFiles[0].url),B&&i.push(B)}),i.length>0?(le(i[0]),ge(i.slice(1)),r(i[0])):(le(null),ge([]),ae(null))}catch{}},[pe,W,r]),t.useEffect(()=>{const i=setTimeout(()=>{fe(n=>n.map(F=>{if(F.id!==j)return F;const M=F.data;return M.prompt===Y&&JSON.stringify(M.points)===JSON.stringify(Q)?F:{...F,data:{...F.data,prompt:Y,points:Q}}}))},300);return()=>clearTimeout(i)},[Y,Q,j,fe]);const f=t.useCallback(i=>{if(!i.ctrlKey&&!i.metaKey||!R.current)return;const n=R.current.getBoundingClientRect(),F=(i.clientX-n.left)/n.width,M=(i.clientY-n.top)/n.height,B={id:D.current++,x:Math.max(0,Math.min(1,F)),y:Math.max(0,Math.min(1,M))};ce(G=>[...G,B])},[]),d=t.useCallback(i=>{ce(n=>n.filter(F=>F.id!==i))},[]),x=t.useCallback((i,n)=>{ce(F=>F.map(M=>M.id===i?{...M,name:n}:M))},[]),g=t.useCallback((i,n)=>{i.stopPropagation();const F=n.name?`@${n.name}`:`@ä½ç½®${n.id}`;i.dataTransfer.setData("text/plain",F),i.dataTransfer.effectAllowed="copy"},[]),w=t.useCallback((i,n)=>{i.stopPropagation();const F=`@å‚è€ƒå›¾${n+1}`;i.dataTransfer.setData("text/plain",F),i.dataTransfer.effectAllowed="copy"},[]),A=t.useCallback(i=>{i.preventDefault(),i.stopPropagation(),i.dataTransfer.dropEffect="copy"},[]),$=t.useCallback(i=>{i.preventDefault(),i.stopPropagation();const n=i.dataTransfer.getData("text/plain");if(n){const F=i.target,M=F.selectionStart,B=F.selectionEnd,G=Y.slice(0,M)+n+Y.slice(B);se(G),setTimeout(()=>{F.selectionStart=F.selectionEnd=M+n.length,F.focus()},0)}},[Y]),N=t.useCallback(async()=>{var i;if(!(!je||Q.length===0)){re(!0);try{const n=await Ce.ai.imageEditing.identifyPoints({image:je,points:Q.map(F=>({id:F.id,x:F.x,y:F.y}))});if(n.success&&((i=n.data)!=null&&i.points)){const F=n.data.points;ce(M=>M.map(B=>{const G=F.find(ne=>ne.id===B.id);return G?{...B,name:G.name}:B})),m.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{m.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{re(!1)}}},[je,Q]),u=t.useCallback(async()=>{var i,n,F,M,B;if(!je){m.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!Y.trim()){m.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}de(!0),U(0);try{const G=await Ce.tasks.createImageEditTask({prompt:Y.trim(),mainImage:je,referenceImages:be.length>0?be:void 0,points:Q.length>0?Q:void 0,sourceImageDimensions:Ie||void 0,sourceNodeId:j}),ne=G.taskId,me=G.creditsCharged||0,oe=G.isFreeUsage,k=G.freeUsageRemaining??0;if(ee(ne),E({prompt:Y.trim(),points:Q,taskId:ne}),oe)m.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${k} æ¬¡æœºä¼š`),P();else if(me>0){const{useAuthStore:h}=await ds(async()=>{const{useAuthStore:y}=await import("./index-B7LKGTE9.js").then(J=>J.f);return{useAuthStore:y}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:S}=h.getState();await S(),m.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${me} ç§¯åˆ†`),P()}else m.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");c(ne)}catch(G){if(de(!1),U(0),((i=G.response)==null?void 0:i.status)===403){const ne=((F=(n=G.response)==null?void 0:n.data)==null?void 0:F.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";m.error(ne)}else{const ne=((B=(M=G.response)==null?void 0:M.data)==null?void 0:B.error)||G.message||"æœªçŸ¥åŸå› ";m.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ne}ï¼Œè¯·ç¨åé‡è¯•`)}}},[je,Y,be,Q,Ie,j,E,c,P]);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Hr,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:R,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:f,children:je?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:je,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),Q.map(i=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-neutral-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${i.x*100}%`,top:`${i.y*100}%`},onClick:n=>{n.stopPropagation(),d(i.id)},title:i.name||`ç‚¹å‡»åˆ é™¤ #${i.id}`,children:i.id},i.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Er,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),be.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[be.map((i,n)=>e.jsx("img",{src:i,alt:`Ref ${n+1}`,draggable:!0,onDragStart:F=>w(F,n),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},n)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",be.length," å‚è€ƒå›¾"]})]}),Q.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",Q.length,")"]}),e.jsxs("button",{onClick:N,disabled:Z||!je,className:"text-[10px] text-neutral-500 hover:text-neutral-600 flex items-center gap-1",children:[Z?e.jsx(Ds,{className:"w-3 h-3 animate-spin"}):e.jsx(mr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:Q.map(i=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:n=>g(n,i),className:"w-5 h-5 bg-neutral-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:i.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:i.name||"",onChange:n=>x(i.id,n.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>d(i.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Br,{className:"w-3 h-3"})})]},i.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:Y,onChange:i=>se(i.target.value),onDragOver:A,onDrop:$,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:u,onPointerDown:i=>i.stopPropagation(),onMouseDown:i=>i.stopPropagation(),disabled:Re||!je||!Y.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Re||!je||!Y.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Re?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!b&&(_?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(z),"æ¬¡"]}):p!==null&&p>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[p,"ç§¯åˆ†"]}):null)]})})]})]})},en=t.memo(Zo);async function dr(s){const{resultUrl:j,allImageUrls:l}=s;return{displayUrl:j,allDisplayUrls:l,isLocalStored:!1,originalUrl:j}}const tn="gemini-3-pro-image-preview",sn=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],rn=s=>{const[j,l]=s.split(":").map(Number);return j/l},an=(s,j)=>{const l=s/j;let W="1:1",fe=1/0;for(const T of sn){const pe=rn(T),Y=Math.abs(l-pe);Y<fe&&(fe=Y,W=T)}return W},on=s=>new Promise((j,l)=>{const W=new Image;W.onload=()=>{j({width:W.naturalWidth,height:W.naturalHeight})},W.onerror=l,W.src=s}),nn=({data:s,selected:j,id:l})=>{const[W,fe]=t.useState(s.config.imageSize||"2K"),[T,pe]=t.useState(s.config.inputImage),[Y,se]=t.useState(!!s.config.taskId),[Q,ce]=t.useState(null),Re=t.useMemo(()=>{const D=s.models||[];return D.find(p=>p.modelId===tn)||D.find(p=>{var b;return(b=p.modelId)==null?void 0:b.includes("gemini")})||D[0]},[s.models]),{credits:de,loading:Z,isFreeUsage:re,freeUsageRemaining:je}=Is({nodeType:"hd_upscale",quantity:1,resolution:W});t.useEffect(()=>{Re&&ce(Re)},[Re]);const{setNodes:le,setEdges:be,getNode:ge,getNodes:xe}=Qt(),Ie=Fs(D=>D.edges.filter(p=>p.target===l));t.useEffect(()=>{const D=xe();let p;Ie.forEach(b=>{var z,P,E,V,a,v,c,r;const _=D.find(f=>f.id===b.source);if(_){const f=(P=(z=_.data)==null?void 0:z.config)==null?void 0:P.uploadedFiles;if(Array.isArray(f)&&f.length>0){const d=f[0];d!=null&&d.url&&(p=d.url)}if(!p){const d=((E=_.data)==null?void 0:E.imageUrl)||((a=(V=_.data)==null?void 0:V.config)==null?void 0:a.generatedImageUrl)||((c=(v=_.data)==null?void 0:v.config)==null?void 0:c.imageUrl)||((r=_.data)==null?void 0:r.url);d&&(p=d)}}}),p!==T&&(pe(p),ae({inputImage:p}))},[Ie,xe]),t.useEffect(()=>{const D=s.config.taskId;(async()=>{if(D)try{const _=(await Ce.tasks.getTaskStatus(D)).task;if(_.status==="SUCCESS"){se(!1);const z=_.resultUrl;if(!z){ae({taskId:""});return}const E=(await dr({taskId:D,resultUrl:z,type:"IMAGE"})).displayUrl;ae({generatedImageUrl:E,taskId:""})}else _.status==="PROCESSING"||_.status==="PENDING"?(se(!0),U(D)):_.status==="FAILURE"&&(se(!1),ae({taskId:""}),$s.error(`ç”Ÿæˆå¤±è´¥: ${_.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{se(!1),ae({taskId:""}),$s.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const ae=D=>{le(p=>p.map(b=>b.id===l?{...b,data:{...b.data,config:{...b.data.config,...D}}}:b))},ee=async()=>{var D;if(!T){$s.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}se(!0);try{const p=await ur(T,{skipCompression:!0});let b="1:1";try{const V=await on(T);b=an(V.width,V.height)}catch{}let _="";try{const V=await Ce.get("/node-prompts/type/hdUpscale");V.success&&((D=V.data)!=null&&D.userPromptTemplate)&&(_=V.data.userPromptTemplate)}catch{}if(_||(_="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),_=`${_}ï¼Œç”Ÿæˆ${b}æ¯”ä¾‹çš„å›¾ç‰‡`,!Q){$s.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),se(!1);return}const z=await Ce.tasks.createImageTask({modelId:Q.id,prompt:_,ratio:b,referenceImages:[p],sourceNodeId:l,metadata:{imageSize:W,nodeType:"hd_upscale"}});if(!z.success)throw new Error(z.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const P=z.taskId,E=z.creditsCharged||0;if(ae({taskId:P}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),E>0){const{useAuthStore:V}=await ds(async()=>{const{useAuthStore:v}=await import("./index-B7LKGTE9.js").then(c=>c.f);return{useAuthStore:v}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:a}=V.getState();await a(),$s.success(`âœ¨ é«˜æ¸…æ”¾å¤§å·²å¼€å§‹ï¼Œæ¶ˆè€— ${E} ç§¯åˆ†`)}U(P)}catch(p){$s.error(p.message||"ç”Ÿæˆå¤±è´¥"),se(!1)}},U=async D=>{let b=0;const _=async()=>{try{const P=(await Ce.tasks.getTaskStatus(D)).task;if(P.status==="SUCCESS"){se(!1);const E=P.resultUrl;if(!E){$s.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const a=(await dr({taskId:D,resultUrl:E,type:"IMAGE"})).displayUrl;ae({generatedImageUrl:a,taskId:"",imageSize:W}),R(a),$s.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else P.status==="FAILURE"?(se(!1),ae({taskId:""}),$s.error(`ç”Ÿæˆå¤±è´¥: ${P.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(P.status==="PROCESSING"||P.status==="PENDING")&&(b++,b<300?setTimeout(_,2e3):(se(!1),$s.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{se(!1),$s.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};_()},R=D=>{const p=ge(l);if(!p)return;const z=xe().filter(v=>v.id.startsWith(`${l}-preview`)&&v.type==="imagePreview").length,V={id:`${l}-preview-${Date.now()}`,type:"imagePreview",position:{x:p.position.x+380,y:p.position.y+z*(220+20)},data:{imageUrl:D,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:l,createdBy:p.data.createdBy}},a={id:`edge-${l}-to-${V.id}`,source:l,target:V.id,sourceHandle:`${l}-source`,type:"aurora"};le(v=>[...v,V]),be(v=>[...v,a])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(gs,{type:"target",position:ut.Left,id:`${l}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(gs,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:T,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{fe("2K"),ae({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${W==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{fe("4K"),ae({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${W==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:ee,onPointerDown:D=>D.stopPropagation(),onMouseDown:D=>D.stopPropagation(),disabled:Y||!T,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Y||!T?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Y?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"}),!Z&&(re?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(je),"æ¬¡"]}):de!==null&&de>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[de,"ç§¯åˆ†"]}):null)]})})]})]})},ln=t.memo(nn),Xr=async(s,j,l)=>new Promise((W,fe)=>{const T=new Image;T.crossOrigin="Anonymous",T.onload=()=>{try{const pe=T.width,Y=T.height,se=Math.floor(pe/l),Q=Math.floor(Y/j),ce=[],Re=document.createElement("canvas");Re.width=se,Re.height=Q;const de=Re.getContext("2d");if(!de){fe(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let Z=0;Z<j;Z++)for(let re=0;re<l;re++)de.clearRect(0,0,se,Q),de.drawImage(T,re*se,Z*Q,se,Q,0,0,se,Q),ce.push(Re.toDataURL("image/png"));W({slices:ce,fullImage:s,rows:j,cols:l})}catch(pe){fe(pe)}},T.onerror=()=>{fe(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),T.src=s}),zr=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},cn=(s,j="image/png")=>{const l=s.includes(",")?s.split(",")[1]:s,W=atob(l),fe=new Array(W.length);for(let pe=0;pe<W.length;pe++)fe[pe]=W.charCodeAt(pe);const T=new Uint8Array(fe);return new Blob([T],{type:j})},dn=({data:s,selected:j,id:l})=>{const[W,fe]=t.useState(null),T="single",[pe,Y]=t.useState(s.config.aspectRatio||"16:9"),[se,Q]=t.useState(s.config.imageSize||"4K"),[ce,Re]=t.useState(s.config.userPrompt||""),[de,Z]=t.useState(!!s.config.taskId),[re,je]=t.useState(s.config.characterImages||[]),[le,be]=t.useState(s.config.sceneImages||[]),[ge,xe]=t.useState(s.config.styleImage),Ie=t.useRef(null),{setNodes:ae,setEdges:ee,getNode:U,getNodes:R,getEdges:D}=Qt(),p=Fs(N=>N.edges.filter(u=>u.target===l)),b=Fs(N=>N.edges.some(u=>u.target===l&&u.targetHandle===`${l}-scene-input`)),_=Fs(N=>N.edges.some(u=>u.target===l&&u.targetHandle===`${l}-style-input`)),z=t.useRef(""),{credits:P,loading:E,isFreeUsage:V,freeUsageRemaining:a}=Is({nodeType:"image_fusion",quantity:1,resolution:se}),v="gemini-3-pro-image-preview",c=t.useMemo(()=>{const N=s.models||[];return N.find(u=>u.modelId===v)||N.find(u=>{var i;return(i=u.modelId)==null?void 0:i.includes("gemini")})||N[0]},[s.models]);t.useEffect(()=>{c&&fe(c)},[c]),t.useEffect(()=>{const N=s.config.taskId,u=s.config.generatedImageUrl;(async()=>{if(N)try{const F=(await Ce.tasks.getTaskStatus(N)).task;if(F.status==="SUCCESS"){Z(!1);const M=F.resultUrl;if(!M){r({taskId:""}),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let B=M;u?B=u:B=(await dr({taskId:N,resultUrl:M,type:"IMAGE"})).displayUrl,r({generatedImageUrl:B,taskId:""});const G=R(),ne=D();if(G.filter(k=>k.type==="imagePreview"&&ne.some(h=>h.source===l&&h.target===k.id)).find(k=>k.data.imageUrl===B||k.data.imageUrl===M)){m.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}m.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),A(B,pe,0)}else F.status==="PROCESSING"||F.status==="PENDING"?(Z(!0),g(N)):F.status==="FAILURE"&&(Z(!1),r({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${F.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{Z(!1),r({taskId:""}),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ie.current&&ce){const N=Ie.current;N.style.height="auto",N.style.height=`${N.scrollHeight}px`}},[]);const r=N=>{ae(u=>u.map(i=>i.id===l?{...i,data:{...i.data,config:{...i.data.config,...N}}}:i))};t.useEffect(()=>{const N=JSON.stringify(p.map(F=>({source:F.source,sourceHandle:F.sourceHandle,targetHandle:F.targetHandle})));if(N===z.current)return;z.current=N;const u=[],i=[];let n;p.forEach(F=>{const M=U(F.source);if(!M)return;const B=F.targetHandle||"",G=f(M);B.includes("character")?u.push(...G):B.includes("scene")?i.length===0&&G.length>0&&i.push(G[0]):B.includes("style")&&G.length>0&&(n=G[0])}),je(u),be(i),xe(n),r({characterImages:u,sceneImages:i,styleImage:n})},[p,U]);const f=N=>{var n,F,M,B;const u=(N==null?void 0:N.type)||"",i=N==null?void 0:N.data;if(u==="upload"&&((n=i==null?void 0:i.config)!=null&&n.uploadedFiles))return i.config.uploadedFiles.filter(G=>{var ne;return G.type==="IMAGE"||((ne=G.mimeType)==null?void 0:ne.startsWith("image/"))}).map(G=>G.url||G.localUrl);if(u==="assetSelector"&&((F=i==null?void 0:i.config)!=null&&F.selectedAsset)){const G=i.config.selectedAsset;if(G.type==="IMAGE"||(M=G.mimeType)!=null&&M.startsWith("image/"))return[G.url]}return u==="imagePreview"&&(i!=null&&i.imageUrl)?[i.imageUrl]:u==="aiImage"&&((B=i==null?void 0:i.config)!=null&&B.generatedImageUrl)?[i.config.generatedImageUrl]:[]},d=()=>{let N=ce;if(ge){const u=re.length+le.length+1;N+=`ï¼Œå‚è€ƒå›¾ç‰‡${u}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${u}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return N+=`ï¼Œç”Ÿæˆ${pe}æ¯”ä¾‹çš„å›¾ç‰‡`,N},x=async()=>{if(!ce.trim()){m.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!W){m.error("è¯·é€‰æ‹©æ¨¡å‹");return}Z(!0);try{const N=d(),u=[...re,...le,...ge?[ge]:[]],i=await Promise.all(u.map(async B=>{try{return await ur(B)}catch{return B}})),n=await Ce.tasks.createImageTask({modelId:W.id,prompt:N,ratio:pe,referenceImages:i.filter(Boolean),sourceNodeId:l,metadata:{imageSize:se,nodeType:"image_fusion"}});if(!n.success)throw new Error(n.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const F=n.taskId,M=n.creditsCharged||0;if(r({taskId:F}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),M>0){const{useAuthStore:B}=await ds(async()=>{const{useAuthStore:ne}=await import("./index-B7LKGTE9.js").then(me=>me.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:G}=B.getState();await G(),m.success(`âœ¨ æ™ºèƒ½æº¶å›¾å·²å¼€å§‹ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†`)}g(F)}catch(N){m.error(N.message||"ç”Ÿæˆå¤±è´¥"),Z(!1)}},g=async N=>{let i=0;const n=async()=>{try{const M=(await Ce.tasks.getTaskStatus(N)).task;if(M.status==="SUCCESS"){Z(!1);const B=M.resultUrl;if(!B){m.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ne=(await dr({taskId:N,resultUrl:B,type:"IMAGE"})).displayUrl;r({generatedImageUrl:ne,taskId:"",modelId:W==null?void 0:W.id,mode:T,aspectRatio:pe,imageSize:se,userPrompt:ce}),T!=="single"||A(ne,pe,0),m.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else M.status==="FAILURE"?(Z(!1),r({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${M.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(M.status==="PROCESSING"||M.status==="PENDING")&&(i++,i<300?setTimeout(n,2e3):(Z(!1),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{Z(!1),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};n()},w=async N=>{try{const{rows:u,cols:i}=zr(T),n=await Xr(N,u,i);r({slicedImages:n.slices}),n.slices.forEach((F,M)=>{A(F,pe,M)})}catch(u){m.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+u.message)}},A=(N,u,i)=>{const n=U(l);if(!n)return;const{rows:F,cols:M}=zr(T),B=F*M,G=280,ne=320,me=20,oe=i%M,k=Math.floor(i/M),h=n.position.x+400,S=n.position.y-(B-1)*(ne+me)/2,y={id:`${l}-preview-${i}-${Date.now()}`,type:"imagePreview",position:{x:h+oe*(G+me),y:S+k*(ne+me)},data:{imageUrl:N,ratio:u,label:`æº¶å›¾ ${i+1}`,fromStoryboard:!0,sourceNodeId:l}},J={id:`edge-${l}-to-${y.id}`,source:l,target:y.id,sourceHandle:`${l}-source`,type:"aurora"};ae(ue=>[...ue,y]),ee(ue=>[...ue,J])},$=re.length+le.length+(ge?1:0);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["è§’è‰² ",re.length>0&&`(${re.length})`]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${l}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["åœºæ™¯ ",le.length>0?"âœ“":""]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${l}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!b})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["é£æ ¼ ",ge?"âœ“":""]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${l}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!_})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(hs,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[$>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",$,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let N=1;const u=[];return re.forEach(i=>{u.push({url:i,type:"char",index:N++})}),le.forEach(i=>{u.push({url:i,type:"scene",index:N++})}),ge&&u.push({url:ge,type:"style",index:N++}),u.map(i=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:i.url,alt:`å›¾${i.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:i.index})]},`${i.type}-${i.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{Q("2K"),r({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${se==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{Q("4K"),r({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${se==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(N=>e.jsx("button",{onClick:()=>{Y(N),r({aspectRatio:N})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${pe===N?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:N},N))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ie,value:ce,onChange:N=>{Re(N.target.value),r({userPrompt:N.target.value});const u=N.target;u.style.height="auto",u.style.height=`${u.scrollHeight}px`},onFocus:N=>{const u=N.target;u.style.height="auto",u.style.height=`${u.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:x,onPointerDown:N=>N.stopPropagation(),onMouseDown:N=>N.stopPropagation(),disabled:de||!ce.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${de||!ce.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:de?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!E&&(V?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(a),"æ¬¡"]}):P!==null&&P>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[P,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(gs,{type:"source",position:ut.Right,id:`${l}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},un=t.memo(dn),gn=["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"],hn="gemini-3-pro-preview",pn="gemini-3-pro-image-preview",Sr=5,fn=({data:s,selected:j,id:l})=>{const[W,fe]=t.useState(s.config.aspectRatio||"1:1"),[T,pe]=t.useState(s.config.inputImages||[]),[Y,se]=t.useState(s.config.userPrompt||""),[Q,ce]=t.useState(!!s.config.taskId),[Re,de]=t.useState(null),[Z,re]=t.useState(null),{credits:je,loading:le,isFreeUsage:be,freeUsageRemaining:ge}=Is({nodeType:"smart_storyboard",quantity:1}),xe=t.useMemo(()=>{const c=s.models||[];return c.find(r=>r.modelId===pn)||c.find(r=>{var f;return(f=r.modelId)==null?void 0:f.includes("gemini")})||c[0]},[s.models]);t.useEffect(()=>{xe&&re(xe)},[xe]);const{setNodes:Ie,setEdges:ae,getNode:ee,getNodes:U}=Qt(),R=t.useRef(null),D=t.useRef(null),p=t.useRef(null),b=t.useRef(U),_=Fs(c=>c.edges.filter(r=>r.target===l)),z=t.useRef("");t.useEffect(()=>{const c=U(),r=[];_.forEach(d=>{var g,w,A,$,N,u,i,n;if(r.length>=Sr)return;const x=c.find(F=>F.id===d.source);if(x){const F=(w=(g=x.data)==null?void 0:g.config)==null?void 0:w.uploadedFiles;Array.isArray(F)&&F.forEach(B=>{r.length>=Sr||B!=null&&B.url&&!r.includes(B.url)&&r.push(B.url)});const M=((A=x.data)==null?void 0:A.imageUrl)||((N=($=x.data)==null?void 0:$.config)==null?void 0:N.generatedImageUrl)||((i=(u=x.data)==null?void 0:u.config)==null?void 0:i.imageUrl)||((n=x.data)==null?void 0:n.url);M&&!r.includes(M)&&r.push(M)}});const f=r.join(",");f!==z.current&&(z.current=f,pe(r),P({inputImages:r}))},[_,U]),t.useEffect(()=>{const c=s.config.taskId,f=setTimeout(async()=>{var d,x,g,w;if(c)try{const $=(await Ce.tasks.getTaskStatus(c)).task;if($.status==="SUCCESS"){ce(!1),de(null);const N=$.resultUrl;if(!N){(d=D.current)==null||d.call(D,{taskId:""});return}const i=(await dr({taskId:c,resultUrl:N,type:"IMAGE"})).displayUrl;(x=D.current)==null||x.call(D,{generatedImageUrl:i,taskId:""}),!b.current().some(M=>{var B;return((B=M.data)==null?void 0:B.sourceNodeId)===l&&M.type==="imagePreview"})&&R.current&&await R.current(i),m.success("åˆ†é•œç”Ÿæˆå·²å®Œæˆï¼")}else $.status==="PROCESSING"||$.status==="PENDING"?(ce(!0),de("image"),setTimeout(()=>{var N;(N=p.current)==null||N.call(p,c)},100)):$.status==="FAILURE"&&(ce(!1),de(null),(g=D.current)==null||g.call(D,{taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${$.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ce(!1),de(null),(w=D.current)==null||w.call(D,{taskId:""}),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}},200);return()=>clearTimeout(f)},[]);const P=c=>{Ie(r=>r.map(f=>f.id===l?{...f,data:{...f.data,config:{...f.data.config,...c}}}:f))};D.current=P,b.current=U;const E=async()=>{var c,r;if(T.length===0){m.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!Y.trim()){m.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}ce(!0),de("text");try{const f=await Promise.all(T.map(i=>ur(i,{skipCompression:!0}))),d="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",x="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚",g=await Ce.ai.text.generate({modelId:hn,systemPrompt:d,prompt:Y,imageUrls:f,skipBilling:!0});if(!g.success)throw new Error(g.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const w=((c=g.data)==null?void 0:c.text)||((r=g.data)==null?void 0:r.content)||g.content;if(!w||typeof w!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(de("image"),!Z){m.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),ce(!1),de(null);return}const A=`${x}

åˆ†é•œæè¿°ï¼š
${w}

ç”Ÿæˆ${W}æ¯”ä¾‹çš„å›¾ç‰‡`,$=await Ce.tasks.createImageTask({modelId:Z.id,prompt:A,ratio:W,referenceImages:f,sourceNodeId:l,metadata:{imageSize:"4K",nodeType:"smart_storyboard"}});if(!$.success)throw new Error($.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const N=$.taskId,u=$.creditsCharged||0;if(P({taskId:N,userPrompt:Y}),u>0){const{useAuthStore:i}=await ds(async()=>{const{useAuthStore:F}=await import("./index-B7LKGTE9.js").then(M=>M.f);return{useAuthStore:F}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:n}=i.getState();await n()}setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},500),V(N)}catch(f){m.error(f.message||"ç”Ÿæˆå¤±è´¥"),ce(!1),de(null)}},V=async c=>{let f=0;const d=async()=>{try{const g=(await Ce.tasks.getTaskStatus(c)).task;if(g.status==="SUCCESS"){ce(!1),de(null);const w=g.resultUrl;if(!w){m.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const $=(await dr({taskId:c,resultUrl:w,type:"IMAGE"})).displayUrl;P({generatedImageUrl:$,taskId:"",aspectRatio:W}),await a($),m.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else g.status==="FAILURE"?(ce(!1),de(null),P({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${g.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(g.status==="PROCESSING"||g.status==="PENDING")&&(f++,f<300?setTimeout(d,2e3):(ce(!1),de(null),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ce(!1),de(null),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};d()};p.current=V;const a=async c=>{try{let r=c;if(!c.startsWith("data:"))try{const $=await Ce.assets.proxyDownload(c),N=new Blob([$],{type:"image/png"});r=await new Promise((u,i)=>{const n=new FileReader;n.onloadend=()=>u(n.result),n.onerror=i,n.readAsDataURL(N)})}catch{}const f=await Xr(r,3,3),d=3e4;m.info(`å¼€å§‹ä¸Šä¼  ${f.slices.length} ä¸ªåˆ†é•œ...`);const x=f.slices.map(async($,N)=>{var u;try{const i=cn($,"image/png"),n=`storyboard_${l}_slice_${N+1}_${Date.now()}.png`,F=new File([i],n,{type:"image/png"}),M=Ce.assets.upload(F),B=new Promise((ne,me)=>setTimeout(()=>me(new Error("ä¸Šä¼ è¶…æ—¶")),d)),G=await Promise.race([M,B]);return G.success&&((u=G.data)!=null&&u.url)?{success:!0,url:G.data.url,index:N+1}:{success:!1,index:N+1,error:G.message}}catch(i){return{success:!1,index:N+1,error:i.message}}}),g=await Promise.all(x),w=[],A=[];g.forEach($=>{$.success&&$.url?w.push($.url):A.push($.index)}),P({slicedImages:w}),A.length>0?m.error(`åˆ†é•œ ${A.join(", ")} ä¸Šä¼ å¤±è´¥`):m.success(`æˆåŠŸç”Ÿæˆ ${w.length} ä¸ªåˆ†é•œ`),v(w,W)}catch(r){m.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+r.message)}};R.current=a;const v=(c,r)=>{const f=ee(l);if(!f)return;const d=220,x=20,g=Date.now(),w=f.position.x+350,A=c.length*d+(c.length-1)*x,$=f.position.y-A/2+150,N=[],u=[];c.forEach((i,n)=>{const F={id:`${l}-slice-${g}-${n}`,type:"imagePreview",position:{x:w,y:$+n*(d+x)},data:{imageUrl:i,ratio:r,label:`åˆ†é•œ ${n+1}`,fromStoryboard:!0,sourceNodeId:l,createdBy:f.data.createdBy}},M={id:`edge-${l}-to-slice-${g}-${n}`,source:l,target:F.id,sourceHandle:`${l}-source`,type:"aurora"};N.push(F),u.push(M)}),Ie(i=>[...i,...N]),ae(i=>[...i,...u]),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},100)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(gs,{type:"target",position:ut.Left,id:`${l}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(gs,{type:"source",position:ut.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",T.length,"/",Sr,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:T.map((c,r)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:c,alt:`å›¾ç‰‡${r+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:r+1})]},r))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:Y,onChange:c=>{se(c.target.value),P({userPrompt:c.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:gn.map(c=>e.jsx("button",{onClick:()=>{fe(c),P({aspectRatio:c})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${W===c?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:c},c))})]}),e.jsx("button",{type:"button",onClick:c=>{c.stopPropagation(),E()},disabled:Q,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Q?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Re==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"}),!le&&(be?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ge),"æ¬¡"]}):je!==null&&je>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[je,"ç§¯åˆ†"]}):null)]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},mn=t.memo(fn),xn="https://api.waule.ai",bn=({isOpen:s,onClose:j,onAssetSelect:l})=>{const[W,fe]=t.useState([]),[T,pe]=t.useState(""),[Y,se]=t.useState([]),[Q,ce]=t.useState([]),[Re,de]=t.useState(!1),[Z,re]=t.useState("ALL"),[je,le]=t.useState("ALL");t.useEffect(()=>{s&&be()},[s]),t.useEffect(()=>{T&&xe(T)},[T]),t.useEffect(()=>{if(!s)return;const ee=je==="ALL"?W:W.filter(U=>(U.category||"OTHER")===je);pe(ee.length>0?ee[0].id:"")},[je,W,s]);const be=async()=>{try{const U=(await Ce.assetLibraries.getAll({includeShared:"true"})).data||[];if(fe(U),U.length>0&&!T){const R=je==="ALL"?U:U.filter(D=>(D.category||"OTHER")===je);pe((R[0]||U[0]).id)}}catch{m.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const ee=U=>{var D;const R=((D=U==null?void 0:U.detail)==null?void 0:D.libraryId)||T;be(),R&&xe(R)};return window.addEventListener("asset-library-updated",ee),()=>window.removeEventListener("asset-library-updated",ee)},[T]);const ge=ee=>(/^https?:\/\//.test(ee)?ee:`${xn}${ee}`).replace(".oss-oss-",".oss-"),xe=async ee=>{var U,R,D,p,b;de(!0);try{const _=W.find(P=>P.id===ee);if(_&&(_.category||"OTHER")==="ROLE"){const E=(await Ce.assetLibraries.roles.list(ee)).data||[],V=[];for(const a of E){const v=a.metadata||{},c=[(U=v.images)==null?void 0:U.frontAssetId,(R=v.images)==null?void 0:R.sideAssetId,(D=v.images)==null?void 0:D.backAssetId,(p=v.images)==null?void 0:p.faceAssetId].filter(Boolean),r=[];for(const d of c)try{const g=(await Ce.assets.getById(d)).data;r.push({id:g.id,url:ge(g.url),name:g.name})}catch{}const f=a.thumbnail?ge(a.thumbnail):((b=r[0])==null?void 0:b.url)||"";V.push({id:a.id,name:a.name,coverUrl:f,images:r})}ce(V),se([])}else{const E=(await Ce.assetLibraries.getAssets(ee)).data||[];se(E),ce([])}}catch{m.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{de(!1)}},Ie=ee=>{pe(ee)},ae=ee=>{l?(l(ee),setTimeout(()=>{be(),T&&xe(T)},0)):m.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:j}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-neutral-500/20 via-neutral-400/30 to-neutral-500/20"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:j,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:W.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(ee=>e.jsx("button",{onClick:()=>re(ee),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${Z===ee?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:ee==="IMAGE"?"å›¾ç‰‡":ee==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},ee))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(ee=>e.jsx("button",{onClick:()=>le(ee),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${je===ee?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:ee==="ROLE"?"è§’è‰²":ee==="SCENE"?"åœºæ™¯":ee==="PROP"?"é“å…·":ee==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},ee))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const ee=je==="ALL"?W:W.filter(U=>(U.category||"OTHER")===je);return e.jsx("select",{value:T,onChange:U=>Ie(U.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-neutral-500",children:ee.map(U=>{var R;return e.jsxs("option",{value:U.id,children:[U.isShared?`[å…±äº«] ${U.name}`:U.name," (",U._count.assets,")",U.isShared&&((R=U.owner)!=null&&R.nickname)?` - ${U.owner.nickname}`:""]},U.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Re?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const ee=W.find(D=>D.id===T);if(ee&&(ee.category||"OTHER")==="ROLE")return Q.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:Q.map(D=>e.jsxs("div",{onClick:()=>l&&l(D),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[D.coverUrl?e.jsx("img",{src:D.coverUrl,alt:D.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:D.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[D.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},D.id))});const R=Y.filter(D=>Z==="ALL"||D.type===Z);return R.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:R.map(D=>e.jsxs("div",{onClick:()=>ae(D),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[D.type==="IMAGE"?e.jsx("img",{src:ge(D.url),alt:D.name,className:"w-full h-full object-cover"}):D.type==="VIDEO"?e.jsx("video",{src:ge(D.url),className:"w-full h-full object-cover"}):D.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:D.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:D.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:D.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(D.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:D.type==="IMAGE"?"image":D.type==="VIDEO"?"video_file":D.type==="AUDIO"?"audio_file":"description"})})]},D.id))})})()})]})})]})]}):null},wn={agent:xo,aiImage:Ka,aiVideo:gr,soraVideo:_o,soraCharacter:Uo,aiVideo_t2v:Za,aiVideo_i2v_first:to,aiVideo_i2v_last:ro,aiVideo_first_last:oo,aiVideo_reference:io,aiVideo_swap:co,aiVideo_lipsync:go,aiVideo_style:fo,upload:wo,assetSelector:ko,imagePreview:No,videoPreview:Io,textPreview:Eo,midjourney:Co,audioVoice:$o,voiceClone:Do,audioSynthesize:Po,audioDesign:Fo,audioPreview:Vo,superCanvas:Bo,videoUpscale:Xo,commercialVideo:qo,textAnnotation:Qo,imageEditing:en,hdUpscale:ln,imageFusion:un,smartStoryboard:mn},yn={aurora:Oo},kn=()=>{const{id:s,projectId:j,episodeId:l,workflowId:W}=xa(),fe=!!W,T=ba(),pe=Cr(),Y=t.useMemo(()=>new URLSearchParams(pe.search),[pe.search]),se=t.useMemo(()=>{const o=Number(Y.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[Y]),Q=t.useMemo(()=>{const o=Number(Y.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[Y]),ce=t.useMemo(()=>{try{const o=Y.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[Y]),{screenToFlowPosition:Re,setCenter:de,getViewport:Z,fitView:re}=Qt(),{setTitle:je}=ya(),le=Ar(o=>o.user),[be,ge]=t.useState(null),[xe,Ie]=t.useState(null),[ae,ee]=t.useState(!0),[U,R,D]=Na([]),[p,b,_]=ja([]),[z,P]=t.useState(!1),E=t.useRef(!1),[V,a]=t.useState(null),[v,c]=t.useState(null),[r,f]=t.useState(!0),d=t.useRef(null),[x,g]=t.useState(!1),w=t.useRef(null),A=t.useRef(null),[$,N]=t.useState(!1),[u,i]=t.useState(null),[n,F]=t.useState([]),[M,B]=t.useState([]),[G,ne]=t.useState(null),[me,oe]=t.useState(null),k=t.useRef(null),h=t.useRef(null),S=G==="video",y=G==="edit",J=G==="imageEdit",ue=o=>ne(null),H=o=>ne(o?"video":null),he=o=>ne(o?"edit":null),Ee=o=>ne(o?"imageEdit":null),Ne=k,$e=me==="agent",Ae=o=>oe(o?"agent":null),_e=h,Ue=h,ie=t.useCallback(o=>{const I=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return I?I.includes("æ–‡ç”Ÿ")||I.includes("text to video")||I.includes("t2v")||I.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":I.includes("é¦–å°¾")||I.includes("first last")||I.includes("two frame")||I.includes("frame pair")||I.includes("first-last")?"é¦–å°¾å¸§":I.includes("é¦–å¸§")||I.includes("first frame")||I.includes("start frame")||I.includes("initial frame")||I.includes("keyframe")?"é¦–å¸§":I.includes("å°¾å¸§")||I.includes("last frame")||I.includes("end frame")||I.includes("final frame")?"å°¾å¸§":I.includes("ä¸»ä½“å‚è€ƒ")||I.includes("subject reference")||I.includes("å‚è€ƒ")||I.includes("reference image")||I.includes("image reference")||I.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ve=t.useMemo(()=>{const o=new Set;return(n||[]).filter(L=>(L.type||"")==="VIDEO_GENERATION").forEach(L=>{var K;(Array.isArray((K=L==null?void 0:L.config)==null?void 0:K.supportedGenerationTypes)?L.config.supportedGenerationTypes:[]).forEach(ke=>{const De=ie(ke);De&&o.add(De)})}),o},[n,ie]),Qe=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Ft=t.useCallback(o=>{const I=(n||[]).filter(K=>(K.type||"")==="VIDEO_EDITING").filter(K=>{var ke;return Array.isArray((ke=K==null?void 0:K.config)==null?void 0:ke.supportedEditingCapabilities)&&K.config.supportedEditingCapabilities.includes(o)}),L=(n||[]).filter(K=>(K.type||"")==="VIDEO_GENERATION").filter(K=>{var He,Fe;if(o!=="è§†é¢‘æ¢äºº")return!1;const ke=((He=K==null?void 0:K.config)==null?void 0:He.supportsVideoEditing)===!0,Pe=(Array.isArray((Fe=K==null?void 0:K.config)==null?void 0:Fe.supportedGenerationTypes)?K.config.supportedGenerationTypes:[]).some(rt=>ie(rt)==="è§†é¢‘æ¢äºº");return ke||Pe}),X={};return[...I,...L].forEach(K=>{X[K.id]||(X[K.id]=K)}),Object.values(X)},[n,ie]),[Mt,At]=t.useState(!1),[ct,gt]=t.useState(null),vt=t.useRef(null),it=t.useRef(),[Ke,yt]=t.useState([]),[Be,wt]=t.useState(null),[Kt,vs]=t.useState(null),[Ss,Es]=t.useState(!1),[Ns,Bs]=t.useState(null),[ps,Zs]=t.useState(null),[Hs,nr]=t.useState(null),_t=t.useRef([]),Xs=t.useRef(null),[bs,er]=t.useState(!1),[ws,tr]=t.useState(!1),[sr,rr]=t.useState(0),Ps=t.useRef(null),q=t.useRef(null),te=t.useRef([]),Me=t.useRef([]),Ge=t.useRef(0),qe=!!l,Oe=qe&&!!se&&!!Q,tt=fe?W:Oe?`${l}-${se}-${Q}`:qe?l:s,bt=Oe,[C,O]=t.useState(!1),we=t.useRef(new Set),Te=t.useRef(new Set),Se=t.useRef(new Set),ye=t.useRef(new Set),et=t.useRef(new Map),st=t.useRef(new Set),kt=t.useCallback((o,I)=>{I!==d.current&&(we.current.add(o.id),R(L=>L.some(X=>X.id===o.id)?L:[...L,{...o,data:{...o.data,models:n}}]))},[n,R]),ht=t.useCallback((o,I,L)=>{L!==d.current&&(st.current.add(o),R(X=>X.map(K=>K.id===o?{...K,data:{...K.data,...I}}:K)),setTimeout(()=>st.current.delete(o),100))},[R]),We=t.useCallback((o,I)=>{I!==d.current&&(R(L=>L.filter(X=>X.id!==o)),b(L=>L.filter(X=>X.source!==o&&X.target!==o)))},[R,b]),Dt=t.useCallback((o,I,L)=>{L!==d.current&&R(X=>X.map(K=>K.id===o?{...K,position:I}:K))},[R]),Xt=t.useCallback((o,I)=>{I!==d.current&&R(L=>L.map(X=>{const K=o.find(ke=>ke.id===X.id);return K?{...X,position:K.position}:X}))},[R]),Pt=t.useCallback((o,I)=>{I!==d.current&&(Te.current.add(o.id),b(L=>L.some(X=>X.id===o.id)?L:[...L,o]))},[b]),zt=t.useCallback((o,I)=>{I!==d.current&&b(L=>L.filter(X=>X.id!==o))},[b]),Ct=t.useCallback((o,I)=>{I!==d.current&&(yt(o),_t.current=o)},[]),{emitNodeAdd:Tt,emitNodeUpdate:Gt,emitNodeDelete:Wt,emitNodesMove:ts,emitEdgeAdd:rs,emitEdgeDelete:ys,emitGroupsUpdate:Js,onlineUsers:Cs}=Ba({workflowId:w.current,isSharedWorkflow:x,isReadOnly:z,onNodeAdd:kt,onNodeUpdate:ht,onNodeDelete:We,onNodeMove:Dt,onNodesMove:Xt,onEdgeAdd:Pt,onEdgeDelete:zt,onGroupsUpdate:Ct});t.useEffect(()=>{_t.current=Ke},[Ke]),t.useEffect(()=>{te.current=U,Ge.current=U.length},[U]),t.useEffect(()=>{Me.current=p},[p]),t.useEffect(()=>{if(!C){Se.current=new Set(U.map(K=>K.id));const X=new Map;U.forEach(K=>{var ke;try{X.set(K.id,JSON.stringify(((ke=K.data)==null?void 0:ke.config)||{}))}catch{X.set(K.id,"{}")}}),et.current=X;return}if(!x||E.current){Se.current=new Set(U.map(X=>X.id));return}const o=new Set(U.map(X=>X.id)),I=Se.current;U.forEach(X=>{var K,ke;if(!I.has(X.id))we.current.has(X.id)||Tt(X);else if(!st.current.has(X.id))try{const De=JSON.stringify(((K=X.data)==null?void 0:K.config)||{}),Pe=et.current.get(X.id)||"{}";De!==Pe&&Gt(X.id,{config:(ke=X.data)==null?void 0:ke.config})}catch{}}),Se.current=o;const L=new Map;U.forEach(X=>{var K;try{L.set(X.id,JSON.stringify(((K=X.data)==null?void 0:K.config)||{}))}catch{L.set(X.id,"{}")}}),et.current=L,we.current=new Set([...we.current].filter(X=>o.has(X)))},[U,x,C,Tt,Gt]),t.useEffect(()=>{if(!C){ye.current=new Set(p.map(L=>L.id));return}if(!x||E.current){ye.current=new Set(p.map(L=>L.id));return}const o=new Set(p.map(L=>L.id)),I=ye.current;p.forEach(L=>{I.has(L.id)||Te.current.has(L.id)||rs(L)}),ye.current=o,Te.current=new Set([...Te.current].filter(L=>o.has(L)))},[p,x,C,rs]);const fs=t.useCallback(o=>{var K;if(E.current)return!1;if(r)return!0;if(_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(o.id))}))return!1;if(Oe)return!0;const L=(K=o.data)==null?void 0:K.createdBy;return(typeof L=="object"?L==null?void 0:L.id:L)===d.current},[r,Oe]),Bt=t.useMemo(()=>{const o=new Set(Ke.filter(I=>!I.hidden).flatMap(I=>I.nodeIds||[]));return U.map(I=>{const L=o.has(I.id),X=L?!1:r?!0:fs(I);return{...I,draggable:I.draggable!==!1,connectable:L?!1:I.connectable!==!1,data:{...I.data,_canEdit:X,_isGrouped:L,_currentUserId:v,_isSharedWorkflow:x}}})},[U,Ke,r,fs,v,x,z]),Jt=t.useRef(null),as=t.useRef(new Map),us=t.useCallback(o=>{if(E.current){D(o);return}const I=o.filter(X=>{var He;if(X.type!=="position")return!0;if(_t.current.find(Fe=>{var rt;return!Fe.hidden&&((rt=Fe.nodeIds)==null?void 0:rt.includes(X.id))}))return r;if(r)return!0;const ke=te.current.find(Fe=>Fe.id===X.id);if(!ke)return!0;const De=(He=ke.data)==null?void 0:He.createdBy;return(typeof De=="object"?De==null?void 0:De.id:De)===d.current});D(I);const L=I.filter(X=>X.type==="position"&&X.position);L.length>0&&(L.forEach(X=>{as.current.set(X.id,X.position)}),Jt.current&&clearTimeout(Jt.current),Jt.current=setTimeout(()=>{const X=Array.from(as.current.entries()).map(([K,ke])=>({id:K,position:ke}));X.length>0&&(ts(X),as.current.clear())},100))},[r,D,ts]);t.useEffect(()=>{Xs.current=ps},[ps]),t.useEffect(()=>{const o=I=>{I.key==="Escape"&&(bs&&er(!1),ws&&tr(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,ws]),t.useEffect(()=>{tt&&(N(!1),O(!1),Gs(),Jr(),qr(),ss().finally(()=>{O(!0)}))},[tt]),t.useEffect(()=>{if(!ae&&!$&&U.length>0){const o=setTimeout(()=>{re({padding:.1,duration:800,maxZoom:1.5}),N(!0)},100);return()=>clearTimeout(o)}},[ae,$,U.length,re]),t.useEffect(()=>{var X;if(!Oe||!xe||!be||!C)return;const o=Ke.find(K=>K.scene===se&&K.shot===Q),I=`${se}-${Q}`;if(o){vs(o.id),wt(o.id);try{if(A.current===I)return;if(Array.isArray(ce)&&ce.length>0){A.current=I;const K=U,ke=[],De=280,Pe=320,He=350,Fe={role:0,scene:0,prop:0,audio:0};K.forEach(Le=>{var ft;if(Le.type==="assetSelector"){const Lt=((ft=Le.data)==null?void 0:ft.label)||"";Lt.startsWith("è§’è‰²")?Fe.role++:Lt.startsWith("åœºæ™¯")?Fe.scene++:Lt.startsWith("é“å…·")?Fe.prop++:Lt.startsWith("éŸ³é¢‘")&&Fe.audio++}});const rt={...Fe},Xe=[];ce.forEach((Le,ft)=>{const Lt=Le.thumbnail||Le.url||"";let Ut=null;const Ot=K.some(ot=>{var $t,Ye;if(ot.type!=="assetSelector")return!1;const Ze=($t=ot.data)==null?void 0:$t.config,ve=Ze==null?void 0:Ze.selectedAsset;if((ve==null?void 0:ve.id)===Le.id)return Ut=ot.id,!0;const Je=((Ye=ot.data)==null?void 0:Ye.label)||"",jt=Le.type==="role"?"è§’è‰²":Le.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${jt}: ${Le.name}`||(ve==null?void 0:ve.name)===Le.name?(Ut=ot.id,!0):!1});if(Ot&&Ut&&Lt&&Xe.push({nodeId:Ut,newUrl:Lt}),Ot)return;const pt=Le.type,mt=pt==="role"?0:pt==="scene"?1:pt==="prop"?2:3,Nt=rt[pt]||0;rt[pt]=(rt[pt]||0)+1;const Ht={x:mt*De,y:He+Nt*Pe},lt=Le.thumbnail||Le.url||"",ze=`assetSelector-${Date.now()}-${ft}`,nt=pt==="role"?"è§’è‰²":pt==="scene"?"åœºæ™¯":pt==="prop"?"é“å…·":"éŸ³é¢‘",dt=Le.metadata,at=pt==="role"&&(dt==null?void 0:dt.images);let qt=[];if(at){const ot=dt.images;ot.frontUrl&&qt.push({id:"front",url:ot.frontUrl,name:`${Le.name}-æ­£é¢`}),ot.sideUrl&&qt.push({id:"side",url:ot.sideUrl,name:`${Le.name}-ä¾§é¢`}),ot.backUrl&&qt.push({id:"back",url:ot.backUrl,name:`${Le.name}-èƒŒé¢`}),ot.faceUrl&&qt.push({id:"face",url:ot.faceUrl,name:`${Le.name}-é¢éƒ¨`})}let Rt;at&&qt.length>0?Rt={selectedInput:{id:Le.id,name:Le.name,coverUrl:lt,images:qt}}:pt==="audio"?Rt={selectedAsset:{id:Le.id,name:Le.name,originalName:Le.name,url:Le.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:Rt={selectedAsset:{id:Le.id,name:Le.name,originalName:Le.name,url:lt,type:"IMAGE",mimeType:"image/png",size:0}},ke.push({id:ze,type:"assetSelector",position:Ht,data:{id:ze,label:`${nt}: ${Le.name}`,config:Rt,freeDrag:!0,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0,workflowContext:{project:be,episode:xe,nodeGroup:o,nodeGroups:Ke}}})}),Xe.length>0&&R(Le=>Le.map(ft=>{var Ut;const Lt=Xe.find(Ot=>Ot.nodeId===ft.id);if(Lt&&ft.type==="assetSelector"){const Ot=((Ut=ft.data)==null?void 0:Ut.config)||{},pt=Ot.selectedAsset||{};return{...ft,data:{...ft.data,config:{...Ot,selectedAsset:{...pt,url:Lt.newUrl}}}}}return ft})),ke.length>0&&R(Le=>[...Le,...ke])}}catch{}return}if(A.current===I)return;const L={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${se}å¹•-ç¬¬${Q}é•œ`,scene:se,shot:Q,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};yt(K=>[...K,L]),_t.current=[..._t.current,L],vs(L.id),wt(L.id),A.current=I;try{const K=((X=xe==null?void 0:xe.scriptJson)==null?void 0:X.acts)||[],ke=Array.isArray(K)?K.find(ze=>Number(ze.actIndex)===Number(se)):null,De=ke?(ke.shots||[]).find(ze=>Number(ze.shotIndex)===Number(Q)):null,He=De?[`ç”»é¢ï¼š${(De.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(De["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(De["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(De["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(De.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=De&&(De.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,Le=280,ft=320,Lt=350,Ut={x:0,y:0},Ot={x:rt+Xe,y:0},pt=`textPreview-${Date.now()}-a`,mt=`textPreview-${Date.now()}-b`,Nt=[{id:pt,type:"textPreview",position:Ut,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:pt,freeDrag:!0,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0,workflowContext:{project:be,episode:xe,nodeGroup:L,nodeGroups:[...Ke,L]}}},{id:mt,type:"textPreview",position:Ot,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:mt,freeDrag:!0,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0,workflowContext:{project:be,episode:xe,nodeGroup:L,nodeGroups:[...Ke,L]}}}],Ht=[];if(Array.isArray(ce)&&ce.length>0){const ze={role:0,scene:0,prop:0,audio:0};ce.forEach((nt,dt)=>{const at=nt.type,qt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,Rt=ze[at]||0;ze[at]=(ze[at]||0)+1;const ot={x:qt*Le,y:Lt+Rt*ft},Ze=`assetSelector-${Date.now()}-${dt}`;Ht.push(Ze);const ve=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=nt.thumbnail||nt.url||"",jt=nt.metadata,$t=at==="role"&&(jt==null?void 0:jt.images);let Ye=[];if($t){const xt=jt.images;xt.frontUrl&&Ye.push({id:"front",url:xt.frontUrl,name:`${nt.name}-æ­£é¢`}),xt.sideUrl&&Ye.push({id:"side",url:xt.sideUrl,name:`${nt.name}-ä¾§é¢`}),xt.backUrl&&Ye.push({id:"back",url:xt.backUrl,name:`${nt.name}-èƒŒé¢`}),xt.faceUrl&&Ye.push({id:"face",url:xt.faceUrl,name:`${nt.name}-é¢éƒ¨`})}let It;$t&&Ye.length>0?It={selectedInput:{id:nt.id,name:nt.name,coverUrl:Je,images:Ye}}:at==="audio"?It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:nt.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},Nt.push({id:Ze,type:"assetSelector",position:ot,data:{id:Ze,label:`${ve}: ${nt.name}`,config:It,freeDrag:!0,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0,workflowContext:{project:be,episode:xe,nodeGroup:L,nodeGroups:[...Ke,L]}}})})}R(ze=>[...ze,...Nt]);const lt=[pt,mt,...Ht];yt(ze=>ze.map(nt=>{if(nt.id!==L.id)return nt;const dt=Array.from(new Set([...nt.nodeIds||[],...lt])),at=nt.bounds;return{...nt,nodeIds:dt,bounds:at}})),_t.current=_t.current.map(ze=>{if(ze.id!==L.id)return ze;const nt=Array.from(new Set([...ze.nodeIds||[],...lt])),dt=ze.bounds;return{...ze,nodeIds:nt,bounds:dt}})}catch{}},[qe,se,Q,xe,be,Ke,R,C,ce]),t.useEffect(()=>{if(be)if(qe&&xe){const o=`${be.name} - ${xe.name||`ç¬¬${xe.episodeNumber}é›†`}`,I=se&&Q?`ç¬¬${se}å¹•ç¬¬${Q}é•œ`:"";je(Oe?o:`${o} ${I}`.trim())}else je(be.name);return()=>je("")},[be,xe,qe,Oe,se,Q,je]),t.useEffect(()=>{if(!(!tt||ae||E.current))return it.current&&clearTimeout(it.current),it.current=setTimeout(()=>{qs()},2e3),()=>{it.current&&clearTimeout(it.current)}},[U,p,Ke]);const ss=async()=>{var o,I,L,X,K,ke;try{let De;if(fe&&W)De=await Ce.workflows.getById(W);else if(Oe)De=await Ce.workflows.getOrCreateByShot(j,l,se,Q);else if(qe)De=await Ce.workflows.getOrCreateByEpisode(j,l);else{if(!s)return;De=await Ce.workflows.getOrCreateByProject(s)}const Pe=De.data;Pe.canEdit===!1||Pe.canEdit===void 0&&Pe.isOwner===!1?(P(!0),E.current=!0,(o=Pe.shareInfo)!=null&&o.owner&&a(Pe.shareInfo.owner)):(P(!1),E.current=!1,a(null)),Pe.currentUserId&&(c(Pe.currentUserId),d.current=Pe.currentUserId);const Fe=Pe.isOwner!==!1||Oe&&Pe.canEdit===!0;f(Fe);const rt=fe||Pe.hasCollaborators===!0;if(g(rt),w.current=Pe.id,fe&&ge({id:Pe.projectId||W,name:Pe.name||"å…±äº«å·¥ä½œæµ",description:Pe.description,type:"QUICK",status:"DRAFT"}),Pe.data){const{nodes:Xe,edges:Le,nodeGroups:ft}=Pe.data;if(ft&&ft.length>0&&(yt(ft),_t.current=ft),Xe&&Xe.length>0){let Lt=Xe;if(Oe&&((I=xe==null?void 0:xe.scriptJson)!=null&&I.acts))try{const Nt=xe.scriptJson.acts.find(ze=>Number(ze.actIndex)===Number(se)),Ht=(L=Nt==null?void 0:Nt.shots)==null?void 0:L.find(ze=>Number(ze.shotIndex)===Number(Q)),lt=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(ze=>{ze.nodeId&&lt.add(ze.nodeId)}),(X=Ht.media)!=null&&X.nodeId&&lt.add(Ht.media.nodeId)),Lt=Xe.map(ze=>{var nt;return ze.type==="videoPreview"&&((nt=ze.data)!=null&&nt.addedToStoryboard)&&!lt.has(ze.id)?{...ze,data:{...ze.data,addedToStoryboard:!1}}:ze})}catch{}let Ut;if(Oe&&((K=xe==null?void 0:xe.scriptJson)!=null&&K.acts))try{const Nt=xe.scriptJson.acts.find(lt=>Number(lt.actIndex)===Number(se)),Ht=(ke=Nt==null?void 0:Nt.shots)==null?void 0:ke.find(lt=>Number(lt.shotIndex)===Number(Q));Ut=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Ot=new Set((ft||[]).filter(mt=>!mt.hidden).flatMap(mt=>mt.nodeIds||[])),pt=Lt.map(mt=>{const Nt=ft?ft.find(ze=>ze.nodeIds.includes(mt.id)):null,Ht=n.length>0?n:mt.data.models||[],lt=mt.type==="agent"&&Ut?{...mt.data,output:Ut,lastOutput:Ut}:mt.data;return{...mt,data:{...lt,models:Ht,onOpenAssetPanel:mt.type==="assetSelector"?mt.data.onOpenAssetPanel||ar:mt.data.onOpenAssetPanel,workflowContext:{project:be,episode:xe,nodeGroup:Nt,nodeGroups:ft||[]}},draggable:mt.draggable!==!1,connectable:Ot.has(mt.id)?!1:mt.connectable!==!1,deletable:Ot.has(mt.id)?!1:mt.deletable!==!1}});R(pt)}if(Le&&Le.length>0){const Lt=new Set(Xe.map(pt=>pt.id)),Ut=new Map(Xe.map(pt=>[pt.id,pt.type])),Ot=Le.filter(pt=>{if(!Lt.has(pt.source)||!Lt.has(pt.target))return!1;const mt=Ut.get(pt.target),Nt=Ut.get(pt.source);return!(mt==="midjourney"&&pt.targetHandle==="text-input"&&Nt!=="agent")}).map(pt=>({...pt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:pt.targetHandle||void 0}));b(Ot)}}}catch{}};t.useEffect(()=>{n.length>0&&U.length>0&&R(o=>o.map(I=>({...I,data:{...I.data,models:n},draggable:I.draggable!==void 0?I.draggable:!0,deletable:I.deletable!==void 0?I.deletable:!0})))},[n,U.length]),t.useEffect(()=>{if(!be&&!xe||U.length===0)return;if(U.some(I=>{var De,Pe;const L=I.data.workflowContext,X=((De=L==null?void 0:L.project)==null?void 0:De.id)!==(be==null?void 0:be.id),K=((Pe=L==null?void 0:L.episode)==null?void 0:Pe.id)!==(xe==null?void 0:xe.id),ke=(L==null?void 0:L.nodeGroups)!==_t.current;return!L||X||K||ke})){const I=se&&Q&&_t.current.find(L=>L.scene===se&&L.shot===Q)||null;R(L=>L.map(X=>{const K=_t.current.find(De=>De.nodeIds.includes(X.id))||null,ke=I||K;return{...X,data:{...X.data,workflowContext:{project:be,episode:xe,nodeGroup:ke,nodeGroups:_t.current}}}}))}},[be,xe,se,Q,U.length,Ke]);const Os=async(o,I,L)=>{var X;if(!(!j||!l))try{const K=o.find(Fe=>Fe.type==="agent");if(!K)return;const ke=((X=K.data)==null?void 0:X.output)||"",Pe=(await Ce.episodes.getById(j,l)).scriptJson;if(!Pe||!Pe.acts)return;const He=Pe.acts.map(Fe=>{var rt;return Fe.actIndex===I?{...Fe,shots:(rt=Fe.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===L&&Xe.æç¤ºè¯!==ke?{...Xe,æç¤ºè¯:ke}:Xe)}:Fe});await Ce.episodes.update(j,l,{scriptJson:{acts:He}})}catch{}},ks=async()=>{if(!(z||E.current)&&!(te.current.length===0&&Me.current.length===0))try{const o=te.current.map(L=>{const{data:X,...K}=L,{workflowContext:ke,_canEdit:De,_currentUserId:Pe,...He}=X||{};return{...K,data:He}}),I=Me.current.map(L=>({id:L.id,source:L.source,target:L.target,sourceHandle:L.sourceHandle,targetHandle:L.targetHandle,type:L.type}));if(Oe){await Ce.workflows.saveShot(j,l,se,Q,{nodes:o,edges:I,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}});try{await Os(te.current,se,Q)}catch{}}else qe?await Ce.workflows.saveEpisode(j,l,{nodes:o,edges:I,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}}):fe&&W?await Ce.workflows.update(W,{data:{nodes:o,edges:I,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}}}):s&&await Ce.workflows.save(s,{nodes:o,edges:I,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}})}catch{}},ms=t.useRef(null),qs=t.useCallback(()=>{ms.current&&clearTimeout(ms.current),ms.current=setTimeout(()=>{ks()},2e3)},[]);t.useEffect(()=>{const o=I=>{if(E.current)return;it.current&&clearTimeout(it.current);const X=I.detail;X!=null&&X.nodeId&&(X!=null&&X.config)&&(te.current=te.current.map(K=>{var ke;return K.id===X.nodeId?{...K,data:{...K.data,config:{...((ke=K.data)==null?void 0:ke.config)||{},...X.config}}}:K})),setTimeout(()=>{ks()},100)};return window.addEventListener("workflow:save",o),()=>{window.removeEventListener("workflow:save",o)}},[]),t.useEffect(()=>{if(be||xe){let o=_t.current;Oe&&se&&Q&&(o=_t.current.filter(I=>I.scene===se&&I.shot===Q)),window.__workflowContext={project:be,episode:xe,nodeGroups:o}}},[be,xe,Ke,Oe,se,Q]);const Gs=async()=>{try{if(fe){window.__workflowContext={project:null,episode:null,nodeGroups:_t.current};return}if(qe){const[o,I]=await Promise.all([Ce.episodes.getById(j,l),Ce.projects.getById(j)]);Ie(o.data),ge(I.data);let L=_t.current;Oe&&se&&Q&&(L=_t.current.filter(X=>X.scene===se&&X.shot===Q)),window.__workflowContext={project:I.data,episode:o.data,nodeGroups:L}}else{const o=await Ce.projects.getById(s);ge(o.data);let I=_t.current;Oe&&se&&Q&&(I=_t.current.filter(L=>L.scene===se&&L.shot===Q)),window.__workflowContext={project:o.data,episode:null,nodeGroups:I}}}catch{m.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),T("/quick")}finally{ee(!1)}},Jr=async()=>{try{const o=await Ce.get("/ai/models",{params:{isActive:"true"}});F(o||[])}catch{}};t.useEffect(()=>{R(o=>o.map(I=>{const L=String(I.type||"");return!L.startsWith("aiVideo")&&L!=="audioVoice"&&L!=="voiceClone"&&L!=="audioSynthesize"&&L!=="audioDesign"?I:{...I,data:{...I.data,models:n}}}))},[n,R]);const qr=async()=>{try{const I=(await Ce.agents.getAll()).filter(L=>L.isActive&&(!L.usageScene||L.usageScene==="workflow"));B(I)}catch{}};t.useEffect(()=>{R(o=>o.map(I=>{var Pe,He,Fe,rt,Xe;if(I.type!=="agent")return I;const L=(He=(Pe=I.data)==null?void 0:Pe.config)==null?void 0:He.agentId,X=M.find(Le=>Le.id===L),K=X==null?void 0:X.aiModelId,ke=n.find(Le=>Le.id===K);let De=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if((!De||De.length===0)&&ke){const Le=(ke.provider||"").toLowerCase(),ft=(ke.name||"").toLowerCase();(Le.includes("google")||ft.includes("gemini"))&&(De=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(De)&&De.length>0){const Le=(Xe=(rt=I.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,ft=Lt=>Lt.map(Ut=>Ut.toUpperCase()).sort().join(",");if(!Le||ft(Le)!==ft(De))return{...I,data:{...I.data,config:{...I.data.config,acceptedInputs:De}}}}return I}))},[M,n,R]);const Kr=t.useCallback(o=>{var Pe,He,Fe,rt,Xe,Le,ft,Lt,Ut,Ot,pt,mt,Nt,Ht,lt,ze,nt;Zt.current=!1;const I=_t.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.source||""))}),L=_t.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.target||""))});if(I||L){m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Zt.current=!1;return}const X=U.find(dt=>dt.id===o.source),K=U.find(dt=>dt.id===o.target);if(X&&K){const dt=Rt=>{var ve,Je,jt;const ot=Rt.type,Ze=Rt.data;if(ot==="upload"&&Array.isArray((ve=Ze.config)==null?void 0:ve.uploadedFiles)&&Ze.config.uploadedFiles.length>0){const $t=Ze.config.uploadedFiles,Ye=$t.some(Et=>{const Yt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Yt==="VIDEO"||js.startsWith("video/")}),It=$t.some(Et=>{const Yt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Yt==="IMAGE"||js.startsWith("image/")}),xt=$t.some(Et=>{const Yt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Yt==="AUDIO"||js.startsWith("audio/")});return(K==null?void 0:K.type)==="aiVideo_swap"?Ye?"VIDEO":It?"IMAGE":xt?"AUDIO":null:It?"IMAGE":Ye?"VIDEO":xt?"AUDIO":null}if(ot==="assetSelector"){if((Je=Ze.config)!=null&&Je.subjects)return"IMAGE";if((jt=Ze.config)!=null&&jt.selectedAsset){const $t=Ze.config.selectedAsset,Ye=($t.type||"").toUpperCase(),It=($t.mimeType||"").toLowerCase();return Ye==="IMAGE"||It.startsWith("image/")?"IMAGE":Ye==="VIDEO"||It.startsWith("video/")?"VIDEO":Ye==="AUDIO"||It.startsWith("audio/")?"AUDIO":Ye||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=dt(X);let qt=(Pe=K.data.config)==null?void 0:Pe.acceptedInputs;if(K.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const Rt={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${Rt[at]||at}è¾“å…¥`),Zt.current=!1;return}if((!qt||qt.length===0)&&K.data.type==="agent"){const Rt=(He=K.data.config)==null?void 0:He.agentId,ot=M.find(jt=>jt.id===Rt),Ze=ot==null?void 0:ot.aiModelId,ve=n.find(jt=>jt.id===Ze),Je=(Fe=ve==null?void 0:ve.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)qt=Je;else{const jt=((rt=ve==null?void 0:ve.provider)==null?void 0:rt.toLowerCase())||"",$t=((ve==null?void 0:ve.name)||"").toLowerCase();(jt.includes("google")||$t.includes("gemini"))&&(qt=["TEXT","IMAGE","DOCUMENT"])}}if(K.type!=="agent"){if(!K.type.startsWith("aiVideo")&&qt&&qt.length>0&&at){const Rt=qt.map(Ze=>typeof Ze=="string"?Ze.toUpperCase():Ze),ot=typeof at=="string"?at.toUpperCase():at;if(!Rt.includes(ot)){const Ze={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${Ze[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${Rt.map(ve=>Ze[ve]||ve).join("ã€")}ï¼‰`),Zt.current=!1;return}}}if(K.type==="aiVideo_swap"){const Rt=p.filter(jt=>jt.target===K.id),ot=Rt.filter(jt=>{const $t=U.find(It=>It.id===jt.source);return dt($t)==="VIDEO"}).length,Ze=Rt.filter(jt=>{const $t=U.find(It=>It.id===jt.source);return dt($t)==="IMAGE"}).length,ve=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="IMAGE"?1:0);if(ve>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){m.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Zt.current=!1;return}}if(K.type==="aiVideo_lipsync"){const Rt=p.filter($t=>$t.target===K.id),ot=Rt.filter($t=>{const Ye=U.find(xt=>xt.id===$t.source);return dt(Ye)==="VIDEO"}).length,Ze=Rt.filter($t=>{const Ye=U.find(xt=>xt.id===$t.source);return dt(Ye)==="AUDIO"}).length,ve=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="AUDIO"?1:0),jt=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ve>1||Je>1||!jt){m.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Zt.current=!1;return}}if(K.type.startsWith("aiVideo")&&K.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(Ze=>{const ve=(Ze||"").toLowerCase().replace(/[_\-\s]+/g," ");return ve?ve.includes("æ–‡ç”Ÿ")||ve.includes("text to video")||ve.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("é¦–å°¾")||ve.includes("first last")||ve.includes("two frame")||ve.includes("frame pair")?"é¦–å°¾å¸§":ve.includes("é¦–å¸§")||ve.includes("first frame")||ve.includes("start frame")||ve.includes("initial frame")||ve.includes("keyframe")?"é¦–å¸§":ve.includes("å°¾å¸§")||ve.includes("last frame")||ve.includes("end frame")||ve.includes("final frame")?"å°¾å¸§":ve.includes("ä¸»ä½“å‚è€ƒ")||ve.includes("subject reference")||ve.includes("å‚è€ƒ")||ve.includes("reference image")||ve.includes("image reference")||ve.includes("ref image")?"å‚è€ƒå›¾":Ze||"":""})((Le=(Xe=K.data)==null?void 0:Xe.config)==null?void 0:Le.generationType);if(K.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){m.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Zt.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&X.type==="assetSelector"){const Ze=((ft=X.data)==null?void 0:ft.config)||{};if(Ze.subjects&&Ze.subjects.length>0&&(Ze.subjects[0].images||[]).length>1){m.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Zt.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&X.type==="assetSelector"){const Ze=((Lt=X.data)==null?void 0:Lt.config)||{};if(Ze.subjects&&Ze.subjects.length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Zt.current=!1;return}}}if(K.type==="aiVideo_style"){const Ze=p.filter(ve=>ve.target===K.id).filter(ve=>{const Je=U.find($t=>$t.id===ve.source);return dt(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){m.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Zt.current=!1;return}if(Ze>1){m.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Zt.current=!1;return}}if(K.type.startsWith("aiVideo")&&at==="TEXT"&&p.filter(Ze=>Ze.target===K.id).find(Ze=>{const ve=U.find(Je=>Je.id===Ze.source);return(ve==null?void 0:ve.type)==="agent"})){m.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Zt.current=!1;return}if(K.type==="aiImage"){if(at==="TEXT"){if(p.filter(Ze=>Ze.target===K.id).some(Ze=>{const ve=U.find(Je=>Je.id===Ze.source);return(ve==null?void 0:ve.type)==="agent"})){m.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Zt.current=!1;return}}else if(at==="IMAGE"){const ot=p.filter(Ye=>Ye.target===K.id).reduce((Ye,It)=>{var Yt,js,es,Rs,As,Mr,Dr;const xt=U.find(cs=>cs.id===It.source),Et=(xt==null?void 0:xt.type)||"";if(Et==="upload"){const cs=((es=(js=(Yt=xt==null?void 0:xt.data)==null?void 0:Yt.config)==null?void 0:js.uploadedFiles)==null?void 0:es[0])||null,fa=((cs==null?void 0:cs.type)||"").toUpperCase(),ma=((cs==null?void 0:cs.mimeType)||"").toLowerCase();return Ye+(fa==="IMAGE"||ma.startsWith("image/")?1:0)}if(Et==="assetSelector"){const cs=((Rs=xt==null?void 0:xt.data)==null?void 0:Rs.config)||{};return cs.selectedAsset&&(Ye+=(cs.selectedAsset.type||"").toUpperCase()==="IMAGE"||(cs.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(cs.subjects)&&cs.subjects.length>0?Ye+((cs.subjects[0].images||[]).length||0):Ye}if(Et==="aiImage"){const cs=(Mr=(As=xt==null?void 0:xt.data)==null?void 0:As.config)==null?void 0:Mr.generatedImageUrl;return Ye+(cs?1:0)}if(Et==="imagePreview"){const cs=(Dr=xt==null?void 0:xt.data)==null?void 0:Dr.imageUrl;return Ye+(cs?1:0)}return Ye},0);let Ze=1;if(X.type==="assetSelector"){const Ye=((Ut=X==null?void 0:X.data)==null?void 0:Ut.config)||{};Ye.selectedAsset?Ze=(Ye.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ye.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Ye.subjects)&&Ye.subjects.length>0&&(Ze=(Ye.subjects[0].images||[]).length||0)}else if(X.type==="upload"){const Ye=((mt=(pt=(Ot=X==null?void 0:X.data)==null?void 0:Ot.config)==null?void 0:pt.uploadedFiles)==null?void 0:mt[0])||null,It=((Ye==null?void 0:Ye.type)||"").toUpperCase(),xt=((Ye==null?void 0:Ye.mimeType)||"").toLowerCase();Ze=It==="IMAGE"||xt.startsWith("image/")?1:0}else X.type==="aiImage"?Ze=((Ht=(Nt=X==null?void 0:X.data)==null?void 0:Nt.config)==null?void 0:Ht.generatedImageUrl)?1:0:X.type==="imagePreview"&&(Ze=((lt=X==null?void 0:X.data)==null?void 0:lt.imageUrl)?1:0);const ve=(nt=(ze=K==null?void 0:K.data)==null?void 0:ze.config)==null?void 0:nt.modelId,Je=n.find(Ye=>Ye.id===ve),jt=(Je==null?void 0:Je.config)||{},$t=jt.maxReferenceImages||jt.supportedReferenceImagesLimit||jt.referenceImagesLimit||10;if(ot+Ze>$t){m.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${$t}å¼ ï¼‰`),Zt.current=!1;return}}}}try{const dt=U.find(ot=>ot.id===o.target),at=U.find(ot=>ot.id===o.source),qt=ot=>{var ve,Je,jt,$t;if(!ot)return null;const Ze=String(ot.type||"").toLowerCase();if(Ze==="upload"){const Ye=(((Je=(ve=ot.data)==null?void 0:ve.config)==null?void 0:Je.uploadedFiles)||[]).find(It=>{const xt=((It==null?void 0:It.type)||"").toUpperCase(),Et=((It==null?void 0:It.mimeType)||"").toLowerCase();return xt==="AUDIO"||Et.startsWith("audio/")});return(Ye==null?void 0:Ye.url)||null}if(Ze==="assetSelector"){const Ye=($t=(jt=ot.data)==null?void 0:jt.config)==null?void 0:$t.selectedAsset,It=((Ye==null?void 0:Ye.type)||"").toUpperCase(),xt=((Ye==null?void 0:Ye.mimeType)||"").toLowerCase();if(It==="AUDIO"||xt.startsWith("audio/"))return(Ye==null?void 0:Ye.url)||null}return null};if(String((dt==null?void 0:dt.type)||"")==="audioVoice"){const ot=qt(at);ot&&R(Ze=>Ze.map(ve=>ve.id===dt.id?{...ve,data:{...ve.data,config:{...ve.data.config,audioUrl:ot}}}:ve))}}catch{}const De={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{b(dt=>Ia(De,dt)),rs(De)},0),xs.current=null,Zt.current=!0},[b,U,M,n,p,rs]),Yr=t.useCallback((o,I)=>{const L=_t.current.some(K=>{var ke;return!K.hidden&&((ke=K.nodeIds)==null?void 0:ke.includes(I.source))}),X=_t.current.some(K=>{var ke;return!K.hidden&&((ke=K.nodeIds)==null?void 0:ke.includes(I.target))});if(L||X){m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}b(K=>K.filter(ke=>ke.id!==I.id)),ys(I.id),m.success("å·²æ–­å¼€è¿æ¥")},[b,ys]),vr=t.useCallback(o=>{var X,K,ke,De,Pe,He,Fe,rt,Xe,Le,ft,Lt,Ut,Ot,pt;it.current&&clearTimeout(it.current);try{const mt=localStorage.getItem("suppressedPreviewTasks")||"[]",Nt=JSON.parse(mt),Ht=ze=>{Nt.push(ze)};for(const ze of Array.isArray(o)?o:[])if((ze==null?void 0:ze.type)==="imagePreview"){const nt=(K=(X=ze==null?void 0:ze.data)==null?void 0:X.midjourneyData)==null?void 0:K.sourceNodeId,dt=(De=(ke=ze==null?void 0:ze.data)==null?void 0:ke.midjourneyData)==null?void 0:De.taskId,at=(He=(Pe=ze==null?void 0:ze.data)==null?void 0:Pe.midjourneyData)==null?void 0:He.messageId;if(nt||dt||at)Ht({sourceNodeId:nt,taskId:dt,messageId:at});else{const qt=Me.current.find(Rt=>Rt.target===ze.id);if(qt){const Rt=te.current.find(Ze=>Ze.id===qt.source),ot=(rt=(Fe=Rt==null?void 0:Rt.data)==null?void 0:Fe.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((ze==null?void 0:ze.type)==="videoPreview"){const nt=Me.current.find(dt=>dt.target===ze.id);if(nt){const dt=te.current.find(qt=>qt.id===nt.source),at=(Le=(Xe=dt==null?void 0:dt.data)==null?void 0:Xe.config)==null?void 0:Le.taskId;at&&Ht({taskId:at})}}const lt=Nt.slice(Math.max(0,Nt.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(lt))}catch{}try{const mt=[];for(const Nt of Array.isArray(o)?o:[]){const Ht=(Ut=(Lt=(ft=Nt==null?void 0:Nt.data)==null?void 0:ft.workflowContext)==null?void 0:Lt.project)==null?void 0:Ut.name;(Nt==null?void 0:Nt.type)==="imagePreview"&&((Ot=Nt==null?void 0:Nt.data)!=null&&Ot.imageUrl)?mt.push(Ce.post("/assets/recycle/record",{url:Nt.data.imageUrl,type:"IMAGE",projectName:Ht})):(Nt==null?void 0:Nt.type)==="videoPreview"&&((pt=Nt==null?void 0:Nt.data)!=null&&pt.videoUrl)&&mt.push(Ce.post("/assets/recycle/record",{url:Nt.data.videoUrl,type:"VIDEO",projectName:Ht}))}mt.length>0&&Promise.allSettled(mt).then(()=>{})}catch{}const I=Array.isArray(o)?o.length:0,L=Ge.current;setTimeout(()=>{const mt=te.current.length,Nt=Math.max(L-I,0);mt===Nt&&ks()},100)},[]),Qr=t.useCallback(o=>{const I=o.filter(X=>_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(X.id))})?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(I.length===0)return;if(r){vr(I),I.forEach(X=>Wt(X.id));return}const L=I.filter(X=>{var De;const K=(De=X.data)==null?void 0:De.createdBy;return(typeof K=="object"?K==null?void 0:K.id:K)===d.current});L.length>0&&(vr(L),L.forEach(X=>Wt(X.id)))},[r,vr,Wt]),_r=t.useCallback(o=>{it.current&&clearTimeout(it.current),setTimeout(()=>{qs()},250)},[]),Zr=t.useCallback(o=>{const I=o.filter(L=>{if(L.type!=="remove")return!0;const X=Me.current.find(De=>De.id===L.id);if(!X)return!0;const K=_t.current.some(De=>{var Pe;return!De.hidden&&((Pe=De.nodeIds)==null?void 0:Pe.includes(X.source))}),ke=_t.current.some(De=>{var Pe;return!De.hidden&&((Pe=De.nodeIds)==null?void 0:Pe.includes(X.target))});return K||ke?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});_(I)},[_]),ea=t.useCallback(o=>{const I=o.filter(L=>{const X=_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(L.source))}),K=_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(L.target))});return X||K?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});I.length>0&&(_r(I),I.forEach(L=>ys(L.id)))},[_r,ys]),ta=t.useCallback(o=>{if(o.preventDefault(),z)return;const I=200,L=400,X=10;let K=o.clientX,ke=o.clientY;K+I+X>window.innerWidth&&(K=window.innerWidth-I-X),ke+L+X>window.innerHeight&&(ke=window.innerHeight-L-X),K=Math.max(X,K),ke=Math.max(X,ke),i({x:K,y:ke})},[z]),hr=t.useCallback(()=>{i(null),ue(),H(!1)},[]),ar=t.useCallback(o=>{gt(o),At(!0)},[]);t.useEffect(()=>{U.length>0&&U.some(I=>I.type==="assetSelector"&&!I.data.onOpenAssetPanel)&&R(I=>I.map(L=>L.type==="assetSelector"&&!L.data.onOpenAssetPanel?{...L,data:{...L.data,onOpenAssetPanel:ar,models:L.data.models||n}}:L))},[U.length,ar,n]);const sa=t.useCallback(o=>{ct&&(R(I=>I.map(X=>X.id===ct?{...X,data:{...X.data,config:{...X.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(K=>K.url)}],referenceImages:o.images.map(K=>({id:K.id,url:K.url,name:K.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:X)),At(!1),gt(null),m.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[ct,R]),Tr=o=>{const L={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",X=L==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:L==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:L==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:L==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],K=n.filter(He=>He.type==="VIDEO_GENERATION"),ke=n.filter(He=>He.type==="VIDEO_EDITING"),De=He=>{const Fe=(He||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Pe=null;return L==="è§†é¢‘æ¢äºº"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||K.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Le=>De(Le)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):L==="å¯¹å£å‹"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:L==="é£æ ¼è½¬æ¢"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Pe=K.find(He=>{var rt;const Fe=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>De(Xe)):[];return L==="é¦–å¸§"||L==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(L)}),{modelId:Pe==null?void 0:Pe.id,modelName:Pe==null?void 0:Pe.name,generationType:L,lockedGenerationType:L,hideGenerationTypeSelector:!0,acceptedInputs:X}},ns=(o,I,L,X,K,ke,De,Pe)=>{if(!u)return;const He=Re({x:u.x,y:u.y}),Fe=`${o}-${Date.now()}`,rt=Kt?Ke.find(Ut=>Ut.id===Kt)||null:Ke.find(Ut=>Ut.nodeIds.includes(Fe))||null,Xe=L==="aiImage"||L.startsWith("aiVideo")||L==="midjourney",Le=L.startsWith("aiVideo")?Tr(L):{},ft=X?{agentId:X}:Le;L.startsWith("aiVideo"),L.startsWith("aiVideo")&&Pe&&Object.assign(ft,Pe);const Lt={id:Fe,type:L,position:He,data:{label:K||I,type:o,config:ft,models:n,isExpanded:Xe,onOpenAssetPanel:L==="assetSelector"?ar:void 0,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0,workflowContext:{project:be,episode:xe,nodeGroup:rt,nodeGroups:Ke}}};R(Ut=>[...Ut,Lt]),Tt(Lt),Kt&&(yt(Ut=>Ut.map(Ot=>{if(Ot.id!==Kt)return Ot;const pt=Array.from(new Set([...Ot.nodeIds||[],Fe])),mt=xr(pt)||Ot.bounds;return{...Ot,nodeIds:pt,bounds:mt}})),_t.current=_t.current.map(Ut=>{if(Ut.id!==Kt)return Ut;const Ot=Array.from(new Set([...Ut.nodeIds||[],Fe])),pt=xr(Ot)||Ut.bounds;return{...Ut,nodeIds:Ot,bounds:pt}})),hr(),m.success(`å·²æ·»åŠ ${K||I}èŠ‚ç‚¹`),L==="assetSelector"&&setTimeout(()=>{ar(Lt.id)},100)},[is,Ks]=t.useState(null),Zt=t.useRef(!1),xs=t.useRef(null),Ys=t.useMemo(()=>{var Pe,He,Fe,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const I=is.handleType==="target",L=Xe=>{const Le=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return Le?Le.includes("æ–‡ç”Ÿ")||Le.includes("text to video")||Le.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Le.includes("é¦–å°¾")||Le.includes("first last")||Le.includes("two frame")||Le.includes("frame pair")?"é¦–å°¾å¸§":Le.includes("é¦–å¸§")||Le.includes("first frame")||Le.includes("start frame")||Le.includes("initial frame")||Le.includes("keyframe")?"é¦–å¸§":Le.includes("å°¾å¸§")||Le.includes("last frame")||Le.includes("end frame")||Le.includes("final frame")?"å°¾å¸§":Le.includes("ä¸»ä½“å‚è€ƒ")||Le.includes("subject reference")||Le.includes("å‚è€ƒ")||Le.includes("reference image")||Le.includes("image reference")||Le.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(I){const Xe=U.find(Ot=>Ot.id===is.sourceNodeId),Le=(Xe==null?void 0:Xe.type)||"",ft=Le.startsWith("aiVideo"),Lt=L((He=(Pe=Xe==null?void 0:Xe.data)==null?void 0:Pe.config)==null?void 0:He.generationType),Ut=Le==="aiVideo_t2v"||Lt==="æ–‡ç”Ÿè§†é¢‘";if(Le==="aiImage"){const Ot=p.filter(nt=>nt.target===(Xe==null?void 0:Xe.id)),pt=Ot.some(nt=>{const dt=U.find(at=>at.id===nt.source);return((dt==null?void 0:dt.type)||"")==="agent"}),mt=Ot.reduce((nt,dt)=>{var Rt,ot,Ze,ve;const at=U.find(Je=>Je.id===dt.source),qt=(at==null?void 0:at.type)||"";if(qt==="upload"){const Je=((Ze=(ot=(Rt=at==null?void 0:at.data)==null?void 0:Rt.config)==null?void 0:ot.uploadedFiles)==null?void 0:Ze[0])||null,jt=((Je==null?void 0:Je.type)||"").toUpperCase(),$t=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return nt+(jt==="IMAGE"||$t.startsWith("image/")?1:0)}if(qt==="assetSelector"){const Je=((ve=at==null?void 0:at.data)==null?void 0:ve.config)||{};if(Je.selectedAsset)return nt+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return nt+((Je.subjects[0].images||[]).length||0)}return nt},0),Nt=(rt=(Fe=Xe==null?void 0:Xe.data)==null?void 0:Fe.config)==null?void 0:rt.modelId,Ht=n.find(nt=>nt.id===Nt),lt=(Ht==null?void 0:Ht.config)||{},ze=lt.maxReferenceImages||lt.supportedReferenceImagesLimit||lt.referenceImagesLimit||10;return pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=ze?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(ft){const Ot=p.filter(ze=>ze.target===(Xe==null?void 0:Xe.id)),pt=Ot.some(ze=>{const nt=U.find(dt=>dt.id===ze.source);return((nt==null?void 0:nt.type)||"")==="agent"}),mt=Ot.reduce((ze,nt)=>{var qt,Rt,ot,Ze;const dt=U.find(ve=>ve.id===nt.source),at=(dt==null?void 0:dt.type)||"";if(at==="aiImage"||at==="imagePreview")return ze+1;if(at==="upload"){const ve=((ot=(Rt=(qt=dt==null?void 0:dt.data)==null?void 0:qt.config)==null?void 0:Rt.uploadedFiles)==null?void 0:ot[0])||null,Je=((ve==null?void 0:ve.type)||"").toUpperCase(),jt=((ve==null?void 0:ve.mimeType)||"").toLowerCase();return ze+(Je==="IMAGE"||jt.startsWith("image/")?1:0)}if(at==="assetSelector"){const ve=((Ze=dt==null?void 0:dt.data)==null?void 0:Ze.config)||{};if(ve.selectedAsset)return ze+((ve.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ve.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ve.subjects&&ve.subjects.length>0)return ze+((ve.subjects[0].images||[]).length||0)}return ze},0);return Ut?pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Le==="aiVideo_i2v_first"||Le==="aiVideo_i2v_last"||Lt==="é¦–å¸§"||Lt==="å°¾å¸§"?pt&&mt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Le==="aiVideo_first_last"||Lt==="é¦–å°¾å¸§"?pt&&mt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Le==="aiVideo_reference"||Lt==="å‚è€ƒå›¾"?pt&&mt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const X=U.find(Xe=>Xe.id===is.sourceNodeId),ke=(Xe=>{var Lt,Ut,Ot;if(!Xe)return null;const Le=Xe.type,ft=Xe.data;if(Le==="upload"&&Array.isArray((Lt=ft.config)==null?void 0:Lt.uploadedFiles)&&ft.config.uploadedFiles.length>0){const pt=ft.config.uploadedFiles;return pt.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="IMAGE"||nt.startsWith("image/")})?"IMAGE":pt.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="VIDEO"||nt.startsWith("video/")})?"VIDEO":pt.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="AUDIO"||nt.startsWith("audio/")})?"AUDIO":null}if(Le==="assetSelector"){if((Ut=ft.config)!=null&&Ut.subjects)return"IMAGE";if((Ot=ft.config)!=null&&Ot.selectedAsset){const pt=ft.config.selectedAsset,mt=(pt.type||"").toUpperCase(),Nt=(pt.mimeType||"").toLowerCase();return mt==="IMAGE"||Nt.startsWith("image/")?"IMAGE":mt==="VIDEO"||Nt.startsWith("video/")?"VIDEO":mt==="AUDIO"||Nt.startsWith("audio/")?"AUDIO":mt||null}}return Le==="aiImage"||Le==="imagePreview"||Le==="midjourney"?"IMAGE":(Le||"").startsWith("aiVideo")||Le==="videoPreview"?"VIDEO":Le==="agent"||Le==="textPreview"?"TEXT":null})(X),De=X==null?void 0:X.type;return De==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:De==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ke==="TEXT",showAiImage:ke==="IMAGE"||ke==="TEXT",showAudio:ke==="AUDIO",showVideo:ke==="VIDEO"||ke==="IMAGE"||ke==="TEXT",showEdit:ke==="VIDEO",showImageEditing:ke==="IMAGE",showMidjourney:ke==="IMAGE"||ke==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ke==="IMAGE"}},[is,U,p,n]),ra=t.useCallback((o,{nodeId:I,handleType:L})=>{if(!I){xs.current=null;return}if(L==="target"){const X=U.find(ke=>ke.id===I),K=(X==null?void 0:X.type)||"";if(K==="agent"||K==="aiImage"||K==="midjourney"||K.startsWith("aiVideo")){m.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),xs.current=null;return}}if(L==="source"){const X=U.find(K=>K.id===I);if(X&&(X.type==="aiImage"||X.type.startsWith("aiVideo"))){xs.current=null;return}}Zt.current=!1,xs.current={nodeId:I,handleType:L==="target"?"target":"source"},hr(),Ks(null)},[hr,U]),aa=t.useCallback(o=>{const I=xs.current;if(!I)return;let L=0,X=0;"changedTouches"in o&&o.changedTouches.length>0?(L=o.changedTouches[0].clientX,X=o.changedTouches[0].clientY):"clientX"in o&&(L=o.clientX,X=o.clientY),setTimeout(()=>{if(Zt.current){Zt.current=!1,xs.current=null;return}const K=o.target,ke=!!K&&!!K.closest(".react-flow__pane"),De=!!K&&(K.closest(".react-flow__node")||K.closest(".react-flow__handle"));if(!ke||De){Zt.current=!1,xs.current=null;return}Ks({x:L,y:X,sourceNodeId:I.nodeId,handleType:I.handleType}),Zt.current=!1},100),xs.current=null},[]),ls=(o,I,L,X,K,ke)=>{var Lt,Ut,Ot,pt,mt,Nt,Ht;if(!is)return;const De=Re({x:is.x,y:is.y}),Pe=`${L}-${Date.now()}`,He=U.find(lt=>lt.id===is.sourceNodeId),Fe=He?Ke.find(lt=>lt.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?Tr(o):{};let Le={};X?Le={agentId:X}:o.startsWith("aiVideo")?Le=Xe:o==="smartStoryboard"?Le={taskId:"",aspectRatio:"1:1",inputImages:[],userPrompt:""}:o==="hdUpscale"?Le={taskId:"",imageSize:"4K"}:o==="imageFusion"&&(Le={taskId:"",imageSize:"4K"}),o.startsWith("aiVideo")&&ke&&Object.assign(Le,ke);const ft={id:Pe,type:o,position:De,data:{label:K||I,type:L,config:Le,models:n,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0,workflowContext:{project:be,episode:xe,nodeGroup:Fe,nodeGroups:Ke}}};if(R(lt=>[...lt,ft]),Fe&&(yt(lt=>lt.map(ze=>{if(ze.id!==Fe.id)return ze;const nt=Array.from(new Set([...ze.nodeIds,Pe]));return{...ze,nodeIds:nt}})),_t.current=_t.current.map(lt=>{if(lt.id!==Fe.id)return lt;const ze=Array.from(new Set([...lt.nodeIds,Pe]));return{...lt,nodeIds:ze}})),is.handleType==="source"){const lt=U.find(ve=>ve.id===is.sourceNodeId),ze=ft,nt=ve=>{const Je=(ve||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ve||"":""},dt=ve=>{var $t,Ye,It;const Je=ve.type,jt=ve.data;if(Je==="upload"&&Array.isArray(($t=jt.config)==null?void 0:$t.uploadedFiles)&&jt.config.uploadedFiles.length>0){const xt=jt.config.uploadedFiles,Et=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="VIDEO"||As.startsWith("video/")}),Yt=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="IMAGE"||As.startsWith("image/")}),js=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="AUDIO"||As.startsWith("audio/")});return(ze==null?void 0:ze.type)==="aiVideo_swap"?Et?"VIDEO":Yt?"IMAGE":js?"AUDIO":null:Yt?"IMAGE":Et?"VIDEO":js?"AUDIO":null}if(Je==="assetSelector"){if((Ye=jt.config)!=null&&Ye.subjects)return"IMAGE";if((It=jt.config)!=null&&It.selectedAsset){const xt=jt.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Yt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Yt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Yt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":Et||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ve=>{var jt,$t,Ye;if(dt(ve)!=="IMAGE")return 0;if(ve.type==="upload")return((($t=(jt=ve.data)==null?void 0:jt.config)==null?void 0:$t.uploadedFiles)||[]).filter(xt=>xt.type==="IMAGE"||(xt.mimeType||"").startsWith("image/")).length;if(ve.type==="assetSelector"){const It=((Ye=ve.data)==null?void 0:Ye.config)||{};return It.subjects&&It.subjects.length>0?(It.subjects[0].images||[]).length:It.selectedAsset&&It.selectedAsset.type==="IMAGE"?1:0}return ve.type==="imagePreview"||ve.type==="aiImage",1},qt=ve=>{var xt,Et,Yt,js,es,Rs;const Je=nt((Et=(xt=ve.data)==null?void 0:xt.config)==null?void 0:Et.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const jt=(js=(Yt=ve.data)==null?void 0:Yt.config)==null?void 0:js.modelId,Ye=(((es=ve.data)==null?void 0:es.models)||n).find(As=>As.id===jt),It=Array.isArray((Rs=Ye==null?void 0:Ye.config)==null?void 0:Rs.supportedGenerationTypes)?Ye.config.supportedGenerationTypes.map(As=>nt(As)):[];return It.includes("å‚è€ƒå›¾")||It.includes("ä¸»ä½“å‚è€ƒ")?7:It.includes("é¦–å°¾å¸§")?2:It.includes("é¦–å¸§")||It.includes("å°¾å¸§")?1:(It.includes("æ–‡ç”Ÿè§†é¢‘"),0)},Rt=lt?dt(lt):null;if(ze.type.startsWith("aiVideo")&&Rt==="IMAGE"){if(nt((Ut=(Lt=ze.data)==null?void 0:Lt.config)==null?void 0:Ut.generationType)==="é¦–å°¾å¸§"&&lt&&lt.type==="assetSelector"){const xt=((Ot=lt.data)==null?void 0:Ot.config)||{};if(xt.subjects&&(((pt=xt.subjects[0])==null?void 0:pt.images)||[]).length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ks(null),xs.current=null,Zt.current=!1;return}}const Je=p.filter(xt=>xt.target===ze.id);let jt=0;Je.forEach(xt=>{const Et=U.find(Yt=>Yt.id===xt.source);Et&&(jt+=at(Et))});const $t=lt?at(lt):0,Ye=qt(ze),It=jt+$t;if(Ye===0){m.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ks(null),xs.current=null,Zt.current=!1;return}if(It>Ye){m.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Ye}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${It}å¼ ï¼‰`),Ks(null),xs.current=null,Zt.current=!1;return}}let ot;ft.type==="superCanvas"?ot="input-image":ft.type==="midjourney"&&(Rt==="IMAGE"?ot="omni-ref":Rt==="TEXT"&&(ot="text-input"));const Ze={id:`edge-${is.sourceNodeId}-${ft.id}`,source:is.sourceNodeId,target:ft.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};b(ve=>[...ve,Ze])}else if(is.handleType==="target"){const lt=U.find(Ze=>Ze.id===is.sourceNodeId),ze=(lt==null?void 0:lt.type)||"";if(ze==="agent"||ze==="aiImage"||ze==="midjourney"||ze.startsWith("aiVideo")){m.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ks(null),xs.current=null,Zt.current=!1;return}const nt=ft,dt=U.find(Ze=>Ze.id===is.sourceNodeId),at=Ze=>{const ve=(Ze||"").toLowerCase();return ve?ve.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("é¦–å°¾")?"é¦–å°¾å¸§":ve.includes("é¦–å¸§")?"é¦–å¸§":ve.includes("å°¾å¸§")?"å°¾å¸§":ve.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ve.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ve.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("first-last")?"é¦–å°¾å¸§":ve.includes("first")?"é¦–å¸§":ve.includes("last")?"å°¾å¸§":ve.includes("subject")?"ä¸»ä½“å‚è€ƒ":ve.includes("reference")?"å‚è€ƒå›¾":Ze||"":""},Rt=(Ze=>{var jt,$t,Ye,It;const ve=Ze.type,Je=Ze.data;if(ve==="upload"&&(($t=(jt=Je.config)==null?void 0:jt.uploadedFiles)==null?void 0:$t.length)>0){const xt=Je.config.uploadedFiles[0],Et=(xt.type||"").toUpperCase(),Yt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Yt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Yt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":Et||null}if(ve==="assetSelector"){if((Ye=Je.config)!=null&&Ye.subjects)return"IMAGE";if((It=Je.config)!=null&&It.selectedAsset){const xt=Je.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Yt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Yt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Yt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":Et||null}}return ve==="aiImage"||ve==="imagePreview"?"IMAGE":ve==="aiVideo"||ve==="videoPreview"?"VIDEO":ve==="agent"?"TEXT":null})(nt);if(dt&&dt.type==="aiVideo"&&Rt==="IMAGE"&&at((Nt=(mt=dt.data)==null?void 0:mt.config)==null?void 0:Nt.generationType)==="é¦–å°¾å¸§"&&nt&&nt.type==="assetSelector"){const ve=((Ht=nt.data)==null?void 0:Ht.config)||{};if(ve.subjects&&ve.subjects.length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ks(null),xs.current=null,Zt.current=!1;return}}const ot={id:`edge-${ft.id}-${is.sourceNodeId}`,source:ft.id,sourceHandle:ft.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};b(Ze=>[...Ze,ot])}Ks(null),xs.current=null,Zt.current=!1,m.success(`å·²æ·»åŠ ${I}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(ft.id)},100)},xr=t.useCallback(o=>{const I=U.filter(Pe=>o.includes(Pe.id));if(I.length===0)return null;const L=50;let X=1/0,K=1/0,ke=-1/0,De=-1/0;return I.forEach(Pe=>{const He=Pe.position.x,Fe=Pe.position.y,rt=Pe.width||320,Xe=Pe.height||200;X=Math.min(X,He),K=Math.min(K,Fe),ke=Math.max(ke,He+rt),De=Math.max(De,Fe+Xe)}),{x:X-L,y:K-L,width:ke-X+L*2,height:De-K+L*2}},[U]),oa=t.useCallback(()=>{tr(o=>!o),er(!1)},[]),Ur=t.useCallback((o,I)=>{const L={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:I-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:le?{id:le.id,nickname:le.nickname,avatar:le.avatar}:void 0}};R(X=>[...X,L]),tr(!1)},[R,le]),na=t.useCallback(()=>{if(!r){m.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=U.filter(ke=>ke.selected);if(o.length===0){m.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){m.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const I=o.map(ke=>ke.id);if(Ke.some(ke=>ke.nodeIds.some(De=>I.includes(De)))){m.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const X=xr(I);if(!X){m.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const K={id:`group-${Date.now()}`,nodeIds:I,bounds:X};yt(ke=>{const De=[...ke,K];return Js(De),setTimeout(()=>{qs()},100),De}),wt(K.id),R(ke=>{const De=new Set;return p.forEach(Pe=>{if(I.includes(Pe.source)){const He=ke.find(Fe=>Fe.id===Pe.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&De.add(Pe.target)}}),ke.map(Pe=>I.includes(Pe.id)?{...Pe,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:K,nodeGroups:[...Ke,K]}}}:De.has(Pe.id)?{...Pe,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:K,nodeGroups:[...Ke,K]}}}:Pe)}),m.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${I.length} ä¸ªèŠ‚ç‚¹`)},[U,xr,Ke,R]),ia=t.useCallback(()=>{if(!r){m.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Be){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ke.find(I=>I.id===Be);o&&(R(I=>I.map(L=>o.nodeIds.includes(L.id)?{...L,draggable:!0,connectable:!0,deletable:!0,data:{...L.data,workflowContext:{...L.data.workflowContext,nodeGroup:null,nodeGroups:Ke.filter(X=>X.id!==Be)}}}:L)),yt(I=>{const L=I.filter(X=>X.id!==Be);return Js(L),setTimeout(()=>{qs()},100),L}),wt(null),m.success("å·²è§£é™¤ç¼–ç»„"))},[Be,Ke,R,Js]),la=t.useCallback(()=>{if(!Be){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Bs(Be),Es(!0)},[Be]),Rr=t.useCallback((o,I)=>{o.stopPropagation(),o.preventDefault(),Zs(null),wt(I),nr(null)},[]);t.useEffect(()=>{if(!ps||!Hs)return;let o=Hs.x,I=Hs.y;const L=K=>{const ke=Xs.current;if(!ke)return;const De=Z(),Pe=(K.clientX-o)/De.zoom,He=(K.clientY-I)/De.zoom;if(Math.abs(Pe)<.01&&Math.abs(He)<.01)return;const Fe=_t.current.find(rt=>rt.id===ke);Fe&&(yt(rt=>rt.map(Xe=>Xe.id===ke?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Pe,y:Xe.bounds.y+He}}:Xe)),R(rt=>rt.map(Xe=>Fe.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Pe,y:Xe.position.y+He}}:Xe)),o=K.clientX,I=K.clientY)},X=()=>{Zs(null),nr(null)};return document.addEventListener("mousemove",L),document.addEventListener("mouseup",X),()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",X)}},[ps,Hs]);const ca=t.useCallback(o=>{if(ws){const I=Re({x:o.clientX,y:o.clientY});Ur(I.x,I.y);return}hr(),Ks(null),xs.current=null,wt(null),Zt.current=!1},[hr,ws,Re,Ur]),Nr=t.useRef(null),da=t.useCallback(()=>{Ke.length>0&&!Nr.current&&(Nr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),Nr.current=null}))},[Ke.length]),ir=t.useCallback(o=>Ke.find(I=>I.nodeIds.includes(o))||null,[Ke]),ua=t.useCallback((o,I)=>{var X;if(bt||(X=I==null?void 0:I.data)!=null&&X.freeDrag)return;const L=ir(I.id);if(L){if(!L.hidden&&!r)return;Ps.current=I.id,q.current={x:I.position.x,y:I.position.y}}},[ir,r]),ga=t.useCallback((o,I)=>{var K;if(bt||(K=I==null?void 0:I.data)!=null&&K.freeDrag||!q.current||Ps.current!==I.id)return;const L=ir(I.id);if(!L)return;const X=!L.hidden;if(!(X&&!r))if(X){const ke=I.position.x-q.current.x,De=I.position.y-q.current.y,Pe=[],He=L.nodeIds||[];te.current.forEach(Fe=>{if(He.includes(Fe.id)){const rt={x:Fe.id===I.id?I.position.x:Fe.position.x+ke,y:Fe.id===I.id?I.position.y:Fe.position.y+De};Pe.push({id:Fe.id,position:rt})}}),R(Fe=>Fe.map(rt=>{const Xe=Pe.find(Le=>Le.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Pe.length>0&&ts(Pe),yt(Fe=>{const rt=Fe.map(Xe=>Xe.id===L.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ke,y:Xe.bounds.y+De}}:Xe);return _t.current=rt,rt}),q.current={x:I.position.x,y:I.position.y}}else{const ke=L.bounds.x,De=L.bounds.y,Pe=L.bounds.width,He=L.bounds.height,Fe=(Le,ft,Lt)=>Math.max(ft,Math.min(Le,Lt)),rt=Fe(I.position.x,ke+10,ke+Pe-10),Xe=Fe(I.position.y,De+10,De+He-10);R(Le=>Le.map(ft=>ft.id===I.id?{...ft,position:{x:rt,y:Xe}}:ft)),q.current={x:rt,y:Xe}}},[R,yt,ir,r,ts]),ha=t.useCallback(()=>{Ps.current=null,q.current=null,Xs.current=null,Ps.current=null,q.current=null,Xs.current=null,Zs(null),_t.current.length>0&&Js(_t.current)},[Js]),pa=t.useCallback((o,I)=>{const L=ir(I.id);L&&wt(L.id)},[ir]);if(t.useEffect(()=>{if(p.length===0||U.length===0)return;const o=p.filter(I=>{const L=U.find(K=>K.id===I.source),X=U.find(K=>K.id===I.target);return(X==null?void 0:X.type)==="midjourney"&&I.targetHandle==="text-input"&&(L==null?void 0:L.type)!=="agent"});o.length>0&&(b(I=>I.filter(L=>!o.some(X=>X.id===L.id))),m.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[p,U,b]),ae)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!be)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const $r=U.filter(o=>o.selected).length>=2,br=!!Be;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:vt,className:"flex-1 relative overflow-hidden",children:[z&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:V?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${V.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),be&&e.jsx("div",{className:`absolute left-1/2 -translate-x-1/2 ${z?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&xe?`${be.name} ç¬¬${xe.episodeNumber}é›†${!Oe&&se&&Q?` ç¬¬${se}å¹•ç¬¬${Q}é•œ`:""}`:be.name})}),!Oe&&Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-[100px] top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,I)=>o.scene!==I.scene?(o.scene||0)-(I.scene||0):(o.shot||0)-(I.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const I=o.bounds.x+o.bounds.width/2,L=o.bounds.y+o.bounds.height/2,X=vt.current;if(X){const K=X.clientWidth,ke=X.clientHeight,De=.2,Pe=K*(1-De),He=ke*(1-De),Fe=Pe/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(Fe,rt,1.5),Le=Math.max(Xe,.3);de(I,L,{zoom:Le,duration:800})}else de(I,L,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Be===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-[#deeaef]/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-[#deeaef] dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:"fixed right-[24px] top-1/2 -translate-y-1/2 z-[100] flex flex-col gap-1 p-2 rounded-2xl bg-[#deeaef] dark:bg-[#18181b] shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{onClick:()=>{if(qe&&j&&l){const o=Oe&&se&&Q?`?shot=${Q}`:"";T(`/projects/${j}/episodes/${l}${o}`)}else T("/quick")},className:"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"arrow_back"})}),e.jsx("div",{className:"h-px bg-neutral-200 dark:bg-neutral-700 my-1"}),!z&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!bt&&r&&er(!bs)},disabled:bt||!r,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!r?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":bs?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:r?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!bt&&r&&na()},disabled:bt||!r||!$r,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!r||!$r?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:r?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_work"})}),e.jsx("button",{onClick:()=>{!bt&&r&&ia()},disabled:bt||!r||!br,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!r||!br?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:r?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_off"})}),e.jsx("button",{onClick:()=>{!bt&&r&&la()},disabled:bt||!r||!br,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!r||!br?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:r?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"edit"})}),e.jsx("button",{onClick:()=>oa(),className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${ws?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:ws?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"text_fields"})})]})]}),x&&Cs.length>0&&e.jsxs("div",{className:`absolute ${z?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:Cs.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.ai${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-neutral-600 dark:text-neutral-300",children:"person"})},o.id))}),Cs.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",Cs.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${ws?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Sa,{nodes:Bt,edges:p,onNodesChange:z?void 0:us,onEdgesChange:z?void 0:Zr,onNodesDelete:z?void 0:Qr,onEdgesDelete:z?void 0:ea,onConnect:z?void 0:Kr,onConnectStart:z?void 0:ra,onConnectEnd:z?void 0:aa,onEdgeDoubleClick:z?void 0:Yr,onPaneContextMenu:z?void 0:ta,onPaneClick:z?void 0:ca,onMove:da,onNodeClick:z?void 0:pa,onNodeDragStart:z?void 0:ua,onNodeDrag:z?void 0:ga,onNodeDragStop:z?void 0:ha,nodeTypes:wn,edgeTypes:yn,nodesDraggable:!z,nodesConnectable:!z,elementsSelectable:!z,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${z?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#525252",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:z?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Ea,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#525252"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#404040"})]})}),Ke.filter(o=>!o.hidden).map(o=>{const I=Z(),L=o.bounds.x*I.zoom+I.x,X=o.bounds.y*I.zoom+I.y,K=o.bounds.width*I.zoom,ke=o.bounds.height*I.zoom,De=12*I.zoom,Pe=Math.max(1.25,1.25*I.zoom),He=document.documentElement.classList.contains("dark"),Fe=Be===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:L,y:X,width:K,height:ke,rx:De,ry:De,fill:"none",stroke:Fe?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Pe,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:L,y:X,width:K,height:ke,rx:De,ry:De,fill:"transparent",stroke:"transparent",strokeWidth:Pe*3,style:{pointerEvents:"stroke",cursor:ps===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),Rr(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ke.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const I=Z(),L=o.bounds.x*I.zoom+I.x,X=o.bounds.y*I.zoom+I.y,K=40*I.zoom,ke=10*I.zoom,De=15*I.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Pe=>{Pe.stopPropagation(),Rr(Pe,o.id)},onClick:Pe=>{Pe.stopPropagation(),wt(o.id)},style:{left:L+ke,top:X-K-ke-De,fontSize:`${K}px`,cursor:ps===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),u&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:u.x,top:u.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ne("agent")},onMouseLeave:()=>{k.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ne("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),G==="agent"&&e.jsx("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ne("agent")},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(k.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:I=>{I.preventDefault(),I.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),Ee(!0)},onMouseLeave:()=>{k.current=window.setTimeout(()=>{Ee(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),J&&e.jsxs("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),Ee(!0)},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(k.current=window.setTimeout(()=>{Ee(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),H(!0)},onMouseLeave:()=>{Ne.current=window.setTimeout(()=>{H(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),S&&e.jsxs("div",{onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),H(!0)},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(Ne.current=window.setTimeout(()=>{H(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ne("edit")},onMouseLeave:()=>{k.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),G==="edit"&&e.jsxs("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ne("edit")},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(k.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Qe.filter(o=>Ft(o).length>0).map(o=>e.jsxs("button",{onMouseDown:I=>{I.preventDefault(),I.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),he(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),Qe.every(o=>Ft(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Ys.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Ae(!0),onMouseLeave:()=>Ae(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),$e&&e.jsx("div",{onMouseEnter:()=>{_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:I=>{I.preventDefault(),I.stopPropagation(),ls("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Ys.showAiImage&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Ys.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("imageEdit")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),me==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("imageEdit")},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(h.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Ys.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("video")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),me==="video"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("video")},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(h.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ls("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ls("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ls("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ls("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Ys.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),Ue.current&&(clearTimeout(Ue.current),Ue.current=null),he(!0)},onMouseLeave:()=>{Ue.current=window.setTimeout(()=>{he(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>he(!0),onMouseLeave:()=>he(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),he(!0)},onMouseOver:()=>oe(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),y&&e.jsxs("div",{onMouseEnter:()=>{Ue.current&&(clearTimeout(Ue.current),Ue.current=null),he(!0)},onMouseLeave:o=>{const I=o.currentTarget.parentElement,L=o.relatedTarget;(!I||!I.contains(L))&&(Ue.current=window.setTimeout(()=>{he(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Qe.filter(o=>Ft(o).length>0).map(o=>e.jsxs("button",{onMouseDown:I=>{I.preventDefault(),I.stopPropagation(),o==="å¯¹å£å‹"?ls("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?ls("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ls("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),he(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),Qe.every(o=>Ft(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ys.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ys.showUpload&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Ys.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Ys.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(bn,{isOpen:Mt,onClose:()=>{At(!1),gt(null)},onAssetSelect:sa}),Ss&&Ns&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Es(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Es(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),I=document.getElementById("shot-input"),L=parseInt((o==null?void 0:o.value)||"0"),X=parseInt((I==null?void 0:I.value)||"0");if(L>0&&X>0){if(Ke.find(ke=>ke.id!==Ns&&ke.scene===L&&ke.shot===X)){m.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${L}å¹•-ç¬¬${X}é•œ`);return}yt(ke=>{const De=ke.map(He=>He.id===Ns?{...He,scene:L,shot:X,name:`ç¬¬${L}å¹•-ç¬¬${X}é•œ`}:He),Pe=De.find(He=>He.id===Ns);return Pe&&R(He=>{const Fe=new Set;return p.forEach(rt=>{if(Pe.nodeIds.includes(rt.source)){const Xe=He.find(Le=>Le.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&Fe.add(rt.target)}}),He.map(rt=>Pe.nodeIds.includes(rt.id)||Fe.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Pe,nodeGroups:De}}}:rt)}),setTimeout(()=>{qs()},100),De}),Es(!1),Bs(null),m.success(`å·²å‘½åä¸ºï¼šç¬¬${L}å¹•-ç¬¬${X}é•œ`)}else m.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},An=()=>e.jsx(va,{children:e.jsx(kn,{})});export{An as default};
