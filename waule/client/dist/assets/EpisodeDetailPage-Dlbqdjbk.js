import{e as ve,r as k,d as je,j as e,f as ee}from"./react-vendor-CnSaCHf4.js";import{c as g,b as j,d as Ne}from"./index-DOiS8MNr.js";import{g as Ie}from"./assetNaming-PUktT1IV.js";import"./reactflow-COwzeFBM.js";import"./utils-BcyDR7Vi.js";function Te(){var Y;const{projectId:N,episodeId:$}=ve(),[I,te]=k.useState(null),[ae,se]=k.useState(!0),[E,re]=k.useState(null),le=je();k.useEffect(()=>{(async()=>{var t;try{const r=await g.episodes.getById(N,$),d=(r==null?void 0:r.data)??r;te(d);try{const l=(t=d==null?void 0:d.scriptJson)==null?void 0:t.acts;Array.isArray(l)&&l.length>0?A(l):A(null)}catch{}}finally{se(!1)}})()},[N,$]),k.useEffect(()=>{N&&(async()=>{try{const t=await g.projects.getById(N);re(t.data)}catch{}})()},[N]);const de=(E==null?void 0:E.name)||"",W=I!=null&&I.episodeNumber&&I.episodeNumber>0?I.episodeNumber:void 0,i=(I==null?void 0:I.canEdit)??!0,[S,A]=k.useState(null),[M,P]=k.useState(!1),[q,ne]=k.useState(""),[D,oe]=k.useState([]),[F,ie]=k.useState([]),[_,Q]=k.useState(""),[ce,xe]=k.useState(""),[ue,U]=k.useState(!1),[me,G]=k.useState(!1),[he,K]=k.useState(!1);k.useEffect(()=>{document.querySelectorAll("textarea.auto-resize").forEach(t=>{t.style.height="auto",t.style.height=t.scrollHeight+"px"})},[S]);const O=async a=>{try{await g.episodes.update(N,$,{scriptJson:{acts:a}})}catch(t){j.error((t==null?void 0:t.message)||"保存分镜脚本失败")}},X=a=>{const t=document.getElementById(a);t&&t.scrollIntoView({behavior:"smooth",block:"start"})},B=(a,t,r,d)=>{A(l=>l&&l.map(u=>u.actIndex===a?{...u,shots:u.shots.map(p=>p.shotIndex===t?{...p,[r]:d}:p)}:u))},R=async()=>{if(S)try{if(me){K(!0);return}G(!0),await O(S)}finally{G(!1),he&&(K(!1),R())}},J=a=>({shotIndex:a,画面:"","景别/镜头":"","内容/动作":"","声音/对话":"",时长:"",提示词:"",media:{type:"video",url:""}}),pe=async(a,t)=>{const d=(S||[]).map(l=>{if(l.actIndex!==a)return l;if(t==null){const u=l.shots&&l.shots.length?Math.max(...l.shots.map(p=>p.shotIndex))+1:1;return{...l,shots:[...l.shots,J(u)]}}else{const u=[];for(const p of l.shots)p.shotIndex===t&&u.push(J(t)),u.push({...p,shotIndex:p.shotIndex>=t?p.shotIndex+1:p.shotIndex});return{...l,shots:u}}});A(d),await O(d)},fe=async a=>{try{const t=S||[],r=[];for(const l of t)if(r.push(l),l.actIndex===a){const u=a+1;r.push({actIndex:u,shots:[J(1)]})}const d=r.map((l,u)=>({...l,actIndex:u+1}));A(d),await O(d);try{const l=await g.workflows.getAll({projectId:N,episodeId:$}),p=((l==null?void 0:l.data)||l||[]).filter(s=>s.sceneNumber&&s.sceneNumber>a);for(const s of p){const m=s.sceneNumber+1;await g.workflows.update(s.id,{sceneNumber:m,name:`第${m}幕-第${s.shotNumber}镜`})}}catch{j.warning("幕已添加，但工作流更新失败，请手动检查")}}catch(t){j.error("添加幕失败: "+(t.message||"未知错误"))}},ge=async(a,t)=>{var l,u,p;if(!window.confirm("确认删除该镜？"))return;const r=S||[],d=r.map(s=>{if(s.actIndex!==a)return s;const c=(s.shots||[]).filter(h=>h.shotIndex!==t).map((h,o)=>({...h,shotIndex:o+1}));return{...s,shots:c}});A(d);try{await O(d);try{const s=(u=(l=r.find(c=>c.actIndex===a))==null?void 0:l.shots)==null?void 0:u.find(c=>c.shotIndex===t),m=[];if(s&&(Array.isArray(s.mediaList)&&s.mediaList.forEach(c=>{c.nodeId&&m.push(c.nodeId)}),(p=s.media)!=null&&p.nodeId&&m.push(s.media.nodeId)),m.length>0){const c=await g.workflows.getAll({projectId:N,episodeId:$}),o=((c==null?void 0:c.data)||c||[]).find(n=>n.sceneNumber===a&&n.shotNumber===t);if(o){const n=o.data?JSON.parse(o.data):{nodes:[],edges:[]},b=n.nodes.map(f=>{var x;return m.includes(f.id)&&((x=f.data)!=null&&x.addedToStoryboard)?{...f,data:{...f.data,addedToStoryboard:!1}}:f});await g.workflows.update(o.id,{data:JSON.stringify({...n,nodes:b})})}}}catch{}}catch{}},V=async(a,t,r,d)=>{try{let l="视频.mp4";if(E&&I){const m={id:`act-${t}-shot-${r}`,scene:t,shot:r,nodeIds:[]},c=Ie({project:{id:E.id,name:E.name,type:E.type||"QUICK"},episode:{id:I.id,episodeNumber:I.episodeNumber||1},nodeGroup:m,nodeId:`video-${t}-${r}-${d||0}`,assetType:"video",preview:!1});c&&(l=c)}const p=(await Ne.get("/assets/proxy-download-with-name",{params:{url:a,filename:l},responseType:"blob"})).data,s=document.createElement("a");s.href=URL.createObjectURL(p),s.download=l,s.click(),URL.revokeObjectURL(s.href)}catch(l){j.error("下载失败: "+(l.message||"未知错误"))}},be=()=>{const a=`幕,镜,画面,景别/镜头,内容/动作,声音/对话,时长,提示词
1,1,示例画面,全景,示例内容和动作描述,示例对话或音效,5秒,示例AI生成提示词
1,2,示例画面2,特写,示例内容和动作描述2,示例对话或音效2,3秒,示例AI生成提示词2`,t=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(t),r.download="分镜脚本模板.csv",r.click(),URL.revokeObjectURL(r.href)},ye=async a=>{var r;const t=(r=a.target.files)==null?void 0:r[0];if(t)try{const u=(await t.text()).replace(/^\ufeff/,"").split(`
`).filter(o=>o.trim());if(u.length<2){j.error("CSV文件格式不正确，至少需要包含表头和一行数据");return}const p=u[0].split(",").map(o=>o.trim());if(!["幕","镜","画面","景别/镜头","内容/动作","声音/对话","时长","提示词"].every(o=>p.includes(o))){j.error("CSV文件表头不正确，请使用提供的模板格式");return}const c=new Map;for(let o=1;o<u.length;o++){const n=u[o].split(",").map(T=>T.trim());if(n.length<8)continue;const b=parseInt(n[0]),f=parseInt(n[1]);if(isNaN(b)||isNaN(f))continue;const x={shotIndex:f,画面:n[2],"景别/镜头":n[3],"内容/动作":n[4],"声音/对话":n[5],时长:n[6],提示词:n[7]};c.has(b)||c.set(b,[]),c.get(b).push(x)}const h=Array.from(c.entries()).map(([o,n])=>({actIndex:o,shots:n.sort((b,f)=>b.shotIndex-f.shotIndex)})).sort((o,n)=>o.actIndex-n.actIndex);if(h.length===0){j.error("CSV文件中没有有效的分镜数据");return}A(h),await O(h),a.target.value=""}catch(d){j.error("导入失败: "+(d.message||"文件格式错误")),a.target.value=""}};k.useEffect(()=>{(async()=>{var a;try{const t=await g.agents.getAll();let r=t.find(l=>(l.name||"").includes("超级导演")&&l.isActive===!1);if(r||(r=t.find(l=>(l.name||"").includes("超级导演"))),r||(r=t.find(l=>l.isActive===!1)),!r){j.error("未找到未启用的智能体，请在后台创建一个未启用的智能体用于分镜脚本生成");return}xe(r.name||"未启用智能体");const d=await g.agents.roles.listByAgent(r.id);ie(d),(a=d[0])!=null&&a.id&&Q(d[0].id)}catch(t){j.error((t==null?void 0:t.message)||"加载智能体角色失败")}})()},[]);const we=async()=>{var a,t,r,d,l,u,p;try{const s=[],m=[],c=[],h=[];for(const v of D){try{if(v.type.startsWith("text/")){const w=await v.text();s.push(`【${v.name}】
${w}`)}}catch{}try{const w=await g.assets.upload(v),C=((a=w==null?void 0:w.data)==null?void 0:a.url)||(w==null?void 0:w.url)||"",L=v.type||((t=w==null?void 0:w.data)==null?void 0:t.mimeType)||"";if(!C)continue;L.startsWith("image/")?m.push(C):L.startsWith("video/")?c.push(C):(L==="application/pdf"||L==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||L==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||L.startsWith("text/"))&&h.push({filePath:C,mimeType:L})}catch(w){j.error((w==null?void 0:w.message)||`上传附件失败：${v.name}`)}}const o='请严格输出符合以下结构的JSON，不要包含多余文字：{"locale":"zh-CN","acts":[{"actIndex":1,"shots":[{"shotIndex":1,"画面":"...","景别/镜头":"...","内容/动作":"...","声音/对话":"...","时长":"6s","提示词":"...","media":{"type":"video","aspectRatio":"16:9","orientation":"horizontal"}}]}]}]}',n=`${q}

${s.join(`

`)}`.trim(),b=m.length+c.length+h.length>0;if(!n&&!b){j.error("请输入文本或上传文档");return}const f=n||"请根据附件生成分镜脚本";U(!0),P(!1);const x=F.find(v=>v.id===_),T=x!=null&&x.systemPrompt?`${x.systemPrompt}

${o}`:o,y=await g.post("/tasks/storyboard",{projectId:N,episodeId:$,roleId:x.id,prompt:f,systemPrompt:T,temperature:(x==null?void 0:x.temperature)??0,attachments:{documentFiles:h,imageUrls:m,videoUrls:c}}),z=(y==null?void 0:y.taskId)||((r=y==null?void 0:y.data)==null?void 0:r.taskId),ke=Date.now()+5*60*1e3;let Z=!1;for(;Date.now()<ke;){await new Promise(C=>setTimeout(C,3e3));const v=await g.get(`/tasks/${z}`),w=((d=v==null?void 0:v.task)==null?void 0:d.status)||(v==null?void 0:v.status);if(w==="SUCCESS"){const C=await g.episodes.getById(N,$),L=(C==null?void 0:C.data)??C,H=(l=L==null?void 0:L.scriptJson)==null?void 0:l.acts;if(Array.isArray(H)&&H.length>0){A(H),Z=!0;break}}else if(w==="FAILURE"){j.error("脚本生成失败"),U(!1);break}}Z||(j.error("脚本生成超时或失败"),U(!1)),U(!1)}catch(s){const m=((p=(u=s==null?void 0:s.response)==null?void 0:u.data)==null?void 0:p.error)||(s==null?void 0:s.message)||"执行智能体失败";j.error(m),U(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
.no-scrollbar::-webkit-scrollbar{display:none}
.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
/* Light模式：紫色到粉色 */
.bg-gradient-brand{background-image:linear-gradient(135deg,#a855f7,#ec4899);}
/* Dark模式：深紫到深粉（不透明）*/
.dark .bg-gradient-brand{background-image:linear-gradient(135deg,#9333ea,#db2777);}
/* 标题区域渐变边框（Aurora风格）*/
.bg-gradient-aurora{background-image:linear-gradient(90deg,rgba(236,72,153,0.2),rgba(168,85,247,0.2),rgba(6,182,212,0.2));}
.dark .bg-gradient-aurora{background-image:linear-gradient(90deg,rgba(236,72,153,0.2),rgba(168,85,247,0.2),rgba(6,182,212,0.2));}
    `}),e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("aside",{className:"w-80 bg-card-light dark:bg-background-dark p-6 flex flex-col border-r border-border-light dark:border-border-dark",children:[e.jsx("div",{className:"mb-10",children:e.jsxs("h1",{className:"text-xl font-bold text-slate-900 dark:text-white",children:["《",de,"》",W&&e.jsxs("span",{className:"font-normal text-slate-600 dark:text-text-dark-secondary text-sm align-baseline",children:["  第",W,"集"]})]})}),e.jsxs("div",{className:"flex-1 min-h-0 flex flex-col",children:[e.jsx("h2",{className:"text-sm font-semibold text-slate-600 dark:text-text-dark-secondary px-4 mb-3",children:"分镜导航"}),e.jsx("nav",{className:"flex flex-col gap-1.5 flex-1 overflow-y-auto pr-1 no-scrollbar",children:S?S.map(a=>e.jsxs("div",{className:"mb-2",children:[e.jsxs("a",{href:`#act-${a.actIndex}`,onClick:t=>{t.preventDefault(),X(`act-${a.actIndex}`)},className:"px-4 py-2 text-slate-900 dark:text-text-dark-primary font-semibold hover:text-slate-600 dark:hover:text-text-dark-secondary",children:["第",a.actIndex,"幕"]}),e.jsx("div",{className:"flex flex-col gap-1.5",children:a.shots.map(t=>e.jsxs("a",{className:"flex items-start gap-2 px-3 py-2 rounded-lg text-slate-600 dark:text-text-dark-secondary hover:bg-slate-200 dark:hover:bg-card-dark-hover hover:text-slate-900 dark:hover:text-text-dark-primary transition-colors ml-3",href:`#shot-${a.actIndex}-${t.shotIndex}`,onClick:r=>{r.preventDefault(),X(`shot-${a.actIndex}-${t.shotIndex}`)},children:[e.jsx("span",{className:"material-symbols-outlined text-base mt-0.5",children:"camera"}),e.jsxs("span",{className:"text-sm",children:["第",t.shotIndex,"镜: ",(t.画面||"").slice(0,18)||"未命名"]})]},`shot-nav-${a.actIndex}-${t.shotIndex}`))})]},`act-nav-${a.actIndex}`)):e.jsx("div",{className:"px-4 text-slate-600 dark:text-text-dark-secondary",children:"暂无分镜"})})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[!i&&e.jsxs("div",{className:"px-3 py-2 rounded-lg bg-amber-100 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:"只读模式"})]}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-500 mt-1",children:"您只有查看权限，无法编辑"})]}),(I==null?void 0:I.isOwner)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{P(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white font-medium hover:shadow-lg transition-all text-sm active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"auto_awesome"}),e.jsx("span",{children:"自动创建分镜脚本"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("button",{onClick:()=>{var a;return(a=document.getElementById("csv-import-input"))==null?void 0:a.click()},className:"w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 dark:from-blue-600/50 dark:to-cyan-600/50 text-white font-medium hover:shadow-lg transition-all text-sm active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"upload_file"}),e.jsx("span",{children:"导入分镜脚本"})]}),e.jsxs("button",{onClick:be,className:"w-full flex items-center justify-center gap-1 px-2 py-1 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"}),e.jsx("span",{children:"下载CSV模板"})]})]}),e.jsx("input",{id:"csv-import-input",type:"file",accept:".csv",onChange:ye,className:"hidden"})]})]})]}),e.jsx("main",{className:"flex-1 p-8 md:p-12 overflow-y-auto bg-background-light dark:bg-background-dark",children:e.jsx("div",{className:"max-w-none mx-auto",children:ae?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-tiffany-500 border-t-transparent"})}):e.jsx(e.Fragment,{children:S?S.map(a=>e.jsxs("div",{id:`act-${a.actIndex}`,className:"mb-12",onDoubleClick:()=>{const t=document.getElementById(`act-body-${a.actIndex}`);if(t){const r=t.getAttribute("data-hidden")==="true";t.setAttribute("data-hidden",r?"false":"true"),t.style.display=r?"":"none"}},children:[e.jsx("div",{className:"bg-gradient-aurora p-px rounded-lg mb-6",children:e.jsx("div",{className:"bg-white dark:bg-background-dark rounded-lg",children:e.jsxs("div",{className:"px-4 py-2 flex items-center justify-between",children:[e.jsxs("div",{className:"text-slate-900 dark:text-white font-bold text-xl",children:["第",a.actIndex,"幕"]}),i&&e.jsxs("button",{onClick:()=>fe(a.actIndex),className:"flex items-center gap-1 px-3 py-1 text-sm text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-lg transition-colors",title:"在此幕后添加新幕",children:[e.jsx("span",{className:"material-symbols-outlined text-base",children:"add_circle"}),e.jsx("span",{children:"添加幕"})]})]})})}),e.jsx("div",{id:`act-body-${a.actIndex}`,className:"space-y-8 pl-12","data-hidden":"false",children:a.shots.map(t=>e.jsxs("div",{id:`shot-${a.actIndex}-${t.shotIndex}`,className:"grid grid-cols-1 lg:grid-cols-[60px,2fr,minmax(280px,420px)] gap-6 items-stretch",children:[e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-8 lg:w-1/2 h-32 lg:h-[120px]",children:e.jsx("div",{className:"bg-gradient-brand p-px rounded-lg w-full h-full",children:e.jsxs("div",{className:"bg-white dark:bg-background-dark rounded-lg w-full h-full flex flex-col items-center justify-center gap-2 py-1",children:[e.jsx("span",{className:"text-slate-900 dark:text-white text-sm leading-tight",children:"第"}),e.jsx("span",{className:"text-slate-900 dark:text-white text-base whitespace-nowrap leading-tight",children:t.shotIndex}),e.jsx("span",{className:"text-slate-900 dark:text-white text-sm leading-tight",children:"镜"})]})})}),e.jsx("button",{onClick:()=>le(`/projects/${N}/episodes/${$}/workflow?scene=${a.actIndex}&shot=${t.shotIndex}`),className:`${i?"bg-tiffany-500":"bg-slate-400"} text-white rounded-full w-8 lg:w-1/2 aspect-square hover:opacity-90 flex items-center justify-center`,title:i?"进入工作流":"查看工作流",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:i?"camera":"visibility"})}),i&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>ge(a.actIndex,t.shotIndex),title:"删除分镜",className:"bg-red-600 text-white rounded-full w-8 lg:w-1/2 aspect-square hover:opacity-90 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"remove"})}),e.jsx("button",{onClick:()=>pe(a.actIndex,t.shotIndex),title:"新增分镜",className:"bg-slate-300 dark:bg-white/20 text-slate-800 dark:text-white rounded-full w-8 lg:w-1/2 aspect-square hover:opacity-90 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"add"})})]})]}),e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white/90 dark:bg-card-dark border border-slate-200 dark:border-transparent rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-[128px,1fr] items-center border-b border-slate-200 dark:border-border-dark",children:[e.jsx("div",{className:"px-4 py-2 text-slate-600 dark:text-text-dark-secondary whitespace-nowrap flex items-center",children:"画面"}),e.jsx("div",{className:"px-4 py-2 flex items-center",children:e.jsx("textarea",{value:t.画面,onChange:i?r=>B(a.actIndex,t.shotIndex,"画面",r.target.value):void 0,onInput:i?r=>{const d=r.target;d.style.height="auto",d.style.height=d.scrollHeight+"px"}:void 0,onBlur:i?R:void 0,readOnly:!i,rows:1,className:`auto-resize w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-text-dark-primary rounded p-2 resize-none overflow-hidden ${i?"":"cursor-default select-text"}`})})]}),e.jsxs("div",{className:"grid grid-cols-[128px,1fr] items-center border-b border-slate-200 dark:border-border-dark",children:[e.jsx("div",{className:"px-4 py-2 text-slate-600 dark:text-text-dark-secondary whitespace-nowrap flex items-center",children:"景别/镜头"}),e.jsx("div",{className:"px-4 py-2 flex items-center",children:e.jsx("textarea",{value:t["景别/镜头"],onChange:i?r=>B(a.actIndex,t.shotIndex,"景别/镜头",r.target.value):void 0,onInput:i?r=>{const d=r.target;d.style.height="auto",d.style.height=d.scrollHeight+"px"}:void 0,onBlur:i?R:void 0,readOnly:!i,rows:1,className:`auto-resize w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-text-dark-primary rounded p-2 resize-none overflow-hidden ${i?"":"cursor-default select-text"}`})})]}),e.jsxs("div",{className:"grid grid-cols-[128px,1fr] items-center border-b border-slate-200 dark:border-border-dark",children:[e.jsx("div",{className:"px-4 py-2 text-slate-600 dark:text-text-dark-secondary whitespace-nowrap flex items-center",children:"内容/动作"}),e.jsx("div",{className:"px-4 py-2 flex items-center",children:e.jsx("textarea",{value:t["内容/动作"],onChange:i?r=>B(a.actIndex,t.shotIndex,"内容/动作",r.target.value):void 0,onInput:i?r=>{const d=r.target;d.style.height="auto",d.style.height=d.scrollHeight+"px"}:void 0,onBlur:i?R:void 0,readOnly:!i,rows:1,className:`auto-resize w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-text-dark-primary rounded p-2 resize-none overflow-hidden ${i?"":"cursor-default select-text"}`})})]}),e.jsxs("div",{className:"grid grid-cols-[128px,1fr] items-center border-b border-slate-200 dark:border-border-dark",children:[e.jsx("div",{className:"px-4 py-2 text-slate-600 dark:text-text-dark-secondary whitespace-nowrap flex items-center",children:"声音/对话"}),e.jsx("div",{className:"px-4 py-2 flex items-center",children:e.jsx("textarea",{value:t["声音/对话"],onChange:i?r=>B(a.actIndex,t.shotIndex,"声音/对话",r.target.value):void 0,onInput:i?r=>{const d=r.target;d.style.height="auto",d.style.height=d.scrollHeight+"px"}:void 0,onBlur:i?R:void 0,readOnly:!i,rows:1,className:`auto-resize w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-text-dark-primary rounded p-2 resize-none overflow-hidden ${i?"":"cursor-default select-text"}`})})]}),e.jsxs("div",{className:"grid grid-cols-[128px,1fr] items-center",children:[e.jsx("div",{className:"px-4 py-2 text-slate-600 dark:text-text-dark-secondary whitespace-nowrap flex items-center",children:"时长"}),e.jsx("div",{className:"px-4 py-2 flex items-center",children:e.jsx("input",{value:t.时长,onChange:i?r=>B(a.actIndex,t.shotIndex,"时长",r.target.value):void 0,onBlur:i?R:void 0,readOnly:!i,className:`w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-text-dark-primary rounded p-2 ${i?"":"cursor-default select-text"}`})})]})]}),e.jsxs("div",{className:"bg-white/90 dark:bg-card-dark border border-slate-200 dark:border-transparent p-6 rounded-lg",children:[e.jsx("div",{className:"text-slate-900 dark:text-text-dark-primary font-medium mb-2",children:"提示词："}),e.jsx("textarea",{value:t.提示词,onChange:i?r=>B(a.actIndex,t.shotIndex,"提示词",r.target.value):void 0,onInput:i?r=>{const d=r.target;d.style.height="auto",d.style.height=d.scrollHeight+"px"}:void 0,onBlur:i?R:void 0,readOnly:!i,rows:1,className:`auto-resize w-full bg-slate-50 dark:bg-background-dark text-slate-900 dark:text-text-dark-secondary rounded p-2 resize-none overflow-hidden ${i?"":"cursor-default select-text"}`})]})]}),(()=>{var u,p;const r=Array.isArray(t.mediaList)&&t.mediaList.length===1,d=r&&t.mediaList&&(t.mediaList[0].orientation==="vertical"||t.mediaList[0].aspectRatio==="9:16"),l=r?d?"items-center justify-start":"items-start justify-center":"items-center justify-center";return e.jsx("div",{className:`bg-slate-100 dark:bg-card-dark border border-slate-200 dark:border-transparent rounded-lg h-full flex ${l} overflow-hidden`,children:Array.isArray(t.mediaList)&&t.mediaList.length>0?t.mediaList.length===1?(()=>{const s=t.mediaList[0],m=s.orientation==="vertical"||s.aspectRatio==="9:16";return e.jsxs("div",{className:`relative bg-black rounded overflow-hidden group ${m?"h-full w-auto":"w-full h-auto"}`,children:[(s==null?void 0:s.type)==="video"&&(s!=null&&s.url)?e.jsx("video",{src:s.url,controls:!0,className:`${m?"h-full w-auto":"w-full h-auto"}`}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-[64px] text-white/40",children:"movie"})}),(s==null?void 0:s.type)==="video"&&(s==null?void 0:s.url)&&e.jsx("button",{onClick:()=>V(s.url,a.actIndex,t.shotIndex,0),className:"absolute bottom-2 right-2 w-8 h-8 bg-slate-500 hover:bg-slate-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",title:"下载视频",children:e.jsx("span",{className:"material-symbols-outlined",children:"download"})}),i&&e.jsx("button",{onClick:async()=>{if(!window.confirm("确认删除该视频？"))return;const c=[],h=S.map(o=>o.actIndex!==a.actIndex?o:{...o,shots:o.shots.map(n=>n.shotIndex!==t.shotIndex?n:{...n,mediaList:c})});A(h),await O(h);try{const o=s.nodeId;if(o){const n=await g.workflows.getAll({projectId:N,episodeId:$}),f=((n==null?void 0:n.data)||n||[]).find(x=>x.sceneNumber===a.actIndex&&x.shotNumber===t.shotIndex);if(f){const x=f.data?JSON.parse(f.data):{nodes:[],edges:[]},T=x.nodes.map(y=>{var z;return y.id===o&&((z=y.data)!=null&&z.addedToStoryboard)?{...y,data:{...y.data,addedToStoryboard:!1}}:y});await g.workflows.update(f.id,{data:JSON.stringify({...x,nodes:T})})}}}catch{}},className:"absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",title:"删除视频",children:e.jsx("span",{className:"material-symbols-outlined",children:"close"})})]},`vid-${a.actIndex}-${t.shotIndex}-0`)})():e.jsx("div",{className:"w-full h-full grid grid-cols-2 grid-rows-2 gap-2 p-2",children:t.mediaList.slice(0,4).map((s,m)=>e.jsxs("div",{className:"relative w-full h-full bg-black rounded overflow-hidden group",children:[(s==null?void 0:s.type)==="video"&&(s!=null&&s.url)?e.jsx("video",{src:s.url,controls:!0,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-[64px] text-white/40",children:"movie"})}),(s==null?void 0:s.type)==="video"&&(s==null?void 0:s.url)&&e.jsx("button",{onClick:()=>V(s.url,a.actIndex,t.shotIndex,m),className:"absolute bottom-1 right-1 w-6 h-6 bg-slate-500 hover:bg-slate-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",title:"下载视频",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})}),i&&e.jsx("button",{onClick:async()=>{if(!window.confirm("确认删除该视频？"))return;const c=(t.mediaList||[]).filter((o,n)=>n!==m),h=S.map(o=>o.actIndex!==a.actIndex?o:{...o,shots:o.shots.map(n=>n.shotIndex!==t.shotIndex?n:{...n,mediaList:c})});A(h),await O(h);try{const o=s.nodeId;if(o){const n=await g.workflows.getAll({projectId:N,episodeId:$}),f=((n==null?void 0:n.data)||n||[]).find(x=>x.sceneNumber===a.actIndex&&x.shotNumber===t.shotIndex);if(f){const x=f.data?JSON.parse(f.data):{nodes:[],edges:[]},T=x.nodes.map(y=>{var z;return y.id===o&&((z=y.data)!=null&&z.addedToStoryboard)?{...y,data:{...y.data,addedToStoryboard:!1}}:y});await g.workflows.update(f.id,{data:JSON.stringify({...x,nodes:T})})}}}catch{}},className:"absolute top-1 right-1 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",title:"删除视频",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"close"})})]},`vid-${a.actIndex}-${t.shotIndex}-${m}`))}):((u=t.media)==null?void 0:u.type)==="video"&&((p=t.media)!=null&&p.url)?e.jsxs("div",{className:"relative w-full h-full overflow-hidden group",children:[e.jsx("video",{src:t.media.url,controls:!0,className:"w-full h-full object-cover"}),e.jsx("button",{onClick:()=>V(t.media.url,a.actIndex,t.shotIndex),className:"absolute bottom-2 right-2 w-8 h-8 bg-slate-500 hover:bg-slate-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",title:"下载视频",children:e.jsx("span",{className:"material-symbols-outlined",children:"download"})}),i&&e.jsx("button",{onClick:async()=>{var m;if(!window.confirm("确认删除该视频？"))return;const s=S.map(c=>c.actIndex!==a.actIndex?c:{...c,shots:c.shots.map(h=>h.shotIndex!==t.shotIndex?h:{...h,media:void 0})});A(s),await O(s);try{const c=(m=t.media)==null?void 0:m.nodeId;if(c){const h=await g.workflows.getAll({projectId:N,episodeId:$}),n=((h==null?void 0:h.data)||h||[]).find(b=>b.sceneNumber===a.actIndex&&b.shotNumber===t.shotIndex);if(n){const b=n.data?JSON.parse(n.data):{nodes:[],edges:[]},f=b.nodes.map(x=>{var T;return x.id===c&&((T=x.data)!=null&&T.addedToStoryboard)?{...x,data:{...x.data,addedToStoryboard:!1}}:x});await g.workflows.update(n.id,{data:JSON.stringify({...b,nodes:f})})}}}catch{}},className:"absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",title:"删除视频",children:e.jsx("span",{className:"material-symbols-outlined",children:"close"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-[144px] text-white/50",children:"movie"})})})})()]},t.shotIndex))})]},a.actIndex)):e.jsx("div",{className:"text-slate-600 dark:text-text-dark-secondary",children:"暂无分镜脚本，请点击左侧按钮创建"})})})})]}),M&&void 0,M&&ee.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]",children:e.jsxs("div",{className:"bg-white dark:bg-background-dark w-full max-w-2xl rounded-lg p-6 border border-slate-200 dark:border-border-dark",children:[e.jsx("div",{className:"text-slate-900 dark:text-white text-lg font-bold mb-4",children:"自动创建分镜脚本"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-1",children:["智能体：",ce||"加载中"]}),F.length>1?e.jsx("select",{value:_,onChange:a=>Q(a.target.value),className:"w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-white rounded p-2",children:F.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))}):e.jsx("div",{className:"w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-white rounded p-2",children:((Y=F[0])==null?void 0:Y.name)||"单角色"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-1",children:"输入文字"}),e.jsx("textarea",{value:q,onChange:a=>ne(a.target.value),className:"w-full bg-slate-50 dark:bg-card-dark text-slate-900 dark:text-white rounded p-3 h-32",placeholder:"在此输入剧集梗概、镜头要求等"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-1",children:"上传文档（可选）"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",multiple:!0,onChange:a=>oe(Array.from(a.target.files||[])),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",id:"file-upload"}),e.jsxs("label",{htmlFor:"file-upload",className:"flex items-center justify-center gap-2 w-full px-4 py-3 border-2 border-dashed rounded-lg cursor-pointer transition-all border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-white/5 hover:border-purple-400 dark:hover:border-purple-400/50 hover:bg-slate-100 dark:hover:bg-white/10",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-slate-400",children:"upload_file"}),e.jsx("span",{className:"text-sm text-slate-600 dark:text-slate-400",children:D.length>0?`已选择 ${D.length} 个文件`:"点击选择文件或拖拽到此处"})]})]}),D.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:D.map((a,t)=>e.jsxs("div",{className:"text-xs text-slate-600 dark:text-slate-400 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"description"}),e.jsx("span",{children:a.name}),e.jsxs("span",{className:"text-slate-400 dark:text-slate-500",children:["(",(a.size/1024).toFixed(1)," KB)"]})]},t))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>P(!1),className:"px-4 py-2 rounded bg-slate-200 dark:bg-card-dark text-slate-900 dark:text-white hover:bg-slate-300 dark:hover:bg-card-dark-hover transition-colors",children:"取消"}),e.jsx("button",{onClick:we,className:"px-4 py-2 rounded bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white transition-all active:scale-95",children:"执行"})]})]})}),document.body),ue&&ee.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-[9999]",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark rounded-lg p-6 text-center",children:[e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"})}),e.jsx("div",{className:"text-slate-900 dark:text-white mt-2",children:"脚本生成中……"}),e.jsx("div",{className:"text-slate-600 dark:text-text-dark-secondary text-sm mt-1",children:"请耐心等待！"})]})}),document.body)]})}export{Te as default};
