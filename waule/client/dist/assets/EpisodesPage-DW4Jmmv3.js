import{d as X,e as Y,r,j as e,R as T}from"./react-vendor-BvY2dB7B.js";import{b as v,c as l,d as M}from"./index-Dg_hJ4va.js";import"./reactflow-D8v6_Qvs.js";import"./utils-BcyDR7Vi.js";const A=({isEdit:n=!1,onSubmit:d,onClose:m,formData:y,setFormData:c,episodes:S,editingEpisodeId:I,thumbnail:E,setThumbnail:C,setThumbnailFile:b})=>{const f=T.useRef(null),[$,h]=T.useState(!1),N=async s=>{var R,L;const x=(R=s.target.files)==null?void 0:R[0];if(x){if(!x.type.startsWith("image/")){l.error("请选择图片文件");return}if(x.size>10*1024*1024){l.error("图片大小不能超过 10MB");return}h(!0);try{const j=await v.assets.upload(x);j.success&&((L=j.data)!=null&&L.url)?(C(j.data.url),b(null),l.success("封面上传成功")):l.error("上传失败")}catch(j){l.error(j.message||"上传失败")}finally{h(!1)}}},w=()=>{C(null),b(null),f.current&&(f.current.value="")},o=100,P=new Set(S.filter(s=>s.id!==I).map(s=>s.episodeNumber)),g=Array.from({length:o},(s,x)=>x+1).filter(s=>!P.has(s)),u=g.length>0;return e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white/90 dark:bg-black/70 backdrop-blur-xl border-2 border-slate-200 dark:border-white/10 rounded-2xl p-6 max-w-lg w-full shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800 dark:text-white",children:n?"编辑剧集":"新建剧集"}),e.jsx("button",{onClick:m,className:"p-1.5 rounded-md text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsxs("form",{onSubmit:s=>{d(s)},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2",children:"剧集封面"}),e.jsx("input",{ref:f,type:"file",accept:"image/*",onChange:N,className:"hidden"}),$?e.jsxs("div",{className:"w-full h-36 border-2 border-dashed border-purple-400 dark:border-purple-400/50 rounded-lg flex flex-col items-center justify-center gap-2 bg-slate-100 dark:bg-white/5",children:[e.jsx("span",{className:"material-symbols-outlined text-2xl text-purple-500 animate-spin",children:"progress_activity"}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:"正在上传..."})]}):E?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:E,alt:"封面预览",className:"w-full h-36 object-cover rounded-lg border-2 border-slate-200 dark:border-white/10"}),e.jsx("button",{type:"button",onClick:w,className:"absolute top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-all opacity-0 group-hover:opacity-100 shadow-md",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}):e.jsxs("button",{type:"button",onClick:()=>{var s;return(s=f.current)==null?void 0:s.click()},className:"w-full h-36 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-lg hover:border-purple-400 dark:hover:border-purple-400/50 transition-colors flex flex-col items-center justify-center gap-2 bg-slate-100 dark:bg-white/5",children:[e.jsx("span",{className:"material-symbols-outlined text-2xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:"点击上传封面图片"}),e.jsx("span",{className:"text-[11px] text-slate-500 dark:text-slate-500",children:"支持 JPG、PNG，最大 10MB"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2",children:"第几集 *"}),u?e.jsx("select",{required:!0,value:y.episodeNumber,onChange:s=>c(x=>({...x,episodeNumber:parseInt(s.target.value)})),className:"w-full px-4 py-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white outline-none transition-all",style:{outline:"none",boxShadow:"none"},children:g.map(s=>e.jsxs("option",{value:s,children:["第 ",s," 集"]},s))}):e.jsxs("div",{className:"w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-lg text-text-light-secondary dark:text-text-dark-secondary",children:["已达到最大剧集数（",o,"集）"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2",children:"剧集描述"}),e.jsx("textarea",{value:y.description,onChange:s=>c(x=>({...x,description:s.target.value})),className:"w-full px-4 py-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 outline-none resize-none transition-all",style:{outline:"none",boxShadow:"none"},rows:3,placeholder:"简要描述剧集内容...",maxLength:500})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:m,className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-white/10",children:"取消"}),e.jsx("button",{type:"submit",disabled:!u,className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed font-medium active:scale-95",children:n?"保存更改":"创建剧集"})]})]})]})})},re=()=>{const n=X(),{projectId:d}=Y(),[m,y]=r.useState(null),[c,S]=r.useState([]),[I,E]=r.useState(!0),[C,b]=r.useState(!1),[f,$]=r.useState(!1),[h,N]=r.useState(null),[w,o]=r.useState(null),[P,g]=r.useState(null),[u,s]=r.useState({name:"",description:"",episodeNumber:1}),[x,R]=r.useState(!1),[L,j]=r.useState(null),[V,F]=r.useState([]),[U,z]=r.useState(!1),B=()=>{const t=new Set(c.map(a=>a.episodeNumber));for(let a=1;a<=100;a++)if(!t.has(a))return a;return 1};r.useEffect(()=>{d&&(W(),_())},[d]);const W=async()=>{try{const t=await v.projects.getById(d);y(t.data)}catch{l.error("加载项目失败")}},_=async()=>{var t;try{E(!0);const a=await v.episodes.list(d);S(((t=a.data)==null?void 0:t.data)||a.data||[])}catch{l.error("加载剧集列表失败")}finally{E(!1)}},G=async t=>{var p,k;if(t.preventDefault(),c.some(i=>i.episodeNumber===u.episodeNumber)){l.error(`第 ${u.episodeNumber} 集已存在，请选择其他集数`);return}try{const i={...u,name:`第${u.episodeNumber}集`,thumbnail:w||void 0},D=await v.episodes.create(d,i);l.success("剧集创建成功！"),b(!1),s({name:"",description:"",episodeNumber:1}),o(null),g(null),_()}catch(i){l.error(((k=(p=i.response)==null?void 0:p.data)==null?void 0:k.message)||"创建失败")}},O=async t=>{var p,k;if(t.preventDefault(),!h)return;if(c.some(i=>i.id!==h.id&&i.episodeNumber===u.episodeNumber)){l.error(`第 ${u.episodeNumber} 集已存在，请选择其他集数`);return}try{const i={...u,name:`第${u.episodeNumber}集`,thumbnail:w||void 0};await v.episodes.update(d,h.id,i),l.success("剧集更新成功！"),$(!1),N(null),s({name:"",description:"",episodeNumber:1}),o(null),g(null),_()}catch(i){l.error(((k=(p=i.response)==null?void 0:p.data)==null?void 0:k.message)||"更新失败")}},q=async t=>{var a,p;if(confirm("确定要删除此剧集吗？此操作不可恢复。"))try{await v.episodes.delete(d,t),l.success("剧集已删除"),_()}catch(k){l.error(((p=(a=k.response)==null?void 0:a.data)==null?void 0:p.message)||"删除失败")}},H=t=>{N(t),s({name:"",description:t.description||"",episodeNumber:t.episodeNumber}),o(t.thumbnail||null),g(null),$(!0)},J=async t=>{j(t),R(!0),z(!0);try{const a=await v.episodes.getCollaborators(d,t.id);F(a.data||[])}catch{l.error("加载协作者失败")}finally{z(!1)}},K=async(t,a)=>{var p,k;if(L)try{await v.episodes.updatePermission(d,L.id,t,a),F(i=>i.map(D=>D.id===t?{...D,permission:a}:D)),l.success("权限已更新")}catch(i){l.error(((k=(p=i.response)==null?void 0:p.data)==null?void 0:k.message)||"更新失败")}},Q=t=>({DRAFT:"草稿",IN_PROGRESS:"进行中",RENDERING:"渲染中",COMPLETED:"已完成",ARCHIVED:"已归档"})[t]||t;return e.jsxs("div",{className:"p-8",children:[e.jsx("div",{className:"flex items-center justify-between gap-8 mb-12",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>n("/drama"),className:"w-10 h-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded-lg transition-all",children:e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"arrow_back"})}),e.jsx("h1",{className:"text-4xl font-bold text-text-light-primary dark:text-text-dark-primary whitespace-nowrap",children:(m==null?void 0:m.name)||"剧集列表"})]})}),e.jsx("div",{className:"fixed left-[24px] bottom-8 z-50",children:e.jsxs("div",{className:"group relative",children:[e.jsx("button",{onClick:()=>{s({name:"",episodeNumber:B(),description:""}),b(!0)},className:"w-10 h-10 rounded-xl bg-white dark:bg-[#18181b] text-neutral-600 dark:text-neutral-400 border border-neutral-200 dark:border-neutral-700 hover:bg-black dark:hover:bg-white hover:text-white dark:hover:text-black hover:border-transparent transition-all flex items-center justify-center shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:e.jsx("span",{className:"material-symbols-outlined text-3xl",style:{fontVariationSettings:'"FILL" 0, "wght" 500'},children:"add"})}),e.jsx("span",{className:"absolute left-full top-1/2 -translate-y-1/2 ml-2 px-2 py-1 text-xs text-white bg-slate-800 dark:bg-slate-700 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50",children:"新建剧集"})]})}),I?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-tiffany-500 border-t-transparent"})}):c.length===0?e.jsxs("div",{className:"text-center py-20",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-tiffany-100 to-accent-100 dark:from-tiffany-500/10 dark:to-accent-500/10 rounded-3xl mb-6",children:e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500",children:"movie"})}),e.jsx("h2",{className:"text-xl font-semibold text-text-light-primary dark:text-text-dark-primary mb-2",children:"还没有剧集"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary mb-6",children:'点击上方"新建剧集"按钮创建第一集'}),e.jsxs("button",{onClick:()=>{s({name:"",episodeNumber:B(),description:""}),b(!0)},className:"px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-lg transition-all inline-flex items-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add"}),"新建剧集"]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4",children:c.map(t=>e.jsxs("div",{onClick:()=>n(`/projects/${d}/episodes/${t.id}`),className:"relative border border-neutral-200 dark:border-neutral-800 rounded-2xl overflow-hidden hover:border-neutral-400 dark:hover:border-neutral-600 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group cursor-pointer aspect-[4/3]",children:[e.jsxs("div",{className:"absolute inset-0",children:[e.jsx(Z,{thumbnail:t.thumbnail||"",name:t.name,episodeNumber:t.episodeNumber}),(m==null?void 0:m.isOwner)!==!1&&e.jsxs("div",{className:"absolute top-2 left-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:a=>{a.stopPropagation(),H(t)},className:"w-7 h-7 flex items-center justify-center bg-black/60 dark:bg-white/80 hover:bg-black dark:hover:bg-white text-white dark:text-black rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"编辑剧集",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"edit"})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),J(t)},className:"w-7 h-7 flex items-center justify-center bg-black/60 dark:bg-white/80 hover:bg-black dark:hover:bg-white text-white dark:text-black rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"权限管理",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"group"})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),q(t.id)},className:"w-7 h-7 flex items-center justify-center bg-black/60 dark:bg-white/80 hover:bg-black dark:hover:bg-white text-white dark:text-black rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"删除剧集",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}),t.status!=="DRAFT"&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-1 rounded-lg text-xs font-medium text-white bg-black/50 dark:bg-white/20 backdrop-blur-sm z-10",children:Q(t.status)})]}),e.jsxs("div",{className:"absolute bottom-3 left-3 right-3 p-3 bg-white/50 dark:bg-black/50 backdrop-blur-md rounded-xl z-10",children:[e.jsx("h3",{className:"font-semibold text-sm text-neutral-900 dark:text-white truncate",children:t.name}),e.jsx("p",{className:"text-xs text-neutral-500 dark:text-neutral-400 mt-0.5 truncate",children:t.description||"暂无描述"})]})]},t.id))}),C&&e.jsx(A,{isEdit:!1,onSubmit:G,formData:u,setFormData:s,episodes:c,editingEpisodeId:null,thumbnail:w,setThumbnail:o,thumbnailFile:P,setThumbnailFile:g,onClose:()=>{b(!1),s({name:"",description:"",episodeNumber:1}),o(null),g(null)}}),f&&h&&e.jsx(A,{isEdit:!0,onSubmit:O,formData:u,setFormData:s,episodes:c,editingEpisodeId:h.id,thumbnail:w,setThumbnail:o,thumbnailFile:P,setThumbnailFile:g,onClose:()=>{$(!1),N(null),s({name:"",description:"",episodeNumber:1}),o(null),g(null)}}),x&&L&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"p-6 border-b border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-slate-800 dark:text-white",children:["权限管理 - 第",L.episodeNumber,"集"]}),e.jsx("button",{onClick:()=>{R(!1),j(null),F([])},className:"w-8 h-8 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 rounded-lg",children:e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-slate-400",children:"close"})})]}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:"为协作者设置该剧集的编辑权限"})]}),e.jsx("div",{className:"p-6 max-h-[400px] overflow-y-auto",children:U?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("span",{className:"material-symbols-outlined text-2xl text-purple-500 animate-spin",children:"progress_activity"})}):V.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500 dark:text-slate-400",children:[e.jsx("span",{className:"material-symbols-outlined text-4xl mb-2 block",children:"group_off"}),e.jsx("p",{children:"暂无协作者"}),e.jsx("p",{className:"text-sm mt-1",children:"请先在项目设置中添加协作者"})]}):e.jsx("div",{className:"space-y-3",children:V.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-white/5 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[t.avatar?e.jsx("img",{src:t.avatar,alt:"",className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",children:"person"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-800 dark:text-white",children:t.nickname||"未命名用户"}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:t.permission==="EDIT"?"可编辑分镜脚本":"仅可查看"})]})]}),e.jsxs("select",{value:t.permission,onChange:a=>K(t.id,a.target.value),className:"px-3 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-white/10 rounded-lg text-sm text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"READ",children:"只读"}),e.jsx("option",{value:"EDIT",children:"编辑"})]})]},t.id))})}),e.jsx("div",{className:"p-4 border-t border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5",children:e.jsx("button",{onClick:()=>{R(!1),j(null),F([])},className:"w-full py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:shadow-lg transition-all",children:"完成"})})]})})]})},Z=({thumbnail:n,name:d,episodeNumber:m})=>{const[y,c]=r.useState([]),[S,I]=r.useState(0),[E,C]=r.useState(!1);r.useEffect(()=>{if(C(!1),I(0),!n){c([]);return}if(n.startsWith("http")||n.startsWith("data:")){c([n]);return}const f=n.startsWith("/")?n:`/${n}`,h="https://api.waule.ai".replace(/\/$/,"").replace(/\/api$/,""),N=M.defaults.baseURL&&M.defaults.baseURL.startsWith("http")?M.defaults.baseURL.replace(/\/$/,"").replace(/\/api$/,""):"",w=window.location.origin.replace(/\/$/,""),o=[];w&&o.push(`${w}${f}`),h&&o.push(`${h}${f}`),N&&o.push(`${N}${f}`),c(o)},[n]);const b=y[S]||null;return!n||E||!b?e.jsx("div",{className:"episode-fallback w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-300 dark:text-white/30 mb-2 block",children:"movie"}),e.jsxs("div",{className:"text-2xl font-bold text-tiffany-400 dark:text-white/40",children:["第 ",m," 集"]})]})}):e.jsx("img",{src:b,alt:d,className:"w-full h-full object-cover",onError:()=>{S+1<y.length?I(S+1):C(!0)}})};export{re as default};
