const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DOiS8MNr.js","assets/react-vendor-CnSaCHf4.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-COwzeFBM.js","assets/utils-BcyDR7Vi.js","assets/index-BauPnFGN.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Dt,u as Pr,e as ia,d as la}from"./react-vendor-CnSaCHf4.js";import{u as kr,l as ca,c as Me,_ as gs,b as h,e as da}from"./index-DOiS8MNr.js";import{P as dt,H as Xs,a as ts,b as Ds,d as dr,e as Fs,g as ua,R as pa,f as fa,h as ga,i as ha,j as ma,C as xa}from"./reactflow-COwzeFBM.js";import{C as ba,L as Qs,S as hr,I as Tr,V as wa}from"./video-DBLD6CTd.js";import{c as Is}from"./createLucideIcon-Dx_rwhFP.js";import{f as Ws,g as Ts}from"./assetNaming-PUktT1IV.js";import{X as ya,j as Hs,L as Vs,o as Rr,a as ka,v as sr,U as Ur,b as va,N as Na}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=Is("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ia=Is("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=Is("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=Is("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=Is("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Aa=Is("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=Is("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yr=Is("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ta=Is("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ra=Is("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Or=Is("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gr=Is("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ua=Is("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),$a="https://api.waule.com";function Ma(s){const{workflowId:E,isSharedWorkflow:u,isReadOnly:K,onNodeAdd:Ie,onNodeUpdate:U,onNodeDelete:ve,onNodeMove:ee,onNodesMove:ce,onEdgeAdd:Z,onEdgeDelete:he,onGroupsUpdate:Oe,onUserJoin:me}=s,ae=t.useRef(null),se=t.useRef(!1),{token:fe}=kr(),[le,Ce]=t.useState([]);t.useEffect(()=>{if(!u||!E||!fe)return;const x=ca($a,{auth:{token:fe},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return ae.current=x,x.on("connect",()=>{se.current=!0,x.emit("join-workflow",E),x.emit("user:join",{workflowId:E})}),x.on("disconnect",m=>{se.current=!1}),x.on("connect_error",m=>{}),x.on("node:add",m=>{Ie==null||Ie(m.node,m.userId)}),x.on("node:update",m=>{U==null||U(m.nodeId,m.changes,m.userId)}),x.on("node:delete",m=>{ve==null||ve(m.nodeId,m.userId)}),x.on("node:move",m=>{ee==null||ee(m.nodeId,m.position,m.userId)}),x.on("nodes:move",m=>{ce==null||ce(m.nodes,m.userId)}),x.on("edge:add",m=>{Z==null||Z(m.edge,m.userId)}),x.on("edge:delete",m=>{he==null||he(m.edgeId,m.userId)}),x.on("groups:update",m=>{Oe==null||Oe(m.groups,m.userId)}),x.on("user:join",m=>{me==null||me(m.user)}),x.on("users:online",m=>{Ce(m.users)}),()=>{ae.current&&(ae.current.emit("leave-workflow",E),ae.current.disconnect(),ae.current=null),se.current=!1,Ce([])}},[E,u,fe]);const Y=t.useCallback(x=>{ae.current&&se.current&&E&&!K&&ae.current.emit("node:add",{workflowId:E,node:x})},[E,K]),De=t.useCallback((x,m)=>{ae.current&&se.current&&E&&!K&&ae.current.emit("node:update",{workflowId:E,nodeId:x,changes:m})},[E,K]),we=t.useCallback(x=>{ae.current&&se.current&&E&&!K&&ae.current.emit("node:delete",{workflowId:E,nodeId:x})},[E,K]),oe=t.useCallback((x,m)=>{ae.current&&se.current&&E&&!K&&ae.current.emit("node:move",{workflowId:E,nodeId:x,position:m})},[E,K]),T=t.useCallback(x=>{ae.current&&se.current&&E&&!K&&ae.current.emit("nodes:move",{workflowId:E,nodes:x})},[E,K]),$=t.useCallback(x=>{ae.current&&se.current&&E&&!K&&ae.current.emit("edge:add",{workflowId:E,edge:x})},[E,K]),D=t.useCallback(x=>{ae.current&&se.current&&E&&!K&&ae.current.emit("edge:delete",{workflowId:E,edgeId:x})},[E,K]),_=t.useCallback(x=>{ae.current&&se.current&&E&&!K&&ae.current.emit("groups:update",{workflowId:E,groups:x})},[E,K]);return{isConnected:se.current,onlineUsers:le,emitNodeAdd:Y,emitNodeUpdate:De,emitNodeDelete:we,emitNodeMove:oe,emitNodesMove:T,emitEdgeAdd:$,emitEdgeDelete:D,emitGroupsUpdate:_}}const vr=1920,Vr=(s,E=vr,u=.9)=>new Promise((K,Ie)=>{const U=new Image,ve=URL.createObjectURL(s);U.onload=()=>{URL.revokeObjectURL(ve);let{width:ee,height:ce}=U;if(ee>E||ce>E){const me=E/Math.max(ee,ce);ee=Math.round(ee*me),ce=Math.round(ce*me)}const Z=document.createElement("canvas");Z.width=ee,Z.height=ce;const he=Z.getContext("2d");if(!he){Ie(new Error("Failed to get canvas context"));return}he.drawImage(U,0,0,ee,ce);const Oe=Z.toDataURL("image/jpeg",u);K(Oe)},U.onerror=()=>{URL.revokeObjectURL(ve),Ie(new Error("Failed to load image for compression"))},U.src=ve}),$r=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(u=>u.test(s)):!1,Da=async s=>{try{const E=s.startsWith("/uploads/")?`https://api.waule.com${s}`:s,K=await(await fetch(E)).blob();return await Vr(K,vr,.9)}catch(E){throw E}},Nr=async s=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(s.length>500*1024)try{const u=await(await fetch(s)).blob();return await Vr(u,vr,.9)}catch{return s}return s}return s.includes("aliyuncs.com")||s.includes("oss-cn-")||s.startsWith("https://")&&!$r(s)?s:$r(s)?await Da(s):s},vt=({type:s,position:E,id:u,className:K="",label:Ie,isConnectable:U,disabled:ve,style:ee,...ce})=>{const Z=E===dt.Left,he=U===!1||ve?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-purple-300 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-purple-300 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${K}`;return e.jsxs("div",{className:`absolute ${Z?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...ee||{}},children:[Z&&Ie&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:Ie}),e.jsx(Xs,{type:s,position:E,id:u,isConnectable:ve?!1:U,style:{position:"relative",[Z?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${he} !z-[10001]`,...ce}),!Z&&Ie&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:Ie})]})},rs=({value:s,onChange:E,options:u,className:K=""})=>{const[Ie,U]=t.useState(!1),ve=t.useRef(null);t.useEffect(()=>{if(!Ie)return;const Z=he=>{ve.current&&!ve.current.contains(he.target)&&U(!1)};return document.addEventListener("mousedown",Z,!0),()=>document.removeEventListener("mousedown",Z,!0)},[Ie]);const ee=u.find(Z=>Z.value===s),ce=Z=>{Z.stopPropagation(),U(!Ie)};return e.jsxs("div",{className:`relative ${K}`,ref:ve,children:[e.jsxs("div",{onClick:ce,onMouseDown:Z=>Z.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(ee==null?void 0:ee.label)||s}),e.jsx(ba,{size:12,className:`transition-transform ${Ie?"rotate-90":""}`})]}),Ie&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white/90 dark:bg-[#1a1a1a]/90 backdrop-blur-xl border-slate-200 dark:border-white/10",children:u.map(Z=>e.jsxs("div",{onClick:he=>{he.stopPropagation(),E(Z.value),U(!1)},onMouseDown:he=>he.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[Z.label,s===Z.value&&e.jsx(Sa,{size:10,className:"text-purple-500"})]},Z.value))})]})},Ls=s=>{const[E,u]=t.useState(null),[K,Ie]=t.useState(!1),[U,ve]=t.useState(!1),[ee,ce]=t.useState(0),[Z,he]=t.useState(0),Oe=t.useCallback(()=>{he(me=>me+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){u(null),ve(!1),ce(0);return}try{Ie(!0);const se=(await Me.post("/billing/estimate",s)).data,fe=(se==null?void 0:se.data)??se,le=(fe==null?void 0:fe.originalCredits)??(fe==null?void 0:fe.credits)??0;u(le),ve((fe==null?void 0:fe.isFreeUsage)??!1),ce((fe==null?void 0:fe.freeUsageRemaining)??0)}catch{u(null),ve(!1),ce(0)}finally{Ie(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,Z]),{credits:E,loading:K,isFreeUsage:U,freeUsageRemaining:ee,refetch:Oe}},fs=({createdBy:s,isSharedWorkflow:E})=>{if(!E||!s||typeof s=="string")return null;const{nickname:u,avatar:K}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:u||"æœªçŸ¥ç”¨æˆ·",children:K?e.jsx("img",{src:K,alt:u||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(u||"?")[0].toUpperCase()})})},La=({data:s,selected:E,id:u})=>{var ie;const[K,Ie]=t.useState(s.isExpanded!==!1),[U,ve]=t.useState(null),[ee,ce]=t.useState(s.config.prompt||""),[Z,he]=t.useState(s.config.ratio||""),[Oe,me]=t.useState(s.config.imageSize||"2K"),[ae,se]=t.useState(s.config.maxImages||1),[fe,le]=t.useState(!1),[,Ce]=t.useState(0),[,Y]=t.useState(s.config.taskId||""),[De,we]=t.useState(s.config.referenceImages||[]),[oe,T]=t.useState(null),$=t.useRef(null),D=t.useRef(!1),{setNodes:_,setEdges:x,getNode:m,getEdges:I,getNodes:te}=ts(),M=Ds(),C=dr(k=>k.edges.filter(p=>p.target===u)),O=t.useRef(""),r=t.useRef(""),{credits:y,loading:l,isFreeUsage:n,freeUsageRemaining:o,refetch:a}=Ls({aiModelId:U==null?void 0:U.id,quantity:1,resolution:Oe}),c=t.useMemo(()=>(s.models||[]).filter(k=>k.type==="IMAGE_GENERATION"&&k.isActive&&!k.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const k=c.find(p=>p.id===s.config.modelId);if(k){ve(k);const p=k.config;p!=null&&p.supportedRatios&&p.supportedRatios.length>0&&!Z&&he(p.supportedRatios[0]),s.config.acceptedInputs||f({acceptedInputs:(p==null?void 0:p.acceptedInputs)||["TEXT","IMAGE"]})}}else if(c.length>0){ve(c[0]);const k=c[0].config;k!=null&&k.supportedRatios&&k.supportedRatios.length>0&&!Z&&he(k.supportedRatios[0]),s.config.acceptedInputs||f({acceptedInputs:(k==null?void 0:k.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,c]),t.useEffect(()=>{const k=s.config.taskId;(async()=>{if(k)try{const b=(await Me.tasks.getTaskStatus(k)).task;if(b.status==="SUCCESS"){le(!1),Ce(100);const V=b.resultUrl;if(!V){le(!1),Ce(0),f({taskId:""}),Dt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ne=s.config.ratio||"1:1";f({prompt:s.config.prompt||ee,ratio:ne,modelId:s.config.modelId||(U==null?void 0:U.id),generatedImageUrl:V,taskId:""});const H=te(),ge=I();if(H.filter(_e=>_e.type==="imagePreview"&&ge.some(je=>je.source===u&&je.target===_e.id)).find(_e=>_e.data.imageUrl===V)){f({taskId:""}),Dt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Dt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const _e=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(_e).some(Re=>Re.taskId&&Re.taskId===k||Re.sourceNodeId&&Re.sourceNodeId===u)||de(V,ne)}catch{de(V,ne)}}else b.status==="PROCESSING"||b.status==="PENDING"?(le(!0),Ce(b.progress||0),F(k)):b.status==="FAILURE"&&(le(!1),Ce(0),f({taskId:""}),Dt.error(b.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${b.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{le(!1),Ce(0),f({taskId:""}),Dt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const w=()=>{if(!U)return[];const k=U.config;return(k==null?void 0:k.supportedRatios)||[]},S=()=>{var b;const k=(b=s==null?void 0:s.config)==null?void 0:b.modelId,p=c.find(V=>V.id===k)||c[0],N=(p==null?void 0:p.config)||{};return N.maxReferenceImages||N.supportedReferenceImagesLimit||N.referenceImagesLimit||10};function L(k){var N,b,V,ne,H,ge,Se;const p=(k==null?void 0:k.type)||"";if(p==="upload")return(((b=(N=k==null?void 0:k.data)==null?void 0:N.config)==null?void 0:b.uploadedFiles)||[]).reduce((_e,je)=>{const Te=((je==null?void 0:je.type)||"").toUpperCase(),Re=((je==null?void 0:je.mimeType)||"").toLowerCase();return _e+(Te==="IMAGE"||Re.startsWith("image/")?1:0)},0);if(p==="assetSelector"){const ye=((V=k==null?void 0:k.data)==null?void 0:V.config)||{};if(ye.selectedAsset){const _e=(ye.selectedAsset.type||"").toUpperCase(),je=(ye.selectedAsset.mimeType||"").toLowerCase();return _e==="IMAGE"||je.startsWith("image/")?1:0}return Array.isArray(ye.subjects)&&ye.subjects.length>0&&(((ne=ye.subjects[0])==null?void 0:ne.images)||[]).length>0?1:0}return p==="aiImage"?((ge=(H=k==null?void 0:k.data)==null?void 0:H.config)==null?void 0:ge.generatedImageUrl)?1:0:p==="imagePreview"&&((Se=k==null?void 0:k.data)==null?void 0:Se.imageUrl)?1:0}function q(k){var b,V,ne,H;const p=(k==null?void 0:k.type)||"",N=k==null?void 0:k.data;if(p==="upload"&&((V=(b=N==null?void 0:N.config)==null?void 0:b.uploadedFiles)==null?void 0:V.length)>0){const ge=N.config.uploadedFiles[0],Se=(ge.type||"").toUpperCase(),ye=(ge.mimeType||"").toLowerCase();return Se==="IMAGE"||ye.startsWith("image/")?"IMAGE":Se==="VIDEO"||ye.startsWith("video/")?"VIDEO":Se==="AUDIO"||ye.startsWith("audio/")?"AUDIO":Se||null}if(p==="assetSelector"){if((ne=N==null?void 0:N.config)!=null&&ne.subjects)return"IMAGE";if((H=N==null?void 0:N.config)!=null&&H.selectedAsset){const ge=N.config.selectedAsset,Se=(ge.type||"").toUpperCase(),ye=(ge.mimeType||"").toLowerCase();return Se==="IMAGE"||ye.startsWith("image/")?"IMAGE":Se==="VIDEO"||ye.startsWith("video/")?"VIDEO":Se==="AUDIO"||ye.startsWith("audio/")?"AUDIO":Se||null}}return p==="aiImage"||p==="imagePreview"?"IMAGE":(p||"").startsWith("aiVideo")||p==="videoPreview"?"VIDEO":p==="agent"?"TEXT":null}const Q=t.useMemo(()=>{const k=C,p=k.some(V=>{const ne=m(V.source);return((ne==null?void 0:ne.type)||"")==="agent"}),N=S(),b=k.reduce((V,ne)=>V+L(m(ne.source)),0);return p&&b>=N},[C,m]),g=k=>{const p=m(k.source);if(!p)return!1;const N=p.type||"",b=I().filter(ye=>ye.target===u),V=q(p);if(V==="VIDEO"||V==="AUDIO"||V==="DOCUMENT")return!1;const ne=b.some(ye=>{const _e=m(ye.source);return((_e==null?void 0:_e.type)||"")==="agent"});if(N==="agent"||N==="textPreview")return!ne;const H=b.reduce((ye,_e)=>ye+L(m(_e.source)),0),ge=L(p),Se=S();return H+ge<=Se};t.useEffect(()=>{const k=C;let N=S();const b=[];k.forEach(V=>{const ne=m(V.source),H=L(ne);H<=0||(N-H>=0?N-=H:b.push(V.id))}),b.length>0&&(x(V=>V.filter(ne=>!b.includes(ne.id))),Dt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[C,m,x]),t.useEffect(()=>{const k=C,p=[];k.forEach(N=>{const b=m(N.source),V=q(b);(V==="VIDEO"||V==="AUDIO"||V==="DOCUMENT")&&p.push(N.id)}),p.length>0&&(x(N=>N.filter(b=>!p.includes(b.id))),Dt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[C,m,x]),t.useEffect(()=>{const k=C.map(ne=>{var ye,_e,je,Te,Re;const H=m(ne.source);if(!H)return`${ne.id}-${ne.source}`;const ge=H.data||{};let Se=[];if(H.type==="assetSelector"){const re=(ye=ge.config)==null?void 0:ye.subjects;if(re&&re.length>0){const Be=(_e=re[0].images)==null?void 0:_e[0];Se=Be?[Be]:[]}else(je=ge.config)!=null&&je.selectedAsset&&ge.config.selectedAsset.type==="IMAGE"&&(Se=[ge.config.selectedAsset.url])}else if(H.type==="upload")Se=(((Te=ge.config)==null?void 0:Te.uploadedFiles)||[]).filter(Be=>Be.type==="IMAGE").map(Be=>Be.url);else if(H.type==="aiImage"||H.type==="imagePreview"){const re=((Re=ge.config)==null?void 0:Re.generatedImageUrl)||ge.imageUrl;re&&(Se=[re])}return`${ne.id}-${ne.source}-${Se.join("|")}`}).sort().join(",");if(k===O.current)return;O.current=k;const p=[];let N="";C.forEach(ne=>{var ge,Se,ye,_e,je,Te;const H=m(ne.source);if(H){const Re=H.data;if(H.type==="agent"&&((ge=Re.config)!=null&&ge.generatedText)?N||(N=Re.config.generatedText):H.type==="textPreview"&&Re.content&&(N||(N=Re.content)),H.type==="assetSelector"&&((Se=Re.config)!=null&&Se.subjects)&&Re.config.subjects.length>0){const Be=(ye=Re.config.subjects[0].images)==null?void 0:ye[0];Be&&!p.includes(Be)&&p.push(Be)}let re=((_e=Re.config)==null?void 0:_e.generatedImageUrl)||Re.imageUrl||"";if(!re&&((je=Re.config)!=null&&je.selectedAsset)){const Be=Re.config.selectedAsset;Be.type==="IMAGE"&&(re=Be.url)}if(!re&&((Te=Re.config)!=null&&Te.uploadedFiles)&&Re.config.uploadedFiles.length>0){const Be=Re.config.uploadedFiles[0];Be.type==="IMAGE"&&(re=Be.url)}re&&!p.includes(re)&&p.push(re)}});const b=S(),V=p.slice(0,Math.max(0,b));we(V),f({referenceImages:V}),N&&N!==ee&&(ce(N),f({prompt:N}))},[C,m,u,ee,M]),t.useEffect(()=>{if(C.length===0)return;let k="",p="";C.forEach(N=>{var V;const b=M.find(ne=>ne.id===N.source);if(b&&b.type==="agent"){const ne=b.data;(V=ne.config)!=null&&V.generatedText&&(k=ne.config.generatedText,p=`${b.id}-${ne.config.generatedText.substring(0,50)}`)}}),k&&p!==r.current&&(r.current=p,ce(k),f({prompt:k}))},[M,C,u]),t.useEffect(()=>{const k=$.current;k&&K&&requestAnimationFrame(()=>{k.style.height="auto";const p=Math.max(60,Math.min(k.scrollHeight,600));k.style.height=`${p}px`})},[ee,K]),t.useEffect(()=>{const k=setTimeout(()=>{ee!==s.config.prompt&&f({prompt:ee})},300);return()=>clearTimeout(k)},[ee]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ee&&ce(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{Z&&Z!==s.config.ratio&&f({ratio:Z})},[Z]),t.useEffect(()=>{Oe&&Oe!==s.config.imageSize&&f({imageSize:Oe})},[Oe]),t.useEffect(()=>{var k;if((U==null?void 0:U.modelId)==="gemini-3-pro-image-preview"){const p=((k=U==null?void 0:U.config)==null?void 0:k.supportedResolutions)||[];(p.length>0&&!p.includes(Oe)||p.length===1)&&me(p[0])}},[U]),t.useEffect(()=>{ae!==s.config.maxImages&&f({maxImages:ae})},[ae]);const f=k=>{m(u)&&_(N=>N.map(b=>b.id===u?{...b,data:{...b.data,config:{...b.data.config,...k}}}:b))},d=k=>{T(k)},B=(k,p)=>{if(k.preventDefault(),oe===null||oe===p)return;const N=[...De],b=N[oe];N.splice(oe,1),N.splice(p,0,b),we(N),T(p)},P=()=>{T(null),f({referenceImages:De})},F=async k=>{let N=0;const b=async()=>{var V;try{N++;const H=(await Me.tasks.getTaskStatus(k)).task;if(Ce(H.progress||0),H.status==="SUCCESS"){le(!1),Ce(100);const ge=H.resultUrl,Se=(V=H.metadata)==null?void 0:V.allImageUrls;f({prompt:ee,ratio:Z,modelId:U==null?void 0:U.id,generatedImageUrl:ge,taskId:""}),Se&&Se.length>1?(ue(Se,Z),Dt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Se.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(de(ge,Z),Dt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(H.status==="FAILURE"){le(!1),Ce(0),f({taskId:""});const{useAuthStore:ge}=await gs(async()=>{const{useAuthStore:ye}=await import("./index-DOiS8MNr.js").then(_e=>_e.f);return{useAuthStore:ye}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Se}=ge.getState();await Se(),Dt.error(H.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(H.status==="PROCESSING"||H.status==="PENDING")&&(N<600?setTimeout(b,1e3):(le(!1),Ce(0),f({taskId:""}),Dt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{le(!1),Ce(0),f({taskId:""}),Dt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};b()},X=async()=>{var k,p,N,b,V;if(!(!ee.trim()||!U)){le(!0),Ce(0);try{let ne=[];if(De.length>0)try{for(const Re of De){const re=await Nr(Re);ne.push(re)}}catch{}let H=ee.trim();U.modelId==="doubao-seedream-4-5-251128"&&ae>1&&(H=`ç”Ÿæˆä¸€ç»„å…±${ae}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${H}`),U.modelId==="gemini-3-pro-image-preview"&&Z&&(H=`${H}ï¼Œç”Ÿæˆ${Z}çš„æ¯”ä¾‹`);const ge={modelId:U.id,prompt:H,ratio:Z||"1:1",referenceImages:ne.length>0?ne:void 0};U.modelId==="gemini-3-pro-image-preview"&&(ge.imageSize=Oe),U.modelId==="doubao-seedream-4-5-251128"&&ae>1&&(ge.maxImages=ae);const Se=await Me.tasks.createImageTask(ge),ye=Se.taskId,_e=Se.creditsCharged||0,je=Se.isFreeUsage,Te=Se.freeUsageRemaining??0;if(Y(ye),f({prompt:ee,ratio:Z,modelId:U.id,taskId:ye}),je)Dt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Te} æ¬¡æœºä¼š`),a();else if(_e>0){const{useAuthStore:Re}=await gs(async()=>{const{useAuthStore:Be}=await import("./index-DOiS8MNr.js").then(qe=>qe.f);return{useAuthStore:Be}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:re}=Re.getState();await re(),Dt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${_e} ç§¯åˆ†`),a()}else Dt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");F(ye)}catch(ne){if(le(!1),Ce(0),((k=ne.response)==null?void 0:k.status)===403){const H=((N=(p=ne.response)==null?void 0:p.data)==null?void 0:N.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Dt.error(H)}else{const H=((V=(b=ne.response)==null?void 0:b.data)==null?void 0:V.error)||ne.message||"æœªçŸ¥åŸå› ";Dt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${H}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ue=(k,p)=>{!k||k.length===0||k.forEach((N,b)=>{setTimeout(()=>{de(N,p,b)},b*100)})},de=(k,p,N)=>{const b=m(u);if(!b)return;const V=1,ne=te(),H=I(),ge=ne.filter(Ot=>Ot.type==="imagePreview"&&H.some(tt=>tt.source===u&&tt.target===Ot.id));if(ge.find(Ot=>Ot.data.imageUrl===k))return;const ye=400,_e=(Ot,tt=300)=>{if(!Ot||!/^[0-9]+\s*:\s*[0-9]+$/.test(Ot))return tt;const[_t,Kt]=Ot.split(":").map(bs=>parseFloat(bs));return!_t||!Kt?tt:Math.round(ye*(Kt/_t))},je=document.querySelector(`.react-flow__node[data-id="${u}"]`),Te=(je==null?void 0:je.getBoundingClientRect().width)||400,Re=Math.round(Te/V),re=200,Be=100,qe=_e(p,300),Ft=b.position.x+Re+re,at=b.position.y,ot=N!==void 0?ge.length+N:ge.length,Le=Ft,ut=at+ot*(qe+Be),Et=Date.now(),nt={id:`preview-${u}-${Et}`,type:"imagePreview",position:{x:Le,y:ut},data:{imageUrl:k,width:ye,ratio:p,workflowContext:b.data.workflowContext,createdBy:b.data.createdBy}};_(Ot=>[...Ot,nt]);const yt={id:`edge-${u}-${nt.id}`,source:u,target:nt.id,targetHandle:`${nt.id}-target`,type:"aurora"};x(Ot=>Ot.find(_t=>_t.source===u&&_t.target===nt.id)?Ot:[...Ot,yt])};if(t.useEffect(()=>{s.isExpanded!==void 0&&Ie(s.isExpanded)},[s.isExpanded]),!K&&s.config.generatedImageUrl){const[k,p]=(s.config.ratio||"1:1").split(":").map(Number),N=k/p,b=320,V=b/N;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:b,height:V},onDoubleClick:()=>{Ie(!0),m(u)&&_(H=>H.map(ge=>ge.id===u?{...ge,data:{...ge.data,isExpanded:!0}}:ge))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:Q,isValidConnection:g}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),ee&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:ee,children:ee})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!K&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{Ie(!0),m(u)&&_(p=>p.map(N=>N.id===u?{...N,data:{...N.data,isExpanded:!0}}:N))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:Q,isValidConnection:g}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:ee?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:ee})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:Q,isValidConnection:g}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:K?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:(U==null?void 0:U.id)||"",onChange:k=>{const p=c.find(N=>N.id===k);if(ve(p||null),p){const N=p.config;N!=null&&N.supportedRatios&&N.supportedRatios.length>0&&he(N.supportedRatios[0]),f({modelId:p.id,acceptedInputs:(N==null?void 0:N.acceptedInputs)||["TEXT","IMAGE"]})}},options:c.map(k=>({value:k.id,label:k.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:$,value:ee,onChange:k=>{D.current=!0,ce(k.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),De.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",De.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:De.map((k,p)=>e.jsxs("div",{draggable:!0,onDragStart:N=>{N.stopPropagation(),d(p)},onDragEnd:N=>{N.stopPropagation(),P()},onDragOver:N=>{N.stopPropagation(),B(N,p)},className:`nodrag relative group cursor-move aspect-square ${oe===p?"opacity-50":""}`,children:[e.jsx("img",{src:k,alt:`å›¾ç‰‡${p+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-purple-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:p+1})]},p))})]}),(U==null?void 0:U.modelId)==="gemini-3-pro-image-preview"&&(()=>{var p;const k=((p=U==null?void 0:U.config)==null?void 0:p.supportedResolutions)||[];return k.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${k.length} gap-2`,children:k.map(N=>e.jsx("button",{onClick:()=>me(N),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Oe===N?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:N==="4K"?"4k":"hd"}),e.jsx("span",{children:N})]})},N))})]})})(),(U==null?void 0:U.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-purple-500 dark:text-purple-400",children:[ae," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:ae,onChange:k=>se(Number(k.target.value)),className:"nodrag w-full h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-500"}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),ae>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),w().length>0&&e.jsx("div",{className:"space-y-1",children:((ie=U==null?void 0:U.provider)==null?void 0:ie.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>he("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Z==="16:9"?"bg-purple-600 text-white border-purple-500":"bg-purple-950/50 text-purple-300 border-purple-700/30 hover:bg-purple-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>he("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Z==="9:16"?"bg-purple-600 text-white border-purple-500":"bg-purple-950/50 text-purple-300 border-purple-700/30 hover:bg-purple-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(rs,{value:Z,onChange:k=>he(k),options:w().map(k=>{const[p,N]=k.split(":");return{value:k,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[k]||`${p}:${N}`}})})]})}),e.jsx("button",{onClick:X,onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),disabled:fe||!ee.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${fe?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!l&&(n?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",o,"æ¬¡"]}):y!==null&&y>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[y,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Pa=t.memo(La),cr="https://api.waule.com",Oa=({data:s,selected:E,id:u})=>{var ms,Es,Ys,G,z,Pe,Ue,Xe,We,Ye,ct;const[K,Ie]=t.useState(!0),[,U]=t.useState(0),[ve,ee]=t.useState(s.config.taskId||""),ce=s.config.modelId,Z=s.config.duration||5,he=s.config.resolution||"720p",{credits:Oe,loading:me,isFreeUsage:ae,freeUsageRemaining:se,refetch:fe}=Ls({aiModelId:ce,duration:Z,resolution:he});t.useEffect(()=>{},[ve]);const{setNodes:le,setEdges:Ce,getNode:Y,getNodes:De,getEdges:we}=ts(),oe=Fs(),T=Ds(),$=t.useRef(""),D=(ms=s.config)==null?void 0:ms.selectedEditingCapability,_=t.useMemo(()=>{const j=(s.models||[]).filter(A=>{var pe;return((pe=A.provider)==null?void 0:pe.toLowerCase())!=="sora"&&A.id!=="sora-video"});if(D){const A=j.filter(Ne=>Ne.type==="VIDEO_EDITING").filter(Ne=>{var xe;return Array.isArray((xe=Ne==null?void 0:Ne.config)==null?void 0:xe.supportedEditingCapabilities)&&Ne.config.supportedEditingCapabilities.includes(D)}),pe=j.filter(Ne=>Ne.type==="VIDEO_GENERATION").filter(Ne=>{var xt,it;if(D!=="è§†é¢‘æ¢äºº")return!1;const xe=((xt=Ne==null?void 0:Ne.config)==null?void 0:xt.supportsVideoEditing)===!0,Ze=(Array.isArray((it=Ne==null?void 0:Ne.config)==null?void 0:it.supportedGenerationTypes)?Ne.config.supportedGenerationTypes:[]).some(Ge=>(Ge||"").toLowerCase().includes("æ¢äºº")||(Ge||"").includes("è§†é¢‘æ¢äºº"));return xe||Ze}),Ae={};return[...A,...pe].forEach(Ne=>{Ae[Ne.id]||(Ae[Ne.id]=Ne)}),Object.values(Ae)}return j.filter(A=>A.type==="VIDEO_GENERATION")},[s.models,D]),[x,m]=t.useState(s.config.prompt||""),I=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==x&&m(s.config.prompt)},[s.config.prompt]);const[te,M]=t.useState(s.config.modelId||((Es=_[0])==null?void 0:Es.id)||""),[C,O]=t.useState(s.config.ratio||"16:9"),[r,y]=t.useState(s.config.resolution||""),l=t.useCallback(j=>{const A=(j||"").toLowerCase();return A?A.includes("æ–‡ç”Ÿ")||A.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":A.includes("é¦–å°¾")?"é¦–å°¾å¸§":A.includes("é¦–å¸§")||A.includes("first frame")||A.includes("start frame")||A.includes("initial frame")||A.includes("keyframe")?"é¦–å¸§":A.includes("å°¾å¸§")||A.includes("last frame")||A.includes("end frame")||A.includes("final frame")?"å°¾å¸§":A.includes("ä¸»ä½“å‚è€ƒ")||A.includes("å‚è€ƒ")||A.includes("reference image")||A.includes("image reference")||A.includes("ref image")?"å‚è€ƒå›¾":A.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":A.includes("first-last")||A.includes("two-frame")||A.includes("frame pair")?"é¦–å°¾å¸§":A.includes("first")?"é¦–å¸§":A.includes("last")?"å°¾å¸§":A.includes("subject")||A.includes("reference")?"å‚è€ƒå›¾":j||"":""},[]),[n,o]=t.useState((s.config.lockedGenerationType?l(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[a,c]=t.useState(s.config.duration||5),[w,S]=t.useState(s.config.audio||!1),[L,q]=t.useState(s.config.movementAmplitude||"auto"),[Q,g]=t.useState(!1),[f,d]=t.useState([]),[B,P]=t.useState(null),[F,X]=t.useState(!1),[ue]=t.useState(""),[de]=t.useState("confirm"),[ie]=t.useState(null),[k,p]=t.useState(!1),[N,b]=t.useState([]),[V,ne]=t.useState(""),[H,ge]=t.useState(0),[Se,ye]=t.useState(0),[_e,je]=t.useState({}),[Te,Re]=t.useState([]),re=_.find(j=>j.id===te);t.useEffect(()=>{var j,A;if(!_.find(pe=>pe.id===te)){const pe=((j=_[0])==null?void 0:j.id)||"";M(pe),Le({modelId:pe,modelName:(A=_[0])==null?void 0:A.name})}},[_]),t.useEffect(()=>{var j;if((j=re==null?void 0:re.config.supportedResolutions)!=null&&j.length){const A=re.config.supportedResolutions;if(!r||!A.includes(r)){const pe=A[0];y(pe),Le({resolution:pe})}}},[re==null?void 0:re.id]),t.useEffect(()=>{var pe;const j=(pe=re==null?void 0:re.modelId)==null?void 0:pe.includes("viduq2"),A=l(n)==="é¦–å°¾å¸§";j&&A&&a>8&&(c(8),Le({duration:8}))},[n,re==null?void 0:re.modelId]);const Be=((Ys=re==null?void 0:re.provider)==null?void 0:Ys.toLowerCase())==="sora",qe=t.useMemo(()=>{var j,A,pe,Ae;if((j=re==null?void 0:re.config.supportedDurations)!=null&&j.length){let Ne=re.config.supportedDurations;const xe=(A=re.modelId)==null?void 0:A.includes("viduq2"),Qe=l(n)==="é¦–å°¾å¸§";return xe&&Qe&&(Ne=Ne.filter(xt=>xt<=8)),(((pe=re.provider)==null?void 0:pe.toLowerCase())==="minimax"||((Ae=re.modelId)==null?void 0:Ae.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(Ne=Ne.filter(xt=>xt===6)),Ne}return[a||5]},[re,a,n,l,r]),Ft=t.useMemo(()=>{var j;return(j=re==null?void 0:re.config.supportedResolutions)!=null&&j.length?re.config.supportedResolutions:[]},[re]),at=!re||!((G=re.config.supportedDurations)!=null&&G.length),ot=!re||!((z=re.config.supportedResolutions)!=null&&z.length),Le=t.useCallback(j=>{Y(u)&&le(pe=>pe.map(Ae=>Ae.id===u?{...Ae,data:{...Ae.data,config:{...Ae.data.config,...j}}}:Ae))},[Y,u,le]);t.useEffect(()=>{if(qe.length>0&&!qe.includes(a)){const j=qe[0];c(j),Le({duration:j})}},[qe,a,Le]);const ut=(j,A)=>{const pe=(xt,it)=>it===0?xt:pe(it,xt%it),Ae=pe(j,A),Ne=j/Ae,xe=A/Ae,Qe={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},Ze=`${Ne}:${xe}`;return Qe[Ze]||Ze},Et=()=>{const j=oe.filter(Qe=>Qe.target===u),A=[];j.forEach(Qe=>{var xt;const Ze=Y(Qe.source);if(Ze&&Ze.type==="upload"&&(((xt=Ze.data.config)==null?void 0:xt.uploadedFiles)||[]).forEach(Ge=>{const Rt=Ge.type||Ge.mimeType||"";(Rt==="IMAGE"||Rt.startsWith("image/"))&&A.push({id:Ge.id||Ge.name,url:Ge.url,name:Ge.name||Ge.originalName,width:Ge.width,height:Ge.height,aspectRatio:Ge.width&&Ge.height?ut(Ge.width,Ge.height):"16:9"})}),Ze&&Ze.type==="assetSelector"){const it=Ze.data.config||{},Ge=it.subjects,Rt=it.selectedAsset,Bt=l(n);Ge&&Ge.length>0?Bt==="é¦–å°¾å¸§"||(Ge[0].images||[]).forEach((Gt,wt)=>{A.push({id:`${Ze.id}-subject-${wt}`,url:Gt,name:Ge[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Rt&&Rt.type==="IMAGE"&&A.push({id:Rt.id,url:Rt.url,name:Rt.name||Rt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(Ze&&Ze.type==="imagePreview"){const it=Ze.data.imageUrl,Ge=Ze.data.width,Rt=Ze.data.height;it&&A.push({id:Ze.id,url:it,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:Ge,height:Rt,aspectRatio:Ge&&Rt?ut(Ge,Rt):"16:9"})}});const pe=new Set,Ae=[];A.forEach(Qe=>{const Ze=Qe.url;pe.has(Ze)||(pe.add(Ze),Ae.push(Qe))});const Ne=l(n);let xe=[];return Ne==="æ–‡ç”Ÿè§†é¢‘"?xe=[]:Ne==="é¦–å¸§"||Ne==="å°¾å¸§"?xe=Ae.slice(0,1):Ne==="é¦–å°¾å¸§"?xe=Ae.slice(0,2):Ne==="å‚è€ƒå›¾"?xe=Ae.slice(0,7):xe=Ae,xe},nt=t.useMemo(()=>Et(),[oe,T,n,u]),yt=j=>{if(!I.current)return;const A=I.current,pe=A.selectionStart||x.length,Ae=x.slice(0,pe),Ne=x.slice(pe),xe=`@${j} `,Qe=Ae+xe+Ne;m(Qe),je(Ze=>({...Ze,[j]:`image-${j}`})),setTimeout(()=>{const Ze=pe+xe.length;A.setSelectionRange(Ze,Ze),A.focus()},0)},Ot=t.useCallback(async()=>{var j;if(!(Te.length>0))try{const A=await Me.assetLibraries.getAll({includeShared:"true"}),pe=A.data||A||[],Ae=[];for(const Ne of pe)if(Ne.category==="ROLE")try{const xe=await Me.assetLibraries.roles.list(Ne.id),Qe=xe.data||xe||[];for(const Ze of Qe)Ae.push({id:Ze.id,name:((j=Ze.metadata)==null?void 0:j.name)||Ze.name||"",thumbnail:Ze.thumbnail})}catch{}Re(Ae)}catch{}},[Te.length]),tt=t.useCallback(j=>{if(!j){b(Te.slice(0,5));return}const A=Te.filter(pe=>pe.name.toLowerCase().includes(j.toLowerCase())).slice(0,5);b(A),ye(0)},[Te]),_t=t.useCallback(j=>{const A=j.target.value,pe=j.target.selectionStart||0;m(A);const Ne=A.substring(0,pe).match(/@([^@\s]*)$/);if(Ne){const xe=Ne[1];ne(xe),ge(pe-xe.length-1),p(!0),Ot().then(()=>tt(xe))}else p(!1),b([])},[Ot,tt]),Kt=t.useCallback(j=>{const A=x.substring(0,H),pe=x.substring(H+V.length+1),Ae=`@${j.name} `,Ne=A+Ae+pe;m(Ne),je(xe=>({...xe,[j.name]:j.id})),p(!1),b([]),ne(""),setTimeout(()=>{if(I.current){I.current.focus();const xe=A.length+Ae.length;I.current.setSelectionRange(xe,xe)}},0)},[x,H,V]),bs=t.useCallback(j=>{!k||N.length===0||(j.key==="ArrowDown"?(j.preventDefault(),ye(A=>A<N.length-1?A+1:A)):j.key==="ArrowUp"?(j.preventDefault(),ye(A=>A>0?A-1:A)):j.key==="Enter"&&N[Se]?(j.preventDefault(),Kt(N[Se])):j.key==="Escape"&&p(!1))},[k,N,Se,Kt]);t.useEffect(()=>{const j=s.config.taskId;(async()=>{if(j){try{const Ae=(await Me.tasks.getTaskStatus(j)).task;if(Ae.status==="SUCCESS"){g(!1),U(100);const Ne=Ae.resultUrl;if(!Ne){g(!1),U(0),Le({taskId:""}),ee(""),h.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const xe=s.config.ratio||"16:9";Le({prompt:s.config.prompt||x,ratio:xe,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:Ne,taskId:""}),ee("");const Qe=De(),Ze=we();if(Qe.filter(Ge=>Ge.type==="videoPreview"&&Ze.some(Rt=>Rt.source===u&&Rt.target===Ge.id)).find(Ge=>Ge.data.videoUrl===Ne)){setTimeout(()=>U(0),1e3);return}h.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const Ge=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Ge).some($t=>$t.taskId&&$t.taskId===j||$t.sourceNodeId&&$t.sourceNodeId===u)||Ss(Ne,xe)}catch{Ss(Ne,xe)}setTimeout(()=>U(0),1e3)}else if(Ae.status==="PROCESSING"||Ae.status==="PENDING"){g(!0),U(Ae.progress||0),Js(j);return}else Ae.status==="FAILURE"&&(g(!1),U(0),Le({taskId:""}),ee(""),h.error(`ç”Ÿæˆå¤±è´¥: ${Ae.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{g(!1),U(0),Le({taskId:""}),ee(""),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const j=oe.filter(pe=>pe.target===u);let A="";j.forEach(pe=>{var Ne;const Ae=Y(pe.source);if(Ae){const xe=Ae.data;Ae.type==="agent"&&((Ne=xe.config)!=null&&Ne.generatedText)?A||(A=xe.config.generatedText):Ae.type==="textPreview"&&xe.content&&(A||(A=xe.content))}}),A&&A!==x&&(m(A),Le({prompt:A}))},[oe,u,Y,x,Le]),t.useEffect(()=>{const j=oe.filter(Ae=>Ae.target===u);if(j.length===0)return;let A="",pe="";j.forEach(Ae=>{var xe;const Ne=T.find(Qe=>Qe.id===Ae.source);if(Ne&&Ne.type==="agent"){const Qe=Ne.data;(xe=Qe.config)!=null&&xe.generatedText&&(A=Qe.config.generatedText,pe=`${Ne.id}-${Qe.config.generatedText.substring(0,50)}`)}}),A&&pe!==$.current&&($.current=pe,m(A),Le({prompt:A}))},[T,oe,u,Le]),t.useEffect(()=>{const j=JSON.stringify(nt),A=JSON.stringify(f);j!==A&&d(nt)},[nt]);const cs=t.useMemo(()=>{const j=f.length,A=l(n);return j===0?!0:j===1?A==="å‚è€ƒå›¾":j===2?A==="é¦–å°¾å¸§"?!1:A==="å‚è€ƒå›¾":j>2?A==="å‚è€ƒå›¾":!1},[f.length,n,l]),Rs=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),ws=t.useMemo(()=>{const j=l(n);return D?_:_.filter(A=>{var Ae;const pe=(((Ae=A.config)==null?void 0:Ae.supportedGenerationTypes)||[]).map(Ne=>l(Ne));return j==="é¦–å¸§"||j==="å°¾å¸§"?pe.includes("é¦–å¸§")||pe.includes("å°¾å¸§"):pe.includes(j)})},[_,n,l,D]),zs=t.useMemo(()=>{const j=D?_:ws;return j.length>0?j:D?(s.models||[]).filter(pe=>(pe.type||"")==="VIDEO_EDITING"):j},[D,_,ws,s.models]);t.useEffect(()=>{var A,pe;if(!zs.find(Ae=>Ae.id===te)){const Ae=((A=zs[0])==null?void 0:A.id)||"";M(Ae),Le({modelId:Ae||void 0,modelName:Ae?(pe=zs[0])==null?void 0:pe.name:void 0})}},[zs]);const Nt=t.useCallback(j=>{const A=l(j);return D?["IMAGE","VIDEO"]:A==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[l,D]);t.useEffect(()=>{if(!cs&&f.length>0){const j=f[0].aspectRatio;j&&C!==j&&(O(j),setTimeout(()=>{Le({ratio:j})},0))}},[cs,f,C]),t.useEffect(()=>{if(!D&&Rs.length>0&&!Rs.includes(n)){const j="æ–‡ç”Ÿè§†é¢‘";o(j),setTimeout(()=>{Le({generationType:j,acceptedInputs:Nt(j)})},0)}},[Rs,n,Nt,D]),t.useEffect(()=>{l(n)==="é¦–å°¾å¸§"&&w&&(S(!1),Le({audio:!1}))},[n,l]),t.useEffect(()=>{const j=l(n);if(j==="æ–‡ç”Ÿè§†é¢‘")return;const A=oe.filter(xe=>xe.target===u),pe=[],Ae=[];A.forEach(xe=>{var xt,it,Ge,Rt,Bt;const Qe=Y(xe.source);if(!Qe)return;const Ze=Qe.type;if((Ze||"").startsWith("aiVideo")||Ze==="videoPreview"){Ae.push(xe.id);return}if(Ze==="upload"){const $t=(Ge=(it=(xt=Qe.data)==null?void 0:xt.config)==null?void 0:it.uploadedFiles)==null?void 0:Ge[0],Gt=(($t==null?void 0:$t.type)||"").toUpperCase(),wt=(($t==null?void 0:$t.mimeType)||"").toLowerCase();if(Gt==="VIDEO"||wt.startsWith("video/")){Ae.push(xe.id);return}(Gt==="IMAGE"||wt.startsWith("image/"))&&pe.push(xe.id);return}if(Ze==="assetSelector"){const $t=((Rt=Qe.data)==null?void 0:Rt.config)||{};if($t.selectedAsset){const Gt=($t.selectedAsset.type||"").toUpperCase(),wt=($t.selectedAsset.mimeType||"").toLowerCase();Gt==="VIDEO"||wt.startsWith("video/")?Ae.push(xe.id):(Gt==="IMAGE"||wt.startsWith("image/"))&&pe.push(xe.id)}else if($t.subjects&&$t.subjects.length>0){const Gt=(((Bt=$t.subjects[0])==null?void 0:Bt.images)||[]).length;j==="å‚è€ƒå›¾"||j==="é¦–å°¾å¸§"?pe.push(xe.id):(j==="é¦–å¸§"||j==="å°¾å¸§")&&(Gt>1?Ae.push(xe.id):pe.push(xe.id))}return}(Ze==="aiImage"||Ze==="imagePreview")&&pe.push(xe.id)});let Ne=new Set([...Ae]);j==="é¦–å¸§"||j==="å°¾å¸§"?pe.slice(1).forEach(xe=>Ne.add(xe)):j==="é¦–å°¾å¸§"&&pe.slice(2).forEach(xe=>Ne.add(xe)),Ne.size>0&&Ce(xe=>xe.filter(Qe=>!Ne.has(Qe.id)))},[n,oe,u,Y,Ce,l]),t.useEffect(()=>{const j=s.config.generationType;if(!j||l(j)!==l(n)){const A=l(n)||"æ–‡ç”Ÿè§†é¢‘";Le({generationType:A,acceptedInputs:Nt(A)})}},[]),t.useEffect(()=>{const j=Nt(n);Le({acceptedInputs:j})},[n,Nt]);const Ps=j=>{P(j)},ys=j=>{j.preventDefault()},Zs=j=>{if(B===null)return;const A=[...f],[pe]=A.splice(B,1);A.splice(j,0,pe),d(A),P(null),Le({referenceImages:A})};t.useEffect(()=>{const j=I.current;j&&K&&requestAnimationFrame(()=>{j.style.height="auto";const A=Math.max(60,Math.min(j.scrollHeight,600));j.style.height=`${A}px`})},[x,K]),t.useEffect(()=>{if(x===s.config.prompt)return;const j=setTimeout(()=>{Le({prompt:x})},500);return()=>clearTimeout(j)},[x]);const hs=j=>{var pe,Ae,Ne;M(j);const A=ws.find(xe=>xe.id===j);if(A){const xe=(pe=A.config.supportedRatios)!=null&&pe.length?A.config.supportedRatios:["16:9"],Qe=A.config.supportedResolutions||[],Ze=(Ae=A.config.supportedGenerationTypes)!=null&&Ae.length?A.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],xt=(Ne=A.config.supportedDurations)!=null&&Ne.length?A.config.supportedDurations:[5],it=xe[0],Ge=Qe.length>0?Qe[0]:r,Rt=l(n||Ze[0]),Bt=xt[0],$t=A.config.supportsAudioOutput?w:!1;O(it),y(Ge),o(Rt),c(Bt),A.config.supportsAudioOutput||S(!1),Le({modelId:j,modelName:A.name,ratio:it,resolution:Ge,generationType:Rt,duration:Bt,audio:$t,acceptedInputs:Nt(Rt)})}};t.useEffect(()=>{var A;const j=(A=s==null?void 0:s.config)==null?void 0:A.generatedVideoUrl;j&&Ss(j,s.config.ratio||"16:9")},[(Pe=s==null?void 0:s.config)==null?void 0:Pe.generatedVideoUrl]);const Js=async j=>{let pe=0;const Ae=async()=>{try{pe++;const xe=(await Me.tasks.getTaskStatus(j)).task;if(U(xe.progress||0),xe.status==="SUCCESS"||xe.status==="COMPLETED"||xe.status==="DONE"){g(!1),U(100);const Qe=xe.resultUrl;Ss(Qe,s.config.ratio||"16:9"),Le({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:Qe}),ee(""),h.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>U(0),1e3);return}else if(xe.status==="FAILURE"){g(!1),U(0),Le({taskId:""});const{useAuthStore:Qe}=await gs(async()=>{const{useAuthStore:xt}=await import("./index-DOiS8MNr.js").then(it=>it.f);return{useAuthStore:xt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ze}=Qe.getState();await Ze(),h.error(xe.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(xe.status==="PROCESSING"||xe.status==="PENDING")&&(pe<600?setTimeout(Ae,1e3):(g(!1),U(0),Le({taskId:""}),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{g(!1),U(0),Le({taskId:""}),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Ae()},qs=async()=>{var pe,Ae,Ne,xe,Qe,Ze,xt;if(l(n)==="æ–‡ç”Ÿè§†é¢‘"&&!x.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯");return}g(!0);const A=Et();Le({referenceImages:A}),U(0);try{let it=[],Ge;const Rt=f.length;if(f.length>0)try{for(const xs of f){let zt=xs.url;!zt.startsWith("data:")&&!zt.startsWith("http")&&(zt=`${cr}${zt}`),zt=zt.replace(/^https?:\/\/localhost(?::\d+)?/i,cr);const Xt=await Nr(zt);it.push(Xt)}}catch{h.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Bt=oe.filter(xs=>xs.target===u);let $t=[];if(l(n)==="å‚è€ƒå›¾"){const xs=/@(\S+)/g,Xt=[...x.matchAll(xs)].map(is=>is[1]);for(const is of Xt){const qt=_e[is];qt&&$t.push(qt)}const as=new Map;for(const is of Bt){const qt=Y(is.source);if((qt==null?void 0:qt.type)==="assetSelector"){const Os=(pe=qt.data.config)==null?void 0:pe.roleIds;if(Os&&Os.length>0)for(const ks of Os)$t.includes(ks)||$t.push(ks);const js=(Ae=qt.data.config)==null?void 0:Ae.subjects;if(js&&js.length>0){for(const ks of js)if(!as.has(ks.name)){const ir=(ks.images||[]).map(Gs=>Gs.startsWith("http")||Gs.startsWith("data:")?Gs:`${cr}${Gs}`);as.set(ks.name,ir)}}}}if(as.size>0){const is=Array.from(as.entries());let qt=0;const Os=[];for(const[js,ks]of is){if(qt>=7)break;const ir=7-qt,Gs=ks.slice(0,Math.max(0,ir));Gs.length>0&&(Os.push({name:js,images:Gs}),qt+=Gs.length)}Ge=Os,is.some(([,js])=>js.length>0)&&qt<is.reduce((js,[,ks])=>js+ks.length,0)&&h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(it.length>0){const is=nt.filter(qt=>!qt.id.includes("subject"));is.length>0&&(Ge||(Ge=[]),is.forEach((qt,Os)=>{const js=`å›¾${Os+1}`,ks=qt.url.startsWith("http")||qt.url.startsWith("data:")?qt.url:`${cr}${qt.url}`;Ge.push({name:js,images:[ks]})}))}}const Gt=Ge&&Ge.length>0?Ge.reduce((xs,zt)=>{var Xt;return xs+(((Xt=zt.images)==null?void 0:Xt.length)||0)},0):Rt,wt=$t.length>0;let It=n;if(It==="é¦–å¸§"||It==="å°¾å¸§"){if(Gt!==1&&!wt){h.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),g(!1),U(0);return}}else if(It==="é¦–å°¾å¸§"){if(Gt===1)It="é¦–å¸§";else if(Gt!==2&&!wt){h.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),g(!1),U(0);return}Ge&&Ge.length>0?Ge=[{...Ge[0],images:Ge[0].images.slice(0,2)}]:it=it.slice(0,2)}else if(It==="å‚è€ƒå›¾"||It==="ä¸»ä½“å‚è€ƒ"){if(Gt<1&&!wt){h.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),g(!1),U(0);return}if(Ge&&Ge.length>0){if(Ge.reduce((zt,Xt)=>{var as;return zt+(((as=Xt.images)==null?void 0:as.length)||0)},0)>7){let zt=7;Ge=Ge.map(Xt=>({...Xt,images:Xt.images.slice(0,Math.max(0,zt-=Xt.images.length,Xt.images.length))})),zt=7,Ge=Ge.map(Xt=>{const as=Xt.images.slice(0,Math.min(Xt.images.length,zt));return zt-=as.length,{...Xt,images:as}}).filter(Xt=>Xt.images.length>0),h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else it.length>7&&(it=it.slice(0,7),h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}ie==="dropImages"&&(it=[],Ge=void 0),(l(n)==="é¦–å¸§"||l(n)==="å°¾å¸§")&&ie==="useFirstImage"&&it.length>=2&&(it=[it[0]]),l(n)==="é¦–å°¾å¸§"&&ie==="useFirstTwoImages"&&it.length>=3&&(it=it.slice(0,2));const Mt={modelId:te,ratio:C,referenceImages:Ge&&Ge.length>0?void 0:it.length>0?it:void 0,roleIds:$t.length>0?$t:void 0,generationType:It,sourceNodeId:u,metadata:{duration:a,resolution:r,audio:w,movementAmplitude:L,roleIds:$t.length>0?$t:void 0},...Ge?{subjects:Ge}:{}};Ge&&Ge.length>0;const Lt=l(It);if(Lt==="æ–‡ç”Ÿè§†é¢‘"){if(!x.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯"),g(!1),U(0);return}Mt.prompt=x.trim()}else if(Lt==="å‚è€ƒå›¾"){if(!x.trim()){h.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),g(!1),U(0);return}Mt.prompt=x.trim()}else x.trim()&&(Mt.prompt=x.trim());const es=await Me.tasks.createVideoTask(Mt),ns=es.taskId,Cs=es.creditsCharged||0,er=es.isFreeUsage,Us=es.freeUsageRemaining??0;if(ee(ns),Le({prompt:x,ratio:C,resolution:r,generationType:n,duration:a,modelId:te,taskId:ns}),er)h.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Us} æ¬¡`),fe();else if(Cs>0){const{useAuthStore:xs}=await gs(async()=>{const{useAuthStore:Xt}=await import("./index-DOiS8MNr.js").then(as=>as.f);return{useAuthStore:Xt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:zt}=xs.getState();await zt(),h.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${Cs} ç§¯åˆ†ï¼‰`),fe()}else h.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Js(ns)}catch(it){if(g(!1),U(0),((Ne=it.response)==null?void 0:Ne.status)===403){const Ge=((Qe=(xe=it.response)==null?void 0:xe.data)==null?void 0:Qe.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";h.error(Ge)}else h.error(`æäº¤å¤±è´¥: ${((xt=(Ze=it.response)==null?void 0:Ze.data)==null?void 0:xt.error)||it.message}`)}},rr=async()=>{const j=l(n),A=Et(),pe=A.length,Ae=(()=>{var Qe;const xe=oe.filter(Ze=>Ze.target===u);for(const Ze of xe){const xt=Y(Ze.source);if((xt==null?void 0:xt.type)==="assetSelector"){const it=(Qe=xt.data.config)==null?void 0:Qe.subjects;if(it&&it.length>0)return!0}}return!1})(),Ne=Object.keys(_e).length>0;if((Ae||Ne)&&(j==="é¦–å¸§"||j==="å°¾å¸§"||j==="é¦–å°¾å¸§")){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((j==="é¦–å¸§"||j==="å°¾å¸§")&&pe===0&&!Ne){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(j==="é¦–å°¾å¸§"&&pe===0&&!Ne){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(j==="å‚è€ƒå›¾"&&pe===0&&!Ne){h.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(j==="æ–‡ç”Ÿè§†é¢‘"&&pe>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((j==="é¦–å¸§"||j==="å°¾å¸§")&&pe>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(j==="é¦–å°¾å¸§"&&pe>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(j==="æ–‡ç”Ÿè§†é¢‘"&&!x.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!te){h.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}d(A),Le({referenceImages:A}),g(!0),U(0),await qs()},Ss=(j,A)=>{const pe=Y(u);if(!pe||!j)return;const Ae=A||C||"16:9",Ne=De(),xe=we(),Qe=Ne.filter(zt=>zt.type==="videoPreview"&&xe.some(Xt=>Xt.source===u&&Xt.target===zt.id));if(Qe.find(zt=>zt.data.videoUrl===j))return;const xt=1,it=400,Ge=(zt,Xt=300)=>{if(!zt||!/^[0-9]+\s*:\s*[0-9]+$/.test(zt))return Xt;const[as,is]=zt.split(":").map(qt=>parseFloat(qt));return!as||!is?Xt:Math.round(it*(is/as))},Rt=document.querySelector(`.react-flow__node[data-id="${u}"]`),Bt=Rt==null?void 0:Rt.getBoundingClientRect(),$t=Math.round(((Bt==null?void 0:Bt.width)||400)/xt),Gt=100,wt=200,It=Ge(Ae,300),Mt=Qe.length,Lt=pe.position.x+$t+wt,es=pe.position.y,ns=Lt,Cs=es+Mt*(It+Gt),er=Date.now(),Us={id:`preview-${u}-${er}`,type:"videoPreview",position:{x:ns,y:Cs},data:{videoUrl:j,width:it,ratio:Ae,workflowContext:pe.data.workflowContext,createdBy:pe.data.createdBy}};le(zt=>[...zt,Us]);const xs={id:`edge-${u}-${Us.id}`,source:u,target:Us.id,targetHandle:`${Us.id}-target`,type:"aurora"};Ce(zt=>zt.find(as=>as.source===u&&as.target===Us.id)?zt:[...zt,xs])},Ns=j=>{const A=j.target;if(A.tagName==="INPUT"||A.tagName==="TEXTAREA"||A.tagName==="SELECT"||A.tagName==="BUTTON"||A.closest("button")||A.closest("input")||A.closest("textarea")||A.closest("select"))return;const pe=!K;Ie(pe),le(Ae=>Ae.map(Ne=>Ne.id===u?{...Ne,data:{...Ne.data,isExpanded:pe}}:Ne))};return e.jsxs("div",{onDoubleClick:Ns,className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var it;const j=((it=Y(u))==null?void 0:it.type)||"",A=l(n),pe=A==="æ–‡ç”Ÿè§†é¢‘"||j==="aiVideo_t2v",Ae=j==="aiVideo_i2v_first"||j==="aiVideo_i2v_last"||A==="é¦–å¸§"||A==="å°¾å¸§",Ne=j==="aiVideo_first_last"||A==="é¦–å°¾å¸§",xe=j==="aiVideo_reference"||A==="å‚è€ƒå›¾",Qe=oe.filter(Ge=>Ge.target===u),Ze=Qe.some(Ge=>{const Rt=Y(Ge.source);return(Rt==null?void 0:Rt.type)==="agent"}),xt=Qe.reduce((Ge,Rt)=>{var Gt,wt,It,Mt;const Bt=Y(Rt.source),$t=(Bt==null?void 0:Bt.type)||"";if($t==="aiImage"||$t==="imagePreview")return Ge+1;if($t==="upload"){const Lt=(It=(wt=(Gt=Bt==null?void 0:Bt.data)==null?void 0:Gt.config)==null?void 0:wt.uploadedFiles)==null?void 0:It[0],es=((Lt==null?void 0:Lt.type)||"").toUpperCase(),ns=((Lt==null?void 0:Lt.mimeType)||"").toLowerCase();return Ge+(es==="IMAGE"||ns.startsWith("image/")?1:0)}if($t==="assetSelector"){const Lt=((Mt=Bt==null?void 0:Bt.data)==null?void 0:Mt.config)||{};if(Lt.selectedAsset)return Ge+((Lt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Lt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Lt.subjects&&Lt.subjects.length>0)return Ge+((Lt.subjects[0].images||[]).length||0)}return Ge},0);return pe?!Ze:Ae?!(Ze&&xt>=1):Ne?!(Ze&&xt>=2):xe?!(Ze&&xt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),F&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ue}),de==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{X(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{X(!1),h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{X(!1),await qs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:K?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(rs,{value:te,onChange:j=>hs(j),options:ws.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:ws.map(j=>({value:j.id,label:j.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Be?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:I,value:x,onChange:j=>{var Ne;const A=(Ne=re==null?void 0:re.modelId)==null?void 0:Ne.includes("viduq2"),pe=l(n)==="å‚è€ƒå›¾";A&&pe?_t(j):(m(j.target.value),p(!1))},onKeyDown:j=>{var Ae;const A=(Ae=re==null?void 0:re.modelId)==null?void 0:Ae.includes("viduq2"),pe=l(n)==="å‚è€ƒå›¾";A&&pe&&bs(j)},placeholder:(Ue=re==null?void 0:re.modelId)!=null&&Ue.includes("viduq2")&&l(n)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),k&&N.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:N.map((j,A)=>e.jsxs("button",{type:"button",onClick:()=>Kt(j),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${A===Se?"bg-purple-100 dark:bg-purple-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[j.thumbnail?e.jsx("img",{src:j.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-200 dark:bg-purple-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-purple-600 dark:text-purple-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",j.name]})})]},j.id))})]})]}),Object.keys(_e).length>0&&((Xe=re==null?void 0:re.modelId)==null?void 0:Xe.includes("viduq2"))&&l(n)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys(_e).map(j=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-purple-500/10 dark:bg-purple-500/20 border border-purple-400/50 dark:border-purple-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-purple-500 dark:text-purple-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-purple-700 dark:text-purple-300",children:j}),e.jsx("button",{type:"button",onClick:()=>{je(Ae=>{const Ne={...Ae};return delete Ne[j],Ne});const A=new RegExp(`@${j}\\s*`,"g"),pe=x.replace(A,"");m(pe)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-purple-500 dark:text-purple-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},j))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Be&&f.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(We=f[0])!=null&&We.name&&f[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",n==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",l(n)==="å‚è€ƒå›¾"&&f.some(j=>!j.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:f.map((j,A)=>{const pe=f.slice(0,A+1).filter(xe=>!xe.id.includes("subject")).length,Ae=!j.id.includes("subject"),Ne=Ae?`å›¾${pe}`:j.name;return e.jsxs("div",{draggable:n==="é¦–å°¾å¸§",onDragStart:()=>Ps(A),onDragOver:ys,onDrop:()=>Zs(A),onClick:()=>{Ae&&l(n)==="å‚è€ƒå›¾"&&yt(Ne)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${n==="é¦–å°¾å¸§"?"cursor-move":Ae&&l(n)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${B===A?"opacity-50":""} ${j.id.includes("subject")?"border-purple-400 dark:border-purple-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-purple-400 dark:hover:border-purple-400/50 ${Ae&&l(n)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Ae&&l(n)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${Ne}`:j.name,children:[e.jsx("img",{src:`${j.url.startsWith("http")||j.url.startsWith("data:")?j.url:cr+j.url}`,alt:j.name,className:"w-full h-full object-cover"}),j.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),j.name]}),Ae&&n!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),Ne]}),n==="é¦–å°¾å¸§"&&!j.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:A===0?"é¦–":A===1?"å°¾":A+1})]},j.id)})})]}),re&&!Be&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",at?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:qe.map(j=>e.jsxs("button",{type:"button",onClick:()=>{c(j),Le({duration:j})},disabled:at,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${a===j?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"} disabled:opacity-50 disabled:cursor-not-allowed`,children:[j,"ç§’"]},j))})]}),cs&&(((Ye=re==null?void 0:re.config.supportedRatios)==null?void 0:Ye.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Be?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{O("16:9"),Le({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${C==="16:9"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{O("9:16"),Le({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${C==="9:16"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(rs,{value:C,onChange:j=>{O(j),Le({ratio:j})},options:((re==null?void 0:re.config.supportedRatios)||[]).map(j=>{const[A,pe]=j.split(":");return{value:j,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[j]||`${A}:${pe}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",ot?"(æœªé…ç½®)":""]}),e.jsx(rs,{value:r,onChange:j=>{y(j),Le({resolution:j})},options:Ft.map(j=>({value:j,label:j})),className:ot?"opacity-50 pointer-events-none":""})]}),((ct=re==null?void 0:re.provider)==null?void 0:ct.toLowerCase())==="vidu"&&(re==null?void 0:re.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(j=>e.jsx("button",{type:"button",onClick:()=>{q(j),Le({movementAmplitude:j})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${L===j?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:j==="auto"?"è‡ªåŠ¨":j==="small"?"å°":j==="medium"?"ä¸­":"å¤§"},j))})]}),(re==null?void 0:re.config.supportsAudioOutput)&&l(n)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const j=!w;S(j),Le({audio:j})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${w?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${w?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:rr,disabled:Q||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Q?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!me&&(ae?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",se,"æ¬¡"]}):Oe!==null&&Oe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[Oe,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:x?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-purple-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-purple-300 line-clamp-6 whitespace-pre-wrap break-words",children:x})]}):e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},nr=t.memo(Oa),Ga=s=>{const{data:E}=s;return e.jsx(nr,{...s,data:{...E,config:{...E==null?void 0:E.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Va=t.memo(Ga),Wa=s=>{const{data:E}=s;return e.jsx(nr,{...s,data:{...E,config:{...E==null?void 0:E.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},Fa=t.memo(Wa),za=s=>{const{data:E}=s;return e.jsx(nr,{...s,data:{...E,config:{...E==null?void 0:E.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},Ba=t.memo(za),Ha=s=>{const{data:E}=s;return e.jsx(nr,{...s,data:{...E,config:{...E==null?void 0:E.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},Xa=t.memo(Ha),Ja=s=>{const E=(s==null?void 0:s.data)||{},u=E.config||{};return e.jsx(nr,{...s,data:{...E,config:{...u,generationType:(u==null?void 0:u.lockedGenerationType)||(u==null?void 0:u.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(u==null?void 0:u.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(u==null?void 0:u.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(u==null?void 0:u.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},qa=t.memo(Ja),or="https://api.waule.com",Ya=({data:s,selected:E,id:u})=>{var M,C,O,r,y,l;const[K]=t.useState(!0),[Ie,U]=t.useState(!1),[ve]=t.useState(""),[ee,ce]=t.useState("wan-std"),[Z,he]=t.useState(0),Oe=t.useRef(null),{setNodes:me,setEdges:ae,getNode:se,getNodes:fe,getEdges:le}=ts(),Ce=Fs(),Y=s.config.modelId,{credits:De,loading:we}=Ls({aiModelId:Y,duration:Z,mode:ee==="wan-pro"?"pro":"standard"}),oe=t.useMemo(()=>{var a;const n=s.models||[],o=(a=s==null?void 0:s.config)==null?void 0:a.selectedEditingCapability;return n.filter(c=>{var w;return(c.type||"")==="VIDEO_EDITING"&&Array.isArray((w=c.config)==null?void 0:w.supportedEditingCapabilities)&&(o?c.config.supportedEditingCapabilities.includes(o):c.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||c.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(M=s==null?void 0:s.config)==null?void 0:M.selectedEditingCapability]),[T,$]=t.useState(s.config.modelId||((C=oe[0])==null?void 0:C.id)||""),D=t.useMemo(()=>oe.find(n=>n.id===T),[oe,T]);t.useEffect(()=>{var n;if(!oe.find(o=>o.id===T)){const o=((n=oe[0])==null?void 0:n.id)||"";$(o),me(a=>a.map(c=>{var w;return c.id===u?{...c,data:{...c.data,config:{...c.data.config,modelId:o||void 0,modelName:o?(w=oe[0])==null?void 0:w.name:void 0}}}:c}))}},[oe]),t.useEffect(()=>{},[D]);const _=t.useMemo(()=>{var L,q,Q,g,f,d,B,P,F,X,ue,de,ie,k,p,N;const n=Ce.filter(b=>b.target===u);let o=null,a=0,c=null,w=null,S=null;for(const b of n){const V=se(b.source);if(!V)continue;const ne=String(V.type||"");if(ne==="upload"){const H=(Q=(q=(L=V.data)==null?void 0:L.config)==null?void 0:q.uploadedFiles)==null?void 0:Q[0];if(!H)continue;const ge=String(H.mimeType||"").toLowerCase(),Se=String(H.type||"").toUpperCase(),ye=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${or}${H.url}`;!c&&(Se==="VIDEO"||ge.startsWith("video/"))&&(c=ye,S=b.id),!o&&(Se==="IMAGE"||ge.startsWith("image/"))&&(o=ye,a=H.size||0,w=b.id)}else if(ne==="assetSelector"){const H=(f=(g=V.data)==null?void 0:g.config)==null?void 0:f.selectedAsset;if(H){const Se=String(H.mimeType||"").toLowerCase(),ye=String(H.type||"").toUpperCase(),_e=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${or}${H.url}`;!c&&(ye==="VIDEO"||Se.startsWith("video/"))&&(c=_e,S=b.id),!o&&(ye==="IMAGE"||Se.startsWith("image/"))&&(o=_e,a=H.size||0,w=b.id)}const ge=((B=(d=V.data)==null?void 0:d.config)==null?void 0:B.subjects)||[];if(!o&&Array.isArray(ge)&&ge.length>0){const ye=(((P=ge[0])==null?void 0:P.images)||[])[0];ye&&(o=ye.startsWith("http")||ye.startsWith("data:")?ye:`${or}${ye}`,w=b.id)}}else if(ne==="aiImage"){const H=(X=(F=V.data)==null?void 0:F.config)==null?void 0:X.generatedImageUrl;!o&&H&&(o=H.startsWith("http")||H.startsWith("data:")?H:`${or}${H}`,w=b.id)}else if(ne==="imagePreview"){const H=((ue=V.data)==null?void 0:ue.imageUrl)||((de=V.data)==null?void 0:de.url);!o&&H&&(o=H.startsWith("http")||H.startsWith("data:")?H:`${or}${H}`,w=b.id)}else if(ne==="videoPreview"||ne.startsWith("aiVideo")){const H=((ie=V.data)==null?void 0:ie.videoUrl)||((k=V.data)==null?void 0:k.url)||((N=(p=V.data)==null?void 0:p.config)==null?void 0:N.generatedVideoUrl);!c&&H&&(c=H.startsWith("http")||H.startsWith("data:")?H:`${or}${H}`,S=b.id)}if(o&&c)break}return{imageUrl:o,videoUrl:c,imageSize:a,imageEdgeId:w,videoEdgeId:S}},[Ce,u,se]);t.useEffect(()=>{if(_.imageSize>5*1024*1024){const o=(_.imageSize/1024/1024).toFixed(2);h.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${o}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),_.imageEdgeId&&ae(a=>a.filter(c=>c.id!==_.imageEdgeId))}if(!_.videoUrl){he(0);return}const n=document.createElement("video");n.src=_.videoUrl,n.onloadedmetadata=()=>{const o=n.duration||0,a=n.videoWidth,c=n.videoHeight;he(o);let w="";o<2||o>30?w=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${o.toFixed(1)}ç§’ï¼‰`:(a>2048||c>2048)&&(w=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${a}x${c}ï¼‰`),w&&(h.error(w+"ï¼Œè¿æ¥å·²æ–­å¼€"),_.videoEdgeId&&ae(S=>S.filter(L=>L.id!==_.videoEdgeId)))},n.onerror=()=>he(0),n.load()},[_.videoUrl,_.imageSize,_.videoEdgeId,_.imageEdgeId,ae]);const x=t.useMemo(()=>!!T&&!!_.videoUrl&&!!_.imageUrl,[T,_.videoUrl,_.imageUrl]),m=t.useCallback(n=>{var k,p,N;const o=se(u);if(!o||!n)return;const a=fe(),c=le(),w=a.filter(b=>b.type==="videoPreview"&&c.some(V=>V.source===u&&V.target===b.id));if(w.find(b=>{var V;return((V=b.data)==null?void 0:V.videoUrl)===n}))return;const L=400,q=(b,V=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(b))return V;const[ne,H]=b.split(":").map(ge=>parseFloat(ge));return!ne||!H?V:Math.round(L*(H/ne))},Q=200,g=100,f=q("16:9",300),d=document.querySelector(`.react-flow__node[data-id="${u}"]`),B=Math.round((d==null?void 0:d.getBoundingClientRect().width)||400),P=(((k=o.position)==null?void 0:k.x)||0)+B+Q,F=((p=o.position)==null?void 0:p.y)||0,X=w.length,ue=P,de=F+X*(f+g),ie={id:`preview-${u}-${Date.now()}`,type:"videoPreview",position:{x:ue,y:de},data:{videoUrl:n,width:L,ratio:"16:9",workflowContext:o.data.workflowContext,createdBy:(N=o.data)==null?void 0:N.createdBy}};me(b=>[...b,ie]),ae(b=>[...b,{id:`edge-${u}-${ie.id}`,source:u,target:ie.id,type:"aurora"}])},[u,se,fe,le,me,ae]);t.useEffect(()=>{var o;const n=(o=s==null?void 0:s.config)==null?void 0:o.generatedVideoUrl;n&&m(n)},[(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl]),t.useEffect(()=>{const n=s.config.taskId;(async()=>{var c,w;let a=!1;if(n)try{const L=(await Me.tasks.getTaskStatus(n)).task;if(L.status==="SUCCESS"){const q=L.resultUrl||((c=L.previewNodeData)==null?void 0:c.url);if(q){let Q=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";Q=JSON.parse(g).some(d=>d.taskId&&d.taskId===n||d.sourceNodeId&&d.sourceNodeId===u)}catch{}Q||m(q),me(g=>g.map(f=>f.id===u?{...f,data:{...f.data,config:{...f.data.config,generatedVideoUrl:q,taskId:n}}}:f))}U(!1),a=!0}else if(L.status==="PROCESSING"||L.status==="PENDING"){U(!0),await I(n);return}else L.status==="FAILURE"&&(U(!1),me(q=>q.map(Q=>Q.id===u?{...Q,data:{...Q.data,config:{...Q.data.config,taskId:""}}}:Q)))}catch{U(!1)}if(!a)try{const S=await Me.tasks.getPendingPreviewNodes(u);if(Array.isArray(S.tasks)&&S.tasks.length>0)for(const L of S.tasks){const q=(w=L.previewNodeData)==null?void 0:w.url;if(q){let Q=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";Q=JSON.parse(g).some(d=>d.taskId&&d.taskId===L.id||d.sourceNodeId&&d.sourceNodeId===u)}catch{}Q||m(q),await Me.tasks.markPreviewNodeCreated(L.id)}}}catch{}})()},[]);const I=async n=>{let o=0;const a=600,c=async()=>{var w;try{o++;const L=(await Me.tasks.getTaskStatus(n)).task;if(L.status==="SUCCESS"){const q=L.resultUrl||((w=L.previewNodeData)==null?void 0:w.url);if(q){let Q=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";Q=JSON.parse(g).some(d=>d.taskId&&d.taskId===n||d.sourceNodeId&&d.sourceNodeId===u)}catch{}Q||m(q),me(g=>g.map(f=>f.id!==u?f:{...f,data:{...f.data,config:{...f.data.config,generatedVideoUrl:q,taskId:n}}}))}U(!1),h.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(L.status==="PROCESSING"||L.status==="PENDING")if(o<a)setTimeout(c,5e3);else{U(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),me(q=>q.map(Q=>Q.id===u?{...Q,data:{...Q.data,config:{...Q.data.config,taskId:""}}}:Q));return}else if(L.status==="FAILURE"){U(!1);try{const{useAuthStore:q}=await gs(async()=>{const{useAuthStore:g}=await import("./index-DOiS8MNr.js").then(f=>f.f);return{useAuthStore:g}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Q}=q.getState();await Q()}catch{}h.error(L.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),me(q=>q.map(Q=>Q.id===u?{...Q,data:{...Q.data,config:{...Q.data.config,taskId:""}}}:Q));return}else{U(!1),h.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),me(q=>q.map(Q=>Q.id===u?{...Q,data:{...Q.data,config:{...Q.data.config,taskId:""}}}:Q));return}}catch{U(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),me(L=>L.map(q=>q.id===u?{...q,data:{...q.data,config:{...q.data.config,taskId:""}}}:q));return}};c()},te=async()=>{var n,o;if(!x){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}U(!0);try{const a=await Me.post("/tasks/video-edit",{modelId:T,prompt:ve||"",referenceImages:_.imageUrl?[_.imageUrl]:[],sourceNodeId:u,duration:Z,metadata:{videoUrl:_.videoUrl,wanMode:ee,duration:Z}}),c=a.taskId,w=a.creditsCharged||0;if(w>0)try{const{useAuthStore:S}=await gs(async()=>{const{useAuthStore:q}=await import("./index-DOiS8MNr.js").then(Q=>Q.f);return{useAuthStore:q}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:L}=S.getState();await L(),h.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${w} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");me(S=>S.map(L=>L.id===u?{...L,data:{...L.data,config:{...L.data.config,taskId:c}}}:L)),await I(c)}catch(a){U(!1);const c=((o=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:o.error)||a.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${c}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:K?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(rs,{value:T,onChange:n=>{$(n),me(o=>o.map(a=>{var c;return a.id===u?{...a,data:{...a.data,config:{...a.data.config,modelId:n,modelName:(c=oe.find(w=>w.id===n))==null?void 0:c.name}}}:a}))},options:oe.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:oe.map(n=>({value:n.id,label:n.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>ce("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${ee==="wan-std"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>ce("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${ee==="wan-pro"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((y=s==null?void 0:s.config)==null?void 0:y.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),_.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Oe,src:_.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:n=>{const o=n.currentTarget;o.duration&&o.duration!==1/0&&he(o.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((l=s==null?void 0:s.config)==null?void 0:l.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),_.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:_.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:te,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!we&&(De!==null&&De>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[De,"ç§¯åˆ†"]}):Z===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ka=t.memo(Ya),fr="https://api.waule.com",Qa=({data:s,selected:E,id:u})=>{var q,Q;const[K]=t.useState(!0),[Ie,U]=t.useState(!1),[ve,ee]=t.useState(!1),ce=t.useRef(null),Z=t.useRef(null),he=t.useRef(null),[Oe,me]=t.useState(!1),[ae,se]=t.useState(0),[fe,le]=t.useState(0),[Ce,Y]=t.useState(0),[De,we]=t.useState(null),{setNodes:oe,setEdges:T,getNode:$,getNodes:D,getEdges:_}=ts(),x=Fs(),m=Ds(),I=t.useMemo(()=>`lipSyncTask:${u}`,[u]),te=t.useMemo(()=>(s.models||[]).filter(f=>{var d;return(f.type||"")==="VIDEO_EDITING"&&Array.isArray((d=f.config)==null?void 0:d.supportedEditingCapabilities)&&f.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[M,C]=t.useState(s.config.modelId||((q=te[0])==null?void 0:q.id)||"");t.useEffect(()=>{var g;if(!te.find(f=>f.id===M)){const f=((g=te[0])==null?void 0:g.id)||"";C(f),oe(d=>d.map(B=>{var P;return B.id===u?{...B,data:{...B.data,config:{...B.data.config,modelId:f||void 0,modelName:f?(P=te[0])==null?void 0:P.name:void 0}}}:B}))}},[te]);const O=t.useMemo(()=>!fe||!ae?0:fe>=ae||ve?ae:fe,[fe,ae,ve]),{credits:r,loading:y}=Ls({aiModelId:M,duration:O,mode:"standard",operationType:"video_retalk"}),l=t.useMemo(()=>{var P,F,X,ue,de,ie,k,p,N;const g=x.filter(b=>b.target===u);let f=null,d=null,B=null;for(const b of g){const V=m.find(H=>H.id===b.source);if(!V)continue;const ne=String(V.type||"");if(ne==="upload"){const H=(X=(F=(P=V.data)==null?void 0:P.config)==null?void 0:F.uploadedFiles)==null?void 0:X[0];if(!H)continue;const ge=String(H.mimeType||"").toLowerCase(),Se=String(H.type||"").toUpperCase(),ye=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${fr}${H.url}`;!f&&(Se==="VIDEO"||ge.startsWith("video/"))&&(f=ye),!d&&(Se==="AUDIO"||ge.startsWith("audio/"))&&(d=ye),!B&&(Se==="IMAGE"||ge.startsWith("image/"))&&(B=ye)}else if(ne==="assetSelector"){const H=(de=(ue=V.data)==null?void 0:ue.config)==null?void 0:de.selectedAsset;if(H){const ge=String(H.mimeType||"").toLowerCase(),Se=String(H.type||"").toUpperCase(),ye=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${fr}${H.url}`;!f&&(Se==="VIDEO"||ge.startsWith("video/"))&&(f=ye),!d&&(Se==="AUDIO"||ge.startsWith("audio/"))&&(d=ye),!B&&(Se==="IMAGE"||ge.startsWith("image/"))&&(B=ye)}}else if(ne==="videoPreview"||ne.startsWith("aiVideo")){const H=((ie=V.data)==null?void 0:ie.videoUrl)||((k=V.data)==null?void 0:k.url)||((N=(p=V.data)==null?void 0:p.config)==null?void 0:N.generatedVideoUrl);!f&&H&&(f=H.startsWith("http")||H.startsWith("data:")?H:`${fr}${H}`)}if(f&&d&&B)break}return{videoUrl:f,audioUrl:d,imageUrl:B}},[x,u,m]),n=t.useMemo(()=>{var f;const g=te.find(d=>d.id===M);return((f=g==null?void 0:g.modelId)==null?void 0:f.toLowerCase().includes("videoretalk"))||!1},[M,te]),o=t.useMemo(()=>!!M&&!!l.videoUrl&&!!l.audioUrl&&!De,[M,l.videoUrl,l.audioUrl,De]);t.useEffect(()=>{const g=ce.current;if(!g||!l.audioUrl)return;g.src=l.audioUrl,g.load();const f=()=>{se(g.duration||0)},d=()=>Y(g.duration?g.currentTime/g.duration:0),B=()=>me(!1);return g.addEventListener("loadedmetadata",f),g.addEventListener("timeupdate",d),g.addEventListener("ended",B),()=>{g.removeEventListener("loadedmetadata",f),g.removeEventListener("timeupdate",d),g.removeEventListener("ended",B)}},[l.audioUrl]),t.useEffect(()=>{if(!l.videoUrl){le(0);return}const g=document.createElement("video");g.src=l.videoUrl,g.onloadedmetadata=()=>{if(le(g.duration||0),n){const f=g.videoWidth,d=g.videoHeight;f>2048||d>2048?(we(`è§†é¢‘åˆ†è¾¨ç‡ ${f}x${d} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),h.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${f}x${d}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),T(B=>B.filter(P=>{var ue,de,ie,k,p,N,b,V;if(P.target!==u)return!0;const F=m.find(ne=>ne.id===P.source);return F?!(F.type==="upload"&&((k=(ie=(de=(ue=F.data)==null?void 0:ue.config)==null?void 0:de.uploadedFiles)==null?void 0:ie[0])==null?void 0:k.type)==="VIDEO"||F.type==="assetSelector"&&((b=(N=(p=F.data)==null?void 0:p.config)==null?void 0:N.selectedAsset)==null?void 0:b.type)==="VIDEO"||F.type==="videoPreview"||((V=F.type)==null?void 0:V.startsWith("aiVideo"))):!0}))):De!=null&&De.includes("è§†é¢‘åˆ†è¾¨ç‡")&&we(null)}},g.onerror=()=>le(0),g.load()},[l.videoUrl,n,u,m,T]),t.useEffect(()=>{const g=l.audioUrl,f=he.current;if(!g||!f)return;const d=P=>{const F=f.getContext("2d");if(!F)return;const X=f.width,ue=f.height;F.clearRect(0,0,X,ue);const de="#1a1033",ie="#7a0fe8";F.fillStyle=de,F.fillRect(0,0,X,ue);const k=P.length,p=2,N=Math.max(1,Math.floor((X-(k-1)*p)/k));for(let b=0;b<k;b++){const V=Math.min(1,Math.max(0,P[b])),ne=Math.max(2,Math.floor(V*ue)),H=b*(N+p),ge=Math.floor((ue-ne)/2);F.fillStyle=ie,F.fillRect(H,ge,N,ne)}if(Ce>0){const b=Math.floor(X*Ce);F.fillStyle="#ffffff88",F.fillRect(b,0,2,ue)}};(async()=>{try{let P=g;g.includes("aliyuncs.com")&&(P=`https://api.waule.com/proxy/audio?url=${encodeURIComponent(g)}`);const X=await(await fetch(P,{mode:(g.includes("aliyuncs.com"),"cors"),credentials:g.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ue=window.AudioContext||window.webkitAudioContext,k=(await new ue().decodeAudioData(X)).getChannelData(0),p=120,N=Math.max(1,Math.floor(k.length/p)),b=new Float32Array(p);for(let V=0;V<p;V++){let ne=0,H=0;const ge=V*N,Se=Math.min(k.length,ge+N);for(let ye=ge;ye<Se;ye++)ne+=Math.abs(k[ye]),H++;b[V]=H?ne/H:0}d(b)}catch{const F=new Float32Array(120);for(let X=0;X<120;X++)F[X]=(Math.sin(X/5)+1)/2;d(F)}})()},[l.audioUrl,Ce]);const a=()=>{const g=ce.current;g&&(Oe?(g.pause(),me(!1)):(g.play(),me(!0)))},c=g=>{if(!g||!isFinite(g))return"0:00";const f=Math.floor(g/60),d=Math.floor(g%60);return`${f}:${d.toString().padStart(2,"0")}`},w=t.useCallback(g=>{var _e,je,Te;const f=$(u);if(!f||!g)return;const d=g.startsWith("http")||g.startsWith("data:")?g:`${fr}${g}`,B=D(),P=_(),F=B.filter(Re=>Re.type==="videoPreview"&&P.some(re=>re.source===u&&re.target===Re.id));if(F.find(Re=>{var re;return((re=Re.data)==null?void 0:re.videoUrl)===d}))return;const ue=400,de=(Re,re=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(Re))return re;const[Be,qe]=Re.split(":").map(Ft=>parseFloat(Ft));return!Be||!qe?re:Math.round(ue*(qe/Be))},ie=200,k=100,p=de("16:9",300),N=document.querySelector(`.react-flow__node[data-id="${u}"]`),b=Math.round((N==null?void 0:N.getBoundingClientRect().width)||400),V=(((_e=f.position)==null?void 0:_e.x)||0)+b+ie,ne=((je=f.position)==null?void 0:je.y)||0,H=F.length,ge=V,Se=ne+H*(p+k),ye={id:`preview-${u}-${Date.now()}`,type:"videoPreview",position:{x:ge,y:Se},data:{videoUrl:d,ratio:"16:9",workflowContext:f.data.workflowContext,createdBy:(Te=f.data)==null?void 0:Te.createdBy}};oe(Re=>[...Re,ye]),T(Re=>[...Re,{id:`edge-${u}-${ye.id}`,source:u,target:ye.id,type:"aurora"}])},[u,$,D,_,oe,T]);t.useEffect(()=>{var f;const g=(f=s==null?void 0:s.config)==null?void 0:f.generatedVideoUrl;g&&w(g)},[(Q=s==null?void 0:s.config)==null?void 0:Q.generatedVideoUrl]),t.useEffect(()=>{const g=s.config.taskId||(()=>{try{return localStorage.getItem(I)||""}catch{return""}})();(async()=>{var B,P;let d=!1;if(g)try{const X=(await Me.tasks.getTaskStatus(g)).task;if(X.status==="PROCESSING"||X.status==="PENDING"){const ue=new Date(X.createdAt);if((new Date().getTime()-ue.getTime())/(1e3*60*60)>1){U(!1),oe(k=>k.map(p=>p.id===u?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p));try{localStorage.removeItem(I)}catch{}return}}if(X.status==="SUCCESS"||X.status==="COMPLETED"||X.status==="DONE"){const ue=X.resultUrl||((B=X.previewNodeData)==null?void 0:B.url);if(ue){let de=!1;try{const ie=localStorage.getItem("suppressedPreviewTasks")||"[]";de=JSON.parse(ie).some(p=>p.taskId&&p.taskId===g||p.sourceNodeId&&p.sourceNodeId===u)}catch{}de||w(ue),oe(ie=>ie.map(k=>k.id===u?{...k,data:{...k.data,config:{...k.data.config,generatedVideoUrl:ue,taskId:g}}}:k))}U(!1);try{localStorage.removeItem(I)}catch{}d=!0}else if(X.status==="PROCESSING"||X.status==="PENDING"){U(!0),await S(g);return}else if(X.status==="FAILURE"||X.status==="FAILED"){U(!1),oe(ue=>ue.map(de=>de.id===u?{...de,data:{...de.data,config:{...de.data.config,taskId:""}}}:de));try{localStorage.removeItem(I)}catch{}}}catch{U(!1);try{localStorage.removeItem(I)}catch{}}if(!d)try{const F=await Me.tasks.getPendingPreviewNodes(u);if(Array.isArray(F.tasks)&&F.tasks.length>0)for(const X of F.tasks){const ue=(P=X.previewNodeData)==null?void 0:P.url;if(ue){let de=!1;try{const ie=localStorage.getItem("suppressedPreviewTasks")||"[]";de=JSON.parse(ie).some(p=>p.taskId&&p.taskId===X.id||p.sourceNodeId&&p.sourceNodeId===u)}catch{}de||w(ue),await Me.tasks.markPreviewNodeCreated(X.id)}}}catch{}})()},[I,u,w]);const S=async g=>{let f=0;const d=600;let B=-1,P=0;const F=60,X=async()=>{var ue;try{f++;const ie=(await Me.tasks.getTaskStatus(g)).task;if(ie.status==="PROCESSING"||ie.status==="PENDING"){const k=ie.progress||0;if(k===B){if(P++,P>=F){U(!1),h.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),oe(p=>p.map(N=>N.id===u?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N));try{localStorage.removeItem(I)}catch{}return}}else B=k,P=0}if(ie.status==="SUCCESS"||ie.status==="COMPLETED"||ie.status==="DONE"){const k=ie.resultUrl||((ue=ie.previewNodeData)==null?void 0:ue.url);k&&(w(k),oe(p=>p.map(N=>N.id===u?{...N,data:{...N.data,config:{...N.data.config,generatedVideoUrl:k,taskId:g}}}:N))),U(!1),h.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(I)}catch{}return}else if(ie.status==="PROCESSING"||ie.status==="PENDING")if(f<d)setTimeout(X,5e3);else{U(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),oe(k=>k.map(p=>p.id===u?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p));try{localStorage.removeItem(I)}catch{}return}else if(ie.status==="FAILURE"||ie.status==="FAILED"){U(!1);try{const{useAuthStore:k}=await gs(async()=>{const{useAuthStore:N}=await import("./index-DOiS8MNr.js").then(b=>b.f);return{useAuthStore:N}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:p}=k.getState();await p()}catch{}h.error(ie.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),oe(k=>k.map(p=>p.id===u?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p));try{localStorage.removeItem(I)}catch{}return}else{U(!1),h.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),oe(k=>k.map(p=>p.id===u?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p));try{localStorage.removeItem(I)}catch{}return}}catch{U(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),oe(ie=>ie.map(k=>k.id===u?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));try{localStorage.removeItem(I)}catch{}return}};X()},L=async()=>{var g,f;if(!o){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}U(!0);try{const d=await Me.post("/tasks/video-edit",{modelId:M,prompt:"",referenceImages:l.imageUrl?[l.imageUrl]:[],sourceNodeId:u,generationType:"å¯¹å£å‹",duration:O,metadata:{videoUrl:l.videoUrl,audioUrl:l.audioUrl,videoExtension:ve,duration:O}}),B=d.taskId,P=d.creditsCharged||0;if(P>0)try{const{useAuthStore:F}=await gs(async()=>{const{useAuthStore:ue}=await import("./index-DOiS8MNr.js").then(de=>de.f);return{useAuthStore:ue}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:X}=F.getState();await X(),h.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${P} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");oe(F=>F.map(X=>X.id===u?{...X,data:{...X.data,config:{...X.data.config,taskId:B}}}:X));try{localStorage.setItem(I,B)}catch{}await S(B)}catch(d){U(!1);const B=((f=(g=d==null?void 0:d.response)==null?void 0:g.data)==null?void 0:f.error)||d.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(I)}catch{}}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:K?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(rs,{value:M,onChange:g=>{C(g),oe(f=>f.map(d=>{var B;return d.id===u?{...d,data:{...d.data,config:{...d.data.config,modelId:g,modelName:(B=te.find(P=>P.id===g))==null?void 0:B.name}}}:d}))},options:te.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:te.map(g=>({value:g.id,label:g.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:l.videoUrl?e.jsx("video",{src:l.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},l.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:l.imageUrl?e.jsx("img",{src:l.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},l.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),l.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:a,className:"nodrag w-7 h-7 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Oe?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:c(ae)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:he,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:ce,src:l.audioUrl,className:"hidden"}),e.jsx("video",{ref:Z,className:"hidden",muted:!0,onLoadedMetadata:g=>{const f=g.currentTarget;f.duration&&f.duration!==1/0&&le(f.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:ve,onChange:g=>ee(g.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:L,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!y&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[r,"ç§¯åˆ†"]}):O===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Za=t.memo(Qa),br="https://api.waule.com",eo=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],to=({data:s,selected:E,id:u})=>{var te,M;const[K]=t.useState(!0),[Ie,U]=t.useState(!1),[ve,ee]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[ce,Z]=t.useState(s.config.videoFps||15),[he,Oe]=t.useState(0),me=t.useRef(null),{setNodes:ae,setEdges:se,getNode:fe,getNodes:le,getEdges:Ce}=ts(),Y=Fs(),De=t.useMemo(()=>(s.models||[]).filter(O=>{var r;return(O.type||"")==="VIDEO_EDITING"&&Array.isArray((r=O.config)==null?void 0:r.supportedEditingCapabilities)&&O.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[we,oe]=t.useState(s.config.modelId||((te=De[0])==null?void 0:te.id)||""),{credits:T,loading:$}=Ls({aiModelId:we,duration:he});t.useMemo(()=>De.find(C=>C.id===we),[De,we]),t.useEffect(()=>{var C;if(!De.find(O=>O.id===we)){const O=((C=De[0])==null?void 0:C.id)||"";oe(O),ae(r=>r.map(y=>{var l;return y.id===u?{...y,data:{...y.data,config:{...y.data.config,modelId:O||void 0,modelName:O?(l=De[0])==null?void 0:l.name:void 0}}}:y}))}},[De]);const D=t.useMemo(()=>{var r,y,l,n,o,a,c,w,S;const C=Y.filter(L=>L.target===u);let O=null;for(const L of C){const q=fe(L.source);if(!q)continue;const Q=String(q.type||"");if(Q==="upload"){const g=(l=(y=(r=q.data)==null?void 0:r.config)==null?void 0:y.uploadedFiles)==null?void 0:l[0];if(!g)continue;const f=String(g.mimeType||"").toLowerCase(),d=String(g.type||"").toUpperCase(),B=g.url.startsWith("http")||g.url.startsWith("data:")?g.url:`${br}${g.url}`;!O&&(d==="VIDEO"||f.startsWith("video/"))&&(O=B)}else if(Q==="assetSelector"){const g=(o=(n=q.data)==null?void 0:n.config)==null?void 0:o.selectedAsset;if(g){const f=String(g.mimeType||"").toLowerCase(),d=String(g.type||"").toUpperCase(),B=g.url.startsWith("http")||g.url.startsWith("data:")?g.url:`${br}${g.url}`;!O&&(d==="VIDEO"||f.startsWith("video/"))&&(O=B)}}else if(Q==="videoPreview"||Q.startsWith("aiVideo")){const g=((a=q.data)==null?void 0:a.videoUrl)||((c=q.data)==null?void 0:c.url)||((S=(w=q.data)==null?void 0:w.config)==null?void 0:S.generatedVideoUrl);!O&&g&&(O=g.startsWith("http")||g.startsWith("data:")?g:`${br}${g}`)}if(O)break}return{videoUrl:O}},[Y,u,fe]);t.useEffect(()=>{if(!D.videoUrl){Oe(0);return}const C=document.createElement("video");C.preload="metadata",C.onloadedmetadata=()=>{C.duration&&C.duration!==1/0&&Oe(C.duration)},C.onerror=()=>Oe(0),C.src=D.videoUrl},[D.videoUrl]);const _=t.useMemo(()=>!!we&&!!D.videoUrl,[we,D.videoUrl]),x=t.useCallback(C=>{var F,X,ue;const O=fe(u);if(!O||!C)return;const r=le(),y=Ce(),l=r.filter(de=>de.type==="videoPreview"&&y.some(ie=>ie.source===u&&ie.target===de.id));if(l.find(de=>{var ie;return((ie=de.data)==null?void 0:ie.videoUrl)===C}))return;const o=400,a=(de,ie=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(de))return ie;const[k,p]=de.split(":").map(N=>parseFloat(N));return!k||!p?ie:Math.round(o*(p/k))},c=200,w=100,S=a("16:9",300),L=document.querySelector(`.react-flow__node[data-id="${u}"]`),q=Math.round((L==null?void 0:L.getBoundingClientRect().width)||400),Q=(((F=O.position)==null?void 0:F.x)||0)+q+c,g=((X=O.position)==null?void 0:X.y)||0,f=l.length,d=Q,B=g+f*(S+w),P={id:`preview-${u}-${Date.now()}`,type:"videoPreview",position:{x:d,y:B},data:{videoUrl:C,width:o,ratio:"16:9",workflowContext:O.data.workflowContext,createdBy:(ue=O.data)==null?void 0:ue.createdBy}};ae(de=>[...de,P]),se(de=>[...de,{id:`edge-${u}-${P.id}`,source:u,target:P.id,type:"aurora"}])},[u,fe,le,Ce,ae,se]);t.useEffect(()=>{var O;const C=(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl;C&&x(C)},[(M=s==null?void 0:s.config)==null?void 0:M.generatedVideoUrl]),t.useEffect(()=>{const C=s.config.taskId;(async()=>{var y,l;let r=!1;if(C)try{const o=(await Me.tasks.getTaskStatus(C)).task;if(o.status==="SUCCESS"){const a=o.resultUrl||((y=o.previewNodeData)==null?void 0:y.url);if(a){let c=!1;try{const w=localStorage.getItem("suppressedPreviewTasks")||"[]";c=JSON.parse(w).some(L=>L.taskId&&L.taskId===C||L.sourceNodeId&&L.sourceNodeId===u)}catch{}c||x(a),ae(w=>w.map(S=>S.id===u?{...S,data:{...S.data,config:{...S.data.config,generatedVideoUrl:a,taskId:C}}}:S))}U(!1),r=!0}else if(o.status==="PROCESSING"||o.status==="PENDING"){U(!0),await m(C);return}else o.status==="FAILURE"&&(U(!1),ae(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c)))}catch{U(!1)}if(!r)try{const n=await Me.tasks.getPendingPreviewNodes(u);if(Array.isArray(n.tasks)&&n.tasks.length>0)for(const o of n.tasks){const a=(l=o.previewNodeData)==null?void 0:l.url;if(a){let c=!1;try{const w=localStorage.getItem("suppressedPreviewTasks")||"[]";c=JSON.parse(w).some(L=>L.taskId&&L.taskId===o.id||L.sourceNodeId&&L.sourceNodeId===u)}catch{}c||x(a),await Me.tasks.markPreviewNodeCreated(o.id)}}}catch{}})()},[]);const m=async C=>{let O=0;const r=600,y=async()=>{var l;try{O++;const o=(await Me.tasks.getTaskStatus(C)).task;if(o.status==="SUCCESS"){const a=o.resultUrl||((l=o.previewNodeData)==null?void 0:l.url);a&&(x(a),ae(c=>c.map(w=>w.id!==u?w:{...w,data:{...w.data,config:{...w.data.config,generatedVideoUrl:a,taskId:C}}}))),U(!1),h.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else o.status==="PROCESSING"||o.status==="PENDING"?O<r?setTimeout(y,5e3):(U(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ae(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c))):o.status==="FAILURE"&&(U(!1),h.error(o.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ae(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c)))}catch{U(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ae(o=>o.map(a=>a.id===u?{...a,data:{...a.data,config:{...a.data.config,taskId:""}}}:a))}};y()},I=async()=>{var C,O;if(!_){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}U(!0);try{const r=await Me.post("/tasks/video-edit",{modelId:we,prompt:"",referenceImages:[],sourceNodeId:u,generationType:"é£æ ¼è½¬æ¢",duration:he,metadata:{videoUrl:D.videoUrl,styleId:ve,videoFps:ce,duration:he}}),y=r.taskId,l=r.creditsCharged||0;if(l>0)try{const{useAuthStore:n}=await gs(async()=>{const{useAuthStore:a}=await import("./index-DOiS8MNr.js").then(c=>c.f);return{useAuthStore:a}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:o}=n.getState();await o(),h.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${l} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ae(n=>n.map(o=>o.id===u?{...o,data:{...o.data,config:{...o.data.config,taskId:y,styleId:ve,videoFps:ce}}}:o)),await m(y)}catch(r){U(!1);const y=((O=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:O.error)||r.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${y}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:K?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(rs,{value:we,onChange:C=>{oe(C),ae(O=>O.map(r=>{var y;return r.id===u?{...r,data:{...r.data,config:{...r.data.config,modelId:C,modelName:(y=De.find(l=>l.id===C))==null?void 0:y.name}}}:r}))},options:De.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:De.map(C=>({value:C.id,label:C.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(rs,{value:String(ve),onChange:C=>{const O=parseInt(C,10);ee(O),ae(r=>r.map(y=>y.id===u?{...y,data:{...y.data,config:{...y.data.config,styleId:O}}}:y))},options:eo.map(C=>({value:String(C.id),label:C.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:ce,min:15,max:25,onChange:C=>{let O=parseInt(C.target.value,10)||15;O<15&&(O=15),O>25&&(O=25),Z(O),ae(r=>r.map(y=>y.id===u?{...y,data:{...y.data,config:{...y.data.config,videoFps:O}}}:y))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),D.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:me,src:D.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:C=>{const O=C.currentTarget;O.duration&&O.duration!==1/0&&Oe(O.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:I,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!$&&(T!==null&&T>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[T,"ç§¯åˆ†"]}):he===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},so=t.memo(to),ro=({data:s,selected:E,id:u})=>{const[K,Ie]=t.useState(null),[U,ve]=t.useState(!1),[ee,ce]=t.useState(s.config.prompt||""),[Z,he]=t.useState(""),Oe=t.useRef(null),me=t.useRef(!1),[ae,se]=t.useState(!1),{setNodes:fe,setEdges:le,getNode:Ce,getNodes:Y,getEdges:De}=ts(),we=dr(n=>n.edges.filter(o=>o.target===u)),oe=Ds(),[T,$]=t.useState([]),[D,_]=t.useState([]),x=t.useRef(""),m=t.useMemo(()=>((K==null?void 0:K.roles)||[]).find(n=>n.id===Z),[K,Z]),{credits:I,loading:te,isFreeUsage:M,freeUsageRemaining:C}=Ls({aiModelId:m==null?void 0:m.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&O(s.config.agentId)},[s.config.agentId]);const O=async n=>{var o,a,c,w,S;try{ve(!0);const L=await Me.agents.getById(n);let q=[];try{q=await Me.agents.roles.listByAgent(n)||[],Ie({...L,roles:q});const g=((o=s==null?void 0:s.config)==null?void 0:o.roleId)||"";he(g||((a=q[0])==null?void 0:a.id)||"")}catch{Ie(L)}try{const Q=await Me.agents.getAvailableModels(),g=(q||[]).find(f=>{var d;return f.id===((d=s==null?void 0:s.config)==null?void 0:d.roleId)});if(g){const f=(Q||[]).find(B=>B.id===g.aiModelId),d=((c=f==null?void 0:f.config)==null?void 0:c.acceptedInputs)||((f==null?void 0:f.type)==="TEXT_GENERATION"&&((S=(w=f==null?void 0:f.provider)==null?void 0:w.toLowerCase())!=null&&S.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:d})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{h.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{ve(!1)}};t.useEffect(()=>{r({roleId:Z}),(async()=>{var n,o,a;if(K)try{const c=await Me.agents.getAvailableModels(),w=(K.roles||[]).find(S=>S.id===Z);if(w){const S=(c||[]).find(q=>q.id===w.aiModelId),L=((n=S==null?void 0:S.config)==null?void 0:n.acceptedInputs)||((S==null?void 0:S.type)==="TEXT_GENERATION"&&((a=(o=S==null?void 0:S.provider)==null?void 0:o.toLowerCase())!=null&&a.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:L})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[Z,K]);const r=n=>{Ce(u)&&fe(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,...n}}}:c))};t.useEffect(()=>{const n=Oe.current;n&&requestAnimationFrame(()=>{n.style.height="auto";const o=Math.max(60,Math.min(n.scrollHeight,600));n.style.height=`${o}px`})},[ee]),t.useEffect(()=>{const n=setTimeout(()=>{ee!==s.config.prompt&&r({prompt:ee})},500);return()=>clearTimeout(n)},[ee,s.config.prompt]),t.useEffect(()=>{const n=we;if(!n||n.length===0)return;let o="";n.some(a=>{const c=oe.find(S=>S.id===a.source);if(!c)return!1;const w=c.data||{};return c.type==="textPreview"&&typeof w.content=="string"&&w.content.trim()?(o=w.content.trim(),!0):!1}),o&&!me.current&&(ce(o),r({prompt:o}))},[we,oe]),t.useEffect(()=>{const n=we.map(c=>`${c.id}-${c.source}`).sort().join(",");if(n===x.current)return;x.current=n;const o=[],a=[];we.forEach(c=>{var L,q,Q;const w=Ce(c.source);if(!w)return;const S=w.data||{};if(w.type==="upload")(((L=S.config)==null?void 0:L.uploadedFiles)||[]).forEach(f=>{f.type==="IMAGE"&&o.push(f.url),f.type==="DOCUMENT"&&a.push({name:f.originalName,url:f.url})});else if(w.type==="assetSelector"){const g=(q=S.config)==null?void 0:q.subjects;if(g&&g.length>0)(g[0].images||[]).map(d=>{const B="https://api.waule.com";return d.startsWith("data:")?d:d.startsWith("http")?d.replace(/^https?:\/\/localhost(?::\d+)?/i,B):`${B}${d}`}).forEach(d=>o.push(d));else{const f=(Q=S.config)==null?void 0:Q.selectedAsset;if(f){const d="https://api.waule.com",B=P=>P.startsWith("http")?P.replace(/^https?:\/\/localhost(?::\d+)?/i,d):`${d}${P}`;f.type==="IMAGE"&&o.push(B(f.url)),f.type==="DOCUMENT"&&a.push({name:f.originalName,url:B(f.url)})}}}else w.type==="imagePreview"&&S.imageUrl&&o.push(S.imageUrl)}),$(o),_(a)},[we,Ce,oe]);const y=()=>{if(!K)return null;const n=(K.roles||[]).find(o=>o.id===Z);return n?{systemPrompt:n.systemPrompt,aiModelId:n.aiModelId,temperature:n.temperature,maxTokens:n.maxTokens}:null},l=async()=>{var o,a,c,w,S,L,q,Q,g,f,d,B,P,F;if(!K){h.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!ee.trim()){h.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let n=(K.roles||[]).find(X=>X.id===Z)||(K.roles||[])[0];if(!n){h.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!Z||Z!==n.id)&&(he(n.id),r({roleId:n.id}));try{se(!0);const ue=De().filter(je=>je.target===u);let de="";const ie="https://api.waule.com",k=[],p=[],N=[];for(const je of ue){const Te=Ce(je.source);if(Te)if(Te.type==="upload"){const Re=((a=(o=Te.data)==null?void 0:o.config)==null?void 0:a.uploadedFiles)||[];for(const re of Re)if(re.type==="DOCUMENT")k.push({filePath:re.url,mimeType:re.mimeType}),de+=`[æ–‡æ¡£æ–‡ä»¶: ${re.originalName}]
`;else if(re.type==="IMAGE"){const Be=re.url.startsWith("http")?re.url:`${ie}${re.url}`;p.push(Be),de+=`[å›¾ç‰‡æ–‡ä»¶: ${re.originalName}]
`}else if(re.type==="VIDEO"){const Be=re.url.startsWith("http")?re.url:`${ie}${re.url}`;N.push(Be),de+=`[è§†é¢‘æ–‡ä»¶: ${re.originalName}]
`}else re.type==="AUDIO"&&(de+=`[éŸ³é¢‘æ–‡ä»¶: ${re.originalName}]
`)}else if(Te.type==="assetSelector"){const Re=(w=(c=Te.data)==null?void 0:c.config)==null?void 0:w.subjects;if(Re&&Re.length>0){const re=(Re[0].images||[]).map(Be=>Be.startsWith("http")?Be:`${ie}${Be}`).map(Be=>Be.replace(/^https?:\/\/localhost(?::\d+)?/i,ie));re.forEach(Be=>p.push(Be)),de+=`[å‚è€ƒå›¾ç‰‡ç»„: ${re.length} å¼ ]
`}else{const re=(L=(S=Te.data)==null?void 0:S.config)==null?void 0:L.selectedAsset;if(re){if(re.type==="DOCUMENT")k.push({filePath:re.url,mimeType:re.mimeType}),de+=`[æ–‡æ¡£æ–‡ä»¶: ${re.originalName}]
`;else if(re.type==="IMAGE"){let Be=re.url.startsWith("http")?re.url:`${ie}${re.url}`;Be=Be.replace(/^https?:\/\/localhost(?::\d+)?/i,ie),p.push(Be),de+=`[å›¾ç‰‡æ–‡ä»¶: ${re.originalName}]
`}else if(re.type==="VIDEO"){let Be=re.url.startsWith("http")?re.url:`${ie}${re.url}`;Be=Be.replace(/^https?:\/\/localhost(?::\d+)?/i,ie),N.push(Be),de+=`[è§†é¢‘æ–‡ä»¶: ${re.originalName}]
`}}}}else if(Te.type==="aiImage"){const Re=(Q=(q=Te.data)==null?void 0:q.config)==null?void 0:Q.generatedImageUrl;if(Re){const re=Re.startsWith("http")?Re:`${ie}${Re}`;p.push(re),de+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(Te.type==="imagePreview"){const Re=Te.data.imageUrl;Re&&(p.push(Re),de+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(Te.type==="videoPreview"){const Re=Te.data.videoUrl;if(Re){const re=Re.startsWith("http")?Re:`${ie}${Re}`;N.push(re),de+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else Te.type==="textPreview"&&Te.data.content&&(de+=Te.data.content+`

`)}const b=y();if(!b)return;let V=b.systemPrompt;de&&(V+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${de}`),V+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${ee}`;const ne=await Me.ai.text.generate({modelId:n.aiModel.id||b.aiModelId,prompt:V,systemPrompt:n.systemPrompt||b.systemPrompt,temperature:n.temperature??b.temperature,maxTokens:n.maxTokens??b.maxTokens,documentFiles:k.length>0?k:void 0,imageUrls:p.length>0?p:void 0,videoUrls:N.length>0?N:void 0}),H=ne&&(((g=ne.data)==null?void 0:g.text)||(ne==null?void 0:ne.text))||"";if(!H||H.trim()===""){h.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:H});const ge=De().filter(je=>je.source===u),Se=Y(),ye=ge.filter(je=>{const Te=Se.find(Re=>Re.id===je.target);return Te&&Te.type!=="textPreview"});if(ye.length>0)fe(je=>{const Te=new Set(ye.map(Re=>Re.target));return je.map(Re=>{var Be;if(!Te.has(Re.id))return Re;const re=((Be=Re.data)==null?void 0:Be.config)||{};return Re.type==="midjourney"?{...Re,data:{...Re.data,prompt:H}}:{...Re,data:{...Re.data,config:{...re,prompt:H}}}})});else{const je=Ce(u);if(je){const Te=Date.now(),Re=`text-preview-${u}-${Te}`,re=ge.filter(ut=>{const Et=Se.find(nt=>nt.id===ut.target);return Et&&Et.type==="textPreview"}),Be=document.querySelector(`.react-flow__node[data-id="${u}"]`),qe=(Be==null?void 0:Be.getBoundingClientRect().width)||300,Ft=je.position.x+qe+100,at=je.position.y+re.length*700,ot={id:Re,type:"textPreview",position:{x:Ft,y:at},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:H,createdBy:(f=je.data)==null?void 0:f.createdBy}},Le={id:`edge-${u}-${Re}`,source:u,target:Re,type:"aurora"};fe(ut=>[...ut,ot]),setTimeout(()=>{le(ut=>[...ut,Le])},50)}}const _e=(ne==null?void 0:ne.creditsCharged)||0;if(_e>0){const{useAuthStore:je}=await gs(async()=>{const{useAuthStore:Re}=await import("./index-DOiS8MNr.js").then(re=>re.f);return{useAuthStore:Re}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Te}=je.getState();await Te(),h.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${_e} ç§¯åˆ†ï¼‰`)}else h.success("æ‰§è¡ŒæˆåŠŸ")}catch(X){const ue=((B=(d=X==null?void 0:X.response)==null?void 0:d.data)==null?void 0:B.message)||((F=(P=X==null?void 0:X.response)==null?void 0:P.data)==null?void 0:F.error)||(X==null?void 0:X.message)||"æœªçŸ¥é”™è¯¯";h.error("æ‰§è¡Œå¤±è´¥ï¼š"+ue)}finally{se(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:U?"LOADING...":((K==null?void 0:K.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[K&&(K.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(rs,{value:Z,onChange:n=>he(n),options:[...K.roles||[]].sort((n,o)=>(n.order??0)-(o.order??0)).map(n=>({value:n.id,label:n.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Oe,value:ee,onChange:n=>{me.current=!0,ce(n.target.value)},onMouseDown:n=>n.stopPropagation(),onTouchStart:n=>n.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:l,disabled:ae||U||!K||!ee.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg dark:hover:from-purple-500/60 dark:hover:to-pink-500/60 border-transparent dark:border-white/10",children:ae?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!te&&(M?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",C,"æ¬¡"]}):I!==null&&I>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[I,"ç§¯åˆ†"]}):null)]})}),T.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",T.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:T.map((n,o)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:n,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"})},o))})]}),D.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",D.length,")"]}),e.jsx("div",{className:"space-y-1",children:D.map((n,o)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:n.name,children:n.name})]},o))})]})]}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ao=t.memo(ro),wr="https://api.waule.com",_s=400,oo=({data:s,id:E,selected:u})=>{const[K,Ie]=t.useState(!1),[U,ve]=t.useState(0),[ee,ce]=t.useState(s.config.uploadedFiles||[]),[Z,he]=t.useState(null),[Oe,me]=t.useState(null);t.useEffect(()=>()=>{},[E]),t.useEffect(()=>{},[Z]),t.useEffect(()=>{},[Oe]);const[ae,se]=t.useState(null),fe=t.useRef(null),le=t.useRef(null),Ce=t.useRef(null),[Y,De]=t.useState(!1),[we,oe]=t.useState(0),[T,$]=t.useState(0),[D,_]=t.useState(!1),x=t.useRef(null),{setNodes:m,getNode:I,setEdges:te,getEdges:M}=ts(),C=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const d=s.createdBy;if(typeof d=="object"&&(d==null||d.id),C.current)return;const B=s.config.uploadedFiles||[];!K&&JSON.stringify(B)!==JSON.stringify(ee)&&(ce(B),he(null),me(null))},[s.config.uploadedFiles,K,s._currentUserId,s.createdBy]);const O=()=>{x.current&&(x.current.paused?(x.current.play(),_(!0)):(x.current.pause(),_(!1)))},r=d=>{I(E)&&(C.current=!0,m(P=>P.map(F=>F.id===E?{...F,data:{...F.data,config:{...F.data.config,uploadedFiles:d}}}:F)))},y=async d=>{var P,F;if(!d||d.length===0)return;Ie(!0);const B=[];try{for(let X=0;X<d.length;X++){const ue=d[X];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ue.type)){h.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ue.name}`);continue}const ie=await Me.assets.upload(ue,void 0,{onUploadProgress:k=>{const p=(k==null?void 0:k.total)||0,N=(k==null?void 0:k.loaded)||0;if(p>0){const b=Math.round(N/p*100);ve(b)}}});if(ie.data){const k=(ie.data.type||"").toUpperCase(),p=(ie.data.mimeType||"").toLowerCase(),N=k==="IMAGE"||k==="VIDEO"||k==="AUDIO"?k:p.startsWith("image/")?"IMAGE":p.startsWith("video/")?"VIDEO":p.startsWith("audio/")?"AUDIO":k||"",b=ie.data.url;B.push({id:ie.data.id,name:ie.data.name,originalName:ie.data.originalName,type:N,mimeType:ie.data.mimeType,size:ie.data.size,url:b})}}if(B.length>0){let X=[];const ue=B[0].type;if(ae!==null)X=[...ee],X[ae]=B[0];else{const ie={};for(const k of ee)ie[k.id]=k;for(const k of B)ie[k.id]=k;X=Object.values(ie)}if(I(E)){const ie=M().filter(p=>p.source===E),k=[];if(ie.forEach(p=>{var V;const N=I(p.target);if(!N||N.type.startsWith("aiVideo"))return;const b=(V=N.data.config)==null?void 0:V.acceptedInputs;if(b&&b.length>0){const ne=ue.toUpperCase();b.map(ge=>typeof ge=="string"?ge.toUpperCase():ge).includes(ne)||k.push(p.id)}}),k.length>0){te(N=>N.filter(b=>!k.includes(b.id)));const p={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.warning(`å·²æ–­å¼€ ${k.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${p[ue]||ue}ç±»å‹ï¼‰`)}}he(null),me(null),ce(X),r(X);try{const ie=M().filter(p=>p.source===E);if(ie.some(p=>{const N=I(p.target);return(N==null?void 0:N.type)==="aiVideo"})){const p=localStorage.getItem("workflow:nodes"),N=p?JSON.parse(p):[],b=ie.filter(ne=>{var H;return((H=I(ne.target))==null?void 0:H.type)==="aiVideo"}).map(ne=>ne.target),V=N.filter(ne=>b.includes(ne.id));V.length>0&&m(ne=>ne.map(H=>V.find(ge=>ge.id===H.id)?{...H,data:{...H.data,config:{...H.data.config,_updatedAt:Date.now()}}}:H))}}catch{}h.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(X){h.error(`ä¸Šä¼ å¤±è´¥: ${((F=(P=X.response)==null?void 0:P.data)==null?void 0:F.message)||X.message}`)}finally{Ie(!1),ve(0),fe.current&&(fe.current.value=""),se(null)}},l=()=>{m(d=>d.filter(B=>B.id!==E)),te(d=>d.filter(B=>B.source!==E&&B.target!==E)),h.success("èŠ‚ç‚¹å·²åˆ é™¤")},n=()=>{var d;se(0),(d=fe.current)==null||d.click()},o=d=>d<1024?d+" B":d<1024*1024?(d/1024).toFixed(2)+" KB":(d/(1024*1024)).toFixed(2)+" MB",a=d=>d.startsWith("image/")?{icon:"image",color:"text-tiffany-400"}:d.startsWith("video/")?{icon:"movie",color:"text-green-400"}:d.startsWith("audio/")?{icon:"audio_file",color:"text-blue-400"}:{icon:"description",color:"text-tiffany-400"};t.useEffect(()=>{if(ee.length>0){const d=ee[0],B=(d.url.startsWith("http")||d.url.startsWith("data:")?d.url:`${wr}${d.url}`).replace(".oss-oss-",".oss-");if(d.type==="IMAGE"){const P=new Image;P.onload=()=>{const F=P.width/P.height,X=_s/F;he({width:_s,height:X})},P.onerror=F=>{he({width:_s,height:_s*.75})},P.src=B}else if(d.type==="VIDEO"){const P=document.createElement("video");P.onloadedmetadata=()=>{const F=P.videoWidth/P.videoHeight,X=_s/F;me({width:_s,height:X})},P.onerror=F=>{me({width:_s,height:_s*.5625})},P.src=B}}},[ee]);const c=()=>{const d=le.current;d&&(Y?(d.pause(),De(!1)):(d.play(),De(!0)))};t.useEffect(()=>{const d=le.current;if(!d)return;const B=()=>oe(d.duration||0),P=()=>$(d.duration?d.currentTime/d.duration:0),F=()=>De(!1);return d.addEventListener("loadedmetadata",B),d.addEventListener("timeupdate",P),d.addEventListener("ended",F),()=>{d.removeEventListener("loadedmetadata",B),d.removeEventListener("timeupdate",P),d.removeEventListener("ended",F)}},[ee]);const w=t.useRef(null),[S,L]=t.useState(0);t.useEffect(()=>{const d=ee[0];if(!d||d.type!=="AUDIO"){w.current=null;return}const P=(d.url.startsWith("http")||d.url.startsWith("data:")?d.url:`${wr}${d.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let X;/https:\/\/.*aliyuncs\.com\//.test(P)?X=await Me.assets.proxyDownload(P):X=await(await fetch(P,{mode:"cors"})).arrayBuffer();const ue=window.AudioContext||window.webkitAudioContext,k=(await new ue().decodeAudioData(X)).getChannelData(0),p=120,N=Math.max(1,Math.floor(k.length/p)),b=new Float32Array(p);for(let V=0;V<p;V++){let ne=0,H=0;const ge=V*N,Se=Math.min(k.length,ge+N);for(let ye=ge;ye<Se;ye++)ne+=Math.abs(k[ye]),H++;b[V]=H?ne/H:0}w.current=b,L(V=>V+1)}catch{const ue=new Float32Array(120);for(let de=0;de<120;de++)ue[de]=(Math.sin(de/5)+1)/2;w.current=ue,L(de=>de+1)}})()},[ee]),t.useEffect(()=>{const d=Ce.current;if(!d)return;const B=w.current;if(!B)return;const P=d.getContext("2d");if(!P)return;const F=d.width,X=d.height;P.clearRect(0,0,F,X);const ue=B.length,de=2,ie=Math.max(1,Math.floor((F-(ue-1)*de)/ue)),k=P.createLinearGradient(0,0,F,0);k.addColorStop(0,"#a855f7"),k.addColorStop(.5,"#d946ef"),k.addColorStop(1,"#ec4899");for(let p=0;p<ue;p++){const N=Math.min(1,Math.max(0,B[p])),b=Math.max(2,Math.floor(N*X)),V=p*(ie+de),ne=Math.floor((X-b)/2);P.fillStyle=k,P.fillRect(V,ne,ie,b)}if(T>0){const p=Math.floor(F*T);P.fillStyle="#ffffff88",P.fillRect(p,0,2,X)}},[T,S]);const q=d=>{if(!d||!isFinite(d))return"0:00";const B=Math.floor(d/60),P=Math.floor(d%60);return`${B}:${P.toString().padStart(2,"0")}`},Q=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"tiffany"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"green"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"blue"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"tiffany"}],g=ee[0],f=g?(g.url.startsWith("http")||g.url.startsWith("data:")?g.url:`${wr}${g.url}`).replace(".oss-oss-",".oss-"):"";return g&&g.type==="IMAGE"&&Z?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:f,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:Z.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:d=>y(d.target.files),className:"hidden"})]}):g&&g.type==="VIDEO"&&Oe?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${D?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:d=>{d.stopPropagation(),O()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:D?"pause":"play_arrow"})})}),e.jsx("video",{ref:x,src:f,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Oe.height},onEnded:()=>_(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:d=>y(d.target.files),className:"hidden"})]}):g&&g.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:c,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:Y?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:q(we)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:Ce,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:le,src:f,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:d=>y(d.target.files),className:"hidden"})]}):g&&g.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:g.originalName,children:g.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:o(g.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:d=>y(d.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:fe,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:d=>y(d.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var d;s._canEdit!==!1&&((d=fe.current)==null||d.click())},onDragOver:d=>{d.preventDefault(),d.stopPropagation()},onDrop:d=>{d.preventDefault(),d.stopPropagation(),s._canEdit!==!1&&y(d.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-purple-400 dark:hover:border-purple-400/50 transition-colors ${K||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:K?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:K?`ä¸Šä¼ ä¸­... ${U}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),K&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all",style:{width:`${U}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Q.map(d=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${d.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:d.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:d.formats.join(", ")})]},d.type))})]}),ee.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",ee.length,")"]}),ee.map(d=>{const{icon:B,color:P}=a(d.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${P} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:B}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:d.originalName,children:d.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:o(d.size)})]}),e.jsx("button",{onClick:l,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},d.id)})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},no=t.memo(oo),Mr="https://api.waule.com",Ms=320,io=({data:s,id:E,selected:u})=>{const[K,Ie]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[U,ve]=t.useState([]),{setNodes:ee,getNode:ce}=ts(),[Z,he]=t.useState(null),[Oe,me]=t.useState(null),ae=t.useRef(null),se=t.useRef(null),[fe,le]=t.useState(!1),[Ce,Y]=t.useState(0),[De,we]=t.useState(0),oe=t.useRef(null),[T,$]=t.useState(!1),[D,_]=t.useState(!1),x=t.useRef(null),m=()=>{x.current&&(x.current.paused?(x.current.play(),_(!0)):(x.current.pause(),_(!1)))},I=t.useRef(!1);t.useEffect(()=>{const l=s._currentUserId,n=s.createdBy,o=typeof n=="object"?n==null?void 0:n.id:n;if(l&&o&&l===o&&I.current)return;const a=s.config.selectedInput||s.config.selectedAsset||null;if(!a)return;const c=K;(()=>{if(!c)return!1;const S=c.images&&!c.type,L=a.images&&!a.type;if(S&&L){const q=c.images||[],Q=a.images||[];if(q.length!==Q.length)return!1;for(let g=0;g<q.length;g++)if(q[g].id!==Q[g].id||q[g].url!==Q[g].url)return!1;return!0}if(c.id&&a.id)return c.id===a.id&&c.url===a.url&&c.type===a.type;try{return JSON.stringify(c)===JSON.stringify(a)}catch{return!1}})()||Ie(a)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var n,o,a;if(K&&K.images&&!K.type){const c=K,w=(a=(o=(n=ce(E))==null?void 0:n.data)==null?void 0:o.config)==null?void 0:a.referenceImages;Array.isArray(w)&&w.length>0?ve(w.map(S=>({id:S.id,url:S.url,name:S.name}))):ve(c.images||[])}else ve([])},[K,ce,E]);const te=l=>{const n=ce(E);n&&(I.current=!0,ee(o=>o.map(a=>a.id===E?{...a,data:{...a.data,config:{...a.data.config,...l}}}:a)),Ie((l==null?void 0:l.selectedInput)??(l==null?void 0:l.selectedAsset)??n.data.config.selectedInput??n.data.config.selectedAsset))},M=l=>/^https?:\/\//.test(l)||l.startsWith("data:"),C=l=>!l||l.startsWith("data:")?l:/^https?:\/\/localhost(?::\d+)?\//i.test(l)?l.replace(/^https?:\/\/localhost(?::\d+)?/i,Mr):M(l)?l:`${Mr}${l}`;t.useEffect(()=>{var Q,g,f,d,B,P,F,X,ue;if(!(K&&K.images&&!K.type))return;const n=K,o=U.length?U:n.images||[];if(o.length===1){const de=o[0],ie={id:de.id,name:de.name,originalName:de.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:de.url};te({selectedInput:ie,selectedAsset:ie,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const a=[{name:n.name,images:o.map(de=>C(de.url))}],c=o.map(de=>({id:de.id,url:de.url,name:de.name})),w=[n.id],S=(f=(g=(Q=ce(E))==null?void 0:Q.data)==null?void 0:g.config)==null?void 0:f.subjects,L=(P=(B=(d=ce(E))==null?void 0:d.data)==null?void 0:B.config)==null?void 0:P.referenceImages,q=(ue=(X=(F=ce(E))==null?void 0:F.data)==null?void 0:X.config)==null?void 0:ue.roleIds;(JSON.stringify(S)!==JSON.stringify(a)||JSON.stringify(L)!==JSON.stringify(c)||JSON.stringify(q)!==JSON.stringify(w))&&te({subjects:a,referenceImages:c,roleIds:w})},[U]);const O=l=>{if(!(K&&K.images&&!K.type))return;const o=K,a=[...U];if(l<0||l>=a.length)return;if(a.splice(l,1),ve(a),h.success("å·²åˆ é™¤å‚è€ƒå›¾"),a.length===0){Ie(null),te({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),h.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(a.length===1){const q=a[0],Q={id:q.id,name:q.name,originalName:q.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:q.url};Ie(Q),te({selectedInput:Q,selectedAsset:Q,subjects:void 0,referenceImages:void 0,roleIds:void 0}),h.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const c={id:o.id,name:o.name,coverUrl:C(a[0].url),images:a};Ie(c);const w=[{name:c.name,images:a.map(q=>C(q.url))}],S=a.map(q=>({id:q.id,url:q.url,name:q.name})),L=[c.id];te({selectedInput:c,subjects:w,referenceImages:S,roleIds:L}),h.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(E)};t.useEffect(()=>{if(K&&K.type){const l=K;if(l.type==="IMAGE"){const n=new Image;n.onload=()=>{const o=n.width/n.height,a=Ms/o;he({width:Ms,height:a})},n.src=C(l.url)}else if(l.type==="VIDEO"){const n=document.createElement("video");n.onloadedmetadata=()=>{const o=n.videoWidth/n.videoHeight,a=Ms/o;me({width:Ms,height:a})},n.src=C(l.url)}}},[K]),t.useEffect(()=>{if(!(K&&K.type==="AUDIO")){$(!1);return}const o=C(K.url),a=ae.current,c=se.current;if(!a||!c)return;a.src=o,we(0),$(!1);const w=()=>Y(a.duration||0),S=()=>we(a.duration?a.currentTime/a.duration:0),L=()=>le(!1);return a.addEventListener("loadedmetadata",w),a.addEventListener("timeupdate",S),a.addEventListener("ended",L),(async()=>{try{const g=await(await fetch(o,{mode:"cors"})).arrayBuffer(),f=window.AudioContext||window.webkitAudioContext,P=(await new f().decodeAudioData(g)).getChannelData(0),F=120,X=Math.max(1,Math.floor(P.length/F)),ue=new Float32Array(F);for(let de=0;de<F;de++){let ie=0,k=0;const p=de*X,N=Math.min(P.length,p+X);for(let b=p;b<N;b++)ie+=Math.abs(P[b]),k++;ue[de]=k?ie/k:0}oe.current=ue,$(!0)}catch{const g=new Float32Array(120);for(let f=0;f<120;f++)g[f]=(Math.sin(f/5)+1)/2;oe.current=g,$(!0)}})(),()=>{a.removeEventListener("loadedmetadata",w),a.removeEventListener("timeupdate",S),a.removeEventListener("ended",L)}},[K]),t.useEffect(()=>{if(!(K&&K.type==="AUDIO")||!T)return;const n=se.current,o=oe.current;if(!n||!o)return;const a=n.getContext("2d");if(!a)return;const c=n.width,w=n.height;a.clearRect(0,0,c,w);const S=o.length,L=2,q=Math.max(1,Math.floor((c-(S-1)*L)/S)),Q=a.createLinearGradient(0,0,c,0);Q.addColorStop(0,"#a855f7"),Q.addColorStop(.5,"#d946ef"),Q.addColorStop(1,"#ec4899");for(let g=0;g<S;g++){const f=Math.min(1,Math.max(0,o[g])),d=Math.max(2,Math.floor(f*w)),B=g*(q+L),P=Math.floor((w-d)/2);a.fillStyle=Q,a.fillRect(B,P,q,d)}if(De>0){const g=Math.floor(c*De);a.fillStyle="#ffffff88",a.fillRect(g,0,2,w)}},[K,De,T]);const y=l=>l<1024?l+" B":l<1024*1024?(l/1024).toFixed(2)+" KB":(l/(1024*1024)).toFixed(2)+" MB";if(K){if(K.images&&!K.type){const a=K;return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ms*.5625},children:U[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:c=>c.preventDefault(),src:C(U[0].url),alt:a.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:c=>{c.preventDefault(),c.stopPropagation(),c.nativeEvent&&typeof c.nativeEvent.stopImmediatePropagation=="function"&&c.nativeEvent.stopImmediatePropagation(),O(0)},onClick:c=>{c.preventDefault(),c.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:a.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:U.slice(1).map((c,w)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:S=>S.preventDefault(),src:C(c.url),alt:c.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:S=>{S.preventDefault(),S.stopPropagation(),S.nativeEvent&&typeof S.nativeEvent.stopImmediatePropagation=="function"&&S.nativeEvent.stopImmediatePropagation(),O(w+1)},onClick:S=>{S.preventDefault(),S.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},c.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const n=K,o=C(n.url);if(n.type==="IMAGE"&&Z)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:o,alt:n.name,className:"w-full object-cover",style:{width:Ms,height:Z.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(n.type==="VIDEO"&&Oe)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${D?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:a=>{a.stopPropagation(),m()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:D?"pause":"play_arrow"})})}),e.jsx("video",{ref:x,src:o,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ms,height:Oe.height},onEnded:()=>_(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(n.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:n.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const a=ae.current;a&&(fe?(a.pause(),le(!1)):(a.play(),le(!0)))},className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:fe?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const a=Ce;if(!a||!isFinite(a))return"0:00";const c=Math.floor(a/60),w=Math.floor(a%60);return`${c}:${w.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:se,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ae,src:o,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(n.type==="DOCUMENT"){const a=S=>S.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:S.includes("word")?{icon:"description",color:"text-blue-400"}:S.includes("excel")||S.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:c,color:w}=a(n.mimeType);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${w} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:c}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:n.originalName,children:n.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:y(n.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},lo=t.memo(io),co=({data:s,id:E})=>{var n;const{setNodes:u,setEdges:K,getNodes:Ie}=ts(),U=kr(o=>o.refreshUser),[ve,ee]=t.useState(!1),[ce,Z]=t.useState([]),[he,Oe]=t.useState(""),[me,ae]=t.useState("ALL"),[se,fe]=t.useState(""),[le,Ce]=t.useState(!1),Y=s.width||400,[De,we]=t.useState(null);t.useEffect(()=>{ve&&(O(),setTimeout(()=>{r()},100))},[ve]);const oe=t.useRef(null),T=t.useRef(!1);t.useEffect(()=>{const o=s.pendingButtonAction;if(o){try{const w=localStorage.getItem("suppressedPreviewTasks")||"[]",S=JSON.parse(w),L=localStorage.getItem("createdPreviewTasks")||"[]",q=JSON.parse(L),Q=S.some(B=>B.taskId&&B.taskId===o.newTaskId||B.sourceNodeId&&B.sourceNodeId===o.sourceNodeId),f=Ie().some(B=>{var P,F,X,ue;return B.type==="imagePreview"&&((F=(P=B.data)==null?void 0:P.midjourneyData)==null?void 0:F.sourceNodeId)===o.sourceNodeId&&((ue=(X=B.data)==null?void 0:X.midjourneyData)==null?void 0:ue.taskId)===o.newTaskId}),d=q.some(B=>B.taskId&&B.taskId===o.newTaskId);if(Q||d&&f){we(null),u(B=>B.map(P=>P.id===o.sourceNodeId?{...P,data:{...P.data,pendingButtonAction:void 0}}:P));return}}catch{}if(T.current)return;if(T.current=!0,Ie().some(w=>{var S,L,q,Q;return w.type==="imagePreview"&&((L=(S=w.data)==null?void 0:S.midjourneyData)==null?void 0:L.sourceNodeId)===o.sourceNodeId&&((Q=(q=w.data)==null?void 0:q.midjourneyData)==null?void 0:Q.taskId)===o.newTaskId})){we(null),u(w=>w.map(S=>S.id===o.sourceNodeId?{...S,data:{...S.data,pendingButtonAction:void 0}}:S)),T.current=!1;return}we(o.buttonCustomId),$(o.newTaskId,o.buttonLabel,o.sourceNodeId)}return()=>{T.current=!1,oe.current&&(clearTimeout(oe.current),oe.current=null)}},[]);const $=async(o,a,c)=>{const w=c||E;let S=0;const L=150,q=2e3;T.current=!0;const Q=/^[UV]\d$/.test(a)||a.includes("Vary")||a.includes("Upscale")&&a!=="Upscale"||a.includes("Zoom")||a.includes("Pan")||a.includes("Make")||a.includes("Remaster"),g=async()=>{var f,d,B,P,F,X,ue,de;if(T.current)try{const ie=await Me.midjourney.fetchTask(o);if(!T.current)return;const k=ie.task;if(k.status==="SUCCESS"){if(Q&&s.imageUrl&&((f=s.midjourneyData)!=null&&f.messageId)){const at=k.imageUrl===s.imageUrl,ot=((d=k.properties)==null?void 0:d.messageId)===((B=s.midjourneyData)==null?void 0:B.messageId);if(at&&ot){S++;try{const Le=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(Le).some(nt=>{var yt;return nt.taskId&&nt.taskId===o||nt.messageId&&nt.messageId===((yt=k.properties)==null?void 0:yt.messageId)})){we(null),u(nt=>nt.map(yt=>yt.id===w?{...yt,data:{...yt.data,pendingButtonAction:void 0}}:yt));return}}catch{}S<L?oe.current=setTimeout(g,q):(h.error(`${a} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),we(null),u(Le=>Le.map(ut=>ut.id===w?{...ut,data:{...ut.data,pendingButtonAction:void 0}}:ut)));return}}if(h.success(`${a} å®Œæˆï¼`),we(null),u(at=>at.map(ot=>ot.id===w?{...ot,data:{...ot.data,pendingButtonAction:void 0}}:ot)),Ie().find(at=>{var ot,Le,ut,Et,nt;return at.type==="imagePreview"&&((ot=at.data.midjourneyData)==null?void 0:ot.sourceNodeId)===w&&(((Le=at.data.midjourneyData)==null?void 0:Le.taskId)===o||((ut=k.properties)==null?void 0:ut.messageId)&&((Et=at.data.midjourneyData)==null?void 0:Et.messageId)===((nt=k.properties)==null?void 0:nt.messageId))})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const b=Ie().find(at=>at.id===w);if(!b)return;if(!k.imageUrl){h.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const V=200,ne=100,H=s.width||400,Se=((at,ot=300)=>{if(!at||!/^[0-9]+\s*:\s*[0-9]+$/.test(at))return ot;const[Le,ut]=at.split(":").map(Et=>parseFloat(Et));return!Le||!ut?ot:Math.round(H*(ut/Le))})(s.ratio,300),ye=document.querySelector(`.react-flow__node[data-id="${b.id}"]`),_e=Math.round((ye==null?void 0:ye.getBoundingClientRect().width)||((P=b.data)==null?void 0:P.width)||400),je=Ie().filter(at=>{var ot,Le;return at.type==="imagePreview"&&((Le=(ot=at.data)==null?void 0:ot.midjourneyData)==null?void 0:Le.sourceNodeId)===w}),Te=b.position.x+_e+V,Re=b.position.y,re=Te,Be=Re+je.length*(Se+ne),qe=`preview-${Date.now()}`,Ft={id:qe,type:"imagePreview",position:{x:re,y:Be},data:{imageUrl:k.imageUrl,width:H,height:Se,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(F=b.data)==null?void 0:F.createdBy,midjourneyData:{taskId:o,messageId:(X=k.properties)==null?void 0:X.messageId,messageHash:(ue=k.properties)==null?void 0:ue.messageHash,sourceNodeId:w,buttons:k.buttons,action:k.action}}};u(at=>[...at,Ft]),K(at=>{const ot={id:`${w}-${qe}`,source:w,target:qe,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...at,ot]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const ot=Ie().find(Le=>Le.id===qe)})});try{const at=localStorage.getItem("createdPreviewTasks")||"[]",Le=[...JSON.parse(at),{taskId:o,messageId:(de=k.properties)==null?void 0:de.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(Le))}catch{}h.success(`å·²åˆ›å»º${a}é¢„è§ˆèŠ‚ç‚¹`);return}if(k.status==="FAILURE"){h.error(`${a} å¤±è´¥: ${k.failReason||"æœªçŸ¥é”™è¯¯"}`),we(null),u(p=>p.map(N=>N.id===w?{...N,data:{...N.data,pendingButtonAction:void 0}}:N));return}if(k.status==="NOT_FOUND"){if(Ie().some(b=>{var V,ne,H,ge;return b.type==="imagePreview"&&((ne=(V=b.data)==null?void 0:V.midjourneyData)==null?void 0:ne.sourceNodeId)===w&&((ge=(H=b.data)==null?void 0:H.midjourneyData)==null?void 0:ge.taskId)===o})){we(null),u(b=>b.map(V=>V.id===w?{...V,data:{...V.data,pendingButtonAction:void 0}}:V));return}h.error(`${a} ä»»åŠ¡ä¸å­˜åœ¨`),we(null),u(b=>b.map(V=>V.id===w?{...V,data:{...V.data,pendingButtonAction:void 0}}:V));return}S++,S<L?oe.current=setTimeout(g,q):(h.error(`${a} è¶…æ—¶`),we(null),u(p=>p.map(N=>N.id===E?{...N,data:{...N.data,pendingButtonAction:void 0}}:N)))}catch(ie){h.error(`${a} å¤±è´¥: ${ie.message}`),we(null),u(k=>k.map(p=>p.id===E?{...p,data:{...p.data,pendingButtonAction:void 0}}:p))}};g()},D=()=>{try{const o=localStorage.getItem("midjourneyButtonConfig");if(o)return JSON.parse(o)}catch{}return{}},_=o=>{const a=D();if(Object.keys(a).length===0)return!0;const c=o.label.replace(/\s+/g,"_");return a.hasOwnProperty(c)?a[c]===!0:!0},x=o=>{if(!o)return"";let a=o.trim();return/^upscale_\d+\s/i.test(a)&&(a=a.replace(/^upscale_\d+\s+/i,"")),a},m=(((n=s.midjourneyData)==null?void 0:n.buttons)||[]).map(o=>String(o.label||"").toLowerCase()),I=m.some(o=>/^[uv][1-4]$/i.test(o)),te=m.some(o=>o.includes("redo")),M=!I&&!te&&m.some(o=>o.includes("upscale")),C=o=>{const a=String(o.label||""),c=a.toLowerCase(),w=String(o.customId||"").toLowerCase(),S=/ğŸ‘|â¤ï¸|â¤/.test(a);return c.includes("animate")||c.includes("web")||w.includes("web")||c.includes("browser")||c.includes("open in web")||c.includes("open web")||c.includes("like")||w.includes("like")||S?!1:I?/^U[1-4]$/i.test(a):M?c.includes("upscale"):!1};t.useEffect(()=>{ve&&(O(),r())},[ve]);const O=async()=>{try{const o=me==="ALL"?void 0:{category:me},c=(await Me.assetLibraries.getAll(o)).data||[];if(Z(c),c.length>0){const w=c.find(S=>S.id===he);Oe(w?w.id:c[0].id)}else Oe("")}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},r=()=>{const o=window.__workflowContext;if(!o||!o.project||!o.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const a=Ws(E,o.nodeGroups);if(!a&&o.nodeGroups.length>0){const w=o.nodeGroups[0],S=Ts({project:o.project,episode:o.episode,nodeGroup:w,assetType:"image"});S?(fe(S),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${S}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const c=Ts({project:o.project,episode:o.episode,nodeGroup:a,assetType:"image"});c?(fe(c),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${c}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},y=async()=>{var o,a;if(!he){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!se.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{Ce(!0),await Me.assetLibraries.addFromUrl(he,s.imageUrl,se.trim());const c=window.__workflowContext;if(c&&c.project&&c.nodeGroups){const w=Ws(E,c.nodeGroups)||c.nodeGroups[0];w&&Ts({project:c.project,episode:c.episode,nodeGroup:w,nodeId:E,assetType:"image",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ee(!1),fe("");try{u(w=>w.map(S=>S.id===E?{...S,data:{...S.data,addedToLibrary:!0}}:S))}catch{}try{const w=new CustomEvent("asset-library-updated",{detail:{libraryId:he}});window.dispatchEvent(w)}catch{}}catch(c){h.error(((a=(o=c.response)==null?void 0:o.data)==null?void 0:a.message)||"æ·»åŠ å¤±è´¥")}finally{Ce(!1)}},l=async()=>{var o;try{const a=s.imageUrl;let c=`image-${Date.now()}.jpg`;const w=window.__workflowContext;if(w&&w.project&&w.nodeGroups){const f=Ws(E,w.nodeGroups)||w.nodeGroups[0];if(f){const d=Ts({project:w.project,episode:w.episode,nodeGroup:f,nodeId:E,assetType:"image",preview:!0});if(d&&(c=d,!c.includes("."))){const B=((o=a.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:o[0])||".jpg";c+=B}}}h.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const S=`/assets/proxy-download-with-name?url=${encodeURIComponent(a)}&filename=${encodeURIComponent(c)}`,L=await Me.get(S,{responseType:"blob"}),q=L instanceof Blob?L:L==null?void 0:L.data;if(!q||!(q instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const Q=window.URL.createObjectURL(q),g=document.createElement("a");g.href=Q,g.download=c,document.body.appendChild(g),g.click(),document.body.removeChild(g),setTimeout(()=>{window.URL.revokeObjectURL(Q)},100),h.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${c}`)}catch(a){h.error(`æ“ä½œå¤±è´¥: ${a instanceof Error?a.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const a=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(c=>_(c)&&C(c)):[]).length>0;return e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Y,borderRadius:a?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{ee(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:l,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const o=(s.midjourneyData.buttons||[]).filter(a=>_(a)&&C(a));return o.length===0?null:e.jsxs("div",{className:"nodrag bg-white/80 dark:bg-black/60 backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Y},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:o.map((a,c)=>{var g;const w=x(a.label),S=((g=s.clickedButtons)==null?void 0:g.includes(a.label))||!1,L=De===a.customId,q=s._canEdit===!1,Q=De!==null&&De!==a.customId||S||q;return e.jsx("button",{onClick:async()=>{var f,d,B,P,F,X;if(!((f=s.midjourneyData)!=null&&f.taskId)){h.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(S){h.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}we(a.customId);try{h.info(`æ­£åœ¨æ‰§è¡Œ ${a.label}...`);const ue=await Me.midjourney.action({taskId:s.midjourneyData.taskId,customId:a.customId,messageId:s.midjourneyData.messageId,nodeId:E,mode:s.midjourneyData.mode||"relax"});if(!ue.success){h.error(ue.description||"æ“ä½œå¤±è´¥"),we(null);return}const de=ue.taskId;if(ue.creditsCharged&&ue.creditsCharged>0&&U(),!de){h.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),we(null);return}u(ie=>ie.map(k=>k.id===E?{...k,data:{...k.data,pendingButtonAction:{buttonLabel:a.label,buttonCustomId:a.customId,newTaskId:de,sourceNodeId:E},clickedButtons:[...k.data.clickedButtons||[],a.label]}}:k)),h.info(`${w} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),$(de,w)}catch(ue){if(((d=ue.response)==null?void 0:d.status)===429)h.warning(((P=(B=ue.response)==null?void 0:B.data)==null?void 0:P.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const de=((X=(F=ue.response)==null?void 0:F.data)==null?void 0:X.error)||ue.message;h.error(de)}we(null)}},disabled:Q,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${S?"bg-slate-400 dark:bg-slate-600 cursor-not-allowed opacity-50 text-white border-transparent":L?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 cursor-wait text-white border-transparent shadow-md":De!==null?"bg-slate-300 dark:bg-slate-700 cursor-not-allowed opacity-50 text-white border-transparent":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:S?`${w} (å·²ç‚¹å‡»)`:w,children:e.jsxs("span",{className:"flex items-center gap-1",children:[L&&e.jsx(Qs,{className:"w-3 h-3 animate-spin"}),a.emoji&&!/^upscale_\d+$/i.test(a.emoji)&&e.jsx("span",{children:a.emoji}),w,S&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},c)})})]})})(),ve&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ee(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:se,onChange:o=>fe(o.target.value),onMouseDown:o=>o.stopPropagation(),onTouchStart:o=>o.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const o=me==="ALL"?ce:ce.filter(a=>(a.category||"OTHER")===me);return o.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:me==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:he,onChange:a=>Oe(a.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:o.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a._count.assets," ä¸ªèµ„äº§)"]},a.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(o=>e.jsx("button",{type:"button",onClick:()=>{ae(o);const a=ce.filter(c=>(c.category||"OTHER")===o);Oe(a.length>0?a[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${me===o?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:o==="ROLE"?"person":o==="SCENE"?"landscape":o==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:o==="ROLE"?"è§’è‰²åº“":o==="SCENE"?"åœºæ™¯åº“":o==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},o))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ee(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:y,disabled:le||ce.length===0||!se.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:le?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},uo=t.memo(co),po=({data:s,id:E})=>{var te;const u="https://api.waule.com",[K,Ie]=t.useState(!1),[U,ve]=t.useState([]),[ee,ce]=t.useState(""),[Z,he]=t.useState("ALL"),[Oe,me]=t.useState(""),[ae,se]=t.useState(!1),{setNodes:fe}=ts(),[le]=t.useState(s.width||400),[Ce,Y]=t.useState(null),[De,we]=t.useState(!1),oe=t.useRef(null),T=Pr(),$=!!((te=s==null?void 0:s.workflowContext)!=null&&te.episode)||T.pathname.includes("/episodes/");t.useEffect(()=>{K&&(_(),setTimeout(()=>{x()},100))},[K]),t.useEffect(()=>{const M=oe.current;if(!M)return;const C=()=>{const l=M.videoWidth||0,n=M.videoHeight||0;if(l>0&&n>0){const o=l/n;Y(Math.round(le/o))}},O=()=>we(!0),r=()=>we(!1),y=()=>we(!1);return M.addEventListener("loadedmetadata",C),M.addEventListener("play",O),M.addEventListener("pause",r),M.addEventListener("ended",y),()=>{M.removeEventListener("loadedmetadata",C),M.removeEventListener("play",O),M.removeEventListener("pause",r),M.removeEventListener("ended",y)}},[le,s.videoUrl]);const D=M=>{M.stopPropagation();const C=oe.current;C&&(C.paused?C.play():C.pause())};t.useEffect(()=>{try{const M=localStorage.getItem("suppressedPreviewTasks")||"[]",C=JSON.parse(M),O=s==null?void 0:s.pendingButtonAction;if(O&&C.some(y=>y.taskId&&y.taskId===O.newTaskId||y.sourceNodeId&&y.sourceNodeId===O.sourceNodeId)){Ie(!1);return}}catch{}},[]);const _=async()=>{try{const M=await Me.assetLibraries.getAll();ve(M.data),M.data.length>0&&ce(M.data[0].id)}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},x=()=>{const M=window.__workflowContext;if(!M||!M.project||!M.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const C=Ws(E,M.nodeGroups);if(!C&&M.nodeGroups.length>0){const r=M.nodeGroups[0],y=Ts({project:M.project,episode:M.episode,nodeGroup:r,assetType:"video"});y?(me(y),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${y}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const O=Ts({project:M.project,episode:M.episode,nodeGroup:C,assetType:"video"});O?(me(O),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${O}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},m=async()=>{var M,C;if(!ee){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Oe.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{se(!0),await Me.assetLibraries.addFromUrl(ee,s.videoUrl,Oe.trim());const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const r=Ws(E,O.nodeGroups)||O.nodeGroups[0];r&&Ts({project:O.project,episode:O.episode,nodeGroup:r,nodeId:E,assetType:"video",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),Ie(!1),me("");try{fe(r=>r.map(y=>y.id===E?{...y,data:{...y.data,addedToLibrary:!0}}:y))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:ee}});window.dispatchEvent(r)}catch{}}catch(O){h.error(((C=(M=O.response)==null?void 0:M.data)==null?void 0:C.message)||"æ·»åŠ å¤±è´¥")}finally{se(!1)}},I=async()=>{var M;try{const C=s.videoUrl;let O=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const c=Ws(E,r.nodeGroups)||r.nodeGroups[0];if(c){const w=Ts({project:r.project,episode:r.episode,nodeGroup:c,nodeId:E,assetType:"video",preview:!0});if(w&&(O=w,!O.includes("."))){const S=((M=C.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:M[0])||".mp4";O+=S}}}h.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");const y=`/assets/proxy-download-with-name?url=${encodeURIComponent(C)}&filename=${encodeURIComponent(O)}`,l=await Me.get(y,{responseType:"blob"}),n=l instanceof Blob?l:l==null?void 0:l.data;if(!n||!(n instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const o=window.URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=O,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>{window.URL.revokeObjectURL(o)},100),h.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${O}`)}catch(C){h.error(`æ“ä½œå¤±è´¥: ${C instanceof Error?C.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:le},children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${De?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:D,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:De?"pause":"play_arrow"})})}),e.jsx("video",{ref:oe,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${u}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:Ce?`${Ce}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[$&&e.jsxs("button",{onClick:async()=>{var M,C;try{const O=s.videoUrl,r=s.workflowContext||{},y=r.episode,l=(()=>{try{const F=new URLSearchParams(window.location.search);return{scene:Number(F.get("scene")),shot:Number(F.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),n=r.nodeGroup||Ws(E,r.nodeGroups||[]),o=(n==null?void 0:n.scene)??l.scene,a=(n==null?void 0:n.shot)??l.shot,c=(()=>{try{const F=T.pathname.split("/").filter(Boolean),X=F.indexOf("projects"),ue=F.indexOf("episodes"),de=X>=0?F[X+1]:void 0,ie=ue>=0?F[ue+1]:void 0;return{pid:de,eid:ie}}catch{return{pid:void 0,eid:void 0}}})(),w=((M=r.project)==null?void 0:M.id)||(y==null?void 0:y.projectId)||c.pid,S=(y==null?void 0:y.id)||c.eid;if(!w||!S||!o||!a){h.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const L=await Me.episodes.getById(w,S),q=(L==null?void 0:L.data)??L,Q=(q==null?void 0:q.data)??q,g=Array.isArray((C=Q==null?void 0:Q.scriptJson)==null?void 0:C.acts)?[...Q.scriptJson.acts]:[];let f=g.find(F=>Number(F.actIndex)===Number(o));f||(f={actIndex:Number(o),shots:[]},g.push(f)),f.shots=Array.isArray(f.shots)?[...f.shots]:[];let d=f.shots.find(F=>Number(F.shotIndex)===Number(a));d||(d={shotIndex:Number(a),mediaList:[]},f.shots.push(d));const B=Array.isArray(d.mediaList)?d.mediaList.slice():[];if(B.length>=4){h.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}B.push({type:"video",url:O,nodeId:E}),d.mediaList=B;const P={...Q.scriptJson||{},acts:g};await Me.episodes.update(w,S,{scriptJson:P});try{fe(F=>F.map(X=>X.id===E?{...X,data:{...X.data,addedToStoryboard:!0}}:X))}catch{}h.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(O){h.error((O==null?void 0:O.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{Ie(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:I,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),K&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>Ie(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Oe,onChange:M=>me(M.target.value),onMouseDown:M=>M.stopPropagation(),onTouchStart:M=>M.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const M=Z==="ALL"?U:U.filter(C=>(C.category||"OTHER")===Z);return M.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Z==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:ee,onChange:C=>ce(C.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:M.map(C=>e.jsxs("option",{value:C.id,children:[C.name," (",C._count.assets," ä¸ªèµ„äº§)"]},C.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(M=>e.jsx("button",{type:"button",onClick:()=>{he(M);const C=U.filter(O=>(O.category||"OTHER")===M);ce(C.length>0?C[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Z===M?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:M==="ROLE"?"person":M==="SCENE"?"landscape":M==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:M==="ROLE"?"è§’è‰²åº“":M==="SCENE"?"åœºæ™¯åº“":M==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},M))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Ie(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:m,disabled:ae||U.length===0||!Oe.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:ae?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`})]})},fo=t.memo(po),go=({data:s,id:E,selected:u})=>{const{getNodes:K,getEdges:Ie,setEdges:U,setNodes:ve,getNode:ee}=ts(),[ce,Z]=t.useState(s.content||""),he=t.useRef(null),Oe=t.useRef(null),me=t.useRef(null),ae=t.useRef(null);t.useEffect(()=>{const D=I=>{I.stopPropagation()},_=Oe.current,x=me.current;_&&_.addEventListener("wheel",D,{passive:!0}),x&&x.addEventListener("wheel",D,{passive:!0});const m=ae.current;return m&&m.addEventListener("wheel",D,{passive:!0}),()=>{_&&_.removeEventListener("wheel",D),x&&x.removeEventListener("wheel",D),m&&m.removeEventListener("wheel",D)}},[]);const se=t.useRef(null),fe=async D=>{var _,x;try{const m=(s==null?void 0:s.workflowContext)||{},I=m.episode,te=m.nodeGroup||Array.isArray(m.nodeGroups)&&m.nodeGroups.find(S=>(S.nodeIds||[]).includes(E))||null;let M=te==null?void 0:te.scene,C=te==null?void 0:te.shot;try{const S=new URLSearchParams(window.location.search),L=Number(S.get("scene")),q=Number(S.get("shot"));Number.isFinite(L)&&L>0&&(M=M??L),Number.isFinite(q)&&q>0&&(C=C??q)}catch{}const O=((_=m.project)==null?void 0:_.id)||(I==null?void 0:I.projectId),r=I==null?void 0:I.id;if(!O||!r||!M||!C)return;const y=await Me.episodes.getById(O,r),l=(y==null?void 0:y.data)??y,n=(l==null?void 0:l.data)??l,o=Array.isArray((x=n==null?void 0:n.scriptJson)==null?void 0:x.acts)?[...n.scriptJson.acts]:[];let a=o.find(S=>Number(S.actIndex)===Number(M));a||(a={actIndex:Number(M),shots:[]},o.push(a)),a.shots=Array.isArray(a.shots)?[...a.shots]:[];let c=a.shots.find(S=>Number(S.shotIndex)===Number(C));c||(c={shotIndex:Number(C)},a.shots.push(c)),Object.keys(D).forEach(S=>{c[S]=D[S]||""});const w={...n.scriptJson||{},acts:o};await Me.episodes.update(O,r,{scriptJson:w})}catch(m){h.error((m==null?void 0:m.message)||"ä¿å­˜å¤±è´¥")}},le=()=>{var D,_,x;try{const m=K(),I=Ie(),te=m.find(l=>l.id===E),M=I.filter(l=>l.source===E).map(l=>l.target),C=m.filter(l=>l.type==="agent");let O="";const r=C.find(l=>M.includes(l.id));if(r)O=r.id;else if(te&&C.length>0)O=((_=(D=C.map(n=>{var o,a,c,w;return{a:n,dx:(((o=n.position)==null?void 0:o.x)??0)-(((a=te.position)==null?void 0:a.x)??0),dy:Math.abs((((c=n.position)==null?void 0:c.y)??0)-(((w=te.position)==null?void 0:w.y)??0))}}).sort((n,o)=>(n.dx>=0&&o.dx>=0,n.dx-o.dx||n.dy-o.dy))[0])==null?void 0:D.a)==null?void 0:_.id)||C[0].id;else{const l=m.findIndex(n=>n.id===E);O=((x=m[l+1])==null?void 0:x.id)||""}if(!O)return;U(l=>l.some(o=>o.source===E&&o.target===O)?l:[...l,{id:`e-${Date.now()}`,source:E,target:O}]);const y=ce||String((s==null?void 0:s.content)||"");ve(l=>l.map(n=>{if(n.id!==O)return n;const o=n.data||{};return n.type==="agent"?{...n,data:{...o,config:{...o.config||{},prompt:y}}}:n.type==="midjourney"?{...n,data:{...o,prompt:y}}:n.type==="aiImage"?{...n,data:{...o,config:{...o.config||{},prompt:y}}}:n.type==="textPreview"?{...n,data:{...o,content:y}}:{...n,data:{...o,config:{...o.config||{},prompt:y}}}}))}catch{}},Ce=(s.title||"")==="åˆ†é•œè®¾è®¡",Y=(s.title||"")==="æç¤ºè¯",De=(()=>{if(!Ce)return[];const D=String(s.content||""),_=D.split(/\r?\n/).map(C=>C.trim()),x=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),m=[];let I=null;for(const C of _){if(!C)continue;const O=C.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(O&&x.has(O[1])){I&&m.push(I),I={label:O[1],content:O[2]||""};continue}if(x.has(C)){I&&m.push(I),I={label:C,content:""};continue}I?I.content=I.content?`${I.content}
${C}`:C:I={label:"æ–‡æœ¬",content:C}}if(I&&m.push(I),m.length===0)return[{label:"æ–‡æœ¬",content:D}];const te=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],M=new Map(te.map((C,O)=>[C,O]));return m.filter(C=>C.content&&C.content.trim().length>0).sort((C,O)=>(M.get(C.label)??999)-(M.get(O.label)??999))})(),[we,oe]=t.useState(De),T=t.useRef(null),$=t.useRef([]);return t.useEffect(()=>{oe(De)},[s.content,Ce]),t.useEffect(()=>{requestAnimationFrame(()=>{$.current.forEach(D=>{D&&(D.style.height="auto",D.style.height=`${D.scrollHeight}px`)})})},[we]),t.useEffect(()=>{Y&&Z(s.content||"")},[s.content,Y]),e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:Ce?e.jsx("div",{ref:me,className:"space-y-2 nowheel",children:we.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):we.map((D,_)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:D.label}),e.jsx("textarea",{value:D.content,onChange:x=>{const m=x.target.value;x.target.style.height="auto",x.target.style.height=`${x.target.scrollHeight}px`,oe(I=>{const te=I.map((O,r)=>r===_?{...O,content:m}:O),M=te.map(O=>`${O.label}ï¼š${O.content}`).join(`
`);return ee(E)&&ve(O=>O.map(r=>r.id===E?{...r,data:{...r.data,content:M}}:r)),T.current&&(clearTimeout(T.current),T.current=null),T.current=window.setTimeout(async()=>{const O=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};te.forEach(y=>{O.has(y.label)&&(r[y.label]=y.content)}),await fe(r)},600),te})},onBlur:async x=>{const m=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),I={};I[D.label]=x.currentTarget.value,m.has(D.label)&&await fe(I)},onMouseDown:x=>x.stopPropagation(),onTouchStart:x=>x.stopPropagation(),ref:x=>{$.current[_]=x,x&&(x.style.height="auto",x.style.height=`${x.scrollHeight}px`,x.style.overflow="hidden",x.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors",placeholder:`å¡«å†™${D.label}...`})]},`sec-${_}`))}):Y?e.jsxs("div",{ref:Oe,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:ce,onChange:D=>{const _=D.target.value;Z(_);const x=440;D.target.style.height="auto";const m=Math.min(D.target.scrollHeight,x);D.target.style.height=`${m}px`,D.target.style.overflowY=D.target.scrollHeight>x?"auto":"hidden",ee(E)&&ve(te=>te.map(M=>M.id===E?{...M,data:{...M.data,content:_}}:M)),se.current&&(clearTimeout(se.current),se.current=null),se.current=window.setTimeout(async()=>{await fe({æç¤ºè¯:_})},600)},onBlur:async D=>{const _=D.currentTarget.value;await fe({æç¤ºè¯:_})},onMouseDown:D=>D.stopPropagation(),onTouchStart:D=>D.stopPropagation(),ref:D=>{if(he.current=D,D){D.style.wordBreak="break-word",D.style.height="auto";const x=Math.min(D.scrollHeight,440);D.style.height=`${x}px`,D.style.overflowY=D.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:le,onPointerDown:D=>D.stopPropagation(),onMouseDown:D=>D.stopPropagation(),disabled:!ce.trim(),className:"nodrag relative w-full mt-2 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 disabled:opacity-50 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:ae,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(vt,{type:"target",position:dt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(vt,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ho=t.memo(go),mo=({data:s,selected:E,id:u})=>{const{setNodes:K,setEdges:Ie,getNode:U,getNodes:ve,getEdges:ee,getViewport:ce}=ts(),Z=Fs(),he=Ds(),[Oe]=t.useState(s.isExpanded??!0),[me,ae]=t.useState(s.prompt||""),[se,fe]=t.useState(s.ratio||"16:9"),[le,Ce]=t.useState(s.mode||"relax"),[Y,De]=t.useState(s.chaos??0),[we,oe]=t.useState(s.stylize??100),[T,$]=t.useState(s.weird??0),[D,_]=t.useState(s.quality??1),[x,m]=t.useState(s.styleRaw??!1),[I,te]=t.useState(s.omniWeight??100),[M,C]=t.useState(s.styleWeight??100),[,O]=t.useState(s.taskId||""),[r,y]=t.useState(s.status||"idle"),[l,n]=t.useState(s.progress||""),[o,a]=t.useState(s.omniReferenceImages||[]),[c,w]=t.useState(s.styleReferenceImages||[]),[S,L]=t.useState(!0);t.useEffect(()=>{(async()=>{var b;try{const V=await Me.midjourney.getSettings();L(((b=V.settings)==null?void 0:b.fastEnabled)??!0)}catch{}})()},[]);const{credits:q,isFreeUsage:Q,freeUsageRemaining:g,refetch:f}=Ls({moduleType:"midjourney",operationType:"imagine",mode:le}),d=t.useRef(null),B=t.useRef(!1),P=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==me&&ae(s.prompt)},[s.prompt]);const F=N=>{K(b=>b.map(V=>V.id===u?{...V,data:{...V.data,...N}}:V))};t.useEffect(()=>{const N=s.taskId,b=s.status;(async()=>{var ne,H;if(N&&(b==="processing"||b==="submitting"))try{const Se=(await Me.midjourney.fetchTask(N)).task;if(Se.status==="SUCCESS"){const ye=Se.imageUrl||"",_e=((ne=Se.properties)==null?void 0:ne.messageId)||"",je=((H=Se.properties)==null?void 0:H.messageHash)||"",Te=s.ratio||"16:9";if(y("idle"),n(""),F({status:"idle",progress:"",taskId:""}),ve().find(Be=>{var qe,Ft,at;return Be.type==="imagePreview"&&((qe=Be.data.midjourneyData)==null?void 0:qe.sourceNodeId)===u&&(((Ft=Be.data.midjourneyData)==null?void 0:Ft.taskId)===N||_e&&((at=Be.data.midjourneyData)==null?void 0:at.messageId)===_e)})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}h.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),ie(ye,"4å®«æ ¼",Te,{taskId:N,messageId:_e,messageHash:je,mode:s.mode||"relax",buttons:Se.buttons,action:Se.action})}else Se.status==="IN_PROGRESS"||Se.status==="SUBMITTED"?(y("processing"),setTimeout(()=>{P.current(N)},100)):Se.status==="FAILURE"?(y("error"),n(""),F({status:"error",progress:"",taskId:""}),h.error(Se.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Se.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Se.status==="NOT_FOUND"&&(y("idle"),n(""),F({status:"idle",progress:"",taskId:""}))}catch{y("idle"),n(""),F({status:"idle",progress:"",taskId:""}),h.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const X=t.useCallback(()=>{const N=Z.filter(ye=>ye.target===u),b=[],V=[];let ne="";N.forEach(ye=>{var je,Te,Re,re,Be,qe,Ft,at;const _e=U(ye.source);if(_e){const ot=_e.data,Le=ye.targetHandle||"omni-ref";if(Le==="text-input"){if(_e.type==="agent"){const ut=((je=ot.config)==null?void 0:je.generatedText)||"";ut&&typeof ut=="string"&&(ne=ut)}}else{let ut=ot.imageUrl||"";if(!ut&&((Te=ot.config)!=null&&Te.selectedAsset)){const Et=ot.config.selectedAsset;Et.type==="IMAGE"&&(ut=`https://api.waule.com${Et.url}`.replace(".oss-oss-",".oss-"))}if(!ut&&((Re=ot.config)!=null&&Re.generatedImageUrl)&&(ut=ot.config.generatedImageUrl),_e.type==="assetSelector"){const Et="https://api.waule.com",nt=tt=>{let _t=tt||"";return _t&&(!_t.startsWith("http")&&!_t.startsWith("data:")&&(_t=`${Et}${_t}`),_t=_t.replace(".oss-oss-",".oss-"),_t.replace(/^https?:\/\/localhost(?::\d+)?/i,Et))},yt=(re=ot.config)==null?void 0:re.subjects,Ot=(Be=ot.config)==null?void 0:Be.referenceImages;if(Le==="omni-ref"){let tt="";yt&&yt.length>0&&yt[0].images&&yt[0].images.length>0?tt=nt(yt[0].images[0]):Ot&&Ot.length>0?tt=nt(Ot[0].url):(qe=ot.config)!=null&&qe.selectedAsset&&ot.config.selectedAsset.type==="IMAGE"&&(tt=nt(ot.config.selectedAsset.url)),tt&&!b.includes(tt)&&b.length<1&&b.push(tt)}else if(Le==="style-ref"){let tt="";yt&&yt.length>0&&yt[0].images&&yt[0].images.length>0?tt=nt(yt[0].images[0]):Ot&&Ot.length>0?tt=nt(Ot[0].url):(Ft=ot.config)!=null&&Ft.selectedAsset&&ot.config.selectedAsset.type==="IMAGE"&&(tt=nt(ot.config.selectedAsset.url)),tt&&!V.includes(tt)&&V.length<1&&V.push(tt)}}if(_e.type==="upload"){const Et="https://api.waule.com",nt=tt=>{let _t=tt||"";return _t&&(!_t.startsWith("http")&&!_t.startsWith("data:")&&(_t=`${Et}${_t}`),_t=_t.replace(".oss-oss-",".oss-"),_t.replace(/^https?:\/\/localhost(?::\d+)?/i,Et))},Ot=(((at=ot.config)==null?void 0:at.uploadedFiles)||[]).find(tt=>tt.type==="IMAGE"||(tt.mimeType||"").startsWith("image/"));if(Ot){const tt=nt(Ot.url);Le==="omni-ref"?tt&&!b.includes(tt)&&b.length<1&&b.push(tt):Le==="style-ref"&&tt&&!V.includes(tt)&&V.length<1&&V.push(tt)}}ut&&(Le==="omni-ref"&&!b.includes(ut)?b.push(ut):Le==="style-ref"&&!V.includes(ut)&&V.push(ut))}}}),ne&&ne!==me&&!B.current&&(ae(ne),F({prompt:ne}));const H=ye=>{if(!ye||typeof ye!="string")return!1;const _e=ye.trim();return _e?!!(_e.startsWith("data:image/")||/^https?:\/\//.test(_e)||_e.startsWith("/")):!1},ge=b.filter(H).slice(0,1),Se=V.filter(H).slice(0,1);JSON.stringify(ge)!==JSON.stringify(o)&&(a(ge),F({omniReferenceImages:ge})),JSON.stringify(Se)!==JSON.stringify(c)&&(w(Se),F({styleReferenceImages:Se}))},[Z,u,U,he,me,B.current]);t.useEffect(()=>{X()},[X]),t.useEffect(()=>{const N=d.current;N&&Oe&&requestAnimationFrame(()=>{N.style.height="auto";const b=Math.max(60,Math.min(N.scrollHeight,600));N.style.height=`${b}px`})},[me,Oe]);const ue=N=>{try{const b=new URL(N),V=new URLSearchParams(b.search);return V.has("width")||V.has("height")?(V.delete("width"),V.delete("height"),b.search=V.toString(),b.toString()):N}catch{return N}},de=N=>{const[V,ne]=N.split(":").map(Number);if(!V||!ne)return{width:512,height:512};const H=V/ne;return H>=1?{width:512,height:Math.round(512/H)}:{width:Math.round(512*H),height:512}},ie=t.useCallback((N,b,V,ne)=>{const H=U(u);if(!H)return;const ge=b.startsWith("U")?ue(N):N,Se=ve(),ye=ee();if(Se.filter(tt=>tt.type==="imagePreview"&&ye.some(_t=>_t.source===u&&_t.target===tt.id)).find(tt=>tt.data.imageUrl===ge))return;const Te=400,Re=200,re=100,Be=tt=>{const _t=ce().zoom||1,Kt=document.querySelector(`.react-flow__node[data-id="${tt.id}"]`),bs=(Kt==null?void 0:Kt.getBoundingClientRect().width)||tt.data&&tt.data.width||400,cs=(Kt==null?void 0:Kt.getBoundingClientRect().height)||tt.data&&tt.data.height||300,Rs=Math.round(bs/_t),ws=Math.round(cs/_t);return{w:Rs,h:ws}},qe=(tt,_t=300)=>{if(!tt||!/^[0-9]+\s*:\s*[0-9]+$/.test(tt))return _t;const[Kt,bs]=tt.split(":").map(cs=>parseFloat(cs));return!Kt||!bs?_t:Math.round(Te*(bs/Kt))},Ft=Be(H),at=qe(V,300),ot=H.position.x+Ft.w+Re,Le=H.position.y,ut=ve().filter(tt=>{var _t,Kt;return tt.type==="imagePreview"&&((Kt=(_t=tt.data)==null?void 0:_t.midjourneyData)==null?void 0:Kt.sourceNodeId)===u}).length,Et=ot,nt=Le+ut*(at+re),yt=`preview-${Date.now()}`,Ot={id:yt,type:"imagePreview",position:{x:Et,y:nt},data:{imageUrl:ge,width:Te,ratio:V,workflowContext:H.data.workflowContext,createdBy:H.data.createdBy,midjourneyData:ne?{taskId:ne.taskId,messageId:ne.messageId,messageHash:ne.messageHash,sourceNodeId:u,mode:ne.mode,buttons:ne.buttons,action:ne.action}:void 0}};K(tt=>[...tt,Ot]),Ie(tt=>[...tt,{id:`${u}-${yt}`,source:u,target:yt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),h.success(`âœ¨ å·²åˆ›å»º${b}é¢„è§ˆèŠ‚ç‚¹`)},[u,U,ve,ee,K,Ie,ue,de]),k=t.useCallback(async()=>{var N,b,V,ne,H,ge,Se,ye,_e,je,Te,Re;if(!me.trim()){h.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}y("submitting"),n(""),F({status:"submitting",progress:""});try{const re=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Be=me.toLowerCase(),qe=re.find(nt=>Be.includes(nt));if(qe){h.error(`æ£€æµ‹åˆ°å‚æ•° "${qe}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),y("idle"),F({status:"idle",progress:"",taskId:""});return}y("submitting");let Ft=me;try{h.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const nt=await Me.translation.smartTranslate({text:me});nt.success&&(Ft=nt.translatedText,nt.needsTranslation&&h.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{h.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}h.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let at=Ft.trim();if(se&&se!=="1:1"&&!at.includes("--ar")&&(at+=` --ar ${se}`),!at.includes("--v")&&!at.includes("--version")&&(at+=" --v 7.0"),le==="fast"&&!at.includes("--fast")?at+=" --fast":le==="relax"&&!at.includes("--relax")&&(at+=" --relax"),Y>0&&(at+=` --chaos ${Y}`),we!==100&&(at+=` --stylize ${we}`),T>0&&(at+=` --weird ${T}`),D!==1&&(at+=` --quality ${D}`),x&&(at+=" --style raw"),o.length>0){h.info(`æ­£åœ¨ä¸Šä¼  ${o.length} å¼ å‚è€ƒå›¾...`);const nt=[];for(let yt=0;yt<o.length;yt++){const Ot=o[yt];try{const tt=await Me.midjourney.uploadReferenceImage({imageUrl:Ot});if(tt.success&&tt.discordUrl)nt.push(tt.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{h.error(`å‚è€ƒå›¾ ${yt+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),y("idle");return}}at+=` --oref ${nt.join(" ")}`,I!==100&&(at+=` --ow ${I}`),h.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(c.length>0){h.info(`æ­£åœ¨ä¸Šä¼  ${c.length} å¼ é£æ ¼å›¾...`);const nt=[];for(let yt=0;yt<c.length;yt++){const Ot=c[yt];try{const tt=await Me.midjourney.uploadReferenceImage({imageUrl:Ot});if(tt.success&&tt.discordUrl)nt.push(tt.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{h.error(`é£æ ¼å›¾ ${yt+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),y("idle");return}}at+=` --sref ${nt.join(" ")}`,M!==100&&(at+=` --sw ${M}`),h.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const ot=await Me.midjourney.imagine({prompt:at,nodeId:u,mode:le});if(!ot.success)throw new Error(ot.description||"ä»»åŠ¡æäº¤å¤±è´¥");const Le=ot.taskId;O(Le),y("processing"),F({taskId:Le,status:"processing",progress:"",prompt:me,ratio:se,mode:le,chaos:Y,stylize:we,weird:T,quality:D,styleRaw:x,omniWeight:I,styleWeight:M});const ut=ot.isFreeUsage,Et=ot.creditsCharged||0;if(ut)h.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${g} æ¬¡æœºä¼š`),f();else if(Et>0){const{useAuthStore:nt}=await gs(async()=>{const{useAuthStore:Ot}=await import("./index-DOiS8MNr.js").then(tt=>tt.f);return{useAuthStore:Ot}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:yt}=nt.getState();await yt(),h.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${Et} ç§¯åˆ†`),f()}else h.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");P.current(Le)}catch(re){if(y("error"),n(""),F({status:"error",progress:"",taskId:""}),((N=re.response)==null?void 0:N.status)===403){const Ft=((V=(b=re.response)==null?void 0:b.data)==null?void 0:V.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";h.error(Ft);return}if(((ne=re.response)==null?void 0:ne.status)===429){h.warning(((ge=(H=re.response)==null?void 0:H.data)==null?void 0:ge.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Be=((ye=(Se=re.response)==null?void 0:Se.data)==null?void 0:ye.description)||((je=(_e=re.response)==null?void 0:_e.data)==null?void 0:je.error)||re.message,qe=(Re=(Te=re.response)==null?void 0:Te.data)==null?void 0:Re.bannedWord;qe?h.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${qe}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):h.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Be}ï¼Œè¯·ç¨åé‡è¯•`)}},[me,se,le,Y,we,T,D,x,o,I,c,M,F,Q,g,f]),p=t.useCallback(async N=>{let b=0;const V=150,ne=2e3,H=async()=>{var ge,Se,ye,_e;try{const Te=(await Me.midjourney.fetchTask(N)).task;if(Te.status==="SUCCESS"){const re=Te.imageUrl||"",Be=((ge=Te.properties)==null?void 0:ge.messageId)||"",qe=((Se=Te.properties)==null?void 0:Se.messageHash)||"";if(y("idle"),n(""),F({status:"idle",taskId:"",progress:""}),ve().find(ot=>{var Le,ut,Et;return ot.type==="imagePreview"&&((Le=ot.data.midjourneyData)==null?void 0:Le.sourceNodeId)===u&&(((ut=ot.data.midjourneyData)==null?void 0:ut.taskId)===N||Be&&((Et=ot.data.midjourneyData)==null?void 0:Et.messageId)===Be)})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}h.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),ie(re,"4å®«æ ¼",se,{taskId:N,messageId:Be,messageHash:qe,mode:le,buttons:Te.buttons,action:Te.action});return}const Re=Te.progress||"";if(n(Re),(Te.status==="IN_PROGRESS"||Te.status==="SUBMITTED")&&(y("processing"),F({status:"processing",progress:Re})),Te.status==="FAILURE"){y("error"),n(""),F({status:"error",progress:"",taskId:""}),h.error(Te.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Te.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(Te.status==="NOT_FOUND"){y("error"),n(""),F({status:"error",progress:"",taskId:""}),h.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}b++,b<V?setTimeout(H,ne):(y("error"),n(""),F({status:"error",progress:"",taskId:""}),h.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(je){if((je.code==="ECONNABORTED"||je.code==="ERR_NETWORK"||((ye=je.message)==null?void 0:ye.includes("aborted"))||((_e=je.message)==null?void 0:_e.includes("Network Error")))&&b<V-1){b++,setTimeout(H,ne*2);return}y("error"),n(""),F({status:"error",progress:"",taskId:""}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};H()},[u,se,ie,F,ve]);return P.current=p,e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Oe&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:d,value:me,onChange:N=>{B.current=!0,ae(N.target.value)},onPointerDown:N=>N.stopPropagation(),onMouseDown:N=>N.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:N=>N.stopPropagation(),onMouseDown:N=>N.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>Ce("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${le==="relax"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!S){h.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}Ce("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${S?le==="fast"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50":"bg-slate-200 dark:bg-white/10 text-slate-400 dark:text-white/30 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:opacity-50 disabled:cursor-not-allowed`,title:S?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!S&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(rs,{value:se,onChange:N=>fe(N),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Y})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:Y,onChange:N=>De(Number(N.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${Y/2}%, #06b6d4 ${Y}%, var(--range-bg-color) ${Y}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:we})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:we,onChange:N=>oe(Number(N.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${we/1e3*50}%, #06b6d4 ${we/1e3*100}%, var(--range-bg-color) ${we/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:T})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:T,onChange:N=>$(Number(N.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${T/3e3*50}%, #06b6d4 ${T/3e3*100}%, var(--range-bg-color) ${T/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:D})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:D===.25?0:D===.5?1:D===1?2:3,onChange:N=>{const b=Number(N.target.value);_(b===0?.25:b===1?.5:b===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${(D===.25?0:D===.5?1:D===1?2:3)/3*50}%, #06b6d4 ${(D===.25?0:D===.5?1:D===1?2:3)/3*100}%, var(--range-bg-color) ${(D===.25?0:D===.5?1:D===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>m(!x),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed ${x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-purple-500 dark:border-purple-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${x?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600"}`})})]})})]}),o.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Tr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",o.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:o.map((N,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:N,alt:`Reference ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:I})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:I,onChange:N=>te(Number(N.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${I/1e3*50}%, #06b6d4 ${I/1e3*100}%, var(--range-bg-color) ${I/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),c.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Tr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",c.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:c.map((N,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:N,alt:`Style ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:M})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:M,onChange:N=>C(Number(N.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${M/1e3*50}%, #06b6d4 ${M/1e3*100}%, var(--range-bg-color) ${M/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:k,onPointerDown:N=>N.stopPropagation(),onMouseDown:N=>N.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 relative overflow-hidden bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:opacity-50 disabled:cursor-wait",children:[r==="processing"&&l&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400/30 to-accent-400/30 transition-all duration-300",style:{width:l}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!l||l===""||l==="0%"?le==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${l}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),Q?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",g,"æ¬¡"]}):q!==null&&q>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-blue-500/30 text-blue-200 rounded text-[9px]",children:[q,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(Xs,{type:"target",position:dt.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:N=>{const b=U(N.source||"");return!!b&&b.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(Xs,{type:"target",position:dt.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:N=>!Z.some(V=>V.target===u&&V.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(Xs,{type:"target",position:dt.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:N=>!Z.some(V=>V.target===u&&V.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(Xs,{type:"source",position:dt.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},gr="https://api.waule.com",xo=({data:s,selected:E,id:u})=>{var qs,rr,Ss,Ns,ms,Es,Ys;const[K,Ie]=t.useState(!0),[,U]=t.useState(0),[ve,ee]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[ve]);const{setNodes:ce,setEdges:Z,getNode:he,getNodes:Oe,getEdges:me}=ts(),ae=Fs(),se=Ds(),fe=t.useRef(""),le=(qs=s.config)==null?void 0:qs.selectedEditingCapability,Ce=t.useMemo(()=>(s.models||[]).filter(z=>{var Pe;return z.type==="VIDEO_GENERATION"&&((Pe=z.provider)==null?void 0:Pe.toLowerCase())==="sora"}),[s.models]),[Y,De]=t.useState(s.config.prompt||""),we=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Y&&De(s.config.prompt)},[s.config.prompt]);const[oe,T]=t.useState(s.config.modelId||((rr=Ce[0])==null?void 0:rr.id)||""),[$,D]=t.useState(s.config.ratio||"16:9"),[_,x]=t.useState(s.config.resolution||"1080P"),m=t.useCallback(G=>{const z=(G||"").toLowerCase();return z?z.includes("æ–‡ç”Ÿ")||z.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":z.includes("é¦–å°¾")?"é¦–å°¾å¸§":z.includes("é¦–å¸§")||z.includes("first frame")||z.includes("start frame")||z.includes("initial frame")||z.includes("keyframe")?"é¦–å¸§":z.includes("å°¾å¸§")||z.includes("last frame")||z.includes("end frame")||z.includes("final frame")?"å°¾å¸§":z.includes("ä¸»ä½“å‚è€ƒ")||z.includes("å‚è€ƒ")||z.includes("reference image")||z.includes("image reference")||z.includes("ref image")?"å‚è€ƒå›¾":z.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":z.includes("first-last")||z.includes("two-frame")||z.includes("frame pair")?"é¦–å°¾å¸§":z.includes("first")?"é¦–å¸§":z.includes("last")?"å°¾å¸§":z.includes("subject")||z.includes("reference")?"å‚è€ƒå›¾":G||"":""},[]),[I,te]=t.useState((s.config.lockedGenerationType?m(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[M,C]=t.useState(s.config.duration||10),[O,r]=t.useState(s.config.isGenerating||!1),[y,l]=t.useState([]),[n,o]=t.useState(null),[a,c]=t.useState(!1),[w]=t.useState(""),[S]=t.useState("confirm"),[L]=t.useState(null),[q,Q]=t.useState(!1),[g,f]=t.useState([]),[d,B]=t.useState(""),[P,F]=t.useState(0),[X,ue]=t.useState(0),de=t.useRef(!1),[ie,k]=t.useState(!1),p=Ce.find(G=>G.id===oe)||Ce[0],{credits:N,loading:b,isFreeUsage:V,freeUsageRemaining:ne,refetch:H}=Ls({aiModelId:p==null?void 0:p.id,duration:M,resolution:_});t.useEffect(()=>{var G,z;if(!Ce.find(Pe=>Pe.id===oe)){const Pe=((G=Ce[0])==null?void 0:G.id)||"";T(Pe),qe({modelId:Pe,modelName:(z=Ce[0])==null?void 0:z.name})}},[Ce]);const ge=((Ss=p==null?void 0:p.provider)==null?void 0:Ss.toLowerCase())==="sora",Se=t.useMemo(()=>{var z;if((z=p==null?void 0:p.config.supportedDurations)!=null&&z.length)return p.config.supportedDurations;const G=((p==null?void 0:p.provider)||"").toLowerCase();return G==="sora"?[10,15]:G==="minimaxi"?[6,10]:[M||10]},[p,M]),ye=t.useMemo(()=>{var z;return(z=p==null?void 0:p.config.supportedResolutions)!=null&&z.length?p.config.supportedResolutions:((p==null?void 0:p.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[p]),_e=t.useMemo(()=>Math.min(...Se),[Se]),je=t.useMemo(()=>Math.max(...Se),[Se]),Te=t.useMemo(()=>Math.max(1,je-_e),[je,_e]),Re=t.useMemo(()=>{const G=(M-_e)/Te*100;return Number.isNaN(G)?0:Math.min(100,Math.max(0,G))},[M,_e,Te]),re=!p||!((Ns=p.config.supportedDurations)!=null&&Ns.length),Be=!p||!((ms=p.config.supportedResolutions)!=null&&ms.length),qe=t.useCallback(G=>{he(u)&&ce(Pe=>Pe.map(Ue=>Ue.id===u?{...Ue,data:{...Ue.data,config:{...Ue.data.config,...G}}}:Ue))},[he,u,ce]),Ft=(G,z)=>{const Pe=(j,A)=>A===0?j:Pe(A,j%A),Ue=Pe(G,z),Xe=G/Ue,We=z/Ue,Ye={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},ct=`${Xe}:${We}`;return Ye[ct]||ct},at=()=>{const G=ae.filter(We=>We.target===u),z=[];G.forEach(We=>{var ct;const Ye=he(We.source);if(Ye&&Ye.type==="upload"&&(((ct=Ye.data.config)==null?void 0:ct.uploadedFiles)||[]).forEach(A=>{const pe=A.type||A.mimeType||"";(pe==="IMAGE"||pe.startsWith("image/"))&&z.push({id:A.id||A.name,url:A.url,name:A.name||A.originalName,width:A.width,height:A.height,aspectRatio:A.width&&A.height?Ft(A.width,A.height):"16:9"})}),Ye&&Ye.type==="assetSelector"){const j=Ye.data.config||{},A=j.subjects,pe=j.selectedAsset,Ae=m(I);A&&A.length>0?Ae==="é¦–å°¾å¸§"||(A[0].images||[]).forEach((xe,Qe)=>{z.push({id:`${Ye.id}-subject-${Qe}`,url:xe,name:A[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):pe&&pe.type==="IMAGE"&&z.push({id:pe.id,url:pe.url,name:pe.name||pe.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(Ye&&Ye.type==="imagePreview"){const j=Ye.data.imageUrl,A=Ye.data.width,pe=Ye.data.height;j&&z.push({id:Ye.id,url:j,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:A,height:pe,aspectRatio:A&&pe?Ft(A,pe):"16:9"})}});const Pe=new Set,Ue=[];z.forEach(We=>{const Ye=We.url;Pe.has(Ye)||(Pe.add(Ye),Ue.push(We))});const Xe=m(I);return Xe==="æ–‡ç”Ÿè§†é¢‘"?ge?Ue:[]:Xe==="é¦–å¸§"||Xe==="å°¾å¸§"?Ue.slice(0,1):Xe==="é¦–å°¾å¸§"?Ue.slice(0,2):Xe==="å‚è€ƒå›¾"?Ue.slice(0,7):Ue},ot=t.useMemo(()=>at(),[ae,se,I,u,ge]);t.useEffect(()=>{const G=s.config.taskId;(async()=>{let Pe=!1;if(s.config.isGenerating||!G)try{const Ue=await Me.tasks.getActiveTask(u);if(Ue.task){const Xe=Ue.task;ee(Xe.id),r(!0),U(Xe.progress||0),Ps(Xe.id);return}else s.config.isGenerating&&(r(!1),qe({isGenerating:!1}))}catch{}if(G){const Ue=Oe(),Xe=me(),We=Ue.find(Ye=>Ye.type==="videoPreview"&&Xe.some(ct=>ct.source===u&&ct.target===Ye.id));if(We&&We.data.videoUrl){Pe=!0,G&&(qe({taskId:""}),ee(""));return}try{const ct=(await Me.tasks.getTaskStatus(G)).task;if(ct.status==="SUCCESS"){const j=ct.resultUrl;U(100),setTimeout(()=>U(0),1e3);try{const A=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(A).some(Ne=>Ne.taskId&&Ne.taskId===G||Ne.sourceNodeId&&Ne.sourceNodeId===u)||hs(j,s.config.ratio||"16:9")}catch{hs(j,s.config.ratio||"16:9")}Pe=!0,qe({taskId:""}),ee(""),h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")}else if(ct.status==="PROCESSING"||ct.status==="PENDING"){r(!0),U(ct.progress||0),Ps(G);return}else ct.status==="FAILURE"&&(U(0),qe({taskId:""}),h.error(ct.errorMessage?`è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${ct.errorMessage}`:"è§†é¢‘ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{U(0),qe({taskId:""})}}if(!Pe)try{const Ue=await Me.tasks.getPendingPreviewNodes(u);if(Ue.tasks&&Ue.tasks.length>0)for(const Xe of Ue.tasks){const{previewNodeData:We}=Xe;if(We&&We.url){const Ye=We.ratio||s.config.ratio||"16:9";let ct=!1;try{const j=localStorage.getItem("suppressedPreviewTasks")||"[]";ct=JSON.parse(j).some(pe=>pe.taskId&&pe.taskId===Xe.id||pe.sourceNodeId&&pe.sourceNodeId===u)}catch{}ct||hs(We.url,Ye),await Me.tasks.markPreviewNodeCreated(Xe.id)}}}catch{}})()},[]),t.useEffect(()=>{const G=ae.filter(Pe=>Pe.target===u);let z="";G.forEach(Pe=>{var Xe;const Ue=he(Pe.source);if(Ue){const We=Ue.data;Ue.type==="agent"&&((Xe=We.config)!=null&&Xe.generatedText)?z||(z=We.config.generatedText):Ue.type==="textPreview"&&We.content&&(z||(z=We.content))}}),z&&z!==Y&&(De(z),qe({prompt:z}))},[ae,u,he,Y,qe]),t.useEffect(()=>{const G=ae.filter(Ue=>Ue.target===u);if(G.length===0)return;let z="",Pe="";G.forEach(Ue=>{var We;const Xe=se.find(Ye=>Ye.id===Ue.source);if(Xe&&Xe.type==="agent"){const Ye=Xe.data;(We=Ye.config)!=null&&We.generatedText&&(z=Ye.config.generatedText,Pe=`${Xe.id}-${Ye.config.generatedText.substring(0,50)}`)}}),z&&Pe!==fe.current&&(fe.current=Pe,De(z),qe({prompt:z}))},[se,ae,u,qe]),t.useEffect(()=>{const G=JSON.stringify(ot),z=JSON.stringify(y);G!==z&&l(ot)},[ot]);const Le=t.useMemo(()=>{if(ge)return!0;const G=y.length,z=m(I);return G===0?!0:G===1?z==="å‚è€ƒå›¾":G===2?z==="é¦–å°¾å¸§"?!1:z==="å‚è€ƒå›¾":G>2?z==="å‚è€ƒå›¾":!1},[y.length,I,m,ge]),ut=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Et=t.useMemo(()=>{const G=m(I);return le?Ce:Ce.filter(z=>{var Ue;const Pe=(((Ue=z.config)==null?void 0:Ue.supportedGenerationTypes)||[]).map(Xe=>m(Xe));return G==="é¦–å¸§"||G==="å°¾å¸§"?Pe.includes("é¦–å¸§")||Pe.includes("å°¾å¸§"):Pe.includes(G)})},[Ce,I,m,le]),nt=t.useMemo(()=>{const G=le?Ce:Et;return G.length>0?G:le?(s.models||[]).filter(Pe=>(Pe.type||"")==="VIDEO_EDITING"):G},[le,Ce,Et,s.models]);t.useEffect(()=>{var z,Pe;if(!nt.find(Ue=>Ue.id===oe)){const Ue=((z=nt[0])==null?void 0:z.id)||"";T(Ue),qe({modelId:Ue||void 0,modelName:Ue?(Pe=nt[0])==null?void 0:Pe.name:void 0})}},[nt]);const yt=t.useCallback(G=>{const z=m(G);return le?["IMAGE","VIDEO"]:z==="æ–‡ç”Ÿè§†é¢‘"?ge?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[m,le,ge]);t.useEffect(()=>{if(!Le&&y.length>0){const G=y[0].aspectRatio;G&&$!==G&&(D(G),setTimeout(()=>{qe({ratio:G})},0))}},[Le,y,$]),t.useEffect(()=>{if(!le&&ut.length>0&&!ut.includes(I)){const G="æ–‡ç”Ÿè§†é¢‘";te(G),setTimeout(()=>{qe({generationType:G,acceptedInputs:yt(G)})},0)}},[ut,I,yt,le]),t.useEffect(()=>{const G=m(I);if(G==="æ–‡ç”Ÿè§†é¢‘")return;const z=ae.filter(We=>We.target===u),Pe=[],Ue=[];z.forEach(We=>{var j,A,pe,Ae,Ne;const Ye=he(We.source);if(!Ye)return;const ct=Ye.type;if((ct||"").startsWith("aiVideo")||ct==="videoPreview"){Ue.push(We.id);return}if(ct==="upload"){const xe=(pe=(A=(j=Ye.data)==null?void 0:j.config)==null?void 0:A.uploadedFiles)==null?void 0:pe[0],Qe=((xe==null?void 0:xe.type)||"").toUpperCase(),Ze=((xe==null?void 0:xe.mimeType)||"").toLowerCase();if(Qe==="VIDEO"||Ze.startsWith("video/")){Ue.push(We.id);return}(Qe==="IMAGE"||Ze.startsWith("image/"))&&Pe.push(We.id);return}if(ct==="assetSelector"){const xe=((Ae=Ye.data)==null?void 0:Ae.config)||{};if(xe.selectedAsset){const Qe=(xe.selectedAsset.type||"").toUpperCase(),Ze=(xe.selectedAsset.mimeType||"").toLowerCase();Qe==="VIDEO"||Ze.startsWith("video/")?Ue.push(We.id):(Qe==="IMAGE"||Ze.startsWith("image/"))&&Pe.push(We.id)}else if(xe.subjects&&xe.subjects.length>0){const Qe=(((Ne=xe.subjects[0])==null?void 0:Ne.images)||[]).length;G==="å‚è€ƒå›¾"||G==="é¦–å°¾å¸§"?Pe.push(We.id):(G==="é¦–å¸§"||G==="å°¾å¸§")&&(Qe>1?Ue.push(We.id):Pe.push(We.id))}return}(ct==="aiImage"||ct==="imagePreview")&&Pe.push(We.id)});let Xe=new Set([...Ue]);G==="é¦–å¸§"||G==="å°¾å¸§"?Pe.slice(1).forEach(We=>Xe.add(We)):G==="é¦–å°¾å¸§"&&Pe.slice(2).forEach(We=>Xe.add(We)),Xe.size>0&&Z(We=>We.filter(Ye=>!Xe.has(Ye.id)))},[I,ae,u,he,Z,m]),t.useEffect(()=>{const G=s.config.generationType;if(!G||m(G)!==m(I)){const z=m(I)||"æ–‡ç”Ÿè§†é¢‘";qe({generationType:z,acceptedInputs:yt(z)})}},[]),t.useEffect(()=>{const G=yt(I);qe({acceptedInputs:G})},[I,yt]);const Ot=G=>{o(G)},tt=G=>{G.preventDefault()},_t=G=>{if(n===null)return;const z=[...y],[Pe]=z.splice(n,1);z.splice(G,0,Pe),l(z),o(null),qe({referenceImages:z})};t.useEffect(()=>{const G=we.current;G&&K&&requestAnimationFrame(()=>{G.style.height="auto";const z=Math.max(60,Math.min(G.scrollHeight,600));G.style.height=`${z}px`})},[Y,K]),t.useEffect(()=>{if(Y===s.config.prompt)return;const G=setTimeout(()=>{qe({prompt:Y})},500);return()=>clearTimeout(G)},[Y]);const Kt=t.useCallback(async G=>{if(!G){f([]);return}try{const z=await Me.soraCharacters.search(G,5);f(z.characters||[]),ue(0)}catch{f([])}},[]),bs=t.useCallback(G=>{const z=G.target.value,Pe=G.target.selectionStart||0;if(De(z),de.current)return;const Xe=z.substring(0,Pe).match(/@([^@\s#]*)$/);if(Xe){const We=Xe[1];B(We),F(Pe-We.length-1),Q(!0),Kt(We)}else Q(!1),f([])},[Kt]),cs=t.useCallback(G=>{const z=Y.substring(0,P),Pe=Y.substring(P+d.length+1),Ue=`@#${G.customName}#`,Xe=z+Ue+Pe;De(Xe),Q(!1),f([]),B(""),setTimeout(()=>{if(we.current){we.current.focus();const We=z.length+Ue.length;we.current.setSelectionRange(We,We)}},0)},[Y,P,d]),Rs=t.useCallback(G=>{!q||g.length===0||(G.key==="ArrowDown"?(G.preventDefault(),ue(z=>z<g.length-1?z+1:z)):G.key==="ArrowUp"?(G.preventDefault(),ue(z=>z>0?z-1:z)):G.key==="Enter"&&g[X]?(G.preventDefault(),cs(g[X])):G.key==="Escape"&&Q(!1))},[q,g,X,cs]),ws=t.useCallback(async G=>{var Xe;const z=/@#([^#]+)#/g,Pe=[...G.matchAll(z)];if(Pe.length===0)return G;let Ue=G;for(const We of Pe){const Ye=We[1];try{const ct=await Me.soraCharacters.getByCustomName(Ye);(Xe=ct.character)!=null&&Xe.characterName&&(Ue=Ue.replace(We[0],` ${ct.character.characterName} `))}catch{}}return Ue},[]),zs=G=>{var Pe,Ue,Xe,We;T(G);const z=Et.find(Ye=>Ye.id===G);if(z){const Ye=(Pe=z.config.supportedRatios)!=null&&Pe.length?z.config.supportedRatios:["16:9"],ct=(Ue=z.config.supportedResolutions)!=null&&Ue.length?z.config.supportedResolutions:["1080P"],j=(Xe=z.config.supportedGenerationTypes)!=null&&Xe.length?z.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],A=(z.provider||"").toLowerCase(),pe=(We=z.config.supportedDurations)!=null&&We.length?z.config.supportedDurations:A==="sora"?[10,15]:A==="minimaxi"?[6,10]:[10],Ae=Ye[0],Ne=ct[0],xe=m(I||j[0]),Qe=pe[0];D(Ae),x(Ne),te(xe),C(Qe),qe({modelId:G,modelName:z.name,ratio:Ae,resolution:Ne,generationType:xe,duration:Qe,acceptedInputs:yt(xe)})}},Nt=t.useMemo(()=>{const G=m(I),z=y.length,Xe=ae.filter(We=>We.target===u).filter(We=>{var j,A,pe,Ae,Ne;const Ye=he(We.source),ct=Ye==null?void 0:Ye.type;if(!Ye)return!1;if(ct==="upload"){const xe=(pe=(A=(j=Ye.data)==null?void 0:j.config)==null?void 0:A.uploadedFiles)==null?void 0:pe[0],Qe=((xe==null?void 0:xe.mimeType)||"").toLowerCase();return((xe==null?void 0:xe.type)||"").toUpperCase()==="VIDEO"||Qe.startsWith("video/")}if(ct==="assetSelector"){const xe=(Ne=(Ae=Ye.data)==null?void 0:Ae.config)==null?void 0:Ne.selectedAsset,Qe=((xe==null?void 0:xe.mimeType)||"").toLowerCase();return((xe==null?void 0:xe.type)||"").toUpperCase()==="VIDEO"||Qe.startsWith("video/")}return!!((ct||"").startsWith("aiVideo")||ct==="videoPreview")}).length;return oe?G==="æ–‡ç”Ÿè§†é¢‘"?ge?!0:!!Y.trim():G==="é¦–å¸§"||G==="å°¾å¸§"?z>=1:G==="é¦–å°¾å¸§"?z>=2:G==="å‚è€ƒå›¾"?z>=1:G==="è§†é¢‘æ¢äºº"?Xe>=1&&z>=1:G==="å¯¹å£å‹"||G==="é£æ ¼è½¬æ¢"?Xe>=1:!1:!1},[I,y.length,Y,O,ae,u,he,m,ge]);t.useEffect(()=>{var z;const G=(z=s==null?void 0:s.config)==null?void 0:z.generatedVideoUrl;G&&hs(G,s.config.ratio||"16:9")},[(Es=s==null?void 0:s.config)==null?void 0:Es.generatedVideoUrl]);const Ps=async G=>{let Pe=0;const Ue=async()=>{try{Pe++;const We=(await Me.tasks.getTaskStatus(G)).task;if(U(We.progress||0),We.status==="SUCCESS"||We.status==="COMPLETED"||We.status==="DONE"){U(100);const Ye=We.resultUrl;r(!1),hs(Ye,s.config.ratio||"16:9");try{await Me.tasks.markPreviewNodeCreated(G)}catch{}qe({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:Ye,taskId:"",isGenerating:!1}),ee(""),h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>U(0),1e3);return}else if(We.status==="FAILURE"){r(!1),U(0),qe({taskId:"",isGenerating:!1}),h.error(We.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(We.status==="PROCESSING"||We.status==="PENDING")&&(Pe<600?setTimeout(Ue,1e3):(r(!1),U(0),qe({taskId:"",isGenerating:!1}),h.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),U(0),qe({taskId:"",isGenerating:!1}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ue()},ys=async()=>{var Pe,Ue,Xe,We,Ye,ct;if(m(I)==="æ–‡ç”Ÿè§†é¢‘"&&!Y.trim()){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const z=at();qe({referenceImages:z}),U(0);try{let j=[],A;const pe=z.length;if(z.length>0)try{for(const Gt of z){let wt=Gt.url;!wt.startsWith("data:")&&!wt.startsWith("http")&&(wt=`${gr}${wt}`),wt=wt.replace(/^https?:\/\/localhost(?::\d+)?/i,gr);const It=await Nr(wt);j.push(It)}}catch{h.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Ae=ae.filter(Gt=>Gt.target===u);if(m(I)==="å‚è€ƒå›¾"){const Gt=new Map;for(const wt of Ae){const It=he(wt.source);if((It==null?void 0:It.type)==="assetSelector"){const Mt=(Pe=It.data.config)==null?void 0:Pe.subjects;if(Mt&&Mt.length>0){for(const Lt of Mt)if(!Gt.has(Lt.name)){const es=(Lt.images||[]).map(ns=>ns.startsWith("http")||ns.startsWith("data:")?ns:`${gr}${ns}`);Gt.set(Lt.name,es)}}}}if(Gt.size>0){const wt=Array.from(Gt.entries());let It=0;const Mt=[];for(const[Lt,es]of wt){if(It>=7)break;const ns=7-It,Cs=es.slice(0,Math.max(0,ns));Cs.length>0&&(Mt.push({name:Lt,images:Cs}),It+=Cs.length)}A=Mt,wt.some(([,Lt])=>Lt.length>0)&&It<wt.reduce((Lt,[,es])=>Lt+es.length,0)&&h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const Ne=A&&A.length>0?A.reduce((Gt,wt)=>{var It;return Gt+(((It=wt.images)==null?void 0:It.length)||0)},0):pe;let xe=I;if(xe==="é¦–å¸§"||xe==="å°¾å¸§"){if(Ne!==1){h.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),U(0);return}}else if(xe==="é¦–å°¾å¸§"){if(Ne===1)xe="é¦–å¸§";else if(Ne!==2){h.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),U(0);return}A&&A.length>0?A=[{...A[0],images:A[0].images.slice(0,2)}]:j=j.slice(0,2)}else if(xe==="å‚è€ƒå›¾"||xe==="ä¸»ä½“å‚è€ƒ"){if(Ne<1){h.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),U(0);return}if(A&&A.length>0){if(A.reduce((wt,It)=>{var Mt;return wt+(((Mt=It.images)==null?void 0:Mt.length)||0)},0)>7){let wt=7;A=A.map(It=>({...It,images:It.images.slice(0,Math.max(0,wt-=It.images.length,It.images.length))})),wt=7,A=A.map(It=>{const Mt=It.images.slice(0,Math.min(It.images.length,wt));return wt-=Mt.length,{...It,images:Mt}}).filter(It=>It.images.length>0),h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else j.length>7&&(j=j.slice(0,7),h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}L==="dropImages"&&(j=[],A=void 0),(m(I)==="é¦–å¸§"||m(I)==="å°¾å¸§")&&L==="useFirstImage"&&j.length>=2&&(j=[j[0]]),m(I)==="é¦–å°¾å¸§"&&L==="useFirstTwoImages"&&j.length>=3&&(j=j.slice(0,2));const Qe={modelId:oe,ratio:$,duration:M,referenceImages:j.length>0&&!A?j:void 0,generationType:xe,sourceNodeId:u,...A?{subjects:A}:{}},Ze=m(xe);let xt=Y.trim();if(xt&&xt.includes("@#")&&(xt=await ws(xt)),!ie&&xt&&(xt="No BGM. "+xt),Ze==="æ–‡ç”Ÿè§†é¢‘"){if(!xt){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),U(0);return}Qe.prompt=xt}else if(Ze==="å‚è€ƒå›¾"){if(!xt){h.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),U(0);return}Qe.prompt=xt}else xt&&(Qe.prompt=xt);const it=await Me.tasks.createVideoTask(Qe),Ge=it.taskId,Rt=it.creditsCharged||0,Bt=it.isFreeUsage,$t=it.freeUsageRemaining??0;if(ee(Ge),qe({prompt:Y,ratio:$,resolution:_,generationType:I,duration:M,modelId:oe,taskId:Ge,isGenerating:!0}),Bt)h.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${$t} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),H();else if(Rt>0){const{useAuthStore:Gt}=await gs(async()=>{const{useAuthStore:It}=await import("./index-DOiS8MNr.js").then(Mt=>Mt.f);return{useAuthStore:It}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:wt}=Gt.getState();await wt(),h.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Rt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),H()}else h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Ps(Ge)}catch(j){if(r(!1),U(0),((Ue=j.response)==null?void 0:Ue.status)===403){const A=((We=(Xe=j.response)==null?void 0:Xe.data)==null?void 0:We.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";h.error(A)}else{const A=((ct=(Ye=j.response)==null?void 0:Ye.data)==null?void 0:ct.error)||j.message||"æœªçŸ¥åŸå› ";h.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${A}ï¼Œè¯·ç¨åé‡è¯•`)}}},Zs=async()=>{const G=m(I),z=at(),Pe=z.length;if((()=>{var We;const Xe=ae.filter(Ye=>Ye.target===u);for(const Ye of Xe){const ct=he(Ye.source);if((ct==null?void 0:ct.type)==="assetSelector"){const j=(We=ct.data.config)==null?void 0:We.subjects;if(j&&j.length>0)return!0}}return!1})()&&(G==="é¦–å¸§"||G==="å°¾å¸§"||G==="é¦–å°¾å¸§")){h.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((G==="é¦–å¸§"||G==="å°¾å¸§")&&Pe===0){h.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(G==="é¦–å°¾å¸§"&&Pe===0){h.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(G==="å‚è€ƒå›¾"&&Pe===0){h.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(G==="æ–‡ç”Ÿè§†é¢‘"&&Pe>0&&!ge&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((G==="é¦–å¸§"||G==="å°¾å¸§")&&Pe>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(G==="é¦–å°¾å¸§"&&Pe>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(G==="æ–‡ç”Ÿè§†é¢‘"&&!Y.trim()){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!oe){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}l(z),qe({referenceImages:z}),r(!0),U(0),await ys()},hs=(G,z)=>{const Pe=he(u);if(!Pe||!G)return null;const Ue=z||$||"16:9",Xe=Oe(),We=me(),Ye=Xe.filter(Mt=>Mt.type==="videoPreview"&&We.some(Lt=>Lt.source===u&&Lt.target===Mt.id)),ct=Ye.find(Mt=>Mt.data.videoUrl===G);if(ct)return ct.id;const j=1,A=400,pe=(Mt,Lt=300)=>{if(!Mt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Mt))return Lt;const[es,ns]=Mt.split(":").map(Cs=>parseFloat(Cs));return!es||!ns?Lt:Math.round(A*(ns/es))},Ae=document.querySelector(`.react-flow__node[data-id="${u}"]`),Ne=Ae==null?void 0:Ae.getBoundingClientRect(),xe=Math.round(((Ne==null?void 0:Ne.width)||400)/j),Qe=100,Ze=200,xt=pe(Ue,300),it=Ye.length,Ge=Pe.position.x+xe+Ze,Rt=Pe.position.y,Bt=Ge,$t=Rt+it*(xt+Qe),Gt=Date.now(),wt={id:`preview-${u}-${Gt}`,type:"videoPreview",position:{x:Bt,y:$t},data:{videoUrl:G,width:A,ratio:Ue,workflowContext:Pe.data.workflowContext,createdBy:Pe.data.createdBy}};ce(Mt=>[...Mt,wt]);const It={id:`edge-${u}-${wt.id}`,source:u,target:wt.id,targetHandle:`${wt.id}-target`,type:"aurora"};return Z(Mt=>Mt.find(es=>es.source===u&&es.target===wt.id)?Mt:[...Mt,It]),wt.id},Js=G=>{const z=G.target;if(z.tagName==="INPUT"||z.tagName==="TEXTAREA"||z.tagName==="SELECT"||z.tagName==="BUTTON"||z.closest("button")||z.closest("input")||z.closest("textarea")||z.closest("select"))return;const Pe=!K;Ie(Pe),ce(Ue=>Ue.map(Xe=>Xe.id===u?{...Xe,data:{...Xe.data,isExpanded:Pe}}:Xe))};return e.jsxs("div",{onDoubleClick:Js,className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var A;const G=((A=he(u))==null?void 0:A.type)||"",z=m(I),Pe=z==="æ–‡ç”Ÿè§†é¢‘"||G==="aiVideo_t2v",Ue=G==="aiVideo_i2v_first"||G==="aiVideo_i2v_last"||z==="é¦–å¸§"||z==="å°¾å¸§",Xe=G==="aiVideo_first_last"||z==="é¦–å°¾å¸§",We=G==="aiVideo_reference"||z==="å‚è€ƒå›¾",Ye=ae.filter(pe=>pe.target===u),ct=Ye.some(pe=>{const Ae=he(pe.source);return(Ae==null?void 0:Ae.type)==="agent"}),j=Ye.reduce((pe,Ae)=>{var Qe,Ze,xt,it;const Ne=he(Ae.source),xe=(Ne==null?void 0:Ne.type)||"";if(xe==="aiImage"||xe==="imagePreview")return pe+1;if(xe==="upload"){const Ge=(xt=(Ze=(Qe=Ne==null?void 0:Ne.data)==null?void 0:Qe.config)==null?void 0:Ze.uploadedFiles)==null?void 0:xt[0],Rt=((Ge==null?void 0:Ge.type)||"").toUpperCase(),Bt=((Ge==null?void 0:Ge.mimeType)||"").toLowerCase();return pe+(Rt==="IMAGE"||Bt.startsWith("image/")?1:0)}if(xe==="assetSelector"){const Ge=((it=Ne==null?void 0:Ne.data)==null?void 0:it.config)||{};if(Ge.selectedAsset)return pe+((Ge.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ge.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Ge.subjects&&Ge.subjects.length>0)return pe+((Ge.subjects[0].images||[]).length||0)}return pe},0);return Pe?ge||!ct:Ue?!(ct&&j>=1):Xe?!(ct&&j>=2):We?!(ct&&j>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:w}),S==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{c(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{c(!1),h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{c(!1),await ys()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:K?e.jsxs("div",{className:"space-y-3",children:[!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(rs,{value:oe,onChange:G=>zs(G),options:Et.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Et.map(G=>({value:G.id,label:G.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-purple-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:we,value:Y,onChange:bs,onKeyDown:Rs,onCompositionStart:()=>{de.current=!0},onCompositionEnd:G=>{de.current=!1,bs(G)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),q&&g.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:g.map((G,z)=>e.jsxs("button",{type:"button",onMouseDown:Pe=>{Pe.preventDefault(),Pe.stopPropagation(),cs(G)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${z===X?"bg-purple-100 dark:bg-purple-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[G.avatarUrl?e.jsx("img",{src:G.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-200 dark:bg-purple-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-purple-600 dark:text-purple-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:G.customName}),e.jsx("div",{className:"text-[10px] text-purple-500 dark:text-purple-400 font-mono truncate",children:G.characterName})]})]},G.id))})]})]}),y.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",I==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:y.map((G,z)=>e.jsxs("div",{draggable:I==="é¦–å°¾å¸§",onDragStart:()=>Ot(z),onDragOver:tt,onDrop:()=>_t(z),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${I==="é¦–å°¾å¸§"?"cursor-move":""} ${n===z?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50`,children:[e.jsx("img",{src:`${G.url.startsWith("http")||G.url.startsWith("data:")?G.url:gr+G.url}`,alt:G.name,className:"w-full h-full object-cover"}),I==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:z===0?"é¦–":z===1?"å°¾":z+1})]},G.id))})]}),p&&!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",re?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[M,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:_e,max:je,step:"1",value:M,onChange:G=>{const z=parseInt(G.target.value,10);C(z),qe({duration:z})},disabled:re,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-purple-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #a855f7 ${Re}%, #3b0764 ${Re}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),p&&Le&&(ge||(((Ys=p==null?void 0:p.config.supportedRatios)==null?void 0:Ys.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),ge?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const G="landscape",z=M===15?15:10,Pe=`sora-video-${G}-${z}s`,Ue=Ce.find(We=>{var Ye;return((Ye=We.modelId)==null?void 0:Ye.toLowerCase())===Pe})||Ce[0],Xe=(Ue==null?void 0:Ue.id)||"";T(Xe),D("16:9"),qe({modelId:Xe,ratio:"16:9",modelName:(Ue==null?void 0:Ue.name)||`Sora Video (Landscape ${z}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${$==="16:9"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const G="portrait",z=M===15?15:10,Pe=`sora-video-${G}-${z}s`,Ue=Ce.find(We=>{var Ye;return((Ye=We.modelId)==null?void 0:Ye.toLowerCase())===Pe})||Ce[0],Xe=(Ue==null?void 0:Ue.id)||"";T(Xe),D("9:16"),qe({modelId:Xe,ratio:"9:16",modelName:(Ue==null?void 0:Ue.name)||`Sora Video (Portrait ${z}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${$==="9:16"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(rs,{value:$,onChange:G=>{D(G),qe({ratio:G})},options:((p==null?void 0:p.config.supportedRatios)||[]).map(G=>{const[z,Pe]=G.split(":");return{value:G,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[G]||`${z}:${Pe}`}})})]}),p&&ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const G=$==="9:16"?"portrait":"landscape",z=`sora-video-${G}-10s`,Pe=Ce.find(Xe=>{var We;return((We=Xe.modelId)==null?void 0:We.toLowerCase())===z})||Ce[0],Ue=(Pe==null?void 0:Pe.id)||"";C(10),T(Ue),qe({duration:10,modelId:Ue,modelName:(Pe==null?void 0:Pe.name)||`Sora Video (${G==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${M===10?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const G=$==="9:16"?"portrait":"landscape",z=`sora-video-${G}-15s`,Pe=Ce.find(Xe=>{var We;return((We=Xe.modelId)==null?void 0:We.toLowerCase())===z})||Ce[0],Ue=(Pe==null?void 0:Pe.id)||"";C(15),T(Ue),qe({duration:15,modelId:Ue,modelName:(Pe==null?void 0:Pe.name)||`Sora Video (${G==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${M===15?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),p&&ge&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>k(!ie),className:`nodrag relative w-10 h-5 rounded-full transition-all ${ie?"bg-gradient-to-r from-purple-500 to-pink-500":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${ie?"left-5":"left-0.5"}`})})]}),p&&!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Be?"(æœªé…ç½®)":""]}),e.jsx(rs,{value:_,onChange:G=>{x(G),qe({resolution:G})},options:ye.map(G=>({value:G,label:G})),className:Be?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:Zs,disabled:O||!Nt||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${O||!Nt?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:O?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!b&&(V?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",ne,"æ¬¡"]}):N!==null&&N>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[N,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:Y?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-purple-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-purple-300 line-clamp-6 whitespace-pre-wrap break-words",children:Y})]}):e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},bo=t.memo(xo),Dr="https://api.waule.com",wo=({data:s,selected:E,id:u})=>{var C,O;const[K,Ie]=t.useState(!0),[U,ve]=t.useState(s.config.customName||""),[ee,ce]=t.useState(!1),[Z,he]=t.useState(0),[Oe,me]=t.useState(s.config.taskId||""),[ae,se]=t.useState(null),{credits:fe,loading:le}=Ls({nodeType:"sora_character"}),{setNodes:Ce,getNode:Y,setEdges:De}=ts(),we=Fs(),oe=Ds(),T=t.useCallback(r=>{var n;if(!r)return!1;const y=r.type||"",l=((n=r.data)==null?void 0:n.config)||{};if(y==="upload")return(l.uploadedFiles||l.files||[]).some(a=>(a.mimeType||a.type||"").toLowerCase().startsWith("video/"));if(y==="videoPreview")return!!l.url;if(y==="assetSelector"){const o=l.selectedAsset;return((o==null?void 0:o.mimeType)||"").toLowerCase().startsWith("video/")&&!!(o!=null&&o.url)}return y.startsWith("aiVideo")||y==="soraVideo"?!!l.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=we.filter(n=>n.target===u);if(r.length===0)return;const y=[],l=[];for(const n of r){const o=oe.find(a=>a.id===n.source)||Y(n.source);T(o)?y.push(n.id):l.push(n.id)}y.length>1&&(l.push(...y.slice(1)),h.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),l.length>0&&(De(n=>n.filter(o=>!l.includes(o.id))),l.length>0&&y.length<=1&&r.some(o=>{const a=oe.find(c=>c.id===o.source)||Y(o.source);return!T(a)})&&h.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[we,u,oe,Y,De,T]);const $=t.useMemo(()=>we.filter(y=>y.target===u).map(y=>{var n;const l=oe.find(o=>o.id===y.source);return(n=l==null?void 0:l.data)==null?void 0:n.config}),[we,u,oe]),D=t.useMemo(()=>(s.models||[]).filter(y=>{var l;return y.type==="VIDEO_GENERATION"&&((l=y.provider)==null?void 0:l.toLowerCase())==="sora"}),[s.models]),_=((C=D.find(r=>{var y;return(y=r.modelId)==null?void 0:y.includes("landscape-10s")}))==null?void 0:C.id)||((O=D[0])==null?void 0:O.id)||"",x=t.useCallback(r=>{Ce(y=>y.map(l=>l.id===u?{...l,data:{...l.data,config:{...l.data.config,...r}}}:l))},[u,Ce]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!ee&&(se({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),ve(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,ee]);const m=t.useMemo(()=>{var y;const r=we.filter(l=>l.target===u);for(const l of r){const n=oe.find(c=>c.id===l.source)||Y(l.source);if(!n)continue;const o=n.type||"",a=((y=n.data)==null?void 0:y.config)||{};if(o==="upload"){const w=(a.uploadedFiles||a.files||[]).find(S=>(S.mimeType||S.type||"").toLowerCase().startsWith("video/"));if(w!=null&&w.url)return{url:w.url,thumbnail:w.thumbnail||w.url,name:w.name||w.originalName||"è§†é¢‘"}}if(o==="videoPreview"&&a.url)return{url:a.url,thumbnail:a.thumbnail||a.url,name:a.name||"è§†é¢‘"};if(o==="assetSelector"){const c=a.selectedAsset;if(((c==null?void 0:c.mimeType)||"").toLowerCase().startsWith("video/")&&(c!=null&&c.url))return{url:c.url,thumbnail:c.thumbnail||c.url,name:c.name||"è§†é¢‘"}}if((o.startsWith("aiVideo")||o==="soraVideo")&&a.generatedVideoUrl)return{url:a.generatedVideoUrl,thumbnail:a.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[we,u,oe,$,Y]),I=!!m,te=async r=>{let l=0;const n=async()=>{try{l++;const a=(await Me.tasks.getTaskStatus(r)).task;if(he(a.progress||0),a.status==="SUCCESS"||a.status==="COMPLETED"||a.status==="DONE"){ce(!1),he(100);const c=a.metadata||{},w=c.characterName||"",S=c.avatarUrl||a.resultUrl||"";if(!w){h.error("æœªèƒ½è·å–è§’è‰²åç§°"),x({taskId:""}),me("");return}try{const q=(await Me.soraCharacters.create({customName:U||w,characterName:w,avatarUrl:S,sourceVideoUrl:(m==null?void 0:m.url)||void 0})).character;se({id:q.id,customName:q.customName,characterName:q.characterName,avatarUrl:q.avatarUrl}),x({customName:q.customName,characterName:q.characterName,avatarUrl:q.avatarUrl,taskId:""}),h.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${q.customName}`)}catch(L){se({id:"",customName:U||w,characterName:w,avatarUrl:S}),h.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${L.message}`)}me(""),setTimeout(()=>he(0),1e3);return}else if(a.status==="FAILURE"){ce(!1),he(0),x({taskId:""}),h.error(a.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(a.status==="PROCESSING"||a.status==="PENDING")&&(l<600?setTimeout(n,1e3):(ce(!1),he(0),x({taskId:""}),h.error("åˆ›å»ºè¶…æ—¶")))}catch{ce(!1),he(0),x({taskId:""}),h.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};n()},M=async()=>{var y,l,n,o,a;if(!m){h.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!U.trim()){h.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!_){h.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=m.url;if(!r){h.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const c=await Me.soraCharacters.getByCustomName(U.trim());if(c!=null&&c.character){h.error(`è‡ªå®šä¹‰åç§°"${U.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}ce(!0),he(5),se(null);try{const c=await Me.tasks.createVideoTask({modelId:_,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:u,metadata:{isCharacterCreation:!0,customName:U.trim(),referenceType:"video",nodeType:"sora_character"}}),w=c.taskId,S=c.creditsCharged||0;if(me(w),x({customName:U.trim(),taskId:w}),S>0)try{const{useAuthStore:L}=await gs(async()=>{const{useAuthStore:Q}=await import("./index-DOiS8MNr.js").then(g=>g.f);return{useAuthStore:Q}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:q}=L.getState();await q(),h.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${S} ç§¯åˆ†ï¼‰`)}catch{h.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else h.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");te(w)}catch(c){if(ce(!1),he(0),((y=c.response)==null?void 0:y.status)===403){const w=((n=(l=c.response)==null?void 0:l.data)==null?void 0:n.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";h.error(w)}else h.error(`æäº¤å¤±è´¥: ${((a=(o=c.response)==null?void 0:o.data)==null?void 0:a.error)||c.message}`)}};return t.useEffect(()=>{Oe&&!ee&&(ce(!0),te(Oe))},[]),e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl border-b border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",onClick:()=>Ie(!K),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${K?"rotate-180":""}`,children:"expand_more"})]})]}),K&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${I?"bg-green-500":"bg-slate-300 dark:bg-white/20"}`}),e.jsx("span",{className:I?"text-green-600 dark:text-green-400":"text-slate-400 dark:text-white/50",children:I?"å·²è¿æ¥è§†é¢‘":"è¯·è¿æ¥è§†é¢‘è¾“å…¥"})]}),m&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${m.url.startsWith("http")||m.url.startsWith("data:")?m.url:Dr+m.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:m.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:U,onChange:r=>ve(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors",disabled:ee})]}),ae&&!ee&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[ae.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-purple-400 dark:border-purple-400/50 flex-shrink-0",children:e.jsx("img",{src:ae.avatarUrl.startsWith("http")?ae.avatarUrl:`${Dr}${ae.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-purple-400 dark:border-purple-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:ae.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:ae.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),ee&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[Z,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300",style:{width:`${Z}%`}})})]}),e.jsx("button",{onClick:M,disabled:ee||!I||!U.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${ee||!I||!U.trim()||s._canEdit===!1?"bg-slate-300 dark:bg-white/10 text-slate-500 dark:text-white/30 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg active:scale-95"}`,children:ee?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!le&&fe!==null&&fe>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[fe,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},yo=t.memo(wo),ko=({data:s,id:E,selected:u})=>{const{setNodes:K,getNode:Ie}=ts(),[U,ve]=t.useState(s.config.modelId||""),[ee,ce]=t.useState(s.config.voiceId||""),[Z,he]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Oe,me]=t.useState(s.config.status||""),[ae,se]=t.useState(!1),[fe,le]=t.useState([]),[Ce]=t.useState(void 0),[Y]=t.useState("mp3"),[De]=t.useState(void 0),[we]=t.useState(void 0),[oe]=t.useState(void 0),[T]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!U&&ve(s.config.modelId)},[s.config.modelId,U]),t.useEffect(()=>{!ee&&s.config.voiceId&&ce(String(s.config.voiceId))},[s.config.voiceId,ee]),t.useEffect(()=>{if(!U){const m=(s.models||[]).filter(I=>I.type==="AUDIO_SYNTHESIS"&&I.isActive)[0];m&&(ve(m.id),D({modelId:m.id}))}},[s.models,U]),t.useEffect(()=>{$()},[]);const $=async()=>{try{const x=await Me.get("/ai/audio/voices"),m=(x==null?void 0:x.data)??x;le(Array.isArray(m)?m:[])}catch{}},D=x=>{Ie(E)&&K(I=>I.map(te=>te.id===E?{...te,data:{...te.data,config:{...te.data.config,...x}}}:te))},_=async()=>{var te,M,C,O;const x=(ee||s.config.voiceId||"").trim(),m=(Z||"").trim();if(!x||!m){h.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let I=U;if(!I){const r=(s.models||[]).filter(y=>y.type==="AUDIO_SYNTHESIS"&&y.isActive);if(r[0])I=r[0].id,ve(I),D({modelId:I});else{h.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}se(!0);try{if(Oe!=="OK"){let n=0,o=!1;for(;n<12;){n++;try{const a=await Me.ai.audio.queryVoice({voiceId:x,modelId:I}),c=((te=a.data)==null?void 0:te.status)||a.status;if(me(c),D({status:c}),c==="OK"){o=!0;break}if(c==="UNDEPLOYED")break}catch{}await new Promise(a=>setTimeout(a,2500))}if(!o){h.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),se(!1);return}}const r=await Me.ai.audio.synthesize({modelId:I,voiceId:x,text:m,format:Y,sampleRate:Ce,volume:we,rate:De,pitch:oe,output_format:T}),y=((M=r.data)==null?void 0:M.url)||r.url;try{const l=y&&y.startsWith("http")?y:`https://api.waule.com${y}`;let n;l?n=await Me.assets.proxyDownload(l):n=await(await fetch(y,{mode:"cors"})).arrayBuffer();const o=URL.createObjectURL(new Blob([n],{type:Y==="wav"?"audio/wav":"audio/mpeg"}));D({outputUrl:o})}catch{D({outputUrl:y})}h.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const y=((O=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(y)?h.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(y)?h.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):h.error(y)}se(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:U,onChange:x=>{ve(x),D({modelId:x})},options:(s.models||[]).filter(x=>x.type==="AUDIO_SYNTHESIS"&&x.isActive).map(x=>({value:x.id,label:x.name}))})]}),fe.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",fe.length,")"]}),e.jsx(rs,{value:ee||"",onChange:x=>{ce(x),D({voiceId:x})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...fe.map(x=>({value:x.voiceId,label:x.prefix||x.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:ee,onChange:x=>{const m=x.target.value;ce(m),D({voiceId:m})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:Z,onChange:x=>{he(x.target.value),D({text:x.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:_,disabled:ae||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ae?"bg-gray-600 dark:bg-gray-700 text-white":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ae?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},vo=t.memo(ko),No=({data:s,id:E,selected:u})=>{const{setNodes:K,setEdges:Ie,getNode:U}=ts(),[ve,ee]=t.useState(s.config.modelId||""),[ce,Z]=t.useState(s.config.voiceId||""),[he,Oe]=t.useState(s.config.voiceName||""),[me,ae]=t.useState(s.config.cloneAudioUrl||""),[se,fe]=t.useState(s.config.promptAudioUrl||""),[le,Ce]=t.useState(s.config.promptText||""),[Y,De]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[we,oe]=t.useState(!1);t.useEffect(()=>{const I=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!ce||!ce.startsWith("Waule")&&!ce.startsWith("Aivider")||ce.startsWith("minimax-")){const te=I();Z(te),_({voiceId:te})}},[ce]);const T=dr(I=>I.edges.filter(te=>te.target===E)),$=Ds(),D=t.useRef("");t.useEffect(()=>{if(!ve){const te=(s.models||[]).filter(M=>{if(M.type!=="AUDIO_SYNTHESIS"||!M.isActive)return!1;const C=String(M.provider||"").toLowerCase();return C.includes("minimaxi")||C.includes("hailuo")||C.includes("æµ·èº")})[0];te&&(ee(te.id),_({modelId:te.id}))}},[s.models,ve]),t.useEffect(()=>{try{const I=T.map(C=>`${C.id}-${C.source}-${C.targetHandle||""}`).sort().join(",");if(I===D.current)return;D.current=I;let te="",M="";for(const C of T){const O=U(C.source);if(!O)continue;const r=O.data||{},y=String(O.type||"").toLowerCase(),n=(()=>{var o,a;if(y==="upload"){const c=(((o=r.config)==null?void 0:o.uploadedFiles)||[]).find(w=>{const S=((w==null?void 0:w.type)||"").toUpperCase(),L=((w==null?void 0:w.mimeType)||"").toLowerCase();return S==="AUDIO"||L.startsWith("audio/")});return c==null?void 0:c.url}if(y==="assetSelector"){const c=(a=r.config)==null?void 0:a.selectedAsset,w=((c==null?void 0:c.type)||"").toUpperCase(),S=((c==null?void 0:c.mimeType)||"").toLowerCase();if(w==="AUDIO"||S.startsWith("audio/"))return c==null?void 0:c.url}return null})();n&&(C.targetHandle===`${E}-target-clone`&&(te=n),C.targetHandle===`${E}-target-prompt`&&(M=n))}te!==me&&(ae(te),_({cloneAudioUrl:te})),M!==se&&(fe(M),_({promptAudioUrl:M}))}catch{}},[T,$,U,E,me,se]);const _=I=>{K(te=>te.map(M=>M.id===E?{...M,data:{...M.data,config:{...M.data.config,...I}}}:M))},x=async()=>{var I,te;if(!ce||!he){h.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await Me.ai.audio.voices.add({voiceId:ce,prefix:he}),h.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(M){const C=((te=(I=M==null?void 0:M.response)==null?void 0:I.data)==null?void 0:te.message)||(M==null?void 0:M.message)||"ä¿å­˜å¤±è´¥";h.error(C)}},m=async()=>{var I,te,M;if(!ve||!he||!me){h.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}oe(!0),h.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const O=(s.models||[]).find(c=>c.id===ve),r=(O==null?void 0:O.modelId)||"speech-2.6-hd";let y=me;y.startsWith("http");const l=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;Z(l),_({voiceId:l});const n=await Me.ai.audio.createVoice({modelId:ve,targetModel:r,prefix:he,url:y,promptUrl:se||void 0,promptText:le||void 0,voiceId:l,previewText:Y||void 0}),o=(n==null?void 0:n.data)||n,a=o==null?void 0:o.sampleUrl;if(a){_({sampleUrl:a,status:"OK",voiceName:he}),h.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const c=U(E);if(c){const w=`audioPreview-${Date.now()}`,S={id:w,type:"audioPreview",position:{x:c.position.x+450,y:c.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:a,config:{audioUrl:a,title:`${he} - è¯•å¬`},models:s.models,createdBy:(I=c.data)==null?void 0:I.createdBy}};K(q=>[...q,S]);const L={id:`e-${E}-source-${w}-target`,source:E,sourceHandle:`${E}-source`,target:w,targetHandle:`${w}-target`,type:"aurora"};Ie(q=>[...q,L])}}else _({status:"OK",voiceName:he}),h.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(C){const O=((M=(te=C==null?void 0:C.response)==null?void 0:te.data)==null?void 0:M.message)||(C==null?void 0:C.message)||"åˆ›å»ºå¤±è´¥";h.error(O)}oe(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:ve,onChange:I=>{ee(I),_({modelId:I})},options:(s.models||[]).filter(I=>{if(I.type!=="AUDIO_SYNTHESIS"||!I.isActive)return!1;if(Array.isArray(I.capabilities))return I.capabilities.some(M=>M.capability==="éŸ³è‰²å…‹éš†"&&M.supported);const te=String(I.provider||"").toLowerCase();return te.includes("minimaxi")||te.includes("hailuo")||te.includes("æµ·èº")}).map(I=>({value:I.id,label:I.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:he,onChange:I=>{Oe(I.target.value),_({voiceName:I.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:I=>I.stopPropagation()}),e.jsx("button",{onClick:x,disabled:!ce||!he,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!ce||!he?"bg-gray-600 dark:bg-gray-700 text-white opacity-50":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:me?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:me?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:se?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:se?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:le,onChange:I=>{Ce(I.target.value),_({promptText:I.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:I=>I.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:Y,onChange:I=>{De(I.target.value),_({previewText:I.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:I=>I.stopPropagation()})]}),e.jsx("button",{onClick:m,disabled:we||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${we||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:we?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},jo=t.memo(No),Lr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Io=({data:s,id:E,selected:u})=>{const{setNodes:K,getNode:Ie,setEdges:U}=ts(),[ve,ee]=t.useState(s.config.modelId||""),[ce,Z]=t.useState(s.config.voiceId||""),[he,Oe]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),me=t.useRef(null),[ae,se]=t.useState("zh"),fe=t.useRef(null),le=t.useRef(null),Ce=t.useRef(null),Y=t.useRef(null),De=t.useRef(null),[we,oe]=t.useState([]),T=async()=>{try{const l=await Me.ai.audio.voices.list(),n=(l==null?void 0:l.data)??l;oe(Array.isArray(n)?n:[])}catch{}},$=async()=>{try{const l=window.AudioContext||window.webkitAudioContext;Y.current||(Y.current=new l);const n=Y.current;n.state==="suspended"&&await n.resume()}catch{}},[D,_]=t.useState(!1),[x]=t.useState(""),[m]=t.useState(void 0),[I]=t.useState("mp3"),[te]=t.useState(void 0),[M]=t.useState(void 0),[C]=t.useState(void 0),[O]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!ve&&ee(s.config.modelId)},[s.config.modelId,ve]),t.useEffect(()=>{!ce&&s.config.voiceId&&Z(String(s.config.voiceId))},[s.config.voiceId,ce]),t.useEffect(()=>{if(!ve){const n=(s.models||[]).filter(o=>o.type==="AUDIO_SYNTHESIS"&&o.isActive)[0];n&&(ee(n.id),r({modelId:n.id}))}},[s.models,ve]),t.useEffect(()=>{T()},[]),t.useEffect(()=>{ae==="custom"&&T()},[ae]),t.useEffect(()=>{const l=me.current;l&&(l.style.height="auto",l.style.height=`${l.scrollHeight}px`)},[he]);const r=l=>{Ie(E)&&K(o=>o.map(a=>a.id===E?{...a,data:{...a.data,config:{...a.data.config,...l}}}:a))},y=async(l=!1)=>{var c,w,S,L,q;let n=(ce||s.config.voiceId||"").trim();if(l&&!n)if(ae==="custom"){const Q=we[0];Q&&(n=String(Q.voiceId),Z(n),r({voiceId:n}))}else{const Q=Lr.find(g=>{const f=g.label;return ae==="zh"?f.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):ae==="yue"?f.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):ae==="en"?f.startsWith("è‹±æ–‡ "):ae==="ja"?f.startsWith("æ—¥æ–‡ "):ae==="ko"?f.startsWith("éŸ©æ–‡ "):!0});Q&&(n=Q.id,Z(n),r({voiceId:n}))}const o=l?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(he||"").trim();if(!n||!o){h.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let a=ve;if(!a){const Q=(s.models||[]).filter(g=>g.type==="AUDIO_SYNTHESIS"&&g.isActive);if(Q[0])a=Q[0].id,ee(a),r({modelId:a});else{h.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}_(!0);try{l&&await $();const Q={};if(x)try{Q.voice_modify={emotion:x}}catch{}const g=await Me.ai.audio.synthesize({modelId:a,voiceId:n,text:o,format:I,sampleRate:m,volume:M,rate:te,pitch:C,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...Q}),f=((c=g==null?void 0:g.data)==null?void 0:c.url)||(g==null?void 0:g.url),d=window.location.origin,P=(b=>{if(!b)return"";try{if(b.startsWith("http://localhost:3000")||b.startsWith("http://127.0.0.1:3000")){const V=new URL(b).pathname;return`${d}${V}`}return b.startsWith("http")?b:b.startsWith("/")?`${d}${b}`:`${d}/${b}`}catch{return b}})(f);let F;const X=b=>{if(b.length>=12){if(b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69)return"audio/wav";if(b[0]===73&&b[1]===68&&b[2]===51||b[0]===255&&(b[1]&224)===224)return"audio/mpeg"}return I==="wav"?"audio/wav":"audio/mpeg"},ue=b=>b.length>=12&&b[4]===102&&b[5]===116&&b[6]===121&&b[7]===112,de=b=>b.length>=4&&b[0]===79&&b[1]===103&&b[2]===103&&b[3]===83,ie=b=>b.length>=4&&b[0]===102&&b[1]===76&&b[2]===97&&b[3]===67,k=new Uint8Array(F||new ArrayBuffer(0));let p=X(k);(!p||p==="application/octet-stream")&&(ue(k)?p="audio/mp4":de(k)?p="audio/ogg":ie(k)&&(p="audio/flac"));let N;if(l){if(De.current){try{De.current.stop()}catch{}De.current.disconnect(),De.current=null}const b=le.current||new Audio;b.preload="auto",b.autoplay=!0,b.playsInline=!0,b.crossOrigin="anonymous",le.current=b;let V=!1;const ne=(H,ge,Se=1500)=>new Promise(ye=>{let _e=!1;const je=()=>{_e||(_e=!0,Re(),ye(!0))},Te=()=>{_e||(_e=!0,Re(),ye(!1))},Re=()=>{H.removeEventListener(ge,je),H.removeEventListener("error",Te)};H.addEventListener(ge,je),H.addEventListener("error",Te),setTimeout(()=>{Te()},Se)});try{const H=ye=>{const _e=(ye||"").replace(/\s+/g,""),je=new Uint8Array(Math.floor(_e.length/2));for(let Te=0;Te<je.length;Te++)je[Te]=parseInt(_e.substr(Te*2,2),16);return je},ge=((w=g==null?void 0:g.data)==null?void 0:w.hex)||(g==null?void 0:g.hex),Se=ge?H(String(ge)).buffer:void 0;if(Se&&Se.byteLength>0){const ye=new Uint8Array(Se),_e=X(ye),je=new Blob([Se],{type:_e}),Te=URL.createObjectURL(je);if(Ce.current)try{URL.revokeObjectURL(Ce.current)}catch{}if(Ce.current=Te,b.src=Te,b.load(),!await ne(b,"canplay"))throw new Error("blob not ready");await b.play(),V=!0}else throw new Error("no hex")}catch{V=!1}if(!V){try{const H=ye=>{const _e=(ye||"").replace(/\s+/g,""),je=new Uint8Array(Math.floor(_e.length/2));for(let Te=0;Te<je.length;Te++)je[Te]=parseInt(_e.substr(Te*2,2),16);return je},ge=((S=g==null?void 0:g.data)==null?void 0:S.hex)||(g==null?void 0:g.hex),Se=ge?H(String(ge)).buffer:void 0;if(!Se||Se.byteLength===0){const ye=await Me.assets.proxyDownload(P);if(!ye||ye.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const _e=new Uint8Array(ye),je=X(_e),Te=new Blob([ye],{type:je}),Re=URL.createObjectURL(Te);if(Ce.current)try{URL.revokeObjectURL(Ce.current)}catch{}if(Ce.current=Re,b.src=Re,b.load(),!await ne(b,"canplay"))throw new Error("blob not ready");await b.play(),V=!0}else{const ye=new Uint8Array(Se),_e=X(ye),je=new Blob([Se],{type:_e}),Te=URL.createObjectURL(je);if(Ce.current)try{URL.revokeObjectURL(Ce.current)}catch{}if(Ce.current=Te,b.src=Te,b.load(),!await ne(b,"canplay"))throw new Error("blob not ready");await b.play(),V=!0}}catch{}if(!V)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const b=await Me.assets.proxyDownload(P),V=new Uint8Array(b),ne=X(V);N=URL.createObjectURL(new Blob([b],{type:ne}))}catch{}if(!l&&N){if(fe.current)try{URL.revokeObjectURL(fe.current)}catch{}fe.current=N;const b=P||N;r({outputUrl:b});try{const V=Ie(E);if(V){const H=document.querySelector(`.react-flow__node[data-id="${V.id}"]`),ge=Math.round((H==null?void 0:H.getBoundingClientRect().width)||420),Se=V.position.x+ge+160,ye=`audio-preview-${Date.now()}`;K(_e=>{var re;const je=_e.filter(Be=>{var qe;return Be.type==="audioPreview"&&((qe=Be.data)==null?void 0:qe.sourceNodeId)===E}),Te=V.position.y,Re=je.length>0?Math.max(...je.map(Be=>{var qe;return((qe=Be.position)==null?void 0:qe.y)||Te}))+120:Te;return[..._e,{id:ye,type:"audioPreview",position:{x:Se,y:Re},data:{audioUrl:b,sourceNodeId:E,createdBy:(re=V.data)==null?void 0:re.createdBy}}]}),U(_e=>[..._e,{id:`${E}-${ye}`,source:E,target:ye}])}}catch{}}l&&le.current&&!le.current.paused?h.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!l&&N&&h.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(Q){const g=((q=(L=Q==null?void 0:Q.response)==null?void 0:L.data)==null?void 0:q.message)||(Q==null?void 0:Q.message)||(l?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");h.error(g)}_(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:ve,onChange:l=>{ee(l),r({modelId:l})},options:(s.models||[]).filter(l=>l.type==="AUDIO_SYNTHESIS"&&l.isActive).map(l=>({value:l.id,label:l.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(rs,{value:ae,onChange:l=>{se(l),l==="custom"&&T()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(rs,{value:ce,onChange:l=>{Z(l),r({voiceId:l})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...ae==="custom"?we.map(l=>({value:l.voiceId,label:l.prefix||l.voiceId})):Lr.filter(l=>{const n=l.label;return ae==="zh"?n.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):ae==="yue"?n.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):ae==="en"?n.startsWith("è‹±æ–‡ "):ae==="ja"?n.startsWith("æ—¥æ–‡ "):ae==="ko"?n.startsWith("éŸ©æ–‡ "):!0}).map(l=>({value:l.id,label:l.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>y(!0),disabled:D,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${D?"bg-gray-600 dark:bg-gray-700":""}`,style:D?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #a855f7, #ec4899)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:me,value:he,onChange:l=>{Oe(l.target.value),r({text:l.target.value})},onMouseDown:l=>l.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>y(!1),disabled:D||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${D||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700":"border-transparent dark:border-white/10"}`,style:D||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #a855f7, #ec4899)"},children:D?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:le,className:"hidden"}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},So=t.memo(Io),Eo=t.memo(({id:s,sourceX:E,sourceY:u,targetX:K,targetY:Ie,sourcePosition:U,targetPosition:ve,selected:ee,markerEnd:ce})=>{const[Z]=ua({sourceX:E,sourceY:u,targetX:K,targetY:Ie,sourcePosition:U,targetPosition:ve});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ec4899",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#a855f7",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:Z,fill:"none",stroke:ee?"#a855f7":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:ce}),e.jsx("path",{d:Z,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:ce}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:Z,calcMode:"linear"})}),e.jsx("path",{d:Z,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Co=({data:s,id:E})=>{const u=t.useRef(null),{getNode:K,setNodes:Ie}=ts(),[U,ve]=t.useState(!1),[ee,ce]=t.useState([]),[Z,he]=t.useState(""),[Oe,me]=t.useState("ALL"),[ae,se]=t.useState(""),[fe,le]=t.useState(!1),Ce=t.useMemo(()=>window.location.origin,[]),Y=t.useMemo(()=>{var D;const $=s.audioUrl||"";if($.startsWith("blob:")){const _=s.sourceNodeId?K(s.sourceNodeId):null,x=((D=_==null?void 0:_.data)==null?void 0:D.outputUrl)||"";return x.startsWith("http")?x:x.startsWith("/")?`${Ce}${x}`:$}return $.startsWith("http")?`${Ce}/api/assets/proxy-stream?url=${encodeURIComponent($)}`:$.startsWith("/")?`${Ce}${$}`:$},[s.audioUrl,s.sourceNodeId,Ce]);t.useEffect(()=>{const $=u.current;$&&($.preload="auto",$.playsInline=!0,$.crossOrigin="anonymous",$.load())},[Y]),t.useEffect(()=>{U&&(De(),setTimeout(()=>{we()},100))},[U]);const De=async()=>{try{const $=Oe==="ALL"?void 0:{category:Oe},_=(await Me.assetLibraries.getAll($)).data||[];ce(_);const x=Oe==="ALL"?_:_.filter(m=>(m.category||"OTHER")===Oe);if(x.length>0){const m=x.find(I=>I.id===Z);he(m?m.id:x[0].id)}else he("")}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},we=()=>{const $=window.__workflowContext;if(!$||!$.project||!$.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const D=Ws(E,$.nodeGroups);if(!D&&$.nodeGroups.length>0){const x=$.nodeGroups[0],m=Ts({project:$.project,episode:$.episode,nodeGroup:x,assetType:"audio"});m?(se(m),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${m}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const _=Ts({project:$.project,episode:$.episode,nodeGroup:D,assetType:"audio"});_?(se(_),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${_}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},oe=async()=>{var $,D;if(!Z){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ae.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{le(!0),await Me.assetLibraries.addFromUrl(Z,s.audioUrl,ae.trim());const _=window.__workflowContext;if(_&&_.project&&_.nodeGroups){const x=Ws(E,_.nodeGroups)||_.nodeGroups[0];x&&Ts({project:_.project,episode:_.episode,nodeGroup:x,nodeId:E,assetType:"audio",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ve(!1),se("");try{Ie(x=>x.map(m=>m.id===E?{...m,data:{...m.data,addedToLibrary:!0}}:m))}catch{}try{const x=new CustomEvent("asset-library-updated",{detail:{libraryId:Z}});window.dispatchEvent(x)}catch{}}catch(_){h.error(((D=($=_.response)==null?void 0:$.data)==null?void 0:D.message)||"æ·»åŠ å¤±è´¥")}finally{le(!1)}},T=async()=>{var _;let $=`audio-${Date.now()}.mp3`;const D=window.__workflowContext;if(D&&D.project&&D.nodeGroups){const x=Ws(E,D.nodeGroups)||D.nodeGroups[0];if(x){const m=Ts({project:D.project,episode:D.episode,nodeGroup:x,assetType:"audio",preview:!0});if(m&&($=m,!$.includes("."))){const I=((_=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:_[0])||".mp3";$+=I}}}try{h.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const x=`/assets/proxy-download-with-name?url=${encodeURIComponent(s.audioUrl)}&filename=${encodeURIComponent($)}`,m=await Me.get(x,{responseType:"blob"}),I=m instanceof Blob?m:m==null?void 0:m.data;if(!I||!(I instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const te=window.URL.createObjectURL(I),M=document.createElement("a");M.href=te,M.download=$,document.body.appendChild(M),M.click(),document.body.removeChild(M),setTimeout(()=>{window.URL.revokeObjectURL(te)},100),h.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${$}`)}catch(x){h.error(`ä¸‹è½½å¤±è´¥: ${x instanceof Error?x.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:u,controls:!0,src:Y,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{ve(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:T,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),U&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ve(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ae,onChange:$=>se($.target.value),onMouseDown:$=>$.stopPropagation(),onTouchStart:$=>$.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const $=Oe==="ALL"?ee:ee.filter(D=>(D.category||"OTHER")===Oe);return $.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Oe==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Z,onChange:D=>he(D.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:$.map(D=>e.jsxs("option",{value:D.id,children:[D.name," (",D._count.assets," ä¸ªèµ„äº§)"]},D.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map($=>e.jsx("button",{type:"button",onClick:()=>{me($);const D=ee.filter(_=>(_.category||"OTHER")===$);he(D.length>0?D[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Oe===$?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:$==="ROLE"?"person":$==="SCENE"?"landscape":$==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:$==="ROLE"?"è§’è‰²åº“":$==="SCENE"?"åœºæ™¯åº“":$==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},$))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ve(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:oe,disabled:fe||ee.length===0||!ae.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:fe?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Ao=t.memo(Co),_o=({data:s,id:E,selected:u})=>{const{setNodes:K,getNode:Ie,setEdges:U}=ts(),[ve,ee]=t.useState(s.config.modelId||""),[ce,Z]=t.useState(s.config.prompt||""),[he,Oe]=t.useState(s.config.previewText||""),[me,ae]=t.useState(s.config.voiceId||""),[se,fe]=t.useState(!1),le=t.useRef(null),Ce=t.useRef(null),Y=t.useRef(null),De=t.useRef(null),[we,oe]=t.useState([]);t.useEffect(()=>{if(!ve){const I=(s.models||[]).filter(te=>te.type==="AUDIO_SYNTHESIS"&&te.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(te.provider||"").toLowerCase())&&(Array.isArray(te.capabilities)?te.capabilities.some(M=>M.capability==="éŸ³è‰²è®¾è®¡"&&M.supported):!0))[0];I&&(ee(I.id),T({modelId:I.id}))}},[s.models,ve]);const T=m=>{Ie(E)&&K(te=>te.map(M=>M.id===E?{...M,data:{...M.data,config:{...M.data.config,...m}}}:M))};t.useEffect(()=>{(async()=>{try{const m=await Me.ai.audio.voices.list(),I=(m==null?void 0:m.data)??m;oe(Array.isArray(I)?I:[])}catch{}})()},[]);const $=m=>{m&&(m.style.height="auto",m.style.height=`${m.scrollHeight}px`)};t.useEffect(()=>{$(Ce.current)},[ce]),t.useEffect(()=>{$(Y.current)},[he]);const D=async m=>{if(!m)return!1;try{const I=(m||"").replace(/\s+/g,""),te=new Uint8Array(Math.floor(I.length/2));for(let y=0;y<te.length;y++)te[y]=parseInt(I.substr(y*2,2),16);const M=(()=>{const y=te;return y.length>=12&&y[0]===82&&y[1]===73&&y[2]===70&&y[3]===70&&y[8]===87&&y[9]===65&&y[10]===86&&y[11]===69?"audio/wav":(y.length>=3&&y[0]===73&&y[1]===68&&y[2]===51||y.length>=2&&y[0]===255&&(y[1]&224)===224,"audio/mpeg")})(),C=new Blob([te.buffer],{type:M}),O=URL.createObjectURL(C);if(De.current)try{URL.revokeObjectURL(De.current)}catch{}De.current=O;const r=le.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=O,le.current=r,await r.play(),!0}catch{return!1}},_=async()=>{var I,te,M,C,O;if(!ce.trim()){h.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let m=ve;if(!m){const r=(s.models||[]).filter(y=>y.type==="AUDIO_SYNTHESIS"&&y.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(y.provider||"").toLowerCase()));if(r[0])m=r[0].id,ee(m),T({modelId:m});else{h.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}fe(!0);try{const r=await Me.ai.audio.design({modelId:m,prompt:ce,preview_text:he,voice_id:me||void 0,aigc_watermark:!1}),y=((I=r==null?void 0:r.data)==null?void 0:I.voice_id)||(r==null?void 0:r.voice_id),l=((te=r==null?void 0:r.data)==null?void 0:te.trial_audio)||(r==null?void 0:r.trial_audio)||((M=r==null?void 0:r.data)==null?void 0:M.hex)||(r==null?void 0:r.hex);y&&(ae(String(y)),T({voiceId:String(y)})),l&&typeof l=="string"?(T({trialHex:l}),await D(l),h.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):h.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const n=Ie(E);if(n){const a=document.querySelector(`.react-flow__node[data-id="${n.id}"]`),c=Math.round((a==null?void 0:a.getBoundingClientRect().width)||420),w=n.position.x+c+160,S=`audio-preview-${Date.now()}`;K(L=>{var q;return[...L,{id:S,type:"audioPreview",position:{x:w,y:n.position.y},data:{audioUrl:De.current||"",sourceNodeId:E,createdBy:(q=n.data)==null?void 0:q.createdBy}}]}),U(L=>[...L,{id:`${E}-${S}`,source:E,target:S}])}}catch{}}catch(r){const y=((O=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";h.error(y)}fe(!1)},x=async()=>{var I,te;const m=(me||"").trim();if(!m){h.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(we.some(o=>String(o.voiceId)===String(m))){h.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const O=(s.models||[]).find(o=>o.id===ve),r=(O==null?void 0:O.modelId)||"cosyvoice-v2",y=(ce||m).slice(0,40);await Me.ai.audio.voices.add({voiceId:m,prefix:y,targetModel:r,provider:String((O==null?void 0:O.provider)||"")});const l=await Me.ai.audio.voices.list(),n=(l==null?void 0:l.data)??l;oe(Array.isArray(n)?n:[]),h.success("å·²ä¿å­˜éŸ³è‰²")}catch(M){const C=((te=(I=M==null?void 0:M.response)==null?void 0:I.data)==null?void 0:te.message)||(M==null?void 0:M.message)||"ä¿å­˜å¤±è´¥";h.error(C)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:ve,onChange:m=>{ee(m),T({modelId:m})},options:(s.models||[]).filter(m=>m.type!=="AUDIO_SYNTHESIS"||!m.isActive?!1:Array.isArray(m.capabilities)?m.capabilities.some(I=>I.capability==="éŸ³è‰²è®¾è®¡"&&I.supported):["minimaxi","hailuo","æµ·èº"].includes(String(m.provider||"").toLowerCase())).map(m=>({value:m.id,label:m.name}))})]}),we.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(rs,{value:me||"",onChange:m=>{ae(m),T({voiceId:m})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...we.map(m=>({value:m.voiceId,label:m.prefix||m.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:me,onChange:m=>{const I=m.target.value;ae(I),T({voiceId:I})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:Ce,value:ce,onChange:m=>{Z(m.target.value),T({prompt:m.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:Y,value:he,onChange:m=>{Oe(m.target.value),T({previewText:m.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:_,disabled:se||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${se||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:se?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:x,disabled:se||!me||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${se||!me||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white opacity-50":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:le,className:"hidden"}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},To=t.memo(_o),Ro=({data:s,id:E,selected:u})=>{const K=t.useRef(null),Ie=t.useRef(null),U=t.useRef(null),{getNodes:ve,getEdges:ee,setNodes:ce,setEdges:Z,getNode:he,getViewport:Oe}=ts(),me=Fs(),ae=Ds(),[se,fe]=t.useState(null),[le,Ce]=t.useState("#7c3aed"),[Y,De]=t.useState(100),we=t.useRef(!1),oe=t.useRef(null),T=t.useRef(null),$=t.useRef(null),D=t.useRef(new Set),_=t.useRef(null),x=t.useRef(null),m=t.useRef(null),I=4096,te=s.width||800,M=s.width||800,C=I,O=I;return t.useEffect(()=>{var g,f,d,B;if(!K.current||Ie.current)return;const r=document.createElement("canvas");r.width=C,r.height=O,K.current.appendChild(r);const y=new ya(r,{width:C,height:O,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),l=new Hs({left:0,top:0,width:C,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});y.add(l),y.sendObjectToBack(l),y.perPixelTargetFind=!0,y.targetFindTolerance=8;const n=te/C;y.setDimensions({width:te,height:M}),y.setZoom(n),r.style.width=`${te} px`,r.style.height=`${M} px`,Ie.current=y,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const o=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;y.rotationCursor=o;const a=Vs.prototype.controls||{};a.tl&&(a.tl.cursorStyle="nwse-resize",a.tl.cornerStyle="square"),a.br&&(a.br.cursorStyle="nwse-resize",a.br.cornerStyle="square"),a.tr&&(a.tr.cursorStyle="nesw-resize",a.tr.cornerStyle="square"),a.bl&&(a.bl.cursorStyle="nesw-resize",a.bl.cornerStyle="square"),a.mtr&&(a.mtr.cursorStyle=o,a.mtr.cornerStyle="circle");const c=P=>{P&&(P.borderColor="#ff2d55",P.cornerColor="#ff2d55",P.cornerStrokeColor="#ff2d55",P.transparentCorners=!1,P.cornerSize=12,P.hasBorders=!0,P.hasControls=!0)},w=()=>{const P=y.getActiveObject();P&&(P.type==="activeSelection"&&Array.isArray(P._objects)&&P._objects.forEach(c),c(P),y.requestRenderAll())};y.on("selection:created",w),y.on("selection:updated",w),y.freeDrawingBrush=new Rr(y);const S=()=>{const P=Ie.current;if(!P)return;const F=P.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(F.objects)&&(F.objects=F.objects.map(ie=>(ie&&ie.type==="image"&&ie.originalUrl&&(ie.src=ie.originalUrl),ie)));const X={canvasJson:F,appliedCrop:m.current},ue=JSON.stringify(X);try{localStorage.setItem(`superCanvas:${E}`,ue)}catch{}he(E)&&ce(ie=>ie.map(k=>k.id===E?{...k,data:{...k.data,canvasState:ue}}:k))},L=()=>{x.current&&(clearTimeout(x.current),x.current=null),x.current=window.setTimeout(()=>{S()},300)};y.on("object:added",L),y.on("object:modified",L),y.on("object:removed",L),y.on("path:created",L);const q=((f=(g=he(E))==null?void 0:g.data)==null?void 0:f.canvasState)||localStorage.getItem(`superCanvas:${E}`),Q=(B=(d=he(E))==null?void 0:d.data)==null?void 0:B.canvasJson;if(q||Q)try{let P,F=null;if(q){const p=JSON.parse(q);p.canvasJson?(P=p.canvasJson,F=p.appliedCrop):P=p}else Q&&(P=JSON.parse(Q));const X=P,ue=p=>{var N,b,V,ne,H,ge,Se,ye,_e;if(!p||typeof p!="object")return p;if(p.type==="image"){if(p.originalUrl)p.src=p.originalUrl;else if(p.sourceNodeId){const je=he(p.sourceNodeId),Te=((N=je==null?void 0:je.data)==null?void 0:N.imageUrl)||((b=je==null?void 0:je.data)==null?void 0:b.url)||((V=je==null?void 0:je.data)==null?void 0:V.output)||((H=(ne=je==null?void 0:je.data)==null?void 0:ne.config)==null?void 0:H.generatedImageUrl)||((_e=(ye=(Se=(ge=je==null?void 0:je.data)==null?void 0:ge.config)==null?void 0:Se.uploadedFiles)==null?void 0:ye[0])==null?void 0:_e.url);Te&&(p.originalUrl=Te,p.src=Te)}return typeof p.src=="string"&&p.src.startsWith("blob:")?null:p}return Array.isArray(p.objects)&&(p.objects=p.objects.map(ue).filter(Boolean),p.type==="group"&&p.objects.length===0)?null:p},de=p=>p&&(typeof(p==null?void 0:p.src)=="string"&&p.src.startsWith("blob:")?null:p.type==="image"?ue(p):p),ie=p=>p&&(Array.isArray(p)?p.map(ie).filter(Boolean):typeof p=="object"&&(p.type==="image"&&typeof p.src=="string"&&p.src.startsWith("blob:")||(Object.keys(p).forEach(N=>{const b=p[N];if(typeof b=="string"&&b.startsWith("blob:"))p[N]=void 0;else if(b&&typeof b=="object"){const V=ie(b);V===null?delete p[N]:p[N]=V}}),Array.isArray(p.objects)&&(p.objects=p.objects.map(ie).filter(Boolean),p.type==="group"&&p.objects.length===0)))?null:p);Array.isArray(X.objects)&&(X.objects=X.objects.map(ue).filter(Boolean)),X.backgroundImage&&(X.backgroundImage=de(X.backgroundImage)),X.overlayImage&&(X.overlayImage=de(X.overlayImage)),X.clipPath&&(X.clipPath=ue(X.clipPath));const k=ie(X);y.loadFromJSON(k).then(()=>{const p=new Hs({left:0,top:0,width:C,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});y.add(p);const N=y.getObjects().find(b=>b.name==="__background__");if(N&&y.sendObjectToBack(N),F){m.current=F;const{left:b,top:V,width:ne,height:H}=F,ge=new Hs({left:b,top:V,width:ne,height:H,absolutePositioned:!0});y.clipPath=ge,N&&N.set({left:b,top:V,width:ne,height:H})}y.requestRenderAll()})}catch{}return K.current&&K.current.classList.add("nodrag"),()=>{y.dispose(),Ie.current=null,K.current&&(K.current.innerHTML="")}},[E,C,O,te]),t.useEffect(()=>{se==="brush"?(Y<80||Y>400)&&De(100):(se==="pencil"||se==="line"||se==="arrow")&&(Y<10||Y>30)&&De(15)},[se,Y]),t.useEffect(()=>{const r=Ie.current;if(!r)return;const y="https://api.waule.com",l=me.filter(a=>a.target===E&&a.targetHandle==="input-image");l.forEach(async a=>{var Q,g;const c=ae.find(f=>f.id===a.source);if(!c||D.current.has(c.id))return;let w;const S=c.data;if(c.type==="upload"){const f=(Q=S==null?void 0:S.config)==null?void 0:Q.uploadedFiles;if(f&&f.length>0){const d=f[0];(d.type==="IMAGE"||(g=d.mimeType)!=null&&g.startsWith("image/"))&&(w=d.url)}}else c.type==="imagePreview"?w=S==null?void 0:S.imageUrl:w=(S==null?void 0:S.imageUrl)||(S==null?void 0:S.output)||(S==null?void 0:S.url);if(!w)return;let L=w;if(!w.startsWith("http")&&!w.startsWith("data:")&&(L=`${y}${w}`),L=L.replace(/^https?:\/\/localhost(?::\d+)?/i,y),r.getObjects().find(f=>f.sourceNodeId===c.id)){D.current.add(c.id);return}D.current.add(c.id);try{const f=await Me.assets.proxyDownload(L),d=new Uint8Array(f);let B="image/png";d.length>=4&&(d[0]===137&&d[1]===80&&d[2]===78&&d[3]===71?B="image/png":d[0]===255&&d[1]===216&&d[2]===255?B="image/jpeg":d[0]===71&&d[1]===73&&d[2]===70?B="image/gif":d[0]===82&&d[1]===73&&d[2]===70&&d[3]===70&&d.length>=12&&d[8]===87&&d[9]===69&&d[10]===66&&d[11]===80&&(B="image/webp"));const P=new Blob([f],{type:B}),F=URL.createObjectURL(P),X=await ka.fromURL(F);if(!X){URL.revokeObjectURL(F);return}const ue=l.indexOf(a)*20;X.set({scaleX:1,scaleY:1,left:(C-X.width)/2+ue,top:(O-X.height)/2+ue,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:c.id,originalUrl:L,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),X.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(X);const de=r.getObjects().find(ie=>ie.name==="__background__");de?(r.sendObjectToBack(X),r.sendObjectToBack(de)):r.sendObjectToBack(X),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(F),1e3)}catch{}});const n=new Set(l.map(a=>{var c;return(c=ae.find(w=>w.id===a.source))==null?void 0:c.id}).filter(Boolean)),o=[];D.current.forEach(a=>{if(!n.has(a)){o.push(a);const c=r.getObjects().find(w=>w.sourceNodeId===a);c&&(r.remove(c),r.requestRenderAll())}}),o.forEach(a=>D.current.delete(a))},[me,ae,E,C,O]),t.useEffect(()=>{const r=Ie.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,se===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(o=>{o.name!=="__background__"&&o.name!=="__crop__"&&(o.selectable=!1,o.evented=!1)}),_.current&&(_.current.style.display="none"),m.current){const{left:o,top:a,width:c,height:w}=m.current,S=new Hs({left:o,top:a,width:c,height:w,absolutePositioned:!0});r.clipPath=S;const L=r.getObjects().find(q=>q.name==="__background__");L&&L.set({left:o,top:a,width:c,height:w})}return}const y=le.startsWith("#")?`%23${le.slice(1)}`:encodeURIComponent(le),l=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${y}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,n=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(se==="pencil"||se==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Rr(r);const o=(c,w)=>{const S=c.replace("#",""),L=parseInt(S.substring(0,2),16),q=parseInt(S.substring(2,4),16),Q=parseInt(S.substring(4,6),16);return`rgba(${L},${q},${Q},${w})`};if(r.freeDrawingBrush.color=o(le,.7),r.freeDrawingBrush.width=Y,m.current){const{left:c,top:w,width:S,height:L}=m.current,q=new Hs({left:c,top:w,width:S,height:L,absolutePositioned:!0});r.clipPath=q;const Q=r.getObjects().find(g=>g.name==="__background__");Q&&Q.set({left:c,top:w,width:S,height:L})}const a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${y}' stroke-width='2.2'/></svg>") 16 16, crosshair`;se==="pencil"?(r.freeDrawingCursor=l,r.defaultCursor=l,r.hoverCursor=l,r.moveCursor=l,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=l)):(r.freeDrawingCursor=a,r.defaultCursor=a,r.hoverCursor=a,r.moveCursor=a,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=a)),r.selection=!1,r.getObjects().forEach(c=>{c.name!=="__background__"&&c.name!=="__crop__"&&(c.selectable=!0,c.evented=!0)}),se==="brush"&&_.current&&(_.current.style.display="block"),se==="pencil"&&_.current&&(_.current.style.display="none")}else if(se==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const o=r.getObjects().find(L=>L.name==="__background__");o&&o.set({left:0,top:0,width:C,height:O}),r.requestRenderAll();let a=$.current;const c=C*.1,w=C-c*2,S=O-c*2;if(!a||!r.getObjects().includes(a)){const L=m.current||{left:c,top:c,width:w,height:S};a=new Hs({left:L.left,top:L.top,width:L.width,height:L.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),$.current=a,r.add(a)}a&&(a.visible=!0,a.selectable=!0,a.evented=!0,r.setActiveObject(a),r.requestRenderAll())}else if(se==="line"||se==="arrow"||se==="text"||se==="eraser"){if(r.selection=!1,m.current){const{left:a,top:c,width:w,height:S}=m.current,L=new Hs({left:a,top:c,width:w,height:S,absolutePositioned:!0});r.clipPath=L;const q=r.getObjects().find(Q=>Q.name==="__background__");q&&q.set({left:a,top:c,width:w,height:S})}const o=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${y}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=se==="text"?"text":se==="eraser"?n:o,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),se==="line"||se==="arrow"?(r.hoverCursor=o,r.moveCursor=o,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(a=>{a.name!=="__background__"&&a.name!=="__crop__"&&(a.selectable=!1,a.evented=!1)}),_.current&&(_.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(a=>{a.name!=="__background__"&&a.name!=="__crop__"&&(a.selectable=!0,a.evented=!0)}),se==="eraser"&&_.current&&(_.current.style.display="none"),se==="eraser"&&(r.moveCursor=n,r.hoverCursor=n)),_.current&&(_.current.style.display="none")}else{if($.current&&($.current.visible=!1,r.discardActiveObject()),m.current){const{left:o,top:a,width:c,height:w}=m.current,S=new Hs({left:o,top:a,width:c,height:w,absolutePositioned:!0});r.clipPath=S;const L=r.getObjects().find(q=>q.name==="__background__");L&&L.set({left:o,top:a,width:c,height:w})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(o=>{o.name!=="__background__"&&o.name!=="__crop__"&&(o.selectable=!0,o.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),_.current&&(_.current.style.display="none")}},[se,le,Y,C,O,te,M]),t.useEffect(()=>{const r=y=>{const l=Ie.current;if(l){if(y.key==="Escape")fe("select");else if(y.key==="Enter"&&se==="crop"){const n=$.current;if(n){const o=Math.max(0,Math.floor(n.left??0)),a=Math.max(0,Math.floor(n.top??0)),c=Math.max(1,Math.floor((n.width??0)*(n.scaleX??1))),w=Math.max(1,Math.floor((n.height??0)*(n.scaleY??1)));m.current={left:o,top:a,width:c,height:w};const S=new Hs({left:o,top:a,width:c,height:w,absolutePositioned:!0});l.clipPath=S;const L=l.getObjects().find(Q=>Q.name==="__background__");L&&L.set({left:o,top:a,width:c,height:w}),n.visible=!1,fe("select"),l.requestRenderAll();const q=Ie.current?()=>{const Q=Ie.current;if(!Q)return;const g=Q.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(g.objects)&&(g.objects=g.objects.map(P=>(P&&P.type==="image"&&P.originalUrl&&(P.src=P.originalUrl),P)));const f={canvasJson:g,appliedCrop:m.current},d=JSON.stringify(f);try{localStorage.setItem(`superCanvas:${E}`,d)}catch{}he(E)&&ce(P=>P.map(F=>F.id===E?{...F,data:{...F.data,canvasState:d}}:F))}:null;q&&q()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[se]),t.useEffect(()=>{const r=Ie.current;if(!r)return;const y=w=>{const S=r.getPointer(w.e);if(we.current=!0,oe.current={x:S.x,y:S.y},(se==="line"||se==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(L=>{L.name!=="__background__"&&L.name!=="__crop__"&&(L.selectable=!1,L.evented=!1)})),se==="line"){const L=[S.x,S.y,S.x,S.y],q=new sr(L,{strokeWidth:Y/2,fill:le,stroke:le,originX:"center",originY:"center",strokeLineCap:"round"});T.current=q,r.add(q)}else if(se==="arrow"){const L=[S.x,S.y,S.x,S.y],q=new sr(L,{strokeWidth:Y/2,fill:le,stroke:le,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});T.current=q,r.add(q)}else if(se==="text"){const L=new Ur("Type here",{left:S.x,top:S.y,fontFamily:"Arial",fill:le,fontSize:Y*10,width:300,splitByGrapheme:!0});L.lockScalingY=!1,L.lockScalingFlip=!0,L.lockUniScaling=!1,L.setControlsVisibility({mt:!1,mb:!1}),r.add(L),r.setActiveObject(L),L.enterEditing(),fe("select")}else if(se==="eraser"){const L=r.getObjects();for(let q=L.length-1;q>=0;q--){const Q=L[q];if(!(Q.name==="__background__"||Q.name==="__crop__"||Q.name==="__input_image__"||Q.sourceNodeId)&&Q.containsPoint(S)){r.remove(Q);break}}r.requestRenderAll()}},l=w=>{const S=r.getPointer(w.e);if(se==="brush"&&_.current){const q=r.getZoom(),Q=Y*q,g=Q/2;_.current.style.width=`${Q}px`,_.current.style.height=`${Q}px`,_.current.style.left=`${S.x*q-g}px`,_.current.style.top=`${S.y*q-g}px`,_.current.style.borderColor=`rgba(${parseInt(le.slice(1,3),16)},${parseInt(le.slice(3,5),16)},${parseInt(le.slice(5,7),16)},0.7)`,_.current.style.borderWidth="1px",_.current.style.background="transparent"}if(!we.current)return;const L=T.current;if(se==="line"&&L&&L instanceof sr)L.set({x2:S.x,y2:S.y}),L.setCoords(),r.requestRenderAll();else if(se==="arrow"&&L&&L instanceof sr)L.set({x2:S.x,y2:S.y}),L.setCoords(),r.requestRenderAll();else if(se==="eraser"){const q=r.getObjects();for(let Q=q.length-1;Q>=0;Q--){const g=q[Q];g.name==="__background__"||g.name==="__crop__"||g.name==="__input_image__"||g.sourceNodeId||g.containsPoint(S)&&r.remove(g)}r.requestRenderAll()}},n=()=>{if(we.current=!1,se==="arrow"&&T.current instanceof sr){const w=T.current,S=Math.atan2(w.y2-w.y1,w.x2-w.x1),L=Math.max(Y*10,120),q=Math.PI/6,Q=-Math.cos(S),g=-Math.sin(S),f=Math.cos(q),d=Math.sin(q),B=w.x2+L*(Q*f-g*d),P=w.y2+L*(Q*d+g*f),F=w.x2+L*(Q*f+g*d),X=w.y2+L*(-Q*d+g*f),ue=w.strokeWidth||Y/2,de=new sr([w.x2,w.y2,B,P],{stroke:le,strokeWidth:ue,strokeLineCap:"round"}),ie=new sr([w.x2,w.y2,F,X],{stroke:le,strokeWidth:ue,strokeLineCap:"round"});r.add(de),r.add(ie);const k=new va([w,de,ie],{selectable:!0,evented:!0});r.remove(w),r.remove(de),r.remove(ie),r.add(k)}T.current=null,(se==="line"||se==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(w=>{w.name!=="__background__"&&w.name!=="__crop__"&&(w.selectable=!1,w.evented=!1)}))},o=w=>{var Q;const S=w.target;if(!S)return;const L=S.type==="textbox"||S instanceof Ur,q=S.type==="i-text"||S instanceof Na;if(L||q){const g=(Q=w==null?void 0:w.transform)==null?void 0:Q.corner;if(g==="ml"||g==="mr"){const f=Math.max(50,(S.width||50)*(S.scaleX||1));S.set({width:f,scaleX:1,scaleY:1})}else{const f=S.scaleX||1,d=S.fontSize||40,B=Math.max(6,Math.min(512,Math.round(d*f)));S.set({fontSize:B,scaleX:1,scaleY:1})}S.setCoords(),r.requestRenderAll()}},a=()=>{se==="brush"&&_.current&&(_.current.style.display="block")},c=()=>{_.current&&(_.current.style.display="none")};return r.on("mouse:down",y),r.on("mouse:move",l),r.on("mouse:up",n),r.on("mouse:over",a),r.on("mouse:out",c),r.on("object:scaling",o),()=>{r.off("mouse:down",y),r.off("mouse:move",l),r.off("mouse:up",n),r.off("mouse:over",a),r.off("mouse:out",c),r.off("object:scaling",o)}},[se,le,Y]),e.jsxs("div",{ref:U,className:`relative flex flex-col w-[800px] h-auto bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yr,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:K,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:_,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:yr,label:"Select"},{id:"pencil",icon:Or,label:"Pencil"},{id:"brush",icon:Ia,label:"Brush"},{id:"line",icon:_a,label:"Line"},{id:"arrow",icon:ja,label:"Arrow"},{id:"text",icon:Ua,label:"Text"},{id:"eraser",icon:Ca,label:"Eraser"},{id:"crop",icon:Ea,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>fe(r.id),className:`p-2 rounded-lg transition-all ${se===r.id?"bg-purple-500/20 text-purple-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=Ie.current,y=r==null?void 0:r.getActiveObject();y&&(r==null||r.remove(y),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(Gr,{size:16})}),e.jsx("button",{onClick:()=>{const r=Ie.current,y=r==null?void 0:r.getActiveObject();y&&(r==null||r.bringObjectToFront(y),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Ra,{size:16})}),e.jsx("button",{onClick:()=>{const r=Ie.current,y=r==null?void 0:r.getActiveObject();if(y){r==null||r.sendObjectToBack(y);const l=r==null?void 0:r.getObjects().find(n=>n.name==="__background__");l&&(r==null||r.sendObjectToBack(l)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Ta,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:le,onChange:r=>Ce(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:se==="brush"?80:10,max:se==="brush"?400:30,value:Y,onChange:r=>{const y=parseInt(r.target.value);De(y)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:Y})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:se==="crop",onClick:async()=>{var ge,Se,ye;const r=Ie.current;if(!r)return;r.discardActiveObject();const y=[...r.viewportTransform],l=r.getWidth(),n=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(I),r.setHeight(I);const o=r.clipPath;r.clipPath=void 0;const a=m.current;let c="",w=C,S=O;a?(w=a.width,S=a.height,c=r.toDataURL({format:"png",quality:1,left:a.left,top:a.top,width:a.width,height:a.height,multiplier:1})):c=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:C,height:O}),r.clipPath=o,r.setViewportTransform(y),r.setWidth(l),r.setHeight(n),r.requestRenderAll();const L=`${w}:${S}`,q=he(E);if(!q)return;let Q=c;try{const _e=c.split(",")[1],je=atob(_e),Te=new Array(je.length);for(let Ft=0;Ft<je.length;Ft++)Te[Ft]=je.charCodeAt(Ft);const Re=new Uint8Array(Te),re=new Blob([Re],{type:"image/png"}),Be=`canvas-export-${Date.now()}.png`,qe=await Me.post("/assets/presigned-url",{fileName:Be,contentType:"image/png"});if(qe.success&&qe.data){const{uploadUrl:Ft,publicUrl:at}=qe.data;await(await gs(async()=>{const{default:Le}=await import("./utils-BcyDR7Vi.js");return{default:Le}},[])).default.put(Ft,re,{headers:{"Content-Type":"image/png"},timeout:3e5}),Q=at}}catch{}const g=Oe&&((ge=Oe())==null?void 0:ge.zoom)||1,f=document.querySelector(`.react-flow__node[data-id="${E}"]`),d=(f==null?void 0:f.getBoundingClientRect().width)||400,B=Math.round(d/g),P=400,F=(_e,je=300)=>{if(!_e||!/^[0-9]+\s*:\s*[0-9]+$/.test(_e))return je;const[Te,Re]=_e.split(":").map(re=>parseFloat(re));return!Te||!Re?je:Math.round(P*(Re/Te))},X=200,ue=100,de=F(L,300),ie=ve(),k=ee(),N=ie.filter(_e=>_e.type==="imagePreview"&&k.some(je=>je.source===E&&je.target===_e.id)).length,b=q.position.x+B+X,V=q.position.y+N*(de+ue),ne={id:`preview-${E}-${Date.now()}`,type:"imagePreview",position:{x:b,y:V},data:{imageUrl:Q,width:P,ratio:L,workflowContext:(Se=q.data)==null?void 0:Se.workflowContext,createdBy:(ye=q.data)==null?void 0:ye.createdBy}};ce(_e=>[..._e,ne]);const H={id:`edge-${E}-${ne.id}`,source:E,target:ne.id,targetHandle:`${ne.id}-target`,type:"aurora"};Z(_e=>_e.find(Te=>Te.source===E&&Te.target===ne.id)?_e:[..._e,H])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md",title:se==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(vt,{type:"target",position:dt.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-purple-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(vt,{type:"source",position:dt.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-purple-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Uo=t.memo(Ro),$o=({data:s,selected:E,id:u})=>{const[K,Ie]=t.useState(s.config.upscaleResolution||"1080p"),[U,ve]=t.useState(!1),[ee,ce]=t.useState(s.config.inputVideoUrl||""),[,Z]=t.useState(s.config.taskId||""),{setNodes:he,setEdges:Oe}=ts(),me=Ds(),ae=Fs(),se=Y=>{he(De=>De.map(we=>we.id===u?{...we,data:{...we.data,config:{...we.data.config,...Y}}}:we))};t.useEffect(()=>{var De,we,oe;const Y=ae.filter(T=>T.target===u);if(Y.length>0){const T=me.find($=>$.id===Y[0].source);if(T){const $=T.data,D=$.videoUrl||((De=$.config)==null?void 0:De.videoUrl)||((we=$.config)==null?void 0:we.outputVideoUrl)||((oe=$.config)==null?void 0:oe.resultUrl);D&&D!==ee&&(ce(D),se({inputVideoUrl:D}))}}else ee&&(ce(""),se({inputVideoUrl:""}))},[ae,me,u]),t.useEffect(()=>{const Y=s.config.taskId;(async()=>{if(Y)try{const oe=(await Me.get(`/tasks/${Y}`)).task;if(oe.status==="SUCCESS"){const T=oe.resultUrl;se({outputVideoUrl:T,taskId:""}),ae.filter(x=>x.source===u).map(x=>me.find(m=>m.id===x.target)).filter(x=>x&&x.type==="videoPreview").find(x=>x.data.videoUrl===T)||le(T),Dt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),ve(!1)}else oe.status==="PROCESSING"||oe.status==="PENDING"?(ve(!0),fe(Y)):oe.status==="FAILURE"&&(ve(!1),se({taskId:""}),Dt.error(oe.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${oe.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{ve(!1),se({taskId:""}),Dt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const fe=async Y=>{let we=0;const oe=async()=>{try{we++;const $=(await Me.get(`/tasks/${Y}`)).task;if($.status==="SUCCESS"){const D=$.resultUrl;ve(!1),se({outputVideoUrl:D,taskId:""}),le(D),Dt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if($.status==="FAILURE"){ve(!1),se({taskId:""}),Dt.error($.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else($.status==="PROCESSING"||$.status==="PENDING")&&(we<300?setTimeout(oe,3e3):(ve(!1),se({taskId:""}),Dt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{ve(!1),se({taskId:""}),Dt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};oe()},le=Y=>{var we;const De=me.find(oe=>oe.id===u);if(De){const oe=`preview-video-${Date.now()}`,T=K==="1080p"?"HD":K,$={id:oe,type:"videoPreview",position:{x:De.position.x+400,y:De.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:Y,ratio:"16:9",resolution:T,createdBy:(we=De.data)==null?void 0:we.createdBy}},D={id:`edge-${u}-${oe}`,source:u,target:oe,type:"aurora"};he(_=>[..._,$]),setTimeout(()=>{Oe(_=>[..._,D])},100)}},Ce=async()=>{var Y,De;if(!ee){Dt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}ve(!0);try{const we=await Me.get("/ai/models?provider=vidu&isActive=true");if(!we||we.length===0){Dt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),ve(!1);return}const oe=we[0],$=(await Me.post("/ai/video-upscale",{video_url:ee,upscale_resolution:K,apiKey:oe.apiKey,apiUrl:oe.apiUrl})).taskId;Z($),se({taskId:$,upscaleResolution:K}),Dt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),fe($)}catch(we){const oe=((De=(Y=we.response)==null?void 0:Y.data)==null?void 0:De.error)||we.message||"æœªçŸ¥åŸå› ";Dt.error(`å¯åŠ¨å¤±è´¥ï¼š${oe}ï¼Œè¯·ç¨åé‡è¯•`),ve(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(Xs,{type:"target",position:dt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[ee&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:ee,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(Y=>e.jsx("button",{type:"button",onClick:()=>{Ie(Y),se({upscaleResolution:Y})},disabled:U,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${K===Y?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${U?"opacity-50 cursor-not-allowed":""}`,children:Y},Y))})]}),e.jsx("button",{type:"button",onClick:Y=>{Y.preventDefault(),Y.stopPropagation(),Ce()},onMouseDown:Y=>{Y.stopPropagation()},disabled:U||!ee||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${U||!ee||s._canEdit===!1?"bg-slate-300 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[U?e.jsx(Qs,{className:"w-4 h-4 animate-spin"}):e.jsx(wa,{className:"w-4 h-4"}),e.jsx("span",{children:U?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(Xs,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Mo=t.memo($o),Do=({data:s,selected:E,id:u})=>{const[K,Ie]=t.useState(s.config.prompt||""),[U,ve]=t.useState(s.config.duration||30),[ee,ce]=t.useState(s.config.ratio||"16:9"),[Z,he]=t.useState(s.config.language||"zh"),[Oe,me]=t.useState(!1),[ae,se]=t.useState(s.config.images||[]),[,fe]=t.useState(s.config.taskId||""),{credits:le,loading:Ce}=Ls({nodeType:"ad_composition",duration:U}),{setNodes:Y,setEdges:De}=ts(),we=Ds(),oe=Fs(),T=x=>{Y(m=>m.map(I=>I.id===u?{...I,data:{...I.data,config:{...I.data.config,...x}}}:I))};t.useEffect(()=>{const x=oe.filter(I=>I.target===u),m=[];x.forEach(I=>{var M,C,O,r,y,l,n,o,a,c;const te=we.find(w=>w.id===I.source);te&&(te.type==="imagePreview"&&((M=te.data)!=null&&M.imageUrl)?m.push(te.data.imageUrl):te.type==="aiImage"&&((O=(C=te.data)==null?void 0:C.config)!=null&&O.generatedImageUrl)?m.push(te.data.config.generatedImageUrl):te.type==="upload"&&((y=(r=te.data)==null?void 0:r.config)!=null&&y.uploadedFiles)?te.data.config.uploadedFiles.filter(S=>S.type==="IMAGE"||(S.mimeType||"").startsWith("image/")).forEach(S=>m.push(S.url)):te.type==="assetSelector"&&((n=(l=te.data)==null?void 0:l.config)!=null&&n.subjects?te.data.config.subjects.forEach(S=>{Array.isArray(S.images)&&S.images.forEach(L=>m.push(L.url))}):((c=(a=(o=te.data)==null?void 0:o.config)==null?void 0:a.selectedAsset)==null?void 0:c.type)==="IMAGE"&&m.push(te.data.config.selectedAsset.url)))}),JSON.stringify(m)!==JSON.stringify(ae)&&(se(m),T({images:m}))},[oe,we,u]),t.useEffect(()=>{const x=s.config.taskId;(async()=>{if(x)try{const te=(await Me.get(`/tasks/${x}`)).task;if(te.status==="SUCCESS"){const M=te.resultUrl;T({taskId:""}),me(!1)}else te.status==="PROCESSING"||te.status==="PENDING"?(me(!0),$(x)):te.status==="FAILURE"&&(me(!1),T({taskId:""}),Dt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${te.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{me(!1),T({taskId:""})}})()},[]);const $=async x=>{let I=0;const te=async()=>{try{I++;const C=(await Me.get(`/tasks/${x}`)).task;if(C.status==="SUCCESS"){const O=C.resultUrl;me(!1),T({taskId:""}),D(O),Dt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(C.status==="FAILURE"){me(!1),T({taskId:""}),Dt.error(C.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(C.status==="PROCESSING"||C.status==="PENDING")&&(I<120?setTimeout(te,1e4):(me(!1),T({taskId:""}),Dt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{me(!1),T({taskId:""}),Dt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};te()},D=x=>{var I;const m=we.find(te=>te.id===u);if(m){const te=`preview-video-${Date.now()}`,M={id:te,type:"videoPreview",position:{x:m.position.x+400,y:m.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:x,ratio:ee,width:320,createdBy:(I=m.data)==null?void 0:I.createdBy}},C={id:`edge-${u}-${te}`,source:u,target:te,type:"aurora"};Y(O=>[...O,M]),setTimeout(()=>{De(O=>[...O,C])},100)}},_=async()=>{var x,m,I,te,M;if(ae.length===0){Dt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(ae.length>15){Dt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!K.trim()){Dt.error("è¯·è¾“å…¥æç¤ºè¯");return}me(!0);try{const C=await Me.get("/ai/models?provider=vidu&isActive=true");if(!C||C.length===0){Dt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),me(!1);return}const O=C[0],r={images:ae,prompt:K,duration:U,ratio:ee,language:Z,apiKey:O.apiKey,apiUrl:O.apiUrl},y=await Me.post("/ai/commercial-video",r),l=y.taskId,n=y.creditsCharged||0;if(fe(l),T({taskId:l,images:ae,prompt:K,duration:U,ratio:ee,language:Z}),n>0)try{const{useAuthStore:o}=await gs(async()=>{const{useAuthStore:c}=await import("./index-DOiS8MNr.js").then(w=>w.f);return{useAuthStore:c}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:a}=o.getState();await a(),Dt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${n} ç§¯åˆ†ï¼‰`)}catch{Dt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Dt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");$(l)}catch(C){((x=C.response)==null?void 0:x.status)===403?Dt.error(((I=(m=C.response)==null?void 0:m.data)==null?void 0:I.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Dt.error(((M=(te=C.response)==null?void 0:te.data)==null?void 0:M.error)||C.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),me(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${E?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(Xs,{type:"target",position:dt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",ae.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:K,onChange:x=>{Ie(x.target.value),T({prompt:x.target.value}),x.target.style.height="auto",x.target.style.height=x.target.scrollHeight+"px"},onFocus:x=>{x.target.style.height="auto",x.target.style.height=x.target.scrollHeight+"px"},ref:x=>{x&&K&&(x.style.height="auto",x.style.height=x.scrollHeight+"px")},disabled:Oe,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(x=>e.jsxs("button",{type:"button",onClick:()=>{ve(x),T({duration:x})},disabled:Oe,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${U===x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Oe?"opacity-50 cursor-not-allowed":""}`,children:[x,"s"]},x))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(x=>e.jsx("button",{type:"button",onClick:()=>{ce(x),T({ratio:x})},disabled:Oe,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${ee===x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Oe?"opacity-50 cursor-not-allowed":""}`,children:x},x))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(x=>e.jsx("button",{type:"button",onClick:()=>{he(x.value),T({language:x.value})},disabled:Oe,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Z===x.value?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Oe?"opacity-50 cursor-not-allowed":""}`,children:x.label},x.value))})]}),e.jsx("button",{type:"button",onClick:_,disabled:Oe||ae.length===0||!K.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Oe||ae.length===0||!K.trim()||s._canEdit===!1?"bg-slate-300 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Oe?e.jsx(Qs,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:Oe?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Oe&&!Ce&&le!==null&&le>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[le,"ç§¯åˆ†"]})]})})]}),e.jsx(Xs,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Lo=t.memo(Do),Po=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],Oo=({data:s,selected:E,id:u})=>{const{setNodes:K}=ts(),[Ie,U]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[ve,ee]=t.useState(!1),[ce,Z]=t.useState(!1),[he,Oe]=t.useState(s.fontSize||36),[me,ae]=t.useState(s.width||200),[se,fe]=t.useState(s.bold||!1),le=t.useRef(null),Ce=t.useRef(null),Y=t.useCallback(oe=>{K(T=>T.map($=>$.id===u?{...$,data:{...$.data,...oe}}:$))},[u,K]);t.useEffect(()=>{const oe=setTimeout(()=>{Ie!==s.text&&Y({text:Ie})},300);return()=>clearTimeout(oe)},[Ie,s.text,Y]),t.useEffect(()=>{Y({fontSize:he,width:me,bold:se})},[he,me,se,Y]);const De=()=>{ee(!0),setTimeout(()=>{le.current&&(le.current.focus(),le.current.select(),le.current.style.height="auto",le.current.style.height=`${le.current.scrollHeight}px`)},0)},we=()=>{ee(!1)};return t.useEffect(()=>{ve&&le.current&&(le.current.style.height="auto",le.current.style.height=`${le.current.scrollHeight}px`)},[ve,Ie]),t.useEffect(()=>{const oe=T=>{Ce.current&&!Ce.current.contains(T.target)&&Z(!1)};return ce&&document.addEventListener("mousedown",oe),()=>document.removeEventListener("mousedown",oe)},[ce]),e.jsxs("div",{className:`relative group ${E?"ring-2 ring-purple-400 ring-offset-2":""}`,style:{width:me},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:oe=>{oe.stopPropagation(),Z(!ce)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),ce&&e.jsxs("div",{ref:Ce,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:oe=>oe.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:he,onChange:oe=>Oe(Number(oe.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-purple-400",children:Po.map(oe=>e.jsxs("option",{value:oe,children:[oe,"px"]},oe))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>fe(!se),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${se?"bg-purple-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),ve?e.jsx("textarea",{ref:le,value:Ie,onChange:oe=>U(oe.target.value),onBlur:we,onMouseDown:oe=>oe.stopPropagation(),onKeyDown:oe=>{oe.key==="Escape"&&ee(!1)},className:"nodrag w-full bg-transparent border-2 border-purple-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${he}px`,fontWeight:se?"bold":"normal"}}):e.jsx("div",{onDoubleClick:De,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${he}px`,fontWeight:se?"bold":"normal"},children:Ie}),!ve&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:oe=>{oe.stopPropagation(),oe.preventDefault();const T=oe.clientX,$=me,D=x=>{x.preventDefault();const m=Math.max(100,$+(x.clientX-T));ae(m)},_=()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",_)};document.addEventListener("mousemove",D),document.addEventListener("mouseup",_)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Go=t.memo(Oo),Vo=({data:s,id:E,selected:u})=>{const{getNode:K,setNodes:Ie,setEdges:U}=ts(),ve=dr(t.useCallback(f=>f.edges.filter(d=>d.target===E),[E])),[ee,ce]=t.useState(s.prompt||""),[Z,he]=t.useState(s.points||[]),[Oe,me]=t.useState(!1),[ae,se]=t.useState(!1),[fe,le]=t.useState(null),[Ce,Y]=t.useState([]),[,De]=t.useState(s.generatedImageUrl||null),[we,oe]=t.useState(null),[,T]=t.useState(s.taskId||""),[,$]=t.useState(0),D=t.useRef(null),_=t.useRef(1),{credits:x,loading:m,isFreeUsage:I,freeUsageRemaining:te,refetch:M}=Ls({nodeType:"image_editing",quantity:1}),C=t.useCallback(f=>{Ie(d=>d.map(B=>B.id===E?{...B,data:{...B.data,...f}}:B))},[E,Ie]),O=dr(t.useCallback(f=>f.edges.filter(d=>d.source===E),[E])),r=t.useCallback(f=>{var ue,de;const d=K(E);if(!d)return;const B=O.find(ie=>{const k=K(ie.target);return(k==null?void 0:k.type)==="imagePreview"});if(B){const ie=B.target;Ie(k=>k.map(p=>p.id===ie?{...p,data:{...p.data,imageUrl:f}}:p));return}const P=Date.now(),F=`preview-${E}-${P}`,X={id:F,type:"imagePreview",position:{x:(((ue=d==null?void 0:d.position)==null?void 0:ue.x)||0)+450,y:((de=d==null?void 0:d.position)==null?void 0:de.y)||0},data:{imageUrl:f,width:400}};setTimeout(()=>{Ie(k=>[...k,X]);const ie={id:`edge-${E}-${F}`,source:E,target:F,targetHandle:`${F}-target`,type:"aurora"};U(k=>k.find(N=>N.source===E&&N.target===F)?k:[...k,ie])},100)},[E,K,Ie,U,O]),y=t.useRef({active:!1,timeoutId:null}),l=t.useCallback(async f=>{let B=0;y.current.timeoutId&&clearTimeout(y.current.timeoutId),y.current.active=!0;const P=async()=>{if(y.current.active)try{B++;const X=(await Me.tasks.getTaskStatus(f)).task;if(!y.current.active)return;if($(X.progress||0),X.status==="SUCCESS"){y.current.active=!1,me(!1),$(100);const ue=X.resultUrl;C({generatedImageUrl:ue,taskId:""}),De(ue),h.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ue&&r(ue);return}else if(X.status==="FAILURE"){y.current.active=!1,me(!1),$(0),C({taskId:""}),h.error(X.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(X.status==="PROCESSING"||X.status==="PENDING")&&(B<300&&y.current.active?y.current.timeoutId=setTimeout(P,1e3):(y.current.active=!1,me(!1),$(0),C({taskId:""}),h.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{y.current.active=!1,me(!1),$(0),C({taskId:""}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};P()},[C,r]);t.useEffect(()=>()=>{y.current.active=!1,y.current.timeoutId&&clearTimeout(y.current.timeoutId)},[]),t.useEffect(()=>{const f=s.taskId;if(!f)return;(async()=>{try{const P=(await Me.tasks.getTaskStatus(f)).task;if(P.status==="SUCCESS"){me(!1),$(100);const F=P.resultUrl;F?(C({generatedImageUrl:F,taskId:""}),De(F),h.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):C({taskId:""})}else P.status==="PROCESSING"||P.status==="PENDING"?(me(!0),$(P.progress||0),l(f)):P.status==="FAILURE"&&(me(!1),$(0),C({taskId:""}),h.error(P.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${P.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{me(!1),$(0),C({taskId:""})}})()},[]);const n=t.useCallback(f=>{const d=new Image;d.onload=()=>{oe({width:d.naturalWidth,height:d.naturalHeight})},d.src=f},[]);t.useEffect(()=>{try{const f=[];ve.forEach(d=>{var X,ue,de,ie;const B=K(d.source);if(!B)return;const P=B.data;let F=null;P!=null&&P.url?F=P.url:P!=null&&P.imageUrl?F=P.imageUrl:P!=null&&P.output?F=P.output:(X=P==null?void 0:P.config)!=null&&X.generatedImageUrl?F=P.config.generatedImageUrl:(ie=(de=(ue=P==null?void 0:P.config)==null?void 0:ue.uploadedFiles)==null?void 0:de[0])!=null&&ie.url&&(F=P.config.uploadedFiles[0].url),F&&f.push(F)}),f.length>0?(le(f[0]),Y(f.slice(1)),n(f[0])):(le(null),Y([]),oe(null))}catch{}},[ve,K,n]),t.useEffect(()=>{const f=setTimeout(()=>{Ie(d=>d.map(B=>{if(B.id!==E)return B;const P=B.data;return P.prompt===ee&&JSON.stringify(P.points)===JSON.stringify(Z)?B:{...B,data:{...B.data,prompt:ee,points:Z}}}))},300);return()=>clearTimeout(f)},[ee,Z,E,Ie]);const o=t.useCallback(f=>{if(!f.ctrlKey&&!f.metaKey||!D.current)return;const d=D.current.getBoundingClientRect(),B=(f.clientX-d.left)/d.width,P=(f.clientY-d.top)/d.height,F={id:_.current++,x:Math.max(0,Math.min(1,B)),y:Math.max(0,Math.min(1,P))};he(X=>[...X,F])},[]),a=t.useCallback(f=>{he(d=>d.filter(B=>B.id!==f))},[]),c=t.useCallback((f,d)=>{he(B=>B.map(P=>P.id===f?{...P,name:d}:P))},[]),w=t.useCallback((f,d)=>{f.stopPropagation();const B=d.name?`@${d.name}`:`@ä½ç½®${d.id}`;f.dataTransfer.setData("text/plain",B),f.dataTransfer.effectAllowed="copy"},[]),S=t.useCallback((f,d)=>{f.stopPropagation();const B=`@å‚è€ƒå›¾${d+1}`;f.dataTransfer.setData("text/plain",B),f.dataTransfer.effectAllowed="copy"},[]),L=t.useCallback(f=>{f.preventDefault(),f.stopPropagation(),f.dataTransfer.dropEffect="copy"},[]),q=t.useCallback(f=>{f.preventDefault(),f.stopPropagation();const d=f.dataTransfer.getData("text/plain");if(d){const B=f.target,P=B.selectionStart,F=B.selectionEnd,X=ee.slice(0,P)+d+ee.slice(F);ce(X),setTimeout(()=>{B.selectionStart=B.selectionEnd=P+d.length,B.focus()},0)}},[ee]),Q=t.useCallback(async()=>{var f;if(!(!fe||Z.length===0)){se(!0);try{const d=await Me.ai.imageEditing.identifyPoints({image:fe,points:Z.map(B=>({id:B.id,x:B.x,y:B.y}))});if(d.success&&((f=d.data)!=null&&f.points)){const B=d.data.points;he(P=>P.map(F=>{const X=B.find(ue=>ue.id===F.id);return X?{...F,name:X.name}:F})),h.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{h.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{se(!1)}}},[fe,Z]),g=t.useCallback(async()=>{var f,d,B,P,F;if(!fe){h.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!ee.trim()){h.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}me(!0),$(0);try{const X=await Me.tasks.createImageEditTask({prompt:ee.trim(),mainImage:fe,referenceImages:Ce.length>0?Ce:void 0,points:Z.length>0?Z:void 0,sourceImageDimensions:we||void 0,sourceNodeId:E}),ue=X.taskId,de=X.creditsCharged||0,ie=X.isFreeUsage,k=X.freeUsageRemaining??0;if(T(ue),C({prompt:ee.trim(),points:Z,taskId:ue}),ie)h.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${k} æ¬¡æœºä¼š`),M();else if(de>0){const{useAuthStore:p}=await gs(async()=>{const{useAuthStore:b}=await import("./index-DOiS8MNr.js").then(V=>V.f);return{useAuthStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:N}=p.getState();await N(),h.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${de} ç§¯åˆ†`),M()}else h.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");l(ue)}catch(X){if(me(!1),$(0),((f=X.response)==null?void 0:f.status)===403){const ue=((B=(d=X.response)==null?void 0:d.data)==null?void 0:B.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";h.error(ue)}else{const ue=((F=(P=X.response)==null?void 0:P.data)==null?void 0:F.error)||X.message||"æœªçŸ¥åŸå› ";h.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ue}ï¼Œè¯·ç¨åé‡è¯•`)}}},[fe,ee,Ce,Z,we,E,C,l,M]);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${E}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(vt,{type:"source",position:dt.Right,id:`${E}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 from-pink-200/50 via-purple-500/20 via-purple-200/50 to-cyan-500/20 to-cyan-200/50 dark:from-pink-500/20 dark:via-purple-500/20 dark:to-cyan-500/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Or,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:D,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:o,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:fe,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),Z.map(f=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${f.x*100}%`,top:`${f.y*100}%`},onClick:d=>{d.stopPropagation(),a(f.id)},title:f.name||`ç‚¹å‡»åˆ é™¤ #${f.id}`,children:f.id},f.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(yr,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),Ce.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[Ce.map((f,d)=>e.jsx("img",{src:f,alt:`Ref ${d+1}`,draggable:!0,onDragStart:B=>S(B,d),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},d)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",Ce.length," å‚è€ƒå›¾"]})]}),Z.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",Z.length,")"]}),e.jsxs("button",{onClick:Q,disabled:ae||!fe,className:"text-[10px] text-purple-500 hover:text-purple-600 disabled:opacity-50 flex items-center gap-1",children:[ae?e.jsx(Qs,{className:"w-3 h-3 animate-spin"}):e.jsx(hr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:Z.map(f=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:d=>w(d,f),className:"w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:f.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:f.name||"",onChange:d=>c(f.id,d.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>a(f.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Gr,{className:"w-3 h-3"})})]},f.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:ee,onChange:f=>ce(f.target.value),onDragOver:L,onDrop:q,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:g,onPointerDown:f=>f.stopPropagation(),onMouseDown:f=>f.stopPropagation(),disabled:Oe||!fe||!ee.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${Oe?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Oe?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!m&&(I?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",te,"æ¬¡"]}):x!==null&&x>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[x,"ç§¯åˆ†"]}):null)]})})]})]})},Wo=t.memo(Vo),Fo="https://api.waule.com",zo=({isOpen:s,onClose:E,onAssetSelect:u})=>{const[K,Ie]=t.useState([]),[U,ve]=t.useState(""),[ee,ce]=t.useState([]),[Z,he]=t.useState([]),[Oe,me]=t.useState(!1),[ae,se]=t.useState("ALL"),[fe,le]=t.useState("ALL");t.useEffect(()=>{s&&Ce()},[s]),t.useEffect(()=>{U&&De(U)},[U]),t.useEffect(()=>{if(!s)return;const T=fe==="ALL"?K:K.filter($=>($.category||"OTHER")===fe);ve(T.length>0?T[0].id:"")},[fe,K,s]);const Ce=async()=>{try{const $=(await Me.assetLibraries.getAll({includeShared:"true"})).data||[];if(Ie($),$.length>0&&!U){const D=fe==="ALL"?$:$.filter(_=>(_.category||"OTHER")===fe);ve((D[0]||$[0]).id)}}catch{h.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const T=$=>{var _;const D=((_=$==null?void 0:$.detail)==null?void 0:_.libraryId)||U;Ce(),D&&De(D)};return window.addEventListener("asset-library-updated",T),()=>window.removeEventListener("asset-library-updated",T)},[U]);const Y=T=>(/^https?:\/\//.test(T)?T:`${Fo}${T}`).replace(".oss-oss-",".oss-"),De=async T=>{var $,D,_,x,m;me(!0);try{const I=K.find(M=>M.id===T);if(I&&(I.category||"OTHER")==="ROLE"){const C=(await Me.assetLibraries.roles.list(T)).data||[],O=[];for(const r of C){const y=r.metadata||{},l=[($=y.images)==null?void 0:$.frontAssetId,(D=y.images)==null?void 0:D.sideAssetId,(_=y.images)==null?void 0:_.backAssetId,(x=y.images)==null?void 0:x.faceAssetId].filter(Boolean),n=[];for(const a of l)try{const w=(await Me.assets.getById(a)).data;n.push({id:w.id,url:Y(w.url),name:w.name})}catch{}const o=r.thumbnail?Y(r.thumbnail):((m=n[0])==null?void 0:m.url)||"";O.push({id:r.id,name:r.name,coverUrl:o,images:n})}he(O),ce([])}else{const C=(await Me.assetLibraries.getAssets(T)).data||[];ce(C),he([])}}catch{h.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{me(!1)}},we=T=>{ve(T)},oe=T=>{u?(u(T),setTimeout(()=>{Ce(),U&&De(U)},0)):h.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:E}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-purple-500/30 via-pink-500/50 to-cyan-500/30"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:E,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:K.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(T=>e.jsx("button",{onClick:()=>se(T),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${ae===T?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"}`,children:T==="IMAGE"?"å›¾ç‰‡":T==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},T))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["ROLE","SCENE","PROP","OTHER"].map(T=>e.jsx("button",{onClick:()=>le(T),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${fe===T?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"}`,children:T==="ROLE"?"è§’è‰²åº“":T==="SCENE"?"åœºæ™¯åº“":T==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"},T))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const T=fe==="ALL"?K:K.filter($=>($.category||"OTHER")===fe);return e.jsx("select",{value:U,onChange:$=>we($.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:T.map($=>{var D;return e.jsxs("option",{value:$.id,children:[$.isShared?`[å…±äº«] ${$.name}`:$.name," (",$._count.assets,")",$.isShared&&((D=$.owner)!=null&&D.nickname)?` - ${$.owner.nickname}`:""]},$.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Oe?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const T=K.find(_=>_.id===U);if(T&&(T.category||"OTHER")==="ROLE")return Z.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:Z.map(_=>e.jsxs("div",{onClick:()=>u&&u(_),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[_.coverUrl?e.jsx("img",{src:_.coverUrl,alt:_.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:_.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[_.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},_.id))});const D=ee.filter(_=>ae==="ALL"||_.type===ae);return D.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:D.map(_=>e.jsxs("div",{onClick:()=>oe(_),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[_.type==="IMAGE"?e.jsx("img",{src:Y(_.url),alt:_.name,className:"w-full h-full object-cover"}):_.type==="VIDEO"?e.jsx("video",{src:Y(_.url),className:"w-full h-full object-cover"}):_.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:_.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:_.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:_.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(_.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:_.type==="IMAGE"?"image":_.type==="VIDEO"?"video_file":_.type==="AUDIO"?"audio_file":"description"})})]},_.id))})})()})]})})]})]}):null},Bo={agent:ao,aiImage:Pa,aiVideo:nr,soraVideo:bo,soraCharacter:yo,aiVideo_t2v:Va,aiVideo_i2v_first:Fa,aiVideo_i2v_last:Ba,aiVideo_first_last:Xa,aiVideo_reference:qa,aiVideo_swap:Ka,aiVideo_lipsync:Za,aiVideo_style:so,upload:no,assetSelector:lo,imagePreview:uo,videoPreview:fo,textPreview:ho,midjourney:mo,audioVoice:vo,voiceClone:jo,audioSynthesize:So,audioDesign:To,audioPreview:Ao,superCanvas:Uo,videoUpscale:Mo,commercialVideo:Lo,textAnnotation:Go,imageEditing:Wo},Ho={aurora:Eo},Xo=()=>{const{id:s,projectId:E,episodeId:u,workflowId:K}=ia(),Ie=!!K,U=la(),ve=Pr(),ee=t.useMemo(()=>new URLSearchParams(ve.search),[ve.search]),ce=t.useMemo(()=>{const i=Number(ee.get("scene"));return Number.isFinite(i)&&i>0?i:void 0},[ee]),Z=t.useMemo(()=>{const i=Number(ee.get("shot"));return Number.isFinite(i)&&i>0?i:void 0},[ee]),{screenToFlowPosition:he,setCenter:Oe,getViewport:me,fitView:ae}=ts(),{setTitle:se}=da(),fe=kr(i=>i.user),[le,Ce]=t.useState(null),[Y,De]=t.useState(null),[we,oe]=t.useState(!0),[T,$,D]=fa([]),[_,x,m]=ga([]),[I,te]=t.useState(!1),M=t.useRef(!1),[C,O]=t.useState(null),[r,y]=t.useState(null),[l,n]=t.useState(!0),o=t.useRef(null),[a,c]=t.useState(!1),w=t.useRef(null),[S,L]=t.useState(!1),[q,Q]=t.useState(null),[g,f]=t.useState([]),[d,B]=t.useState([]),[P,F]=t.useState(null),[X,ue]=t.useState(null),de=t.useRef(null),ie=t.useRef(null),k=P==="video",p=P==="edit",N=i=>F(null),b=i=>F(i?"video":null),V=i=>F(i?"edit":null),ne=de,H=X==="agent",ge=i=>ue(i?"agent":null),Se=ie,ye=ie,_e=t.useCallback(i=>{const v=(i||"").toLowerCase().replace(/[_\-\s]+/g," ");return v?v.includes("æ–‡ç”Ÿ")||v.includes("text to video")||v.includes("t2v")||v.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":v.includes("é¦–å°¾")||v.includes("first last")||v.includes("two frame")||v.includes("frame pair")||v.includes("first-last")?"é¦–å°¾å¸§":v.includes("é¦–å¸§")||v.includes("first frame")||v.includes("start frame")||v.includes("initial frame")||v.includes("keyframe")?"é¦–å¸§":v.includes("å°¾å¸§")||v.includes("last frame")||v.includes("end frame")||v.includes("final frame")?"å°¾å¸§":v.includes("ä¸»ä½“å‚è€ƒ")||v.includes("subject reference")||v.includes("å‚è€ƒ")||v.includes("reference image")||v.includes("image reference")||v.includes("ref image")?"å‚è€ƒå›¾":i||"":""},[]),je=t.useMemo(()=>{const i=new Set;return(g||[]).filter(R=>(R.type||"")==="VIDEO_GENERATION").forEach(R=>{var J;(Array.isArray((J=R==null?void 0:R.config)==null?void 0:J.supportedGenerationTypes)?R.config.supportedGenerationTypes:[]).forEach(be=>{const Ee=_e(be);Ee&&i.add(Ee)})}),i},[g,_e]),Te=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Re=t.useCallback(i=>{const v=(g||[]).filter(J=>(J.type||"")==="VIDEO_EDITING").filter(J=>{var be;return Array.isArray((be=J==null?void 0:J.config)==null?void 0:be.supportedEditingCapabilities)&&J.config.supportedEditingCapabilities.includes(i)}),R=(g||[]).filter(J=>(J.type||"")==="VIDEO_GENERATION").filter(J=>{var ze,Fe;if(i!=="è§†é¢‘æ¢äºº")return!1;const be=((ze=J==null?void 0:J.config)==null?void 0:ze.supportsVideoEditing)===!0,$e=(Array.isArray((Fe=J==null?void 0:J.config)==null?void 0:Fe.supportedGenerationTypes)?J.config.supportedGenerationTypes:[]).some(Ke=>_e(Ke)==="è§†é¢‘æ¢äºº");return be||$e}),W={};return[...v,...R].forEach(J=>{W[J.id]||(W[J.id]=J)}),Object.values(W)},[g,_e]),[re,Be]=t.useState(!1),[qe,Ft]=t.useState(null),at=t.useRef(null),ot=t.useRef(),[Le,ut]=t.useState([]),[Et,nt]=t.useState(null),[yt,Ot]=t.useState(null),[tt,_t]=t.useState(!1),[Kt,bs]=t.useState(null),[cs,Rs]=t.useState(null),[ws,zs]=t.useState(null),Nt=t.useRef([]),Ps=t.useRef(null),[ys,Zs]=t.useState(!1),[hs,Js]=t.useState(!1),[qs,rr]=t.useState(0),Ss=t.useRef(null),Ns=t.useRef(null),ms=t.useRef([]),Es=t.useRef([]),Ys=t.useRef(0),G=!!u,z=G&&!!ce&&!!Z,Pe=Ie?K:z?`${u}-${ce}-${Z}`:G?u:s,Ue=z,[Xe,We]=t.useState(!1),Ye=t.useRef(new Set),ct=t.useRef(new Set),j=t.useRef(new Set),A=t.useRef(new Set),pe=t.useRef(new Map),Ae=t.useRef(new Set),Ne=t.useCallback((i,v)=>{v!==o.current&&(Ye.current.add(i.id),$(R=>R.some(W=>W.id===i.id)?R:[...R,{...i,data:{...i.data,models:g}}]))},[g,$]),xe=t.useCallback((i,v,R)=>{R!==o.current&&(Ae.current.add(i),$(W=>W.map(J=>J.id===i?{...J,data:{...J.data,...v}}:J)),setTimeout(()=>Ae.current.delete(i),100))},[$]),Qe=t.useCallback((i,v)=>{v!==o.current&&($(R=>R.filter(W=>W.id!==i)),x(R=>R.filter(W=>W.source!==i&&W.target!==i)))},[$,x]),Ze=t.useCallback((i,v,R)=>{R!==o.current&&$(W=>W.map(J=>J.id===i?{...J,position:v}:J))},[$]),xt=t.useCallback((i,v)=>{v!==o.current&&$(R=>R.map(W=>{const J=i.find(be=>be.id===W.id);return J?{...W,position:J.position}:W}))},[$]),it=t.useCallback((i,v)=>{v!==o.current&&(ct.current.add(i.id),x(R=>R.some(W=>W.id===i.id)?R:[...R,i]))},[x]),Ge=t.useCallback((i,v)=>{v!==o.current&&x(R=>R.filter(W=>W.id!==i))},[x]),Rt=t.useCallback((i,v)=>{v!==o.current&&(ut(i),Nt.current=i)},[]),{emitNodeAdd:Bt,emitNodeUpdate:$t,emitNodeDelete:Gt,emitNodesMove:wt,emitEdgeAdd:It,emitEdgeDelete:Mt,emitGroupsUpdate:Lt,onlineUsers:es}=Ma({workflowId:w.current,isSharedWorkflow:a,isReadOnly:I,onNodeAdd:Ne,onNodeUpdate:xe,onNodeDelete:Qe,onNodeMove:Ze,onNodesMove:xt,onEdgeAdd:it,onEdgeDelete:Ge,onGroupsUpdate:Rt});t.useEffect(()=>{Nt.current=Le},[Le]),t.useEffect(()=>{ms.current=T,Ys.current=T.length},[T]),t.useEffect(()=>{Es.current=_},[_]),t.useEffect(()=>{if(!Xe){j.current=new Set(T.map(J=>J.id));const W=new Map;T.forEach(J=>{var be;try{W.set(J.id,JSON.stringify(((be=J.data)==null?void 0:be.config)||{}))}catch{W.set(J.id,"{}")}}),pe.current=W;return}if(!a||M.current){j.current=new Set(T.map(W=>W.id));return}const i=new Set(T.map(W=>W.id)),v=j.current;T.forEach(W=>{var J,be;if(!v.has(W.id))Ye.current.has(W.id)||Bt(W);else if(!Ae.current.has(W.id))try{const Ee=JSON.stringify(((J=W.data)==null?void 0:J.config)||{}),$e=pe.current.get(W.id)||"{}";Ee!==$e&&$t(W.id,{config:(be=W.data)==null?void 0:be.config})}catch{}}),j.current=i;const R=new Map;T.forEach(W=>{var J;try{R.set(W.id,JSON.stringify(((J=W.data)==null?void 0:J.config)||{}))}catch{R.set(W.id,"{}")}}),pe.current=R,Ye.current=new Set([...Ye.current].filter(W=>i.has(W)))},[T,a,Xe,Bt,$t]),t.useEffect(()=>{if(!Xe){A.current=new Set(_.map(R=>R.id));return}if(!a||M.current){A.current=new Set(_.map(R=>R.id));return}const i=new Set(_.map(R=>R.id)),v=A.current;_.forEach(R=>{v.has(R.id)||ct.current.has(R.id)||It(R)}),A.current=i,ct.current=new Set([...ct.current].filter(R=>i.has(R)))},[_,a,Xe,It]);const ns=t.useCallback(i=>{var J;if(M.current)return!1;if(l)return!0;if(Nt.current.some(be=>{var Ee;return!be.hidden&&((Ee=be.nodeIds)==null?void 0:Ee.includes(i.id))}))return!1;if(z)return!0;const R=(J=i.data)==null?void 0:J.createdBy;return(typeof R=="object"?R==null?void 0:R.id:R)===o.current},[l,z]),Cs=t.useMemo(()=>{const i=new Set(Le.filter(v=>!v.hidden).flatMap(v=>v.nodeIds||[]));return T.map(v=>{const R=i.has(v.id),W=R?!1:l?!0:ns(v);return{...v,draggable:v.draggable!==!1,connectable:R?!1:v.connectable!==!1,data:{...v.data,_canEdit:W,_isGrouped:R,_currentUserId:r,_isSharedWorkflow:a}}})},[T,Le,l,ns,r,a,I]),er=t.useRef(null),Us=t.useRef(new Map),xs=t.useCallback(i=>{if(M.current){D(i);return}const v=i.filter(W=>{var ze;if(W.type!=="position")return!0;if(Nt.current.find(Fe=>{var Ke;return!Fe.hidden&&((Ke=Fe.nodeIds)==null?void 0:Ke.includes(W.id))}))return l;if(l)return!0;const be=ms.current.find(Fe=>Fe.id===W.id);if(!be)return!0;const Ee=(ze=be.data)==null?void 0:ze.createdBy;return(typeof Ee=="object"?Ee==null?void 0:Ee.id:Ee)===o.current});D(v);const R=v.filter(W=>W.type==="position"&&W.position);R.length>0&&(R.forEach(W=>{Us.current.set(W.id,W.position)}),er.current&&clearTimeout(er.current),er.current=setTimeout(()=>{const W=Array.from(Us.current.entries()).map(([J,be])=>({id:J,position:be}));W.length>0&&(wt(W),Us.current.clear())},100))},[l,D,wt]);t.useEffect(()=>{Ps.current=cs},[cs]),t.useEffect(()=>{const i=v=>{v.key==="Escape"&&(ys&&Zs(!1),hs&&Js(!1))};return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[ys,hs]),t.useEffect(()=>{Pe&&(L(!1),We(!1),Os(),js(),ks(),zt().finally(()=>{We(!0)}))},[Pe]),t.useEffect(()=>{if(!we&&!S&&T.length>0){const i=setTimeout(()=>{ae({padding:.1,duration:800,maxZoom:1.5}),L(!0)},100);return()=>clearTimeout(i)}},[we,S,T.length,ae]),t.useEffect(()=>{var R,W;if(!z||!Y||!le||!Xe)return;const i=Le.find(J=>J.scene===ce&&J.shot===Z);if(i){Ot(i.id),nt(i.id);try{const J=((R=Y==null?void 0:Y.scriptJson)==null?void 0:R.acts)||[],be=Array.isArray(J)?J.find(Ke=>Number(Ke.actIndex)===Number(ce)):null,Ee=be?(be.shots||[]).find(Ke=>Number(Ke.shotIndex)===Number(Z)):null,ze=Ee?[`ç”»é¢ï¼š${(Ee.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(Ee["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(Ee["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(Ee["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(Ee.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=Ee&&(Ee.æç¤ºè¯||"").trim()||"";$(Ke=>Ke.map(Ve=>{var ht;if(Ve.type!=="textPreview")return Ve;const Je=((ht=Ve.data)==null?void 0:ht.title)||"";return Je==="åˆ†é•œè®¾è®¡"?{...Ve,data:{...Ve.data,content:ze||"æš‚æ— åˆ†é•œæ–‡æœ¬"}}:Je==="æç¤ºè¯"?{...Ve,data:{...Ve.data,content:Fe||"æš‚æ— æç¤ºè¯"}}:Ve}))}catch{}return}const v={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${ce}å¹•-ç¬¬${Z}é•œ`,scene:ce,shot:Z,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};ut(J=>[...J,v]),Nt.current=[...Nt.current,v],Ot(v.id),nt(v.id);try{const J=((W=Y==null?void 0:Y.scriptJson)==null?void 0:W.acts)||[],be=Array.isArray(J)?J.find(kt=>Number(kt.actIndex)===Number(ce)):null,Ee=be?(be.shots||[]).find(kt=>Number(kt.shotIndex)===Number(Z)):null,ze=Ee?[`ç”»é¢ï¼š${(Ee.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(Ee["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(Ee["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(Ee["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(Ee.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=Ee&&(Ee.æç¤ºè¯||"").trim()||"",Ke={x:0,y:0},Ve={x:560,y:0},Je=`textPreview-${Date.now()}-a`,ht=`textPreview-${Date.now()}-b`,Ht=[{id:Je,type:"textPreview",position:Ke,data:{content:ze||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:Je,freeDrag:!0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:le,episode:Y,nodeGroup:v,nodeGroups:[...Le,v]}}},{id:ht,type:"textPreview",position:Ve,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:ht,freeDrag:!0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:le,episode:Y,nodeGroup:v,nodeGroups:[...Le,v]}}}];$(kt=>[...kt,...Ht]),ut(kt=>kt.map(Pt=>{if(Pt.id!==v.id)return Pt;const St=Array.from(new Set([...Pt.nodeIds||[],Je,ht])),pt=Pt.bounds;return{...Pt,nodeIds:St,bounds:pt}})),Nt.current=Nt.current.map(kt=>{if(kt.id!==v.id)return kt;const Pt=Array.from(new Set([...kt.nodeIds||[],Je,ht])),St=kt.bounds;return{...kt,nodeIds:Pt,bounds:St}})}catch{}},[G,ce,Z,Y,le,Le,$,Xe]),t.useEffect(()=>{if(le)if(G&&Y){const i=`${le.name} - ${Y.name||`ç¬¬${Y.episodeNumber}é›†`}`,v=ce&&Z?`ç¬¬${ce}å¹•ç¬¬${Z}é•œ`:"";se(z?i:`${i} ${v}`.trim())}else se(le.name);return()=>se("")},[le,Y,G,z,ce,Z,se]),t.useEffect(()=>{if(!(!Pe||we||M.current))return ot.current&&clearTimeout(ot.current),ot.current=setTimeout(()=>{qt()},2e3),()=>{ot.current&&clearTimeout(ot.current)}},[T,_,Le]);const zt=async()=>{var i,v,R,W,J,be;try{let Ee;if(Ie&&K)Ee=await Me.workflows.getById(K);else if(z)Ee=await Me.workflows.getOrCreateByShot(E,u,ce,Z);else if(G)Ee=await Me.workflows.getOrCreateByEpisode(E,u);else{if(!s)return;Ee=await Me.workflows.getOrCreateByProject(s)}const $e=Ee.data;$e.canEdit===!1||$e.canEdit===void 0&&$e.isOwner===!1?(te(!0),M.current=!0,(i=$e.shareInfo)!=null&&i.owner&&O($e.shareInfo.owner)):(te(!1),M.current=!1,O(null)),$e.currentUserId&&(y($e.currentUserId),o.current=$e.currentUserId);const Fe=$e.isOwner!==!1||z&&$e.canEdit===!0;n(Fe);const Ke=Ie||$e.hasCollaborators===!0;if(c(Ke),w.current=$e.id,Ie&&Ce({id:$e.projectId||K,name:$e.name||"å…±äº«å·¥ä½œæµ",description:$e.description,type:"QUICK",status:"DRAFT"}),$e.data){const{nodes:Ve,edges:Je,nodeGroups:ht}=$e.data;if(ht&&ht.length>0&&(ut(ht),Nt.current=ht),Ve&&Ve.length>0){let Ht=Ve;if(z&&((v=Y==null?void 0:Y.scriptJson)!=null&&v.acts))try{const Ct=Y.scriptJson.acts.find(et=>Number(et.actIndex)===Number(ce)),Jt=(R=Ct==null?void 0:Ct.shots)==null?void 0:R.find(et=>Number(et.shotIndex)===Number(Z)),lt=new Set;Jt&&(Array.isArray(Jt.mediaList)&&Jt.mediaList.forEach(et=>{et.nodeId&&lt.add(et.nodeId)}),(W=Jt.media)!=null&&W.nodeId&&lt.add(Jt.media.nodeId)),Ht=Ve.map(et=>{var Ut;return et.type==="videoPreview"&&((Ut=et.data)!=null&&Ut.addedToStoryboard)&&!lt.has(et.id)?{...et,data:{...et.data,addedToStoryboard:!1}}:et})}catch{}let kt;if(z&&((J=Y==null?void 0:Y.scriptJson)!=null&&J.acts))try{const Ct=Y.scriptJson.acts.find(lt=>Number(lt.actIndex)===Number(ce)),Jt=(be=Ct==null?void 0:Ct.shots)==null?void 0:be.find(lt=>Number(lt.shotIndex)===Number(Z));kt=Jt==null?void 0:Jt.æç¤ºè¯}catch{}const Pt=new Set((ht||[]).filter(pt=>!pt.hidden).flatMap(pt=>pt.nodeIds||[])),St=Ht.map(pt=>{const Ct=ht?ht.find(et=>et.nodeIds.includes(pt.id)):null,Jt=g.length>0?g:pt.data.models||[],lt=pt.type==="agent"&&kt?{...pt.data,output:kt,lastOutput:kt}:pt.data;return{...pt,data:{...lt,models:Jt,onOpenAssetPanel:pt.type==="assetSelector"?pt.data.onOpenAssetPanel||tr:pt.data.onOpenAssetPanel,workflowContext:{project:le,episode:Y,nodeGroup:Ct,nodeGroups:ht||[]}},draggable:pt.draggable!==!1,connectable:Pt.has(pt.id)?!1:pt.connectable!==!1,deletable:Pt.has(pt.id)?!1:pt.deletable!==!1}});$(St)}if(Je&&Je.length>0){const Ht=new Set(Ve.map(St=>St.id)),kt=new Map(Ve.map(St=>[St.id,St.type])),Pt=Je.filter(St=>{if(!Ht.has(St.source)||!Ht.has(St.target))return!1;const pt=kt.get(St.target),Ct=kt.get(St.source);return!(pt==="midjourney"&&St.targetHandle==="text-input"&&Ct!=="agent")}).map(St=>({...St,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:St.targetHandle||void 0}));x(Pt)}}}catch{}};t.useEffect(()=>{g.length>0&&T.length>0&&$(i=>i.map(v=>({...v,data:{...v.data,models:g},draggable:v.draggable!==void 0?v.draggable:!0,deletable:v.deletable!==void 0?v.deletable:!0})))},[g,T.length]),t.useEffect(()=>{if(!le&&!Y||T.length===0)return;if(T.some(v=>{var Ee,$e;const R=v.data.workflowContext,W=((Ee=R==null?void 0:R.project)==null?void 0:Ee.id)!==(le==null?void 0:le.id),J=(($e=R==null?void 0:R.episode)==null?void 0:$e.id)!==(Y==null?void 0:Y.id),be=(R==null?void 0:R.nodeGroups)!==Nt.current;return!R||W||J||be})){const v=ce&&Z&&Nt.current.find(R=>R.scene===ce&&R.shot===Z)||null;$(R=>R.map(W=>{const J=Nt.current.find(Ee=>Ee.nodeIds.includes(W.id))||null,be=v||J;return{...W,data:{...W.data,workflowContext:{project:le,episode:Y,nodeGroup:be,nodeGroups:Nt.current}}}}))}},[le,Y,ce,Z,T.length,Le]);const Xt=async(i,v,R)=>{var W;if(!(!E||!u))try{const J=i.find(Fe=>Fe.type==="agent");if(!J)return;const be=((W=J.data)==null?void 0:W.output)||"",$e=(await Me.episodes.getById(E,u)).scriptJson;if(!$e||!$e.acts)return;const ze=$e.acts.map(Fe=>{var Ke;return Fe.actIndex===v?{...Fe,shots:(Ke=Fe.shots)==null?void 0:Ke.map(Ve=>Ve.shotIndex===R&&Ve.æç¤ºè¯!==be?{...Ve,æç¤ºè¯:be}:Ve)}:Fe});await Me.episodes.update(E,u,{scriptJson:{acts:ze}})}catch{}},as=async()=>{if(!(I||M.current)&&!(ms.current.length===0&&Es.current.length===0))try{const i=ms.current.map(R=>{const{data:W,...J}=R,{workflowContext:be,_canEdit:Ee,_currentUserId:$e,...ze}=W||{};return{...J,data:ze}}),v=Es.current.map(R=>({id:R.id,source:R.source,target:R.target,sourceHandle:R.sourceHandle,targetHandle:R.targetHandle,type:R.type}));if(z){await Me.workflows.saveShot(E,u,ce,Z,{nodes:i,edges:v,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}});try{await Xt(ms.current,ce,Z)}catch{}}else G?await Me.workflows.saveEpisode(E,u,{nodes:i,edges:v,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}}):Ie&&K?await Me.workflows.update(K,{data:{nodes:i,edges:v,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}}}):s&&await Me.workflows.save(s,{nodes:i,edges:v,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}})}catch{}},is=t.useRef(null),qt=t.useCallback(()=>{is.current&&clearTimeout(is.current),is.current=setTimeout(()=>{as()},2e3)},[]);t.useEffect(()=>{if(le||Y){let i=Nt.current;z&&ce&&Z&&(i=Nt.current.filter(v=>v.scene===ce&&v.shot===Z)),window.__workflowContext={project:le,episode:Y,nodeGroups:i}}},[le,Y,Le,z,ce,Z]);const Os=async()=>{try{if(Ie){window.__workflowContext={project:null,episode:null,nodeGroups:Nt.current};return}if(G){const[i,v]=await Promise.all([Me.episodes.getById(E,u),Me.projects.getById(E)]);De(i.data),Ce(v.data);let R=Nt.current;z&&ce&&Z&&(R=Nt.current.filter(W=>W.scene===ce&&W.shot===Z)),window.__workflowContext={project:v.data,episode:i.data,nodeGroups:R}}else{const i=await Me.projects.getById(s);Ce(i.data);let v=Nt.current;z&&ce&&Z&&(v=Nt.current.filter(R=>R.scene===ce&&R.shot===Z)),window.__workflowContext={project:i.data,episode:null,nodeGroups:v}}}catch{h.error(G?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),U("/quick")}finally{oe(!1)}},js=async()=>{try{const i=await Me.get("/ai/models",{params:{isActive:"true"}});f(i||[])}catch{}};t.useEffect(()=>{$(i=>i.map(v=>{const R=String(v.type||"");return!R.startsWith("aiVideo")&&R!=="audioVoice"&&R!=="voiceClone"&&R!=="audioSynthesize"&&R!=="audioDesign"?v:{...v,data:{...v.data,models:g}}}))},[g,$]);const ks=async()=>{try{const v=(await Me.agents.getAll()).filter(R=>R.isActive);B(v)}catch{}};t.useEffect(()=>{$(i=>i.map(v=>{var $e,ze,Fe,Ke,Ve;if(v.type!=="agent")return v;const R=(ze=($e=v.data)==null?void 0:$e.config)==null?void 0:ze.agentId,W=d.find(Je=>Je.id===R),J=W==null?void 0:W.aiModelId,be=g.find(Je=>Je.id===J);let Ee=(Fe=be==null?void 0:be.config)==null?void 0:Fe.acceptedInputs;if((!Ee||Ee.length===0)&&be){const Je=(be.provider||"").toLowerCase(),ht=(be.name||"").toLowerCase();(Je.includes("google")||ht.includes("gemini"))&&(Ee=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(Ee)&&Ee.length>0){const Je=(Ve=(Ke=v.data)==null?void 0:Ke.config)==null?void 0:Ve.acceptedInputs,ht=Ht=>Ht.map(kt=>kt.toUpperCase()).sort().join(",");if(!Je||ht(Je)!==ht(Ee))return{...v,data:{...v.data,config:{...v.data.config,acceptedInputs:Ee}}}}return v}))},[d,g,$]);const ir=t.useCallback(i=>{var $e,ze,Fe,Ke,Ve,Je,ht,Ht,kt,Pt,St,pt,Ct,Jt,lt,et,Ut;Qt.current=!1;const v=Nt.current.some(gt=>{var ft;return!gt.hidden&&((ft=gt.nodeIds)==null?void 0:ft.includes(i.source||""))}),R=Nt.current.some(gt=>{var ft;return!gt.hidden&&((ft=gt.nodeIds)==null?void 0:ft.includes(i.target||""))});if(v||R){h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Qt.current=!1;return}const W=T.find(gt=>gt.id===i.source),J=T.find(gt=>gt.id===i.target);if(W&&J){const gt=Wt=>{var ke,He,Tt;const mt=Wt.type,st=Wt.data;if(mt==="upload"&&Array.isArray((ke=st.config)==null?void 0:ke.uploadedFiles)&&st.config.uploadedFiles.length>0){const Vt=st.config.uploadedFiles,rt=Vt.some(jt=>{const Yt=((jt==null?void 0:jt.type)||"").toUpperCase(),vs=((jt==null?void 0:jt.mimeType)||"").toLowerCase();return Yt==="VIDEO"||vs.startsWith("video/")}),At=Vt.some(jt=>{const Yt=((jt==null?void 0:jt.type)||"").toUpperCase(),vs=((jt==null?void 0:jt.mimeType)||"").toLowerCase();return Yt==="IMAGE"||vs.startsWith("image/")}),bt=Vt.some(jt=>{const Yt=((jt==null?void 0:jt.type)||"").toUpperCase(),vs=((jt==null?void 0:jt.mimeType)||"").toLowerCase();return Yt==="AUDIO"||vs.startsWith("audio/")});return(J==null?void 0:J.type)==="aiVideo_swap"?rt?"VIDEO":At?"IMAGE":bt?"AUDIO":null:At?"IMAGE":rt?"VIDEO":bt?"AUDIO":null}if(mt==="assetSelector"){if((He=st.config)!=null&&He.subjects)return"IMAGE";if((Tt=st.config)!=null&&Tt.selectedAsset){const Vt=st.config.selectedAsset,rt=(Vt.type||"").toUpperCase(),At=(Vt.mimeType||"").toLowerCase();return rt==="IMAGE"||At.startsWith("image/")?"IMAGE":rt==="VIDEO"||At.startsWith("video/")?"VIDEO":rt==="AUDIO"||At.startsWith("audio/")?"AUDIO":rt||null}}return mt==="aiImage"||mt==="imagePreview"?"IMAGE":(mt||"").startsWith("aiVideo")||mt==="videoPreview"?"VIDEO":mt==="agent"?"TEXT":null},ft=gt(W);let ss=($e=J.data.config)==null?void 0:$e.acceptedInputs;if(J.type==="aiVideo_t2v"&&ft&&ft!=="TEXT"){const Wt={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${Wt[ft]||ft}è¾“å…¥`),Qt.current=!1;return}if((!ss||ss.length===0)&&J.data.type==="agent"){const Wt=(ze=J.data.config)==null?void 0:ze.agentId,mt=d.find(Tt=>Tt.id===Wt),st=mt==null?void 0:mt.aiModelId,ke=g.find(Tt=>Tt.id===st),He=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(He)&&He.length>0)ss=He;else{const Tt=((Ke=ke==null?void 0:ke.provider)==null?void 0:Ke.toLowerCase())||"",Vt=((ke==null?void 0:ke.name)||"").toLowerCase();(Tt.includes("google")||Vt.includes("gemini"))&&(ss=["TEXT","IMAGE","DOCUMENT"])}}if(J.type!=="agent"){if(!J.type.startsWith("aiVideo")&&ss&&ss.length>0&&ft){const Wt=ss.map(st=>typeof st=="string"?st.toUpperCase():st),mt=typeof ft=="string"?ft.toUpperCase():ft;if(!Wt.includes(mt)){const st={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${st[mt]||mt}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${Wt.map(ke=>st[ke]||ke).join("ã€")}ï¼‰`),Qt.current=!1;return}}}if(J.type==="aiVideo_swap"){const Wt=_.filter(Tt=>Tt.target===J.id),mt=Wt.filter(Tt=>{const Vt=T.find(At=>At.id===Tt.source);return gt(Vt)==="VIDEO"}).length,st=Wt.filter(Tt=>{const Vt=T.find(At=>At.id===Tt.source);return gt(Vt)==="IMAGE"}).length,ke=mt+(ft==="VIDEO"?1:0),He=st+(ft==="IMAGE"?1:0);if(ke>1||He>1||ft!=="VIDEO"&&ft!=="IMAGE"){h.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Qt.current=!1;return}}if(J.type==="aiVideo_lipsync"){const Wt=_.filter(Vt=>Vt.target===J.id),mt=Wt.filter(Vt=>{const rt=T.find(bt=>bt.id===Vt.source);return gt(rt)==="VIDEO"}).length,st=Wt.filter(Vt=>{const rt=T.find(bt=>bt.id===Vt.source);return gt(rt)==="AUDIO"}).length,ke=mt+(ft==="VIDEO"?1:0),He=st+(ft==="AUDIO"?1:0),Tt=ft==="VIDEO"||ft==="AUDIO"||ft==="IMAGE";if(ke>1||He>1||!Tt){h.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Qt.current=!1;return}}if(J.type.startsWith("aiVideo")&&J.type!=="aiVideo_swap"&&ft==="IMAGE"){const mt=(st=>{const ke=(st||"").toLowerCase().replace(/[_\-\s]+/g," ");return ke?ke.includes("æ–‡ç”Ÿ")||ke.includes("text to video")||ke.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")||ke.includes("first last")||ke.includes("two frame")||ke.includes("frame pair")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")||ke.includes("first frame")||ke.includes("start frame")||ke.includes("initial frame")||ke.includes("keyframe")?"é¦–å¸§":ke.includes("å°¾å¸§")||ke.includes("last frame")||ke.includes("end frame")||ke.includes("final frame")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")||ke.includes("subject reference")||ke.includes("å‚è€ƒ")||ke.includes("reference image")||ke.includes("image reference")||ke.includes("ref image")?"å‚è€ƒå›¾":st||"":""})((Je=(Ve=J.data)==null?void 0:Ve.config)==null?void 0:Je.generationType);if(J.type==="aiVideo_t2v"||mt==="æ–‡ç”Ÿè§†é¢‘"){h.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Qt.current=!1;return}if((mt==="é¦–å¸§"||mt==="å°¾å¸§")&&W.type==="assetSelector"){const st=((ht=W.data)==null?void 0:ht.config)||{};if(st.subjects&&st.subjects.length>0&&(st.subjects[0].images||[]).length>1){h.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Qt.current=!1;return}}if(mt==="é¦–å°¾å¸§"&&W.type==="assetSelector"){const st=((Ht=W.data)==null?void 0:Ht.config)||{};if(st.subjects&&st.subjects.length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Qt.current=!1;return}}}if(J.type==="aiVideo_style"){const st=_.filter(ke=>ke.target===J.id).filter(ke=>{const He=T.find(Vt=>Vt.id===ke.source);return gt(He)==="VIDEO"}).length+(ft==="VIDEO"?1:0);if(ft!=="VIDEO"){h.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Qt.current=!1;return}if(st>1){h.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Qt.current=!1;return}}if(J.type.startsWith("aiVideo")&&ft==="TEXT"&&_.filter(st=>st.target===J.id).find(st=>{const ke=T.find(He=>He.id===st.source);return(ke==null?void 0:ke.type)==="agent"})){h.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}if(J.type==="aiImage"){if(ft==="TEXT"){if(_.filter(st=>st.target===J.id).some(st=>{const ke=T.find(He=>He.id===st.source);return(ke==null?void 0:ke.type)==="agent"})){h.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}}else if(ft==="IMAGE"){const mt=_.filter(rt=>rt.target===J.id).reduce((rt,At)=>{var Yt,vs,Zt,$s,As,Ar,_r;const bt=T.find(ls=>ls.id===At.source),jt=(bt==null?void 0:bt.type)||"";if(jt==="upload"){const ls=((Zt=(vs=(Yt=bt==null?void 0:bt.data)==null?void 0:Yt.config)==null?void 0:vs.uploadedFiles)==null?void 0:Zt[0])||null,oa=((ls==null?void 0:ls.type)||"").toUpperCase(),na=((ls==null?void 0:ls.mimeType)||"").toLowerCase();return rt+(oa==="IMAGE"||na.startsWith("image/")?1:0)}if(jt==="assetSelector"){const ls=(($s=bt==null?void 0:bt.data)==null?void 0:$s.config)||{};return ls.selectedAsset&&(rt+=(ls.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ls.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(ls.subjects)&&ls.subjects.length>0?rt+((ls.subjects[0].images||[]).length||0):rt}if(jt==="aiImage"){const ls=(Ar=(As=bt==null?void 0:bt.data)==null?void 0:As.config)==null?void 0:Ar.generatedImageUrl;return rt+(ls?1:0)}if(jt==="imagePreview"){const ls=(_r=bt==null?void 0:bt.data)==null?void 0:_r.imageUrl;return rt+(ls?1:0)}return rt},0);let st=1;if(W.type==="assetSelector"){const rt=((kt=W==null?void 0:W.data)==null?void 0:kt.config)||{};rt.selectedAsset?st=(rt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(rt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(rt.subjects)&&rt.subjects.length>0&&(st=(rt.subjects[0].images||[]).length||0)}else if(W.type==="upload"){const rt=((pt=(St=(Pt=W==null?void 0:W.data)==null?void 0:Pt.config)==null?void 0:St.uploadedFiles)==null?void 0:pt[0])||null,At=((rt==null?void 0:rt.type)||"").toUpperCase(),bt=((rt==null?void 0:rt.mimeType)||"").toLowerCase();st=At==="IMAGE"||bt.startsWith("image/")?1:0}else W.type==="aiImage"?st=((Jt=(Ct=W==null?void 0:W.data)==null?void 0:Ct.config)==null?void 0:Jt.generatedImageUrl)?1:0:W.type==="imagePreview"&&(st=((lt=W==null?void 0:W.data)==null?void 0:lt.imageUrl)?1:0);const ke=(Ut=(et=J==null?void 0:J.data)==null?void 0:et.config)==null?void 0:Ut.modelId,He=g.find(rt=>rt.id===ke),Tt=(He==null?void 0:He.config)||{},Vt=Tt.maxReferenceImages||Tt.supportedReferenceImagesLimit||Tt.referenceImagesLimit||10;if(mt+st>Vt){h.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Vt}å¼ ï¼‰`),Qt.current=!1;return}}}}try{const gt=T.find(mt=>mt.id===i.target),ft=T.find(mt=>mt.id===i.source),ss=mt=>{var ke,He,Tt,Vt;if(!mt)return null;const st=String(mt.type||"").toLowerCase();if(st==="upload"){const rt=(((He=(ke=mt.data)==null?void 0:ke.config)==null?void 0:He.uploadedFiles)||[]).find(At=>{const bt=((At==null?void 0:At.type)||"").toUpperCase(),jt=((At==null?void 0:At.mimeType)||"").toLowerCase();return bt==="AUDIO"||jt.startsWith("audio/")});return(rt==null?void 0:rt.url)||null}if(st==="assetSelector"){const rt=(Vt=(Tt=mt.data)==null?void 0:Tt.config)==null?void 0:Vt.selectedAsset,At=((rt==null?void 0:rt.type)||"").toUpperCase(),bt=((rt==null?void 0:rt.mimeType)||"").toLowerCase();if(At==="AUDIO"||bt.startsWith("audio/"))return(rt==null?void 0:rt.url)||null}return null};if(String((gt==null?void 0:gt.type)||"")==="audioVoice"){const mt=ss(ft);mt&&$(st=>st.map(ke=>ke.id===gt.id?{...ke,data:{...ke.data,config:{...ke.data.config,audioUrl:mt}}}:ke))}}catch{}const Ee={id:`edge-${i.source}-${i.target}-${Date.now()}`,source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{x(gt=>ha(Ee,gt)),It(Ee)},0),us.current=null,Qt.current=!0},[x,T,d,g,_,It]),Gs=t.useCallback((i,v)=>{const R=Nt.current.some(J=>{var be;return!J.hidden&&((be=J.nodeIds)==null?void 0:be.includes(v.source))}),W=Nt.current.some(J=>{var be;return!J.hidden&&((be=J.nodeIds)==null?void 0:be.includes(v.target))});if(R||W){h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}x(J=>J.filter(be=>be.id!==v.id)),Mt(v.id),h.success("å·²æ–­å¼€è¿æ¥")},[x,Mt]),mr=t.useCallback(i=>{var W,J,be,Ee,$e,ze,Fe,Ke,Ve,Je,ht,Ht,kt,Pt,St;ot.current&&clearTimeout(ot.current);try{const pt=localStorage.getItem("suppressedPreviewTasks")||"[]",Ct=JSON.parse(pt),Jt=et=>{Ct.push(et)};for(const et of Array.isArray(i)?i:[])if((et==null?void 0:et.type)==="imagePreview"){const Ut=(J=(W=et==null?void 0:et.data)==null?void 0:W.midjourneyData)==null?void 0:J.sourceNodeId,gt=(Ee=(be=et==null?void 0:et.data)==null?void 0:be.midjourneyData)==null?void 0:Ee.taskId,ft=(ze=($e=et==null?void 0:et.data)==null?void 0:$e.midjourneyData)==null?void 0:ze.messageId;if(Ut||gt||ft)Jt({sourceNodeId:Ut,taskId:gt,messageId:ft});else{const ss=Es.current.find(Wt=>Wt.target===et.id);if(ss){const Wt=ms.current.find(st=>st.id===ss.source),mt=(Ke=(Fe=Wt==null?void 0:Wt.data)==null?void 0:Fe.config)==null?void 0:Ke.taskId;mt&&Jt({taskId:mt})}}}else if((et==null?void 0:et.type)==="videoPreview"){const Ut=Es.current.find(gt=>gt.target===et.id);if(Ut){const gt=ms.current.find(ss=>ss.id===Ut.source),ft=(Je=(Ve=gt==null?void 0:gt.data)==null?void 0:Ve.config)==null?void 0:Je.taskId;ft&&Jt({taskId:ft})}}const lt=Ct.slice(Math.max(0,Ct.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(lt))}catch{}try{const pt=[];for(const Ct of Array.isArray(i)?i:[]){const Jt=(kt=(Ht=(ht=Ct==null?void 0:Ct.data)==null?void 0:ht.workflowContext)==null?void 0:Ht.project)==null?void 0:kt.name;(Ct==null?void 0:Ct.type)==="imagePreview"&&((Pt=Ct==null?void 0:Ct.data)!=null&&Pt.imageUrl)?pt.push(Me.post("/assets/recycle/record",{url:Ct.data.imageUrl,type:"IMAGE",projectName:Jt})):(Ct==null?void 0:Ct.type)==="videoPreview"&&((St=Ct==null?void 0:Ct.data)!=null&&St.videoUrl)&&pt.push(Me.post("/assets/recycle/record",{url:Ct.data.videoUrl,type:"VIDEO",projectName:Jt}))}pt.length>0&&Promise.allSettled(pt).then(()=>{})}catch{}const v=Array.isArray(i)?i.length:0,R=Ys.current;setTimeout(()=>{const pt=ms.current.length,Ct=Math.max(R-v,0);pt===Ct&&as()},100)},[]),Wr=t.useCallback(i=>{const v=i.filter(W=>Nt.current.some(be=>{var Ee;return!be.hidden&&((Ee=be.nodeIds)==null?void 0:Ee.includes(W.id))})?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(v.length===0)return;if(l){mr(v),v.forEach(W=>Gt(W.id));return}const R=v.filter(W=>{var Ee;const J=(Ee=W.data)==null?void 0:Ee.createdBy;return(typeof J=="object"?J==null?void 0:J.id:J)===o.current});R.length>0&&(mr(R),R.forEach(W=>Gt(W.id)))},[l,mr,Gt]),jr=t.useCallback(i=>{ot.current&&clearTimeout(ot.current),setTimeout(()=>{qt()},250)},[]),Fr=t.useCallback(i=>{const v=i.filter(R=>{if(R.type!=="remove")return!0;const W=Es.current.find(Ee=>Ee.id===R.id);if(!W)return!0;const J=Nt.current.some(Ee=>{var $e;return!Ee.hidden&&(($e=Ee.nodeIds)==null?void 0:$e.includes(W.source))}),be=Nt.current.some(Ee=>{var $e;return!Ee.hidden&&(($e=Ee.nodeIds)==null?void 0:$e.includes(W.target))});return J||be?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});m(v)},[m]),zr=t.useCallback(i=>{const v=i.filter(R=>{const W=Nt.current.some(be=>{var Ee;return!be.hidden&&((Ee=be.nodeIds)==null?void 0:Ee.includes(R.source))}),J=Nt.current.some(be=>{var Ee;return!be.hidden&&((Ee=be.nodeIds)==null?void 0:Ee.includes(R.target))});return W||J?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});v.length>0&&(jr(v),v.forEach(R=>Mt(R.id)))},[jr,Mt]),Br=t.useCallback(i=>{if(i.preventDefault(),I)return;const v=200,R=400,W=10;let J=i.clientX,be=i.clientY;J+v+W>window.innerWidth&&(J=window.innerWidth-v-W),be+R+W>window.innerHeight&&(be=window.innerHeight-R-W),J=Math.max(W,J),be=Math.max(W,be),Q({x:J,y:be})},[I]),lr=t.useCallback(()=>{Q(null),N(),b(!1)},[]),tr=t.useCallback(i=>{Ft(i),Be(!0)},[]);t.useEffect(()=>{T.length>0&&T.some(v=>v.type==="assetSelector"&&!v.data.onOpenAssetPanel)&&$(v=>v.map(R=>R.type==="assetSelector"&&!R.data.onOpenAssetPanel?{...R,data:{...R.data,onOpenAssetPanel:tr,models:R.data.models||g}}:R))},[T.length,tr,g]);const Hr=t.useCallback(i=>{qe&&($(v=>v.map(W=>W.id===qe?{...W,data:{...W.data,config:{...W.data.config,...i.images?i.images.length===1?{selectedInput:{id:i.images[0].id,name:i.images[0].name,originalName:i.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:i.images[0].url},selectedAsset:{id:i.images[0].id,name:i.images[0].name,originalName:i.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:i.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:i,subjects:[{name:i.name,images:i.images.map(J=>J.url)}],referenceImages:i.images.map(J=>({id:J.id,url:J.url,name:J.name}))}:{selectedInput:{id:i.id,name:i.name,originalName:i.originalName,type:i.type,mimeType:i.mimeType,size:i.size,url:i.url},selectedAsset:{id:i.id,name:i.name,originalName:i.originalName,type:i.type,mimeType:i.mimeType,size:i.size,url:i.url},subjects:void 0,referenceImages:void 0}}}}:W)),Be(!1),Ft(null),h.success(`å·²é€‰æ‹©ç´ æï¼š${i.name}`))},[qe,$]),Ir=i=>{const R={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[i]||"æ–‡ç”Ÿè§†é¢‘",W=R==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:R==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:R==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:R==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],J=g.filter(ze=>ze.type==="VIDEO_GENERATION"),be=g.filter(ze=>ze.type==="VIDEO_EDITING"),Ee=ze=>{const Fe=(ze||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":ze};let $e=null;return R==="è§†é¢‘æ¢äºº"?$e=be.find(ze=>{var Fe;return Array.isArray((Fe=ze==null?void 0:ze.config)==null?void 0:Fe.supportedEditingCapabilities)&&ze.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||J.find(ze=>{var Ke,Ve;return(Array.isArray((Ke=ze==null?void 0:ze.config)==null?void 0:Ke.supportedGenerationTypes)?ze.config.supportedGenerationTypes.map(Je=>Ee(Je)):[]).includes("è§†é¢‘æ¢äºº")&&((Ve=ze==null?void 0:ze.config)==null?void 0:Ve.supportsVideoEditing)===!0}):R==="å¯¹å£å‹"?$e=be.find(ze=>{var Fe;return Array.isArray((Fe=ze==null?void 0:ze.config)==null?void 0:Fe.supportedEditingCapabilities)&&ze.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:R==="é£æ ¼è½¬æ¢"?$e=be.find(ze=>{var Fe;return Array.isArray((Fe=ze==null?void 0:ze.config)==null?void 0:Fe.supportedEditingCapabilities)&&ze.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:$e=J.find(ze=>{var Ke;const Fe=Array.isArray((Ke=ze==null?void 0:ze.config)==null?void 0:Ke.supportedGenerationTypes)?ze.config.supportedGenerationTypes.map(Ve=>Ee(Ve)):[];return R==="é¦–å¸§"||R==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(R)}),{modelId:$e==null?void 0:$e.id,modelName:$e==null?void 0:$e.name,generationType:R,lockedGenerationType:R,hideGenerationTypeSelector:!0,acceptedInputs:W}},ds=(i,v,R,W,J,be,Ee,$e)=>{if(!q)return;const ze=he({x:q.x,y:q.y}),Fe=`${i}-${Date.now()}`,Ke=yt?Le.find(kt=>kt.id===yt)||null:Le.find(kt=>kt.nodeIds.includes(Fe))||null,Ve=R==="aiImage"||R.startsWith("aiVideo")||R==="midjourney",Je=R.startsWith("aiVideo")?Ir(R):{},ht=W?{agentId:W}:Je;R.startsWith("aiVideo"),R.startsWith("aiVideo")&&$e&&Object.assign(ht,$e);const Ht={id:Fe,type:R,position:ze,data:{label:J||v,type:i,config:ht,models:g,isExpanded:Ve,onOpenAssetPanel:R==="assetSelector"?tr:void 0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:le,episode:Y,nodeGroup:Ke,nodeGroups:Le}}};$(kt=>[...kt,Ht]),Bt(Ht),yt&&(ut(kt=>kt.map(Pt=>{if(Pt.id!==yt)return Pt;const St=Array.from(new Set([...Pt.nodeIds||[],Fe])),pt=ur(St)||Pt.bounds;return{...Pt,nodeIds:St,bounds:pt}})),Nt.current=Nt.current.map(kt=>{if(kt.id!==yt)return kt;const Pt=Array.from(new Set([...kt.nodeIds||[],Fe])),St=ur(Pt)||kt.bounds;return{...kt,nodeIds:Pt,bounds:St}})),lr(),h.success(`å·²æ·»åŠ ${J||v}èŠ‚ç‚¹`),R==="assetSelector"&&setTimeout(()=>{tr(Ht.id)},100)},[os,Bs]=t.useState(null),Qt=t.useRef(!1),us=t.useRef(null),Ks=t.useMemo(()=>{var $e,ze,Fe,Ke;const i={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!os)return i;const v=os.handleType==="target",R=Ve=>{const Je=(Ve||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")||Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":Ve||"":""};if(v){const Ve=T.find(Pt=>Pt.id===os.sourceNodeId),Je=(Ve==null?void 0:Ve.type)||"",ht=Je.startsWith("aiVideo"),Ht=R((ze=($e=Ve==null?void 0:Ve.data)==null?void 0:$e.config)==null?void 0:ze.generationType),kt=Je==="aiVideo_t2v"||Ht==="æ–‡ç”Ÿè§†é¢‘";if(Je==="aiImage"){const Pt=_.filter(Ut=>Ut.target===(Ve==null?void 0:Ve.id)),St=Pt.some(Ut=>{const gt=T.find(ft=>ft.id===Ut.source);return((gt==null?void 0:gt.type)||"")==="agent"}),pt=Pt.reduce((Ut,gt)=>{var Wt,mt,st,ke;const ft=T.find(He=>He.id===gt.source),ss=(ft==null?void 0:ft.type)||"";if(ss==="upload"){const He=((st=(mt=(Wt=ft==null?void 0:ft.data)==null?void 0:Wt.config)==null?void 0:mt.uploadedFiles)==null?void 0:st[0])||null,Tt=((He==null?void 0:He.type)||"").toUpperCase(),Vt=((He==null?void 0:He.mimeType)||"").toLowerCase();return Ut+(Tt==="IMAGE"||Vt.startsWith("image/")?1:0)}if(ss==="assetSelector"){const He=((ke=ft==null?void 0:ft.data)==null?void 0:ke.config)||{};if(He.selectedAsset)return Ut+((He.selectedAsset.type||"").toUpperCase()==="IMAGE"||(He.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(He.subjects&&He.subjects.length>0)return Ut+((He.subjects[0].images||[]).length||0)}return Ut},0),Ct=(Ke=(Fe=Ve==null?void 0:Ve.data)==null?void 0:Fe.config)==null?void 0:Ke.modelId,Jt=g.find(Ut=>Ut.id===Ct),lt=(Jt==null?void 0:Jt.config)||{},et=lt.maxReferenceImages||lt.supportedReferenceImagesLimit||lt.referenceImagesLimit||10;return St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:pt>=et?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(ht){const Pt=_.filter(et=>et.target===(Ve==null?void 0:Ve.id)),St=Pt.some(et=>{const Ut=T.find(gt=>gt.id===et.source);return((Ut==null?void 0:Ut.type)||"")==="agent"}),pt=Pt.reduce((et,Ut)=>{var ss,Wt,mt,st;const gt=T.find(ke=>ke.id===Ut.source),ft=(gt==null?void 0:gt.type)||"";if(ft==="aiImage"||ft==="imagePreview")return et+1;if(ft==="upload"){const ke=((mt=(Wt=(ss=gt==null?void 0:gt.data)==null?void 0:ss.config)==null?void 0:Wt.uploadedFiles)==null?void 0:mt[0])||null,He=((ke==null?void 0:ke.type)||"").toUpperCase(),Tt=((ke==null?void 0:ke.mimeType)||"").toLowerCase();return et+(He==="IMAGE"||Tt.startsWith("image/")?1:0)}if(ft==="assetSelector"){const ke=((st=gt==null?void 0:gt.data)==null?void 0:st.config)||{};if(ke.selectedAsset)return et+((ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ke.subjects&&ke.subjects.length>0)return et+((ke.subjects[0].images||[]).length||0)}return et},0);return kt?St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Je==="aiVideo_i2v_first"||Je==="aiVideo_i2v_last"||Ht==="é¦–å¸§"||Ht==="å°¾å¸§"?St&&pt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Je==="aiVideo_first_last"||Ht==="é¦–å°¾å¸§"?St&&pt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:pt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Je==="aiVideo_reference"||Ht==="å‚è€ƒå›¾"?St&&pt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:pt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return i}const W=T.find(Ve=>Ve.id===os.sourceNodeId),be=(Ve=>{var Ht,kt,Pt;if(!Ve)return null;const Je=Ve.type,ht=Ve.data;if(Je==="upload"&&Array.isArray((Ht=ht.config)==null?void 0:Ht.uploadedFiles)&&ht.config.uploadedFiles.length>0){const St=ht.config.uploadedFiles;return St.some(lt=>{const et=((lt==null?void 0:lt.type)||"").toUpperCase(),Ut=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return et==="IMAGE"||Ut.startsWith("image/")})?"IMAGE":St.some(lt=>{const et=((lt==null?void 0:lt.type)||"").toUpperCase(),Ut=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return et==="VIDEO"||Ut.startsWith("video/")})?"VIDEO":St.some(lt=>{const et=((lt==null?void 0:lt.type)||"").toUpperCase(),Ut=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return et==="AUDIO"||Ut.startsWith("audio/")})?"AUDIO":null}if(Je==="assetSelector"){if((kt=ht.config)!=null&&kt.subjects)return"IMAGE";if((Pt=ht.config)!=null&&Pt.selectedAsset){const St=ht.config.selectedAsset,pt=(St.type||"").toUpperCase(),Ct=(St.mimeType||"").toLowerCase();return pt==="IMAGE"||Ct.startsWith("image/")?"IMAGE":pt==="VIDEO"||Ct.startsWith("video/")?"VIDEO":pt==="AUDIO"||Ct.startsWith("audio/")?"AUDIO":pt||null}}return Je==="aiImage"||Je==="imagePreview"||Je==="midjourney"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"||Je==="textPreview"?"TEXT":null})(W),Ee=W==null?void 0:W.type;return Ee==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:Ee==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:be==="TEXT",showAiImage:be==="IMAGE"||be==="TEXT",showAudio:be==="AUDIO",showVideo:be==="VIDEO"||be==="IMAGE"||be==="TEXT",showEdit:be==="VIDEO",showImageEditing:be==="IMAGE",showMidjourney:be==="IMAGE"||be==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:be==="IMAGE"}},[os,T,_,g]),Xr=t.useCallback((i,{nodeId:v,handleType:R})=>{if(!v){us.current=null;return}if(R==="target"){const W=T.find(be=>be.id===v),J=(W==null?void 0:W.type)||"";if(J==="agent"||J==="aiImage"||J==="midjourney"||J.startsWith("aiVideo")){h.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),us.current=null;return}}if(R==="source"){const W=T.find(J=>J.id===v);if(W&&(W.type==="aiImage"||W.type.startsWith("aiVideo"))){us.current=null;return}}Qt.current=!1,us.current={nodeId:v,handleType:R==="target"?"target":"source"},lr(),Bs(null)},[lr,T]),Jr=t.useCallback(i=>{const v=us.current;if(!v)return;let R=0,W=0;"changedTouches"in i&&i.changedTouches.length>0?(R=i.changedTouches[0].clientX,W=i.changedTouches[0].clientY):"clientX"in i&&(R=i.clientX,W=i.clientY),setTimeout(()=>{if(Qt.current){Qt.current=!1,us.current=null;return}const J=i.target,be=!!J&&!!J.closest(".react-flow__pane"),Ee=!!J&&(J.closest(".react-flow__node")||J.closest(".react-flow__handle"));if(!be||Ee){Qt.current=!1,us.current=null;return}Bs({x:R,y:W,sourceNodeId:v.nodeId,handleType:v.handleType}),Qt.current=!1},100),us.current=null},[]),ps=(i,v,R,W,J,be)=>{var Ht,kt,Pt,St,pt,Ct,Jt;if(!os)return;const Ee=he({x:os.x,y:os.y}),$e=`${R}-${Date.now()}`,ze=T.find(lt=>lt.id===os.sourceNodeId),Fe=ze?Le.find(lt=>lt.nodeIds.includes(ze.id)):null,Ke=i==="aiImage"||i.startsWith("aiVideo")||i==="midjourney",Ve=i.startsWith("aiVideo")?Ir(i):{},Je=W?{agentId:W}:Ve;i.startsWith("aiVideo")&&be&&Object.assign(Je,be);const ht={id:$e,type:i,position:Ee,data:{label:J||v,type:R,config:Je,models:g,isExpanded:Ke,onOpenAssetPanel:i==="assetSelector"?tr:void 0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:le,episode:Y,nodeGroup:Fe,nodeGroups:Le}}};if($(lt=>[...lt,ht]),Fe&&(ut(lt=>lt.map(et=>{if(et.id!==Fe.id)return et;const Ut=Array.from(new Set([...et.nodeIds,$e]));return{...et,nodeIds:Ut}})),Nt.current=Nt.current.map(lt=>{if(lt.id!==Fe.id)return lt;const et=Array.from(new Set([...lt.nodeIds,$e]));return{...lt,nodeIds:et}})),os.handleType==="source"){const lt=T.find(ke=>ke.id===os.sourceNodeId),et=ht,Ut=ke=>{const He=(ke||"").toLowerCase().replace(/[_\-\s]+/g," ");return He?He.includes("æ–‡ç”Ÿ")||He.includes("text to video")||He.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":He.includes("é¦–å°¾")||He.includes("first last")||He.includes("two frame")||He.includes("frame pair")?"é¦–å°¾å¸§":He.includes("é¦–å¸§")||He.includes("first frame")||He.includes("start frame")||He.includes("initial frame")||He.includes("keyframe")?"é¦–å¸§":He.includes("å°¾å¸§")||He.includes("last frame")||He.includes("end frame")||He.includes("final frame")?"å°¾å¸§":He.includes("ä¸»ä½“å‚è€ƒ")||He.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":He.includes("å‚è€ƒ")||He.includes("reference image")||He.includes("image reference")||He.includes("ref image")?"å‚è€ƒå›¾":ke||"":""},gt=ke=>{var Vt,rt,At;const He=ke.type,Tt=ke.data;if(He==="upload"&&Array.isArray((Vt=Tt.config)==null?void 0:Vt.uploadedFiles)&&Tt.config.uploadedFiles.length>0){const bt=Tt.config.uploadedFiles,jt=bt.some(Zt=>{const $s=((Zt==null?void 0:Zt.type)||"").toUpperCase(),As=((Zt==null?void 0:Zt.mimeType)||"").toLowerCase();return $s==="VIDEO"||As.startsWith("video/")}),Yt=bt.some(Zt=>{const $s=((Zt==null?void 0:Zt.type)||"").toUpperCase(),As=((Zt==null?void 0:Zt.mimeType)||"").toLowerCase();return $s==="IMAGE"||As.startsWith("image/")}),vs=bt.some(Zt=>{const $s=((Zt==null?void 0:Zt.type)||"").toUpperCase(),As=((Zt==null?void 0:Zt.mimeType)||"").toLowerCase();return $s==="AUDIO"||As.startsWith("audio/")});return(et==null?void 0:et.type)==="aiVideo_swap"?jt?"VIDEO":Yt?"IMAGE":vs?"AUDIO":null:Yt?"IMAGE":jt?"VIDEO":vs?"AUDIO":null}if(He==="assetSelector"){if((rt=Tt.config)!=null&&rt.subjects)return"IMAGE";if((At=Tt.config)!=null&&At.selectedAsset){const bt=Tt.config.selectedAsset,jt=(bt.type||"").toUpperCase(),Yt=(bt.mimeType||"").toLowerCase();return jt==="IMAGE"||Yt.startsWith("image/")?"IMAGE":jt==="VIDEO"||Yt.startsWith("video/")?"VIDEO":jt==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":jt||null}}return He==="aiImage"||He==="imagePreview"?"IMAGE":(He||"").startsWith("aiVideo")||He==="videoPreview"?"VIDEO":He==="agent"?"TEXT":null},ft=ke=>{var Tt,Vt,rt;if(gt(ke)!=="IMAGE")return 0;if(ke.type==="upload")return(((Vt=(Tt=ke.data)==null?void 0:Tt.config)==null?void 0:Vt.uploadedFiles)||[]).filter(bt=>bt.type==="IMAGE"||(bt.mimeType||"").startsWith("image/")).length;if(ke.type==="assetSelector"){const At=((rt=ke.data)==null?void 0:rt.config)||{};return At.subjects&&At.subjects.length>0?(At.subjects[0].images||[]).length:At.selectedAsset&&At.selectedAsset.type==="IMAGE"?1:0}return ke.type==="imagePreview"||ke.type==="aiImage",1},ss=ke=>{var bt,jt,Yt,vs,Zt,$s;const He=Ut((jt=(bt=ke.data)==null?void 0:bt.config)==null?void 0:jt.generationType);if(He==="æ–‡ç”Ÿè§†é¢‘")return 0;if(He==="é¦–å¸§"||He==="å°¾å¸§")return 1;if(He==="é¦–å°¾å¸§")return 2;if(He==="å‚è€ƒå›¾"||He==="ä¸»ä½“å‚è€ƒ")return 7;const Tt=(vs=(Yt=ke.data)==null?void 0:Yt.config)==null?void 0:vs.modelId,rt=(((Zt=ke.data)==null?void 0:Zt.models)||g).find(As=>As.id===Tt),At=Array.isArray(($s=rt==null?void 0:rt.config)==null?void 0:$s.supportedGenerationTypes)?rt.config.supportedGenerationTypes.map(As=>Ut(As)):[];return At.includes("å‚è€ƒå›¾")||At.includes("ä¸»ä½“å‚è€ƒ")?7:At.includes("é¦–å°¾å¸§")?2:At.includes("é¦–å¸§")||At.includes("å°¾å¸§")?1:(At.includes("æ–‡ç”Ÿè§†é¢‘"),0)},Wt=lt?gt(lt):null;if(et.type.startsWith("aiVideo")&&Wt==="IMAGE"){if(Ut((kt=(Ht=et.data)==null?void 0:Ht.config)==null?void 0:kt.generationType)==="é¦–å°¾å¸§"&&lt&&lt.type==="assetSelector"){const bt=((Pt=lt.data)==null?void 0:Pt.config)||{};if(bt.subjects&&(((St=bt.subjects[0])==null?void 0:St.images)||[]).length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Bs(null),us.current=null,Qt.current=!1;return}}const He=_.filter(bt=>bt.target===et.id);let Tt=0;He.forEach(bt=>{const jt=T.find(Yt=>Yt.id===bt.source);jt&&(Tt+=ft(jt))});const Vt=lt?ft(lt):0,rt=ss(et),At=Tt+Vt;if(rt===0){h.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Bs(null),us.current=null,Qt.current=!1;return}if(At>rt){h.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${rt}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${At}å¼ ï¼‰`),Bs(null),us.current=null,Qt.current=!1;return}}let mt;ht.type==="superCanvas"?mt="input-image":ht.type==="midjourney"&&(Wt==="IMAGE"?mt="omni-ref":Wt==="TEXT"&&(mt="text-input"));const st={id:`edge-${os.sourceNodeId}-${ht.id}`,source:os.sourceNodeId,target:ht.id,targetHandle:mt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(ke=>[...ke,st])}else if(os.handleType==="target"){const lt=T.find(st=>st.id===os.sourceNodeId),et=(lt==null?void 0:lt.type)||"";if(et==="agent"||et==="aiImage"||et==="midjourney"||et.startsWith("aiVideo")){h.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Bs(null),us.current=null,Qt.current=!1;return}const Ut=ht,gt=T.find(st=>st.id===os.sourceNodeId),ft=st=>{const ke=(st||"").toLowerCase();return ke?ke.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")?"é¦–å¸§":ke.includes("å°¾å¸§")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ke.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ke.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("first-last")?"é¦–å°¾å¸§":ke.includes("first")?"é¦–å¸§":ke.includes("last")?"å°¾å¸§":ke.includes("subject")?"ä¸»ä½“å‚è€ƒ":ke.includes("reference")?"å‚è€ƒå›¾":st||"":""},Wt=(st=>{var Tt,Vt,rt,At;const ke=st.type,He=st.data;if(ke==="upload"&&((Vt=(Tt=He.config)==null?void 0:Tt.uploadedFiles)==null?void 0:Vt.length)>0){const bt=He.config.uploadedFiles[0],jt=(bt.type||"").toUpperCase(),Yt=(bt.mimeType||"").toLowerCase();return jt==="IMAGE"||Yt.startsWith("image/")?"IMAGE":jt==="VIDEO"||Yt.startsWith("video/")?"VIDEO":jt==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":jt||null}if(ke==="assetSelector"){if((rt=He.config)!=null&&rt.subjects)return"IMAGE";if((At=He.config)!=null&&At.selectedAsset){const bt=He.config.selectedAsset,jt=(bt.type||"").toUpperCase(),Yt=(bt.mimeType||"").toLowerCase();return jt==="IMAGE"||Yt.startsWith("image/")?"IMAGE":jt==="VIDEO"||Yt.startsWith("video/")?"VIDEO":jt==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":jt||null}}return ke==="aiImage"||ke==="imagePreview"?"IMAGE":ke==="aiVideo"||ke==="videoPreview"?"VIDEO":ke==="agent"?"TEXT":null})(Ut);if(gt&&gt.type==="aiVideo"&&Wt==="IMAGE"&&ft((Ct=(pt=gt.data)==null?void 0:pt.config)==null?void 0:Ct.generationType)==="é¦–å°¾å¸§"&&Ut&&Ut.type==="assetSelector"){const ke=((Jt=Ut.data)==null?void 0:Jt.config)||{};if(ke.subjects&&ke.subjects.length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Bs(null),us.current=null,Qt.current=!1;return}}const mt={id:`edge-${ht.id}-${os.sourceNodeId}`,source:ht.id,sourceHandle:ht.type==="superCanvas"?"output-image":void 0,target:os.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(st=>[...st,mt])}Bs(null),us.current=null,Qt.current=!1,h.success(`å·²æ·»åŠ ${v}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),i==="assetSelector"&&setTimeout(()=>{tr(ht.id)},100)},ur=t.useCallback(i=>{const v=T.filter($e=>i.includes($e.id));if(v.length===0)return null;const R=50;let W=1/0,J=1/0,be=-1/0,Ee=-1/0;return v.forEach($e=>{const ze=$e.position.x,Fe=$e.position.y,Ke=$e.width||320,Ve=$e.height||200;W=Math.min(W,ze),J=Math.min(J,Fe),be=Math.max(be,ze+Ke),Ee=Math.max(Ee,Fe+Ve)}),{x:W-R,y:J-R,width:be-W+R*2,height:Ee-J+R*2}},[T]),qr=t.useCallback(()=>{Js(i=>!i),Zs(!1)},[]),Sr=t.useCallback((i,v)=>{const R={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:i-100,y:v-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0}};$(W=>[...W,R]),Js(!1)},[$,fe]),Yr=t.useCallback(()=>{if(!l){h.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const i=T.filter(be=>be.selected);if(i.length===0){h.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(i.length<2){h.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const v=i.map(be=>be.id);if(Le.some(be=>be.nodeIds.some(Ee=>v.includes(Ee)))){h.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const W=ur(v);if(!W){h.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const J={id:`group-${Date.now()}`,nodeIds:v,bounds:W};ut(be=>{const Ee=[...be,J];return Lt(Ee),setTimeout(()=>{qt()},100),Ee}),nt(J.id),$(be=>{const Ee=new Set;return _.forEach($e=>{if(v.includes($e.source)){const ze=be.find(Fe=>Fe.id===$e.target);ze&&(ze.type==="imagePreview"||ze.type==="videoPreview")&&Ee.add($e.target)}}),be.map($e=>v.includes($e.id)?{...$e,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...$e.data,workflowContext:{...$e.data.workflowContext,nodeGroup:J,nodeGroups:[...Le,J]}}}:Ee.has($e.id)?{...$e,data:{...$e.data,workflowContext:{...$e.data.workflowContext,nodeGroup:J,nodeGroups:[...Le,J]}}}:$e)}),h.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${v.length} ä¸ªèŠ‚ç‚¹`)},[T,ur,Le,$]),Kr=t.useCallback(()=>{if(!l){h.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Et){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const i=Le.find(v=>v.id===Et);i&&($(v=>v.map(R=>i.nodeIds.includes(R.id)?{...R,draggable:!0,connectable:!0,deletable:!0,data:{...R.data,workflowContext:{...R.data.workflowContext,nodeGroup:null,nodeGroups:Le.filter(W=>W.id!==Et)}}}:R)),ut(v=>{const R=v.filter(W=>W.id!==Et);return Lt(R),setTimeout(()=>{qt()},100),R}),nt(null),h.success("å·²è§£é™¤ç¼–ç»„"))},[Et,Le,$,Lt]),Qr=t.useCallback(()=>{if(!Et){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}bs(Et),_t(!0)},[Et]),Er=t.useCallback((i,v)=>{i.stopPropagation(),i.preventDefault(),Rs(null),nt(v),zs(null)},[]);t.useEffect(()=>{if(!cs||!ws)return;let i=ws.x,v=ws.y;const R=J=>{const be=Ps.current;if(!be)return;const Ee=me(),$e=(J.clientX-i)/Ee.zoom,ze=(J.clientY-v)/Ee.zoom;if(Math.abs($e)<.01&&Math.abs(ze)<.01)return;const Fe=Nt.current.find(Ke=>Ke.id===be);Fe&&(ut(Ke=>Ke.map(Ve=>Ve.id===be?{...Ve,bounds:{...Ve.bounds,x:Ve.bounds.x+$e,y:Ve.bounds.y+ze}}:Ve)),$(Ke=>Ke.map(Ve=>Fe.nodeIds.includes(Ve.id)?{...Ve,position:{x:Ve.position.x+$e,y:Ve.position.y+ze}}:Ve)),i=J.clientX,v=J.clientY)},W=()=>{Rs(null),zs(null)};return document.addEventListener("mousemove",R),document.addEventListener("mouseup",W),()=>{document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",W)}},[cs,ws]);const Zr=t.useCallback(i=>{if(hs){const v=he({x:i.clientX,y:i.clientY});Sr(v.x,v.y);return}lr(),Bs(null),us.current=null,nt(null),Qt.current=!1},[lr,hs,he,Sr]),xr=t.useRef(null),ea=t.useCallback(()=>{Le.length>0&&!xr.current&&(xr.current=window.requestAnimationFrame(()=>{rr(i=>i+1),xr.current=null}))},[Le.length]),ar=t.useCallback(i=>Le.find(v=>v.nodeIds.includes(i))||null,[Le]),ta=t.useCallback((i,v)=>{var W;if(Ue||(W=v==null?void 0:v.data)!=null&&W.freeDrag)return;const R=ar(v.id);if(R){if(!R.hidden&&!l)return;Ss.current=v.id,Ns.current={x:v.position.x,y:v.position.y}}},[ar,l]),sa=t.useCallback((i,v)=>{var J;if(Ue||(J=v==null?void 0:v.data)!=null&&J.freeDrag||!Ns.current||Ss.current!==v.id)return;const R=ar(v.id);if(!R)return;const W=!R.hidden;if(!(W&&!l))if(W){const be=v.position.x-Ns.current.x,Ee=v.position.y-Ns.current.y,$e=[],ze=R.nodeIds||[];ms.current.forEach(Fe=>{if(ze.includes(Fe.id)){const Ke={x:Fe.id===v.id?v.position.x:Fe.position.x+be,y:Fe.id===v.id?v.position.y:Fe.position.y+Ee};$e.push({id:Fe.id,position:Ke})}}),$(Fe=>Fe.map(Ke=>{const Ve=$e.find(Je=>Je.id===Ke.id);return Ve?{...Ke,position:Ve.position}:Ke})),$e.length>0&&wt($e),ut(Fe=>{const Ke=Fe.map(Ve=>Ve.id===R.id?{...Ve,bounds:{...Ve.bounds,x:Ve.bounds.x+be,y:Ve.bounds.y+Ee}}:Ve);return Nt.current=Ke,Ke}),Ns.current={x:v.position.x,y:v.position.y}}else{const be=R.bounds.x,Ee=R.bounds.y,$e=R.bounds.width,ze=R.bounds.height,Fe=(Je,ht,Ht)=>Math.max(ht,Math.min(Je,Ht)),Ke=Fe(v.position.x,be+10,be+$e-10),Ve=Fe(v.position.y,Ee+10,Ee+ze-10);$(Je=>Je.map(ht=>ht.id===v.id?{...ht,position:{x:Ke,y:Ve}}:ht)),Ns.current={x:Ke,y:Ve}}},[$,ut,ar,l,wt]),ra=t.useCallback(()=>{Ss.current=null,Ns.current=null,Ps.current=null,Ss.current=null,Ns.current=null,Ps.current=null,Rs(null),Nt.current.length>0&&Lt(Nt.current)},[Lt]),aa=t.useCallback((i,v)=>{const R=ar(v.id);R&&nt(R.id)},[ar]);if(t.useEffect(()=>{if(_.length===0||T.length===0)return;const i=_.filter(v=>{const R=T.find(J=>J.id===v.source),W=T.find(J=>J.id===v.target);return(W==null?void 0:W.type)==="midjourney"&&v.targetHandle==="text-input"&&(R==null?void 0:R.type)!=="agent"});i.length>0&&(x(v=>v.filter(R=>!i.some(W=>W.id===R.id))),h.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[_,T,x]),we)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!le)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Cr=T.filter(i=>i.selected).length>=2,pr=!!Et;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:at,className:"flex-1 relative overflow-hidden",children:[I&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:C?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${C.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),le&&e.jsx("div",{className:`absolute left-4 ${I?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:G&&Y?`ã€Š${le.name}ã€‹ç¬¬${Y.episodeNumber}é›†${!z&&ce&&Z?` ç¬¬${ce}å¹•ç¬¬${Z}é•œ`:""}`:`ã€Š${le.name}ã€‹`})}),!z&&Le.filter(i=>i.scene!==void 0&&i.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-4 top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Le.filter(i=>i.scene!==void 0&&i.shot!==void 0).sort((i,v)=>i.scene!==v.scene?(i.scene||0)-(v.scene||0):(i.shot||0)-(v.shot||0)).map(i=>e.jsx("button",{onClick:()=>{nt(i.id);const v=i.bounds.x+i.bounds.width/2,R=i.bounds.y+i.bounds.height/2,W=at.current;if(W){const J=W.clientWidth,be=W.clientHeight,Ee=.2,$e=J*(1-Ee),ze=be*(1-Ee),Fe=$e/i.bounds.width,Ke=ze/i.bounds.height,Ve=Math.min(Fe,Ke,1.5),Je=Math.max(Ve,.3);Oe(v,R,{zoom:Je,duration:800})}else Oe(v,R,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Et===i.id?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white shadow-lg":"bg-white/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-white dark:hover:bg-white/20"}`,children:i.name},i.id))})}),!1,e.jsxs("div",{className:`absolute ${I?"top-14":"top-5"} left-1/2 transform -translate-x-1/2 z-[100] flex gap-2`,children:[e.jsx("button",{onClick:()=>{U(G&&E&&u?`/projects/${E}/episodes/${u}`:"/quick")},className:"w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105",title:G?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"arrow_back"})}),!I&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!Ue&&l&&Zs(!ys)},disabled:Ue||!l,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":ys?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105"}`,title:l?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:ys?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!Ue&&l&&Yr()},disabled:Ue||!l||!Cr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":Cr?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:l?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"group_work"})}),e.jsx("button",{onClick:()=>{!Ue&&l&&Kr()},disabled:Ue||!l||!pr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":pr?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:l?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"group_off"})}),e.jsx("button",{onClick:()=>{!Ue&&l&&Qr()},disabled:Ue||!l||!pr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":pr?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:l?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"edit"})}),e.jsx("button",{onClick:()=>qr(),className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${hs?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105"}`,title:hs?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"text_fields"})})]})]}),a&&es.length>0&&e.jsxs("div",{className:`absolute ${I?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:es.slice(0,8).map(i=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-purple-200 dark:bg-purple-800 flex items-center justify-center overflow-hidden shadow-sm",title:i.nickname||"ç”¨æˆ·",children:i.avatar?e.jsx("img",{src:i.avatar.startsWith("http")?i.avatar:`https://api.waule.com${i.avatar}`,alt:i.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-purple-600 dark:text-purple-300",children:"person"})},i.id))}),es.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",es.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${ys?"cursor-crosshair":""} ${hs?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(ma,{nodes:Cs,edges:_,onNodesChange:I?void 0:xs,onEdgesChange:I?void 0:Fr,onNodesDelete:I?void 0:Wr,onEdgesDelete:I?void 0:zr,onConnect:I?void 0:ir,onConnectStart:I?void 0:Xr,onConnectEnd:I?void 0:Jr,onEdgeDoubleClick:I?void 0:Gs,onPaneContextMenu:I?void 0:Br,onPaneClick:I?void 0:Zr,onMove:ea,onNodeClick:I?void 0:aa,onNodeDragStart:I?void 0:ta,onNodeDrag:I?void 0:sa,onNodeDragStop:I?void 0:ra,nodeTypes:Bo,edgeTypes:Ho,nodesDraggable:!I,nodesConnectable:!I,elementsSelectable:!I,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${ys?"cursor-crosshair":""} ${I?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#a855f7",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:I?!1:ys,panOnDrag:ys?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(xa,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#a855f7"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#ec4899"})]})}),Le.filter(i=>!i.hidden).map(i=>{const v=me(),R=i.bounds.x*v.zoom+v.x,W=i.bounds.y*v.zoom+v.y,J=i.bounds.width*v.zoom,be=i.bounds.height*v.zoom,Ee=12*v.zoom,$e=Math.max(1.25,1.25*v.zoom),ze=document.documentElement.classList.contains("dark"),Fe=Et===i.id;return e.jsxs("g",{children:[e.jsx("rect",{x:R,y:W,width:J,height:be,rx:Ee,ry:Ee,fill:"none",stroke:Fe?"url(#group-border-gradient)":ze?"#e5e7eb":"#4b5563",strokeWidth:$e,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:R,y:W,width:J,height:be,rx:Ee,ry:Ee,fill:"transparent",stroke:"transparent",strokeWidth:$e*3,style:{pointerEvents:"stroke",cursor:cs===i.id?"grabbing":"grab"},onMouseDown:Ke=>{Ke.stopPropagation(),Ke.preventDefault(),Er(Ke,i.id)},onClick:Ke=>{Ke.stopPropagation(),nt(i.id)}})]},i.id)})]})},qs),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Le.filter(i=>!i.hidden).map(i=>{if(!i.name)return null;const v=me(),R=i.bounds.x*v.zoom+v.x,W=i.bounds.y*v.zoom+v.y,J=40*v.zoom,be=10*v.zoom,Ee=15*v.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:$e=>{$e.stopPropagation(),Er($e,i.id)},onClick:$e=>{$e.stopPropagation(),nt(i.id)},style:{left:R+be,top:W-J-be-Ee,fontSize:`${J}px`,cursor:cs===i.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:i.name},`label-${i.id}`)})},`labels-${qs}`),q&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:q.x,top:q.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{de.current&&(clearTimeout(de.current),de.current=null),F("agent")},onMouseLeave:()=>{de.current=window.setTimeout(()=>{F(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>F("agent"),onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),F("agent")},onClick:i=>{i.preventDefault(),i.stopPropagation(),F("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),P==="agent"&&e.jsx("div",{onMouseEnter:()=>{de.current&&(clearTimeout(de.current),de.current=null),F("agent")},onMouseLeave:i=>{const v=i.currentTarget.parentElement,R=i.relatedTarget;(!v||!v.contains(R))&&(de.current=window.setTimeout(()=>{F(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:d.length>0?d.map(i=>e.jsxs("button",{onMouseDown:v=>{v.preventDefault(),v.stopPropagation(),ds("agent",i.name,"agent",i.id,i.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:i.name}),i.description&&e.jsx("div",{className:"text-xs text-purple-400 truncate",children:i.description})]})]},i.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ds("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{ne.current&&(clearTimeout(ne.current),ne.current=null),b(!0)},onMouseLeave:()=>{ne.current=window.setTimeout(()=>{b(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{F("video")},onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),F("video")},onClick:i=>{i.preventDefault(),i.stopPropagation(),F("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),k&&e.jsxs("div",{onMouseEnter:()=>{ne.current&&(clearTimeout(ne.current),ne.current=null),b(!0)},onMouseLeave:i=>{const v=i.currentTarget.parentElement,R=i.relatedTarget;(!v||!v.contains(R))&&(ne.current=window.setTimeout(()=>{b(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),je.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),je.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),je.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),je.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(je.has("å‚è€ƒå›¾")||je.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),je.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{de.current&&(clearTimeout(de.current),de.current=null),F("edit")},onMouseLeave:()=>{de.current=window.setTimeout(()=>{F(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{F("edit")},onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),F("edit")},onClick:i=>{i.preventDefault(),i.stopPropagation(),F("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),P==="edit"&&e.jsxs("div",{onMouseEnter:()=>{de.current&&(clearTimeout(de.current),de.current=null),F("edit")},onMouseLeave:i=>{const v=i.currentTarget.parentElement,R=i.relatedTarget;(!v||!v.contains(R))&&(de.current=window.setTimeout(()=>{F(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Te.filter(i=>Re(i).length>0).map(i=>e.jsxs("button",{onMouseDown:v=>{v.preventDefault(),v.stopPropagation(),i==="å¯¹å£å‹"?ds("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):i==="é£æ ¼è½¬æ¢"?ds("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ds("video",i==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${i}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:i}),V(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:i})]},i)),Te.every(i=>Re(i).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ds("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ds("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ds("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ds("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]}),os&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:os.x+5,top:os.y+5},children:[Ks.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{ue(null),Se.current&&(clearTimeout(Se.current),Se.current=null),ge(!0)},onMouseLeave:()=>{Se.current=window.setTimeout(()=>{ge(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>ge(!0),onMouseLeave:()=>ge(!1),onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ge(!0)},onClick:i=>{i.preventDefault(),i.stopPropagation(),ge(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),H&&e.jsx("div",{onMouseEnter:()=>{Se.current&&(clearTimeout(Se.current),Se.current=null),ge(!0)},onMouseLeave:()=>{Se.current=window.setTimeout(()=>{ge(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:d.length>0?d.map(i=>e.jsxs("button",{onMouseDown:v=>{v.preventDefault(),v.stopPropagation(),ps("agent",i.name,"agent",i.id,i.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:i.name}),i.description&&e.jsx("div",{className:"text-xs text-purple-400 truncate",children:i.description})]})]},i.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Ks.showAiImage&&e.jsxs("button",{onMouseEnter:()=>ue(null),onClick:()=>ps("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),!1,Ks.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{ie.current&&(clearTimeout(ie.current),ie.current=null),ue("video")},onMouseLeave:()=>{ie.current=window.setTimeout(()=>{ue(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>ue("video"),onClick:i=>i.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),X==="video"&&e.jsxs("div",{onMouseEnter:()=>{ie.current&&(clearTimeout(ie.current),ie.current=null),ue("video")},onMouseLeave:i=>{const v=i.currentTarget.parentElement,R=i.relatedTarget;(!v||!v.contains(R))&&(ie.current=window.setTimeout(()=>{ue(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ps("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),je.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ps("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),je.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ps("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),je.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ps("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),je.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ps("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(je.has("å‚è€ƒå›¾")||je.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ps("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),je.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ps("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Ks.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{ue(null),ye.current&&(clearTimeout(ye.current),ye.current=null),V(!0)},onMouseLeave:()=>{ye.current=window.setTimeout(()=>{V(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>V(!0),onMouseLeave:()=>V(!1),onClick:i=>{i.preventDefault(),i.stopPropagation(),V(!0)},onMouseOver:()=>ue(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),p&&e.jsxs("div",{onMouseEnter:()=>{ye.current&&(clearTimeout(ye.current),ye.current=null),V(!0)},onMouseLeave:i=>{const v=i.currentTarget.parentElement,R=i.relatedTarget;(!v||!v.contains(R))&&(ye.current=window.setTimeout(()=>{V(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Te.filter(i=>Re(i).length>0).map(i=>e.jsxs("button",{onMouseDown:v=>{v.preventDefault(),v.stopPropagation(),i==="å¯¹å£å‹"?ps("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):i==="é£æ ¼è½¬æ¢"?ps("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ps("aiVideo_swap",i==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${i}`,"video"),V(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:i})]},`conn-${i}`)),Te.every(i=>Re(i).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>ue(null),onClick:()=>ps("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showUpload&&e.jsxs("button",{onMouseEnter:()=>ue(null),onClick:()=>ps("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Ks.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>ue(null),onClick:()=>ps("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Ks.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>ue(null),onClick:()=>ps("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(zo,{isOpen:re,onClose:()=>{Be(!1),Ft(null)},onAssetSelect:Hr}),tt&&Kt&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>_t(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:i=>i.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>_t(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const i=document.getElementById("scene-input"),v=document.getElementById("shot-input"),R=parseInt((i==null?void 0:i.value)||"0"),W=parseInt((v==null?void 0:v.value)||"0");if(R>0&&W>0){if(Le.find(be=>be.id!==Kt&&be.scene===R&&be.shot===W)){h.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${R}å¹•-ç¬¬${W}é•œ`);return}ut(be=>{const Ee=be.map(ze=>ze.id===Kt?{...ze,scene:R,shot:W,name:`ç¬¬${R}å¹•-ç¬¬${W}é•œ`}:ze),$e=Ee.find(ze=>ze.id===Kt);return $e&&$(ze=>{const Fe=new Set;return _.forEach(Ke=>{if($e.nodeIds.includes(Ke.source)){const Ve=ze.find(Je=>Je.id===Ke.target);Ve&&(Ve.type==="imagePreview"||Ve.type==="videoPreview")&&Fe.add(Ke.target)}}),ze.map(Ke=>$e.nodeIds.includes(Ke.id)||Fe.has(Ke.id)?{...Ke,data:{...Ke.data,workflowContext:{...Ke.data.workflowContext,nodeGroup:$e,nodeGroups:Ee}}}:Ke)}),setTimeout(()=>{qt()},100),Ee}),_t(!1),bs(null),h.success(`å·²å‘½åä¸ºï¼šç¬¬${R}å¹•-ç¬¬${W}é•œ`)}else h.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},sn=()=>e.jsx(pa,{children:e.jsx(Xo,{})});export{sn as default};
