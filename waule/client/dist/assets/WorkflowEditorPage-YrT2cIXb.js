const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Dg_hJ4va.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-Bp-RHhWQ.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Gt,u as Sr,z as $s,e as xa,d as ba}from"./react-vendor-BvY2dB7B.js";import{u as Er,l as wa,b as _e,_ as ds,c as m,e as ya}from"./index-Dg_hJ4va.js";import{P as ut,H as gs,a as Zt,b as Ls,d as Fs,e as zs,g as ka,R as va,f as Na,h as ja,i as Ia,j as Sa,C as Ea}from"./reactflow-D8v6_Qvs.js";import{C as Ca,L as Ds,S as pr,I as Dr,T as zr,V as Aa}from"./video-CPXLMxBS.js";import{c as Us}from"./createLucideIcon-CK1cQnin.js";import{X as _a,j as Zs,L as Vs,o as Lr,a as Ta,v as or,U as Pr,b as Ua,N as Ra}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Us("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Us("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Us("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Us("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Us("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Us("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Us("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ir=Us("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Us("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Us("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Br=Us("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=Us("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),za="https://api.waule.ai";function Ba(s){const{workflowId:j,isSharedWorkflow:n,isReadOnly:W,onNodeAdd:ye,onNodeUpdate:T,onNodeDelete:fe,onNodeMove:Z,onNodesMove:re,onEdgeAdd:K,onEdgeDelete:de,onGroupsUpdate:Ue,onUserJoin:ce}=s,se=t.useRef(null),ae=t.useRef(!1),{token:je}=Er(),[ie,xe]=t.useState([]);t.useEffect(()=>{if(!n||!j||!je)return;const f=wa(za,{auth:{token:je},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return se.current=f,f.on("connect",()=>{ae.current=!0,f.emit("join-workflow",j),f.emit("user:join",{workflowId:j})}),f.on("disconnect",x=>{ae.current=!1}),f.on("connect_error",x=>{}),f.on("node:add",x=>{ye==null||ye(x.node,x.userId)}),f.on("node:update",x=>{T==null||T(x.nodeId,x.changes,x.userId)}),f.on("node:delete",x=>{fe==null||fe(x.nodeId,x.userId)}),f.on("node:move",x=>{Z==null||Z(x.nodeId,x.position,x.userId)}),f.on("nodes:move",x=>{re==null||re(x.nodes,x.userId)}),f.on("edge:add",x=>{K==null||K(x.edge,x.userId)}),f.on("edge:delete",x=>{de==null||de(x.edgeId,x.userId)}),f.on("groups:update",x=>{Ue==null||Ue(x.groups,x.userId)}),f.on("user:join",x=>{ce==null||ce(x.user)}),f.on("users:online",x=>{xe(x.users)}),()=>{se.current&&(se.current.emit("leave-workflow",j),se.current.disconnect(),se.current=null),ae.current=!1,xe([])}},[j,n,je]);const ue=t.useCallback(f=>{se.current&&ae.current&&j&&!W&&se.current.emit("node:add",{workflowId:j,node:f})},[j,W]),pe=t.useCallback((f,x)=>{se.current&&ae.current&&j&&!W&&se.current.emit("node:update",{workflowId:j,nodeId:f,changes:x})},[j,W]),Ie=t.useCallback(f=>{se.current&&ae.current&&j&&!W&&se.current.emit("node:delete",{workflowId:j,nodeId:f})},[j,W]),ee=t.useCallback((f,x)=>{se.current&&ae.current&&j&&!W&&se.current.emit("node:move",{workflowId:j,nodeId:f,position:x})},[j,W]),Q=t.useCallback(f=>{se.current&&ae.current&&j&&!W&&se.current.emit("nodes:move",{workflowId:j,nodes:f})},[j,W]),U=t.useCallback(f=>{se.current&&ae.current&&j&&!W&&se.current.emit("edge:add",{workflowId:j,edge:f})},[j,W]),R=t.useCallback(f=>{se.current&&ae.current&&j&&!W&&se.current.emit("edge:delete",{workflowId:j,edgeId:f})},[j,W]),L=t.useCallback(f=>{se.current&&ae.current&&j&&!W&&se.current.emit("groups:update",{workflowId:j,groups:f})},[j,W]);return{isConnected:ae.current,onlineUsers:ie,emitNodeAdd:ue,emitNodeUpdate:pe,emitNodeDelete:Ie,emitNodeMove:ee,emitNodesMove:Q,emitEdgeAdd:U,emitEdgeDelete:R,emitGroupsUpdate:L}}const Cr=1920,Hr=(s,j=Cr,n=.9)=>new Promise((W,ye)=>{const T=new Image,fe=URL.createObjectURL(s);T.onload=()=>{URL.revokeObjectURL(fe);let{width:Z,height:re}=T;if(Z>j||re>j){const ce=j/Math.max(Z,re);Z=Math.round(Z*ce),re=Math.round(re*ce)}const K=document.createElement("canvas");K.width=Z,K.height=re;const de=K.getContext("2d");if(!de){ye(new Error("Failed to get canvas context"));return}de.drawImage(T,0,0,Z,re);const Ue=K.toDataURL("image/jpeg",n);W(Ue)},T.onerror=()=>{URL.revokeObjectURL(fe),ye(new Error("Failed to load image for compression"))},T.src=fe}),Or=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(n=>n.test(s)):!1,Ha=async s=>{try{const j=s.startsWith("/uploads/")?`https://api.waule.ai${s}`:s,W=await(await fetch(j)).blob();return await Hr(W,Cr,.9)}catch(j){throw j}},dr=async s=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(s.length>500*1024)try{const n=await(await fetch(s)).blob();return await Hr(n,Cr,.9)}catch{return s}return s}return s.includes("aliyuncs.com")||s.includes("oss-cn-")||s.startsWith("https://")&&!Or(s)?s:Or(s)?await Ha(s):s},St=({type:s,position:j,id:n,className:W="",label:ye,isConnectable:T,disabled:fe,style:Z,...re})=>{const K=j===ut.Left,de=T===!1||fe?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${W}`;return e.jsxs("div",{className:`absolute ${K?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...Z||{}},children:[K&&ye&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:ye}),e.jsx(gs,{type:s,position:j,id:n,isConnectable:fe?!1:T,style:{position:"relative",[K?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${de} !z-[10001]`,...re}),!K&&ye&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:ye})]})},os=({value:s,onChange:j,options:n,className:W=""})=>{const[ye,T]=t.useState(!1),fe=t.useRef(null);t.useEffect(()=>{if(!ye)return;const K=de=>{fe.current&&!fe.current.contains(de.target)&&T(!1)};return document.addEventListener("mousedown",K,!0),()=>document.removeEventListener("mousedown",K,!0)},[ye]);const Z=n.find(K=>K.value===s),re=K=>{K.stopPropagation(),T(!ye)};return e.jsxs("div",{className:`relative ${W}`,ref:fe,children:[e.jsxs("div",{onClick:re,onMouseDown:K=>K.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(Z==null?void 0:Z.label)||s}),e.jsx(Ca,{size:12,className:`transition-transform ${ye?"rotate-90":""}`})]}),ye&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white dark:bg-[#18181b] backdrop-blur-xl border-slate-200 dark:border-white/10",children:n.map(K=>e.jsxs("div",{onClick:de=>{de.stopPropagation(),j(K.value),T(!1)},onMouseDown:de=>de.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[K.label,s===K.value&&e.jsx(Da,{size:10,className:"text-neutral-500"})]},K.value))})]})},Ss=s=>{const[j,n]=t.useState(null),[W,ye]=t.useState(!1),[T,fe]=t.useState(!1),[Z,re]=t.useState(0),[K,de]=t.useState(0),Ue=t.useCallback(()=>{de(ce=>ce+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){n(null),fe(!1),re(0);return}try{ye(!0);const ae=(await _e.post("/billing/estimate",s)).data,je=(ae==null?void 0:ae.data)??ae,ie=(je==null?void 0:je.originalCredits)??(je==null?void 0:je.credits)??0;n(ie),fe((je==null?void 0:je.isFreeUsage)??!1),re((je==null?void 0:je.freeUsageRemaining)??0)}catch{n(null),fe(!1),re(0)}finally{ye(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,K]),{credits:j,loading:W,isFreeUsage:T,freeUsageRemaining:Z,refetch:Ue}},hs=({createdBy:s,isSharedWorkflow:j})=>{if(!j||!s||typeof s=="string")return null;const{nickname:n,avatar:W}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:n||"æœªçŸ¥ç”¨æˆ·",children:W?e.jsx("img",{src:W,alt:n||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-neutral-800 to-neutral-700 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(n||"?")[0].toUpperCase()})})},Xa=({data:s,selected:j,id:n})=>{var oe;const[W,ye]=t.useState(s.isExpanded!==!1),[T,fe]=t.useState(null),[Z,re]=t.useState(s.config.prompt||""),[K,de]=t.useState(s.config.ratio||""),[Ue,ce]=t.useState(s.config.imageSize||"2K"),[se,ae]=t.useState(s.config.maxImages||1),[je,ie]=t.useState(!1),[,xe]=t.useState(0),[,ue]=t.useState(s.config.taskId||""),[pe,Ie]=t.useState(s.config.referenceImages||[]),[ee,Q]=t.useState(null),U=t.useRef(null),R=t.useRef(!1),{setNodes:L,setEdges:f,getNode:x,getEdges:A,getNodes:F}=Zt(),G=Ls(),v=Fs(N=>N.edges.filter(h=>h.target===n)),$=t.useRef(""),r=t.useRef(""),{credits:w,loading:u,isFreeUsage:a,freeUsageRemaining:b,refetch:c}=Ss({aiModelId:T==null?void 0:T.id,quantity:1,resolution:Ue}),p=t.useMemo(()=>(s.models||[]).filter(N=>N.type==="IMAGE_GENERATION"&&N.isActive&&!N.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const N=p.find(h=>h.id===s.config.modelId);if(N){fe(N);const h=N.config;h!=null&&h.supportedRatios&&h.supportedRatios.length>0&&!K&&de(h.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(h==null?void 0:h.acceptedInputs)||["TEXT","IMAGE"]})}}else if(p.length>0){fe(p[0]);const N=p[0].config;N!=null&&N.supportedRatios&&N.supportedRatios.length>0&&!K&&de(N.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(N==null?void 0:N.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,p]),t.useEffect(()=>{const N=s.config.taskId;(async()=>{if(N)try{const y=(await _e.tasks.getTaskStatus(N)).task;if(y.status==="SUCCESS"){ie(!1),xe(100);const J=y.resultUrl;if(!J){ie(!1),xe(0),l({taskId:""}),Gt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ge=s.config.ratio||"1:1";l({prompt:s.config.prompt||Z,ratio:ge,modelId:s.config.modelId||(T==null?void 0:T.id),generatedImageUrl:J,taskId:""});const B=F(),he=A();if(B.filter(Re=>Re.type==="imagePreview"&&he.some(Ce=>Ce.source===n&&Ce.target===Re.id)).find(Re=>Re.data.imageUrl===J)){l({taskId:""}),Gt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Gt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const Re=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Re).some($e=>$e.taskId&&$e.taskId===N||$e.sourceNodeId&&$e.sourceNodeId===n)||me(J,ge)}catch{me(J,ge)}}else y.status==="PROCESSING"||y.status==="PENDING"?(ie(!0),xe(y.progress||0),X(N)):y.status==="FAILURE"&&(ie(!1),xe(0),l({taskId:""}),Gt.error(y.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${y.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ie(!1),xe(0),l({taskId:""}),Gt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const d=()=>{if(!T)return[];const N=T.config;return(N==null?void 0:N.supportedRatios)||[]},k=()=>{var y;const N=(y=s==null?void 0:s.config)==null?void 0:y.modelId,h=p.find(J=>J.id===N)||p[0],E=(h==null?void 0:h.config)||{};return E.maxReferenceImages||E.supportedReferenceImagesLimit||E.referenceImagesLimit||10};function _(N){var E,y,J,ge,B,he,Se;const h=(N==null?void 0:N.type)||"";if(h==="upload")return(((y=(E=N==null?void 0:N.data)==null?void 0:E.config)==null?void 0:y.uploadedFiles)||[]).reduce((Re,Ce)=>{const Ae=((Ce==null?void 0:Ce.type)||"").toUpperCase(),$e=((Ce==null?void 0:Ce.mimeType)||"").toLowerCase();return Re+(Ae==="IMAGE"||$e.startsWith("image/")?1:0)},0);if(h==="assetSelector"){const Ne=((J=N==null?void 0:N.data)==null?void 0:J.config)||{};if(Ne.selectedAsset){const Re=(Ne.selectedAsset.type||"").toUpperCase(),Ce=(Ne.selectedAsset.mimeType||"").toLowerCase();return Re==="IMAGE"||Ce.startsWith("image/")?1:0}return Array.isArray(Ne.subjects)&&Ne.subjects.length>0&&(((ge=Ne.subjects[0])==null?void 0:ge.images)||[]).length>0?1:0}return h==="aiImage"?((he=(B=N==null?void 0:N.data)==null?void 0:B.config)==null?void 0:he.generatedImageUrl)?1:0:h==="imagePreview"&&((Se=N==null?void 0:N.data)==null?void 0:Se.imageUrl)?1:0}function O(N){var y,J,ge,B;const h=(N==null?void 0:N.type)||"",E=N==null?void 0:N.data;if(h==="upload"&&((J=(y=E==null?void 0:E.config)==null?void 0:y.uploadedFiles)==null?void 0:J.length)>0){const he=E.config.uploadedFiles[0],Se=(he.type||"").toUpperCase(),Ne=(he.mimeType||"").toLowerCase();return Se==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Se==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Se==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Se||null}if(h==="assetSelector"){if((ge=E==null?void 0:E.config)!=null&&ge.subjects)return"IMAGE";if((B=E==null?void 0:E.config)!=null&&B.selectedAsset){const he=E.config.selectedAsset,Se=(he.type||"").toUpperCase(),Ne=(he.mimeType||"").toLowerCase();return Se==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Se==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Se==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Se||null}}return h==="aiImage"||h==="imagePreview"?"IMAGE":(h||"").startsWith("aiVideo")||h==="videoPreview"?"VIDEO":h==="agent"?"TEXT":null}const I=t.useMemo(()=>{const N=v,h=N.some(J=>{const ge=x(J.source);return((ge==null?void 0:ge.type)||"")==="agent"}),E=k(),y=N.reduce((J,ge)=>J+_(x(ge.source)),0);return h&&y>=E},[v,x]),g=N=>{const h=x(N.source);if(!h)return!1;const E=h.type||"",y=A().filter(Ne=>Ne.target===n),J=O(h);if(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")return!1;const ge=y.some(Ne=>{const Re=x(Ne.source);return((Re==null?void 0:Re.type)||"")==="agent"});if(E==="agent"||E==="textPreview")return!ge;const B=y.reduce((Ne,Re)=>Ne+_(x(Re.source)),0),he=_(h),Se=k();return B+he<=Se};t.useEffect(()=>{const N=v;let E=k();const y=[];N.forEach(J=>{const ge=x(J.source),B=_(ge);B<=0||(E-B>=0?E-=B:y.push(J.id))}),y.length>0&&(f(J=>J.filter(ge=>!y.includes(ge.id))),Gt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[v,x,f]),t.useEffect(()=>{const N=v,h=[];N.forEach(E=>{const y=x(E.source),J=O(y);(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")&&h.push(E.id)}),h.length>0&&(f(E=>E.filter(y=>!h.includes(y.id))),Gt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[v,x,f]),t.useEffect(()=>{const N=v.map(ge=>{var Ne,Re,Ce,Ae,$e;const B=x(ge.source);if(!B)return`${ge.id}-${ge.source}`;const he=B.data||{};let Se=[];if(B.type==="assetSelector"){const le=(Ne=he.config)==null?void 0:Ne.subjects;if(le&&le.length>0){const Ge=(Re=le[0].images)==null?void 0:Re[0];Se=Ge?[Ge]:[]}else(Ce=he.config)!=null&&Ce.selectedAsset&&he.config.selectedAsset.type==="IMAGE"&&(Se=[he.config.selectedAsset.url])}else if(B.type==="upload")Se=(((Ae=he.config)==null?void 0:Ae.uploadedFiles)||[]).filter(Ge=>Ge.type==="IMAGE").map(Ge=>Ge.url);else if(B.type==="aiImage"||B.type==="imagePreview"){const le=(($e=he.config)==null?void 0:$e.generatedImageUrl)||he.imageUrl;le&&(Se=[le])}return`${ge.id}-${ge.source}-${Se.join("|")}`}).sort().join(",");if(N===$.current)return;$.current=N;const h=[];let E="";v.forEach(ge=>{var he,Se,Ne,Re,Ce,Ae;const B=x(ge.source);if(B){const $e=B.data;if(B.type==="agent"&&((he=$e.config)!=null&&he.generatedText)?E||(E=$e.config.generatedText):B.type==="textPreview"&&$e.content&&(E||(E=$e.content)),B.type==="assetSelector"&&((Se=$e.config)!=null&&Se.subjects)&&$e.config.subjects.length>0){const Ge=(Ne=$e.config.subjects[0].images)==null?void 0:Ne[0];Ge&&!h.includes(Ge)&&h.push(Ge)}let le=((Re=$e.config)==null?void 0:Re.generatedImageUrl)||$e.imageUrl||"";if(!le&&((Ce=$e.config)!=null&&Ce.selectedAsset)){const Ge=$e.config.selectedAsset;Ge.type==="IMAGE"&&(le=Ge.url)}if(!le&&((Ae=$e.config)!=null&&Ae.uploadedFiles)&&$e.config.uploadedFiles.length>0){const Ge=$e.config.uploadedFiles[0];Ge.type==="IMAGE"&&(le=Ge.url)}le&&!h.includes(le)&&h.push(le)}});const y=k(),J=h.slice(0,Math.max(0,y));Ie(J),l({referenceImages:J}),E&&E!==Z&&(re(E),l({prompt:E}))},[v,x,n,Z,G]),t.useEffect(()=>{if(v.length===0)return;let N="",h="";v.forEach(E=>{var J;const y=G.find(ge=>ge.id===E.source);if(y&&y.type==="agent"){const ge=y.data;(J=ge.config)!=null&&J.generatedText&&(N=ge.config.generatedText,h=`${y.id}-${ge.config.generatedText.substring(0,50)}`)}}),N&&h!==r.current&&(r.current=h,re(N),l({prompt:N}))},[G,v,n]),t.useEffect(()=>{const N=U.current;N&&W&&requestAnimationFrame(()=>{N.style.height="auto";const h=Math.max(60,Math.min(N.scrollHeight,600));N.style.height=`${h}px`})},[Z,W]),t.useEffect(()=>{const N=setTimeout(()=>{Z!==s.config.prompt&&l({prompt:Z})},300);return()=>clearTimeout(N)},[Z]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Z&&re(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{K&&K!==s.config.ratio&&l({ratio:K})},[K]),t.useEffect(()=>{Ue&&Ue!==s.config.imageSize&&l({imageSize:Ue})},[Ue]),t.useEffect(()=>{var N;if((T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"){const h=((N=T==null?void 0:T.config)==null?void 0:N.supportedResolutions)||[];(h.length>0&&!h.includes(Ue)||h.length===1)&&ce(h[0])}},[T]),t.useEffect(()=>{se!==s.config.maxImages&&l({maxImages:se})},[se]);const l=N=>{x(n)&&L(E=>E.map(y=>y.id===n?{...y,data:{...y.data,config:{...y.data.config,...N}}}:y))},i=N=>{Q(N)},z=(N,h)=>{if(N.preventDefault(),ee===null||ee===h)return;const E=[...pe],y=E[ee];E.splice(ee,1),E.splice(h,0,y),Ie(E),Q(h)},D=()=>{Q(null),l({referenceImages:pe})},X=async N=>{let E=0;const y=async()=>{var J;try{E++;const B=(await _e.tasks.getTaskStatus(N)).task;if(xe(B.progress||0),B.status==="SUCCESS"){ie(!1),xe(100);const he=B.resultUrl,Se=(J=B.metadata)==null?void 0:J.allImageUrls;l({prompt:Z,ratio:K,modelId:T==null?void 0:T.id,generatedImageUrl:he,taskId:""}),Se&&Se.length>1?(ne(Se,K),Gt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Se.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(me(he,K),Gt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(B.status==="FAILURE"){ie(!1),xe(0),l({taskId:""});const{useAuthStore:he}=await ds(async()=>{const{useAuthStore:Ne}=await import("./index-Dg_hJ4va.js").then(Re=>Re.f);return{useAuthStore:Ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Se}=he.getState();await Se(),Gt.error(B.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(B.status==="PROCESSING"||B.status==="PENDING")&&(E<600?setTimeout(y,1e3):(ie(!1),xe(0),l({taskId:""}),Gt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ie(!1),xe(0),l({taskId:""}),Gt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};y()},V=async()=>{var N,h,E,y,J;if(!(!Z.trim()||!T)){ie(!0),xe(0);try{let he=[];if(pe.length>0)try{for(const Ge of pe){if(Ge.startsWith("http")||Ge.startsWith("/"))try{const Ct=(await fetch(Ge,{method:"HEAD"})).headers.get("content-length");if(Ct&&parseInt(Ct)>10485760){Gt.error("å‚è€ƒå›¾ç‰‡è¶…è¿‡ 10MB é™åˆ¶ï¼Œè¯·å‹ç¼©åé‡è¯•"),ie(!1);return}}catch{}const Qe=await dr(Ge);he.push(Qe)}}catch{}let Se=Z.trim();T.modelId==="doubao-seedream-4-5-251128"&&se>1&&(Se=`ç”Ÿæˆä¸€ç»„å…±${se}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${Se}`),T.modelId==="gemini-3-pro-image-preview"&&K&&(Se=`${Se}ï¼Œç”Ÿæˆ${K}çš„æ¯”ä¾‹`);const Ne={modelId:T.id,prompt:Se,ratio:K||"1:1",referenceImages:he.length>0?he:void 0};T.modelId==="gemini-3-pro-image-preview"&&(Ne.imageSize=Ue),T.modelId==="doubao-seedream-4-5-251128"&&se>1&&(Ne.maxImages=se);const Re=await _e.tasks.createImageTask(Ne),Ce=Re.taskId,Ae=Re.creditsCharged||0,$e=Re.isFreeUsage,le=Re.freeUsageRemaining??0;if(ue(Ce),l({prompt:Z,ratio:K,modelId:T.id,taskId:Ce}),$e)Gt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${le} æ¬¡æœºä¼š`),c();else if(Ae>0){const{useAuthStore:Ge}=await ds(async()=>{const{useAuthStore:Wt}=await import("./index-Dg_hJ4va.js").then(Ct=>Ct.f);return{useAuthStore:Wt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Qe}=Ge.getState();await Qe(),Gt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${Ae} ç§¯åˆ†`),c()}else Gt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");X(Ce)}catch(ge){if(ie(!1),xe(0),((N=ge.response)==null?void 0:N.status)===403){const B=((E=(h=ge.response)==null?void 0:h.data)==null?void 0:E.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Gt.error(B)}else{const B=((J=(y=ge.response)==null?void 0:y.data)==null?void 0:J.error)||ge.message||"æœªçŸ¥åŸå› ";Gt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ne=(N,h)=>{!N||N.length===0||N.forEach((E,y)=>{setTimeout(()=>{me(E,h,y)},y*100)})},me=(N,h,E)=>{const y=x(n);if(!y)return;const J=1,ge=F(),B=A(),he=ge.filter(yt=>yt.type==="imagePreview"&&B.some(Be=>Be.source===n&&Be.target===yt.id));if(he.find(yt=>yt.data.imageUrl===N))return;const Ne=400,Re=(yt,Be=300)=>{if(!yt||!/^[0-9]+\s*:\s*[0-9]+$/.test(yt))return Be;const[wt,Yt]=yt.split(":").map(vs=>parseFloat(vs));return!wt||!Yt?Be:Math.round(Ne*(Yt/wt))},Ce=document.querySelector(`.react-flow__node[data-id="${n}"]`),Ae=(Ce==null?void 0:Ce.getBoundingClientRect().width)||400,$e=Math.round(Ae/J),le=200,Ge=100,Qe=Re(h,300),Wt=y.position.x+$e+le,Ct=y.position.y,_t=E!==void 0?he.length+E:he.length,ct=Wt,gt=Ct+_t*(Qe+Ge),vt=Date.now(),it={id:`preview-${n}-${vt}`,type:"imagePreview",position:{x:ct,y:gt},data:{imageUrl:N,width:Ne,ratio:h,workflowContext:y.data.workflowContext,createdBy:y.data.createdBy}};L(yt=>[...yt,it]);const Ye={id:`edge-${n}-${it.id}`,source:n,target:it.id,targetHandle:`${it.id}-target`,type:"aurora"};f(yt=>yt.find(wt=>wt.source===n&&wt.target===it.id)?yt:[...yt,Ye])};if(t.useEffect(()=>{s.isExpanded!==void 0&&ye(s.isExpanded)},[s.isExpanded]),!W&&s.config.generatedImageUrl){const[N,h]=(s.config.ratio||"1:1").split(":").map(Number),E=N/h,y=320,J=y/E;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:y,height:J},onDoubleClick:()=>{ye(!0),x(n)&&L(B=>B.map(he=>he.id===n?{...he,data:{...he.data,isExpanded:!0}}:he))},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:I,isValidConnection:g}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),Z&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:Z,children:Z})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!W&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{ye(!0),x(n)&&L(h=>h.map(E=>E.id===n?{...E,data:{...E.data,isExpanded:!0}}:E))},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:I,isValidConnection:g}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Z?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:Z})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:I,isValidConnection:g}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:W?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:(T==null?void 0:T.id)||"",onChange:N=>{const h=p.find(E=>E.id===N);if(fe(h||null),h){const E=h.config;E!=null&&E.supportedRatios&&E.supportedRatios.length>0&&de(E.supportedRatios[0]),l({modelId:h.id,acceptedInputs:(E==null?void 0:E.acceptedInputs)||["TEXT","IMAGE"]})}},options:p.map(N=>({value:N.id,label:N.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:U,value:Z,onChange:N=>{R.current=!0,re(N.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),pe.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",pe.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:pe.map((N,h)=>e.jsxs("div",{draggable:!0,onDragStart:E=>{E.stopPropagation(),i(h)},onDragEnd:E=>{E.stopPropagation(),D()},onDragOver:E=>{E.stopPropagation(),z(E,h)},className:`nodrag relative group cursor-move aspect-square ${ee===h?"opacity-50":""}`,children:[e.jsx("img",{src:N,alt:`å›¾ç‰‡${h+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:h+1})]},h))})]}),(T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"&&(()=>{var h;const N=((h=T==null?void 0:T.config)==null?void 0:h.supportedResolutions)||[];return N.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${N.length} gap-2`,children:N.map(E=>e.jsx("button",{onClick:()=>ce(E),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Ue===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:E==="4K"?"4k":"hd"}),e.jsx("span",{children:E})]})},E))})]})})(),(T==null?void 0:T.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-neutral-500 dark:text-neutral-400",children:[se," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:se,onChange:N=>ae(Number(N.target.value)),className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(se-1)/14*50}%, #06b6d4 ${(se-1)/14*100}%, var(--range-bg-color) ${(se-1)/14*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),se>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),d().length>0&&e.jsx("div",{className:"space-y-1",children:((oe=T==null?void 0:T.provider)==null?void 0:oe.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>de("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${K==="16:9"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>de("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${K==="9:16"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(os,{value:K,onChange:N=>de(N),options:d().map(N=>{const[h,E]=N.split(":");return{value:N,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[N]||`${h}:${E}`}})})]})}),e.jsx("button",{onClick:V,onPointerDown:N=>N.stopPropagation(),onMouseDown:N=>N.stopPropagation(),disabled:je||!Z.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${je||!Z.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:je?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(pr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!u&&(a?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(b),"æ¬¡"]}):w!==null&&w>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[w,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ja=t.memo(Xa),hr="https://api.waule.ai",qa=({data:s,selected:j,id:n})=>{var sr,rr,Ps,q,te,Me,Ve,qe,Oe,tt,bt;const[W,ye]=t.useState(!0),[,T]=t.useState(0),[fe,Z]=t.useState(s.config.taskId||""),re=s.config.modelId,K=s.config.duration||5,de=s.config.resolution||"720p",{credits:Ue,loading:ce,isFreeUsage:se,freeUsageRemaining:ae,refetch:je}=Ss({aiModelId:re,duration:K,resolution:de});t.useEffect(()=>{},[fe]);const{setNodes:ie,setEdges:xe,getNode:ue,getNodes:pe,getEdges:Ie}=Zt(),ee=zs(),Q=Ls(),U=t.useRef(""),R=(sr=s.config)==null?void 0:sr.selectedEditingCapability,L=t.useMemo(()=>{const C=(s.models||[]).filter(P=>{var be;return((be=P.provider)==null?void 0:be.toLowerCase())!=="sora"&&P.id!=="sora-video"});if(R){const P=C.filter(Ee=>Ee.type==="VIDEO_EDITING").filter(Ee=>{var we;return Array.isArray((we=Ee==null?void 0:Ee.config)==null?void 0:we.supportedEditingCapabilities)&&Ee.config.supportedEditingCapabilities.includes(R)}),be=C.filter(Ee=>Ee.type==="VIDEO_GENERATION").filter(Ee=>{var kt,ht;if(R!=="è§†é¢‘æ¢äºº")return!1;const we=((kt=Ee==null?void 0:Ee.config)==null?void 0:kt.supportsVideoEditing)===!0,st=(Array.isArray((ht=Ee==null?void 0:Ee.config)==null?void 0:ht.supportedGenerationTypes)?Ee.config.supportedGenerationTypes:[]).some(We=>(We||"").toLowerCase().includes("æ¢äºº")||(We||"").includes("è§†é¢‘æ¢äºº"));return we||st}),Te={};return[...P,...be].forEach(Ee=>{Te[Ee.id]||(Te[Ee.id]=Ee)}),Object.values(Te)}return C.filter(P=>P.type==="VIDEO_GENERATION")},[s.models,R]),[f,x]=t.useState(s.config.prompt||""),A=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==f&&x(s.config.prompt)},[s.config.prompt]);const[F,G]=t.useState(s.config.modelId||((rr=L[0])==null?void 0:rr.id)||""),[v,$]=t.useState(s.config.ratio||"16:9"),[r,w]=t.useState(s.config.resolution||""),u=t.useCallback(C=>{const P=(C||"").toLowerCase();return P?P.includes("æ–‡ç”Ÿ")||P.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":P.includes("é¦–å°¾")?"é¦–å°¾å¸§":P.includes("é¦–å¸§")||P.includes("first frame")||P.includes("start frame")||P.includes("initial frame")||P.includes("keyframe")?"é¦–å¸§":P.includes("å°¾å¸§")||P.includes("last frame")||P.includes("end frame")||P.includes("final frame")?"å°¾å¸§":P.includes("ä¸»ä½“å‚è€ƒ")||P.includes("å‚è€ƒ")||P.includes("reference image")||P.includes("image reference")||P.includes("ref image")?"å‚è€ƒå›¾":P.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":P.includes("first-last")||P.includes("two-frame")||P.includes("frame pair")?"é¦–å°¾å¸§":P.includes("first")?"é¦–å¸§":P.includes("last")?"å°¾å¸§":P.includes("subject")||P.includes("reference")?"å‚è€ƒå›¾":C||"":""},[]),[a,b]=t.useState((s.config.lockedGenerationType?u(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[c,p]=t.useState(s.config.duration||5),[d,k]=t.useState(s.config.audio||!1),[_,O]=t.useState(s.config.movementAmplitude||"auto"),[I,g]=t.useState(!1),[l,i]=t.useState([]),[z,D]=t.useState(null),[X,V]=t.useState(!1),[ne]=t.useState(""),[me]=t.useState("confirm"),[oe]=t.useState(null),[N,h]=t.useState(!1),[E,y]=t.useState([]),[J,ge]=t.useState(""),[B,he]=t.useState(0),[Se,Ne]=t.useState(0),[Re,Ce]=t.useState({}),[Ae,$e]=t.useState([]),le=L.find(C=>C.id===F);t.useEffect(()=>{var C,P;if(!L.find(be=>be.id===F)){const be=((C=L[0])==null?void 0:C.id)||"";G(be),ct({modelId:be,modelName:(P=L[0])==null?void 0:P.name})}},[L]),t.useEffect(()=>{var C;if((C=le==null?void 0:le.config.supportedResolutions)!=null&&C.length){const P=le.config.supportedResolutions;if(!r||!P.includes(r)){const be=P[0];w(be),ct({resolution:be})}}},[le==null?void 0:le.id]),t.useEffect(()=>{var be;const C=(be=le==null?void 0:le.modelId)==null?void 0:be.includes("viduq2"),P=u(a)==="é¦–å°¾å¸§";C&&P&&c>8&&(p(8),ct({duration:8}))},[a,le==null?void 0:le.modelId]);const Ge=((Ps=le==null?void 0:le.provider)==null?void 0:Ps.toLowerCase())==="sora",Qe=t.useMemo(()=>{var C,P,be,Te;if((C=le==null?void 0:le.config.supportedDurations)!=null&&C.length){let Ee=le.config.supportedDurations;const we=(P=le.modelId)==null?void 0:P.includes("viduq2"),et=u(a)==="é¦–å°¾å¸§";return we&&et&&(Ee=Ee.filter(kt=>kt<=8)),(((be=le.provider)==null?void 0:be.toLowerCase())==="minimax"||((Te=le.modelId)==null?void 0:Te.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(Ee=Ee.filter(kt=>kt===6)),Ee}return[c||5]},[le,c,a,u,r]),Wt=t.useMemo(()=>{var C;return(C=le==null?void 0:le.config.supportedResolutions)!=null&&C.length?le.config.supportedResolutions:[]},[le]),Ct=!le||!((q=le.config.supportedDurations)!=null&&q.length),_t=!le||!((te=le.config.supportedResolutions)!=null&&te.length),ct=t.useCallback(C=>{ue(n)&&ie(be=>be.map(Te=>Te.id===n?{...Te,data:{...Te.data,config:{...Te.data.config,...C}}}:Te))},[ue,n,ie]);t.useEffect(()=>{if(Qe.length>0&&!Qe.includes(c)){const C=Qe[0];p(C),ct({duration:C})}},[Qe,c,ct]);const gt=(C,P)=>{const be=(kt,ht)=>ht===0?kt:be(ht,kt%ht),Te=be(C,P),Ee=C/Te,we=P/Te,et={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},st=`${Ee}:${we}`;return et[st]||st},vt=()=>{const C=ee.filter(et=>et.target===n),P=[];C.forEach(et=>{var kt;const st=ue(et.source);if(st&&st.type==="upload"&&(((kt=st.data.config)==null?void 0:kt.uploadedFiles)||[]).forEach(We=>{const Dt=We.type||We.mimeType||"";(Dt==="IMAGE"||Dt.startsWith("image/"))&&P.push({id:We.id||We.name,url:We.url,name:We.name||We.originalName,width:We.width,height:We.height,aspectRatio:We.width&&We.height?gt(We.width,We.height):"16:9"})}),st&&st.type==="assetSelector"){const ht=st.data.config||{},We=ht.subjects,Dt=ht.selectedAsset,Xt=u(a);We&&We.length>0?Xt==="é¦–å°¾å¸§"||(We[0].images||[]).forEach((zt,At)=>{P.push({id:`${st.id}-subject-${At}`,url:zt,name:We[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Dt&&Dt.type==="IMAGE"&&P.push({id:Dt.id,url:Dt.url,name:Dt.name||Dt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(st&&st.type==="imagePreview"){const ht=st.data.imageUrl,We=st.data.width,Dt=st.data.height;ht&&P.push({id:st.id,url:ht,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:We,height:Dt,aspectRatio:We&&Dt?gt(We,Dt):"16:9"})}});const be=new Set,Te=[];P.forEach(et=>{const st=et.url;be.has(st)||(be.add(st),Te.push(et))});const Ee=u(a);let we=[];return Ee==="æ–‡ç”Ÿè§†é¢‘"?we=[]:Ee==="é¦–å¸§"||Ee==="å°¾å¸§"?we=Te.slice(0,1):Ee==="é¦–å°¾å¸§"?we=Te.slice(0,2):Ee==="å‚è€ƒå›¾"?we=Te.slice(0,7):we=Te,we},it=t.useMemo(()=>vt(),[ee,Q,a,n]),Ye=C=>{if(!A.current)return;const P=A.current,be=P.selectionStart||f.length,Te=f.slice(0,be),Ee=f.slice(be),we=`@${C} `,et=Te+we+Ee;x(et),Ce(st=>({...st,[C]:`image-${C}`})),setTimeout(()=>{const st=be+we.length;P.setSelectionRange(st,st),P.focus()},0)},yt=t.useCallback(async()=>{var C;if(!(Ae.length>0))try{const P=await _e.assetLibraries.getAll({includeShared:"true"}),be=P.data||P||[],Te=[];for(const Ee of be)if(Ee.category==="ROLE")try{const we=await _e.assetLibraries.roles.list(Ee.id),et=we.data||we||[];for(const st of et)Te.push({id:st.id,name:((C=st.metadata)==null?void 0:C.name)||st.name||"",thumbnail:st.thumbnail})}catch{}$e(Te)}catch{}},[Ae.length]),Be=t.useCallback(C=>{if(!C){y(Ae.slice(0,5));return}const P=Ae.filter(be=>be.name.toLowerCase().includes(C.toLowerCase())).slice(0,5);y(P),Ne(0)},[Ae]),wt=t.useCallback(C=>{const P=C.target.value,be=C.target.selectionStart||0;x(P);const Ee=P.substring(0,be).match(/@([^@\s]*)$/);if(Ee){const we=Ee[1];ge(we),he(be-we.length-1),h(!0),yt().then(()=>Be(we))}else h(!1),y([])},[yt,Be]),Yt=t.useCallback(C=>{const P=f.substring(0,B),be=f.substring(B+J.length+1),Te=`@${C.name} `,Ee=P+Te+be;x(Ee),Ce(we=>({...we,[C.name]:C.id})),h(!1),y([]),ge(""),setTimeout(()=>{if(A.current){A.current.focus();const we=P.length+Te.length;A.current.setSelectionRange(we,we)}},0)},[f,B,J]),vs=t.useCallback(C=>{!N||E.length===0||(C.key==="ArrowDown"?(C.preventDefault(),Ne(P=>P<E.length-1?P+1:P)):C.key==="ArrowUp"?(C.preventDefault(),Ne(P=>P>0?P-1:P)):C.key==="Enter"&&E[Se]?(C.preventDefault(),Yt(E[Se])):C.key==="Escape"&&h(!1))},[N,E,Se,Yt]);t.useEffect(()=>{const C=s.config.taskId;(async()=>{if(C){try{const Te=(await _e.tasks.getTaskStatus(C)).task;if(Te.status==="SUCCESS"){g(!1),T(100);const Ee=Te.resultUrl;if(!Ee){g(!1),T(0),ct({taskId:""}),Z(""),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const we=s.config.ratio||"16:9";ct({prompt:s.config.prompt||f,ratio:we,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:Ee,taskId:""}),Z("");const et=pe(),st=Ie();if(et.filter(We=>We.type==="videoPreview"&&st.some(Dt=>Dt.source===n&&Dt.target===We.id)).find(We=>We.data.videoUrl===Ee)){setTimeout(()=>T(0),1e3);return}m.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const We=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(We).some(Pt=>Pt.taskId&&Pt.taskId===C||Pt.sourceNodeId&&Pt.sourceNodeId===n)||ws(Ee,we)}catch{ws(Ee,we)}setTimeout(()=>T(0),1e3)}else if(Te.status==="PROCESSING"||Te.status==="PENDING"){g(!0),T(Te.progress||0),Xs(C);return}else Te.status==="FAILURE"&&(g(!1),T(0),ct({taskId:""}),Z(""),m.error(`ç”Ÿæˆå¤±è´¥: ${Te.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{g(!1),T(0),ct({taskId:""}),Z(""),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const C=ee.filter(be=>be.target===n);let P="";C.forEach(be=>{var Ee;const Te=ue(be.source);if(Te){const we=Te.data;Te.type==="agent"&&((Ee=we.config)!=null&&Ee.generatedText)?P||(P=we.config.generatedText):Te.type==="textPreview"&&we.content&&(P||(P=we.content))}}),P&&P!==f&&(x(P),ct({prompt:P}))},[ee,n,ue,f,ct]),t.useEffect(()=>{const C=ee.filter(Te=>Te.target===n);if(C.length===0)return;let P="",be="";C.forEach(Te=>{var we;const Ee=Q.find(et=>et.id===Te.source);if(Ee&&Ee.type==="agent"){const et=Ee.data;(we=et.config)!=null&&we.generatedText&&(P=et.config.generatedText,be=`${Ee.id}-${et.config.generatedText.substring(0,50)}`)}}),P&&be!==U.current&&(U.current=be,x(P),ct({prompt:P}))},[Q,ee,n,ct]),t.useEffect(()=>{const C=JSON.stringify(it),P=JSON.stringify(l);C!==P&&i(it)},[it]);const Is=t.useMemo(()=>{const C=l.length,P=u(a);return C===0?!0:C===1?P==="å‚è€ƒå›¾":C===2?P==="é¦–å°¾å¸§"?!1:P==="å‚è€ƒå›¾":C>2?P==="å‚è€ƒå›¾":!1},[l.length,a,u]),Es=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Ns=t.useMemo(()=>{const C=u(a);return R?L:L.filter(P=>{var Te;const be=(((Te=P.config)==null?void 0:Te.supportedGenerationTypes)||[]).map(Ee=>u(Ee));return C==="é¦–å¸§"||C==="å°¾å¸§"?be.includes("é¦–å¸§")||be.includes("å°¾å¸§"):be.includes(C)})},[L,a,u,R]),Bs=t.useMemo(()=>{const C=R?L:Ns;return C.length>0?C:R?(s.models||[]).filter(be=>(be.type||"")==="VIDEO_EDITING"):C},[R,L,Ns,s.models]);t.useEffect(()=>{var P,be;if(!Bs.find(Te=>Te.id===F)){const Te=((P=Bs[0])==null?void 0:P.id)||"";G(Te),ct({modelId:Te||void 0,modelName:Te?(be=Bs[0])==null?void 0:be.name:void 0})}},[Bs]);const fs=t.useCallback(C=>{const P=u(C);return R?["IMAGE","VIDEO"]:P==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[u,R]);t.useEffect(()=>{if(!Is&&l.length>0){const C=l[0].aspectRatio;C&&v!==C&&($(C),setTimeout(()=>{ct({ratio:C})},0))}},[Is,l,v]),t.useEffect(()=>{if(!R&&Es.length>0&&!Es.includes(a)){const C="æ–‡ç”Ÿè§†é¢‘";b(C),setTimeout(()=>{ct({generationType:C,acceptedInputs:fs(C)})},0)}},[Es,a,fs,R]),t.useEffect(()=>{u(a)==="é¦–å°¾å¸§"&&d&&(k(!1),ct({audio:!1}))},[a,u]),t.useEffect(()=>{const C=u(a);if(C==="æ–‡ç”Ÿè§†é¢‘")return;const P=ee.filter(we=>we.target===n),be=[],Te=[];P.forEach(we=>{var kt,ht,We,Dt,Xt;const et=ue(we.source);if(!et)return;const st=et.type;if((st||"").startsWith("aiVideo")||st==="videoPreview"){Te.push(we.id);return}if(st==="upload"){const Pt=(We=(ht=(kt=et.data)==null?void 0:kt.config)==null?void 0:ht.uploadedFiles)==null?void 0:We[0],zt=((Pt==null?void 0:Pt.type)||"").toUpperCase(),At=((Pt==null?void 0:Pt.mimeType)||"").toLowerCase();if(zt==="VIDEO"||At.startsWith("video/")){Te.push(we.id);return}(zt==="IMAGE"||At.startsWith("image/"))&&be.push(we.id);return}if(st==="assetSelector"){const Pt=((Dt=et.data)==null?void 0:Dt.config)||{};if(Pt.selectedAsset){const zt=(Pt.selectedAsset.type||"").toUpperCase(),At=(Pt.selectedAsset.mimeType||"").toLowerCase();zt==="VIDEO"||At.startsWith("video/")?Te.push(we.id):(zt==="IMAGE"||At.startsWith("image/"))&&be.push(we.id)}else if(Pt.subjects&&Pt.subjects.length>0){const zt=(((Xt=Pt.subjects[0])==null?void 0:Xt.images)||[]).length;C==="å‚è€ƒå›¾"||C==="é¦–å°¾å¸§"?be.push(we.id):(C==="é¦–å¸§"||C==="å°¾å¸§")&&(zt>1?Te.push(we.id):be.push(we.id))}return}(st==="aiImage"||st==="imagePreview")&&be.push(we.id)});let Ee=new Set([...Te]);C==="é¦–å¸§"||C==="å°¾å¸§"?be.slice(1).forEach(we=>Ee.add(we)):C==="é¦–å°¾å¸§"&&be.slice(2).forEach(we=>Ee.add(we)),Ee.size>0&&xe(we=>we.filter(et=>!Ee.has(et.id)))},[a,ee,n,ue,xe,u]),t.useEffect(()=>{const C=s.config.generationType;if(!C||u(C)!==u(a)){const P=u(a)||"æ–‡ç”Ÿè§†é¢‘";ct({generationType:P,acceptedInputs:fs(P)})}},[]),t.useEffect(()=>{const C=fs(a);ct({acceptedInputs:C})},[a,fs]);const Qs=C=>{D(C)},Hs=C=>{C.preventDefault()},nr=C=>{if(z===null)return;const P=[...l],[be]=P.splice(z,1);P.splice(C,0,be),i(P),D(null),ct({referenceImages:P})};t.useEffect(()=>{const C=A.current;C&&W&&requestAnimationFrame(()=>{C.style.height="auto";const P=Math.max(60,Math.min(C.scrollHeight,600));C.style.height=`${P}px`})},[f,W]),t.useEffect(()=>{if(f===s.config.prompt)return;const C=setTimeout(()=>{ct({prompt:f})},500);return()=>clearTimeout(C)},[f]);const Tt=C=>{var be,Te,Ee;G(C);const P=Ns.find(we=>we.id===C);if(P){const we=(be=P.config.supportedRatios)!=null&&be.length?P.config.supportedRatios:["16:9"],et=P.config.supportedResolutions||[],st=(Te=P.config.supportedGenerationTypes)!=null&&Te.length?P.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],kt=(Ee=P.config.supportedDurations)!=null&&Ee.length?P.config.supportedDurations:[5],ht=we[0],We=et.length>0?et[0]:r,Dt=u(a||st[0]),Xt=kt[0],Pt=P.config.supportsAudioOutput?d:!1;$(ht),w(We),b(Dt),p(Xt),P.config.supportsAudioOutput||k(!1),ct({modelId:C,modelName:P.name,ratio:ht,resolution:We,generationType:Dt,duration:Xt,audio:Pt,acceptedInputs:fs(Dt)})}};t.useEffect(()=>{var P;const C=(P=s==null?void 0:s.config)==null?void 0:P.generatedVideoUrl;C&&ws(C,s.config.ratio||"16:9")},[(Me=s==null?void 0:s.config)==null?void 0:Me.generatedVideoUrl]);const Xs=async C=>{let be=0;const Te=async()=>{try{be++;const we=(await _e.tasks.getTaskStatus(C)).task;if(T(we.progress||0),we.status==="SUCCESS"||we.status==="COMPLETED"||we.status==="DONE"){g(!1),T(100);const et=we.resultUrl;ws(et,s.config.ratio||"16:9"),ct({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:et}),Z(""),m.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>T(0),1e3);return}else if(we.status==="FAILURE"){g(!1),T(0),ct({taskId:""});const{useAuthStore:et}=await ds(async()=>{const{useAuthStore:kt}=await import("./index-Dg_hJ4va.js").then(ht=>ht.f);return{useAuthStore:kt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:st}=et.getState();await st(),m.error(we.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(we.status==="PROCESSING"||we.status==="PENDING")&&(be<900?setTimeout(Te,1e3):(g(!1),T(0),ct({taskId:""}),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{g(!1),T(0),ct({taskId:""}),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Te()},bs=async()=>{var be,Te,Ee,we,et,st,kt;if(u(a)==="æ–‡ç”Ÿè§†é¢‘"&&!f.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯");return}g(!0);const P=vt();ct({referenceImages:P}),T(0);try{let ht=[],We;const Dt=l.length;if(l.length>0)try{for(const ps of l){let Bt=ps.url;!Bt.startsWith("data:")&&!Bt.startsWith("http")&&(Bt=`${hr}${Bt}`),Bt=Bt.replace(/^https?:\/\/localhost(?::\d+)?/i,hr);const Jt=await dr(Bt);ht.push(Jt)}}catch{m.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=ee.filter(ps=>ps.target===n);let Pt=[];if(u(a)==="å‚è€ƒå›¾"){const ps=/@(\S+)/g,Jt=[...f.matchAll(ps)].map(us=>us[1]);for(const us of Jt){const ss=Re[us];ss&&Pt.push(ss)}const as=new Map;for(const us of Xt){const ss=ue(us.source);if((ss==null?void 0:ss.type)==="assetSelector"){const Os=(be=ss.data.config)==null?void 0:be.roleIds;if(Os&&Os.length>0)for(const ms of Os)Pt.includes(ms)||Pt.push(ms);const ks=(Te=ss.data.config)==null?void 0:Te.subjects;if(ks&&ks.length>0){for(const ms of ks)if(!as.has(ms.name)){const qs=(ms.images||[]).map(Gs=>Gs.startsWith("http")||Gs.startsWith("data:")?Gs:`${hr}${Gs}`);as.set(ms.name,qs)}}}}if(as.size>0){const us=Array.from(as.entries());let ss=0;const Os=[];for(const[ks,ms]of us){if(ss>=7)break;const qs=7-ss,Gs=ms.slice(0,Math.max(0,qs));Gs.length>0&&(Os.push({name:ks,images:Gs}),ss+=Gs.length)}We=Os,us.some(([,ks])=>ks.length>0)&&ss<us.reduce((ks,[,ms])=>ks+ms.length,0)&&m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(ht.length>0){const us=it.filter(ss=>!ss.id.includes("subject"));us.length>0&&(We||(We=[]),us.forEach((ss,Os)=>{const ks=`å›¾${Os+1}`,ms=ss.url.startsWith("http")||ss.url.startsWith("data:")?ss.url:`${hr}${ss.url}`;We.push({name:ks,images:[ms]})}))}}const zt=We&&We.length>0?We.reduce((ps,Bt)=>{var Jt;return ps+(((Jt=Bt.images)==null?void 0:Jt.length)||0)},0):Dt,At=Pt.length>0;let Ut=a;if(Ut==="é¦–å¸§"||Ut==="å°¾å¸§"){if(zt!==1&&!At){m.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),g(!1),T(0);return}}else if(Ut==="é¦–å°¾å¸§"){if(zt===1)Ut="é¦–å¸§";else if(zt!==2&&!At){m.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),g(!1),T(0);return}We&&We.length>0?We=[{...We[0],images:We[0].images.slice(0,2)}]:ht=ht.slice(0,2)}else if(Ut==="å‚è€ƒå›¾"||Ut==="ä¸»ä½“å‚è€ƒ"){if(zt<1&&!At){m.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),g(!1),T(0);return}if(We&&We.length>0){if(We.reduce((Bt,Jt)=>{var as;return Bt+(((as=Jt.images)==null?void 0:as.length)||0)},0)>7){let Bt=7;We=We.map(Jt=>({...Jt,images:Jt.images.slice(0,Math.max(0,Bt-=Jt.images.length,Jt.images.length))})),Bt=7,We=We.map(Jt=>{const as=Jt.images.slice(0,Math.min(Jt.images.length,Bt));return Bt-=as.length,{...Jt,images:as}}).filter(Jt=>Jt.images.length>0),m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else ht.length>7&&(ht=ht.slice(0,7),m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}oe==="dropImages"&&(ht=[],We=void 0),(u(a)==="é¦–å¸§"||u(a)==="å°¾å¸§")&&oe==="useFirstImage"&&ht.length>=2&&(ht=[ht[0]]),u(a)==="é¦–å°¾å¸§"&&oe==="useFirstTwoImages"&&ht.length>=3&&(ht=ht.slice(0,2));const Vt={modelId:F,ratio:v,referenceImages:We&&We.length>0?void 0:ht.length>0?ht:void 0,roleIds:Pt.length>0?Pt:void 0,generationType:Ut,sourceNodeId:n,metadata:{duration:c,resolution:r,audio:d,movementAmplitude:_,roleIds:Pt.length>0?Pt:void 0},...We?{subjects:We}:{}};We&&We.length>0;const Ft=u(Ut);if(Ft==="æ–‡ç”Ÿè§†é¢‘"){if(!f.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯"),g(!1),T(0);return}Vt.prompt=f.trim()}else if(Ft==="å‚è€ƒå›¾"){if(!f.trim()){m.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),g(!1),T(0);return}Vt.prompt=f.trim()}else f.trim()&&(Vt.prompt=f.trim());const ts=await _e.tasks.createVideoTask(Vt),rs=ts.taskId,ys=ts.creditsCharged||0,Js=ts.isFreeUsage,Cs=ts.freeUsageRemaining??0;if(Z(rs),ct({prompt:f,ratio:v,resolution:r,generationType:a,duration:c,modelId:F,taskId:rs}),Js)m.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Cs} æ¬¡`),je();else if(ys>0){const{useAuthStore:ps}=await ds(async()=>{const{useAuthStore:Jt}=await import("./index-Dg_hJ4va.js").then(as=>as.f);return{useAuthStore:Jt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Bt}=ps.getState();await Bt(),m.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${ys} ç§¯åˆ†ï¼‰`),je()}else m.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Xs(rs)}catch(ht){if(g(!1),T(0),((Ee=ht.response)==null?void 0:Ee.status)===403){const We=((et=(we=ht.response)==null?void 0:we.data)==null?void 0:et.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";m.error(We)}else m.error(`æäº¤å¤±è´¥: ${((kt=(st=ht.response)==null?void 0:st.data)==null?void 0:kt.error)||ht.message}`)}},er=async()=>{const C=u(a),P=vt(),be=P.length,Te=(()=>{var et;const we=ee.filter(st=>st.target===n);for(const st of we){const kt=ue(st.source);if((kt==null?void 0:kt.type)==="assetSelector"){const ht=(et=kt.data.config)==null?void 0:et.subjects;if(ht&&ht.length>0)return!0}}return!1})(),Ee=Object.keys(Re).length>0;if((Te||Ee)&&(C==="é¦–å¸§"||C==="å°¾å¸§"||C==="é¦–å°¾å¸§")){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((C==="é¦–å¸§"||C==="å°¾å¸§")&&be===0&&!Ee){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(C==="é¦–å°¾å¸§"&&be===0&&!Ee){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(C==="å‚è€ƒå›¾"&&be===0&&!Ee){m.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(C==="æ–‡ç”Ÿè§†é¢‘"&&be>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((C==="é¦–å¸§"||C==="å°¾å¸§")&&be>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(C==="é¦–å°¾å¸§"&&be>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(C==="æ–‡ç”Ÿè§†é¢‘"&&!f.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!F){m.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}i(P),ct({referenceImages:P}),g(!0),T(0),await bs()},ws=(C,P)=>{const be=ue(n);if(!be||!C)return;const Te=P||v||"16:9",Ee=pe(),we=Ie(),et=Ee.filter(Bt=>Bt.type==="videoPreview"&&we.some(Jt=>Jt.source===n&&Jt.target===Bt.id));if(et.find(Bt=>Bt.data.videoUrl===C))return;const kt=1,ht=400,We=(Bt,Jt=300)=>{if(!Bt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Bt))return Jt;const[as,us]=Bt.split(":").map(ss=>parseFloat(ss));return!as||!us?Jt:Math.round(ht*(us/as))},Dt=document.querySelector(`.react-flow__node[data-id="${n}"]`),Xt=Dt==null?void 0:Dt.getBoundingClientRect(),Pt=Math.round(((Xt==null?void 0:Xt.width)||400)/kt),zt=100,At=200,Ut=We(Te,300),Vt=et.length,Ft=be.position.x+Pt+At,ts=be.position.y,rs=Ft,ys=ts+Vt*(Ut+zt),Js=Date.now(),Cs={id:`preview-${n}-${Js}`,type:"videoPreview",position:{x:rs,y:ys},data:{videoUrl:C,width:ht,ratio:Te,workflowContext:be.data.workflowContext,createdBy:be.data.createdBy}};ie(Bt=>[...Bt,Cs]);const ps={id:`edge-${n}-${Cs.id}`,source:n,target:Cs.id,targetHandle:`${Cs.id}-target`,type:"aurora"};xe(Bt=>Bt.find(as=>as.source===n&&as.target===Cs.id)?Bt:[...Bt,ps])},tr=C=>{const P=C.target;if(P.tagName==="INPUT"||P.tagName==="TEXTAREA"||P.tagName==="SELECT"||P.tagName==="BUTTON"||P.closest("button")||P.closest("input")||P.closest("textarea")||P.closest("select"))return;const be=!W;ye(be),ie(Te=>Te.map(Ee=>Ee.id===n?{...Ee,data:{...Ee.data,isExpanded:be}}:Ee))};return e.jsxs("div",{onDoubleClick:tr,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var ht;const C=((ht=ue(n))==null?void 0:ht.type)||"",P=u(a),be=P==="æ–‡ç”Ÿè§†é¢‘"||C==="aiVideo_t2v",Te=C==="aiVideo_i2v_first"||C==="aiVideo_i2v_last"||P==="é¦–å¸§"||P==="å°¾å¸§",Ee=C==="aiVideo_first_last"||P==="é¦–å°¾å¸§",we=C==="aiVideo_reference"||P==="å‚è€ƒå›¾",et=ee.filter(We=>We.target===n),st=et.some(We=>{const Dt=ue(We.source);return(Dt==null?void 0:Dt.type)==="agent"}),kt=et.reduce((We,Dt)=>{var zt,At,Ut,Vt;const Xt=ue(Dt.source),Pt=(Xt==null?void 0:Xt.type)||"";if(Pt==="aiImage"||Pt==="imagePreview")return We+1;if(Pt==="upload"){const Ft=(Ut=(At=(zt=Xt==null?void 0:Xt.data)==null?void 0:zt.config)==null?void 0:At.uploadedFiles)==null?void 0:Ut[0],ts=((Ft==null?void 0:Ft.type)||"").toUpperCase(),rs=((Ft==null?void 0:Ft.mimeType)||"").toLowerCase();return We+(ts==="IMAGE"||rs.startsWith("image/")?1:0)}if(Pt==="assetSelector"){const Ft=((Vt=Xt==null?void 0:Xt.data)==null?void 0:Vt.config)||{};if(Ft.selectedAsset)return We+((Ft.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ft.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Ft.subjects&&Ft.subjects.length>0)return We+((Ft.subjects[0].images||[]).length||0)}return We},0);return be?!st:Te?!(st&&kt>=1):Ee?!(st&&kt>=2):we?!(st&&kt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),X&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ne}),me==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{V(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{V(!1),m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{V(!1),await bs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:F,onChange:C=>Tt(C),options:Ns.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Ns.map(C=>({value:C.id,label:C.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ge?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:A,value:f,onChange:C=>{var Ee;const P=(Ee=le==null?void 0:le.modelId)==null?void 0:Ee.includes("viduq2"),be=u(a)==="å‚è€ƒå›¾";P&&be?wt(C):(x(C.target.value),h(!1))},onKeyDown:C=>{var Te;const P=(Te=le==null?void 0:le.modelId)==null?void 0:Te.includes("viduq2"),be=u(a)==="å‚è€ƒå›¾";P&&be&&vs(C)},placeholder:(Ve=le==null?void 0:le.modelId)!=null&&Ve.includes("viduq2")&&u(a)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),N&&E.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:E.map((C,P)=>e.jsxs("button",{type:"button",onClick:()=>Yt(C),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${P===Se?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[C.thumbnail?e.jsx("img",{src:C.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",C.name]})})]},C.id))})]})]}),Object.keys(Re).length>0&&((qe=le==null?void 0:le.modelId)==null?void 0:qe.includes("viduq2"))&&u(a)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys(Re).map(C=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-neutral-500/10 dark:bg-neutral-500/20 border border-neutral-400/50 dark:border-neutral-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-neutral-700 dark:text-neutral-300",children:C}),e.jsx("button",{type:"button",onClick:()=>{Ce(Te=>{const Ee={...Te};return delete Ee[C],Ee});const P=new RegExp(`@${C}\\s*`,"g"),be=f.replace(P,"");x(be)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},C))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ge&&l.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(Oe=l[0])!=null&&Oe.name&&l[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",a==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",u(a)==="å‚è€ƒå›¾"&&l.some(C=>!C.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:l.map((C,P)=>{const be=l.slice(0,P+1).filter(we=>!we.id.includes("subject")).length,Te=!C.id.includes("subject"),Ee=Te?`å›¾${be}`:C.name;return e.jsxs("div",{draggable:a==="é¦–å°¾å¸§",onDragStart:()=>Qs(P),onDragOver:Hs,onDrop:()=>nr(P),onClick:()=>{Te&&u(a)==="å‚è€ƒå›¾"&&Ye(Ee)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${a==="é¦–å°¾å¸§"?"cursor-move":Te&&u(a)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${z===P?"opacity-50":""} ${C.id.includes("subject")?"border-neutral-400 dark:border-neutral-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-neutral-400 dark:hover:border-neutral-400/50 ${Te&&u(a)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Te&&u(a)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${Ee}`:C.name,children:[e.jsx("img",{src:`${C.url.startsWith("http")||C.url.startsWith("data:")?C.url:hr+C.url}`,alt:C.name,className:"w-full h-full object-cover"}),C.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),C.name]}),Te&&a!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),Ee]}),a==="é¦–å°¾å¸§"&&!C.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:P===0?"é¦–":P===1?"å°¾":P+1})]},C.id)})})]}),le&&!Ge&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",Ct?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Qe.map(C=>e.jsxs("button",{type:"button",onClick:()=>{p(C),ct({duration:C})},disabled:Ct,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${c===C?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:[C,"ç§’"]},C))})]}),Is&&(((tt=le==null?void 0:le.config.supportedRatios)==null?void 0:tt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ge?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{$("16:9"),ct({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${v==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{$("9:16"),ct({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${v==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:v,onChange:C=>{$(C),ct({ratio:C})},options:((le==null?void 0:le.config.supportedRatios)||[]).map(C=>{const[P,be]=C.split(":");return{value:C,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[C]||`${P}:${be}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",_t?"(æœªé…ç½®)":""]}),e.jsx(os,{value:r,onChange:C=>{w(C),ct({resolution:C})},options:Wt.map(C=>({value:C,label:C})),className:_t?"opacity-50 pointer-events-none":""})]}),((bt=le==null?void 0:le.provider)==null?void 0:bt.toLowerCase())==="vidu"&&(le==null?void 0:le.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(C=>e.jsx("button",{type:"button",onClick:()=>{O(C),ct({movementAmplitude:C})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${_===C?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:C==="auto"?"è‡ªåŠ¨":C==="small"?"å°":C==="medium"?"ä¸­":"å¤§"},C))})]}),(le==null?void 0:le.config.supportsAudioOutput)&&u(a)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const C=!d;k(C),ct({audio:C})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${d?"bg-neutral-800 dark:bg-white text-white dark:text-black":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${d?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:er,disabled:I||s._canEdit===!1||u(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(f!=null&&f.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${I||u(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(f!=null&&f.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:I?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!ce&&(se?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ae),"æ¬¡"]}):Ue!==null&&Ue>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Ue,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:f?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:f})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ur=t.memo(qa),Ya=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Ka=t.memo(Ya),Za=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},Qa=t.memo(Za),eo=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},to=t.memo(eo),so=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},ro=t.memo(so),ao=s=>{const j=(s==null?void 0:s.data)||{},n=j.config||{};return e.jsx(ur,{...s,data:{...j,config:{...n,generationType:(n==null?void 0:n.lockedGenerationType)||(n==null?void 0:n.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(n==null?void 0:n.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(n==null?void 0:n.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(n==null?void 0:n.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},oo=t.memo(ao),lr="https://api.waule.ai",no=({data:s,selected:j,id:n})=>{var G,v,$,r,w,u;const[W]=t.useState(!0),[ye,T]=t.useState(!1),[fe]=t.useState(""),[Z,re]=t.useState("wan-std"),[K,de]=t.useState(0),Ue=t.useRef(null),{setNodes:ce,setEdges:se,getNode:ae,getNodes:je,getEdges:ie}=Zt(),xe=zs(),ue=s.config.modelId,{credits:pe,loading:Ie}=Ss({aiModelId:ue,duration:K,mode:Z==="wan-pro"?"pro":"standard"}),ee=t.useMemo(()=>{var c;const a=s.models||[],b=(c=s==null?void 0:s.config)==null?void 0:c.selectedEditingCapability;return a.filter(p=>{var d;return(p.type||"")==="VIDEO_EDITING"&&Array.isArray((d=p.config)==null?void 0:d.supportedEditingCapabilities)&&(b?p.config.supportedEditingCapabilities.includes(b):p.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||p.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(G=s==null?void 0:s.config)==null?void 0:G.selectedEditingCapability]),[Q,U]=t.useState(s.config.modelId||((v=ee[0])==null?void 0:v.id)||""),R=t.useMemo(()=>ee.find(a=>a.id===Q),[ee,Q]);t.useEffect(()=>{var a;if(!ee.find(b=>b.id===Q)){const b=((a=ee[0])==null?void 0:a.id)||"";U(b),ce(c=>c.map(p=>{var d;return p.id===n?{...p,data:{...p.data,config:{...p.data.config,modelId:b||void 0,modelName:b?(d=ee[0])==null?void 0:d.name:void 0}}}:p}))}},[ee]),t.useEffect(()=>{},[R]);const L=t.useMemo(()=>{var _,O,I,g,l,i,z,D,X,V,ne,me,oe,N,h,E;const a=xe.filter(y=>y.target===n);let b=null,c=0,p=null,d=null,k=null;for(const y of a){const J=ae(y.source);if(!J)continue;const ge=String(J.type||"");if(ge==="upload"){const B=(I=(O=(_=J.data)==null?void 0:_.config)==null?void 0:O.uploadedFiles)==null?void 0:I[0];if(!B)continue;const he=String(B.mimeType||"").toLowerCase(),Se=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!p&&(Se==="VIDEO"||he.startsWith("video/"))&&(p=Ne,k=y.id),!b&&(Se==="IMAGE"||he.startsWith("image/"))&&(b=Ne,c=B.size||0,d=y.id)}else if(ge==="assetSelector"){const B=(l=(g=J.data)==null?void 0:g.config)==null?void 0:l.selectedAsset;if(B){const Se=String(B.mimeType||"").toLowerCase(),Ne=String(B.type||"").toUpperCase(),Re=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!p&&(Ne==="VIDEO"||Se.startsWith("video/"))&&(p=Re,k=y.id),!b&&(Ne==="IMAGE"||Se.startsWith("image/"))&&(b=Re,c=B.size||0,d=y.id)}const he=((z=(i=J.data)==null?void 0:i.config)==null?void 0:z.subjects)||[];if(!b&&Array.isArray(he)&&he.length>0){const Ne=(((D=he[0])==null?void 0:D.images)||[])[0];Ne&&(b=Ne.startsWith("http")||Ne.startsWith("data:")?Ne:`${lr}${Ne}`,d=y.id)}}else if(ge==="aiImage"){const B=(V=(X=J.data)==null?void 0:X.config)==null?void 0:V.generatedImageUrl;!b&&B&&(b=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,d=y.id)}else if(ge==="imagePreview"){const B=((ne=J.data)==null?void 0:ne.imageUrl)||((me=J.data)==null?void 0:me.url);!b&&B&&(b=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,d=y.id)}else if(ge==="videoPreview"||ge.startsWith("aiVideo")){const B=((oe=J.data)==null?void 0:oe.videoUrl)||((N=J.data)==null?void 0:N.url)||((E=(h=J.data)==null?void 0:h.config)==null?void 0:E.generatedVideoUrl);!p&&B&&(p=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,k=y.id)}if(b&&p)break}return{imageUrl:b,videoUrl:p,imageSize:c,imageEdgeId:d,videoEdgeId:k}},[xe,n,ae]);t.useEffect(()=>{if(L.imageSize>5*1024*1024){const b=(L.imageSize/1024/1024).toFixed(2);m.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${b}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),L.imageEdgeId&&se(c=>c.filter(p=>p.id!==L.imageEdgeId))}if(!L.videoUrl){de(0);return}const a=document.createElement("video");a.src=L.videoUrl,a.onloadedmetadata=()=>{const b=a.duration||0,c=a.videoWidth,p=a.videoHeight;de(b);let d="";b<2||b>30?d=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${b.toFixed(1)}ç§’ï¼‰`:(c>2048||p>2048)&&(d=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${c}x${p}ï¼‰`),d&&(m.error(d+"ï¼Œè¿æ¥å·²æ–­å¼€"),L.videoEdgeId&&se(k=>k.filter(_=>_.id!==L.videoEdgeId)))},a.onerror=()=>de(0),a.load()},[L.videoUrl,L.imageSize,L.videoEdgeId,L.imageEdgeId,se]);const f=t.useMemo(()=>!!Q&&!!L.videoUrl&&!!L.imageUrl,[Q,L.videoUrl,L.imageUrl]),x=t.useCallback(a=>{var N,h,E;const b=ae(n);if(!b||!a)return;const c=je(),p=ie(),d=c.filter(y=>y.type==="videoPreview"&&p.some(J=>J.source===n&&J.target===y.id));if(d.find(y=>{var J;return((J=y.data)==null?void 0:J.videoUrl)===a}))return;const _=400,O=(y,J=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(y))return J;const[ge,B]=y.split(":").map(he=>parseFloat(he));return!ge||!B?J:Math.round(_*(B/ge))},I=200,g=100,l=O("16:9",300),i=document.querySelector(`.react-flow__node[data-id="${n}"]`),z=Math.round((i==null?void 0:i.getBoundingClientRect().width)||400),D=(((N=b.position)==null?void 0:N.x)||0)+z+I,X=((h=b.position)==null?void 0:h.y)||0,V=d.length,ne=D,me=X+V*(l+g),oe={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:ne,y:me},data:{videoUrl:a,width:_,ratio:"16:9",workflowContext:b.data.workflowContext,createdBy:(E=b.data)==null?void 0:E.createdBy}};ce(y=>[...y,oe]),se(y=>[...y,{id:`edge-${n}-${oe.id}`,source:n,target:oe.id,type:"aurora"}])},[n,ae,je,ie,ce,se]);t.useEffect(()=>{var b;const a=(b=s==null?void 0:s.config)==null?void 0:b.generatedVideoUrl;a&&x(a)},[($=s==null?void 0:s.config)==null?void 0:$.generatedVideoUrl]),t.useEffect(()=>{const a=s.config.taskId;(async()=>{var p,d;let c=!1;if(a)try{const _=(await _e.tasks.getTaskStatus(a)).task;if(_.status==="SUCCESS"){const O=_.resultUrl||((p=_.previewNodeData)==null?void 0:p.url);if(O){let I=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";I=JSON.parse(g).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}I||x(O),ce(g=>g.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:O,taskId:a}}}:l))}T(!1),c=!0}else if(_.status==="PROCESSING"||_.status==="PENDING"){T(!0),await A(a);return}else _.status==="FAILURE"&&(T(!1),ce(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I)))}catch{T(!1)}if(!c)try{const k=await _e.tasks.getPendingPreviewNodes(n);if(Array.isArray(k.tasks)&&k.tasks.length>0)for(const _ of k.tasks){const O=(d=_.previewNodeData)==null?void 0:d.url;if(O){let I=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";I=JSON.parse(g).some(i=>i.taskId&&i.taskId===_.id||i.sourceNodeId&&i.sourceNodeId===n)}catch{}I||x(O),await _e.tasks.markPreviewNodeCreated(_.id)}}}catch{}})()},[]);const A=async a=>{let b=0;const c=600,p=async()=>{var d;try{b++;const _=(await _e.tasks.getTaskStatus(a)).task;if(_.status==="SUCCESS"){const O=_.resultUrl||((d=_.previewNodeData)==null?void 0:d.url);if(O){let I=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";I=JSON.parse(g).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}I||x(O),ce(g=>g.map(l=>l.id!==n?l:{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:O,taskId:a}}}))}T(!1),m.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(_.status==="PROCESSING"||_.status==="PENDING")if(b<c)setTimeout(p,5e3);else{T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ce(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));return}else if(_.status==="FAILURE"){T(!1);try{const{useAuthStore:O}=await ds(async()=>{const{useAuthStore:g}=await import("./index-Dg_hJ4va.js").then(l=>l.f);return{useAuthStore:g}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:I}=O.getState();await I()}catch{}m.error(_.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ce(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));return}else{T(!1),m.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),ce(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));return}}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ce(_=>_.map(O=>O.id===n?{...O,data:{...O.data,config:{...O.data.config,taskId:""}}}:O));return}};p()},F=async()=>{var a,b;if(!f){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}T(!0);try{const c=await _e.post("/tasks/video-edit",{modelId:Q,prompt:fe||"",referenceImages:L.imageUrl?[L.imageUrl]:[],sourceNodeId:n,duration:K,metadata:{videoUrl:L.videoUrl,wanMode:Z,duration:K}}),p=c.taskId,d=c.creditsCharged||0;if(d>0)try{const{useAuthStore:k}=await ds(async()=>{const{useAuthStore:O}=await import("./index-Dg_hJ4va.js").then(I=>I.f);return{useAuthStore:O}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_}=k.getState();await _(),m.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${d} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ce(k=>k.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:p}}}:_)),await A(p)}catch(c){T(!1);const p=((b=(a=c==null?void 0:c.response)==null?void 0:a.data)==null?void 0:b.error)||c.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${p}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:Q,onChange:a=>{U(a),ce(b=>b.map(c=>{var p;return c.id===n?{...c,data:{...c.data,config:{...c.data.config,modelId:a,modelName:(p=ee.find(d=>d.id===a))==null?void 0:p.name}}}:c}))},options:ee.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:ee.map(a=>({value:a.id,label:a.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>re("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Z==="wan-std"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>re("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Z==="wan-pro"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((w=s==null?void 0:s.config)==null?void 0:w.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),L.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Ue,src:L.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:a=>{const b=a.currentTarget;b.duration&&b.duration!==1/0&&de(b.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((u=s==null?void 0:s.config)==null?void 0:u.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),L.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:L.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:F,disabled:ye||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ye?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ye?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ie&&(pe!==null&&pe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[pe,"ç§¯åˆ†"]}):K===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},io=t.memo(no),br="https://api.waule.ai",lo=({data:s,selected:j,id:n})=>{var O,I;const[W]=t.useState(!0),[ye,T]=t.useState(!1),[fe,Z]=t.useState(!1),re=t.useRef(null),K=t.useRef(null),de=t.useRef(null),[Ue,ce]=t.useState(!1),[se,ae]=t.useState(0),[je,ie]=t.useState(0),[xe,ue]=t.useState(0),[pe,Ie]=t.useState(null),{setNodes:ee,setEdges:Q,getNode:U,getNodes:R,getEdges:L}=Zt(),f=zs(),x=Ls(),A=t.useMemo(()=>`lipSyncTask:${n}`,[n]),F=t.useMemo(()=>(s.models||[]).filter(l=>{var i;return(l.type||"")==="VIDEO_EDITING"&&Array.isArray((i=l.config)==null?void 0:i.supportedEditingCapabilities)&&l.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[G,v]=t.useState(s.config.modelId||((O=F[0])==null?void 0:O.id)||"");t.useEffect(()=>{var g;if(!F.find(l=>l.id===G)){const l=((g=F[0])==null?void 0:g.id)||"";v(l),ee(i=>i.map(z=>{var D;return z.id===n?{...z,data:{...z.data,config:{...z.data.config,modelId:l||void 0,modelName:l?(D=F[0])==null?void 0:D.name:void 0}}}:z}))}},[F]);const $=t.useMemo(()=>!je||!se?0:je>=se||fe?se:je,[je,se,fe]),{credits:r,loading:w}=Ss({aiModelId:G,duration:$,mode:"standard",operationType:"video_retalk"}),u=t.useMemo(()=>{var D,X,V,ne,me,oe,N,h,E;const g=f.filter(y=>y.target===n);let l=null,i=null,z=null;for(const y of g){const J=x.find(B=>B.id===y.source);if(!J)continue;const ge=String(J.type||"");if(ge==="upload"){const B=(V=(X=(D=J.data)==null?void 0:D.config)==null?void 0:X.uploadedFiles)==null?void 0:V[0];if(!B)continue;const he=String(B.mimeType||"").toLowerCase(),Se=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${br}${B.url}`;!l&&(Se==="VIDEO"||he.startsWith("video/"))&&(l=Ne),!i&&(Se==="AUDIO"||he.startsWith("audio/"))&&(i=Ne),!z&&(Se==="IMAGE"||he.startsWith("image/"))&&(z=Ne)}else if(ge==="assetSelector"){const B=(me=(ne=J.data)==null?void 0:ne.config)==null?void 0:me.selectedAsset;if(B){const he=String(B.mimeType||"").toLowerCase(),Se=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${br}${B.url}`;!l&&(Se==="VIDEO"||he.startsWith("video/"))&&(l=Ne),!i&&(Se==="AUDIO"||he.startsWith("audio/"))&&(i=Ne),!z&&(Se==="IMAGE"||he.startsWith("image/"))&&(z=Ne)}}else if(ge==="videoPreview"||ge.startsWith("aiVideo")){const B=((oe=J.data)==null?void 0:oe.videoUrl)||((N=J.data)==null?void 0:N.url)||((E=(h=J.data)==null?void 0:h.config)==null?void 0:E.generatedVideoUrl);!l&&B&&(l=B.startsWith("http")||B.startsWith("data:")?B:`${br}${B}`)}if(l&&i&&z)break}return{videoUrl:l,audioUrl:i,imageUrl:z}},[f,n,x]),a=t.useMemo(()=>{var l;const g=F.find(i=>i.id===G);return((l=g==null?void 0:g.modelId)==null?void 0:l.toLowerCase().includes("videoretalk"))||!1},[G,F]),b=t.useMemo(()=>!!G&&!!u.videoUrl&&!!u.audioUrl&&!pe,[G,u.videoUrl,u.audioUrl,pe]);t.useEffect(()=>{const g=re.current;if(!g||!u.audioUrl)return;g.src=u.audioUrl,g.load();const l=()=>{ae(g.duration||0)},i=()=>ue(g.duration?g.currentTime/g.duration:0),z=()=>ce(!1);return g.addEventListener("loadedmetadata",l),g.addEventListener("timeupdate",i),g.addEventListener("ended",z),()=>{g.removeEventListener("loadedmetadata",l),g.removeEventListener("timeupdate",i),g.removeEventListener("ended",z)}},[u.audioUrl]),t.useEffect(()=>{if(!u.videoUrl){ie(0);return}const g=document.createElement("video");g.src=u.videoUrl,g.onloadedmetadata=()=>{if(ie(g.duration||0),a){const l=g.videoWidth,i=g.videoHeight;l>2048||i>2048?(Ie(`è§†é¢‘åˆ†è¾¨ç‡ ${l}x${i} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),m.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${l}x${i}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),Q(z=>z.filter(D=>{var ne,me,oe,N,h,E,y,J;if(D.target!==n)return!0;const X=x.find(ge=>ge.id===D.source);return X?!(X.type==="upload"&&((N=(oe=(me=(ne=X.data)==null?void 0:ne.config)==null?void 0:me.uploadedFiles)==null?void 0:oe[0])==null?void 0:N.type)==="VIDEO"||X.type==="assetSelector"&&((y=(E=(h=X.data)==null?void 0:h.config)==null?void 0:E.selectedAsset)==null?void 0:y.type)==="VIDEO"||X.type==="videoPreview"||((J=X.type)==null?void 0:J.startsWith("aiVideo"))):!0}))):pe!=null&&pe.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ie(null)}},g.onerror=()=>ie(0),g.load()},[u.videoUrl,a,n,x,Q]),t.useEffect(()=>{const g=u.audioUrl,l=de.current;if(!g||!l)return;const i=D=>{const X=l.getContext("2d");if(!X)return;const V=l.width,ne=l.height;X.clearRect(0,0,V,ne);const me="#1a1033",oe="#7a0fe8";X.fillStyle=me,X.fillRect(0,0,V,ne);const N=D.length,h=2,E=Math.max(1,Math.floor((V-(N-1)*h)/N));for(let y=0;y<N;y++){const J=Math.min(1,Math.max(0,D[y])),ge=Math.max(2,Math.floor(J*ne)),B=y*(E+h),he=Math.floor((ne-ge)/2);X.fillStyle=oe,X.fillRect(B,he,E,ge)}if(xe>0){const y=Math.floor(V*xe);X.fillStyle="#ffffff88",X.fillRect(y,0,2,ne)}};(async()=>{try{let D=g;g.includes("aliyuncs.com")&&(D=`https://api.waule.ai/proxy/audio?url=${encodeURIComponent(g)}`);const V=await(await fetch(D,{mode:(g.includes("aliyuncs.com"),"cors"),credentials:g.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ne=window.AudioContext||window.webkitAudioContext,N=(await new ne().decodeAudioData(V)).getChannelData(0),h=120,E=Math.max(1,Math.floor(N.length/h)),y=new Float32Array(h);for(let J=0;J<h;J++){let ge=0,B=0;const he=J*E,Se=Math.min(N.length,he+E);for(let Ne=he;Ne<Se;Ne++)ge+=Math.abs(N[Ne]),B++;y[J]=B?ge/B:0}i(y)}catch{const X=new Float32Array(120);for(let V=0;V<120;V++)X[V]=(Math.sin(V/5)+1)/2;i(X)}})()},[u.audioUrl,xe]);const c=()=>{const g=re.current;g&&(Ue?(g.pause(),ce(!1)):(g.play(),ce(!0)))},p=g=>{if(!g||!isFinite(g))return"0:00";const l=Math.floor(g/60),i=Math.floor(g%60);return`${l}:${i.toString().padStart(2,"0")}`},d=t.useCallback(g=>{var Re,Ce,Ae;const l=U(n);if(!l||!g)return;const i=g.startsWith("http")||g.startsWith("data:")?g:`${br}${g}`,z=R(),D=L(),X=z.filter($e=>$e.type==="videoPreview"&&D.some(le=>le.source===n&&le.target===$e.id));if(X.find($e=>{var le;return((le=$e.data)==null?void 0:le.videoUrl)===i}))return;const ne=400,me=($e,le=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test($e))return le;const[Ge,Qe]=$e.split(":").map(Wt=>parseFloat(Wt));return!Ge||!Qe?le:Math.round(ne*(Qe/Ge))},oe=200,N=100,h=me("16:9",300),E=document.querySelector(`.react-flow__node[data-id="${n}"]`),y=Math.round((E==null?void 0:E.getBoundingClientRect().width)||400),J=(((Re=l.position)==null?void 0:Re.x)||0)+y+oe,ge=((Ce=l.position)==null?void 0:Ce.y)||0,B=X.length,he=J,Se=ge+B*(h+N),Ne={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:he,y:Se},data:{videoUrl:i,ratio:"16:9",workflowContext:l.data.workflowContext,createdBy:(Ae=l.data)==null?void 0:Ae.createdBy}};ee($e=>[...$e,Ne]),Q($e=>[...$e,{id:`edge-${n}-${Ne.id}`,source:n,target:Ne.id,type:"aurora"}])},[n,U,R,L,ee,Q]);t.useEffect(()=>{var l;const g=(l=s==null?void 0:s.config)==null?void 0:l.generatedVideoUrl;g&&d(g)},[(I=s==null?void 0:s.config)==null?void 0:I.generatedVideoUrl]),t.useEffect(()=>{const g=s.config.taskId||(()=>{try{return localStorage.getItem(A)||""}catch{return""}})();(async()=>{var z,D;let i=!1;if(g)try{const V=(await _e.tasks.getTaskStatus(g)).task;if(V.status==="PROCESSING"||V.status==="PENDING"){const ne=new Date(V.createdAt);if((new Date().getTime()-ne.getTime())/(1e3*60*60)>1){T(!1),ee(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(A)}catch{}return}}if(V.status==="SUCCESS"||V.status==="COMPLETED"||V.status==="DONE"){const ne=V.resultUrl||((z=V.previewNodeData)==null?void 0:z.url);if(ne){let me=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";me=JSON.parse(oe).some(h=>h.taskId&&h.taskId===g||h.sourceNodeId&&h.sourceNodeId===n)}catch{}me||d(ne),ee(oe=>oe.map(N=>N.id===n?{...N,data:{...N.data,config:{...N.data.config,generatedVideoUrl:ne,taskId:g}}}:N))}T(!1);try{localStorage.removeItem(A)}catch{}i=!0}else if(V.status==="PROCESSING"||V.status==="PENDING"){T(!0),await k(g);return}else if(V.status==="FAILURE"||V.status==="FAILED"){T(!1),ee(ne=>ne.map(me=>me.id===n?{...me,data:{...me.data,config:{...me.data.config,taskId:""}}}:me));try{localStorage.removeItem(A)}catch{}}}catch{T(!1);try{localStorage.removeItem(A)}catch{}}if(!i)try{const X=await _e.tasks.getPendingPreviewNodes(n);if(Array.isArray(X.tasks)&&X.tasks.length>0)for(const V of X.tasks){const ne=(D=V.previewNodeData)==null?void 0:D.url;if(ne){let me=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";me=JSON.parse(oe).some(h=>h.taskId&&h.taskId===V.id||h.sourceNodeId&&h.sourceNodeId===n)}catch{}me||d(ne),await _e.tasks.markPreviewNodeCreated(V.id)}}}catch{}})()},[A,n,d]);const k=async g=>{let l=0;const i=600;let z=-1,D=0;const X=60,V=async()=>{var ne;try{l++;const oe=(await _e.tasks.getTaskStatus(g)).task;if(oe.status==="PROCESSING"||oe.status==="PENDING"){const N=oe.progress||0;if(N===z){if(D++,D>=X){T(!1),m.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),ee(h=>h.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,taskId:""}}}:E));try{localStorage.removeItem(A)}catch{}return}}else z=N,D=0}if(oe.status==="SUCCESS"||oe.status==="COMPLETED"||oe.status==="DONE"){const N=oe.resultUrl||((ne=oe.previewNodeData)==null?void 0:ne.url);N&&(d(N),ee(h=>h.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,generatedVideoUrl:N,taskId:g}}}:E))),T(!1),m.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(A)}catch{}return}else if(oe.status==="PROCESSING"||oe.status==="PENDING")if(l<i)setTimeout(V,5e3);else{T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ee(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(A)}catch{}return}else if(oe.status==="FAILURE"||oe.status==="FAILED"){T(!1);try{const{useAuthStore:N}=await ds(async()=>{const{useAuthStore:E}=await import("./index-Dg_hJ4va.js").then(y=>y.f);return{useAuthStore:E}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:h}=N.getState();await h()}catch{}m.error(oe.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ee(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(A)}catch{}return}else{T(!1),m.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),ee(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(A)}catch{}return}}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ee(oe=>oe.map(N=>N.id===n?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N));try{localStorage.removeItem(A)}catch{}return}};V()},_=async()=>{var g,l;if(!b){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}T(!0);try{const i=await _e.post("/tasks/video-edit",{modelId:G,prompt:"",referenceImages:u.imageUrl?[u.imageUrl]:[],sourceNodeId:n,generationType:"å¯¹å£å‹",duration:$,metadata:{videoUrl:u.videoUrl,audioUrl:u.audioUrl,videoExtension:fe,duration:$}}),z=i.taskId,D=i.creditsCharged||0;if(D>0)try{const{useAuthStore:X}=await ds(async()=>{const{useAuthStore:ne}=await import("./index-Dg_hJ4va.js").then(me=>me.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:V}=X.getState();await V(),m.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${D} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ee(X=>X.map(V=>V.id===n?{...V,data:{...V.data,config:{...V.data.config,taskId:z}}}:V));try{localStorage.setItem(A,z)}catch{}await k(z)}catch(i){T(!1);const z=((l=(g=i==null?void 0:i.response)==null?void 0:g.data)==null?void 0:l.error)||i.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${z}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(A)}catch{}}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:G,onChange:g=>{v(g),ee(l=>l.map(i=>{var z;return i.id===n?{...i,data:{...i.data,config:{...i.data.config,modelId:g,modelName:(z=F.find(D=>D.id===g))==null?void 0:z.name}}}:i}))},options:F.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:F.map(g=>({value:g.id,label:g.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:u.videoUrl?e.jsx("video",{src:u.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},u.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:u.imageUrl?e.jsx("img",{src:u.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},u.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),u.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:c,className:"nodrag w-7 h-7 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Ue?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:p(se)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:de,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:re,src:u.audioUrl,className:"hidden"}),e.jsx("video",{ref:K,className:"hidden",muted:!0,onLoadedMetadata:g=>{const l=g.currentTarget;l.duration&&l.duration!==1/0&&ie(l.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:fe,onChange:g=>Z(g.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:_,disabled:ye||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ye?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ye?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!w&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[r,"ç§¯åˆ†"]}):$===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},co=t.memo(lo),vr="https://api.waule.ai",uo=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],go=({data:s,selected:j,id:n})=>{var F,G;const[W]=t.useState(!0),[ye,T]=t.useState(!1),[fe,Z]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[re,K]=t.useState(s.config.videoFps||15),[de,Ue]=t.useState(0),ce=t.useRef(null),{setNodes:se,setEdges:ae,getNode:je,getNodes:ie,getEdges:xe}=Zt(),ue=zs(),pe=t.useMemo(()=>(s.models||[]).filter($=>{var r;return($.type||"")==="VIDEO_EDITING"&&Array.isArray((r=$.config)==null?void 0:r.supportedEditingCapabilities)&&$.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ie,ee]=t.useState(s.config.modelId||((F=pe[0])==null?void 0:F.id)||""),{credits:Q,loading:U}=Ss({aiModelId:Ie,duration:de});t.useMemo(()=>pe.find(v=>v.id===Ie),[pe,Ie]),t.useEffect(()=>{var v;if(!pe.find($=>$.id===Ie)){const $=((v=pe[0])==null?void 0:v.id)||"";ee($),se(r=>r.map(w=>{var u;return w.id===n?{...w,data:{...w.data,config:{...w.data.config,modelId:$||void 0,modelName:$?(u=pe[0])==null?void 0:u.name:void 0}}}:w}))}},[pe]);const R=t.useMemo(()=>{var r,w,u,a,b,c,p,d,k;const v=ue.filter(_=>_.target===n);let $=null;for(const _ of v){const O=je(_.source);if(!O)continue;const I=String(O.type||"");if(I==="upload"){const g=(u=(w=(r=O.data)==null?void 0:r.config)==null?void 0:w.uploadedFiles)==null?void 0:u[0];if(!g)continue;const l=String(g.mimeType||"").toLowerCase(),i=String(g.type||"").toUpperCase(),z=g.url.startsWith("http")||g.url.startsWith("data:")?g.url:`${vr}${g.url}`;!$&&(i==="VIDEO"||l.startsWith("video/"))&&($=z)}else if(I==="assetSelector"){const g=(b=(a=O.data)==null?void 0:a.config)==null?void 0:b.selectedAsset;if(g){const l=String(g.mimeType||"").toLowerCase(),i=String(g.type||"").toUpperCase(),z=g.url.startsWith("http")||g.url.startsWith("data:")?g.url:`${vr}${g.url}`;!$&&(i==="VIDEO"||l.startsWith("video/"))&&($=z)}}else if(I==="videoPreview"||I.startsWith("aiVideo")){const g=((c=O.data)==null?void 0:c.videoUrl)||((p=O.data)==null?void 0:p.url)||((k=(d=O.data)==null?void 0:d.config)==null?void 0:k.generatedVideoUrl);!$&&g&&($=g.startsWith("http")||g.startsWith("data:")?g:`${vr}${g}`)}if($)break}return{videoUrl:$}},[ue,n,je]);t.useEffect(()=>{if(!R.videoUrl){Ue(0);return}const v=document.createElement("video");v.preload="metadata",v.onloadedmetadata=()=>{v.duration&&v.duration!==1/0&&Ue(v.duration)},v.onerror=()=>Ue(0),v.src=R.videoUrl},[R.videoUrl]);const L=t.useMemo(()=>!!Ie&&!!R.videoUrl,[Ie,R.videoUrl]),f=t.useCallback(v=>{var X,V,ne;const $=je(n);if(!$||!v)return;const r=ie(),w=xe(),u=r.filter(me=>me.type==="videoPreview"&&w.some(oe=>oe.source===n&&oe.target===me.id));if(u.find(me=>{var oe;return((oe=me.data)==null?void 0:oe.videoUrl)===v}))return;const b=400,c=(me,oe=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(me))return oe;const[N,h]=me.split(":").map(E=>parseFloat(E));return!N||!h?oe:Math.round(b*(h/N))},p=200,d=100,k=c("16:9",300),_=document.querySelector(`.react-flow__node[data-id="${n}"]`),O=Math.round((_==null?void 0:_.getBoundingClientRect().width)||400),I=(((X=$.position)==null?void 0:X.x)||0)+O+p,g=((V=$.position)==null?void 0:V.y)||0,l=u.length,i=I,z=g+l*(k+d),D={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:i,y:z},data:{videoUrl:v,width:b,ratio:"16:9",workflowContext:$.data.workflowContext,createdBy:(ne=$.data)==null?void 0:ne.createdBy}};se(me=>[...me,D]),ae(me=>[...me,{id:`edge-${n}-${D.id}`,source:n,target:D.id,type:"aurora"}])},[n,je,ie,xe,se,ae]);t.useEffect(()=>{var $;const v=($=s==null?void 0:s.config)==null?void 0:$.generatedVideoUrl;v&&f(v)},[(G=s==null?void 0:s.config)==null?void 0:G.generatedVideoUrl]),t.useEffect(()=>{const v=s.config.taskId;(async()=>{var w,u;let r=!1;if(v)try{const b=(await _e.tasks.getTaskStatus(v)).task;if(b.status==="SUCCESS"){const c=b.resultUrl||((w=b.previewNodeData)==null?void 0:w.url);if(c){let p=!1;try{const d=localStorage.getItem("suppressedPreviewTasks")||"[]";p=JSON.parse(d).some(_=>_.taskId&&_.taskId===v||_.sourceNodeId&&_.sourceNodeId===n)}catch{}p||f(c),se(d=>d.map(k=>k.id===n?{...k,data:{...k.data,config:{...k.data.config,generatedVideoUrl:c,taskId:v}}}:k))}T(!1),r=!0}else if(b.status==="PROCESSING"||b.status==="PENDING"){T(!0),await x(v);return}else b.status==="FAILURE"&&(T(!1),se(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p)))}catch{T(!1)}if(!r)try{const a=await _e.tasks.getPendingPreviewNodes(n);if(Array.isArray(a.tasks)&&a.tasks.length>0)for(const b of a.tasks){const c=(u=b.previewNodeData)==null?void 0:u.url;if(c){let p=!1;try{const d=localStorage.getItem("suppressedPreviewTasks")||"[]";p=JSON.parse(d).some(_=>_.taskId&&_.taskId===b.id||_.sourceNodeId&&_.sourceNodeId===n)}catch{}p||f(c),await _e.tasks.markPreviewNodeCreated(b.id)}}}catch{}})()},[]);const x=async v=>{let $=0;const r=600,w=async()=>{var u;try{$++;const b=(await _e.tasks.getTaskStatus(v)).task;if(b.status==="SUCCESS"){const c=b.resultUrl||((u=b.previewNodeData)==null?void 0:u.url);c&&(f(c),se(p=>p.map(d=>d.id!==n?d:{...d,data:{...d.data,config:{...d.data.config,generatedVideoUrl:c,taskId:v}}}))),T(!1),m.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else b.status==="PROCESSING"||b.status==="PENDING"?$<r?setTimeout(w,5e3):(T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),se(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p))):b.status==="FAILURE"&&(T(!1),m.error(b.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),se(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p)))}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),se(b=>b.map(c=>c.id===n?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c))}};w()},A=async()=>{var v,$;if(!L){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}T(!0);try{const r=await _e.post("/tasks/video-edit",{modelId:Ie,prompt:"",referenceImages:[],sourceNodeId:n,generationType:"é£æ ¼è½¬æ¢",duration:de,metadata:{videoUrl:R.videoUrl,styleId:fe,videoFps:re,duration:de}}),w=r.taskId,u=r.creditsCharged||0;if(u>0)try{const{useAuthStore:a}=await ds(async()=>{const{useAuthStore:c}=await import("./index-Dg_hJ4va.js").then(p=>p.f);return{useAuthStore:c}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:b}=a.getState();await b(),m.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${u} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");se(a=>a.map(b=>b.id===n?{...b,data:{...b.data,config:{...b.data.config,taskId:w,styleId:fe,videoFps:re}}}:b)),await x(w)}catch(r){T(!1);const w=(($=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:$.error)||r.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${w}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(os,{value:Ie,onChange:v=>{ee(v),se($=>$.map(r=>{var w;return r.id===n?{...r,data:{...r.data,config:{...r.data.config,modelId:v,modelName:(w=pe.find(u=>u.id===v))==null?void 0:w.name}}}:r}))},options:pe.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:pe.map(v=>({value:v.id,label:v.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(os,{value:String(fe),onChange:v=>{const $=parseInt(v,10);Z($),se(r=>r.map(w=>w.id===n?{...w,data:{...w.data,config:{...w.data.config,styleId:$}}}:w))},options:uo.map(v=>({value:String(v.id),label:v.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:re,min:15,max:25,onChange:v=>{let $=parseInt(v.target.value,10)||15;$<15&&($=15),$>25&&($=25),K($),se(r=>r.map(w=>w.id===n?{...w,data:{...w.data,config:{...w.data.config,videoFps:$}}}:w))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),R.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:ce,src:R.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:v=>{const $=v.currentTarget;$.duration&&$.duration!==1/0&&Ue($.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:A,disabled:ye||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ye?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ye?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!U&&(Q!==null&&Q>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Q,"ç§¯åˆ†"]}):de===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ho=t.memo(go),fo=({data:s,selected:j,id:n})=>{const[W,ye]=t.useState(null),[T,fe]=t.useState(!1),[Z,re]=t.useState(s.config.prompt||""),[K,de]=t.useState(""),Ue=t.useRef(null),ce=t.useRef(!1),[se,ae]=t.useState(!1),{setNodes:je,setEdges:ie,getNode:xe,getNodes:ue,getEdges:pe}=Zt(),Ie=Fs(a=>a.edges.filter(b=>b.target===n)),ee=Ls(),[Q,U]=t.useState([]),[R,L]=t.useState([]),f=t.useRef(""),x=t.useMemo(()=>((W==null?void 0:W.roles)||[]).find(a=>a.id===K),[W,K]),{credits:A,loading:F,isFreeUsage:G,freeUsageRemaining:v}=Ss({aiModelId:x==null?void 0:x.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&$(s.config.agentId)},[s.config.agentId]);const $=async a=>{var b,c,p,d,k;try{fe(!0);const _=await _e.agents.getById(a);let O=[];try{O=await _e.agents.roles.listByAgent(a)||[],ye({..._,roles:O});const g=((b=s==null?void 0:s.config)==null?void 0:b.roleId)||"";de(g||((c=O[0])==null?void 0:c.id)||"")}catch{ye(_)}try{const I=await _e.agents.getAvailableModels(),g=(O||[]).find(l=>{var i;return l.id===((i=s==null?void 0:s.config)==null?void 0:i.roleId)});if(g){const l=(I||[]).find(z=>z.id===g.aiModelId),i=((p=l==null?void 0:l.config)==null?void 0:p.acceptedInputs)||((l==null?void 0:l.type)==="TEXT_GENERATION"&&((k=(d=l==null?void 0:l.provider)==null?void 0:d.toLowerCase())!=null&&k.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:i})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{m.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{fe(!1)}};t.useEffect(()=>{r({roleId:K}),(async()=>{var a,b,c;if(W)try{const p=await _e.agents.getAvailableModels(),d=(W.roles||[]).find(k=>k.id===K);if(d){const k=(p||[]).find(O=>O.id===d.aiModelId),_=((a=k==null?void 0:k.config)==null?void 0:a.acceptedInputs)||((k==null?void 0:k.type)==="TEXT_GENERATION"&&((c=(b=k==null?void 0:k.provider)==null?void 0:b.toLowerCase())!=null&&c.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:_})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[K,W]);const r=a=>{xe(n)&&je(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,...a}}}:p))};t.useEffect(()=>{const a=Ue.current;a&&requestAnimationFrame(()=>{a.style.height="auto";const b=Math.max(60,Math.min(a.scrollHeight,600));a.style.height=`${b}px`})},[Z]),t.useEffect(()=>{const a=setTimeout(()=>{Z!==s.config.prompt&&r({prompt:Z})},500);return()=>clearTimeout(a)},[Z,s.config.prompt]),t.useEffect(()=>{const a=Ie;if(!a||a.length===0)return;let b="";a.some(c=>{const p=ee.find(k=>k.id===c.source);if(!p)return!1;const d=p.data||{};return p.type==="textPreview"&&typeof d.content=="string"&&d.content.trim()?(b=d.content.trim(),!0):!1}),b&&!ce.current&&(re(b),r({prompt:b}))},[Ie,ee]),t.useEffect(()=>{const a=Ie.map(p=>`${p.id}-${p.source}`).sort().join(",");if(a===f.current)return;f.current=a;const b=[],c=[];Ie.forEach(p=>{var _,O,I;const d=xe(p.source);if(!d)return;const k=d.data||{};if(d.type==="upload")(((_=k.config)==null?void 0:_.uploadedFiles)||[]).forEach(l=>{l.type==="IMAGE"&&b.push(l.url),l.type==="DOCUMENT"&&c.push({name:l.originalName,url:l.url})});else if(d.type==="assetSelector"){const g=(O=k.config)==null?void 0:O.subjects;if(g&&g.length>0)(g[0].images||[]).map(i=>{const z="https://api.waule.ai";return i.startsWith("data:")?i:i.startsWith("http")?i.replace(/^https?:\/\/localhost(?::\d+)?/i,z):`${z}${i}`}).forEach(i=>b.push(i));else{const l=(I=k.config)==null?void 0:I.selectedAsset;if(l){const i="https://api.waule.ai",z=D=>D.startsWith("http")?D.replace(/^https?:\/\/localhost(?::\d+)?/i,i):`${i}${D}`;l.type==="IMAGE"&&b.push(z(l.url)),l.type==="DOCUMENT"&&c.push({name:l.originalName,url:z(l.url)})}}}else d.type==="imagePreview"&&k.imageUrl&&b.push(k.imageUrl)}),U(b),L(c)},[Ie,xe,ee]);const w=()=>{if(!W)return null;const a=(W.roles||[]).find(b=>b.id===K);return a?{systemPrompt:a.systemPrompt,aiModelId:a.aiModelId,temperature:a.temperature,maxTokens:a.maxTokens}:null},u=async()=>{var b,c,p,d,k,_,O,I,g,l,i,z,D,X;if(!W){m.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!Z.trim()){m.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let a=(W.roles||[]).find(V=>V.id===K)||(W.roles||[])[0];if(!a){m.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!K||K!==a.id)&&(de(a.id),r({roleId:a.id}));try{ae(!0);const ne=pe().filter(Ce=>Ce.target===n);let me="";const oe="https://api.waule.ai",N=[],h=[],E=[];for(const Ce of ne){const Ae=xe(Ce.source);if(Ae)if(Ae.type==="upload"){const $e=((c=(b=Ae.data)==null?void 0:b.config)==null?void 0:c.uploadedFiles)||[];for(const le of $e)if(le.type==="DOCUMENT")N.push({filePath:le.url,mimeType:le.mimeType}),me+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){const Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;h.push(Ge),me+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){const Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;E.push(Ge),me+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}else le.type==="AUDIO"&&(me+=`[éŸ³é¢‘æ–‡ä»¶: ${le.originalName}]
`)}else if(Ae.type==="assetSelector"){const $e=(d=(p=Ae.data)==null?void 0:p.config)==null?void 0:d.subjects;if($e&&$e.length>0){const le=($e[0].images||[]).map(Ge=>Ge.startsWith("http")?Ge:`${oe}${Ge}`).map(Ge=>Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe));le.forEach(Ge=>h.push(Ge)),me+=`[å‚è€ƒå›¾ç‰‡ç»„: ${le.length} å¼ ]
`}else{const le=(_=(k=Ae.data)==null?void 0:k.config)==null?void 0:_.selectedAsset;if(le){if(le.type==="DOCUMENT")N.push({filePath:le.url,mimeType:le.mimeType}),me+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){let Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ge=Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),h.push(Ge),me+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){let Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ge=Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),E.push(Ge),me+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}}}}else if(Ae.type==="aiImage"){const $e=(I=(O=Ae.data)==null?void 0:O.config)==null?void 0:I.generatedImageUrl;if($e){const le=$e.startsWith("http")?$e:`${oe}${$e}`;h.push(le),me+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(Ae.type==="imagePreview"){const $e=Ae.data.imageUrl;$e&&(h.push($e),me+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(Ae.type==="videoPreview"){const $e=Ae.data.videoUrl;if($e){const le=$e.startsWith("http")?$e:`${oe}${$e}`;E.push(le),me+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else Ae.type==="textPreview"&&Ae.data.content&&(me+=Ae.data.content+`

`)}const y=w();if(!y)return;let J=y.systemPrompt;me&&(J+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${me}`),J+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${Z}`;const ge=await _e.ai.text.generate({modelId:a.aiModel.id||y.aiModelId,prompt:J,systemPrompt:a.systemPrompt||y.systemPrompt,temperature:a.temperature??y.temperature,maxTokens:a.maxTokens??y.maxTokens,documentFiles:N.length>0?N:void 0,imageUrls:h.length>0?h:void 0,videoUrls:E.length>0?E:void 0}),B=ge&&(((g=ge.data)==null?void 0:g.text)||(ge==null?void 0:ge.text))||"";if(!B||B.trim()===""){m.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:B});const he=pe().filter(Ce=>Ce.source===n),Se=ue(),Ne=he.filter(Ce=>{const Ae=Se.find($e=>$e.id===Ce.target);return Ae&&Ae.type!=="textPreview"});if(Ne.length>0)je(Ce=>{const Ae=new Set(Ne.map($e=>$e.target));return Ce.map($e=>{var Ge;if(!Ae.has($e.id))return $e;const le=((Ge=$e.data)==null?void 0:Ge.config)||{};return $e.type==="midjourney"?{...$e,data:{...$e.data,prompt:B}}:{...$e,data:{...$e.data,config:{...le,prompt:B}}}})});else{const Ce=xe(n);if(Ce){const Ae=Date.now(),$e=`text-preview-${n}-${Ae}`,le=he.filter(gt=>{const vt=Se.find(it=>it.id===gt.target);return vt&&vt.type==="textPreview"}),Ge=document.querySelector(`.react-flow__node[data-id="${n}"]`),Qe=(Ge==null?void 0:Ge.getBoundingClientRect().width)||300,Wt=Ce.position.x+Qe+100,Ct=Ce.position.y+le.length*700,_t={id:$e,type:"textPreview",position:{x:Wt,y:Ct},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:B,createdBy:(l=Ce.data)==null?void 0:l.createdBy}},ct={id:`edge-${n}-${$e}`,source:n,target:$e,type:"aurora"};je(gt=>[...gt,_t]),setTimeout(()=>{ie(gt=>[...gt,ct])},50)}}const Re=(ge==null?void 0:ge.creditsCharged)||0;if(Re>0){const{useAuthStore:Ce}=await ds(async()=>{const{useAuthStore:$e}=await import("./index-Dg_hJ4va.js").then(le=>le.f);return{useAuthStore:$e}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ae}=Ce.getState();await Ae(),m.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${Re} ç§¯åˆ†ï¼‰`)}else m.success("æ‰§è¡ŒæˆåŠŸ")}catch(V){const ne=((z=(i=V==null?void 0:V.response)==null?void 0:i.data)==null?void 0:z.message)||((X=(D=V==null?void 0:V.response)==null?void 0:D.data)==null?void 0:X.error)||(V==null?void 0:V.message)||"æœªçŸ¥é”™è¯¯";m.error("æ‰§è¡Œå¤±è´¥ï¼š"+ne)}finally{ae(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:T?"LOADING...":((W==null?void 0:W.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[W&&(W.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(os,{value:K,onChange:a=>de(a),options:[...W.roles||[]].sort((a,b)=>(a.order??0)-(b.order??0)).map(a=>({value:a.id,label:a.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Ue,value:Z,onChange:a=>{ce.current=!0,re(a.target.value)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:u,disabled:se||T||!W||!Z.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:cursor-not-allowed bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg  border-transparent dark:border-white/10",children:se?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!F&&(G?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(v),"æ¬¡"]}):A!==null&&A>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[A,"ç§¯åˆ†"]}):null)]})}),Q.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",Q.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:Q.map((a,b)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:a,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"})},b))})]}),R.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",R.length,")"]}),e.jsx("div",{className:"space-y-1",children:R.map((a,b)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:a.name,children:a.name})]},b))})]})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},po=t.memo(fo),Nr="https://api.waule.ai",_s=400,mo=({data:s,id:j,selected:n})=>{const[W,ye]=t.useState(!1),[T,fe]=t.useState(0),[Z,re]=t.useState(s.config.uploadedFiles||[]),[K,de]=t.useState(null),[Ue,ce]=t.useState(null);t.useEffect(()=>()=>{},[j]),t.useEffect(()=>{},[K]),t.useEffect(()=>{},[Ue]);const[se,ae]=t.useState(null),je=t.useRef(null),ie=t.useRef(null),xe=t.useRef(null),[ue,pe]=t.useState(!1),[Ie,ee]=t.useState(0),[Q,U]=t.useState(0),[R,L]=t.useState(!1),f=t.useRef(null),{setNodes:x,getNode:A,setEdges:F,getEdges:G}=Zt(),v=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const i=s.createdBy;if(typeof i=="object"&&(i==null||i.id),v.current)return;const z=s.config.uploadedFiles||[];!W&&JSON.stringify(z)!==JSON.stringify(Z)&&(re(z),de(null),ce(null))},[s.config.uploadedFiles,W,s._currentUserId,s.createdBy]);const $=()=>{f.current&&(f.current.paused?(f.current.play(),L(!0)):(f.current.pause(),L(!1)))},r=i=>{A(j)&&(v.current=!0,x(D=>D.map(X=>X.id===j?{...X,data:{...X.data,config:{...X.data.config,uploadedFiles:i}}}:X)))},w=async i=>{var D,X;if(!i||i.length===0)return;ye(!0);const z=[];try{for(let V=0;V<i.length;V++){const ne=i[V];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ne.type)){m.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ne.name}`);continue}const oe=await _e.assets.upload(ne,void 0,{onUploadProgress:N=>{const h=(N==null?void 0:N.total)||0,E=(N==null?void 0:N.loaded)||0;if(h>0){const y=Math.round(E/h*100);fe(y)}}});if(oe.data){const N=(oe.data.type||"").toUpperCase(),h=(oe.data.mimeType||"").toLowerCase(),E=N==="IMAGE"||N==="VIDEO"||N==="AUDIO"?N:h.startsWith("image/")?"IMAGE":h.startsWith("video/")?"VIDEO":h.startsWith("audio/")?"AUDIO":N||"",y=oe.data.url;z.push({id:oe.data.id,name:oe.data.name,originalName:oe.data.originalName,type:E,mimeType:oe.data.mimeType,size:oe.data.size,url:y})}}if(z.length>0){let V=[];const ne=z[0].type;if(se!==null)V=[...Z],V[se]=z[0];else{const oe={};for(const N of Z)oe[N.id]=N;for(const N of z)oe[N.id]=N;V=Object.values(oe)}if(A(j)){const oe=G().filter(h=>h.source===j),N=[];if(oe.forEach(h=>{var J;const E=A(h.target);if(!E||E.type.startsWith("aiVideo"))return;const y=(J=E.data.config)==null?void 0:J.acceptedInputs;if(y&&y.length>0){const ge=ne.toUpperCase();y.map(he=>typeof he=="string"?he.toUpperCase():he).includes(ge)||N.push(h.id)}}),N.length>0){F(E=>E.filter(y=>!N.includes(y.id)));const h={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.warning(`å·²æ–­å¼€ ${N.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${h[ne]||ne}ç±»å‹ï¼‰`)}}de(null),ce(null),re(V),r(V);try{const oe=G().filter(h=>h.source===j);if(oe.some(h=>{const E=A(h.target);return(E==null?void 0:E.type)==="aiVideo"})){const h=localStorage.getItem("workflow:nodes"),E=h?JSON.parse(h):[],y=oe.filter(ge=>{var B;return((B=A(ge.target))==null?void 0:B.type)==="aiVideo"}).map(ge=>ge.target),J=E.filter(ge=>y.includes(ge.id));J.length>0&&x(ge=>ge.map(B=>J.find(he=>he.id===B.id)?{...B,data:{...B.data,config:{...B.data.config,_updatedAt:Date.now()}}}:B))}}catch{}m.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(V){m.error(`ä¸Šä¼ å¤±è´¥: ${((X=(D=V.response)==null?void 0:D.data)==null?void 0:X.message)||V.message}`)}finally{ye(!1),fe(0),je.current&&(je.current.value=""),ae(null)}},u=()=>{x(i=>i.filter(z=>z.id!==j)),F(i=>i.filter(z=>z.source!==j&&z.target!==j)),m.success("èŠ‚ç‚¹å·²åˆ é™¤")},a=()=>{var i;ae(0),(i=je.current)==null||i.click()},b=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(2)+" KB":(i/(1024*1024)).toFixed(2)+" MB",c=i=>i.startsWith("image/")?{icon:"image",color:"text-neutral-500 dark:text-neutral-400"}:i.startsWith("video/")?{icon:"movie",color:"text-neutral-500 dark:text-neutral-400"}:i.startsWith("audio/")?{icon:"audio_file",color:"text-neutral-500 dark:text-neutral-400"}:{icon:"description",color:"text-neutral-500 dark:text-neutral-400"};t.useEffect(()=>{if(Z.length>0){const i=Z[0],z=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Nr}${i.url}`).replace(".oss-oss-",".oss-");if(i.type==="IMAGE"){const D=new Image;D.onload=()=>{const X=D.width/D.height,V=_s/X;de({width:_s,height:V})},D.onerror=X=>{de({width:_s,height:_s*.75})},D.src=z}else if(i.type==="VIDEO"){const D=document.createElement("video");D.onloadedmetadata=()=>{const X=D.videoWidth/D.videoHeight,V=_s/X;ce({width:_s,height:V})},D.onerror=X=>{ce({width:_s,height:_s*.5625})},D.src=z}}},[Z]);const p=()=>{const i=ie.current;i&&(ue?(i.pause(),pe(!1)):(i.play(),pe(!0)))};t.useEffect(()=>{const i=ie.current;if(!i)return;const z=()=>ee(i.duration||0),D=()=>U(i.duration?i.currentTime/i.duration:0),X=()=>pe(!1);return i.addEventListener("loadedmetadata",z),i.addEventListener("timeupdate",D),i.addEventListener("ended",X),()=>{i.removeEventListener("loadedmetadata",z),i.removeEventListener("timeupdate",D),i.removeEventListener("ended",X)}},[Z]);const d=t.useRef(null),[k,_]=t.useState(0);t.useEffect(()=>{const i=Z[0];if(!i||i.type!=="AUDIO"){d.current=null;return}const D=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Nr}${i.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let V;/https:\/\/.*aliyuncs\.com\//.test(D)?V=await _e.assets.proxyDownload(D):V=await(await fetch(D,{mode:"cors"})).arrayBuffer();const ne=window.AudioContext||window.webkitAudioContext,N=(await new ne().decodeAudioData(V)).getChannelData(0),h=120,E=Math.max(1,Math.floor(N.length/h)),y=new Float32Array(h);for(let J=0;J<h;J++){let ge=0,B=0;const he=J*E,Se=Math.min(N.length,he+E);for(let Ne=he;Ne<Se;Ne++)ge+=Math.abs(N[Ne]),B++;y[J]=B?ge/B:0}d.current=y,_(J=>J+1)}catch{const ne=new Float32Array(120);for(let me=0;me<120;me++)ne[me]=(Math.sin(me/5)+1)/2;d.current=ne,_(me=>me+1)}})()},[Z]),t.useEffect(()=>{const i=xe.current;if(!i)return;const z=d.current;if(!z)return;const D=i.getContext("2d");if(!D)return;const X=i.width,V=i.height;D.clearRect(0,0,X,V);const ne=z.length,me=2,oe=Math.max(1,Math.floor((X-(ne-1)*me)/ne)),N=D.createLinearGradient(0,0,X,0);N.addColorStop(0,"#525252"),N.addColorStop(.5,"#d946ef"),N.addColorStop(1,"#404040");for(let h=0;h<ne;h++){const E=Math.min(1,Math.max(0,z[h])),y=Math.max(2,Math.floor(E*V)),J=h*(oe+me),ge=Math.floor((V-y)/2);D.fillStyle=N,D.fillRect(J,ge,oe,y)}if(Q>0){const h=Math.floor(X*Q);D.fillStyle="#ffffff88",D.fillRect(h,0,2,V)}},[Q,k]);const O=i=>{if(!i||!isFinite(i))return"0:00";const z=Math.floor(i/60),D=Math.floor(i%60);return`${z}:${D.toString().padStart(2,"0")}`},I=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"neutral"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"neutral"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"neutral"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"neutral"}],g=Z[0],l=g?(g.url.startsWith("http")||g.url.startsWith("data:")?g.url:`${Nr}${g.url}`).replace(".oss-oss-",".oss-"):"";return g&&g.type==="IMAGE"&&K?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:l,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:K.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>w(i.target.files),className:"hidden"})]}):g&&g.type==="VIDEO"&&Ue?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${R?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:i=>{i.stopPropagation(),$()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:R?"pause":"play_arrow"})})}),e.jsx("video",{ref:f,src:l,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Ue.height},onEnded:()=>L(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>w(i.target.files),className:"hidden"})]}):g&&g.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:p,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:ue?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:O(Ie)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:xe,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ie,src:l,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>w(i.target.files),className:"hidden"})]}):g&&g.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:g.originalName,children:g.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:b(g.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>w(i.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:je,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>w(i.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var i;s._canEdit!==!1&&((i=je.current)==null||i.click())},onDragOver:i=>{i.preventDefault(),i.stopPropagation()},onDrop:i=>{i.preventDefault(),i.stopPropagation(),s._canEdit!==!1&&w(i.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-neutral-400 dark:hover:border-neutral-400/50 transition-colors ${W||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:W?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:W?`ä¸Šä¼ ä¸­... ${T}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),W&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all",style:{width:`${T}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:I.map(i=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${i.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:i.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:i.formats.join(", ")})]},i.type))})]}),Z.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",Z.length,")"]}),Z.map(i=>{const{icon:z,color:D}=c(i.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${D} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:z}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:i.originalName,children:i.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:b(i.size)})]}),e.jsx("button",{onClick:u,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},i.id)})]})]})}),e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},xo=t.memo(mo),Gr="https://api.waule.ai",Ms=320,bo=({data:s,id:j,selected:n})=>{const[W,ye]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[T,fe]=t.useState([]),{setNodes:Z,getNode:re}=Zt(),[K,de]=t.useState(null),[Ue,ce]=t.useState(null),se=t.useRef(null),ae=t.useRef(null),[je,ie]=t.useState(!1),[xe,ue]=t.useState(0),[pe,Ie]=t.useState(0),ee=t.useRef(null),[Q,U]=t.useState(!1),[R,L]=t.useState(!1),f=t.useRef(null),x=()=>{f.current&&(f.current.paused?(f.current.play(),L(!0)):(f.current.pause(),L(!1)))},A=t.useRef(!1);t.useEffect(()=>{const u=s._currentUserId,a=s.createdBy,b=typeof a=="object"?a==null?void 0:a.id:a;if(u&&b&&u===b&&A.current)return;const c=s.config.selectedInput||s.config.selectedAsset||null;if(!c)return;const p=W;(()=>{if(!p)return!1;const k=p.images&&!p.type,_=c.images&&!c.type;if(k&&_){const O=p.images||[],I=c.images||[];if(O.length!==I.length)return!1;for(let g=0;g<O.length;g++)if(O[g].id!==I[g].id||O[g].url!==I[g].url)return!1;return!0}if(p.id&&c.id)return p.id===c.id&&p.url===c.url&&p.type===c.type;try{return JSON.stringify(p)===JSON.stringify(c)}catch{return!1}})()||ye(c)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var a,b,c;if(W&&W.images&&!W.type){const p=W,d=(c=(b=(a=re(j))==null?void 0:a.data)==null?void 0:b.config)==null?void 0:c.referenceImages;Array.isArray(d)&&d.length>0?fe(d.map(k=>({id:k.id,url:k.url,name:k.name}))):fe(p.images||[])}else fe([])},[W,re,j]);const F=u=>{const a=re(j);a&&(A.current=!0,Z(b=>b.map(c=>c.id===j?{...c,data:{...c.data,config:{...c.data.config,...u}}}:c)),ye((u==null?void 0:u.selectedInput)??(u==null?void 0:u.selectedAsset)??a.data.config.selectedInput??a.data.config.selectedAsset))},G=u=>/^https?:\/\//.test(u)||u.startsWith("data:"),v=u=>!u||u.startsWith("data:")?u:/^https?:\/\/localhost(?::\d+)?\//i.test(u)?u.replace(/^https?:\/\/localhost(?::\d+)?/i,Gr):G(u)?u:`${Gr}${u}`;t.useEffect(()=>{var I,g,l,i,z,D,X,V,ne;if(!(W&&W.images&&!W.type))return;const a=W,b=T.length?T:a.images||[];if(b.length===1){const me=b[0],oe={id:me.id,name:me.name,originalName:me.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:me.url};F({selectedInput:oe,selectedAsset:oe,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const c=[{name:a.name,images:b.map(me=>v(me.url))}],p=b.map(me=>({id:me.id,url:me.url,name:me.name})),d=[a.id],k=(l=(g=(I=re(j))==null?void 0:I.data)==null?void 0:g.config)==null?void 0:l.subjects,_=(D=(z=(i=re(j))==null?void 0:i.data)==null?void 0:z.config)==null?void 0:D.referenceImages,O=(ne=(V=(X=re(j))==null?void 0:X.data)==null?void 0:V.config)==null?void 0:ne.roleIds;(JSON.stringify(k)!==JSON.stringify(c)||JSON.stringify(_)!==JSON.stringify(p)||JSON.stringify(O)!==JSON.stringify(d))&&F({subjects:c,referenceImages:p,roleIds:d})},[T]);const $=u=>{if(!(W&&W.images&&!W.type))return;const b=W,c=[...T];if(u<0||u>=c.length)return;if(c.splice(u,1),fe(c),m.success("å·²åˆ é™¤å‚è€ƒå›¾"),c.length===0){ye(null),F({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),m.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(c.length===1){const O=c[0],I={id:O.id,name:O.name,originalName:O.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:O.url};ye(I),F({selectedInput:I,selectedAsset:I,subjects:void 0,referenceImages:void 0,roleIds:void 0}),m.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const p={id:b.id,name:b.name,coverUrl:v(c[0].url),images:c};ye(p);const d=[{name:p.name,images:c.map(O=>v(O.url))}],k=c.map(O=>({id:O.id,url:O.url,name:O.name})),_=[p.id];F({selectedInput:p,subjects:d,referenceImages:k,roleIds:_}),m.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(j)};t.useEffect(()=>{if(W&&W.type){const u=W;if(u.type==="IMAGE"){const a=new Image;a.onload=()=>{const b=a.width/a.height,c=Ms/b;de({width:Ms,height:c})},a.src=v(u.url)}else if(u.type==="VIDEO"){const a=document.createElement("video");a.onloadedmetadata=()=>{const b=a.videoWidth/a.videoHeight,c=Ms/b;ce({width:Ms,height:c})},a.src=v(u.url)}}},[W]),t.useEffect(()=>{if(!(W&&W.type==="AUDIO")){U(!1);return}const b=v(W.url),c=se.current,p=ae.current;if(!c||!p)return;c.src=b,Ie(0),U(!1);const d=()=>ue(c.duration||0),k=()=>Ie(c.duration?c.currentTime/c.duration:0),_=()=>ie(!1);return c.addEventListener("loadedmetadata",d),c.addEventListener("timeupdate",k),c.addEventListener("ended",_),(async()=>{try{const g=await(await fetch(b,{mode:"cors"})).arrayBuffer(),l=window.AudioContext||window.webkitAudioContext,D=(await new l().decodeAudioData(g)).getChannelData(0),X=120,V=Math.max(1,Math.floor(D.length/X)),ne=new Float32Array(X);for(let me=0;me<X;me++){let oe=0,N=0;const h=me*V,E=Math.min(D.length,h+V);for(let y=h;y<E;y++)oe+=Math.abs(D[y]),N++;ne[me]=N?oe/N:0}ee.current=ne,U(!0)}catch{const g=new Float32Array(120);for(let l=0;l<120;l++)g[l]=(Math.sin(l/5)+1)/2;ee.current=g,U(!0)}})(),()=>{c.removeEventListener("loadedmetadata",d),c.removeEventListener("timeupdate",k),c.removeEventListener("ended",_)}},[W]),t.useEffect(()=>{if(!(W&&W.type==="AUDIO")||!Q)return;const a=ae.current,b=ee.current;if(!a||!b)return;const c=a.getContext("2d");if(!c)return;const p=a.width,d=a.height;c.clearRect(0,0,p,d);const k=b.length,_=2,O=Math.max(1,Math.floor((p-(k-1)*_)/k)),I=c.createLinearGradient(0,0,p,0);I.addColorStop(0,"#525252"),I.addColorStop(.5,"#d946ef"),I.addColorStop(1,"#404040");for(let g=0;g<k;g++){const l=Math.min(1,Math.max(0,b[g])),i=Math.max(2,Math.floor(l*d)),z=g*(O+_),D=Math.floor((d-i)/2);c.fillStyle=I,c.fillRect(z,D,O,i)}if(pe>0){const g=Math.floor(p*pe);c.fillStyle="#ffffff88",c.fillRect(g,0,2,d)}},[W,pe,Q]);const w=u=>u<1024?u+" B":u<1024*1024?(u/1024).toFixed(2)+" KB":(u/(1024*1024)).toFixed(2)+" MB";if(W){if(W.images&&!W.type){const c=W;return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ms*.5625},children:T[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:p=>p.preventDefault(),src:v(T[0].url),alt:c.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:p=>{p.preventDefault(),p.stopPropagation(),p.nativeEvent&&typeof p.nativeEvent.stopImmediatePropagation=="function"&&p.nativeEvent.stopImmediatePropagation(),$(0)},onClick:p=>{p.preventDefault(),p.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:c.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:T.slice(1).map((p,d)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:k=>k.preventDefault(),src:v(p.url),alt:p.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:k=>{k.preventDefault(),k.stopPropagation(),k.nativeEvent&&typeof k.nativeEvent.stopImmediatePropagation=="function"&&k.nativeEvent.stopImmediatePropagation(),$(d+1)},onClick:k=>{k.preventDefault(),k.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},p.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const a=W,b=v(a.url);if(a.type==="IMAGE"&&K)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:b,alt:a.name,className:"w-full object-cover",style:{width:Ms,height:K.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="VIDEO"&&Ue)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${R?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:c=>{c.stopPropagation(),x()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:R?"pause":"play_arrow"})})}),e.jsx("video",{ref:f,src:b,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ms,height:Ue.height},onEnded:()=>L(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const c=se.current;c&&(je?(c.pause(),ie(!1)):(c.play(),ie(!0)))},className:"nodrag w-8 h-8 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:je?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const c=xe;if(!c||!isFinite(c))return"0:00";const p=Math.floor(c/60),d=Math.floor(c%60);return`${p}:${d.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:ae,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:se,src:b,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(a.type==="DOCUMENT"){const c=k=>k.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:k.includes("word")?{icon:"description",color:"text-blue-400"}:k.includes("excel")||k.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:p,color:d}=c(a.mimeType);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${d} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:p}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:a.originalName,children:a.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:w(a.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},wo=t.memo(bo),fr={};function Ts(s){const{project:j,episode:n,nodeGroup:W,assetType:ye,preview:T=!0}=s;if(!W||!W.scene||!W.shot)return null;const fe=`${W.id}-${ye}`;fr[fe]||(fr[fe]=0);let Z;T?Z=fr[fe]+1:(fr[fe]++,Z=fr[fe]);let re=j.name;if(j.type==="DRAMA"&&n){const K=`S${String(n.episodeNumber).padStart(3,"0")}`;re+=`_${K}`}return re+=`_Sc${W.scene}_Sh${W.shot}`,re+=`_${Z}`,re}function Ws(s,j){return j.find(n=>n.nodeIds.includes(s))||null}const yo=({data:s,id:j})=>{var c,p;const{setNodes:n,setEdges:W,getNodes:ye}=Zt(),T=Er(d=>d.refreshUser),fe=Sr(),Z=!!((c=s==null?void 0:s.workflowContext)!=null&&c.episode)||fe.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var k,_,O;if(Z)try{const I=(s==null?void 0:s.workflowContext)||{},g=I.episode,l=new URLSearchParams(window.location.search),i=Number(l.get("shot"))||1,z=fe.pathname.split("/").filter(Boolean),D=z.indexOf("projects"),X=z.indexOf("episodes"),V=((k=I.project)==null?void 0:k.id)||(g==null?void 0:g.projectId)||(D>=0?z[D+1]:void 0),ne=(g==null?void 0:g.id)||(X>=0?z[X+1]:void 0);if(!V||!ne)return;const me=await _e.episodes.getById(V,ne),oe=(me==null?void 0:me.data)??me,N=(oe==null?void 0:oe.data)??oe,E=(Array.isArray((_=N==null?void 0:N.scriptJson)==null?void 0:_.acts)?N.scriptJson.acts:[]).find(B=>B.actIndex===1),y=(O=E==null?void 0:E.shots)==null?void 0:O.find(B=>Number(B.shotIndex)===i),ge=(Array.isArray(y==null?void 0:y.mediaList)?y.mediaList:[]).some(B=>(B==null?void 0:B.nodeId)===j);n(B=>B.map(he=>he.id===j?{...he,data:{...he.data,addedToStoryboard:ge}}:he))}catch{}})()},[j,Z,fe.pathname]);const[re,K]=t.useState(!1),[de,Ue]=t.useState([]),[ce,se]=t.useState(""),[ae,je]=t.useState("ALL"),[ie,xe]=t.useState(""),[ue,pe]=t.useState(!1),Ie=s.width||400,[ee,Q]=t.useState(null);t.useEffect(()=>{re&&(w(),setTimeout(()=>{u()},100))},[re]);const U=t.useRef(null),R=t.useRef(!1);t.useEffect(()=>{const d=s.pendingButtonAction;if(d){try{const O=localStorage.getItem("suppressedPreviewTasks")||"[]",I=JSON.parse(O),g=localStorage.getItem("createdPreviewTasks")||"[]",l=JSON.parse(g),i=I.some(V=>V.taskId&&V.taskId===d.newTaskId||V.sourceNodeId&&V.sourceNodeId===d.sourceNodeId),D=ye().some(V=>{var ne,me,oe,N;return V.type==="imagePreview"&&((me=(ne=V.data)==null?void 0:ne.midjourneyData)==null?void 0:me.sourceNodeId)===d.sourceNodeId&&((N=(oe=V.data)==null?void 0:oe.midjourneyData)==null?void 0:N.taskId)===d.newTaskId}),X=l.some(V=>V.taskId&&V.taskId===d.newTaskId);if(i||X&&D){Q(null),n(V=>V.map(ne=>ne.id===d.sourceNodeId?{...ne,data:{...ne.data,pendingButtonAction:void 0}}:ne));return}}catch{}if(R.current)return;if(R.current=!0,ye().some(O=>{var I,g,l,i;return O.type==="imagePreview"&&((g=(I=O.data)==null?void 0:I.midjourneyData)==null?void 0:g.sourceNodeId)===d.sourceNodeId&&((i=(l=O.data)==null?void 0:l.midjourneyData)==null?void 0:i.taskId)===d.newTaskId})){Q(null),n(O=>O.map(I=>I.id===d.sourceNodeId?{...I,data:{...I.data,pendingButtonAction:void 0}}:I)),R.current=!1;return}Q(d.buttonCustomId),L(d.newTaskId,d.buttonLabel,d.sourceNodeId)}return()=>{R.current=!1,U.current&&(clearTimeout(U.current),U.current=null)}},[]);const L=async(d,k,_)=>{const O=_||j;let I=0;const g=150,l=2e3;R.current=!0;const i=/^[UV]\d$/.test(k)||k.includes("Vary")||k.includes("Upscale")&&k!=="Upscale"||k.includes("Zoom")||k.includes("Pan")||k.includes("Make")||k.includes("Remaster"),z=async()=>{var D,X,V,ne,me,oe,N,h;if(R.current)try{const E=await _e.midjourney.fetchTask(d);if(!R.current)return;const y=E.task;if(y.status==="SUCCESS"){if(i&&s.imageUrl&&((D=s.midjourneyData)!=null&&D.messageId)){const gt=y.imageUrl===s.imageUrl,vt=((X=y.properties)==null?void 0:X.messageId)===((V=s.midjourneyData)==null?void 0:V.messageId);if(gt&&vt){I++;try{const it=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(it).some(Be=>{var wt;return Be.taskId&&Be.taskId===d||Be.messageId&&Be.messageId===((wt=y.properties)==null?void 0:wt.messageId)})){Q(null),n(Be=>Be.map(wt=>wt.id===O?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}I<g?U.current=setTimeout(z,l):(m.error(`${k} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),Q(null),n(it=>it.map(Ye=>Ye.id===O?{...Ye,data:{...Ye.data,pendingButtonAction:void 0}}:Ye)));return}}if(m.success(`${k} å®Œæˆï¼`),Q(null),n(gt=>gt.map(vt=>vt.id===O?{...vt,data:{...vt.data,pendingButtonAction:void 0}}:vt)),ye().find(gt=>{var vt,it,Ye,yt,Be;return gt.type==="imagePreview"&&((vt=gt.data.midjourneyData)==null?void 0:vt.sourceNodeId)===O&&(((it=gt.data.midjourneyData)==null?void 0:it.taskId)===d||((Ye=y.properties)==null?void 0:Ye.messageId)&&((yt=gt.data.midjourneyData)==null?void 0:yt.messageId)===((Be=y.properties)==null?void 0:Be.messageId))})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const B=ye().find(gt=>gt.id===O);if(!B)return;if(!y.imageUrl){m.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const he=200,Se=100,Ne=s.width||400,Ce=((gt,vt=300)=>{if(!gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(gt))return vt;const[it,Ye]=gt.split(":").map(yt=>parseFloat(yt));return!it||!Ye?vt:Math.round(Ne*(Ye/it))})(s.ratio,300),Ae=document.querySelector(`.react-flow__node[data-id="${B.id}"]`),$e=Math.round((Ae==null?void 0:Ae.getBoundingClientRect().width)||((ne=B.data)==null?void 0:ne.width)||400),le=ye().filter(gt=>{var vt,it;return gt.type==="imagePreview"&&((it=(vt=gt.data)==null?void 0:vt.midjourneyData)==null?void 0:it.sourceNodeId)===O}),Ge=B.position.x+$e+he,Qe=B.position.y,Wt=Ge,Ct=Qe+le.length*(Ce+Se),_t=`preview-${Date.now()}`,ct={id:_t,type:"imagePreview",position:{x:Wt,y:Ct},data:{imageUrl:y.imageUrl,width:Ne,height:Ce,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(me=B.data)==null?void 0:me.createdBy,midjourneyData:{taskId:d,messageId:(oe=y.properties)==null?void 0:oe.messageId,messageHash:(N=y.properties)==null?void 0:N.messageHash,sourceNodeId:O,buttons:y.buttons,action:y.action}}};n(gt=>[...gt,ct]),W(gt=>{const vt={id:`${O}-${_t}`,source:O,target:_t,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...gt,vt]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const vt=ye().find(it=>it.id===_t)})});try{const gt=localStorage.getItem("createdPreviewTasks")||"[]",it=[...JSON.parse(gt),{taskId:d,messageId:(h=y.properties)==null?void 0:h.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(it))}catch{}m.success(`å·²åˆ›å»º${k}é¢„è§ˆèŠ‚ç‚¹`);return}if(y.status==="FAILURE"){m.error(`${k} å¤±è´¥: ${y.failReason||"æœªçŸ¥é”™è¯¯"}`),Q(null),n(J=>J.map(ge=>ge.id===O?{...ge,data:{...ge.data,pendingButtonAction:void 0}}:ge));return}if(y.status==="NOT_FOUND"){if(ye().some(B=>{var he,Se,Ne,Re;return B.type==="imagePreview"&&((Se=(he=B.data)==null?void 0:he.midjourneyData)==null?void 0:Se.sourceNodeId)===O&&((Re=(Ne=B.data)==null?void 0:Ne.midjourneyData)==null?void 0:Re.taskId)===d})){Q(null),n(B=>B.map(he=>he.id===O?{...he,data:{...he.data,pendingButtonAction:void 0}}:he));return}m.error(`${k} ä»»åŠ¡ä¸å­˜åœ¨`),Q(null),n(B=>B.map(he=>he.id===O?{...he,data:{...he.data,pendingButtonAction:void 0}}:he));return}I++,I<g?U.current=setTimeout(z,l):(m.error(`${k} è¶…æ—¶`),Q(null),n(J=>J.map(ge=>ge.id===j?{...ge,data:{...ge.data,pendingButtonAction:void 0}}:ge)))}catch(E){m.error(`${k} å¤±è´¥: ${E.message}`),Q(null),n(y=>y.map(J=>J.id===j?{...J,data:{...J.data,pendingButtonAction:void 0}}:J))}};z()},f=()=>{try{const d=localStorage.getItem("midjourneyButtonConfig");if(d)return JSON.parse(d)}catch{}return{}},x=d=>{const k=f();if(Object.keys(k).length===0)return!0;const _=d.label.replace(/\s+/g,"_");return k.hasOwnProperty(_)?k[_]===!0:!0},A=d=>{if(!d)return"";let k=d.trim();return/^upscale_\d+\s/i.test(k)&&(k=k.replace(/^upscale_\d+\s+/i,"")),k},F=(((p=s.midjourneyData)==null?void 0:p.buttons)||[]).map(d=>String(d.label||"").toLowerCase()),G=F.some(d=>/^[uv][1-4]$/i.test(d)),v=F.some(d=>d.includes("redo")),$=!G&&!v&&F.some(d=>d.includes("upscale")),r=d=>{const k=String(d.label||""),_=k.toLowerCase(),O=String(d.customId||"").toLowerCase(),I=/ğŸ‘|â¤ï¸|â¤/.test(k);return _.includes("animate")||_.includes("web")||O.includes("web")||_.includes("browser")||_.includes("open in web")||_.includes("open web")||_.includes("like")||O.includes("like")||I?!1:G?/^U[1-4]$/i.test(k):$?_.includes("upscale"):!1};t.useEffect(()=>{re&&(w(),u())},[re]);const w=async()=>{try{const d=ae==="ALL"?void 0:{category:ae},_=(await _e.assetLibraries.getAll(d)).data||[];if(Ue(_),_.length>0){const O=_.find(I=>I.id===ce);se(O?O.id:_[0].id)}else se("")}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},u=()=>{const d=window.__workflowContext;if(!d||!d.project||!d.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const k=Ws(j,d.nodeGroups);if(!k&&d.nodeGroups.length>0){const O=d.nodeGroups[0],I=Ts({project:d.project,episode:d.episode,nodeGroup:O,assetType:"image"});I?(xe(I),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${I}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const _=Ts({project:d.project,episode:d.episode,nodeGroup:k,assetType:"image"});_?(xe(_),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${_}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},a=async()=>{var d,k;if(!ce){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ie.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{pe(!0),await _e.assetLibraries.addFromUrl(ce,s.imageUrl,ie.trim());const _=window.__workflowContext;if(_&&_.project&&_.nodeGroups){const O=Ws(j,_.nodeGroups)||_.nodeGroups[0];O&&Ts({project:_.project,episode:_.episode,nodeGroup:O,nodeId:j,assetType:"image",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),K(!1),xe("");try{n(O=>O.map(I=>I.id===j?{...I,data:{...I.data,addedToLibrary:!0}}:I))}catch{}try{const O=new CustomEvent("asset-library-updated",{detail:{libraryId:ce}});window.dispatchEvent(O)}catch{}}catch(_){m.error(((k=(d=_.response)==null?void 0:d.data)==null?void 0:k.message)||"æ·»åŠ å¤±è´¥")}finally{pe(!1)}},b=async()=>{var d;try{const k=s.imageUrl;let _=`image-${Date.now()}.jpg`;const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const z=Ws(j,O.nodeGroups)||O.nodeGroups[0];if(z){const D=Ts({project:O.project,episode:O.episode,nodeGroup:z,nodeId:j,assetType:"image",preview:!0});if(D&&(_=D,!_.includes("."))){const X=((d=k.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:d[0])||".jpg";_+=X}}}m.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const I=await fetch(k);if(!I.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${I.status}`);const g=await I.blob(),l=window.URL.createObjectURL(g),i=document.createElement("a");i.href=l,i.download=_,document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>{window.URL.revokeObjectURL(l)},100),m.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${_}`)}catch(k){m.error(`æ“ä½œå¤±è´¥: ${k instanceof Error?k.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const k=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(_=>x(_)&&r(_)):[]).length>0;return e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ie,borderRadius:k?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[Z&&e.jsxs("button",{onClick:async()=>{var _,O;try{const I=s.imageUrl,g=s.workflowContext||{},l=g.episode,i=new URLSearchParams(window.location.search),z=Number(i.get("shot"))||1,D=fe.pathname.split("/").filter(Boolean),X=D.indexOf("projects"),V=D.indexOf("episodes"),ne=((_=g.project)==null?void 0:_.id)||(l==null?void 0:l.projectId)||(X>=0?D[X+1]:void 0),me=(l==null?void 0:l.id)||(V>=0?D[V+1]:void 0);if(!ne||!me){m.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const oe=await _e.episodes.getById(ne,me),N=(oe==null?void 0:oe.data)??oe,h=(N==null?void 0:N.data)??N;let E=Array.isArray((O=h==null?void 0:h.scriptJson)==null?void 0:O.acts)?[...h.scriptJson.acts]:[],y=E.find(he=>he.actIndex===1);y||(y={actIndex:1,shots:[]},E.push(y)),y.shots=Array.isArray(y.shots)?[...y.shots]:[];let J=y.shots.find(he=>Number(he.shotIndex)===z);J||(J={shotIndex:z,mediaList:[]},y.shots.push(J));const ge=Array.isArray(J.mediaList)?J.mediaList.slice():[];ge.push({type:"image",url:I,nodeId:j,duration:5}),J.mediaList=ge;const B={...h.scriptJson||{},acts:E};await _e.episodes.update(ne,me,{scriptJson:B});try{n(he=>he.map(Se=>Se.id===j?{...Se,data:{...Se.data,addedToStoryboard:!0}}:Se))}catch{}m.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(I){m.error((I==null?void 0:I.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{K(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:b,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const d=(s.midjourneyData.buttons||[]).filter(k=>x(k)&&r(k));return d.length===0?null:e.jsxs("div",{className:"nodrag bg-white dark:bg-[#18181b] backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ie},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.map((k,_)=>{var z;const O=A(k.label),I=((z=s.clickedButtons)==null?void 0:z.includes(k.label))||!1,g=ee===k.customId,l=s._canEdit===!1,i=ee!==null&&ee!==k.customId||I||l;return e.jsx("button",{onClick:async()=>{var D,X,V,ne,me,oe;if(!((D=s.midjourneyData)!=null&&D.taskId)){m.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(I){m.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}Q(k.customId);try{m.info(`æ­£åœ¨æ‰§è¡Œ ${k.label}...`);const N=await _e.midjourney.action({taskId:s.midjourneyData.taskId,customId:k.customId,messageId:s.midjourneyData.messageId,nodeId:j,mode:s.midjourneyData.mode||"relax"});if(!N.success){m.error(N.description||"æ“ä½œå¤±è´¥"),Q(null);return}const h=N.taskId;if(N.creditsCharged&&N.creditsCharged>0&&T(),!h){m.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),Q(null);return}n(E=>E.map(y=>y.id===j?{...y,data:{...y.data,pendingButtonAction:{buttonLabel:k.label,buttonCustomId:k.customId,newTaskId:h,sourceNodeId:j},clickedButtons:[...y.data.clickedButtons||[],k.label]}}:y)),m.info(`${O} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),L(h,O)}catch(N){if(((X=N.response)==null?void 0:X.status)===429)m.warning(((ne=(V=N.response)==null?void 0:V.data)==null?void 0:ne.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const h=((oe=(me=N.response)==null?void 0:me.data)==null?void 0:oe.error)||N.message;m.error(h)}Q(null)}},disabled:i,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${I?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":g?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-wait text-white border-transparent shadow-md":ee!==null?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:I?`${O} (å·²ç‚¹å‡»)`:O,children:e.jsxs("span",{className:"flex items-center gap-1",children:[g&&e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),k.emoji&&!/^upscale_\d+$/i.test(k.emoji)&&e.jsx("span",{children:k.emoji}),O,I&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},_)})})]})})(),re&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>K(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ie,onChange:d=>xe(d.target.value),onMouseDown:d=>d.stopPropagation(),onTouchStart:d=>d.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const d=ae==="ALL"?de:de.filter(k=>(k.category||"OTHER")===ae);return d.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:ae==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:ce,onChange:k=>se(k.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:d.map(k=>e.jsxs("option",{value:k.id,children:[k.name," (",k._count.assets," ä¸ªèµ„äº§)"]},k.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(d=>e.jsx("button",{type:"button",onClick:()=>{je(d);const k=de.filter(_=>(_.category||"OTHER")===d);se(k.length>0?k[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${ae===d?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:d==="ROLE"?"person":d==="SCENE"?"landscape":d==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:d==="ROLE"?"è§’è‰²åº“":d==="SCENE"?"åœºæ™¯åº“":d==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},d))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>K(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:a,disabled:ue||de.length===0||!ie.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:ue?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ko=t.memo(yo),vo=({data:s,id:j})=>{var F;const n="https://api.waule.ai",[W,ye]=t.useState(!1),[T,fe]=t.useState([]),[Z,re]=t.useState(""),[K,de]=t.useState("ALL"),[Ue,ce]=t.useState(""),[se,ae]=t.useState(!1),{setNodes:je}=Zt(),[ie]=t.useState(s.width||400),[xe,ue]=t.useState(null),[pe,Ie]=t.useState(!1),ee=t.useRef(null),Q=Sr(),U=!!((F=s==null?void 0:s.workflowContext)!=null&&F.episode)||Q.pathname.includes("/episodes/");t.useEffect(()=>{W&&(L(),setTimeout(()=>{f()},100))},[W]),t.useEffect(()=>{const G=ee.current;if(!G)return;const v=()=>{const u=G.videoWidth||0,a=G.videoHeight||0;if(u>0&&a>0){const b=u/a;ue(Math.round(ie/b))}},$=()=>Ie(!0),r=()=>Ie(!1),w=()=>Ie(!1);return G.addEventListener("loadedmetadata",v),G.addEventListener("play",$),G.addEventListener("pause",r),G.addEventListener("ended",w),()=>{G.removeEventListener("loadedmetadata",v),G.removeEventListener("play",$),G.removeEventListener("pause",r),G.removeEventListener("ended",w)}},[ie,s.videoUrl]);const R=G=>{G.stopPropagation();const v=ee.current;v&&(v.paused?v.play():v.pause())};t.useEffect(()=>{try{const G=localStorage.getItem("suppressedPreviewTasks")||"[]",v=JSON.parse(G),$=s==null?void 0:s.pendingButtonAction;if($&&v.some(w=>w.taskId&&w.taskId===$.newTaskId||w.sourceNodeId&&w.sourceNodeId===$.sourceNodeId)){ye(!1);return}}catch{}},[]);const L=async()=>{try{const G=await _e.assetLibraries.getAll();fe(G.data),G.data.length>0&&re(G.data[0].id)}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},f=()=>{const G=window.__workflowContext;if(!G||!G.project||!G.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const v=Ws(j,G.nodeGroups);if(!v&&G.nodeGroups.length>0){const r=G.nodeGroups[0],w=Ts({project:G.project,episode:G.episode,nodeGroup:r,assetType:"video"});w?(ce(w),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${w}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const $=Ts({project:G.project,episode:G.episode,nodeGroup:v,assetType:"video"});$?(ce($),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${$}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},x=async()=>{var G,v;if(!Z){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Ue.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ae(!0),await _e.assetLibraries.addFromUrl(Z,s.videoUrl,Ue.trim());const $=window.__workflowContext;if($&&$.project&&$.nodeGroups){const r=Ws(j,$.nodeGroups)||$.nodeGroups[0];r&&Ts({project:$.project,episode:$.episode,nodeGroup:r,nodeId:j,assetType:"video",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ye(!1),ce("");try{je(r=>r.map(w=>w.id===j?{...w,data:{...w.data,addedToLibrary:!0}}:w))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:Z}});window.dispatchEvent(r)}catch{}}catch($){m.error(((v=(G=$.response)==null?void 0:G.data)==null?void 0:v.message)||"æ·»åŠ å¤±è´¥")}finally{ae(!1)}},A=async()=>{var G;try{const v=s.videoUrl;let $=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const c=Ws(j,r.nodeGroups)||r.nodeGroups[0];if(c){const p=Ts({project:r.project,episode:r.episode,nodeGroup:c,nodeId:j,assetType:"video",preview:!0});if(p&&($=p,!$.includes("."))){const d=((G=v.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:G[0])||".mp4";$+=d}}}m.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");const w=await fetch(v);if(!w.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${w.status}`);const u=await w.blob(),a=window.URL.createObjectURL(u),b=document.createElement("a");b.href=a,b.download=$,document.body.appendChild(b),b.click(),document.body.removeChild(b),setTimeout(()=>{window.URL.revokeObjectURL(a)},100),m.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${$}`)}catch(v){m.error(`æ“ä½œå¤±è´¥: ${v instanceof Error?v.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ie},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 flex items-center justify-center pointer-events-none",children:e.jsx("button",{className:`nodrag pointer-events-auto w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${pe?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:R,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:pe?"pause":"play_arrow"})})}),e.jsx("video",{ref:ee,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${n}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:xe?`${xe}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[U&&e.jsxs("button",{onClick:async()=>{var G,v;try{const $=s.videoUrl,r=s.workflowContext||{},w=r.episode,u=(()=>{try{const X=new URLSearchParams(window.location.search);return{scene:Number(X.get("scene")),shot:Number(X.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),a=r.nodeGroup||Ws(j,r.nodeGroups||[]),b=(a==null?void 0:a.scene)??u.scene,c=(a==null?void 0:a.shot)??u.shot,p=(()=>{try{const X=Q.pathname.split("/").filter(Boolean),V=X.indexOf("projects"),ne=X.indexOf("episodes"),me=V>=0?X[V+1]:void 0,oe=ne>=0?X[ne+1]:void 0;return{pid:me,eid:oe}}catch{return{pid:void 0,eid:void 0}}})(),d=((G=r.project)==null?void 0:G.id)||(w==null?void 0:w.projectId)||p.pid,k=(w==null?void 0:w.id)||p.eid;if(!d||!k||!b||!c){m.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const _=await _e.episodes.getById(d,k),O=(_==null?void 0:_.data)??_,I=(O==null?void 0:O.data)??O,g=Array.isArray((v=I==null?void 0:I.scriptJson)==null?void 0:v.acts)?[...I.scriptJson.acts]:[];let l=g.find(X=>Number(X.actIndex)===Number(b));l||(l={actIndex:Number(b),shots:[]},g.push(l)),l.shots=Array.isArray(l.shots)?[...l.shots]:[];let i=l.shots.find(X=>Number(X.shotIndex)===Number(c));i||(i={shotIndex:Number(c),mediaList:[]},l.shots.push(i));const z=Array.isArray(i.mediaList)?i.mediaList.slice():[];if(z.length>=4){m.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}z.push({type:"video",url:$,nodeId:j}),i.mediaList=z;const D={...I.scriptJson||{},acts:g};await _e.episodes.update(d,k,{scriptJson:D});try{je(X=>X.map(V=>V.id===j?{...V,data:{...V.data,addedToStoryboard:!0}}:V))}catch{}m.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch($){m.error(($==null?void 0:$.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{ye(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:A,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),W&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:G=>G.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ye(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Ue,onChange:G=>ce(G.target.value),onMouseDown:G=>G.stopPropagation(),onTouchStart:G=>G.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const G=K==="ALL"?T:T.filter(v=>(v.category||"OTHER")===K);return G.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:K==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Z,onChange:v=>re(v.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:G.map(v=>e.jsxs("option",{value:v.id,children:[v.name," (",v._count.assets," ä¸ªèµ„äº§)"]},v.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(G=>e.jsx("button",{type:"button",onClick:()=>{de(G);const v=T.filter($=>($.category||"OTHER")===G);re(v.length>0?v[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${K===G?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:G==="ROLE"?"person":G==="SCENE"?"landscape":G==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:G==="ROLE"?"è§’è‰²åº“":G==="SCENE"?"åœºæ™¯åº“":G==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},G))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ye(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:x,disabled:se||T.length===0||!Ue.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:se?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`})]})},No=t.memo(vo),jo=({data:s,id:j,selected:n})=>{const{getNodes:W,getEdges:ye,setEdges:T,setNodes:fe,getNode:Z}=Zt(),[re,K]=t.useState(s.content||""),de=t.useRef(null),Ue=t.useRef(null),ce=t.useRef(null),se=t.useRef(null);t.useEffect(()=>{const R=A=>{A.stopPropagation()},L=Ue.current,f=ce.current;L&&L.addEventListener("wheel",R,{passive:!0}),f&&f.addEventListener("wheel",R,{passive:!0});const x=se.current;return x&&x.addEventListener("wheel",R,{passive:!0}),()=>{L&&L.removeEventListener("wheel",R),f&&f.removeEventListener("wheel",R),x&&x.removeEventListener("wheel",R)}},[]);const ae=t.useRef(null),je=async R=>{var L,f;try{const x=(s==null?void 0:s.workflowContext)||{},A=x.episode,F=x.nodeGroup||Array.isArray(x.nodeGroups)&&x.nodeGroups.find(k=>(k.nodeIds||[]).includes(j))||null;let G=F==null?void 0:F.scene,v=F==null?void 0:F.shot;try{const k=new URLSearchParams(window.location.search),_=Number(k.get("scene")),O=Number(k.get("shot"));Number.isFinite(_)&&_>0&&(G=G??_),Number.isFinite(O)&&O>0&&(v=v??O)}catch{}const $=((L=x.project)==null?void 0:L.id)||(A==null?void 0:A.projectId),r=A==null?void 0:A.id;if(!$||!r||!G||!v)return;const w=await _e.episodes.getById($,r),u=(w==null?void 0:w.data)??w,a=(u==null?void 0:u.data)??u,b=Array.isArray((f=a==null?void 0:a.scriptJson)==null?void 0:f.acts)?[...a.scriptJson.acts]:[];let c=b.find(k=>Number(k.actIndex)===Number(G));c||(c={actIndex:Number(G),shots:[]},b.push(c)),c.shots=Array.isArray(c.shots)?[...c.shots]:[];let p=c.shots.find(k=>Number(k.shotIndex)===Number(v));p||(p={shotIndex:Number(v)},c.shots.push(p)),Object.keys(R).forEach(k=>{p[k]=R[k]||""});const d={...a.scriptJson||{},acts:b};await _e.episodes.update($,r,{scriptJson:d})}catch(x){m.error((x==null?void 0:x.message)||"ä¿å­˜å¤±è´¥")}},ie=()=>{var R,L,f;try{const x=W(),A=ye(),F=x.find(u=>u.id===j),G=A.filter(u=>u.source===j).map(u=>u.target),v=x.filter(u=>u.type==="agent");let $="";const r=v.find(u=>G.includes(u.id));if(r)$=r.id;else if(F&&v.length>0)$=((L=(R=v.map(a=>{var b,c,p,d;return{a,dx:(((b=a.position)==null?void 0:b.x)??0)-(((c=F.position)==null?void 0:c.x)??0),dy:Math.abs((((p=a.position)==null?void 0:p.y)??0)-(((d=F.position)==null?void 0:d.y)??0))}}).sort((a,b)=>(a.dx>=0&&b.dx>=0,a.dx-b.dx||a.dy-b.dy))[0])==null?void 0:R.a)==null?void 0:L.id)||v[0].id;else{const u=x.findIndex(a=>a.id===j);$=((f=x[u+1])==null?void 0:f.id)||""}if(!$)return;T(u=>u.some(b=>b.source===j&&b.target===$)?u:[...u,{id:`e-${Date.now()}`,source:j,target:$}]);const w=re||String((s==null?void 0:s.content)||"");fe(u=>u.map(a=>{if(a.id!==$)return a;const b=a.data||{};return a.type==="agent"?{...a,data:{...b,config:{...b.config||{},prompt:w}}}:a.type==="midjourney"?{...a,data:{...b,prompt:w}}:a.type==="aiImage"?{...a,data:{...b,config:{...b.config||{},prompt:w}}}:a.type==="textPreview"?{...a,data:{...b,content:w}}:{...a,data:{...b,config:{...b.config||{},prompt:w}}}}))}catch{}},xe=(s.title||"")==="åˆ†é•œè®¾è®¡",ue=(s.title||"")==="æç¤ºè¯",pe=(()=>{if(!xe)return[];const R=String(s.content||""),L=R.split(/\r?\n/).map(v=>v.trim()),f=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),x=[];let A=null;for(const v of L){if(!v)continue;const $=v.match(/^(.+?)[ï¼š:]\s*(.*)$/);if($&&f.has($[1])){A&&x.push(A),A={label:$[1],content:$[2]||""};continue}if(f.has(v)){A&&x.push(A),A={label:v,content:""};continue}A?A.content=A.content?`${A.content}
${v}`:v:A={label:"æ–‡æœ¬",content:v}}if(A&&x.push(A),x.length===0)return[{label:"æ–‡æœ¬",content:R}];const F=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],G=new Map(F.map((v,$)=>[v,$]));return x.filter(v=>v.content&&v.content.trim().length>0).sort((v,$)=>(G.get(v.label)??999)-(G.get($.label)??999))})(),[Ie,ee]=t.useState(pe),Q=t.useRef(null),U=t.useRef([]);return t.useEffect(()=>{ee(pe)},[s.content,xe]),t.useEffect(()=>{requestAnimationFrame(()=>{U.current.forEach(R=>{R&&(R.style.height="auto",R.style.height=`${R.scrollHeight}px`)})})},[Ie]),t.useEffect(()=>{ue&&K(s.content||"")},[s.content,ue]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:xe?e.jsx("div",{ref:ce,className:"space-y-2 nowheel",children:Ie.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ie.map((R,L)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:R.label}),e.jsx("textarea",{value:R.content,onChange:f=>{const x=f.target.value;f.target.style.height="auto",f.target.style.height=`${f.target.scrollHeight}px`,ee(A=>{const F=A.map(($,r)=>r===L?{...$,content:x}:$),G=F.map($=>`${$.label}ï¼š${$.content}`).join(`
`);return Z(j)&&fe($=>$.map(r=>r.id===j?{...r,data:{...r.data,content:G}}:r)),Q.current&&(clearTimeout(Q.current),Q.current=null),Q.current=window.setTimeout(async()=>{const $=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};F.forEach(w=>{$.has(w.label)&&(r[w.label]=w.content)}),await je(r)},600),F})},onBlur:async f=>{const x=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),A={};A[R.label]=f.currentTarget.value,x.has(R.label)&&await je(A)},onMouseDown:f=>f.stopPropagation(),onTouchStart:f=>f.stopPropagation(),ref:f=>{U.current[L]=f,f&&(f.style.height="auto",f.style.height=`${f.scrollHeight}px`,f.style.overflow="hidden",f.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",placeholder:`å¡«å†™${R.label}...`})]},`sec-${L}`))}):ue?e.jsxs("div",{ref:Ue,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:re,onChange:R=>{const L=R.target.value;K(L);const f=440;R.target.style.height="auto";const x=Math.min(R.target.scrollHeight,f);R.target.style.height=`${x}px`,R.target.style.overflowY=R.target.scrollHeight>f?"auto":"hidden",Z(j)&&fe(F=>F.map(G=>G.id===j?{...G,data:{...G.data,content:L}}:G)),ae.current&&(clearTimeout(ae.current),ae.current=null),ae.current=window.setTimeout(async()=>{await je({æç¤ºè¯:L})},600)},onBlur:async R=>{const L=R.currentTarget.value;await je({æç¤ºè¯:L})},onMouseDown:R=>R.stopPropagation(),onTouchStart:R=>R.stopPropagation(),ref:R=>{if(de.current=R,R){R.style.wordBreak="break-word",R.style.height="auto";const f=Math.min(R.scrollHeight,440);R.style.height=`${f}px`,R.style.overflowY=R.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ie,onPointerDown:R=>R.stopPropagation(),onMouseDown:R=>R.stopPropagation(),disabled:!re.trim(),className:"nodrag relative w-full mt-2 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:se,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(St,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Io=t.memo(jo),So=({data:s,selected:j,id:n})=>{const{setNodes:W,setEdges:ye,getNode:T,getNodes:fe,getEdges:Z,getViewport:re}=Zt(),K=zs(),de=Ls(),[Ue]=t.useState(s.isExpanded??!0),[ce,se]=t.useState(s.prompt||""),[ae,je]=t.useState(s.ratio||"16:9"),[ie,xe]=t.useState(s.mode||"relax"),[ue,pe]=t.useState(s.chaos??0),[Ie,ee]=t.useState(s.stylize??100),[Q,U]=t.useState(s.weird??0),[R,L]=t.useState(s.quality??1),[f,x]=t.useState(s.styleRaw??!1),[A,F]=t.useState(s.omniWeight??100),[G,v]=t.useState(s.styleWeight??100),[,$]=t.useState(s.taskId||""),[r,w]=t.useState(s.status||"idle"),[u,a]=t.useState(s.progress||""),[b,c]=t.useState(s.omniReferenceImages||[]),[p,d]=t.useState(s.styleReferenceImages||[]),[k,_]=t.useState(!0);t.useEffect(()=>{(async()=>{var y;try{const J=await _e.midjourney.getSettings();_(((y=J.settings)==null?void 0:y.fastEnabled)??!0)}catch{}})()},[]);const{credits:O,isFreeUsage:I,freeUsageRemaining:g,refetch:l}=Ss({moduleType:"midjourney",operationType:"imagine",mode:ie}),i=t.useRef(null),z=t.useRef(!1),D=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==ce&&se(s.prompt)},[s.prompt]);const X=E=>{W(y=>y.map(J=>J.id===n?{...J,data:{...J.data,...E}}:J))};t.useEffect(()=>{const E=s.taskId,y=s.status;(async()=>{var ge,B;if(E&&(y==="processing"||y==="submitting"))try{const Se=(await _e.midjourney.fetchTask(E)).task;if(Se.status==="SUCCESS"){const Ne=Se.imageUrl||"",Re=((ge=Se.properties)==null?void 0:ge.messageId)||"",Ce=((B=Se.properties)==null?void 0:B.messageHash)||"",Ae=s.ratio||"16:9";if(w("idle"),a(""),X({status:"idle",progress:"",taskId:""}),fe().find(Ge=>{var Qe,Wt,Ct;return Ge.type==="imagePreview"&&((Qe=Ge.data.midjourneyData)==null?void 0:Qe.sourceNodeId)===n&&(((Wt=Ge.data.midjourneyData)==null?void 0:Wt.taskId)===E||Re&&((Ct=Ge.data.midjourneyData)==null?void 0:Ct.messageId)===Re)})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}m.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(Ne,"4å®«æ ¼",Ae,{taskId:E,messageId:Re,messageHash:Ce,mode:s.mode||"relax",buttons:Se.buttons,action:Se.action})}else Se.status==="IN_PROGRESS"||Se.status==="SUBMITTED"?(w("processing"),setTimeout(()=>{D.current(E)},100)):Se.status==="FAILURE"?(w("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error(Se.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Se.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Se.status==="NOT_FOUND"&&(w("idle"),a(""),X({status:"idle",progress:"",taskId:""}))}catch{w("idle"),a(""),X({status:"idle",progress:"",taskId:""}),m.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const V=t.useCallback(()=>{const E=K.filter(Ne=>Ne.target===n),y=[],J=[];let ge="";E.forEach(Ne=>{var Ce,Ae,$e,le,Ge,Qe,Wt,Ct;const Re=T(Ne.source);if(Re){const _t=Re.data,ct=Ne.targetHandle||"omni-ref";if(ct==="text-input"){if(Re.type==="agent"){const gt=((Ce=_t.config)==null?void 0:Ce.generatedText)||"";gt&&typeof gt=="string"&&(ge=gt)}}else{let gt=_t.imageUrl||"";if(!gt&&((Ae=_t.config)!=null&&Ae.selectedAsset)){const vt=_t.config.selectedAsset;vt.type==="IMAGE"&&(gt=`https://api.waule.ai${vt.url}`.replace(".oss-oss-",".oss-"))}if(!gt&&(($e=_t.config)!=null&&$e.generatedImageUrl)&&(gt=_t.config.generatedImageUrl),Re.type==="assetSelector"){const vt="https://api.waule.ai",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},Ye=(le=_t.config)==null?void 0:le.subjects,yt=(Ge=_t.config)==null?void 0:Ge.referenceImages;if(ct==="omni-ref"){let Be="";Ye&&Ye.length>0&&Ye[0].images&&Ye[0].images.length>0?Be=it(Ye[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Qe=_t.config)!=null&&Qe.selectedAsset&&_t.config.selectedAsset.type==="IMAGE"&&(Be=it(_t.config.selectedAsset.url)),Be&&!y.includes(Be)&&y.length<1&&y.push(Be)}else if(ct==="style-ref"){let Be="";Ye&&Ye.length>0&&Ye[0].images&&Ye[0].images.length>0?Be=it(Ye[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Wt=_t.config)!=null&&Wt.selectedAsset&&_t.config.selectedAsset.type==="IMAGE"&&(Be=it(_t.config.selectedAsset.url)),Be&&!J.includes(Be)&&J.length<1&&J.push(Be)}}if(Re.type==="upload"){const vt="https://api.waule.ai",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},yt=(((Ct=_t.config)==null?void 0:Ct.uploadedFiles)||[]).find(Be=>Be.type==="IMAGE"||(Be.mimeType||"").startsWith("image/"));if(yt){const Be=it(yt.url);ct==="omni-ref"?Be&&!y.includes(Be)&&y.length<1&&y.push(Be):ct==="style-ref"&&Be&&!J.includes(Be)&&J.length<1&&J.push(Be)}}gt&&(ct==="omni-ref"&&!y.includes(gt)?y.push(gt):ct==="style-ref"&&!J.includes(gt)&&J.push(gt))}}}),ge&&ge!==ce&&!z.current&&(se(ge),X({prompt:ge}));const B=Ne=>{if(!Ne||typeof Ne!="string")return!1;const Re=Ne.trim();return Re?!!(Re.startsWith("data:image/")||/^https?:\/\//.test(Re)||Re.startsWith("/")):!1},he=y.filter(B).slice(0,1),Se=J.filter(B).slice(0,1);JSON.stringify(he)!==JSON.stringify(b)&&(c(he),X({omniReferenceImages:he})),JSON.stringify(Se)!==JSON.stringify(p)&&(d(Se),X({styleReferenceImages:Se}))},[K,n,T,de,ce,z.current]);t.useEffect(()=>{V()},[V]),t.useEffect(()=>{const E=i.current;E&&Ue&&requestAnimationFrame(()=>{E.style.height="auto";const y=Math.max(60,Math.min(E.scrollHeight,600));E.style.height=`${y}px`})},[ce,Ue]);const ne=E=>{try{const y=new URL(E),J=new URLSearchParams(y.search);return J.has("width")||J.has("height")?(J.delete("width"),J.delete("height"),y.search=J.toString(),y.toString()):E}catch{return E}},me=E=>{const[J,ge]=E.split(":").map(Number);if(!J||!ge)return{width:512,height:512};const B=J/ge;return B>=1?{width:512,height:Math.round(512/B)}:{width:Math.round(512*B),height:512}},oe=t.useCallback((E,y,J,ge)=>{const B=T(n);if(!B)return;const he=y.startsWith("U")?ne(E):E,Se=fe(),Ne=Z();if(Se.filter(Be=>Be.type==="imagePreview"&&Ne.some(wt=>wt.source===n&&wt.target===Be.id)).find(Be=>Be.data.imageUrl===he))return;const Ae=400,$e=200,le=100,Ge=Be=>{const wt=re().zoom||1,Yt=document.querySelector(`.react-flow__node[data-id="${Be.id}"]`),vs=(Yt==null?void 0:Yt.getBoundingClientRect().width)||Be.data&&Be.data.width||400,Is=(Yt==null?void 0:Yt.getBoundingClientRect().height)||Be.data&&Be.data.height||300,Es=Math.round(vs/wt),Ns=Math.round(Is/wt);return{w:Es,h:Ns}},Qe=(Be,wt=300)=>{if(!Be||!/^[0-9]+\s*:\s*[0-9]+$/.test(Be))return wt;const[Yt,vs]=Be.split(":").map(Is=>parseFloat(Is));return!Yt||!vs?wt:Math.round(Ae*(vs/Yt))},Wt=Ge(B),Ct=Qe(J,300),_t=B.position.x+Wt.w+$e,ct=B.position.y,gt=fe().filter(Be=>{var wt,Yt;return Be.type==="imagePreview"&&((Yt=(wt=Be.data)==null?void 0:wt.midjourneyData)==null?void 0:Yt.sourceNodeId)===n}).length,vt=_t,it=ct+gt*(Ct+le),Ye=`preview-${Date.now()}`,yt={id:Ye,type:"imagePreview",position:{x:vt,y:it},data:{imageUrl:he,width:Ae,ratio:J,workflowContext:B.data.workflowContext,createdBy:B.data.createdBy,midjourneyData:ge?{taskId:ge.taskId,messageId:ge.messageId,messageHash:ge.messageHash,sourceNodeId:n,mode:ge.mode,buttons:ge.buttons,action:ge.action}:void 0}};W(Be=>[...Be,yt]),ye(Be=>[...Be,{id:`${n}-${Ye}`,source:n,target:Ye,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),m.success(`âœ¨ å·²åˆ›å»º${y}é¢„è§ˆèŠ‚ç‚¹`)},[n,T,fe,Z,W,ye,ne,me]),N=t.useCallback(async()=>{var E,y,J,ge,B,he,Se,Ne,Re,Ce,Ae,$e;if(!ce.trim()){m.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}w("submitting"),a(""),X({status:"submitting",progress:""});try{const le=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ge=ce.toLowerCase(),Qe=le.find(it=>Ge.includes(it));if(Qe){m.error(`æ£€æµ‹åˆ°å‚æ•° "${Qe}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),w("idle"),X({status:"idle",progress:"",taskId:""});return}w("submitting");let Wt=ce;try{m.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const it=await _e.translation.smartTranslate({text:ce});it.success&&(Wt=it.translatedText,it.needsTranslation&&m.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{m.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}m.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let Ct=Wt.trim();if(ae&&ae!=="1:1"&&!Ct.includes("--ar")&&(Ct+=` --ar ${ae}`),!Ct.includes("--v")&&!Ct.includes("--version")&&(Ct+=" --v 7.0"),ie==="fast"&&!Ct.includes("--fast")?Ct+=" --fast":ie==="relax"&&!Ct.includes("--relax")&&(Ct+=" --relax"),ue>0&&(Ct+=` --chaos ${ue}`),Ie!==100&&(Ct+=` --stylize ${Ie}`),Q>0&&(Ct+=` --weird ${Q}`),R!==1&&(Ct+=` --quality ${R}`),f&&(Ct+=" --style raw"),b.length>0){m.info(`æ­£åœ¨ä¸Šä¼  ${b.length} å¼ å‚è€ƒå›¾...`);const it=[];for(let Ye=0;Ye<b.length;Ye++){const yt=b[Ye];try{const Be=await _e.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{m.error(`å‚è€ƒå›¾ ${Ye+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),w("idle");return}}Ct+=` --oref ${it.join(" ")}`,A!==100&&(Ct+=` --ow ${A}`),m.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(p.length>0){m.info(`æ­£åœ¨ä¸Šä¼  ${p.length} å¼ é£æ ¼å›¾...`);const it=[];for(let Ye=0;Ye<p.length;Ye++){const yt=p[Ye];try{const Be=await _e.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{m.error(`é£æ ¼å›¾ ${Ye+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),w("idle");return}}Ct+=` --sref ${it.join(" ")}`,G!==100&&(Ct+=` --sw ${G}`),m.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const _t=await _e.midjourney.imagine({prompt:Ct,nodeId:n,mode:ie});if(!_t.success)throw new Error(_t.description||"ä»»åŠ¡æäº¤å¤±è´¥");const ct=_t.taskId;$(ct),w("processing"),X({taskId:ct,status:"processing",progress:"",prompt:ce,ratio:ae,mode:ie,chaos:ue,stylize:Ie,weird:Q,quality:R,styleRaw:f,omniWeight:A,styleWeight:G});const gt=_t.isFreeUsage,vt=_t.creditsCharged||0;if(gt)m.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${g} æ¬¡æœºä¼š`),l();else if(vt>0){const{useAuthStore:it}=await ds(async()=>{const{useAuthStore:yt}=await import("./index-Dg_hJ4va.js").then(Be=>Be.f);return{useAuthStore:yt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ye}=it.getState();await Ye(),m.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${vt} ç§¯åˆ†`),l()}else m.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");D.current(ct)}catch(le){if(w("error"),a(""),X({status:"error",progress:"",taskId:""}),((E=le.response)==null?void 0:E.status)===403){const Wt=((J=(y=le.response)==null?void 0:y.data)==null?void 0:J.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";m.error(Wt);return}if(((ge=le.response)==null?void 0:ge.status)===429){m.warning(((he=(B=le.response)==null?void 0:B.data)==null?void 0:he.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ge=((Ne=(Se=le.response)==null?void 0:Se.data)==null?void 0:Ne.description)||((Ce=(Re=le.response)==null?void 0:Re.data)==null?void 0:Ce.error)||le.message,Qe=($e=(Ae=le.response)==null?void 0:Ae.data)==null?void 0:$e.bannedWord;Qe?m.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${Qe}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):m.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ge}ï¼Œè¯·ç¨åé‡è¯•`)}},[ce,ae,ie,ue,Ie,Q,R,f,b,A,p,G,X,I,g,l]),h=t.useCallback(async E=>{let y=0;const J=150,ge=2e3,B=async()=>{var he,Se,Ne,Re;try{const Ae=(await _e.midjourney.fetchTask(E)).task;if(Ae.status==="SUCCESS"){const le=Ae.imageUrl||"",Ge=((he=Ae.properties)==null?void 0:he.messageId)||"",Qe=((Se=Ae.properties)==null?void 0:Se.messageHash)||"";if(w("idle"),a(""),X({status:"idle",taskId:"",progress:""}),fe().find(_t=>{var ct,gt,vt;return _t.type==="imagePreview"&&((ct=_t.data.midjourneyData)==null?void 0:ct.sourceNodeId)===n&&(((gt=_t.data.midjourneyData)==null?void 0:gt.taskId)===E||Ge&&((vt=_t.data.midjourneyData)==null?void 0:vt.messageId)===Ge)})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}m.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(le,"4å®«æ ¼",ae,{taskId:E,messageId:Ge,messageHash:Qe,mode:ie,buttons:Ae.buttons,action:Ae.action});return}const $e=Ae.progress||"";if(a($e),(Ae.status==="IN_PROGRESS"||Ae.status==="SUBMITTED")&&(w("processing"),X({status:"processing",progress:$e})),Ae.status==="FAILURE"){w("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error(Ae.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ae.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(Ae.status==="NOT_FOUND"){w("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}y++,y<J?setTimeout(B,ge):(w("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Ce){if((Ce.code==="ECONNABORTED"||Ce.code==="ERR_NETWORK"||((Ne=Ce.message)==null?void 0:Ne.includes("aborted"))||((Re=Ce.message)==null?void 0:Re.includes("Network Error")))&&y<J-1){y++,setTimeout(B,ge*2);return}w("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};B()},[n,ae,oe,X,fe]);return D.current=h,e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Ue&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:i,value:ce,onChange:E=>{z.current=!0,se(E.target.value)},onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>xe("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ie==="relax"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!k){m.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}xe("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${k?ie==="fast"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50":"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:cursor-not-allowed`,title:k?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!k&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(os,{value:ae,onChange:E=>je(E),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:ue})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:ue,onChange:E=>pe(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${ue/2}%, #06b6d4 ${ue}%, var(--range-bg-color) ${ue}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ie})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ie,onChange:E=>ee(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Ie/1e3*50}%, #06b6d4 ${Ie/1e3*100}%, var(--range-bg-color) ${Ie/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Q})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:Q,onChange:E=>U(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Q/3e3*50}%, #06b6d4 ${Q/3e3*100}%, var(--range-bg-color) ${Q/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:R})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:R===.25?0:R===.5?1:R===1?2:3,onChange:E=>{const y=Number(E.target.value);L(y===0?.25:y===1?.5:y===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(R===.25?0:R===.5?1:R===1?2:3)/3*50}%, #06b6d4 ${(R===.25?0:R===.5?1:R===1?2:3)/3*100}%, var(--range-bg-color) ${(R===.25?0:R===.5?1:R===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>x(!f),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:cursor-not-allowed ${f?"bg-neutral-800 dark:bg-white text-white dark:text-black border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-neutral-500 dark:border-neutral-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${f?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-neutral-800 dark:bg-white text-white dark:text-black"}`})})]})})]}),b.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Dr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",b.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:b.map((E,y)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Reference ${y+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",y+1]})})]},y))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:A})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:A,onChange:E=>F(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${A/1e3*50}%, #06b6d4 ${A/1e3*100}%, var(--range-bg-color) ${A/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),p.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Dr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",p.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:p.map((E,y)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Style ${y+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",y+1]})})]},y))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:G})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:G,onChange:E=>v(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${G/1e3*50}%, #06b6d4 ${G/1e3*100}%, var(--range-bg-color) ${G/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:N,onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1||!(ce!=null&&ce.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 relative overflow-hidden ${r==="processing"||r==="submitting"||!(ce!=null&&ce.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:[r==="processing"&&u&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-neutral-400/30 to-accent-400/30 transition-all duration-300",style:{width:u}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!u||u===""||u==="0%"?ie==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${u}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(pr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),I?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(g),"æ¬¡"]}):O!==null&&O>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:[O,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(gs,{type:"target",position:ut.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>{const y=T(E.source||"");return!!y&&y.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(gs,{type:"target",position:ut.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!K.some(J=>J.target===n&&J.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(gs,{type:"target",position:ut.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!K.some(J=>J.target===n&&J.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(gs,{type:"source",position:ut.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},wr="https://api.waule.ai",Eo=({data:s,selected:j,id:n})=>{var bs,er,ws,tr,sr,rr,Ps;const[W,ye]=t.useState(!0),[,T]=t.useState(0),[fe,Z]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[fe]);const{setNodes:re,setEdges:K,getNode:de,getNodes:Ue,getEdges:ce}=Zt(),se=zs(),ae=Ls(),je=t.useRef(""),ie=(bs=s.config)==null?void 0:bs.selectedEditingCapability,xe=t.useMemo(()=>(s.models||[]).filter(te=>{var Me;return te.type==="VIDEO_GENERATION"&&((Me=te.provider)==null?void 0:Me.toLowerCase())==="sora"}),[s.models]),[ue,pe]=t.useState(s.config.prompt||""),Ie=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ue&&pe(s.config.prompt)},[s.config.prompt]);const[ee,Q]=t.useState(s.config.modelId||((er=xe[0])==null?void 0:er.id)||""),[U,R]=t.useState(s.config.ratio||"16:9"),[L,f]=t.useState(s.config.resolution||"1080P"),x=t.useCallback(q=>{const te=(q||"").toLowerCase();return te?te.includes("æ–‡ç”Ÿ")||te.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":te.includes("é¦–å°¾")?"é¦–å°¾å¸§":te.includes("é¦–å¸§")||te.includes("first frame")||te.includes("start frame")||te.includes("initial frame")||te.includes("keyframe")?"é¦–å¸§":te.includes("å°¾å¸§")||te.includes("last frame")||te.includes("end frame")||te.includes("final frame")?"å°¾å¸§":te.includes("ä¸»ä½“å‚è€ƒ")||te.includes("å‚è€ƒ")||te.includes("reference image")||te.includes("image reference")||te.includes("ref image")?"å‚è€ƒå›¾":te.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":te.includes("first-last")||te.includes("two-frame")||te.includes("frame pair")?"é¦–å°¾å¸§":te.includes("first")?"é¦–å¸§":te.includes("last")?"å°¾å¸§":te.includes("subject")||te.includes("reference")?"å‚è€ƒå›¾":q||"":""},[]),[A,F]=t.useState((s.config.lockedGenerationType?x(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[G,v]=t.useState(s.config.duration||10),[$,r]=t.useState(s.config.isGenerating||!1),[w,u]=t.useState([]),[a,b]=t.useState(null),[c,p]=t.useState(!1),[d]=t.useState(""),[k]=t.useState("confirm"),[_]=t.useState(null),[O,I]=t.useState(!1),[g,l]=t.useState([]),[i,z]=t.useState(""),[D,X]=t.useState(0),[V,ne]=t.useState(0),me=t.useRef(!1),[oe,N]=t.useState(!1),h=xe.find(q=>q.id===ee)||xe[0],{credits:E,loading:y,isFreeUsage:J,freeUsageRemaining:ge,refetch:B}=Ss({aiModelId:h==null?void 0:h.id,duration:G,resolution:L});t.useEffect(()=>{var q,te;if(!xe.find(Me=>Me.id===ee)){const Me=((q=xe[0])==null?void 0:q.id)||"";Q(Me),Qe({modelId:Me,modelName:(te=xe[0])==null?void 0:te.name})}},[xe]);const he=((ws=h==null?void 0:h.provider)==null?void 0:ws.toLowerCase())==="sora",Se=t.useMemo(()=>{var te;if((te=h==null?void 0:h.config.supportedDurations)!=null&&te.length)return h.config.supportedDurations;const q=((h==null?void 0:h.provider)||"").toLowerCase();return q==="sora"?[10,15]:q==="minimaxi"?[6,10]:[G||10]},[h,G]),Ne=t.useMemo(()=>{var te;return(te=h==null?void 0:h.config.supportedResolutions)!=null&&te.length?h.config.supportedResolutions:((h==null?void 0:h.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[h]),Re=t.useMemo(()=>Math.min(...Se),[Se]),Ce=t.useMemo(()=>Math.max(...Se),[Se]),Ae=t.useMemo(()=>Math.max(1,Ce-Re),[Ce,Re]),$e=t.useMemo(()=>{const q=(G-Re)/Ae*100;return Number.isNaN(q)?0:Math.min(100,Math.max(0,q))},[G,Re,Ae]),le=!h||!((tr=h.config.supportedDurations)!=null&&tr.length),Ge=!h||!((sr=h.config.supportedResolutions)!=null&&sr.length),Qe=t.useCallback(q=>{de(n)&&re(Me=>Me.map(Ve=>Ve.id===n?{...Ve,data:{...Ve.data,config:{...Ve.data.config,...q}}}:Ve))},[de,n,re]),Wt=(q,te)=>{const Me=(C,P)=>P===0?C:Me(P,C%P),Ve=Me(q,te),qe=q/Ve,Oe=te/Ve,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},bt=`${qe}:${Oe}`;return tt[bt]||bt},Ct=()=>{const q=se.filter(Oe=>Oe.target===n),te=[];q.forEach(Oe=>{var bt;const tt=de(Oe.source);if(tt&&tt.type==="upload"&&(((bt=tt.data.config)==null?void 0:bt.uploadedFiles)||[]).forEach(P=>{const be=P.type||P.mimeType||"";(be==="IMAGE"||be.startsWith("image/"))&&te.push({id:P.id||P.name,url:P.url,name:P.name||P.originalName,width:P.width,height:P.height,aspectRatio:P.width&&P.height?Wt(P.width,P.height):"16:9"})}),tt&&tt.type==="assetSelector"){const C=tt.data.config||{},P=C.subjects,be=C.selectedAsset,Te=x(A);P&&P.length>0?Te==="é¦–å°¾å¸§"||(P[0].images||[]).forEach((we,et)=>{te.push({id:`${tt.id}-subject-${et}`,url:we,name:P[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):be&&be.type==="IMAGE"&&te.push({id:be.id,url:be.url,name:be.name||be.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const C=tt.data.imageUrl,P=tt.data.width,be=tt.data.height;C&&te.push({id:tt.id,url:C,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:P,height:be,aspectRatio:P&&be?Wt(P,be):"16:9"})}});const Me=new Set,Ve=[];te.forEach(Oe=>{const tt=Oe.url;Me.has(tt)||(Me.add(tt),Ve.push(Oe))});const qe=x(A);return qe==="æ–‡ç”Ÿè§†é¢‘"?he?Ve:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ve.slice(0,1):qe==="é¦–å°¾å¸§"?Ve.slice(0,2):qe==="å‚è€ƒå›¾"?Ve.slice(0,7):Ve},_t=t.useMemo(()=>Ct(),[se,ae,A,n,he]);t.useEffect(()=>{const q=s.config.taskId;(async()=>{if(q){try{const Ve=(await _e.tasks.getTaskStatus(q)).task;if(Ve.status==="SUCCESS"){r(!1),T(100);const qe=Ve.resultUrl;if(!qe){r(!1),T(0),Qe({taskId:"",isGenerating:!1}),Z(""),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Oe=s.config.ratio||"16:9";Qe({taskId:"",isGenerating:!1}),Z("");const tt=Ue(),bt=ce();if(tt.filter(be=>be.type==="videoPreview"&&bt.some(Te=>Te.source===n&&Te.target===be.id)).find(be=>be.data.videoUrl===qe)){setTimeout(()=>T(0),1e3);return}m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼");try{const be=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(be).some(we=>we.taskId&&we.taskId===q||we.sourceNodeId&&we.sourceNodeId===n)||Tt(qe,Oe)}catch{Tt(qe,Oe)}setTimeout(()=>T(0),1e3)}else if(Ve.status==="PROCESSING"||Ve.status==="PENDING"){r(!0),T(Ve.progress||0),Qs(q);return}else Ve.status==="FAILURE"&&(r(!1),T(0),Qe({taskId:"",isGenerating:!1}),Z(""),m.error(`ç”Ÿæˆå¤±è´¥: ${Ve.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{r(!1),T(0),Qe({taskId:"",isGenerating:!1}),Z("")}return}try{const Me=await _e.tasks.getPendingPreviewNodes(n);if(Me.tasks&&Me.tasks.length>0)for(const Ve of Me.tasks){const{previewNodeData:qe}=Ve;if(qe&&qe.url){const Oe=qe.ratio||s.config.ratio||"16:9";let tt=!1;try{const bt=localStorage.getItem("suppressedPreviewTasks")||"[]";tt=JSON.parse(bt).some(P=>P.taskId&&P.taskId===Ve.id||P.sourceNodeId&&P.sourceNodeId===n)}catch{}tt||(Tt(qe.url,Oe),m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")),await _e.tasks.markPreviewNodeCreated(Ve.id)}}}catch{}})()},[]),t.useEffect(()=>{const q=se.filter(Me=>Me.target===n);let te="";q.forEach(Me=>{var qe;const Ve=de(Me.source);if(Ve){const Oe=Ve.data;Ve.type==="agent"&&((qe=Oe.config)!=null&&qe.generatedText)?te||(te=Oe.config.generatedText):Ve.type==="textPreview"&&Oe.content&&(te||(te=Oe.content))}}),te&&te!==ue&&(pe(te),Qe({prompt:te}))},[se,n,de,ue,Qe]),t.useEffect(()=>{const q=se.filter(Ve=>Ve.target===n);if(q.length===0)return;let te="",Me="";q.forEach(Ve=>{var Oe;const qe=ae.find(tt=>tt.id===Ve.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Oe=tt.config)!=null&&Oe.generatedText&&(te=tt.config.generatedText,Me=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),te&&Me!==je.current&&(je.current=Me,pe(te),Qe({prompt:te}))},[ae,se,n,Qe]),t.useEffect(()=>{const q=JSON.stringify(_t),te=JSON.stringify(w);q!==te&&u(_t)},[_t]);const ct=t.useMemo(()=>{if(he)return!0;const q=w.length,te=x(A);return q===0?!0:q===1?te==="å‚è€ƒå›¾":q===2?te==="é¦–å°¾å¸§"?!1:te==="å‚è€ƒå›¾":q>2?te==="å‚è€ƒå›¾":!1},[w.length,A,x,he]),gt=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),vt=t.useMemo(()=>{const q=x(A);return ie?xe:xe.filter(te=>{var Ve;const Me=(((Ve=te.config)==null?void 0:Ve.supportedGenerationTypes)||[]).map(qe=>x(qe));return q==="é¦–å¸§"||q==="å°¾å¸§"?Me.includes("é¦–å¸§")||Me.includes("å°¾å¸§"):Me.includes(q)})},[xe,A,x,ie]),it=t.useMemo(()=>{const q=ie?xe:vt;return q.length>0?q:ie?(s.models||[]).filter(Me=>(Me.type||"")==="VIDEO_EDITING"):q},[ie,xe,vt,s.models]);t.useEffect(()=>{var te,Me;if(!it.find(Ve=>Ve.id===ee)){const Ve=((te=it[0])==null?void 0:te.id)||"";Q(Ve),Qe({modelId:Ve||void 0,modelName:Ve?(Me=it[0])==null?void 0:Me.name:void 0})}},[it]);const Ye=t.useCallback(q=>{const te=x(q);return ie?["IMAGE","VIDEO"]:te==="æ–‡ç”Ÿè§†é¢‘"?he?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[x,ie,he]);t.useEffect(()=>{if(!ct&&w.length>0){const q=w[0].aspectRatio;q&&U!==q&&(R(q),setTimeout(()=>{Qe({ratio:q})},0))}},[ct,w,U]),t.useEffect(()=>{if(!ie&&gt.length>0&&!gt.includes(A)){const q="æ–‡ç”Ÿè§†é¢‘";F(q),setTimeout(()=>{Qe({generationType:q,acceptedInputs:Ye(q)})},0)}},[gt,A,Ye,ie]),t.useEffect(()=>{const q=x(A);if(q==="æ–‡ç”Ÿè§†é¢‘")return;const te=se.filter(Oe=>Oe.target===n),Me=[],Ve=[];te.forEach(Oe=>{var C,P,be,Te,Ee;const tt=de(Oe.source);if(!tt)return;const bt=tt.type;if((bt||"").startsWith("aiVideo")||bt==="videoPreview"){Ve.push(Oe.id);return}if(bt==="upload"){const we=(be=(P=(C=tt.data)==null?void 0:C.config)==null?void 0:P.uploadedFiles)==null?void 0:be[0],et=((we==null?void 0:we.type)||"").toUpperCase(),st=((we==null?void 0:we.mimeType)||"").toLowerCase();if(et==="VIDEO"||st.startsWith("video/")){Ve.push(Oe.id);return}(et==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id);return}if(bt==="assetSelector"){const we=((Te=tt.data)==null?void 0:Te.config)||{};if(we.selectedAsset){const et=(we.selectedAsset.type||"").toUpperCase(),st=(we.selectedAsset.mimeType||"").toLowerCase();et==="VIDEO"||st.startsWith("video/")?Ve.push(Oe.id):(et==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id)}else if(we.subjects&&we.subjects.length>0){const et=(((Ee=we.subjects[0])==null?void 0:Ee.images)||[]).length;q==="å‚è€ƒå›¾"||q==="é¦–å°¾å¸§"?Me.push(Oe.id):(q==="é¦–å¸§"||q==="å°¾å¸§")&&(et>1?Ve.push(Oe.id):Me.push(Oe.id))}return}(bt==="aiImage"||bt==="imagePreview")&&Me.push(Oe.id)});let qe=new Set([...Ve]);q==="é¦–å¸§"||q==="å°¾å¸§"?Me.slice(1).forEach(Oe=>qe.add(Oe)):q==="é¦–å°¾å¸§"&&Me.slice(2).forEach(Oe=>qe.add(Oe)),qe.size>0&&K(Oe=>Oe.filter(tt=>!qe.has(tt.id)))},[A,se,n,de,K,x]),t.useEffect(()=>{const q=s.config.generationType;if(!q||x(q)!==x(A)){const te=x(A)||"æ–‡ç”Ÿè§†é¢‘";Qe({generationType:te,acceptedInputs:Ye(te)})}},[]),t.useEffect(()=>{const q=Ye(A);Qe({acceptedInputs:q})},[A,Ye]);const yt=q=>{b(q)},Be=q=>{q.preventDefault()},wt=q=>{if(a===null)return;const te=[...w],[Me]=te.splice(a,1);te.splice(q,0,Me),u(te),b(null),Qe({referenceImages:te})};t.useEffect(()=>{const q=Ie.current;q&&W&&requestAnimationFrame(()=>{q.style.height="auto";const te=Math.max(60,Math.min(q.scrollHeight,600));q.style.height=`${te}px`})},[ue,W]),t.useEffect(()=>{if(ue===s.config.prompt)return;const q=setTimeout(()=>{Qe({prompt:ue})},500);return()=>clearTimeout(q)},[ue]);const Yt=t.useCallback(async q=>{if(!q){l([]);return}try{const te=await _e.soraCharacters.search(q,5);l(te.characters||[]),ne(0)}catch{l([])}},[]),vs=t.useCallback(q=>{const te=q.target.value,Me=q.target.selectionStart||0;if(pe(te),me.current)return;const qe=te.substring(0,Me).match(/@([^@\s#]*)$/);if(qe){const Oe=qe[1];z(Oe),X(Me-Oe.length-1),I(!0),Yt(Oe)}else I(!1),l([])},[Yt]),Is=t.useCallback(q=>{const te=ue.substring(0,D),Me=ue.substring(D+i.length+1),Ve=`@#${q.customName}#`,qe=te+Ve+Me;pe(qe),I(!1),l([]),z(""),setTimeout(()=>{if(Ie.current){Ie.current.focus();const Oe=te.length+Ve.length;Ie.current.setSelectionRange(Oe,Oe)}},0)},[ue,D,i]),Es=t.useCallback(q=>{!O||g.length===0||(q.key==="ArrowDown"?(q.preventDefault(),ne(te=>te<g.length-1?te+1:te)):q.key==="ArrowUp"?(q.preventDefault(),ne(te=>te>0?te-1:te)):q.key==="Enter"&&g[V]?(q.preventDefault(),Is(g[V])):q.key==="Escape"&&I(!1))},[O,g,V,Is]),Ns=t.useCallback(async q=>{var qe;const te=/@#([^#]+)#/g,Me=[...q.matchAll(te)];if(Me.length===0)return q;let Ve=q;for(const Oe of Me){const tt=Oe[1];try{const bt=await _e.soraCharacters.getByCustomName(tt);(qe=bt.character)!=null&&qe.characterName&&(Ve=Ve.replace(Oe[0],` ${bt.character.characterName} `))}catch{}}return Ve},[]),Bs=q=>{var Me,Ve,qe,Oe;Q(q);const te=vt.find(tt=>tt.id===q);if(te){const tt=(Me=te.config.supportedRatios)!=null&&Me.length?te.config.supportedRatios:["16:9"],bt=(Ve=te.config.supportedResolutions)!=null&&Ve.length?te.config.supportedResolutions:["1080P"],C=(qe=te.config.supportedGenerationTypes)!=null&&qe.length?te.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],P=(te.provider||"").toLowerCase(),be=(Oe=te.config.supportedDurations)!=null&&Oe.length?te.config.supportedDurations:P==="sora"?[10,15]:P==="minimaxi"?[6,10]:[10],Te=tt[0],Ee=bt[0],we=x(A||C[0]),et=be[0];R(Te),f(Ee),F(we),v(et),Qe({modelId:q,modelName:te.name,ratio:Te,resolution:Ee,generationType:we,duration:et,acceptedInputs:Ye(we)})}},fs=t.useMemo(()=>{const q=x(A),te=w.length,qe=se.filter(Oe=>Oe.target===n).filter(Oe=>{var C,P,be,Te,Ee;const tt=de(Oe.source),bt=tt==null?void 0:tt.type;if(!tt)return!1;if(bt==="upload"){const we=(be=(P=(C=tt.data)==null?void 0:C.config)==null?void 0:P.uploadedFiles)==null?void 0:be[0],et=((we==null?void 0:we.mimeType)||"").toLowerCase();return((we==null?void 0:we.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}if(bt==="assetSelector"){const we=(Ee=(Te=tt.data)==null?void 0:Te.config)==null?void 0:Ee.selectedAsset,et=((we==null?void 0:we.mimeType)||"").toLowerCase();return((we==null?void 0:we.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}return!!((bt||"").startsWith("aiVideo")||bt==="videoPreview")}).length;return ee?q==="æ–‡ç”Ÿè§†é¢‘"?he?!0:!!ue.trim():q==="é¦–å¸§"||q==="å°¾å¸§"?te>=1:q==="é¦–å°¾å¸§"?te>=2:q==="å‚è€ƒå›¾"?te>=1:q==="è§†é¢‘æ¢äºº"?qe>=1&&te>=1:q==="å¯¹å£å‹"||q==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[A,w.length,ue,$,se,n,de,x,he]);t.useEffect(()=>{var te;const q=(te=s==null?void 0:s.config)==null?void 0:te.generatedVideoUrl;q&&Tt(q,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const Qs=async q=>{let Me=0;const Ve=async()=>{try{Me++;const Oe=(await _e.tasks.getTaskStatus(q)).task;if(T(Oe.progress||0),Oe.status==="SUCCESS"||Oe.status==="COMPLETED"||Oe.status==="DONE"){T(100);const tt=Oe.resultUrl;r(!1),Tt(tt,s.config.ratio||"16:9");try{await _e.tasks.markPreviewNodeCreated(q)}catch{}Qe({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),Z(""),m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>T(0),1e3);return}else if(Oe.status==="FAILURE"){r(!1),T(0),Qe({taskId:"",isGenerating:!1}),m.error(Oe.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Oe.status==="PROCESSING"||Oe.status==="PENDING")&&(Me<600?setTimeout(Ve,1e3):(r(!1),T(0),Qe({taskId:"",isGenerating:!1}),m.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),T(0),Qe({taskId:"",isGenerating:!1}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ve()},Hs=async()=>{var Me,Ve,qe,Oe,tt,bt;if(x(A)==="æ–‡ç”Ÿè§†é¢‘"&&!ue.trim()){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const te=Ct();Qe({referenceImages:te}),T(0);try{let C=[],P;const be=te.length;if(te.length>0)try{for(const zt of te){let At=zt.url;!At.startsWith("data:")&&!At.startsWith("http")&&(At=`${wr}${At}`),At=At.replace(/^https?:\/\/localhost(?::\d+)?/i,wr);const Ut=await dr(At);C.push(Ut)}}catch{m.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Te=se.filter(zt=>zt.target===n);if(x(A)==="å‚è€ƒå›¾"){const zt=new Map;for(const At of Te){const Ut=de(At.source);if((Ut==null?void 0:Ut.type)==="assetSelector"){const Vt=(Me=Ut.data.config)==null?void 0:Me.subjects;if(Vt&&Vt.length>0){for(const Ft of Vt)if(!zt.has(Ft.name)){const ts=(Ft.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${wr}${rs}`);zt.set(Ft.name,ts)}}}}if(zt.size>0){const At=Array.from(zt.entries());let Ut=0;const Vt=[];for(const[Ft,ts]of At){if(Ut>=7)break;const rs=7-Ut,ys=ts.slice(0,Math.max(0,rs));ys.length>0&&(Vt.push({name:Ft,images:ys}),Ut+=ys.length)}P=Vt,At.some(([,Ft])=>Ft.length>0)&&Ut<At.reduce((Ft,[,ts])=>Ft+ts.length,0)&&m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const Ee=P&&P.length>0?P.reduce((zt,At)=>{var Ut;return zt+(((Ut=At.images)==null?void 0:Ut.length)||0)},0):be;let we=A;if(we==="é¦–å¸§"||we==="å°¾å¸§"){if(Ee!==1){m.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),T(0);return}}else if(we==="é¦–å°¾å¸§"){if(Ee===1)we="é¦–å¸§";else if(Ee!==2){m.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),T(0);return}P&&P.length>0?P=[{...P[0],images:P[0].images.slice(0,2)}]:C=C.slice(0,2)}else if(we==="å‚è€ƒå›¾"||we==="ä¸»ä½“å‚è€ƒ"){if(Ee<1){m.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),T(0);return}if(P&&P.length>0){if(P.reduce((At,Ut)=>{var Vt;return At+(((Vt=Ut.images)==null?void 0:Vt.length)||0)},0)>7){let At=7;P=P.map(Ut=>({...Ut,images:Ut.images.slice(0,Math.max(0,At-=Ut.images.length,Ut.images.length))})),At=7,P=P.map(Ut=>{const Vt=Ut.images.slice(0,Math.min(Ut.images.length,At));return At-=Vt.length,{...Ut,images:Vt}}).filter(Ut=>Ut.images.length>0),m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else C.length>7&&(C=C.slice(0,7),m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}_==="dropImages"&&(C=[],P=void 0),(x(A)==="é¦–å¸§"||x(A)==="å°¾å¸§")&&_==="useFirstImage"&&C.length>=2&&(C=[C[0]]),x(A)==="é¦–å°¾å¸§"&&_==="useFirstTwoImages"&&C.length>=3&&(C=C.slice(0,2));const et={modelId:ee,ratio:U,duration:G,referenceImages:C.length>0&&!P?C:void 0,generationType:we,sourceNodeId:n,...P?{subjects:P}:{}},st=x(we);let kt=ue.trim();if(kt&&kt.includes("@#")&&(kt=await Ns(kt)),!oe&&kt&&(kt="No BGM. "+kt),st==="æ–‡ç”Ÿè§†é¢‘"){if(!kt){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),T(0);return}et.prompt=kt}else if(st==="å‚è€ƒå›¾"){if(!kt){m.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),T(0);return}et.prompt=kt}else kt&&(et.prompt=kt);const ht=await _e.tasks.createVideoTask(et),We=ht.taskId,Dt=ht.creditsCharged||0,Xt=ht.isFreeUsage,Pt=ht.freeUsageRemaining??0;if(Z(We),Qe({prompt:ue,ratio:U,resolution:L,generationType:A,duration:G,modelId:ee,taskId:We,isGenerating:!0}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),Xt)m.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Pt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),B();else if(Dt>0){const{useAuthStore:zt}=await ds(async()=>{const{useAuthStore:Ut}=await import("./index-Dg_hJ4va.js").then(Vt=>Vt.f);return{useAuthStore:Ut}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:At}=zt.getState();await At(),m.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Dt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),B()}else m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Qs(We)}catch(C){if(r(!1),T(0),((Ve=C.response)==null?void 0:Ve.status)===403){const P=((Oe=(qe=C.response)==null?void 0:qe.data)==null?void 0:Oe.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";m.error(P)}else{const P=((bt=(tt=C.response)==null?void 0:tt.data)==null?void 0:bt.error)||C.message||"æœªçŸ¥åŸå› ";m.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${P}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const q=x(A),te=Ct(),Me=te.length;if((()=>{var Oe;const qe=se.filter(tt=>tt.target===n);for(const tt of qe){const bt=de(tt.source);if((bt==null?void 0:bt.type)==="assetSelector"){const C=(Oe=bt.data.config)==null?void 0:Oe.subjects;if(C&&C.length>0)return!0}}return!1})()&&(q==="é¦–å¸§"||q==="å°¾å¸§"||q==="é¦–å°¾å¸§")){m.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&Me===0){m.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(q==="é¦–å°¾å¸§"&&Me===0){m.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(q==="å‚è€ƒå›¾"&&Me===0){m.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&Me>0&&!he&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&Me>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="é¦–å°¾å¸§"&&Me>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&!ue.trim()){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!ee){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}u(te),Qe({referenceImages:te}),r(!0),T(0),await Hs()},Tt=(q,te)=>{const Me=de(n);if(!Me||!q)return null;const Ve=te||U||"16:9",qe=Ue(),Oe=ce(),tt=qe.filter(Vt=>Vt.type==="videoPreview"&&Oe.some(Ft=>Ft.source===n&&Ft.target===Vt.id)),bt=tt.find(Vt=>Vt.data.videoUrl===q);if(bt)return bt.id;const C=1,P=400,be=(Vt,Ft=300)=>{if(!Vt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Vt))return Ft;const[ts,rs]=Vt.split(":").map(ys=>parseFloat(ys));return!ts||!rs?Ft:Math.round(P*(rs/ts))},Te=document.querySelector(`.react-flow__node[data-id="${n}"]`),Ee=Te==null?void 0:Te.getBoundingClientRect(),we=Math.round(((Ee==null?void 0:Ee.width)||400)/C),et=100,st=200,kt=be(Ve,300),ht=tt.length,We=Me.position.x+we+st,Dt=Me.position.y,Xt=We,Pt=Dt+ht*(kt+et),zt=Date.now(),At={id:`preview-${n}-${zt}`,type:"videoPreview",position:{x:Xt,y:Pt},data:{videoUrl:q,width:P,ratio:Ve,workflowContext:Me.data.workflowContext,createdBy:Me.data.createdBy}};re(Vt=>[...Vt,At]);const Ut={id:`edge-${n}-${At.id}`,source:n,target:At.id,targetHandle:`${At.id}-target`,type:"aurora"};return K(Vt=>Vt.find(ts=>ts.source===n&&ts.target===At.id)?Vt:[...Vt,Ut]),At.id},Xs=q=>{const te=q.target;if(te.tagName==="INPUT"||te.tagName==="TEXTAREA"||te.tagName==="SELECT"||te.tagName==="BUTTON"||te.closest("button")||te.closest("input")||te.closest("textarea")||te.closest("select"))return;const Me=!W;ye(Me),re(Ve=>Ve.map(qe=>qe.id===n?{...qe,data:{...qe.data,isExpanded:Me}}:qe))};return e.jsxs("div",{onDoubleClick:Xs,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var P;const q=((P=de(n))==null?void 0:P.type)||"",te=x(A),Me=te==="æ–‡ç”Ÿè§†é¢‘"||q==="aiVideo_t2v",Ve=q==="aiVideo_i2v_first"||q==="aiVideo_i2v_last"||te==="é¦–å¸§"||te==="å°¾å¸§",qe=q==="aiVideo_first_last"||te==="é¦–å°¾å¸§",Oe=q==="aiVideo_reference"||te==="å‚è€ƒå›¾",tt=se.filter(be=>be.target===n),bt=tt.some(be=>{const Te=de(be.source);return(Te==null?void 0:Te.type)==="agent"}),C=tt.reduce((be,Te)=>{var et,st,kt,ht;const Ee=de(Te.source),we=(Ee==null?void 0:Ee.type)||"";if(we==="aiImage"||we==="imagePreview")return be+1;if(we==="upload"){const We=(kt=(st=(et=Ee==null?void 0:Ee.data)==null?void 0:et.config)==null?void 0:st.uploadedFiles)==null?void 0:kt[0],Dt=((We==null?void 0:We.type)||"").toUpperCase(),Xt=((We==null?void 0:We.mimeType)||"").toLowerCase();return be+(Dt==="IMAGE"||Xt.startsWith("image/")?1:0)}if(we==="assetSelector"){const We=((ht=Ee==null?void 0:Ee.data)==null?void 0:ht.config)||{};if(We.selectedAsset)return be+((We.selectedAsset.type||"").toUpperCase()==="IMAGE"||(We.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(We.subjects&&We.subjects.length>0)return be+((We.subjects[0].images||[]).length||0)}return be},0);return Me?he||!bt:Ve?!(bt&&C>=1):qe?!(bt&&C>=2):Oe?!(bt&&C>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:d}),k==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{p(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{p(!1),m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{p(!1),await Hs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:W?e.jsxs("div",{className:"space-y-3",children:[!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:ee,onChange:q=>Bs(q),options:vt.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:vt.map(q=>({value:q.id,label:q.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-neutral-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ie,value:ue,onChange:vs,onKeyDown:Es,onCompositionStart:()=>{me.current=!0},onCompositionEnd:q=>{me.current=!1,vs(q)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),O&&g.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:g.map((q,te)=>e.jsxs("button",{type:"button",onMouseDown:Me=>{Me.preventDefault(),Me.stopPropagation(),Is(q)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${te===V?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[q.avatarUrl?e.jsx("img",{src:q.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:q.customName}),e.jsx("div",{className:"text-[10px] text-neutral-500 dark:text-neutral-400 font-mono truncate",children:q.characterName})]})]},q.id))})]})]}),w.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",A==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:w.map((q,te)=>e.jsxs("div",{draggable:A==="é¦–å°¾å¸§",onDragStart:()=>yt(te),onDragOver:Be,onDrop:()=>wt(te),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${A==="é¦–å°¾å¸§"?"cursor-move":""} ${a===te?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50`,children:[e.jsx("img",{src:`${q.url.startsWith("http")||q.url.startsWith("data:")?q.url:wr+q.url}`,alt:q.name,className:"w-full h-full object-cover"}),A==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:te===0?"é¦–":te===1?"å°¾":te+1})]},q.id))})]}),h&&!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",le?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[G,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:Re,max:Ce,step:"1",value:G,onChange:q=>{const te=parseInt(q.target.value,10);v(te),Qe({duration:te})},disabled:le,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-neutral-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-neutral-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #525252 ${$e}%, #3b0764 ${$e}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),h&&ct&&(he||(((Ps=h==null?void 0:h.config.supportedRatios)==null?void 0:Ps.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),he?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q="landscape",te=G===15?15:10,Me=`sora-video-${q}-${te}s`,Ve=xe.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||xe[0],qe=(Ve==null?void 0:Ve.id)||"";Q(qe),R("16:9"),Qe({modelId:qe,ratio:"16:9",modelName:(Ve==null?void 0:Ve.name)||`Sora Video (Landscape ${te}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${U==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const q="portrait",te=G===15?15:10,Me=`sora-video-${q}-${te}s`,Ve=xe.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||xe[0],qe=(Ve==null?void 0:Ve.id)||"";Q(qe),R("9:16"),Qe({modelId:qe,ratio:"9:16",modelName:(Ve==null?void 0:Ve.name)||`Sora Video (Portrait ${te}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${U==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:U,onChange:q=>{R(q),Qe({ratio:q})},options:((h==null?void 0:h.config.supportedRatios)||[]).map(q=>{const[te,Me]=q.split(":");return{value:q,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[q]||`${te}:${Me}`}})})]}),h&&he&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q=U==="9:16"?"portrait":"landscape",te=`sora-video-${q}-10s`,Me=xe.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===te})||xe[0],Ve=(Me==null?void 0:Me.id)||"";v(10),Q(Ve),Qe({duration:10,modelId:Ve,modelName:(Me==null?void 0:Me.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${G===10?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const q=U==="9:16"?"portrait":"landscape",te=`sora-video-${q}-15s`,Me=xe.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===te})||xe[0],Ve=(Me==null?void 0:Me.id)||"";v(15),Q(Ve),Qe({duration:15,modelId:Ve,modelName:(Me==null?void 0:Me.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${G===15?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),h&&he&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>N(!oe),className:`nodrag relative w-10 h-5 rounded-full transition-all ${oe?"bg-gradient-to-r from-neutral-800 to-neutral-700":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${oe?"left-5":"left-0.5"}`})})]}),h&&!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ge?"(æœªé…ç½®)":""]}),e.jsx(os,{value:L,onChange:q=>{f(q),Qe({resolution:q})},options:Ne.map(q=>({value:q,label:q})),className:Ge?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:$||!fs||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${$||!fs?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:$?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!y&&(J?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ge),"æ¬¡"]}):E!==null&&E>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[E,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:ue?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:ue})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Co=t.memo(Eo),Vr="https://api.waule.ai",Ao=({data:s,selected:j,id:n})=>{var v,$;const[W,ye]=t.useState(!0),[T,fe]=t.useState(s.config.customName||""),[Z,re]=t.useState(!1),[K,de]=t.useState(0),[Ue,ce]=t.useState(s.config.taskId||""),[se,ae]=t.useState(null),{credits:je,loading:ie}=Ss({nodeType:"sora_character"}),{setNodes:xe,getNode:ue,setEdges:pe}=Zt(),Ie=zs(),ee=Ls(),Q=t.useCallback(r=>{var a;if(!r)return!1;const w=r.type||"",u=((a=r.data)==null?void 0:a.config)||{};if(w==="upload")return(u.uploadedFiles||u.files||[]).some(c=>(c.mimeType||c.type||"").toLowerCase().startsWith("video/"));if(w==="videoPreview")return!!u.url;if(w==="assetSelector"){const b=u.selectedAsset;return((b==null?void 0:b.mimeType)||"").toLowerCase().startsWith("video/")&&!!(b!=null&&b.url)}return w.startsWith("aiVideo")||w==="soraVideo"?!!u.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=Ie.filter(a=>a.target===n);if(r.length===0)return;const w=[],u=[];for(const a of r){const b=ee.find(c=>c.id===a.source)||ue(a.source);Q(b)?w.push(a.id):u.push(a.id)}w.length>1&&(u.push(...w.slice(1)),m.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),u.length>0&&(pe(a=>a.filter(b=>!u.includes(b.id))),u.length>0&&w.length<=1&&r.some(b=>{const c=ee.find(p=>p.id===b.source)||ue(b.source);return!Q(c)})&&m.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ie,n,ee,ue,pe,Q]);const U=t.useMemo(()=>Ie.filter(w=>w.target===n).map(w=>{var a;const u=ee.find(b=>b.id===w.source);return(a=u==null?void 0:u.data)==null?void 0:a.config}),[Ie,n,ee]),R=t.useMemo(()=>(s.models||[]).filter(w=>{var u;return w.type==="VIDEO_GENERATION"&&((u=w.provider)==null?void 0:u.toLowerCase())==="sora"}),[s.models]),L=((v=R.find(r=>{var w;return(w=r.modelId)==null?void 0:w.includes("landscape-10s")}))==null?void 0:v.id)||(($=R[0])==null?void 0:$.id)||"",f=t.useCallback(r=>{xe(w=>w.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,...r}}}:u))},[n,xe]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!Z&&(ae({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),fe(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,Z]);const x=t.useMemo(()=>{var w;const r=Ie.filter(u=>u.target===n);for(const u of r){const a=ee.find(p=>p.id===u.source)||ue(u.source);if(!a)continue;const b=a.type||"",c=((w=a.data)==null?void 0:w.config)||{};if(b==="upload"){const d=(c.uploadedFiles||c.files||[]).find(k=>(k.mimeType||k.type||"").toLowerCase().startsWith("video/"));if(d!=null&&d.url)return{url:d.url,thumbnail:d.thumbnail||d.url,name:d.name||d.originalName||"è§†é¢‘"}}if(b==="videoPreview"&&c.url)return{url:c.url,thumbnail:c.thumbnail||c.url,name:c.name||"è§†é¢‘"};if(b==="assetSelector"){const p=c.selectedAsset;if(((p==null?void 0:p.mimeType)||"").toLowerCase().startsWith("video/")&&(p!=null&&p.url))return{url:p.url,thumbnail:p.thumbnail||p.url,name:p.name||"è§†é¢‘"}}if((b.startsWith("aiVideo")||b==="soraVideo")&&c.generatedVideoUrl)return{url:c.generatedVideoUrl,thumbnail:c.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ie,n,ee,U,ue]),A=!!x,F=async r=>{let u=0;const a=async()=>{try{u++;const c=(await _e.tasks.getTaskStatus(r)).task;if(de(c.progress||0),c.status==="SUCCESS"||c.status==="COMPLETED"||c.status==="DONE"){re(!1),de(100);const p=c.metadata||{},d=p.characterName||"",k=p.avatarUrl||c.resultUrl||"";if(!d){m.error("æœªèƒ½è·å–è§’è‰²åç§°"),f({taskId:""}),ce("");return}try{const O=(await _e.soraCharacters.create({customName:T||d,characterName:d,avatarUrl:k,sourceVideoUrl:(x==null?void 0:x.url)||void 0})).character;ae({id:O.id,customName:O.customName,characterName:O.characterName,avatarUrl:O.avatarUrl}),f({customName:O.customName,characterName:O.characterName,avatarUrl:O.avatarUrl,taskId:""}),m.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${O.customName}`)}catch(_){ae({id:"",customName:T||d,characterName:d,avatarUrl:k}),m.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${_.message}`)}ce(""),setTimeout(()=>de(0),1e3);return}else if(c.status==="FAILURE"){re(!1),de(0),f({taskId:""}),m.error(c.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(c.status==="PROCESSING"||c.status==="PENDING")&&(u<600?setTimeout(a,1e3):(re(!1),de(0),f({taskId:""}),m.error("åˆ›å»ºè¶…æ—¶")))}catch{re(!1),de(0),f({taskId:""}),m.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};a()},G=async()=>{var w,u,a,b,c;if(!x){m.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!T.trim()){m.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!L){m.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=x.url;if(!r){m.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const p=await _e.soraCharacters.getByCustomName(T.trim());if(p!=null&&p.character){m.error(`è‡ªå®šä¹‰åç§°"${T.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}re(!0),de(5),ae(null);try{const p=await _e.tasks.createVideoTask({modelId:L,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:n,metadata:{isCharacterCreation:!0,customName:T.trim(),referenceType:"video",nodeType:"sora_character"}}),d=p.taskId,k=p.creditsCharged||0;if(ce(d),f({customName:T.trim(),taskId:d}),k>0)try{const{useAuthStore:_}=await ds(async()=>{const{useAuthStore:I}=await import("./index-Dg_hJ4va.js").then(g=>g.f);return{useAuthStore:I}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:O}=_.getState();await O(),m.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${k} ç§¯åˆ†ï¼‰`)}catch{m.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else m.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");F(d)}catch(p){if(re(!1),de(0),((w=p.response)==null?void 0:w.status)===403){const d=((a=(u=p.response)==null?void 0:u.data)==null?void 0:a.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";m.error(d)}else m.error(`æäº¤å¤±è´¥: ${((c=(b=p.response)==null?void 0:b.data)==null?void 0:c.error)||p.message}`)}};return t.useEffect(()=>{Ue&&!Z&&(re(!0),F(Ue))},[]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl rounded-t-2xl",onClick:()=>ye(!W),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${W?"rotate-180":""}`,children:"expand_more"})]})]}),W&&e.jsxs("div",{className:"p-4 space-y-3",children:[x&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${x.url.startsWith("http")||x.url.startsWith("data:")?x.url:Vr+x.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:x.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:T,onChange:r=>fe(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",disabled:Z})]}),se&&!Z&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[se.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("img",{src:se.avatarUrl.startsWith("http")?se.avatarUrl:`${Vr}${se.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:se.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:se.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),Z&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[K,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all duration-300",style:{width:`${K}%`}})})]}),e.jsx("button",{onClick:G,disabled:Z||!A||!T.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${Z||!A||!T.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95"}`,children:Z?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ie&&je!==null&&je>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[je,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},_o=t.memo(Ao),To=({data:s,id:j,selected:n})=>{const{setNodes:W,getNode:ye}=Zt(),[T,fe]=t.useState(s.config.modelId||""),[Z,re]=t.useState(s.config.voiceId||""),[K,de]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Ue,ce]=t.useState(s.config.status||""),[se,ae]=t.useState(!1),[je,ie]=t.useState([]),[xe]=t.useState(void 0),[ue]=t.useState("mp3"),[pe]=t.useState(void 0),[Ie]=t.useState(void 0),[ee]=t.useState(void 0),[Q]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!T&&fe(s.config.modelId)},[s.config.modelId,T]),t.useEffect(()=>{!Z&&s.config.voiceId&&re(String(s.config.voiceId))},[s.config.voiceId,Z]),t.useEffect(()=>{if(!T){const x=(s.models||[]).filter(A=>A.type==="AUDIO_SYNTHESIS"&&A.isActive)[0];x&&(fe(x.id),R({modelId:x.id}))}},[s.models,T]),t.useEffect(()=>{U()},[]);const U=async()=>{try{const f=await _e.get("/ai/audio/voices"),x=(f==null?void 0:f.data)??f;ie(Array.isArray(x)?x:[])}catch{}},R=f=>{ye(j)&&W(A=>A.map(F=>F.id===j?{...F,data:{...F.data,config:{...F.data.config,...f}}}:F))},L=async()=>{var F,G,v,$;const f=(Z||s.config.voiceId||"").trim(),x=(K||"").trim();if(!f||!x){m.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let A=T;if(!A){const r=(s.models||[]).filter(w=>w.type==="AUDIO_SYNTHESIS"&&w.isActive);if(r[0])A=r[0].id,fe(A),R({modelId:A});else{m.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}ae(!0);try{if(Ue!=="OK"){let a=0,b=!1;for(;a<12;){a++;try{const c=await _e.ai.audio.queryVoice({voiceId:f,modelId:A}),p=((F=c.data)==null?void 0:F.status)||c.status;if(ce(p),R({status:p}),p==="OK"){b=!0;break}if(p==="UNDEPLOYED")break}catch{}await new Promise(c=>setTimeout(c,2500))}if(!b){m.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),ae(!1);return}}const r=await _e.ai.audio.synthesize({modelId:A,voiceId:f,text:x,format:ue,sampleRate:xe,volume:Ie,rate:pe,pitch:ee,output_format:Q}),w=((G=r.data)==null?void 0:G.url)||r.url;try{const u=w&&w.startsWith("http")?w:`https://api.waule.ai${w}`;let a;u?a=await _e.assets.proxyDownload(u):a=await(await fetch(w,{mode:"cors"})).arrayBuffer();const b=URL.createObjectURL(new Blob([a],{type:ue==="wav"?"audio/wav":"audio/mpeg"}));R({outputUrl:b})}catch{R({outputUrl:w})}m.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const w=(($=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:$.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(w)?m.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(w)?m.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):m.error(w)}ae(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:T,onChange:f=>{fe(f),R({modelId:f})},options:(s.models||[]).filter(f=>f.type==="AUDIO_SYNTHESIS"&&f.isActive).map(f=>({value:f.id,label:f.name}))})]}),je.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",je.length,")"]}),e.jsx(os,{value:Z||"",onChange:f=>{re(f),R({voiceId:f})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...je.map(f=>({value:f.voiceId,label:f.prefix||f.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:Z,onChange:f=>{const x=f.target.value;re(x),R({voiceId:x})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:K,onChange:f=>{de(f.target.value),R({text:f.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:L,disabled:se||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${se?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:se?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Uo=t.memo(To),Ro=({data:s,id:j,selected:n})=>{const{setNodes:W,setEdges:ye,getNode:T}=Zt(),[fe,Z]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.voiceId||""),[de,Ue]=t.useState(s.config.voiceName||""),[ce,se]=t.useState(s.config.cloneAudioUrl||""),[ae,je]=t.useState(s.config.promptAudioUrl||""),[ie,xe]=t.useState(s.config.promptText||""),[ue,pe]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ie,ee]=t.useState(!1);t.useEffect(()=>{const A=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!re||!re.startsWith("Waule")&&!re.startsWith("Aivider")||re.startsWith("minimax-")){const F=A();K(F),L({voiceId:F})}},[re]);const Q=Fs(A=>A.edges.filter(F=>F.target===j)),U=Ls(),R=t.useRef("");t.useEffect(()=>{if(!fe){const F=(s.models||[]).filter(G=>{if(G.type!=="AUDIO_SYNTHESIS"||!G.isActive)return!1;const v=String(G.provider||"").toLowerCase();return v.includes("minimaxi")||v.includes("hailuo")||v.includes("æµ·èº")})[0];F&&(Z(F.id),L({modelId:F.id}))}},[s.models,fe]),t.useEffect(()=>{try{const A=Q.map(v=>`${v.id}-${v.source}-${v.targetHandle||""}`).sort().join(",");if(A===R.current)return;R.current=A;let F="",G="";for(const v of Q){const $=T(v.source);if(!$)continue;const r=$.data||{},w=String($.type||"").toLowerCase(),a=(()=>{var b,c;if(w==="upload"){const p=(((b=r.config)==null?void 0:b.uploadedFiles)||[]).find(d=>{const k=((d==null?void 0:d.type)||"").toUpperCase(),_=((d==null?void 0:d.mimeType)||"").toLowerCase();return k==="AUDIO"||_.startsWith("audio/")});return p==null?void 0:p.url}if(w==="assetSelector"){const p=(c=r.config)==null?void 0:c.selectedAsset,d=((p==null?void 0:p.type)||"").toUpperCase(),k=((p==null?void 0:p.mimeType)||"").toLowerCase();if(d==="AUDIO"||k.startsWith("audio/"))return p==null?void 0:p.url}return null})();a&&(v.targetHandle===`${j}-target-clone`&&(F=a),v.targetHandle===`${j}-target-prompt`&&(G=a))}F!==ce&&(se(F),L({cloneAudioUrl:F})),G!==ae&&(je(G),L({promptAudioUrl:G}))}catch{}},[Q,U,T,j,ce,ae]);const L=A=>{W(F=>F.map(G=>G.id===j?{...G,data:{...G.data,config:{...G.data.config,...A}}}:G))},f=async()=>{var A,F;if(!re||!de){m.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await _e.ai.audio.voices.add({voiceId:re,prefix:de}),m.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(G){const v=((F=(A=G==null?void 0:G.response)==null?void 0:A.data)==null?void 0:F.message)||(G==null?void 0:G.message)||"ä¿å­˜å¤±è´¥";m.error(v)}},x=async()=>{var A,F,G;if(!fe||!de||!ce){m.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}ee(!0),m.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const $=(s.models||[]).find(p=>p.id===fe),r=($==null?void 0:$.modelId)||"speech-2.6-hd";let w=ce;w.startsWith("http");const u=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;K(u),L({voiceId:u});const a=await _e.ai.audio.createVoice({modelId:fe,targetModel:r,prefix:de,url:w,promptUrl:ae||void 0,promptText:ie||void 0,voiceId:u,previewText:ue||void 0}),b=(a==null?void 0:a.data)||a,c=b==null?void 0:b.sampleUrl;if(c){L({sampleUrl:c,status:"OK",voiceName:de}),m.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const p=T(j);if(p){const d=`audioPreview-${Date.now()}`,k={id:d,type:"audioPreview",position:{x:p.position.x+450,y:p.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:c,config:{audioUrl:c,title:`${de} - è¯•å¬`},models:s.models,createdBy:(A=p.data)==null?void 0:A.createdBy}};W(O=>[...O,k]);const _={id:`e-${j}-source-${d}-target`,source:j,sourceHandle:`${j}-source`,target:d,targetHandle:`${d}-target`,type:"aurora"};ye(O=>[...O,_])}}else L({status:"OK",voiceName:de}),m.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(v){const $=((G=(F=v==null?void 0:v.response)==null?void 0:F.data)==null?void 0:G.message)||(v==null?void 0:v.message)||"åˆ›å»ºå¤±è´¥";m.error($)}ee(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:A=>{Z(A),L({modelId:A})},options:(s.models||[]).filter(A=>{if(A.type!=="AUDIO_SYNTHESIS"||!A.isActive)return!1;if(Array.isArray(A.capabilities))return A.capabilities.some(G=>G.capability==="éŸ³è‰²å…‹éš†"&&G.supported);const F=String(A.provider||"").toLowerCase();return F.includes("minimaxi")||F.includes("hailuo")||F.includes("æµ·èº")}).map(A=>({value:A.id,label:A.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:de,onChange:A=>{Ue(A.target.value),L({voiceName:A.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:A=>A.stopPropagation()}),e.jsx("button",{onClick:f,disabled:!re||!de,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!re||!de?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:ce?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:ce?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:ae?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:ae?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ie,onChange:A=>{xe(A.target.value),L({promptText:A.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:A=>A.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:ue,onChange:A=>{pe(A.target.value),L({previewText:A.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:A=>A.stopPropagation()})]}),e.jsx("button",{onClick:x,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},$o=t.memo(Ro),Wr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Mo=({data:s,id:j,selected:n})=>{const{setNodes:W,getNode:ye,setEdges:T}=Zt(),[fe,Z]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.voiceId||""),[de,Ue]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),ce=t.useRef(null),[se,ae]=t.useState("zh"),je=t.useRef(null),ie=t.useRef(null),xe=t.useRef(null),ue=t.useRef(null),pe=t.useRef(null),[Ie,ee]=t.useState([]),Q=async()=>{try{const u=await _e.ai.audio.voices.list(),a=(u==null?void 0:u.data)??u;ee(Array.isArray(a)?a:[])}catch{}},U=async()=>{try{const u=window.AudioContext||window.webkitAudioContext;ue.current||(ue.current=new u);const a=ue.current;a.state==="suspended"&&await a.resume()}catch{}},[R,L]=t.useState(!1),[f]=t.useState(""),[x]=t.useState(void 0),[A]=t.useState("mp3"),[F]=t.useState(void 0),[G]=t.useState(void 0),[v]=t.useState(void 0),[$]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!fe&&Z(s.config.modelId)},[s.config.modelId,fe]),t.useEffect(()=>{!re&&s.config.voiceId&&K(String(s.config.voiceId))},[s.config.voiceId,re]),t.useEffect(()=>{if(!fe){const a=(s.models||[]).filter(b=>b.type==="AUDIO_SYNTHESIS"&&b.isActive)[0];a&&(Z(a.id),r({modelId:a.id}))}},[s.models,fe]),t.useEffect(()=>{Q()},[]),t.useEffect(()=>{se==="custom"&&Q()},[se]),t.useEffect(()=>{const u=ce.current;u&&(u.style.height="auto",u.style.height=`${u.scrollHeight}px`)},[de]);const r=u=>{ye(j)&&W(b=>b.map(c=>c.id===j?{...c,data:{...c.data,config:{...c.data.config,...u}}}:c))},w=async(u=!1)=>{var p,d,k,_,O;let a=(re||s.config.voiceId||"").trim();if(u&&!a)if(se==="custom"){const I=Ie[0];I&&(a=String(I.voiceId),K(a),r({voiceId:a}))}else{const I=Wr.find(g=>{const l=g.label;return se==="zh"?l.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):se==="yue"?l.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):se==="en"?l.startsWith("è‹±æ–‡ "):se==="ja"?l.startsWith("æ—¥æ–‡ "):se==="ko"?l.startsWith("éŸ©æ–‡ "):!0});I&&(a=I.id,K(a),r({voiceId:a}))}const b=u?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(de||"").trim();if(!a||!b){m.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let c=fe;if(!c){const I=(s.models||[]).filter(g=>g.type==="AUDIO_SYNTHESIS"&&g.isActive);if(I[0])c=I[0].id,Z(c),r({modelId:c});else{m.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}L(!0);try{u&&await U();const I={};if(f)try{I.voice_modify={emotion:f}}catch{}const g=await _e.ai.audio.synthesize({modelId:c,voiceId:a,text:b,format:A,sampleRate:x,volume:G,rate:F,pitch:v,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...I}),l=((p=g==null?void 0:g.data)==null?void 0:p.url)||(g==null?void 0:g.url),i=window.location.origin,D=(y=>{if(!y)return"";try{if(y.startsWith("http://localhost:3000")||y.startsWith("http://127.0.0.1:3000")){const J=new URL(y).pathname;return`${i}${J}`}return y.startsWith("http")?y:y.startsWith("/")?`${i}${y}`:`${i}/${y}`}catch{return y}})(l);let X;const V=y=>{if(y.length>=12){if(y[0]===82&&y[1]===73&&y[2]===70&&y[3]===70&&y[8]===87&&y[9]===65&&y[10]===86&&y[11]===69)return"audio/wav";if(y[0]===73&&y[1]===68&&y[2]===51||y[0]===255&&(y[1]&224)===224)return"audio/mpeg"}return A==="wav"?"audio/wav":"audio/mpeg"},ne=y=>y.length>=12&&y[4]===102&&y[5]===116&&y[6]===121&&y[7]===112,me=y=>y.length>=4&&y[0]===79&&y[1]===103&&y[2]===103&&y[3]===83,oe=y=>y.length>=4&&y[0]===102&&y[1]===76&&y[2]===97&&y[3]===67,N=new Uint8Array(X||new ArrayBuffer(0));let h=V(N);(!h||h==="application/octet-stream")&&(ne(N)?h="audio/mp4":me(N)?h="audio/ogg":oe(N)&&(h="audio/flac"));let E;if(u){if(pe.current){try{pe.current.stop()}catch{}pe.current.disconnect(),pe.current=null}const y=ie.current||new Audio;y.preload="auto",y.autoplay=!0,y.playsInline=!0,y.crossOrigin="anonymous",ie.current=y;let J=!1;const ge=(B,he,Se=1500)=>new Promise(Ne=>{let Re=!1;const Ce=()=>{Re||(Re=!0,$e(),Ne(!0))},Ae=()=>{Re||(Re=!0,$e(),Ne(!1))},$e=()=>{B.removeEventListener(he,Ce),B.removeEventListener("error",Ae)};B.addEventListener(he,Ce),B.addEventListener("error",Ae),setTimeout(()=>{Ae()},Se)});try{const B=Ne=>{const Re=(Ne||"").replace(/\s+/g,""),Ce=new Uint8Array(Math.floor(Re.length/2));for(let Ae=0;Ae<Ce.length;Ae++)Ce[Ae]=parseInt(Re.substr(Ae*2,2),16);return Ce},he=((d=g==null?void 0:g.data)==null?void 0:d.hex)||(g==null?void 0:g.hex),Se=he?B(String(he)).buffer:void 0;if(Se&&Se.byteLength>0){const Ne=new Uint8Array(Se),Re=V(Ne),Ce=new Blob([Se],{type:Re}),Ae=URL.createObjectURL(Ce);if(xe.current)try{URL.revokeObjectURL(xe.current)}catch{}if(xe.current=Ae,y.src=Ae,y.load(),!await ge(y,"canplay"))throw new Error("blob not ready");await y.play(),J=!0}else throw new Error("no hex")}catch{J=!1}if(!J){try{const B=Ne=>{const Re=(Ne||"").replace(/\s+/g,""),Ce=new Uint8Array(Math.floor(Re.length/2));for(let Ae=0;Ae<Ce.length;Ae++)Ce[Ae]=parseInt(Re.substr(Ae*2,2),16);return Ce},he=((k=g==null?void 0:g.data)==null?void 0:k.hex)||(g==null?void 0:g.hex),Se=he?B(String(he)).buffer:void 0;if(!Se||Se.byteLength===0){const Ne=await _e.assets.proxyDownload(D);if(!Ne||Ne.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const Re=new Uint8Array(Ne),Ce=V(Re),Ae=new Blob([Ne],{type:Ce}),$e=URL.createObjectURL(Ae);if(xe.current)try{URL.revokeObjectURL(xe.current)}catch{}if(xe.current=$e,y.src=$e,y.load(),!await ge(y,"canplay"))throw new Error("blob not ready");await y.play(),J=!0}else{const Ne=new Uint8Array(Se),Re=V(Ne),Ce=new Blob([Se],{type:Re}),Ae=URL.createObjectURL(Ce);if(xe.current)try{URL.revokeObjectURL(xe.current)}catch{}if(xe.current=Ae,y.src=Ae,y.load(),!await ge(y,"canplay"))throw new Error("blob not ready");await y.play(),J=!0}}catch{}if(!J)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const y=await _e.assets.proxyDownload(D),J=new Uint8Array(y),ge=V(J);E=URL.createObjectURL(new Blob([y],{type:ge}))}catch{}if(!u&&E){if(je.current)try{URL.revokeObjectURL(je.current)}catch{}je.current=E;const y=D||E;r({outputUrl:y});try{const J=ye(j);if(J){const B=document.querySelector(`.react-flow__node[data-id="${J.id}"]`),he=Math.round((B==null?void 0:B.getBoundingClientRect().width)||420),Se=J.position.x+he+160,Ne=`audio-preview-${Date.now()}`;W(Re=>{var le;const Ce=Re.filter(Ge=>{var Qe;return Ge.type==="audioPreview"&&((Qe=Ge.data)==null?void 0:Qe.sourceNodeId)===j}),Ae=J.position.y,$e=Ce.length>0?Math.max(...Ce.map(Ge=>{var Qe;return((Qe=Ge.position)==null?void 0:Qe.y)||Ae}))+120:Ae;return[...Re,{id:Ne,type:"audioPreview",position:{x:Se,y:$e},data:{audioUrl:y,sourceNodeId:j,createdBy:(le=J.data)==null?void 0:le.createdBy}}]}),T(Re=>[...Re,{id:`${j}-${Ne}`,source:j,target:Ne}])}}catch{}}u&&ie.current&&!ie.current.paused?m.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!u&&E&&m.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(I){const g=((O=(_=I==null?void 0:I.response)==null?void 0:_.data)==null?void 0:O.message)||(I==null?void 0:I.message)||(u?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");m.error(g)}L(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:u=>{Z(u),r({modelId:u})},options:(s.models||[]).filter(u=>u.type==="AUDIO_SYNTHESIS"&&u.isActive).map(u=>({value:u.id,label:u.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(os,{value:se,onChange:u=>{ae(u),u==="custom"&&Q()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(os,{value:re,onChange:u=>{K(u),r({voiceId:u})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...se==="custom"?Ie.map(u=>({value:u.voiceId,label:u.prefix||u.voiceId})):Wr.filter(u=>{const a=u.label;return se==="zh"?a.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):se==="yue"?a.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):se==="en"?a.startsWith("è‹±æ–‡ "):se==="ja"?a.startsWith("æ—¥æ–‡ "):se==="ko"?a.startsWith("éŸ©æ–‡ "):!0}).map(u=>({value:u.id,label:u.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>w(!0),disabled:R,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${R?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":""}`,style:R?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:ce,value:de,onChange:u=>{Ue(u.target.value),r({text:u.target.value})},onMouseDown:u=>u.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>w(!1),disabled:R||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${R||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"border-transparent dark:border-white/10"}`,style:R||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:R?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Do=t.memo(Mo),Lo=t.memo(({id:s,sourceX:j,sourceY:n,targetX:W,targetY:ye,sourcePosition:T,targetPosition:fe,selected:Z,markerEnd:re})=>{const[K]=ka({sourceX:j,sourceY:n,targetX:W,targetY:ye,sourcePosition:T,targetPosition:fe});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#404040",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#525252",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:K,fill:"none",stroke:Z?"#525252":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:re}),e.jsx("path",{d:K,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:re}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:K,calcMode:"linear"})}),e.jsx("path",{d:K,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Po=({data:s,id:j})=>{const n=t.useRef(null),{getNode:W,setNodes:ye}=Zt(),[T,fe]=t.useState(!1),[Z,re]=t.useState([]),[K,de]=t.useState(""),[Ue,ce]=t.useState("ALL"),[se,ae]=t.useState(""),[je,ie]=t.useState(!1),xe=t.useMemo(()=>window.location.origin,[]),ue=t.useMemo(()=>{var R;const U=s.audioUrl||"";if(U.startsWith("blob:")){const L=s.sourceNodeId?W(s.sourceNodeId):null,f=((R=L==null?void 0:L.data)==null?void 0:R.outputUrl)||"";return f.startsWith("http")?f:f.startsWith("/")?`${xe}${f}`:U}return U.startsWith("http")?`${xe}/api/assets/proxy-stream?url=${encodeURIComponent(U)}`:U.startsWith("/")?`${xe}${U}`:U},[s.audioUrl,s.sourceNodeId,xe]);t.useEffect(()=>{const U=n.current;U&&(U.preload="auto",U.playsInline=!0,U.crossOrigin="anonymous",U.load())},[ue]),t.useEffect(()=>{T&&(pe(),setTimeout(()=>{Ie()},100))},[T]);const pe=async()=>{try{const U=Ue==="ALL"?void 0:{category:Ue},L=(await _e.assetLibraries.getAll(U)).data||[];re(L);const f=Ue==="ALL"?L:L.filter(x=>(x.category||"OTHER")===Ue);if(f.length>0){const x=f.find(A=>A.id===K);de(x?x.id:f[0].id)}else de("")}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ie=()=>{const U=window.__workflowContext;if(!U||!U.project||!U.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const R=Ws(j,U.nodeGroups);if(!R&&U.nodeGroups.length>0){const f=U.nodeGroups[0],x=Ts({project:U.project,episode:U.episode,nodeGroup:f,assetType:"audio"});x?(ae(x),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${x}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const L=Ts({project:U.project,episode:U.episode,nodeGroup:R,assetType:"audio"});L?(ae(L),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${L}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},ee=async()=>{var U,R;if(!K){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!se.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ie(!0),await _e.assetLibraries.addFromUrl(K,s.audioUrl,se.trim());const L=window.__workflowContext;if(L&&L.project&&L.nodeGroups){const f=Ws(j,L.nodeGroups)||L.nodeGroups[0];f&&Ts({project:L.project,episode:L.episode,nodeGroup:f,nodeId:j,assetType:"audio",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),fe(!1),ae("");try{ye(f=>f.map(x=>x.id===j?{...x,data:{...x.data,addedToLibrary:!0}}:x))}catch{}try{const f=new CustomEvent("asset-library-updated",{detail:{libraryId:K}});window.dispatchEvent(f)}catch{}}catch(L){m.error(((R=(U=L.response)==null?void 0:U.data)==null?void 0:R.message)||"æ·»åŠ å¤±è´¥")}finally{ie(!1)}},Q=async()=>{var L;let U=`audio-${Date.now()}.mp3`;const R=window.__workflowContext;if(R&&R.project&&R.nodeGroups){const f=Ws(j,R.nodeGroups)||R.nodeGroups[0];if(f){const x=Ts({project:R.project,episode:R.episode,nodeGroup:f,assetType:"audio",preview:!0});if(x&&(U=x,!U.includes("."))){const A=((L=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:L[0])||".mp3";U+=A}}}try{m.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const f=await fetch(s.audioUrl);if(!f.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${f.status}`);const x=await f.blob(),A=window.URL.createObjectURL(x),F=document.createElement("a");F.href=A,F.download=U,document.body.appendChild(F),F.click(),document.body.removeChild(F),setTimeout(()=>{window.URL.revokeObjectURL(A)},100),m.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${U}`)}catch(f){m.error(`ä¸‹è½½å¤±è´¥: ${f instanceof Error?f.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:n,controls:!0,src:ue,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{fe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:Q,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),T&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:U=>U.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>fe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:se,onChange:U=>ae(U.target.value),onMouseDown:U=>U.stopPropagation(),onTouchStart:U=>U.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const U=Ue==="ALL"?Z:Z.filter(R=>(R.category||"OTHER")===Ue);return U.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Ue==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:K,onChange:R=>de(R.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:U.map(R=>e.jsxs("option",{value:R.id,children:[R.name," (",R._count.assets," ä¸ªèµ„äº§)"]},R.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(U=>e.jsx("button",{type:"button",onClick:()=>{ce(U);const R=Z.filter(L=>(L.category||"OTHER")===U);de(R.length>0?R[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Ue===U?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:U==="ROLE"?"person":U==="SCENE"?"landscape":U==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:U==="ROLE"?"è§’è‰²åº“":U==="SCENE"?"åœºæ™¯åº“":U==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},U))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>fe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:ee,disabled:je||Z.length===0||!se.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:je?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Oo=t.memo(Po),Go=({data:s,id:j,selected:n})=>{const{setNodes:W,getNode:ye,setEdges:T}=Zt(),[fe,Z]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.prompt||""),[de,Ue]=t.useState(s.config.previewText||""),[ce,se]=t.useState(s.config.voiceId||""),[ae,je]=t.useState(!1),ie=t.useRef(null),xe=t.useRef(null),ue=t.useRef(null),pe=t.useRef(null),[Ie,ee]=t.useState([]);t.useEffect(()=>{if(!fe){const A=(s.models||[]).filter(F=>F.type==="AUDIO_SYNTHESIS"&&F.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(F.provider||"").toLowerCase())&&(Array.isArray(F.capabilities)?F.capabilities.some(G=>G.capability==="éŸ³è‰²è®¾è®¡"&&G.supported):!0))[0];A&&(Z(A.id),Q({modelId:A.id}))}},[s.models,fe]);const Q=x=>{ye(j)&&W(F=>F.map(G=>G.id===j?{...G,data:{...G.data,config:{...G.data.config,...x}}}:G))};t.useEffect(()=>{(async()=>{try{const x=await _e.ai.audio.voices.list(),A=(x==null?void 0:x.data)??x;ee(Array.isArray(A)?A:[])}catch{}})()},[]);const U=x=>{x&&(x.style.height="auto",x.style.height=`${x.scrollHeight}px`)};t.useEffect(()=>{U(xe.current)},[re]),t.useEffect(()=>{U(ue.current)},[de]);const R=async x=>{if(!x)return!1;try{const A=(x||"").replace(/\s+/g,""),F=new Uint8Array(Math.floor(A.length/2));for(let w=0;w<F.length;w++)F[w]=parseInt(A.substr(w*2,2),16);const G=(()=>{const w=F;return w.length>=12&&w[0]===82&&w[1]===73&&w[2]===70&&w[3]===70&&w[8]===87&&w[9]===65&&w[10]===86&&w[11]===69?"audio/wav":(w.length>=3&&w[0]===73&&w[1]===68&&w[2]===51||w.length>=2&&w[0]===255&&(w[1]&224)===224,"audio/mpeg")})(),v=new Blob([F.buffer],{type:G}),$=URL.createObjectURL(v);if(pe.current)try{URL.revokeObjectURL(pe.current)}catch{}pe.current=$;const r=ie.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=$,ie.current=r,await r.play(),!0}catch{return!1}},L=async()=>{var A,F,G,v,$;if(!re.trim()){m.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let x=fe;if(!x){const r=(s.models||[]).filter(w=>w.type==="AUDIO_SYNTHESIS"&&w.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(w.provider||"").toLowerCase()));if(r[0])x=r[0].id,Z(x),Q({modelId:x});else{m.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}je(!0);try{const r=await _e.ai.audio.design({modelId:x,prompt:re,preview_text:de,voice_id:ce||void 0,aigc_watermark:!1}),w=((A=r==null?void 0:r.data)==null?void 0:A.voice_id)||(r==null?void 0:r.voice_id),u=((F=r==null?void 0:r.data)==null?void 0:F.trial_audio)||(r==null?void 0:r.trial_audio)||((G=r==null?void 0:r.data)==null?void 0:G.hex)||(r==null?void 0:r.hex);w&&(se(String(w)),Q({voiceId:String(w)})),u&&typeof u=="string"?(Q({trialHex:u}),await R(u),m.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):m.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const a=ye(j);if(a){const c=document.querySelector(`.react-flow__node[data-id="${a.id}"]`),p=Math.round((c==null?void 0:c.getBoundingClientRect().width)||420),d=a.position.x+p+160,k=`audio-preview-${Date.now()}`;W(_=>{var O;return[..._,{id:k,type:"audioPreview",position:{x:d,y:a.position.y},data:{audioUrl:pe.current||"",sourceNodeId:j,createdBy:(O=a.data)==null?void 0:O.createdBy}}]}),T(_=>[..._,{id:`${j}-${k}`,source:j,target:k}])}}catch{}}catch(r){const w=(($=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:$.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";m.error(w)}je(!1)},f=async()=>{var A,F;const x=(ce||"").trim();if(!x){m.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ie.some(b=>String(b.voiceId)===String(x))){m.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const $=(s.models||[]).find(b=>b.id===fe),r=($==null?void 0:$.modelId)||"cosyvoice-v2",w=(re||x).slice(0,40);await _e.ai.audio.voices.add({voiceId:x,prefix:w,targetModel:r,provider:String(($==null?void 0:$.provider)||"")});const u=await _e.ai.audio.voices.list(),a=(u==null?void 0:u.data)??u;ee(Array.isArray(a)?a:[]),m.success("å·²ä¿å­˜éŸ³è‰²")}catch(G){const v=((F=(A=G==null?void 0:G.response)==null?void 0:A.data)==null?void 0:F.message)||(G==null?void 0:G.message)||"ä¿å­˜å¤±è´¥";m.error(v)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:x=>{Z(x),Q({modelId:x})},options:(s.models||[]).filter(x=>x.type!=="AUDIO_SYNTHESIS"||!x.isActive?!1:Array.isArray(x.capabilities)?x.capabilities.some(A=>A.capability==="éŸ³è‰²è®¾è®¡"&&A.supported):["minimaxi","hailuo","æµ·èº"].includes(String(x.provider||"").toLowerCase())).map(x=>({value:x.id,label:x.name}))})]}),Ie.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(os,{value:ce||"",onChange:x=>{se(x),Q({voiceId:x})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ie.map(x=>({value:x.voiceId,label:x.prefix||x.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:ce,onChange:x=>{const A=x.target.value;se(A),Q({voiceId:A})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:xe,value:re,onChange:x=>{K(x.target.value),Q({prompt:x.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:ue,value:de,onChange:x=>{Ue(x.target.value),Q({previewText:x.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:L,disabled:ae||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ae||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ae?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:f,disabled:ae||!ce||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${ae||!ce||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Vo=t.memo(Go),Wo=({data:s,id:j,selected:n})=>{const W=t.useRef(null),ye=t.useRef(null),T=t.useRef(null),{getNodes:fe,getEdges:Z,setNodes:re,setEdges:K,getNode:de,getViewport:Ue}=Zt(),ce=zs(),se=Ls(),[ae,je]=t.useState(null),[ie,xe]=t.useState("#7c3aed"),[ue,pe]=t.useState(100),Ie=t.useRef(!1),ee=t.useRef(null),Q=t.useRef(null),U=t.useRef(null),R=t.useRef(new Set),L=t.useRef(null),f=t.useRef(null),x=t.useRef(null),A=4096,F=s.width||800,G=s.width||800,v=A,$=A;return t.useEffect(()=>{var g,l,i,z;if(!W.current||ye.current)return;const r=document.createElement("canvas");r.width=v,r.height=$,W.current.appendChild(r);const w=new _a(r,{width:v,height:$,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),u=new Zs({left:0,top:0,width:v,height:$,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});w.add(u),w.sendObjectToBack(u),w.perPixelTargetFind=!0,w.targetFindTolerance=8;const a=F/v;w.setDimensions({width:F,height:G}),w.setZoom(a),r.style.width=`${F} px`,r.style.height=`${G} px`,ye.current=w,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const b=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;w.rotationCursor=b;const c=Vs.prototype.controls||{};c.tl&&(c.tl.cursorStyle="nwse-resize",c.tl.cornerStyle="square"),c.br&&(c.br.cursorStyle="nwse-resize",c.br.cornerStyle="square"),c.tr&&(c.tr.cursorStyle="nesw-resize",c.tr.cornerStyle="square"),c.bl&&(c.bl.cursorStyle="nesw-resize",c.bl.cornerStyle="square"),c.mtr&&(c.mtr.cursorStyle=b,c.mtr.cornerStyle="circle");const p=D=>{D&&(D.borderColor="#ff2d55",D.cornerColor="#ff2d55",D.cornerStrokeColor="#ff2d55",D.transparentCorners=!1,D.cornerSize=12,D.hasBorders=!0,D.hasControls=!0)},d=()=>{const D=w.getActiveObject();D&&(D.type==="activeSelection"&&Array.isArray(D._objects)&&D._objects.forEach(p),p(D),w.requestRenderAll())};w.on("selection:created",d),w.on("selection:updated",d),w.freeDrawingBrush=new Lr(w);const k=()=>{const D=ye.current;if(!D)return;const X=D.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(X.objects)&&(X.objects=X.objects.map(oe=>(oe&&oe.type==="image"&&oe.originalUrl&&(oe.src=oe.originalUrl),oe)));const V={canvasJson:X,appliedCrop:x.current},ne=JSON.stringify(V);try{localStorage.setItem(`superCanvas:${j}`,ne)}catch{}de(j)&&re(oe=>oe.map(N=>N.id===j?{...N,data:{...N.data,canvasState:ne}}:N))},_=()=>{f.current&&(clearTimeout(f.current),f.current=null),f.current=window.setTimeout(()=>{k()},300)};w.on("object:added",_),w.on("object:modified",_),w.on("object:removed",_),w.on("path:created",_);const O=((l=(g=de(j))==null?void 0:g.data)==null?void 0:l.canvasState)||localStorage.getItem(`superCanvas:${j}`),I=(z=(i=de(j))==null?void 0:i.data)==null?void 0:z.canvasJson;if(O||I)try{let D,X=null;if(O){const h=JSON.parse(O);h.canvasJson?(D=h.canvasJson,X=h.appliedCrop):D=h}else I&&(D=JSON.parse(I));const V=D,ne=h=>{var E,y,J,ge,B,he,Se,Ne,Re;if(!h||typeof h!="object")return h;if(h.type==="image"){if(h.originalUrl)h.src=h.originalUrl;else if(h.sourceNodeId){const Ce=de(h.sourceNodeId),Ae=((E=Ce==null?void 0:Ce.data)==null?void 0:E.imageUrl)||((y=Ce==null?void 0:Ce.data)==null?void 0:y.url)||((J=Ce==null?void 0:Ce.data)==null?void 0:J.output)||((B=(ge=Ce==null?void 0:Ce.data)==null?void 0:ge.config)==null?void 0:B.generatedImageUrl)||((Re=(Ne=(Se=(he=Ce==null?void 0:Ce.data)==null?void 0:he.config)==null?void 0:Se.uploadedFiles)==null?void 0:Ne[0])==null?void 0:Re.url);Ae&&(h.originalUrl=Ae,h.src=Ae)}return typeof h.src=="string"&&h.src.startsWith("blob:")?null:h}return Array.isArray(h.objects)&&(h.objects=h.objects.map(ne).filter(Boolean),h.type==="group"&&h.objects.length===0)?null:h},me=h=>h&&(typeof(h==null?void 0:h.src)=="string"&&h.src.startsWith("blob:")?null:h.type==="image"?ne(h):h),oe=h=>h&&(Array.isArray(h)?h.map(oe).filter(Boolean):typeof h=="object"&&(h.type==="image"&&typeof h.src=="string"&&h.src.startsWith("blob:")||(Object.keys(h).forEach(E=>{const y=h[E];if(typeof y=="string"&&y.startsWith("blob:"))h[E]=void 0;else if(y&&typeof y=="object"){const J=oe(y);J===null?delete h[E]:h[E]=J}}),Array.isArray(h.objects)&&(h.objects=h.objects.map(oe).filter(Boolean),h.type==="group"&&h.objects.length===0)))?null:h);Array.isArray(V.objects)&&(V.objects=V.objects.map(ne).filter(Boolean)),V.backgroundImage&&(V.backgroundImage=me(V.backgroundImage)),V.overlayImage&&(V.overlayImage=me(V.overlayImage)),V.clipPath&&(V.clipPath=ne(V.clipPath));const N=oe(V);w.loadFromJSON(N).then(()=>{const h=new Zs({left:0,top:0,width:v,height:$,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});w.add(h);const E=w.getObjects().find(y=>y.name==="__background__");if(E&&w.sendObjectToBack(E),X){x.current=X;const{left:y,top:J,width:ge,height:B}=X,he=new Zs({left:y,top:J,width:ge,height:B,absolutePositioned:!0});w.clipPath=he,E&&E.set({left:y,top:J,width:ge,height:B})}w.requestRenderAll()})}catch{}return W.current&&W.current.classList.add("nodrag"),()=>{w.dispose(),ye.current=null,W.current&&(W.current.innerHTML="")}},[j,v,$,F]),t.useEffect(()=>{ae==="brush"?(ue<80||ue>400)&&pe(100):(ae==="pencil"||ae==="line"||ae==="arrow")&&(ue<10||ue>30)&&pe(15)},[ae,ue]),t.useEffect(()=>{const r=ye.current;if(!r)return;const w="https://api.waule.ai",u=ce.filter(c=>c.target===j&&c.targetHandle==="input-image");u.forEach(async c=>{var I,g;const p=se.find(l=>l.id===c.source);if(!p||R.current.has(p.id))return;let d;const k=p.data;if(p.type==="upload"){const l=(I=k==null?void 0:k.config)==null?void 0:I.uploadedFiles;if(l&&l.length>0){const i=l[0];(i.type==="IMAGE"||(g=i.mimeType)!=null&&g.startsWith("image/"))&&(d=i.url)}}else p.type==="imagePreview"?d=k==null?void 0:k.imageUrl:d=(k==null?void 0:k.imageUrl)||(k==null?void 0:k.output)||(k==null?void 0:k.url);if(!d)return;let _=d;if(!d.startsWith("http")&&!d.startsWith("data:")&&(_=`${w}${d}`),_=_.replace(/^https?:\/\/localhost(?::\d+)?/i,w),r.getObjects().find(l=>l.sourceNodeId===p.id)){R.current.add(p.id);return}R.current.add(p.id);try{const l=await _e.assets.proxyDownload(_),i=new Uint8Array(l);let z="image/png";i.length>=4&&(i[0]===137&&i[1]===80&&i[2]===78&&i[3]===71?z="image/png":i[0]===255&&i[1]===216&&i[2]===255?z="image/jpeg":i[0]===71&&i[1]===73&&i[2]===70?z="image/gif":i[0]===82&&i[1]===73&&i[2]===70&&i[3]===70&&i.length>=12&&i[8]===87&&i[9]===69&&i[10]===66&&i[11]===80&&(z="image/webp"));const D=new Blob([l],{type:z}),X=URL.createObjectURL(D),V=await Ta.fromURL(X);if(!V){URL.revokeObjectURL(X);return}const ne=u.indexOf(c)*20;V.set({scaleX:1,scaleY:1,left:(v-V.width)/2+ne,top:($-V.height)/2+ne,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:p.id,originalUrl:_,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),V.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(V);const me=r.getObjects().find(oe=>oe.name==="__background__");me?(r.sendObjectToBack(V),r.sendObjectToBack(me)):r.sendObjectToBack(V),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(X),1e3)}catch{}});const a=new Set(u.map(c=>{var p;return(p=se.find(d=>d.id===c.source))==null?void 0:p.id}).filter(Boolean)),b=[];R.current.forEach(c=>{if(!a.has(c)){b.push(c);const p=r.getObjects().find(d=>d.sourceNodeId===c);p&&(r.remove(p),r.requestRenderAll())}}),b.forEach(c=>R.current.delete(c))},[ce,se,j,v,$]),t.useEffect(()=>{const r=ye.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,ae===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(b=>{b.name!=="__background__"&&b.name!=="__crop__"&&(b.selectable=!1,b.evented=!1)}),L.current&&(L.current.style.display="none"),x.current){const{left:b,top:c,width:p,height:d}=x.current,k=new Zs({left:b,top:c,width:p,height:d,absolutePositioned:!0});r.clipPath=k;const _=r.getObjects().find(O=>O.name==="__background__");_&&_.set({left:b,top:c,width:p,height:d})}return}const w=ie.startsWith("#")?`%23${ie.slice(1)}`:encodeURIComponent(ie),u=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${w}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(ae==="pencil"||ae==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Lr(r);const b=(p,d)=>{const k=p.replace("#",""),_=parseInt(k.substring(0,2),16),O=parseInt(k.substring(2,4),16),I=parseInt(k.substring(4,6),16);return`rgba(${_},${O},${I},${d})`};if(r.freeDrawingBrush.color=b(ie,.7),r.freeDrawingBrush.width=ue,x.current){const{left:p,top:d,width:k,height:_}=x.current,O=new Zs({left:p,top:d,width:k,height:_,absolutePositioned:!0});r.clipPath=O;const I=r.getObjects().find(g=>g.name==="__background__");I&&I.set({left:p,top:d,width:k,height:_})}const c=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${w}' stroke-width='2.2'/></svg>") 16 16, crosshair`;ae==="pencil"?(r.freeDrawingCursor=u,r.defaultCursor=u,r.hoverCursor=u,r.moveCursor=u,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=u)):(r.freeDrawingCursor=c,r.defaultCursor=c,r.hoverCursor=c,r.moveCursor=c,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=c)),r.selection=!1,r.getObjects().forEach(p=>{p.name!=="__background__"&&p.name!=="__crop__"&&(p.selectable=!0,p.evented=!0)}),ae==="brush"&&L.current&&(L.current.style.display="block"),ae==="pencil"&&L.current&&(L.current.style.display="none")}else if(ae==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const b=r.getObjects().find(_=>_.name==="__background__");b&&b.set({left:0,top:0,width:v,height:$}),r.requestRenderAll();let c=U.current;const p=v*.1,d=v-p*2,k=$-p*2;if(!c||!r.getObjects().includes(c)){const _=x.current||{left:p,top:p,width:d,height:k};c=new Zs({left:_.left,top:_.top,width:_.width,height:_.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),U.current=c,r.add(c)}c&&(c.visible=!0,c.selectable=!0,c.evented=!0,r.setActiveObject(c),r.requestRenderAll())}else if(ae==="line"||ae==="arrow"||ae==="text"||ae==="eraser"){if(r.selection=!1,x.current){const{left:c,top:p,width:d,height:k}=x.current,_=new Zs({left:c,top:p,width:d,height:k,absolutePositioned:!0});r.clipPath=_;const O=r.getObjects().find(I=>I.name==="__background__");O&&O.set({left:c,top:p,width:d,height:k})}const b=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${w}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=ae==="text"?"text":ae==="eraser"?a:b,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),ae==="line"||ae==="arrow"?(r.hoverCursor=b,r.moveCursor=b,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(c=>{c.name!=="__background__"&&c.name!=="__crop__"&&(c.selectable=!1,c.evented=!1)}),L.current&&(L.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(c=>{c.name!=="__background__"&&c.name!=="__crop__"&&(c.selectable=!0,c.evented=!0)}),ae==="eraser"&&L.current&&(L.current.style.display="none"),ae==="eraser"&&(r.moveCursor=a,r.hoverCursor=a)),L.current&&(L.current.style.display="none")}else{if(U.current&&(U.current.visible=!1,r.discardActiveObject()),x.current){const{left:b,top:c,width:p,height:d}=x.current,k=new Zs({left:b,top:c,width:p,height:d,absolutePositioned:!0});r.clipPath=k;const _=r.getObjects().find(O=>O.name==="__background__");_&&_.set({left:b,top:c,width:p,height:d})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(b=>{b.name!=="__background__"&&b.name!=="__crop__"&&(b.selectable=!0,b.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),L.current&&(L.current.style.display="none")}},[ae,ie,ue,v,$,F,G]),t.useEffect(()=>{const r=w=>{const u=ye.current;if(u){if(w.key==="Escape")je("select");else if(w.key==="Enter"&&ae==="crop"){const a=U.current;if(a){const b=Math.max(0,Math.floor(a.left??0)),c=Math.max(0,Math.floor(a.top??0)),p=Math.max(1,Math.floor((a.width??0)*(a.scaleX??1))),d=Math.max(1,Math.floor((a.height??0)*(a.scaleY??1)));x.current={left:b,top:c,width:p,height:d};const k=new Zs({left:b,top:c,width:p,height:d,absolutePositioned:!0});u.clipPath=k;const _=u.getObjects().find(I=>I.name==="__background__");_&&_.set({left:b,top:c,width:p,height:d}),a.visible=!1,je("select"),u.requestRenderAll();const O=ye.current?()=>{const I=ye.current;if(!I)return;const g=I.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(g.objects)&&(g.objects=g.objects.map(D=>(D&&D.type==="image"&&D.originalUrl&&(D.src=D.originalUrl),D)));const l={canvasJson:g,appliedCrop:x.current},i=JSON.stringify(l);try{localStorage.setItem(`superCanvas:${j}`,i)}catch{}de(j)&&re(D=>D.map(X=>X.id===j?{...X,data:{...X.data,canvasState:i}}:X))}:null;O&&O()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[ae]),t.useEffect(()=>{const r=ye.current;if(!r)return;const w=d=>{const k=r.getPointer(d.e);if(Ie.current=!0,ee.current={x:k.x,y:k.y},(ae==="line"||ae==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(_=>{_.name!=="__background__"&&_.name!=="__crop__"&&(_.selectable=!1,_.evented=!1)})),ae==="line"){const _=[k.x,k.y,k.x,k.y],O=new or(_,{strokeWidth:ue/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round"});Q.current=O,r.add(O)}else if(ae==="arrow"){const _=[k.x,k.y,k.x,k.y],O=new or(_,{strokeWidth:ue/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});Q.current=O,r.add(O)}else if(ae==="text"){const _=new Pr("Type here",{left:k.x,top:k.y,fontFamily:"Arial",fill:ie,fontSize:ue*10,width:300,splitByGrapheme:!0});_.lockScalingY=!1,_.lockScalingFlip=!0,_.lockUniScaling=!1,_.setControlsVisibility({mt:!1,mb:!1}),r.add(_),r.setActiveObject(_),_.enterEditing(),je("select")}else if(ae==="eraser"){const _=r.getObjects();for(let O=_.length-1;O>=0;O--){const I=_[O];if(!(I.name==="__background__"||I.name==="__crop__"||I.name==="__input_image__"||I.sourceNodeId)&&I.containsPoint(k)){r.remove(I);break}}r.requestRenderAll()}},u=d=>{const k=r.getPointer(d.e);if(ae==="brush"&&L.current){const O=r.getZoom(),I=ue*O,g=I/2;L.current.style.width=`${I}px`,L.current.style.height=`${I}px`,L.current.style.left=`${k.x*O-g}px`,L.current.style.top=`${k.y*O-g}px`,L.current.style.borderColor=`rgba(${parseInt(ie.slice(1,3),16)},${parseInt(ie.slice(3,5),16)},${parseInt(ie.slice(5,7),16)},0.7)`,L.current.style.borderWidth="1px",L.current.style.background="transparent"}if(!Ie.current)return;const _=Q.current;if(ae==="line"&&_&&_ instanceof or)_.set({x2:k.x,y2:k.y}),_.setCoords(),r.requestRenderAll();else if(ae==="arrow"&&_&&_ instanceof or)_.set({x2:k.x,y2:k.y}),_.setCoords(),r.requestRenderAll();else if(ae==="eraser"){const O=r.getObjects();for(let I=O.length-1;I>=0;I--){const g=O[I];g.name==="__background__"||g.name==="__crop__"||g.name==="__input_image__"||g.sourceNodeId||g.containsPoint(k)&&r.remove(g)}r.requestRenderAll()}},a=()=>{if(Ie.current=!1,ae==="arrow"&&Q.current instanceof or){const d=Q.current,k=Math.atan2(d.y2-d.y1,d.x2-d.x1),_=Math.max(ue*10,120),O=Math.PI/6,I=-Math.cos(k),g=-Math.sin(k),l=Math.cos(O),i=Math.sin(O),z=d.x2+_*(I*l-g*i),D=d.y2+_*(I*i+g*l),X=d.x2+_*(I*l+g*i),V=d.y2+_*(-I*i+g*l),ne=d.strokeWidth||ue/2,me=new or([d.x2,d.y2,z,D],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"}),oe=new or([d.x2,d.y2,X,V],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"});r.add(me),r.add(oe);const N=new Ua([d,me,oe],{selectable:!0,evented:!0});r.remove(d),r.remove(me),r.remove(oe),r.add(N)}Q.current=null,(ae==="line"||ae==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!1,d.evented=!1)}))},b=d=>{var I;const k=d.target;if(!k)return;const _=k.type==="textbox"||k instanceof Pr,O=k.type==="i-text"||k instanceof Ra;if(_||O){const g=(I=d==null?void 0:d.transform)==null?void 0:I.corner;if(g==="ml"||g==="mr"){const l=Math.max(50,(k.width||50)*(k.scaleX||1));k.set({width:l,scaleX:1,scaleY:1})}else{const l=k.scaleX||1,i=k.fontSize||40,z=Math.max(6,Math.min(512,Math.round(i*l)));k.set({fontSize:z,scaleX:1,scaleY:1})}k.setCoords(),r.requestRenderAll()}},c=()=>{ae==="brush"&&L.current&&(L.current.style.display="block")},p=()=>{L.current&&(L.current.style.display="none")};return r.on("mouse:down",w),r.on("mouse:move",u),r.on("mouse:up",a),r.on("mouse:over",c),r.on("mouse:out",p),r.on("object:scaling",b),()=>{r.off("mouse:down",w),r.off("mouse:move",u),r.off("mouse:up",a),r.off("mouse:over",c),r.off("mouse:out",p),r.off("object:scaling",b)}},[ae,ie,ue]),e.jsxs("div",{ref:T,className:`relative flex flex-col w-[800px] h-auto bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ir,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:W,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:L,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Ir,label:"Select"},{id:"pencil",icon:Br,label:"Pencil"},{id:"brush",icon:Ma,label:"Brush"},{id:"line",icon:Ga,label:"Line"},{id:"arrow",icon:$a,label:"Arrow"},{id:"text",icon:Fa,label:"Text"},{id:"eraser",icon:Pa,label:"Eraser"},{id:"crop",icon:La,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>je(r.id),className:`p-2 rounded-lg transition-all ${ae===r.id?"bg-neutral-500/20 text-neutral-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=ye.current,w=r==null?void 0:r.getActiveObject();w&&(r==null||r.remove(w),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(zr,{size:16})}),e.jsx("button",{onClick:()=>{const r=ye.current,w=r==null?void 0:r.getActiveObject();w&&(r==null||r.bringObjectToFront(w),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Wa,{size:16})}),e.jsx("button",{onClick:()=>{const r=ye.current,w=r==null?void 0:r.getActiveObject();if(w){r==null||r.sendObjectToBack(w);const u=r==null?void 0:r.getObjects().find(a=>a.name==="__background__");u&&(r==null||r.sendObjectToBack(u)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Va,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ie,onChange:r=>xe(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:ae==="brush"?80:10,max:ae==="brush"?400:30,value:ue,onChange:r=>{const w=parseInt(r.target.value);pe(w)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:ue})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:ae==="crop",onClick:async()=>{var he,Se,Ne;const r=ye.current;if(!r)return;r.discardActiveObject();const w=[...r.viewportTransform],u=r.getWidth(),a=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(A),r.setHeight(A);const b=r.clipPath;r.clipPath=void 0;const c=x.current;let p="",d=v,k=$;c?(d=c.width,k=c.height,p=r.toDataURL({format:"png",quality:1,left:c.left,top:c.top,width:c.width,height:c.height,multiplier:1})):p=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:v,height:$}),r.clipPath=b,r.setViewportTransform(w),r.setWidth(u),r.setHeight(a),r.requestRenderAll();const _=`${d}:${k}`,O=de(j);if(!O)return;let I=p;try{const Re=p.split(",")[1],Ce=atob(Re),Ae=new Array(Ce.length);for(let Wt=0;Wt<Ce.length;Wt++)Ae[Wt]=Ce.charCodeAt(Wt);const $e=new Uint8Array(Ae),le=new Blob([$e],{type:"image/png"}),Ge=`canvas-export-${Date.now()}.png`,Qe=await _e.post("/assets/presigned-url",{fileName:Ge,contentType:"image/png"});if(Qe.success&&Qe.data){const{uploadUrl:Wt,publicUrl:Ct}=Qe.data;await(await ds(async()=>{const{default:ct}=await import("./utils-BcyDR7Vi.js");return{default:ct}},[])).default.put(Wt,le,{headers:{"Content-Type":"image/png"},timeout:3e5}),I=Ct}}catch{}const g=Ue&&((he=Ue())==null?void 0:he.zoom)||1,l=document.querySelector(`.react-flow__node[data-id="${j}"]`),i=(l==null?void 0:l.getBoundingClientRect().width)||400,z=Math.round(i/g),D=400,X=(Re,Ce=300)=>{if(!Re||!/^[0-9]+\s*:\s*[0-9]+$/.test(Re))return Ce;const[Ae,$e]=Re.split(":").map(le=>parseFloat(le));return!Ae||!$e?Ce:Math.round(D*($e/Ae))},V=200,ne=100,me=X(_,300),oe=fe(),N=Z(),E=oe.filter(Re=>Re.type==="imagePreview"&&N.some(Ce=>Ce.source===j&&Ce.target===Re.id)).length,y=O.position.x+z+V,J=O.position.y+E*(me+ne),ge={id:`preview-${j}-${Date.now()}`,type:"imagePreview",position:{x:y,y:J},data:{imageUrl:I,width:D,ratio:_,workflowContext:(Se=O.data)==null?void 0:Se.workflowContext,createdBy:(Ne=O.data)==null?void 0:Ne.createdBy}};re(Re=>[...Re,ge]);const B={id:`edge-${j}-${ge.id}`,source:j,target:ge.id,targetHandle:`${ge.id}-target`,type:"aurora"};K(Re=>Re.find(Ae=>Ae.source===j&&Ae.target===ge.id)?Re:[...Re,B])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:cursor-not-allowed disabled:hover:shadow-md",title:ae==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(St,{type:"target",position:ut.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(St,{type:"source",position:ut.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Fo=t.memo(Wo),zo=({data:s,selected:j,id:n})=>{const[W,ye]=t.useState(s.config.upscaleResolution||"1080p"),[T,fe]=t.useState(!1),[Z,re]=t.useState(s.config.inputVideoUrl||""),[,K]=t.useState(s.config.taskId||""),{setNodes:de,setEdges:Ue}=Zt(),ce=Ls(),se=zs(),ae=ue=>{de(pe=>pe.map(Ie=>Ie.id===n?{...Ie,data:{...Ie.data,config:{...Ie.data.config,...ue}}}:Ie))};t.useEffect(()=>{var pe,Ie,ee;const ue=se.filter(Q=>Q.target===n);if(ue.length>0){const Q=ce.find(U=>U.id===ue[0].source);if(Q){const U=Q.data,R=U.videoUrl||((pe=U.config)==null?void 0:pe.videoUrl)||((Ie=U.config)==null?void 0:Ie.outputVideoUrl)||((ee=U.config)==null?void 0:ee.resultUrl);R&&R!==Z&&(re(R),ae({inputVideoUrl:R}))}}else Z&&(re(""),ae({inputVideoUrl:""}))},[se,ce,n]),t.useEffect(()=>{const ue=s.config.taskId;(async()=>{if(ue)try{const ee=(await _e.get(`/tasks/${ue}`)).task;if(ee.status==="SUCCESS"){const Q=ee.resultUrl;ae({outputVideoUrl:Q,taskId:""}),se.filter(f=>f.source===n).map(f=>ce.find(x=>x.id===f.target)).filter(f=>f&&f.type==="videoPreview").find(f=>f.data.videoUrl===Q)||ie(Q),Gt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),fe(!1)}else ee.status==="PROCESSING"||ee.status==="PENDING"?(fe(!0),je(ue)):ee.status==="FAILURE"&&(fe(!1),ae({taskId:""}),Gt.error(ee.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${ee.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{fe(!1),ae({taskId:""}),Gt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const je=async ue=>{let Ie=0;const ee=async()=>{try{Ie++;const U=(await _e.get(`/tasks/${ue}`)).task;if(U.status==="SUCCESS"){const R=U.resultUrl;fe(!1),ae({outputVideoUrl:R,taskId:""}),ie(R),Gt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(U.status==="FAILURE"){fe(!1),ae({taskId:""}),Gt.error(U.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(U.status==="PROCESSING"||U.status==="PENDING")&&(Ie<300?setTimeout(ee,3e3):(fe(!1),ae({taskId:""}),Gt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{fe(!1),ae({taskId:""}),Gt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};ee()},ie=ue=>{var Ie;const pe=ce.find(ee=>ee.id===n);if(pe){const ee=`preview-video-${Date.now()}`,Q=W==="1080p"?"HD":W,U={id:ee,type:"videoPreview",position:{x:pe.position.x+400,y:pe.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:ue,ratio:"16:9",resolution:Q,createdBy:(Ie=pe.data)==null?void 0:Ie.createdBy}},R={id:`edge-${n}-${ee}`,source:n,target:ee,type:"aurora"};de(L=>[...L,U]),setTimeout(()=>{Ue(L=>[...L,R])},100)}},xe=async()=>{var ue,pe;if(!Z){Gt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}fe(!0);try{const Ie=await _e.get("/ai/models?provider=vidu&isActive=true");if(!Ie||Ie.length===0){Gt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),fe(!1);return}const ee=Ie[0],U=(await _e.post("/ai/video-upscale",{video_url:Z,upscale_resolution:W,apiKey:ee.apiKey,apiUrl:ee.apiUrl})).taskId;K(U),ae({taskId:U,upscaleResolution:W}),Gt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),je(U)}catch(Ie){const ee=((pe=(ue=Ie.response)==null?void 0:ue.data)==null?void 0:pe.error)||Ie.message||"æœªçŸ¥åŸå› ";Gt.error(`å¯åŠ¨å¤±è´¥ï¼š${ee}ï¼Œè¯·ç¨åé‡è¯•`),fe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[Z&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:Z,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(ue=>e.jsx("button",{type:"button",onClick:()=>{ye(ue),ae({upscaleResolution:ue})},disabled:T,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${W===ue?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${T?"cursor-not-allowed":""}`,children:ue},ue))})]}),e.jsx("button",{type:"button",onClick:ue=>{ue.preventDefault(),ue.stopPropagation(),xe()},onMouseDown:ue=>{ue.stopPropagation()},disabled:T||!Z||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${T||!Z||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[T?e.jsx(Ds,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:T?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(gs,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Bo=t.memo(zo),Ho=({data:s,selected:j,id:n})=>{const[W,ye]=t.useState(s.config.prompt||""),[T,fe]=t.useState(s.config.duration||30),[Z,re]=t.useState(s.config.ratio||"16:9"),[K,de]=t.useState(s.config.language||"zh"),[Ue,ce]=t.useState(!1),[se,ae]=t.useState(s.config.images||[]),[,je]=t.useState(s.config.taskId||""),{credits:ie,loading:xe}=Ss({nodeType:"ad_composition",duration:T}),{setNodes:ue,setEdges:pe}=Zt(),Ie=Ls(),ee=zs(),Q=f=>{ue(x=>x.map(A=>A.id===n?{...A,data:{...A.data,config:{...A.data.config,...f}}}:A))};t.useEffect(()=>{const f=ee.filter(A=>A.target===n),x=[];f.forEach(A=>{var G,v,$,r,w,u,a,b,c,p;const F=Ie.find(d=>d.id===A.source);F&&(F.type==="imagePreview"&&((G=F.data)!=null&&G.imageUrl)?x.push(F.data.imageUrl):F.type==="aiImage"&&(($=(v=F.data)==null?void 0:v.config)!=null&&$.generatedImageUrl)?x.push(F.data.config.generatedImageUrl):F.type==="upload"&&((w=(r=F.data)==null?void 0:r.config)!=null&&w.uploadedFiles)?F.data.config.uploadedFiles.filter(k=>k.type==="IMAGE"||(k.mimeType||"").startsWith("image/")).forEach(k=>x.push(k.url)):F.type==="assetSelector"&&((a=(u=F.data)==null?void 0:u.config)!=null&&a.subjects?F.data.config.subjects.forEach(k=>{Array.isArray(k.images)&&k.images.forEach(_=>x.push(_.url))}):((p=(c=(b=F.data)==null?void 0:b.config)==null?void 0:c.selectedAsset)==null?void 0:p.type)==="IMAGE"&&x.push(F.data.config.selectedAsset.url)))}),JSON.stringify(x)!==JSON.stringify(se)&&(ae(x),Q({images:x}))},[ee,Ie,n]),t.useEffect(()=>{const f=s.config.taskId;(async()=>{if(f)try{const F=(await _e.get(`/tasks/${f}`)).task;if(F.status==="SUCCESS"){const G=F.resultUrl;Q({taskId:""}),ce(!1)}else F.status==="PROCESSING"||F.status==="PENDING"?(ce(!0),U(f)):F.status==="FAILURE"&&(ce(!1),Q({taskId:""}),Gt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${F.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ce(!1),Q({taskId:""})}})()},[]);const U=async f=>{let A=0;const F=async()=>{try{A++;const v=(await _e.get(`/tasks/${f}`)).task;if(v.status==="SUCCESS"){const $=v.resultUrl;ce(!1),Q({taskId:""}),R($),Gt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(v.status==="FAILURE"){ce(!1),Q({taskId:""}),Gt.error(v.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(v.status==="PROCESSING"||v.status==="PENDING")&&(A<120?setTimeout(F,1e4):(ce(!1),Q({taskId:""}),Gt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ce(!1),Q({taskId:""}),Gt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};F()},R=f=>{var A;const x=Ie.find(F=>F.id===n);if(x){const F=`preview-video-${Date.now()}`,G={id:F,type:"videoPreview",position:{x:x.position.x+400,y:x.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:f,ratio:Z,width:320,createdBy:(A=x.data)==null?void 0:A.createdBy}},v={id:`edge-${n}-${F}`,source:n,target:F,type:"aurora"};ue($=>[...$,G]),setTimeout(()=>{pe($=>[...$,v])},100)}},L=async()=>{var f,x,A,F,G;if(se.length===0){Gt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(se.length>15){Gt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!W.trim()){Gt.error("è¯·è¾“å…¥æç¤ºè¯");return}ce(!0);try{const v=await _e.get("/ai/models?provider=vidu&isActive=true");if(!v||v.length===0){Gt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),ce(!1);return}const $=v[0],r={images:se,prompt:W,duration:T,ratio:Z,language:K,apiKey:$.apiKey,apiUrl:$.apiUrl},w=await _e.post("/ai/commercial-video",r),u=w.taskId,a=w.creditsCharged||0;if(je(u),Q({taskId:u,images:se,prompt:W,duration:T,ratio:Z,language:K}),a>0)try{const{useAuthStore:b}=await ds(async()=>{const{useAuthStore:p}=await import("./index-Dg_hJ4va.js").then(d=>d.f);return{useAuthStore:p}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:c}=b.getState();await c(),Gt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${a} ç§¯åˆ†ï¼‰`)}catch{Gt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Gt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");U(u)}catch(v){((f=v.response)==null?void 0:f.status)===403?Gt.error(((A=(x=v.response)==null?void 0:x.data)==null?void 0:A.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Gt.error(((G=(F=v.response)==null?void 0:F.data)==null?void 0:G.error)||v.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),ce(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",se.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:W,onChange:f=>{ye(f.target.value),Q({prompt:f.target.value}),f.target.style.height="auto",f.target.style.height=f.target.scrollHeight+"px"},onFocus:f=>{f.target.style.height="auto",f.target.style.height=f.target.scrollHeight+"px"},ref:f=>{f&&W&&(f.style.height="auto",f.style.height=f.scrollHeight+"px")},disabled:Ue,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(f=>e.jsxs("button",{type:"button",onClick:()=>{fe(f),Q({duration:f})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${T===f?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ue?"cursor-not-allowed":""}`,children:[f,"s"]},f))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(f=>e.jsx("button",{type:"button",onClick:()=>{re(f),Q({ratio:f})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Z===f?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ue?"cursor-not-allowed":""}`,children:f},f))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(f=>e.jsx("button",{type:"button",onClick:()=>{de(f.value),Q({language:f.value})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${K===f.value?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ue?"cursor-not-allowed":""}`,children:f.label},f.value))})]}),e.jsx("button",{type:"button",onClick:L,disabled:Ue||se.length===0||!W.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Ue||se.length===0||!W.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Ue?e.jsx(Ds,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),e.jsx("span",{children:Ue?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Ue&&!xe&&ie!==null&&ie>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ie,"ç§¯åˆ†"]})]})})]}),e.jsx(gs,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Xo=t.memo(Ho),Jo=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],qo=({data:s,selected:j,id:n})=>{const{setNodes:W}=Zt(),[ye,T]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[fe,Z]=t.useState(!1),[re,K]=t.useState(!1),[de,Ue]=t.useState(s.fontSize||36),[ce,se]=t.useState(s.width||200),[ae,je]=t.useState(s.bold||!1),ie=t.useRef(null),xe=t.useRef(null),ue=t.useCallback(ee=>{W(Q=>Q.map(U=>U.id===n?{...U,data:{...U.data,...ee}}:U))},[n,W]);t.useEffect(()=>{const ee=setTimeout(()=>{ye!==s.text&&ue({text:ye})},300);return()=>clearTimeout(ee)},[ye,s.text,ue]),t.useEffect(()=>{ue({fontSize:de,width:ce,bold:ae})},[de,ce,ae,ue]);const pe=()=>{Z(!0),setTimeout(()=>{ie.current&&(ie.current.focus(),ie.current.select(),ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},0)},Ie=()=>{Z(!1)};return t.useEffect(()=>{fe&&ie.current&&(ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},[fe,ye]),t.useEffect(()=>{const ee=Q=>{xe.current&&!xe.current.contains(Q.target)&&K(!1)};return re&&document.addEventListener("mousedown",ee),()=>document.removeEventListener("mousedown",ee)},[re]),e.jsxs("div",{className:`relative group ${j?"ring-2 ring-neutral-400 ring-offset-2":""}`,style:{width:ce},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:ee=>{ee.stopPropagation(),K(!re)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),re&&e.jsxs("div",{ref:xe,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:ee=>ee.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:de,onChange:ee=>Ue(Number(ee.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-neutral-400",children:Jo.map(ee=>e.jsxs("option",{value:ee,children:[ee,"px"]},ee))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>je(!ae),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${ae?"bg-neutral-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),fe?e.jsx("textarea",{ref:ie,value:ye,onChange:ee=>T(ee.target.value),onBlur:Ie,onMouseDown:ee=>ee.stopPropagation(),onKeyDown:ee=>{ee.key==="Escape"&&Z(!1)},className:"nodrag w-full bg-transparent border-2 border-neutral-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${de}px`,fontWeight:ae?"bold":"normal"}}):e.jsx("div",{onDoubleClick:pe,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${de}px`,fontWeight:ae?"bold":"normal"},children:ye}),!fe&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:ee=>{ee.stopPropagation(),ee.preventDefault();const Q=ee.clientX,U=ce,R=f=>{f.preventDefault();const x=Math.max(100,U+(f.clientX-Q));se(x)},L=()=>{document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",L)};document.addEventListener("mousemove",R),document.addEventListener("mouseup",L)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Yo=t.memo(qo),Ko=({data:s,id:j,selected:n})=>{const{getNode:W,setNodes:ye,setEdges:T}=Zt(),fe=Fs(t.useCallback(l=>l.edges.filter(i=>i.target===j),[j])),[Z,re]=t.useState(s.prompt||""),[K,de]=t.useState(s.points||[]),[Ue,ce]=t.useState(!1),[se,ae]=t.useState(!1),[je,ie]=t.useState(null),[xe,ue]=t.useState([]),[,pe]=t.useState(s.generatedImageUrl||null),[Ie,ee]=t.useState(null),[,Q]=t.useState(s.taskId||""),[,U]=t.useState(0),R=t.useRef(null),L=t.useRef(1),{credits:f,loading:x,isFreeUsage:A,freeUsageRemaining:F,refetch:G}=Ss({nodeType:"image_editing",quantity:1}),v=t.useCallback(l=>{ye(i=>i.map(z=>z.id===j?{...z,data:{...z.data,...l}}:z))},[j,ye]),$=Fs(t.useCallback(l=>l.edges.filter(i=>i.source===j),[j])),r=t.useCallback(l=>{var ne,me;const i=W(j);if(!i)return;const z=$.find(oe=>{const N=W(oe.target);return(N==null?void 0:N.type)==="imagePreview"});if(z){const oe=z.target;ye(N=>N.map(h=>h.id===oe?{...h,data:{...h.data,imageUrl:l}}:h));return}const D=Date.now(),X=`preview-${j}-${D}`,V={id:X,type:"imagePreview",position:{x:(((ne=i==null?void 0:i.position)==null?void 0:ne.x)||0)+450,y:((me=i==null?void 0:i.position)==null?void 0:me.y)||0},data:{imageUrl:l,width:400}};setTimeout(()=>{ye(N=>[...N,V]);const oe={id:`edge-${j}-${X}`,source:j,target:X,targetHandle:`${X}-target`,type:"aurora"};T(N=>N.find(E=>E.source===j&&E.target===X)?N:[...N,oe])},100)},[j,W,ye,T,$]),w=t.useRef({active:!1,timeoutId:null}),u=t.useCallback(async l=>{let z=0;w.current.timeoutId&&clearTimeout(w.current.timeoutId),w.current.active=!0;const D=async()=>{if(w.current.active)try{z++;const V=(await _e.tasks.getTaskStatus(l)).task;if(!w.current.active)return;if(U(V.progress||0),V.status==="SUCCESS"){w.current.active=!1,ce(!1),U(100);const ne=V.resultUrl;v({generatedImageUrl:ne,taskId:""}),pe(ne),m.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ne&&r(ne);return}else if(V.status==="FAILURE"){w.current.active=!1,ce(!1),U(0),v({taskId:""}),m.error(V.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(V.status==="PROCESSING"||V.status==="PENDING")&&(z<300&&w.current.active?w.current.timeoutId=setTimeout(D,1e3):(w.current.active=!1,ce(!1),U(0),v({taskId:""}),m.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{w.current.active=!1,ce(!1),U(0),v({taskId:""}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};D()},[v,r]);t.useEffect(()=>()=>{w.current.active=!1,w.current.timeoutId&&clearTimeout(w.current.timeoutId)},[]),t.useEffect(()=>{const l=s.taskId;if(!l)return;(async()=>{try{const D=(await _e.tasks.getTaskStatus(l)).task;if(D.status==="SUCCESS"){ce(!1),U(100);const X=D.resultUrl;X?(v({generatedImageUrl:X,taskId:""}),pe(X),m.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):v({taskId:""})}else D.status==="PROCESSING"||D.status==="PENDING"?(ce(!0),U(D.progress||0),u(l)):D.status==="FAILURE"&&(ce(!1),U(0),v({taskId:""}),m.error(D.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${D.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{ce(!1),U(0),v({taskId:""})}})()},[]);const a=t.useCallback(l=>{const i=new Image;i.onload=()=>{ee({width:i.naturalWidth,height:i.naturalHeight})},i.src=l},[]);t.useEffect(()=>{try{const l=[];fe.forEach(i=>{var V,ne,me,oe;const z=W(i.source);if(!z)return;const D=z.data;let X=null;D!=null&&D.url?X=D.url:D!=null&&D.imageUrl?X=D.imageUrl:D!=null&&D.output?X=D.output:(V=D==null?void 0:D.config)!=null&&V.generatedImageUrl?X=D.config.generatedImageUrl:(oe=(me=(ne=D==null?void 0:D.config)==null?void 0:ne.uploadedFiles)==null?void 0:me[0])!=null&&oe.url&&(X=D.config.uploadedFiles[0].url),X&&l.push(X)}),l.length>0?(ie(l[0]),ue(l.slice(1)),a(l[0])):(ie(null),ue([]),ee(null))}catch{}},[fe,W,a]),t.useEffect(()=>{const l=setTimeout(()=>{ye(i=>i.map(z=>{if(z.id!==j)return z;const D=z.data;return D.prompt===Z&&JSON.stringify(D.points)===JSON.stringify(K)?z:{...z,data:{...z.data,prompt:Z,points:K}}}))},300);return()=>clearTimeout(l)},[Z,K,j,ye]);const b=t.useCallback(l=>{if(!l.ctrlKey&&!l.metaKey||!R.current)return;const i=R.current.getBoundingClientRect(),z=(l.clientX-i.left)/i.width,D=(l.clientY-i.top)/i.height,X={id:L.current++,x:Math.max(0,Math.min(1,z)),y:Math.max(0,Math.min(1,D))};de(V=>[...V,X])},[]),c=t.useCallback(l=>{de(i=>i.filter(z=>z.id!==l))},[]),p=t.useCallback((l,i)=>{de(z=>z.map(D=>D.id===l?{...D,name:i}:D))},[]),d=t.useCallback((l,i)=>{l.stopPropagation();const z=i.name?`@${i.name}`:`@ä½ç½®${i.id}`;l.dataTransfer.setData("text/plain",z),l.dataTransfer.effectAllowed="copy"},[]),k=t.useCallback((l,i)=>{l.stopPropagation();const z=`@å‚è€ƒå›¾${i+1}`;l.dataTransfer.setData("text/plain",z),l.dataTransfer.effectAllowed="copy"},[]),_=t.useCallback(l=>{l.preventDefault(),l.stopPropagation(),l.dataTransfer.dropEffect="copy"},[]),O=t.useCallback(l=>{l.preventDefault(),l.stopPropagation();const i=l.dataTransfer.getData("text/plain");if(i){const z=l.target,D=z.selectionStart,X=z.selectionEnd,V=Z.slice(0,D)+i+Z.slice(X);re(V),setTimeout(()=>{z.selectionStart=z.selectionEnd=D+i.length,z.focus()},0)}},[Z]),I=t.useCallback(async()=>{var l;if(!(!je||K.length===0)){ae(!0);try{const i=await _e.ai.imageEditing.identifyPoints({image:je,points:K.map(z=>({id:z.id,x:z.x,y:z.y}))});if(i.success&&((l=i.data)!=null&&l.points)){const z=i.data.points;de(D=>D.map(X=>{const V=z.find(ne=>ne.id===X.id);return V?{...X,name:V.name}:X})),m.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{m.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{ae(!1)}}},[je,K]),g=t.useCallback(async()=>{var l,i,z,D,X;if(!je){m.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!Z.trim()){m.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}ce(!0),U(0);try{const V=await _e.tasks.createImageEditTask({prompt:Z.trim(),mainImage:je,referenceImages:xe.length>0?xe:void 0,points:K.length>0?K:void 0,sourceImageDimensions:Ie||void 0,sourceNodeId:j}),ne=V.taskId,me=V.creditsCharged||0,oe=V.isFreeUsage,N=V.freeUsageRemaining??0;if(Q(ne),v({prompt:Z.trim(),points:K,taskId:ne}),oe)m.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${N} æ¬¡æœºä¼š`),G();else if(me>0){const{useAuthStore:h}=await ds(async()=>{const{useAuthStore:y}=await import("./index-Dg_hJ4va.js").then(J=>J.f);return{useAuthStore:y}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:E}=h.getState();await E(),m.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${me} ç§¯åˆ†`),G()}else m.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");u(ne)}catch(V){if(ce(!1),U(0),((l=V.response)==null?void 0:l.status)===403){const ne=((z=(i=V.response)==null?void 0:i.data)==null?void 0:z.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";m.error(ne)}else{const ne=((X=(D=V.response)==null?void 0:D.data)==null?void 0:X.error)||V.message||"æœªçŸ¥åŸå› ";m.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ne}ï¼Œè¯·ç¨åé‡è¯•`)}}},[je,Z,xe,K,Ie,j,v,u,G]);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Br,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:R,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:b,children:je?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:je,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),K.map(l=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-neutral-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${l.x*100}%`,top:`${l.y*100}%`},onClick:i=>{i.stopPropagation(),c(l.id)},title:l.name||`ç‚¹å‡»åˆ é™¤ #${l.id}`,children:l.id},l.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ir,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),xe.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[xe.map((l,i)=>e.jsx("img",{src:l,alt:`Ref ${i+1}`,draggable:!0,onDragStart:z=>k(z,i),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},i)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",xe.length," å‚è€ƒå›¾"]})]}),K.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",K.length,")"]}),e.jsxs("button",{onClick:I,disabled:se||!je,className:"text-[10px] text-neutral-500 hover:text-neutral-600 flex items-center gap-1",children:[se?e.jsx(Ds,{className:"w-3 h-3 animate-spin"}):e.jsx(pr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:K.map(l=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:i=>d(i,l),className:"w-5 h-5 bg-neutral-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:l.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:l.name||"",onChange:i=>p(l.id,i.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>c(l.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(zr,{className:"w-3 h-3"})})]},l.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:Z,onChange:l=>re(l.target.value),onDragOver:_,onDrop:O,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:g,onPointerDown:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),disabled:Ue||!je||!Z.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Ue||!je||!Z.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Ue?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(pr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!x&&(A?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(F),"æ¬¡"]}):f!==null&&f>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[f,"ç§¯åˆ†"]}):null)]})})]})]})},Zo=t.memo(Ko);async function cr(s){const{resultUrl:j,allImageUrls:n}=s;return{displayUrl:j,allDisplayUrls:n,isLocalStored:!1,originalUrl:j}}const Qo="gemini-3-pro-image-preview",en=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],tn=s=>{const[j,n]=s.split(":").map(Number);return j/n},sn=(s,j)=>{const n=s/j;let W="1:1",ye=1/0;for(const T of en){const fe=tn(T),Z=Math.abs(n-fe);Z<ye&&(ye=Z,W=T)}return W},rn=s=>new Promise((j,n)=>{const W=new Image;W.onload=()=>{j({width:W.naturalWidth,height:W.naturalHeight})},W.onerror=n,W.src=s}),an=({data:s,selected:j,id:n})=>{const[W,ye]=t.useState(s.config.imageSize||"2K"),[T,fe]=t.useState(s.config.inputImage),[Z,re]=t.useState(!!s.config.taskId),[K,de]=t.useState(null),Ue=t.useMemo(()=>{const L=s.models||[];return L.find(f=>f.modelId===Qo)||L.find(f=>{var x;return(x=f.modelId)==null?void 0:x.includes("gemini")})||L[0]},[s.models]),{credits:ce,loading:se,isFreeUsage:ae,freeUsageRemaining:je}=Ss({nodeType:"hd_upscale",quantity:1,resolution:W});t.useEffect(()=>{Ue&&de(Ue)},[Ue]);const{setNodes:ie,setEdges:xe,getNode:ue,getNodes:pe}=Zt(),Ie=Fs(L=>L.edges.filter(f=>f.target===n));t.useEffect(()=>{const L=pe();let f;Ie.forEach(x=>{var F,G,v,$,r,w;const A=L.find(u=>u.id===x.source);if(A){const u=((F=A.data)==null?void 0:F.imageUrl)||((v=(G=A.data)==null?void 0:G.config)==null?void 0:v.generatedImageUrl)||((r=($=A.data)==null?void 0:$.config)==null?void 0:r.imageUrl)||((w=A.data)==null?void 0:w.url);u&&(f=u)}}),f!==T&&(fe(f),ee({inputImage:f}))},[Ie,pe]),t.useEffect(()=>{const L=s.config.taskId;(async()=>{if(L)try{const A=(await _e.tasks.getTaskStatus(L)).task;if(A.status==="SUCCESS"){re(!1);const F=A.resultUrl;if(!F){ee({taskId:""});return}const v=(await cr({taskId:L,resultUrl:F,type:"IMAGE"})).displayUrl;ee({generatedImageUrl:v,taskId:""})}else A.status==="PROCESSING"||A.status==="PENDING"?(re(!0),U(L)):A.status==="FAILURE"&&(re(!1),ee({taskId:""}),$s.error(`ç”Ÿæˆå¤±è´¥: ${A.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{re(!1),ee({taskId:""}),$s.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const ee=L=>{ie(f=>f.map(x=>x.id===n?{...x,data:{...x.data,config:{...x.data.config,...L}}}:x))},Q=async()=>{var L;if(!T){$s.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}re(!0);try{const f=await dr(T);let x="1:1";try{const $=await rn(T);x=sn($.width,$.height)}catch{}let A="";try{const $=await _e.get("/node-prompts/type/hdUpscale");$.success&&((L=$.data)!=null&&L.userPromptTemplate)&&(A=$.data.userPromptTemplate)}catch{}if(A||(A="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),A=`${A}ï¼Œç”Ÿæˆ${x}æ¯”ä¾‹çš„å›¾ç‰‡`,!K){$s.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),re(!1);return}const F=await _e.tasks.createImageTask({modelId:K.id,prompt:A,ratio:x,referenceImages:[f],sourceNodeId:n,metadata:{imageSize:W,nodeType:"hd_upscale"}});if(!F.success)throw new Error(F.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const G=F.taskId,v=F.creditsCharged||0;if(ee({taskId:G}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),v>0){const{useAuthStore:$}=await ds(async()=>{const{useAuthStore:w}=await import("./index-Dg_hJ4va.js").then(u=>u.f);return{useAuthStore:w}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:r}=$.getState();await r(),$s.success(`âœ¨ é«˜æ¸…æ”¾å¤§å·²å¼€å§‹ï¼Œæ¶ˆè€— ${v} ç§¯åˆ†`)}U(G)}catch(f){$s.error(f.message||"ç”Ÿæˆå¤±è´¥"),re(!1)}},U=async L=>{let x=0;const A=async()=>{try{const G=(await _e.tasks.getTaskStatus(L)).task;if(G.status==="SUCCESS"){re(!1);const v=G.resultUrl;if(!v){$s.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const r=(await cr({taskId:L,resultUrl:v,type:"IMAGE"})).displayUrl;ee({generatedImageUrl:r,taskId:"",imageSize:W}),R(r),$s.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else G.status==="FAILURE"?(re(!1),ee({taskId:""}),$s.error(`ç”Ÿæˆå¤±è´¥: ${G.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(G.status==="PROCESSING"||G.status==="PENDING")&&(x++,x<300?setTimeout(A,2e3):(re(!1),$s.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{re(!1),$s.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};A()},R=L=>{const f=ue(n);if(!f)return;const F=pe().filter(w=>w.id.startsWith(`${n}-preview`)&&w.type==="imagePreview").length,$={id:`${n}-preview-${Date.now()}`,type:"imagePreview",position:{x:f.position.x+380,y:f.position.y+F*(220+20)},data:{imageUrl:L,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:n,createdBy:f.data.createdBy}},r={id:`edge-${n}-to-${$.id}`,source:n,target:$.id,sourceHandle:`${n}-source`,type:"aurora"};ie(w=>[...w,$]),xe(w=>[...w,r])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(gs,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:T,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{ye("2K"),ee({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${W==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{ye("4K"),ee({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${W==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:Q,onPointerDown:L=>L.stopPropagation(),onMouseDown:L=>L.stopPropagation(),disabled:Z||!T||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Z||!T?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Z?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"}),!se&&(ae?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(je),"æ¬¡"]}):ce!==null&&ce>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ce,"ç§¯åˆ†"]}):null)]})})]})]})},on=t.memo(an),Xr=async(s,j,n)=>new Promise((W,ye)=>{const T=new Image;T.crossOrigin="Anonymous",T.onload=()=>{try{const fe=T.width,Z=T.height,re=Math.floor(fe/n),K=Math.floor(Z/j),de=[],Ue=document.createElement("canvas");Ue.width=re,Ue.height=K;const ce=Ue.getContext("2d");if(!ce){ye(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let se=0;se<j;se++)for(let ae=0;ae<n;ae++)ce.clearRect(0,0,re,K),ce.drawImage(T,ae*re,se*K,re,K,0,0,re,K),de.push(Ue.toDataURL("image/png"));W({slices:de,fullImage:s,rows:j,cols:n})}catch(fe){ye(fe)}},T.onerror=()=>{ye(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),T.src=s}),Fr=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},nn=(s,j="image/png")=>{const n=s.includes(",")?s.split(",")[1]:s,W=atob(n),ye=new Array(W.length);for(let fe=0;fe<W.length;fe++)ye[fe]=W.charCodeAt(fe);const T=new Uint8Array(ye);return new Blob([T],{type:j})},ln=({data:s,selected:j,id:n})=>{const[W,ye]=t.useState(null),T="single",[fe,Z]=t.useState(s.config.aspectRatio||"16:9"),[re,K]=t.useState(s.config.imageSize||"4K"),[de,Ue]=t.useState(s.config.userPrompt||""),[ce,se]=t.useState(!!s.config.taskId),[ae,je]=t.useState(s.config.characterImages||[]),[ie,xe]=t.useState(s.config.sceneImages||[]),[ue,pe]=t.useState(s.config.styleImage),Ie=t.useRef(null),{setNodes:ee,setEdges:Q,getNode:U,getNodes:R,getEdges:L}=Zt(),f=Fs(I=>I.edges.filter(g=>g.target===n)),x=Fs(I=>I.edges.some(g=>g.target===n&&g.targetHandle===`${n}-scene-input`)),A=Fs(I=>I.edges.some(g=>g.target===n&&g.targetHandle===`${n}-style-input`)),F=t.useRef(""),{credits:G,loading:v,isFreeUsage:$,freeUsageRemaining:r}=Ss({nodeType:"image_fusion",quantity:1,resolution:re}),w="gemini-3-pro-image-preview",u=t.useMemo(()=>{const I=s.models||[];return I.find(g=>g.modelId===w)||I.find(g=>{var l;return(l=g.modelId)==null?void 0:l.includes("gemini")})||I[0]},[s.models]);t.useEffect(()=>{u&&ye(u)},[u]),t.useEffect(()=>{const I=s.config.taskId,g=s.config.generatedImageUrl;(async()=>{if(I)try{const z=(await _e.tasks.getTaskStatus(I)).task;if(z.status==="SUCCESS"){se(!1);const D=z.resultUrl;if(!D){a({taskId:""}),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let X=D;g?X=g:X=(await cr({taskId:I,resultUrl:D,type:"IMAGE"})).displayUrl,a({generatedImageUrl:X,taskId:""});const V=R(),ne=L();if(V.filter(N=>N.type==="imagePreview"&&ne.some(h=>h.source===n&&h.target===N.id)).find(N=>N.data.imageUrl===X||N.data.imageUrl===D)){m.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}m.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),_(X,fe,0)}else z.status==="PROCESSING"||z.status==="PENDING"?(se(!0),d(I)):z.status==="FAILURE"&&(se(!1),a({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${z.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{se(!1),a({taskId:""}),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ie.current&&de){const I=Ie.current;I.style.height="auto",I.style.height=`${I.scrollHeight}px`}},[]);const a=I=>{ee(g=>g.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,...I}}}:l))};t.useEffect(()=>{const I=JSON.stringify(f.map(z=>({source:z.source,sourceHandle:z.sourceHandle,targetHandle:z.targetHandle})));if(I===F.current)return;F.current=I;const g=[],l=[];let i;f.forEach(z=>{const D=U(z.source);if(!D)return;const X=z.targetHandle||"",V=b(D);X.includes("character")?g.push(...V):X.includes("scene")?l.length===0&&V.length>0&&l.push(V[0]):X.includes("style")&&V.length>0&&(i=V[0])}),je(g),xe(l),pe(i),a({characterImages:g,sceneImages:l,styleImage:i})},[f,U]);const b=I=>{var i,z,D,X;const g=(I==null?void 0:I.type)||"",l=I==null?void 0:I.data;if(g==="upload"&&((i=l==null?void 0:l.config)!=null&&i.uploadedFiles))return l.config.uploadedFiles.filter(V=>{var ne;return V.type==="IMAGE"||((ne=V.mimeType)==null?void 0:ne.startsWith("image/"))}).map(V=>V.url||V.localUrl);if(g==="assetSelector"&&((z=l==null?void 0:l.config)!=null&&z.selectedAsset)){const V=l.config.selectedAsset;if(V.type==="IMAGE"||(D=V.mimeType)!=null&&D.startsWith("image/"))return[V.url]}return g==="imagePreview"&&(l!=null&&l.imageUrl)?[l.imageUrl]:g==="aiImage"&&((X=l==null?void 0:l.config)!=null&&X.generatedImageUrl)?[l.config.generatedImageUrl]:[]},c=()=>{let I=de;if(ue){const g=ae.length+ie.length+1;I+=`ï¼Œå‚è€ƒå›¾ç‰‡${g}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${g}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return I+=`ï¼Œç”Ÿæˆ${fe}æ¯”ä¾‹çš„å›¾ç‰‡`,I},p=async()=>{if(!de.trim()){m.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!W){m.error("è¯·é€‰æ‹©æ¨¡å‹");return}se(!0);try{const I=c(),g=[...ae,...ie,...ue?[ue]:[]],l=await Promise.all(g.map(async X=>{try{return await dr(X)}catch{return X}})),i=await _e.tasks.createImageTask({modelId:W.id,prompt:I,ratio:fe,referenceImages:l.filter(Boolean),sourceNodeId:n,metadata:{imageSize:re,nodeType:"image_fusion"}});if(!i.success)throw new Error(i.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const z=i.taskId,D=i.creditsCharged||0;if(a({taskId:z}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),D>0){const{useAuthStore:X}=await ds(async()=>{const{useAuthStore:ne}=await import("./index-Dg_hJ4va.js").then(me=>me.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:V}=X.getState();await V(),m.success(`âœ¨ æ™ºèƒ½æº¶å›¾å·²å¼€å§‹ï¼Œæ¶ˆè€— ${D} ç§¯åˆ†`)}d(z)}catch(I){m.error(I.message||"ç”Ÿæˆå¤±è´¥"),se(!1)}},d=async I=>{let l=0;const i=async()=>{try{const D=(await _e.tasks.getTaskStatus(I)).task;if(D.status==="SUCCESS"){se(!1);const X=D.resultUrl;if(!X){m.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ne=(await cr({taskId:I,resultUrl:X,type:"IMAGE"})).displayUrl;a({generatedImageUrl:ne,taskId:"",modelId:W==null?void 0:W.id,mode:T,aspectRatio:fe,imageSize:re,userPrompt:de}),T!=="single"||_(ne,fe,0),m.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else D.status==="FAILURE"?(se(!1),a({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${D.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(D.status==="PROCESSING"||D.status==="PENDING")&&(l++,l<300?setTimeout(i,2e3):(se(!1),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{se(!1),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};i()},k=async I=>{try{const{rows:g,cols:l}=Fr(T),i=await Xr(I,g,l);a({slicedImages:i.slices}),i.slices.forEach((z,D)=>{_(z,fe,D)})}catch(g){m.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+g.message)}},_=(I,g,l)=>{const i=U(n);if(!i)return;const{rows:z,cols:D}=Fr(T),X=z*D,V=280,ne=320,me=20,oe=l%D,N=Math.floor(l/D),h=i.position.x+400,E=i.position.y-(X-1)*(ne+me)/2,y={id:`${n}-preview-${l}-${Date.now()}`,type:"imagePreview",position:{x:h+oe*(V+me),y:E+N*(ne+me)},data:{imageUrl:I,ratio:g,label:`æº¶å›¾ ${l+1}`,fromStoryboard:!0,sourceNodeId:n}},J={id:`edge-${n}-to-${y.id}`,source:n,target:y.id,sourceHandle:`${n}-source`,type:"aurora"};ee(ge=>[...ge,y]),Q(ge=>[...ge,J])},O=ae.length+ie.length+(ue?1:0);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["è§’è‰² ",ae.length>0&&`(${ae.length})`]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["åœºæ™¯ ",ie.length>0?"âœ“":""]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!x})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["é£æ ¼ ",ue?"âœ“":""]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!A})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(hs,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[O>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",O,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let I=1;const g=[];return ae.forEach(l=>{g.push({url:l,type:"char",index:I++})}),ie.forEach(l=>{g.push({url:l,type:"scene",index:I++})}),ue&&g.push({url:ue,type:"style",index:I++}),g.map(l=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:l.url,alt:`å›¾${l.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:l.index})]},`${l.type}-${l.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{K("2K"),a({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{K("4K"),a({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(I=>e.jsx("button",{onClick:()=>{Z(I),a({aspectRatio:I})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${fe===I?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:I},I))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ie,value:de,onChange:I=>{Ue(I.target.value),a({userPrompt:I.target.value});const g=I.target;g.style.height="auto",g.style.height=`${g.scrollHeight}px`},onFocus:I=>{const g=I.target;g.style.height="auto",g.style.height=`${g.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:p,onPointerDown:I=>I.stopPropagation(),onMouseDown:I=>I.stopPropagation(),disabled:ce||!de.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${ce||!de.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:ce?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(pr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!v&&($?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(r),"æ¬¡"]}):G!==null&&G>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[G,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(gs,{type:"source",position:ut.Right,id:`${n}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},cn=t.memo(ln),dn=["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"],un="gemini-3-pro-preview",gn="gemini-3-pro-image-preview",jr=5,hn=({data:s,selected:j,id:n})=>{const[W,ye]=t.useState(s.config.aspectRatio||"1:1"),[T,fe]=t.useState(s.config.inputImages||[]),[Z,re]=t.useState(s.config.userPrompt||""),[K,de]=t.useState(!!s.config.taskId),[Ue,ce]=t.useState(null),[se,ae]=t.useState(null),je=t.useMemo(()=>{const v=s.models||[];return v.find($=>$.modelId===gn)||v.find($=>{var r;return(r=$.modelId)==null?void 0:r.includes("gemini")})||v[0]},[s.models]);t.useEffect(()=>{je&&ae(je)},[je]);const{setNodes:ie,setEdges:xe,getNode:ue,getNodes:pe}=Zt(),Ie=t.useRef(null),ee=t.useRef(null),Q=t.useRef(null),U=t.useRef(pe),R=Fs(v=>v.edges.filter($=>$.target===n)),L=t.useRef("");t.useEffect(()=>{const v=pe(),$=[];R.forEach(w=>{var a,b,c,p,d,k,_,O;if($.length>=jr)return;const u=v.find(I=>I.id===w.source);if(u){const I=(b=(a=u.data)==null?void 0:a.config)==null?void 0:b.uploadedFiles;Array.isArray(I)&&I.forEach(l=>{$.length>=jr||l!=null&&l.url&&!$.includes(l.url)&&$.push(l.url)});const g=((c=u.data)==null?void 0:c.imageUrl)||((d=(p=u.data)==null?void 0:p.config)==null?void 0:d.generatedImageUrl)||((_=(k=u.data)==null?void 0:k.config)==null?void 0:_.imageUrl)||((O=u.data)==null?void 0:O.url);g&&!$.includes(g)&&$.push(g)}});const r=$.join(",");r!==L.current&&(L.current=r,fe($),f({inputImages:$}))},[R,pe]),t.useEffect(()=>{const v=s.config.taskId,r=setTimeout(async()=>{var w,u,a,b;if(v)try{const p=(await _e.tasks.getTaskStatus(v)).task;if(p.status==="SUCCESS"){de(!1),ce(null);const d=p.resultUrl;if(!d){(w=ee.current)==null||w.call(ee,{taskId:""});return}const _=(await cr({taskId:v,resultUrl:d,type:"IMAGE"})).displayUrl;(u=ee.current)==null||u.call(ee,{generatedImageUrl:_,taskId:""}),!U.current().some(g=>{var l;return((l=g.data)==null?void 0:l.sourceNodeId)===n&&g.type==="imagePreview"})&&Ie.current&&await Ie.current(_),m.success("åˆ†é•œç”Ÿæˆå·²å®Œæˆï¼")}else p.status==="PROCESSING"||p.status==="PENDING"?(de(!0),ce("image"),setTimeout(()=>{var d;(d=Q.current)==null||d.call(Q,v)},100)):p.status==="FAILURE"&&(de(!1),ce(null),(a=ee.current)==null||a.call(ee,{taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${p.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{de(!1),ce(null),(b=ee.current)==null||b.call(ee,{taskId:""}),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}},200);return()=>clearTimeout(r)},[]);const f=v=>{ie($=>$.map(r=>r.id===n?{...r,data:{...r.data,config:{...r.data.config,...v}}}:r))};ee.current=f,U.current=pe;const x=async()=>{var v,$;if(T.length===0){m.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!Z.trim()){m.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}de(!0),ce("text");try{const r=await Promise.all(T.map(k=>dr(k))),w="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",u="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚",a=await _e.ai.text.generate({modelId:un,systemPrompt:w,prompt:Z,imageUrls:r});if(!a.success)throw new Error(a.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const b=((v=a.data)==null?void 0:v.text)||(($=a.data)==null?void 0:$.content)||a.content;if(!b||typeof b!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(ce("image"),!se){m.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),de(!1),ce(null);return}const c=`${u}

åˆ†é•œæè¿°ï¼š
${b}

ç”Ÿæˆ${W}æ¯”ä¾‹çš„å›¾ç‰‡`,p=await _e.tasks.createImageTask({modelId:se.id,prompt:c,ratio:W,referenceImages:r,sourceNodeId:n,metadata:{imageSize:"4K"}});if(!p.success)throw new Error(p.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const d=p.taskId;f({taskId:d,userPrompt:Z}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},500),A(d)}catch(r){m.error(r.message||"ç”Ÿæˆå¤±è´¥"),de(!1),ce(null)}},A=async v=>{let r=0;const w=async()=>{try{const a=(await _e.tasks.getTaskStatus(v)).task;if(a.status==="SUCCESS"){de(!1),ce(null);const b=a.resultUrl;if(!b){m.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const p=(await cr({taskId:v,resultUrl:b,type:"IMAGE"})).displayUrl;f({generatedImageUrl:p,taskId:"",aspectRatio:W}),await F(p),m.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else a.status==="FAILURE"?(de(!1),ce(null),f({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${a.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(a.status==="PROCESSING"||a.status==="PENDING")&&(r++,r<300?setTimeout(w,2e3):(de(!1),ce(null),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{de(!1),ce(null),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};w()};Q.current=A;const F=async v=>{var $;try{let r=v;if(!v.startsWith("data:"))try{const a=await _e.assets.proxyDownload(v),b=new Blob([a],{type:"image/png"});r=await new Promise((c,p)=>{const d=new FileReader;d.onloadend=()=>c(d.result),d.onerror=p,d.readAsDataURL(b)})}catch{}const w=await Xr(r,3,3),u=[];for(let a=0;a<w.slices.length;a++)try{const b=w.slices[a],c=nn(b,"image/png"),p=new File([c],`storyboard_${n}_slice_${a+1}_${Date.now()}.png`,{type:"image/png"}),d=await _e.assets.upload(p);d.success&&(($=d.data)!=null&&$.url)?u.push(d.data.url):u.push(b)}catch{u.push(w.slices[a])}f({slicedImages:u}),G(u,W)}catch(r){m.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+r.message)}};Ie.current=F;const G=(v,$)=>{const r=ue(n);if(!r)return;const w=220,u=20,a=Date.now(),b=r.position.x+350,c=v.length*w+(v.length-1)*u,p=r.position.y-c/2+150,d=[],k=[];v.forEach((_,O)=>{const I={id:`${n}-slice-${a}-${O}`,type:"imagePreview",position:{x:b,y:p+O*(w+u)},data:{imageUrl:_,ratio:$,label:`åˆ†é•œ ${O+1}`,fromStoryboard:!0,sourceNodeId:n,createdBy:r.data.createdBy}},g={id:`edge-${n}-to-slice-${a}-${O}`,source:n,target:I.id,sourceHandle:`${n}-source`,type:"aurora"};d.push(I),k.push(g)}),ie(_=>[..._,...d]),xe(_=>[..._,...k])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(gs,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",T.length,"/",jr,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:T.map((v,$)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:v,alt:`å›¾ç‰‡${$+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:$+1})]},$))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:Z,onChange:v=>{re(v.target.value),f({userPrompt:v.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:dn.map(v=>e.jsx("button",{onClick:()=>{ye(v),f({aspectRatio:v})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${W===v?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:v},v))})]}),e.jsx("button",{type:"button",onClick:v=>{v.stopPropagation(),x()},disabled:K,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${K?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:K?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Ue==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"})]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},fn=t.memo(hn),pn="https://api.waule.ai",mn=({isOpen:s,onClose:j,onAssetSelect:n})=>{const[W,ye]=t.useState([]),[T,fe]=t.useState(""),[Z,re]=t.useState([]),[K,de]=t.useState([]),[Ue,ce]=t.useState(!1),[se,ae]=t.useState("ALL"),[je,ie]=t.useState("ALL");t.useEffect(()=>{s&&xe()},[s]),t.useEffect(()=>{T&&pe(T)},[T]),t.useEffect(()=>{if(!s)return;const Q=je==="ALL"?W:W.filter(U=>(U.category||"OTHER")===je);fe(Q.length>0?Q[0].id:"")},[je,W,s]);const xe=async()=>{try{const U=(await _e.assetLibraries.getAll({includeShared:"true"})).data||[];if(ye(U),U.length>0&&!T){const R=je==="ALL"?U:U.filter(L=>(L.category||"OTHER")===je);fe((R[0]||U[0]).id)}}catch{m.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const Q=U=>{var L;const R=((L=U==null?void 0:U.detail)==null?void 0:L.libraryId)||T;xe(),R&&pe(R)};return window.addEventListener("asset-library-updated",Q),()=>window.removeEventListener("asset-library-updated",Q)},[T]);const ue=Q=>(/^https?:\/\//.test(Q)?Q:`${pn}${Q}`).replace(".oss-oss-",".oss-"),pe=async Q=>{var U,R,L,f,x;ce(!0);try{const A=W.find(G=>G.id===Q);if(A&&(A.category||"OTHER")==="ROLE"){const v=(await _e.assetLibraries.roles.list(Q)).data||[],$=[];for(const r of v){const w=r.metadata||{},u=[(U=w.images)==null?void 0:U.frontAssetId,(R=w.images)==null?void 0:R.sideAssetId,(L=w.images)==null?void 0:L.backAssetId,(f=w.images)==null?void 0:f.faceAssetId].filter(Boolean),a=[];for(const c of u)try{const d=(await _e.assets.getById(c)).data;a.push({id:d.id,url:ue(d.url),name:d.name})}catch{}const b=r.thumbnail?ue(r.thumbnail):((x=a[0])==null?void 0:x.url)||"";$.push({id:r.id,name:r.name,coverUrl:b,images:a})}de($),re([])}else{const v=(await _e.assetLibraries.getAssets(Q)).data||[];re(v),de([])}}catch{m.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{ce(!1)}},Ie=Q=>{fe(Q)},ee=Q=>{n?(n(Q),setTimeout(()=>{xe(),T&&pe(T)},0)):m.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:j}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-neutral-500/20 via-neutral-400/30 to-neutral-500/20"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:j,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:W.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(Q=>e.jsx("button",{onClick:()=>ae(Q),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${se===Q?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:Q==="IMAGE"?"å›¾ç‰‡":Q==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},Q))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(Q=>e.jsx("button",{onClick:()=>ie(Q),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${je===Q?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:Q==="ROLE"?"è§’è‰²":Q==="SCENE"?"åœºæ™¯":Q==="PROP"?"é“å…·":Q==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},Q))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const Q=je==="ALL"?W:W.filter(U=>(U.category||"OTHER")===je);return e.jsx("select",{value:T,onChange:U=>Ie(U.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-neutral-500",children:Q.map(U=>{var R;return e.jsxs("option",{value:U.id,children:[U.isShared?`[å…±äº«] ${U.name}`:U.name," (",U._count.assets,")",U.isShared&&((R=U.owner)!=null&&R.nickname)?` - ${U.owner.nickname}`:""]},U.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Ue?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const Q=W.find(L=>L.id===T);if(Q&&(Q.category||"OTHER")==="ROLE")return K.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:K.map(L=>e.jsxs("div",{onClick:()=>n&&n(L),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[L.coverUrl?e.jsx("img",{src:L.coverUrl,alt:L.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:L.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[L.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},L.id))});const R=Z.filter(L=>se==="ALL"||L.type===se);return R.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:R.map(L=>e.jsxs("div",{onClick:()=>ee(L),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[L.type==="IMAGE"?e.jsx("img",{src:ue(L.url),alt:L.name,className:"w-full h-full object-cover"}):L.type==="VIDEO"?e.jsx("video",{src:ue(L.url),className:"w-full h-full object-cover"}):L.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:L.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:L.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:L.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(L.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:L.type==="IMAGE"?"image":L.type==="VIDEO"?"video_file":L.type==="AUDIO"?"audio_file":"description"})})]},L.id))})})()})]})})]})]}):null},xn={agent:po,aiImage:Ja,aiVideo:ur,soraVideo:Co,soraCharacter:_o,aiVideo_t2v:Ka,aiVideo_i2v_first:Qa,aiVideo_i2v_last:to,aiVideo_first_last:ro,aiVideo_reference:oo,aiVideo_swap:io,aiVideo_lipsync:co,aiVideo_style:ho,upload:xo,assetSelector:wo,imagePreview:ko,videoPreview:No,textPreview:Io,midjourney:So,audioVoice:Uo,voiceClone:$o,audioSynthesize:Do,audioDesign:Vo,audioPreview:Oo,superCanvas:Fo,videoUpscale:Bo,commercialVideo:Xo,textAnnotation:Yo,imageEditing:Zo,hdUpscale:on,imageFusion:cn,smartStoryboard:fn},bn={aurora:Lo},wn=()=>{const{id:s,projectId:j,episodeId:n,workflowId:W}=xa(),ye=!!W,T=ba(),fe=Sr(),Z=t.useMemo(()=>new URLSearchParams(fe.search),[fe.search]),re=t.useMemo(()=>{const o=Number(Z.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[Z]),K=t.useMemo(()=>{const o=Number(Z.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[Z]),de=t.useMemo(()=>{try{const o=Z.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[Z]),{screenToFlowPosition:Ue,setCenter:ce,getViewport:se,fitView:ae}=Zt(),{setTitle:je}=ya(),ie=Er(o=>o.user),[xe,ue]=t.useState(null),[pe,Ie]=t.useState(null),[ee,Q]=t.useState(!0),[U,R,L]=Na([]),[f,x,A]=ja([]),[F,G]=t.useState(!1),v=t.useRef(!1),[$,r]=t.useState(null),[w,u]=t.useState(null),[a,b]=t.useState(!0),c=t.useRef(null),[p,d]=t.useState(!1),k=t.useRef(null),_=t.useRef(null),[O,I]=t.useState(!1),[g,l]=t.useState(null),[i,z]=t.useState([]),[D,X]=t.useState([]),[V,ne]=t.useState(null),[me,oe]=t.useState(null),N=t.useRef(null),h=t.useRef(null),E=V==="video",y=V==="edit",J=V==="imageEdit",ge=o=>ne(null),B=o=>ne(o?"video":null),he=o=>ne(o?"edit":null),Se=o=>ne(o?"imageEdit":null),Ne=N,Re=me==="agent",Ce=o=>oe(o?"agent":null),Ae=h,$e=h,le=t.useCallback(o=>{const S=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return S?S.includes("æ–‡ç”Ÿ")||S.includes("text to video")||S.includes("t2v")||S.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":S.includes("é¦–å°¾")||S.includes("first last")||S.includes("two frame")||S.includes("frame pair")||S.includes("first-last")?"é¦–å°¾å¸§":S.includes("é¦–å¸§")||S.includes("first frame")||S.includes("start frame")||S.includes("initial frame")||S.includes("keyframe")?"é¦–å¸§":S.includes("å°¾å¸§")||S.includes("last frame")||S.includes("end frame")||S.includes("final frame")?"å°¾å¸§":S.includes("ä¸»ä½“å‚è€ƒ")||S.includes("subject reference")||S.includes("å‚è€ƒ")||S.includes("reference image")||S.includes("image reference")||S.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ge=t.useMemo(()=>{const o=new Set;return(i||[]).filter(M=>(M.type||"")==="VIDEO_GENERATION").forEach(M=>{var Y;(Array.isArray((Y=M==null?void 0:M.config)==null?void 0:Y.supportedGenerationTypes)?M.config.supportedGenerationTypes:[]).forEach(ke=>{const De=le(ke);De&&o.add(De)})}),o},[i,le]),Qe=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Wt=t.useCallback(o=>{const S=(i||[]).filter(Y=>(Y.type||"")==="VIDEO_EDITING").filter(Y=>{var ke;return Array.isArray((ke=Y==null?void 0:Y.config)==null?void 0:ke.supportedEditingCapabilities)&&Y.config.supportedEditingCapabilities.includes(o)}),M=(i||[]).filter(Y=>(Y.type||"")==="VIDEO_GENERATION").filter(Y=>{var He,Fe;if(o!=="è§†é¢‘æ¢äºº")return!1;const ke=((He=Y==null?void 0:Y.config)==null?void 0:He.supportsVideoEditing)===!0,Pe=(Array.isArray((Fe=Y==null?void 0:Y.config)==null?void 0:Fe.supportedGenerationTypes)?Y.config.supportedGenerationTypes:[]).some(rt=>le(rt)==="è§†é¢‘æ¢äºº");return ke||Pe}),H={};return[...S,...M].forEach(Y=>{H[Y.id]||(H[Y.id]=Y)}),Object.values(H)},[i,le]),[Ct,_t]=t.useState(!1),[ct,gt]=t.useState(null),vt=t.useRef(null),it=t.useRef(),[Ye,yt]=t.useState([]),[Be,wt]=t.useState(null),[Yt,vs]=t.useState(null),[Is,Es]=t.useState(!1),[Ns,Bs]=t.useState(null),[fs,Qs]=t.useState(null),[Hs,nr]=t.useState(null),Tt=t.useRef([]),Xs=t.useRef(null),[bs,er]=t.useState(!1),[ws,tr]=t.useState(!1),[sr,rr]=t.useState(0),Ps=t.useRef(null),q=t.useRef(null),te=t.useRef([]),Me=t.useRef([]),Ve=t.useRef(0),qe=!!n,Oe=qe&&!!re&&!!K,tt=ye?W:Oe?`${n}-${re}-${K}`:qe?n:s,bt=Oe,[C,P]=t.useState(!1),be=t.useRef(new Set),Te=t.useRef(new Set),Ee=t.useRef(new Set),we=t.useRef(new Set),et=t.useRef(new Map),st=t.useRef(new Set),kt=t.useCallback((o,S)=>{S!==c.current&&(be.current.add(o.id),R(M=>M.some(H=>H.id===o.id)?M:[...M,{...o,data:{...o.data,models:i}}]))},[i,R]),ht=t.useCallback((o,S,M)=>{M!==c.current&&(st.current.add(o),R(H=>H.map(Y=>Y.id===o?{...Y,data:{...Y.data,...S}}:Y)),setTimeout(()=>st.current.delete(o),100))},[R]),We=t.useCallback((o,S)=>{S!==c.current&&(R(M=>M.filter(H=>H.id!==o)),x(M=>M.filter(H=>H.source!==o&&H.target!==o)))},[R,x]),Dt=t.useCallback((o,S,M)=>{M!==c.current&&R(H=>H.map(Y=>Y.id===o?{...Y,position:S}:Y))},[R]),Xt=t.useCallback((o,S)=>{S!==c.current&&R(M=>M.map(H=>{const Y=o.find(ke=>ke.id===H.id);return Y?{...H,position:Y.position}:H}))},[R]),Pt=t.useCallback((o,S)=>{S!==c.current&&(Te.current.add(o.id),x(M=>M.some(H=>H.id===o.id)?M:[...M,o]))},[x]),zt=t.useCallback((o,S)=>{S!==c.current&&x(M=>M.filter(H=>H.id!==o))},[x]),At=t.useCallback((o,S)=>{S!==c.current&&(yt(o),Tt.current=o)},[]),{emitNodeAdd:Ut,emitNodeUpdate:Vt,emitNodeDelete:Ft,emitNodesMove:ts,emitEdgeAdd:rs,emitEdgeDelete:ys,emitGroupsUpdate:Js,onlineUsers:Cs}=Ba({workflowId:k.current,isSharedWorkflow:p,isReadOnly:F,onNodeAdd:kt,onNodeUpdate:ht,onNodeDelete:We,onNodeMove:Dt,onNodesMove:Xt,onEdgeAdd:Pt,onEdgeDelete:zt,onGroupsUpdate:At});t.useEffect(()=>{Tt.current=Ye},[Ye]),t.useEffect(()=>{te.current=U,Ve.current=U.length},[U]),t.useEffect(()=>{Me.current=f},[f]),t.useEffect(()=>{if(!C){Ee.current=new Set(U.map(Y=>Y.id));const H=new Map;U.forEach(Y=>{var ke;try{H.set(Y.id,JSON.stringify(((ke=Y.data)==null?void 0:ke.config)||{}))}catch{H.set(Y.id,"{}")}}),et.current=H;return}if(!p||v.current){Ee.current=new Set(U.map(H=>H.id));return}const o=new Set(U.map(H=>H.id)),S=Ee.current;U.forEach(H=>{var Y,ke;if(!S.has(H.id))be.current.has(H.id)||Ut(H);else if(!st.current.has(H.id))try{const De=JSON.stringify(((Y=H.data)==null?void 0:Y.config)||{}),Pe=et.current.get(H.id)||"{}";De!==Pe&&Vt(H.id,{config:(ke=H.data)==null?void 0:ke.config})}catch{}}),Ee.current=o;const M=new Map;U.forEach(H=>{var Y;try{M.set(H.id,JSON.stringify(((Y=H.data)==null?void 0:Y.config)||{}))}catch{M.set(H.id,"{}")}}),et.current=M,be.current=new Set([...be.current].filter(H=>o.has(H)))},[U,p,C,Ut,Vt]),t.useEffect(()=>{if(!C){we.current=new Set(f.map(M=>M.id));return}if(!p||v.current){we.current=new Set(f.map(M=>M.id));return}const o=new Set(f.map(M=>M.id)),S=we.current;f.forEach(M=>{S.has(M.id)||Te.current.has(M.id)||rs(M)}),we.current=o,Te.current=new Set([...Te.current].filter(M=>o.has(M)))},[f,p,C,rs]);const ps=t.useCallback(o=>{var Y;if(v.current)return!1;if(a)return!0;if(Tt.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(o.id))}))return!1;if(Oe)return!0;const M=(Y=o.data)==null?void 0:Y.createdBy;return(typeof M=="object"?M==null?void 0:M.id:M)===c.current},[a,Oe]),Bt=t.useMemo(()=>{const o=new Set(Ye.filter(S=>!S.hidden).flatMap(S=>S.nodeIds||[]));return U.map(S=>{const M=o.has(S.id),H=M?!1:a?!0:ps(S);return{...S,draggable:S.draggable!==!1,connectable:M?!1:S.connectable!==!1,data:{...S.data,_canEdit:H,_isGrouped:M,_currentUserId:w,_isSharedWorkflow:p}}})},[U,Ye,a,ps,w,p,F]),Jt=t.useRef(null),as=t.useRef(new Map),us=t.useCallback(o=>{if(v.current){L(o);return}const S=o.filter(H=>{var He;if(H.type!=="position")return!0;if(Tt.current.find(Fe=>{var rt;return!Fe.hidden&&((rt=Fe.nodeIds)==null?void 0:rt.includes(H.id))}))return a;if(a)return!0;const ke=te.current.find(Fe=>Fe.id===H.id);if(!ke)return!0;const De=(He=ke.data)==null?void 0:He.createdBy;return(typeof De=="object"?De==null?void 0:De.id:De)===c.current});L(S);const M=S.filter(H=>H.type==="position"&&H.position);M.length>0&&(M.forEach(H=>{as.current.set(H.id,H.position)}),Jt.current&&clearTimeout(Jt.current),Jt.current=setTimeout(()=>{const H=Array.from(as.current.entries()).map(([Y,ke])=>({id:Y,position:ke}));H.length>0&&(ts(H),as.current.clear())},100))},[a,L,ts]);t.useEffect(()=>{Xs.current=fs},[fs]),t.useEffect(()=>{const o=S=>{S.key==="Escape"&&(bs&&er(!1),ws&&tr(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,ws]),t.useEffect(()=>{tt&&(I(!1),P(!1),Gs(),Jr(),qr(),ss().finally(()=>{P(!0)}))},[tt]),t.useEffect(()=>{if(!ee&&!O&&U.length>0){const o=setTimeout(()=>{ae({padding:.1,duration:800,maxZoom:1.5}),I(!0)},100);return()=>clearTimeout(o)}},[ee,O,U.length,ae]),t.useEffect(()=>{var H;if(!Oe||!pe||!xe||!C)return;const o=Ye.find(Y=>Y.scene===re&&Y.shot===K),S=`${re}-${K}`;if(o){vs(o.id),wt(o.id);try{if(_.current===S)return;if(Array.isArray(de)&&de.length>0){_.current=S;const Y=U,ke=[],De=280,Pe=320,He=350,Fe={role:0,scene:0,prop:0,audio:0};Y.forEach(Le=>{var pt;if(Le.type==="assetSelector"){const Lt=((pt=Le.data)==null?void 0:pt.label)||"";Lt.startsWith("è§’è‰²")?Fe.role++:Lt.startsWith("åœºæ™¯")?Fe.scene++:Lt.startsWith("é“å…·")?Fe.prop++:Lt.startsWith("éŸ³é¢‘")&&Fe.audio++}});const rt={...Fe},Xe=[];de.forEach((Le,pt)=>{const Lt=Le.thumbnail||Le.url||"";let Rt=null;const Ot=Y.some(ot=>{var Mt,Ke;if(ot.type!=="assetSelector")return!1;const Ze=(Mt=ot.data)==null?void 0:Mt.config,ve=Ze==null?void 0:Ze.selectedAsset;if((ve==null?void 0:ve.id)===Le.id)return Rt=ot.id,!0;const Je=((Ke=ot.data)==null?void 0:Ke.label)||"",jt=Le.type==="role"?"è§’è‰²":Le.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${jt}: ${Le.name}`||(ve==null?void 0:ve.name)===Le.name?(Rt=ot.id,!0):!1});if(Ot&&Rt&&Lt&&Xe.push({nodeId:Rt,newUrl:Lt}),Ot)return;const ft=Le.type,mt=ft==="role"?0:ft==="scene"?1:ft==="prop"?2:3,Nt=rt[ft]||0;rt[ft]=(rt[ft]||0)+1;const Ht={x:mt*De,y:He+Nt*Pe},lt=Le.thumbnail||Le.url||"",ze=`assetSelector-${Date.now()}-${pt}`,nt=ft==="role"?"è§’è‰²":ft==="scene"?"åœºæ™¯":ft==="prop"?"é“å…·":"éŸ³é¢‘",dt=Le.metadata,at=ft==="role"&&(dt==null?void 0:dt.images);let qt=[];if(at){const ot=dt.images;ot.frontUrl&&qt.push({id:"front",url:ot.frontUrl,name:`${Le.name}-æ­£é¢`}),ot.sideUrl&&qt.push({id:"side",url:ot.sideUrl,name:`${Le.name}-ä¾§é¢`}),ot.backUrl&&qt.push({id:"back",url:ot.backUrl,name:`${Le.name}-èƒŒé¢`}),ot.faceUrl&&qt.push({id:"face",url:ot.faceUrl,name:`${Le.name}-é¢éƒ¨`})}let $t;at&&qt.length>0?$t={selectedInput:{id:Le.id,name:Le.name,coverUrl:lt,images:qt}}:ft==="audio"?$t={selectedAsset:{id:Le.id,name:Le.name,originalName:Le.name,url:Le.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:$t={selectedAsset:{id:Le.id,name:Le.name,originalName:Le.name,url:lt,type:"IMAGE",mimeType:"image/png",size:0}},ke.push({id:ze,type:"assetSelector",position:Ht,data:{id:ze,label:`${nt}: ${Le.name}`,config:$t,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:xe,episode:pe,nodeGroup:o,nodeGroups:Ye}}})}),Xe.length>0&&R(Le=>Le.map(pt=>{var Rt;const Lt=Xe.find(Ot=>Ot.nodeId===pt.id);if(Lt&&pt.type==="assetSelector"){const Ot=((Rt=pt.data)==null?void 0:Rt.config)||{},ft=Ot.selectedAsset||{};return{...pt,data:{...pt.data,config:{...Ot,selectedAsset:{...ft,url:Lt.newUrl}}}}}return pt})),ke.length>0&&R(Le=>[...Le,...ke])}}catch{}return}if(_.current===S)return;const M={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${re}å¹•-ç¬¬${K}é•œ`,scene:re,shot:K,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};yt(Y=>[...Y,M]),Tt.current=[...Tt.current,M],vs(M.id),wt(M.id),_.current=S;try{const Y=((H=pe==null?void 0:pe.scriptJson)==null?void 0:H.acts)||[],ke=Array.isArray(Y)?Y.find(ze=>Number(ze.actIndex)===Number(re)):null,De=ke?(ke.shots||[]).find(ze=>Number(ze.shotIndex)===Number(K)):null,He=De?[`ç”»é¢ï¼š${(De.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(De["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(De["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(De["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(De.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=De&&(De.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,Le=280,pt=320,Lt=350,Rt={x:0,y:0},Ot={x:rt+Xe,y:0},ft=`textPreview-${Date.now()}-a`,mt=`textPreview-${Date.now()}-b`,Nt=[{id:ft,type:"textPreview",position:Rt,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:ft,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:xe,episode:pe,nodeGroup:M,nodeGroups:[...Ye,M]}}},{id:mt,type:"textPreview",position:Ot,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:mt,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:xe,episode:pe,nodeGroup:M,nodeGroups:[...Ye,M]}}}],Ht=[];if(Array.isArray(de)&&de.length>0){const ze={role:0,scene:0,prop:0,audio:0};de.forEach((nt,dt)=>{const at=nt.type,qt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,$t=ze[at]||0;ze[at]=(ze[at]||0)+1;const ot={x:qt*Le,y:Lt+$t*pt},Ze=`assetSelector-${Date.now()}-${dt}`;Ht.push(Ze);const ve=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=nt.thumbnail||nt.url||"",jt=nt.metadata,Mt=at==="role"&&(jt==null?void 0:jt.images);let Ke=[];if(Mt){const xt=jt.images;xt.frontUrl&&Ke.push({id:"front",url:xt.frontUrl,name:`${nt.name}-æ­£é¢`}),xt.sideUrl&&Ke.push({id:"side",url:xt.sideUrl,name:`${nt.name}-ä¾§é¢`}),xt.backUrl&&Ke.push({id:"back",url:xt.backUrl,name:`${nt.name}-èƒŒé¢`}),xt.faceUrl&&Ke.push({id:"face",url:xt.faceUrl,name:`${nt.name}-é¢éƒ¨`})}let It;Mt&&Ke.length>0?It={selectedInput:{id:nt.id,name:nt.name,coverUrl:Je,images:Ke}}:at==="audio"?It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:nt.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},Nt.push({id:Ze,type:"assetSelector",position:ot,data:{id:Ze,label:`${ve}: ${nt.name}`,config:It,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:xe,episode:pe,nodeGroup:M,nodeGroups:[...Ye,M]}}})})}R(ze=>[...ze,...Nt]);const lt=[ft,mt,...Ht];yt(ze=>ze.map(nt=>{if(nt.id!==M.id)return nt;const dt=Array.from(new Set([...nt.nodeIds||[],...lt])),at=nt.bounds;return{...nt,nodeIds:dt,bounds:at}})),Tt.current=Tt.current.map(ze=>{if(ze.id!==M.id)return ze;const nt=Array.from(new Set([...ze.nodeIds||[],...lt])),dt=ze.bounds;return{...ze,nodeIds:nt,bounds:dt}})}catch{}},[qe,re,K,pe,xe,Ye,R,C,de]),t.useEffect(()=>{if(xe)if(qe&&pe){const o=`${xe.name} - ${pe.name||`ç¬¬${pe.episodeNumber}é›†`}`,S=re&&K?`ç¬¬${re}å¹•ç¬¬${K}é•œ`:"";je(Oe?o:`${o} ${S}`.trim())}else je(xe.name);return()=>je("")},[xe,pe,qe,Oe,re,K,je]),t.useEffect(()=>{if(!(!tt||ee||v.current))return it.current&&clearTimeout(it.current),it.current=setTimeout(()=>{qs()},2e3),()=>{it.current&&clearTimeout(it.current)}},[U,f,Ye]);const ss=async()=>{var o,S,M,H,Y,ke;try{let De;if(ye&&W)De=await _e.workflows.getById(W);else if(Oe)De=await _e.workflows.getOrCreateByShot(j,n,re,K);else if(qe)De=await _e.workflows.getOrCreateByEpisode(j,n);else{if(!s)return;De=await _e.workflows.getOrCreateByProject(s)}const Pe=De.data;Pe.canEdit===!1||Pe.canEdit===void 0&&Pe.isOwner===!1?(G(!0),v.current=!0,(o=Pe.shareInfo)!=null&&o.owner&&r(Pe.shareInfo.owner)):(G(!1),v.current=!1,r(null)),Pe.currentUserId&&(u(Pe.currentUserId),c.current=Pe.currentUserId);const Fe=Pe.isOwner!==!1||Oe&&Pe.canEdit===!0;b(Fe);const rt=ye||Pe.hasCollaborators===!0;if(d(rt),k.current=Pe.id,ye&&ue({id:Pe.projectId||W,name:Pe.name||"å…±äº«å·¥ä½œæµ",description:Pe.description,type:"QUICK",status:"DRAFT"}),Pe.data){const{nodes:Xe,edges:Le,nodeGroups:pt}=Pe.data;if(pt&&pt.length>0&&(yt(pt),Tt.current=pt),Xe&&Xe.length>0){let Lt=Xe;if(Oe&&((S=pe==null?void 0:pe.scriptJson)!=null&&S.acts))try{const Nt=pe.scriptJson.acts.find(ze=>Number(ze.actIndex)===Number(re)),Ht=(M=Nt==null?void 0:Nt.shots)==null?void 0:M.find(ze=>Number(ze.shotIndex)===Number(K)),lt=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(ze=>{ze.nodeId&&lt.add(ze.nodeId)}),(H=Ht.media)!=null&&H.nodeId&&lt.add(Ht.media.nodeId)),Lt=Xe.map(ze=>{var nt;return ze.type==="videoPreview"&&((nt=ze.data)!=null&&nt.addedToStoryboard)&&!lt.has(ze.id)?{...ze,data:{...ze.data,addedToStoryboard:!1}}:ze})}catch{}let Rt;if(Oe&&((Y=pe==null?void 0:pe.scriptJson)!=null&&Y.acts))try{const Nt=pe.scriptJson.acts.find(lt=>Number(lt.actIndex)===Number(re)),Ht=(ke=Nt==null?void 0:Nt.shots)==null?void 0:ke.find(lt=>Number(lt.shotIndex)===Number(K));Rt=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Ot=new Set((pt||[]).filter(mt=>!mt.hidden).flatMap(mt=>mt.nodeIds||[])),ft=Lt.map(mt=>{const Nt=pt?pt.find(ze=>ze.nodeIds.includes(mt.id)):null,Ht=i.length>0?i:mt.data.models||[],lt=mt.type==="agent"&&Rt?{...mt.data,output:Rt,lastOutput:Rt}:mt.data;return{...mt,data:{...lt,models:Ht,onOpenAssetPanel:mt.type==="assetSelector"?mt.data.onOpenAssetPanel||ar:mt.data.onOpenAssetPanel,workflowContext:{project:xe,episode:pe,nodeGroup:Nt,nodeGroups:pt||[]}},draggable:mt.draggable!==!1,connectable:Ot.has(mt.id)?!1:mt.connectable!==!1,deletable:Ot.has(mt.id)?!1:mt.deletable!==!1}});R(ft)}if(Le&&Le.length>0){const Lt=new Set(Xe.map(ft=>ft.id)),Rt=new Map(Xe.map(ft=>[ft.id,ft.type])),Ot=Le.filter(ft=>{if(!Lt.has(ft.source)||!Lt.has(ft.target))return!1;const mt=Rt.get(ft.target),Nt=Rt.get(ft.source);return!(mt==="midjourney"&&ft.targetHandle==="text-input"&&Nt!=="agent")}).map(ft=>({...ft,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:ft.targetHandle||void 0}));x(Ot)}}}catch{}};t.useEffect(()=>{i.length>0&&U.length>0&&R(o=>o.map(S=>({...S,data:{...S.data,models:i},draggable:S.draggable!==void 0?S.draggable:!0,deletable:S.deletable!==void 0?S.deletable:!0})))},[i,U.length]),t.useEffect(()=>{if(!xe&&!pe||U.length===0)return;if(U.some(S=>{var De,Pe;const M=S.data.workflowContext,H=((De=M==null?void 0:M.project)==null?void 0:De.id)!==(xe==null?void 0:xe.id),Y=((Pe=M==null?void 0:M.episode)==null?void 0:Pe.id)!==(pe==null?void 0:pe.id),ke=(M==null?void 0:M.nodeGroups)!==Tt.current;return!M||H||Y||ke})){const S=re&&K&&Tt.current.find(M=>M.scene===re&&M.shot===K)||null;R(M=>M.map(H=>{const Y=Tt.current.find(De=>De.nodeIds.includes(H.id))||null,ke=S||Y;return{...H,data:{...H.data,workflowContext:{project:xe,episode:pe,nodeGroup:ke,nodeGroups:Tt.current}}}}))}},[xe,pe,re,K,U.length,Ye]);const Os=async(o,S,M)=>{var H;if(!(!j||!n))try{const Y=o.find(Fe=>Fe.type==="agent");if(!Y)return;const ke=((H=Y.data)==null?void 0:H.output)||"",Pe=(await _e.episodes.getById(j,n)).scriptJson;if(!Pe||!Pe.acts)return;const He=Pe.acts.map(Fe=>{var rt;return Fe.actIndex===S?{...Fe,shots:(rt=Fe.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===M&&Xe.æç¤ºè¯!==ke?{...Xe,æç¤ºè¯:ke}:Xe)}:Fe});await _e.episodes.update(j,n,{scriptJson:{acts:He}})}catch{}},ks=async()=>{if(!(F||v.current)&&!(te.current.length===0&&Me.current.length===0))try{const o=te.current.map(M=>{const{data:H,...Y}=M,{workflowContext:ke,_canEdit:De,_currentUserId:Pe,...He}=H||{};return{...Y,data:He}}),S=Me.current.map(M=>({id:M.id,source:M.source,target:M.target,sourceHandle:M.sourceHandle,targetHandle:M.targetHandle,type:M.type}));if(Oe){await _e.workflows.saveShot(j,n,re,K,{nodes:o,edges:S,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}});try{await Os(te.current,re,K)}catch{}}else qe?await _e.workflows.saveEpisode(j,n,{nodes:o,edges:S,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}}):ye&&W?await _e.workflows.update(W,{data:{nodes:o,edges:S,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}}}):s&&await _e.workflows.save(s,{nodes:o,edges:S,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}})}catch{}},ms=t.useRef(null),qs=t.useCallback(()=>{ms.current&&clearTimeout(ms.current),ms.current=setTimeout(()=>{ks()},2e3)},[]);t.useEffect(()=>{const o=S=>{if(v.current)return;it.current&&clearTimeout(it.current);const H=S.detail;H!=null&&H.nodeId&&(H!=null&&H.config)&&(te.current=te.current.map(Y=>{var ke;return Y.id===H.nodeId?{...Y,data:{...Y.data,config:{...((ke=Y.data)==null?void 0:ke.config)||{},...H.config}}}:Y})),setTimeout(()=>{ks()},100)};return window.addEventListener("workflow:save",o),()=>{window.removeEventListener("workflow:save",o)}},[]),t.useEffect(()=>{if(xe||pe){let o=Tt.current;Oe&&re&&K&&(o=Tt.current.filter(S=>S.scene===re&&S.shot===K)),window.__workflowContext={project:xe,episode:pe,nodeGroups:o}}},[xe,pe,Ye,Oe,re,K]);const Gs=async()=>{try{if(ye){window.__workflowContext={project:null,episode:null,nodeGroups:Tt.current};return}if(qe){const[o,S]=await Promise.all([_e.episodes.getById(j,n),_e.projects.getById(j)]);Ie(o.data),ue(S.data);let M=Tt.current;Oe&&re&&K&&(M=Tt.current.filter(H=>H.scene===re&&H.shot===K)),window.__workflowContext={project:S.data,episode:o.data,nodeGroups:M}}else{const o=await _e.projects.getById(s);ue(o.data);let S=Tt.current;Oe&&re&&K&&(S=Tt.current.filter(M=>M.scene===re&&M.shot===K)),window.__workflowContext={project:o.data,episode:null,nodeGroups:S}}}catch{m.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),T("/quick")}finally{Q(!1)}},Jr=async()=>{try{const o=await _e.get("/ai/models",{params:{isActive:"true"}});z(o||[])}catch{}};t.useEffect(()=>{R(o=>o.map(S=>{const M=String(S.type||"");return!M.startsWith("aiVideo")&&M!=="audioVoice"&&M!=="voiceClone"&&M!=="audioSynthesize"&&M!=="audioDesign"?S:{...S,data:{...S.data,models:i}}}))},[i,R]);const qr=async()=>{try{const S=(await _e.agents.getAll()).filter(M=>M.isActive&&(!M.usageScene||M.usageScene==="workflow"));X(S)}catch{}};t.useEffect(()=>{R(o=>o.map(S=>{var Pe,He,Fe,rt,Xe;if(S.type!=="agent")return S;const M=(He=(Pe=S.data)==null?void 0:Pe.config)==null?void 0:He.agentId,H=D.find(Le=>Le.id===M),Y=H==null?void 0:H.aiModelId,ke=i.find(Le=>Le.id===Y);let De=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if((!De||De.length===0)&&ke){const Le=(ke.provider||"").toLowerCase(),pt=(ke.name||"").toLowerCase();(Le.includes("google")||pt.includes("gemini"))&&(De=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(De)&&De.length>0){const Le=(Xe=(rt=S.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,pt=Lt=>Lt.map(Rt=>Rt.toUpperCase()).sort().join(",");if(!Le||pt(Le)!==pt(De))return{...S,data:{...S.data,config:{...S.data.config,acceptedInputs:De}}}}return S}))},[D,i,R]);const Yr=t.useCallback(o=>{var Pe,He,Fe,rt,Xe,Le,pt,Lt,Rt,Ot,ft,mt,Nt,Ht,lt,ze,nt;Qt.current=!1;const S=Tt.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.source||""))}),M=Tt.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.target||""))});if(S||M){m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Qt.current=!1;return}const H=U.find(dt=>dt.id===o.source),Y=U.find(dt=>dt.id===o.target);if(H&&Y){const dt=$t=>{var ve,Je,jt;const ot=$t.type,Ze=$t.data;if(ot==="upload"&&Array.isArray((ve=Ze.config)==null?void 0:ve.uploadedFiles)&&Ze.config.uploadedFiles.length>0){const Mt=Ze.config.uploadedFiles,Ke=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="VIDEO"||js.startsWith("video/")}),It=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="IMAGE"||js.startsWith("image/")}),xt=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="AUDIO"||js.startsWith("audio/")});return(Y==null?void 0:Y.type)==="aiVideo_swap"?Ke?"VIDEO":It?"IMAGE":xt?"AUDIO":null:It?"IMAGE":Ke?"VIDEO":xt?"AUDIO":null}if(ot==="assetSelector"){if((Je=Ze.config)!=null&&Je.subjects)return"IMAGE";if((jt=Ze.config)!=null&&jt.selectedAsset){const Mt=Ze.config.selectedAsset,Ke=(Mt.type||"").toUpperCase(),It=(Mt.mimeType||"").toLowerCase();return Ke==="IMAGE"||It.startsWith("image/")?"IMAGE":Ke==="VIDEO"||It.startsWith("video/")?"VIDEO":Ke==="AUDIO"||It.startsWith("audio/")?"AUDIO":Ke||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=dt(H);let qt=(Pe=Y.data.config)==null?void 0:Pe.acceptedInputs;if(Y.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const $t={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${$t[at]||at}è¾“å…¥`),Qt.current=!1;return}if((!qt||qt.length===0)&&Y.data.type==="agent"){const $t=(He=Y.data.config)==null?void 0:He.agentId,ot=D.find(jt=>jt.id===$t),Ze=ot==null?void 0:ot.aiModelId,ve=i.find(jt=>jt.id===Ze),Je=(Fe=ve==null?void 0:ve.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)qt=Je;else{const jt=((rt=ve==null?void 0:ve.provider)==null?void 0:rt.toLowerCase())||"",Mt=((ve==null?void 0:ve.name)||"").toLowerCase();(jt.includes("google")||Mt.includes("gemini"))&&(qt=["TEXT","IMAGE","DOCUMENT"])}}if(Y.type!=="agent"){if(!Y.type.startsWith("aiVideo")&&qt&&qt.length>0&&at){const $t=qt.map(Ze=>typeof Ze=="string"?Ze.toUpperCase():Ze),ot=typeof at=="string"?at.toUpperCase():at;if(!$t.includes(ot)){const Ze={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${Ze[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${$t.map(ve=>Ze[ve]||ve).join("ã€")}ï¼‰`),Qt.current=!1;return}}}if(Y.type==="aiVideo_swap"){const $t=f.filter(jt=>jt.target===Y.id),ot=$t.filter(jt=>{const Mt=U.find(It=>It.id===jt.source);return dt(Mt)==="VIDEO"}).length,Ze=$t.filter(jt=>{const Mt=U.find(It=>It.id===jt.source);return dt(Mt)==="IMAGE"}).length,ve=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="IMAGE"?1:0);if(ve>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){m.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Qt.current=!1;return}}if(Y.type==="aiVideo_lipsync"){const $t=f.filter(Mt=>Mt.target===Y.id),ot=$t.filter(Mt=>{const Ke=U.find(xt=>xt.id===Mt.source);return dt(Ke)==="VIDEO"}).length,Ze=$t.filter(Mt=>{const Ke=U.find(xt=>xt.id===Mt.source);return dt(Ke)==="AUDIO"}).length,ve=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="AUDIO"?1:0),jt=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ve>1||Je>1||!jt){m.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Qt.current=!1;return}}if(Y.type.startsWith("aiVideo")&&Y.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(Ze=>{const ve=(Ze||"").toLowerCase().replace(/[_\-\s]+/g," ");return ve?ve.includes("æ–‡ç”Ÿ")||ve.includes("text to video")||ve.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("é¦–å°¾")||ve.includes("first last")||ve.includes("two frame")||ve.includes("frame pair")?"é¦–å°¾å¸§":ve.includes("é¦–å¸§")||ve.includes("first frame")||ve.includes("start frame")||ve.includes("initial frame")||ve.includes("keyframe")?"é¦–å¸§":ve.includes("å°¾å¸§")||ve.includes("last frame")||ve.includes("end frame")||ve.includes("final frame")?"å°¾å¸§":ve.includes("ä¸»ä½“å‚è€ƒ")||ve.includes("subject reference")||ve.includes("å‚è€ƒ")||ve.includes("reference image")||ve.includes("image reference")||ve.includes("ref image")?"å‚è€ƒå›¾":Ze||"":""})((Le=(Xe=Y.data)==null?void 0:Xe.config)==null?void 0:Le.generationType);if(Y.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){m.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Qt.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&H.type==="assetSelector"){const Ze=((pt=H.data)==null?void 0:pt.config)||{};if(Ze.subjects&&Ze.subjects.length>0&&(Ze.subjects[0].images||[]).length>1){m.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Qt.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&H.type==="assetSelector"){const Ze=((Lt=H.data)==null?void 0:Lt.config)||{};if(Ze.subjects&&Ze.subjects.length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Qt.current=!1;return}}}if(Y.type==="aiVideo_style"){const Ze=f.filter(ve=>ve.target===Y.id).filter(ve=>{const Je=U.find(Mt=>Mt.id===ve.source);return dt(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){m.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Qt.current=!1;return}if(Ze>1){m.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Qt.current=!1;return}}if(Y.type.startsWith("aiVideo")&&at==="TEXT"&&f.filter(Ze=>Ze.target===Y.id).find(Ze=>{const ve=U.find(Je=>Je.id===Ze.source);return(ve==null?void 0:ve.type)==="agent"})){m.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}if(Y.type==="aiImage"){if(at==="TEXT"){if(f.filter(Ze=>Ze.target===Y.id).some(Ze=>{const ve=U.find(Je=>Je.id===Ze.source);return(ve==null?void 0:ve.type)==="agent"})){m.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}}else if(at==="IMAGE"){const ot=f.filter(Ke=>Ke.target===Y.id).reduce((Ke,It)=>{var Kt,js,es,Rs,As,$r,Mr;const xt=U.find(cs=>cs.id===It.source),Et=(xt==null?void 0:xt.type)||"";if(Et==="upload"){const cs=((es=(js=(Kt=xt==null?void 0:xt.data)==null?void 0:Kt.config)==null?void 0:js.uploadedFiles)==null?void 0:es[0])||null,pa=((cs==null?void 0:cs.type)||"").toUpperCase(),ma=((cs==null?void 0:cs.mimeType)||"").toLowerCase();return Ke+(pa==="IMAGE"||ma.startsWith("image/")?1:0)}if(Et==="assetSelector"){const cs=((Rs=xt==null?void 0:xt.data)==null?void 0:Rs.config)||{};return cs.selectedAsset&&(Ke+=(cs.selectedAsset.type||"").toUpperCase()==="IMAGE"||(cs.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(cs.subjects)&&cs.subjects.length>0?Ke+((cs.subjects[0].images||[]).length||0):Ke}if(Et==="aiImage"){const cs=($r=(As=xt==null?void 0:xt.data)==null?void 0:As.config)==null?void 0:$r.generatedImageUrl;return Ke+(cs?1:0)}if(Et==="imagePreview"){const cs=(Mr=xt==null?void 0:xt.data)==null?void 0:Mr.imageUrl;return Ke+(cs?1:0)}return Ke},0);let Ze=1;if(H.type==="assetSelector"){const Ke=((Rt=H==null?void 0:H.data)==null?void 0:Rt.config)||{};Ke.selectedAsset?Ze=(Ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Ke.subjects)&&Ke.subjects.length>0&&(Ze=(Ke.subjects[0].images||[]).length||0)}else if(H.type==="upload"){const Ke=((mt=(ft=(Ot=H==null?void 0:H.data)==null?void 0:Ot.config)==null?void 0:ft.uploadedFiles)==null?void 0:mt[0])||null,It=((Ke==null?void 0:Ke.type)||"").toUpperCase(),xt=((Ke==null?void 0:Ke.mimeType)||"").toLowerCase();Ze=It==="IMAGE"||xt.startsWith("image/")?1:0}else H.type==="aiImage"?Ze=((Ht=(Nt=H==null?void 0:H.data)==null?void 0:Nt.config)==null?void 0:Ht.generatedImageUrl)?1:0:H.type==="imagePreview"&&(Ze=((lt=H==null?void 0:H.data)==null?void 0:lt.imageUrl)?1:0);const ve=(nt=(ze=Y==null?void 0:Y.data)==null?void 0:ze.config)==null?void 0:nt.modelId,Je=i.find(Ke=>Ke.id===ve),jt=(Je==null?void 0:Je.config)||{},Mt=jt.maxReferenceImages||jt.supportedReferenceImagesLimit||jt.referenceImagesLimit||10;if(ot+Ze>Mt){m.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Mt}å¼ ï¼‰`),Qt.current=!1;return}}}}try{const dt=U.find(ot=>ot.id===o.target),at=U.find(ot=>ot.id===o.source),qt=ot=>{var ve,Je,jt,Mt;if(!ot)return null;const Ze=String(ot.type||"").toLowerCase();if(Ze==="upload"){const Ke=(((Je=(ve=ot.data)==null?void 0:ve.config)==null?void 0:Je.uploadedFiles)||[]).find(It=>{const xt=((It==null?void 0:It.type)||"").toUpperCase(),Et=((It==null?void 0:It.mimeType)||"").toLowerCase();return xt==="AUDIO"||Et.startsWith("audio/")});return(Ke==null?void 0:Ke.url)||null}if(Ze==="assetSelector"){const Ke=(Mt=(jt=ot.data)==null?void 0:jt.config)==null?void 0:Mt.selectedAsset,It=((Ke==null?void 0:Ke.type)||"").toUpperCase(),xt=((Ke==null?void 0:Ke.mimeType)||"").toLowerCase();if(It==="AUDIO"||xt.startsWith("audio/"))return(Ke==null?void 0:Ke.url)||null}return null};if(String((dt==null?void 0:dt.type)||"")==="audioVoice"){const ot=qt(at);ot&&R(Ze=>Ze.map(ve=>ve.id===dt.id?{...ve,data:{...ve.data,config:{...ve.data.config,audioUrl:ot}}}:ve))}}catch{}const De={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{x(dt=>Ia(De,dt)),rs(De)},0),xs.current=null,Qt.current=!0},[x,U,D,i,f,rs]),Kr=t.useCallback((o,S)=>{const M=Tt.current.some(Y=>{var ke;return!Y.hidden&&((ke=Y.nodeIds)==null?void 0:ke.includes(S.source))}),H=Tt.current.some(Y=>{var ke;return!Y.hidden&&((ke=Y.nodeIds)==null?void 0:ke.includes(S.target))});if(M||H){m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}x(Y=>Y.filter(ke=>ke.id!==S.id)),ys(S.id),m.success("å·²æ–­å¼€è¿æ¥")},[x,ys]),yr=t.useCallback(o=>{var H,Y,ke,De,Pe,He,Fe,rt,Xe,Le,pt,Lt,Rt,Ot,ft;it.current&&clearTimeout(it.current);try{const mt=localStorage.getItem("suppressedPreviewTasks")||"[]",Nt=JSON.parse(mt),Ht=ze=>{Nt.push(ze)};for(const ze of Array.isArray(o)?o:[])if((ze==null?void 0:ze.type)==="imagePreview"){const nt=(Y=(H=ze==null?void 0:ze.data)==null?void 0:H.midjourneyData)==null?void 0:Y.sourceNodeId,dt=(De=(ke=ze==null?void 0:ze.data)==null?void 0:ke.midjourneyData)==null?void 0:De.taskId,at=(He=(Pe=ze==null?void 0:ze.data)==null?void 0:Pe.midjourneyData)==null?void 0:He.messageId;if(nt||dt||at)Ht({sourceNodeId:nt,taskId:dt,messageId:at});else{const qt=Me.current.find($t=>$t.target===ze.id);if(qt){const $t=te.current.find(Ze=>Ze.id===qt.source),ot=(rt=(Fe=$t==null?void 0:$t.data)==null?void 0:Fe.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((ze==null?void 0:ze.type)==="videoPreview"){const nt=Me.current.find(dt=>dt.target===ze.id);if(nt){const dt=te.current.find(qt=>qt.id===nt.source),at=(Le=(Xe=dt==null?void 0:dt.data)==null?void 0:Xe.config)==null?void 0:Le.taskId;at&&Ht({taskId:at})}}const lt=Nt.slice(Math.max(0,Nt.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(lt))}catch{}try{const mt=[];for(const Nt of Array.isArray(o)?o:[]){const Ht=(Rt=(Lt=(pt=Nt==null?void 0:Nt.data)==null?void 0:pt.workflowContext)==null?void 0:Lt.project)==null?void 0:Rt.name;(Nt==null?void 0:Nt.type)==="imagePreview"&&((Ot=Nt==null?void 0:Nt.data)!=null&&Ot.imageUrl)?mt.push(_e.post("/assets/recycle/record",{url:Nt.data.imageUrl,type:"IMAGE",projectName:Ht})):(Nt==null?void 0:Nt.type)==="videoPreview"&&((ft=Nt==null?void 0:Nt.data)!=null&&ft.videoUrl)&&mt.push(_e.post("/assets/recycle/record",{url:Nt.data.videoUrl,type:"VIDEO",projectName:Ht}))}mt.length>0&&Promise.allSettled(mt).then(()=>{})}catch{}const S=Array.isArray(o)?o.length:0,M=Ve.current;setTimeout(()=>{const mt=te.current.length,Nt=Math.max(M-S,0);mt===Nt&&ks()},100)},[]),Zr=t.useCallback(o=>{const S=o.filter(H=>Tt.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(H.id))})?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(S.length===0)return;if(a){yr(S),S.forEach(H=>Ft(H.id));return}const M=S.filter(H=>{var De;const Y=(De=H.data)==null?void 0:De.createdBy;return(typeof Y=="object"?Y==null?void 0:Y.id:Y)===c.current});M.length>0&&(yr(M),M.forEach(H=>Ft(H.id)))},[a,yr,Ft]),Ar=t.useCallback(o=>{it.current&&clearTimeout(it.current),setTimeout(()=>{qs()},250)},[]),Qr=t.useCallback(o=>{const S=o.filter(M=>{if(M.type!=="remove")return!0;const H=Me.current.find(De=>De.id===M.id);if(!H)return!0;const Y=Tt.current.some(De=>{var Pe;return!De.hidden&&((Pe=De.nodeIds)==null?void 0:Pe.includes(H.source))}),ke=Tt.current.some(De=>{var Pe;return!De.hidden&&((Pe=De.nodeIds)==null?void 0:Pe.includes(H.target))});return Y||ke?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});A(S)},[A]),ea=t.useCallback(o=>{const S=o.filter(M=>{const H=Tt.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(M.source))}),Y=Tt.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(M.target))});return H||Y?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});S.length>0&&(Ar(S),S.forEach(M=>ys(M.id)))},[Ar,ys]),ta=t.useCallback(o=>{if(o.preventDefault(),F)return;const S=200,M=400,H=10;let Y=o.clientX,ke=o.clientY;Y+S+H>window.innerWidth&&(Y=window.innerWidth-S-H),ke+M+H>window.innerHeight&&(ke=window.innerHeight-M-H),Y=Math.max(H,Y),ke=Math.max(H,ke),l({x:Y,y:ke})},[F]),gr=t.useCallback(()=>{l(null),ge(),B(!1)},[]),ar=t.useCallback(o=>{gt(o),_t(!0)},[]);t.useEffect(()=>{U.length>0&&U.some(S=>S.type==="assetSelector"&&!S.data.onOpenAssetPanel)&&R(S=>S.map(M=>M.type==="assetSelector"&&!M.data.onOpenAssetPanel?{...M,data:{...M.data,onOpenAssetPanel:ar,models:M.data.models||i}}:M))},[U.length,ar,i]);const sa=t.useCallback(o=>{ct&&(R(S=>S.map(H=>H.id===ct?{...H,data:{...H.data,config:{...H.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(Y=>Y.url)}],referenceImages:o.images.map(Y=>({id:Y.id,url:Y.url,name:Y.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:H)),_t(!1),gt(null),m.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[ct,R]),_r=o=>{const M={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",H=M==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:M==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:M==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:M==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],Y=i.filter(He=>He.type==="VIDEO_GENERATION"),ke=i.filter(He=>He.type==="VIDEO_EDITING"),De=He=>{const Fe=(He||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Pe=null;return M==="è§†é¢‘æ¢äºº"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||Y.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Le=>De(Le)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):M==="å¯¹å£å‹"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:M==="é£æ ¼è½¬æ¢"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Pe=Y.find(He=>{var rt;const Fe=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>De(Xe)):[];return M==="é¦–å¸§"||M==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(M)}),{modelId:Pe==null?void 0:Pe.id,modelName:Pe==null?void 0:Pe.name,generationType:M,lockedGenerationType:M,hideGenerationTypeSelector:!0,acceptedInputs:H}},ns=(o,S,M,H,Y,ke,De,Pe)=>{if(!g)return;const He=Ue({x:g.x,y:g.y}),Fe=`${o}-${Date.now()}`,rt=Yt?Ye.find(Rt=>Rt.id===Yt)||null:Ye.find(Rt=>Rt.nodeIds.includes(Fe))||null,Xe=M==="aiImage"||M.startsWith("aiVideo")||M==="midjourney",Le=M.startsWith("aiVideo")?_r(M):{},pt=H?{agentId:H}:Le;M.startsWith("aiVideo"),M.startsWith("aiVideo")&&Pe&&Object.assign(pt,Pe);const Lt={id:Fe,type:M,position:He,data:{label:Y||S,type:o,config:pt,models:i,isExpanded:Xe,onOpenAssetPanel:M==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:xe,episode:pe,nodeGroup:rt,nodeGroups:Ye}}};R(Rt=>[...Rt,Lt]),Ut(Lt),Yt&&(yt(Rt=>Rt.map(Ot=>{if(Ot.id!==Yt)return Ot;const ft=Array.from(new Set([...Ot.nodeIds||[],Fe])),mt=mr(ft)||Ot.bounds;return{...Ot,nodeIds:ft,bounds:mt}})),Tt.current=Tt.current.map(Rt=>{if(Rt.id!==Yt)return Rt;const Ot=Array.from(new Set([...Rt.nodeIds||[],Fe])),ft=mr(Ot)||Rt.bounds;return{...Rt,nodeIds:Ot,bounds:ft}})),gr(),m.success(`å·²æ·»åŠ ${Y||S}èŠ‚ç‚¹`),M==="assetSelector"&&setTimeout(()=>{ar(Lt.id)},100)},[is,Ys]=t.useState(null),Qt=t.useRef(!1),xs=t.useRef(null),Ks=t.useMemo(()=>{var Pe,He,Fe,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const S=is.handleType==="target",M=Xe=>{const Le=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return Le?Le.includes("æ–‡ç”Ÿ")||Le.includes("text to video")||Le.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Le.includes("é¦–å°¾")||Le.includes("first last")||Le.includes("two frame")||Le.includes("frame pair")?"é¦–å°¾å¸§":Le.includes("é¦–å¸§")||Le.includes("first frame")||Le.includes("start frame")||Le.includes("initial frame")||Le.includes("keyframe")?"é¦–å¸§":Le.includes("å°¾å¸§")||Le.includes("last frame")||Le.includes("end frame")||Le.includes("final frame")?"å°¾å¸§":Le.includes("ä¸»ä½“å‚è€ƒ")||Le.includes("subject reference")||Le.includes("å‚è€ƒ")||Le.includes("reference image")||Le.includes("image reference")||Le.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(S){const Xe=U.find(Ot=>Ot.id===is.sourceNodeId),Le=(Xe==null?void 0:Xe.type)||"",pt=Le.startsWith("aiVideo"),Lt=M((He=(Pe=Xe==null?void 0:Xe.data)==null?void 0:Pe.config)==null?void 0:He.generationType),Rt=Le==="aiVideo_t2v"||Lt==="æ–‡ç”Ÿè§†é¢‘";if(Le==="aiImage"){const Ot=f.filter(nt=>nt.target===(Xe==null?void 0:Xe.id)),ft=Ot.some(nt=>{const dt=U.find(at=>at.id===nt.source);return((dt==null?void 0:dt.type)||"")==="agent"}),mt=Ot.reduce((nt,dt)=>{var $t,ot,Ze,ve;const at=U.find(Je=>Je.id===dt.source),qt=(at==null?void 0:at.type)||"";if(qt==="upload"){const Je=((Ze=(ot=($t=at==null?void 0:at.data)==null?void 0:$t.config)==null?void 0:ot.uploadedFiles)==null?void 0:Ze[0])||null,jt=((Je==null?void 0:Je.type)||"").toUpperCase(),Mt=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return nt+(jt==="IMAGE"||Mt.startsWith("image/")?1:0)}if(qt==="assetSelector"){const Je=((ve=at==null?void 0:at.data)==null?void 0:ve.config)||{};if(Je.selectedAsset)return nt+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return nt+((Je.subjects[0].images||[]).length||0)}return nt},0),Nt=(rt=(Fe=Xe==null?void 0:Xe.data)==null?void 0:Fe.config)==null?void 0:rt.modelId,Ht=i.find(nt=>nt.id===Nt),lt=(Ht==null?void 0:Ht.config)||{},ze=lt.maxReferenceImages||lt.supportedReferenceImagesLimit||lt.referenceImagesLimit||10;return ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=ze?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(pt){const Ot=f.filter(ze=>ze.target===(Xe==null?void 0:Xe.id)),ft=Ot.some(ze=>{const nt=U.find(dt=>dt.id===ze.source);return((nt==null?void 0:nt.type)||"")==="agent"}),mt=Ot.reduce((ze,nt)=>{var qt,$t,ot,Ze;const dt=U.find(ve=>ve.id===nt.source),at=(dt==null?void 0:dt.type)||"";if(at==="aiImage"||at==="imagePreview")return ze+1;if(at==="upload"){const ve=((ot=($t=(qt=dt==null?void 0:dt.data)==null?void 0:qt.config)==null?void 0:$t.uploadedFiles)==null?void 0:ot[0])||null,Je=((ve==null?void 0:ve.type)||"").toUpperCase(),jt=((ve==null?void 0:ve.mimeType)||"").toLowerCase();return ze+(Je==="IMAGE"||jt.startsWith("image/")?1:0)}if(at==="assetSelector"){const ve=((Ze=dt==null?void 0:dt.data)==null?void 0:Ze.config)||{};if(ve.selectedAsset)return ze+((ve.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ve.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ve.subjects&&ve.subjects.length>0)return ze+((ve.subjects[0].images||[]).length||0)}return ze},0);return Rt?ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Le==="aiVideo_i2v_first"||Le==="aiVideo_i2v_last"||Lt==="é¦–å¸§"||Lt==="å°¾å¸§"?ft&&mt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Le==="aiVideo_first_last"||Lt==="é¦–å°¾å¸§"?ft&&mt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Le==="aiVideo_reference"||Lt==="å‚è€ƒå›¾"?ft&&mt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const H=U.find(Xe=>Xe.id===is.sourceNodeId),ke=(Xe=>{var Lt,Rt,Ot;if(!Xe)return null;const Le=Xe.type,pt=Xe.data;if(Le==="upload"&&Array.isArray((Lt=pt.config)==null?void 0:Lt.uploadedFiles)&&pt.config.uploadedFiles.length>0){const ft=pt.config.uploadedFiles;return ft.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="IMAGE"||nt.startsWith("image/")})?"IMAGE":ft.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="VIDEO"||nt.startsWith("video/")})?"VIDEO":ft.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="AUDIO"||nt.startsWith("audio/")})?"AUDIO":null}if(Le==="assetSelector"){if((Rt=pt.config)!=null&&Rt.subjects)return"IMAGE";if((Ot=pt.config)!=null&&Ot.selectedAsset){const ft=pt.config.selectedAsset,mt=(ft.type||"").toUpperCase(),Nt=(ft.mimeType||"").toLowerCase();return mt==="IMAGE"||Nt.startsWith("image/")?"IMAGE":mt==="VIDEO"||Nt.startsWith("video/")?"VIDEO":mt==="AUDIO"||Nt.startsWith("audio/")?"AUDIO":mt||null}}return Le==="aiImage"||Le==="imagePreview"||Le==="midjourney"?"IMAGE":(Le||"").startsWith("aiVideo")||Le==="videoPreview"?"VIDEO":Le==="agent"||Le==="textPreview"?"TEXT":null})(H),De=H==null?void 0:H.type;return De==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:De==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ke==="TEXT",showAiImage:ke==="IMAGE"||ke==="TEXT",showAudio:ke==="AUDIO",showVideo:ke==="VIDEO"||ke==="IMAGE"||ke==="TEXT",showEdit:ke==="VIDEO",showImageEditing:ke==="IMAGE",showMidjourney:ke==="IMAGE"||ke==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ke==="IMAGE"}},[is,U,f,i]),ra=t.useCallback((o,{nodeId:S,handleType:M})=>{if(!S){xs.current=null;return}if(M==="target"){const H=U.find(ke=>ke.id===S),Y=(H==null?void 0:H.type)||"";if(Y==="agent"||Y==="aiImage"||Y==="midjourney"||Y.startsWith("aiVideo")){m.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),xs.current=null;return}}if(M==="source"){const H=U.find(Y=>Y.id===S);if(H&&(H.type==="aiImage"||H.type.startsWith("aiVideo"))){xs.current=null;return}}Qt.current=!1,xs.current={nodeId:S,handleType:M==="target"?"target":"source"},gr(),Ys(null)},[gr,U]),aa=t.useCallback(o=>{const S=xs.current;if(!S)return;let M=0,H=0;"changedTouches"in o&&o.changedTouches.length>0?(M=o.changedTouches[0].clientX,H=o.changedTouches[0].clientY):"clientX"in o&&(M=o.clientX,H=o.clientY),setTimeout(()=>{if(Qt.current){Qt.current=!1,xs.current=null;return}const Y=o.target,ke=!!Y&&!!Y.closest(".react-flow__pane"),De=!!Y&&(Y.closest(".react-flow__node")||Y.closest(".react-flow__handle"));if(!ke||De){Qt.current=!1,xs.current=null;return}Ys({x:M,y:H,sourceNodeId:S.nodeId,handleType:S.handleType}),Qt.current=!1},100),xs.current=null},[]),ls=(o,S,M,H,Y,ke)=>{var Lt,Rt,Ot,ft,mt,Nt,Ht;if(!is)return;const De=Ue({x:is.x,y:is.y}),Pe=`${M}-${Date.now()}`,He=U.find(lt=>lt.id===is.sourceNodeId),Fe=He?Ye.find(lt=>lt.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?_r(o):{};let Le={};H?Le={agentId:H}:o.startsWith("aiVideo")?Le=Xe:o==="smartStoryboard"?Le={taskId:"",aspectRatio:"1:1",inputImages:[],userPrompt:""}:o==="hdUpscale"?Le={taskId:"",imageSize:"4K"}:o==="imageFusion"&&(Le={taskId:"",imageSize:"4K"}),o.startsWith("aiVideo")&&ke&&Object.assign(Le,ke);const pt={id:Pe,type:o,position:De,data:{label:Y||S,type:M,config:Le,models:i,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:xe,episode:pe,nodeGroup:Fe,nodeGroups:Ye}}};if(R(lt=>[...lt,pt]),Fe&&(yt(lt=>lt.map(ze=>{if(ze.id!==Fe.id)return ze;const nt=Array.from(new Set([...ze.nodeIds,Pe]));return{...ze,nodeIds:nt}})),Tt.current=Tt.current.map(lt=>{if(lt.id!==Fe.id)return lt;const ze=Array.from(new Set([...lt.nodeIds,Pe]));return{...lt,nodeIds:ze}})),is.handleType==="source"){const lt=U.find(ve=>ve.id===is.sourceNodeId),ze=pt,nt=ve=>{const Je=(ve||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ve||"":""},dt=ve=>{var Mt,Ke,It;const Je=ve.type,jt=ve.data;if(Je==="upload"&&Array.isArray((Mt=jt.config)==null?void 0:Mt.uploadedFiles)&&jt.config.uploadedFiles.length>0){const xt=jt.config.uploadedFiles,Et=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="VIDEO"||As.startsWith("video/")}),Kt=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="IMAGE"||As.startsWith("image/")}),js=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="AUDIO"||As.startsWith("audio/")});return(ze==null?void 0:ze.type)==="aiVideo_swap"?Et?"VIDEO":Kt?"IMAGE":js?"AUDIO":null:Kt?"IMAGE":Et?"VIDEO":js?"AUDIO":null}if(Je==="assetSelector"){if((Ke=jt.config)!=null&&Ke.subjects)return"IMAGE";if((It=jt.config)!=null&&It.selectedAsset){const xt=jt.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Kt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ve=>{var jt,Mt,Ke;if(dt(ve)!=="IMAGE")return 0;if(ve.type==="upload")return(((Mt=(jt=ve.data)==null?void 0:jt.config)==null?void 0:Mt.uploadedFiles)||[]).filter(xt=>xt.type==="IMAGE"||(xt.mimeType||"").startsWith("image/")).length;if(ve.type==="assetSelector"){const It=((Ke=ve.data)==null?void 0:Ke.config)||{};return It.subjects&&It.subjects.length>0?(It.subjects[0].images||[]).length:It.selectedAsset&&It.selectedAsset.type==="IMAGE"?1:0}return ve.type==="imagePreview"||ve.type==="aiImage",1},qt=ve=>{var xt,Et,Kt,js,es,Rs;const Je=nt((Et=(xt=ve.data)==null?void 0:xt.config)==null?void 0:Et.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const jt=(js=(Kt=ve.data)==null?void 0:Kt.config)==null?void 0:js.modelId,Ke=(((es=ve.data)==null?void 0:es.models)||i).find(As=>As.id===jt),It=Array.isArray((Rs=Ke==null?void 0:Ke.config)==null?void 0:Rs.supportedGenerationTypes)?Ke.config.supportedGenerationTypes.map(As=>nt(As)):[];return It.includes("å‚è€ƒå›¾")||It.includes("ä¸»ä½“å‚è€ƒ")?7:It.includes("é¦–å°¾å¸§")?2:It.includes("é¦–å¸§")||It.includes("å°¾å¸§")?1:(It.includes("æ–‡ç”Ÿè§†é¢‘"),0)},$t=lt?dt(lt):null;if(ze.type.startsWith("aiVideo")&&$t==="IMAGE"){if(nt((Rt=(Lt=ze.data)==null?void 0:Lt.config)==null?void 0:Rt.generationType)==="é¦–å°¾å¸§"&&lt&&lt.type==="assetSelector"){const xt=((Ot=lt.data)==null?void 0:Ot.config)||{};if(xt.subjects&&(((ft=xt.subjects[0])==null?void 0:ft.images)||[]).length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),xs.current=null,Qt.current=!1;return}}const Je=f.filter(xt=>xt.target===ze.id);let jt=0;Je.forEach(xt=>{const Et=U.find(Kt=>Kt.id===xt.source);Et&&(jt+=at(Et))});const Mt=lt?at(lt):0,Ke=qt(ze),It=jt+Mt;if(Ke===0){m.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ys(null),xs.current=null,Qt.current=!1;return}if(It>Ke){m.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Ke}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${It}å¼ ï¼‰`),Ys(null),xs.current=null,Qt.current=!1;return}}let ot;pt.type==="superCanvas"?ot="input-image":pt.type==="midjourney"&&($t==="IMAGE"?ot="omni-ref":$t==="TEXT"&&(ot="text-input"));const Ze={id:`edge-${is.sourceNodeId}-${pt.id}`,source:is.sourceNodeId,target:pt.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(ve=>[...ve,Ze])}else if(is.handleType==="target"){const lt=U.find(Ze=>Ze.id===is.sourceNodeId),ze=(lt==null?void 0:lt.type)||"";if(ze==="agent"||ze==="aiImage"||ze==="midjourney"||ze.startsWith("aiVideo")){m.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ys(null),xs.current=null,Qt.current=!1;return}const nt=pt,dt=U.find(Ze=>Ze.id===is.sourceNodeId),at=Ze=>{const ve=(Ze||"").toLowerCase();return ve?ve.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("é¦–å°¾")?"é¦–å°¾å¸§":ve.includes("é¦–å¸§")?"é¦–å¸§":ve.includes("å°¾å¸§")?"å°¾å¸§":ve.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ve.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ve.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("first-last")?"é¦–å°¾å¸§":ve.includes("first")?"é¦–å¸§":ve.includes("last")?"å°¾å¸§":ve.includes("subject")?"ä¸»ä½“å‚è€ƒ":ve.includes("reference")?"å‚è€ƒå›¾":Ze||"":""},$t=(Ze=>{var jt,Mt,Ke,It;const ve=Ze.type,Je=Ze.data;if(ve==="upload"&&((Mt=(jt=Je.config)==null?void 0:jt.uploadedFiles)==null?void 0:Mt.length)>0){const xt=Je.config.uploadedFiles[0],Et=(xt.type||"").toUpperCase(),Kt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}if(ve==="assetSelector"){if((Ke=Je.config)!=null&&Ke.subjects)return"IMAGE";if((It=Je.config)!=null&&It.selectedAsset){const xt=Je.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Kt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}}return ve==="aiImage"||ve==="imagePreview"?"IMAGE":ve==="aiVideo"||ve==="videoPreview"?"VIDEO":ve==="agent"?"TEXT":null})(nt);if(dt&&dt.type==="aiVideo"&&$t==="IMAGE"&&at((Nt=(mt=dt.data)==null?void 0:mt.config)==null?void 0:Nt.generationType)==="é¦–å°¾å¸§"&&nt&&nt.type==="assetSelector"){const ve=((Ht=nt.data)==null?void 0:Ht.config)||{};if(ve.subjects&&ve.subjects.length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),xs.current=null,Qt.current=!1;return}}const ot={id:`edge-${pt.id}-${is.sourceNodeId}`,source:pt.id,sourceHandle:pt.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(Ze=>[...Ze,ot])}Ys(null),xs.current=null,Qt.current=!1,m.success(`å·²æ·»åŠ ${S}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(pt.id)},100)},mr=t.useCallback(o=>{const S=U.filter(Pe=>o.includes(Pe.id));if(S.length===0)return null;const M=50;let H=1/0,Y=1/0,ke=-1/0,De=-1/0;return S.forEach(Pe=>{const He=Pe.position.x,Fe=Pe.position.y,rt=Pe.width||320,Xe=Pe.height||200;H=Math.min(H,He),Y=Math.min(Y,Fe),ke=Math.max(ke,He+rt),De=Math.max(De,Fe+Xe)}),{x:H-M,y:Y-M,width:ke-H+M*2,height:De-Y+M*2}},[U]),oa=t.useCallback(()=>{tr(o=>!o),er(!1)},[]),Tr=t.useCallback((o,S)=>{const M={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:S-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0}};R(H=>[...H,M]),tr(!1)},[R,ie]),na=t.useCallback(()=>{if(!a){m.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=U.filter(ke=>ke.selected);if(o.length===0){m.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){m.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const S=o.map(ke=>ke.id);if(Ye.some(ke=>ke.nodeIds.some(De=>S.includes(De)))){m.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const H=mr(S);if(!H){m.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const Y={id:`group-${Date.now()}`,nodeIds:S,bounds:H};yt(ke=>{const De=[...ke,Y];return Js(De),setTimeout(()=>{qs()},100),De}),wt(Y.id),R(ke=>{const De=new Set;return f.forEach(Pe=>{if(S.includes(Pe.source)){const He=ke.find(Fe=>Fe.id===Pe.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&De.add(Pe.target)}}),ke.map(Pe=>S.includes(Pe.id)?{...Pe,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:Y,nodeGroups:[...Ye,Y]}}}:De.has(Pe.id)?{...Pe,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:Y,nodeGroups:[...Ye,Y]}}}:Pe)}),m.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${S.length} ä¸ªèŠ‚ç‚¹`)},[U,mr,Ye,R]),ia=t.useCallback(()=>{if(!a){m.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Be){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ye.find(S=>S.id===Be);o&&(R(S=>S.map(M=>o.nodeIds.includes(M.id)?{...M,draggable:!0,connectable:!0,deletable:!0,data:{...M.data,workflowContext:{...M.data.workflowContext,nodeGroup:null,nodeGroups:Ye.filter(H=>H.id!==Be)}}}:M)),yt(S=>{const M=S.filter(H=>H.id!==Be);return Js(M),setTimeout(()=>{qs()},100),M}),wt(null),m.success("å·²è§£é™¤ç¼–ç»„"))},[Be,Ye,R,Js]),la=t.useCallback(()=>{if(!Be){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Bs(Be),Es(!0)},[Be]),Ur=t.useCallback((o,S)=>{o.stopPropagation(),o.preventDefault(),Qs(null),wt(S),nr(null)},[]);t.useEffect(()=>{if(!fs||!Hs)return;let o=Hs.x,S=Hs.y;const M=Y=>{const ke=Xs.current;if(!ke)return;const De=se(),Pe=(Y.clientX-o)/De.zoom,He=(Y.clientY-S)/De.zoom;if(Math.abs(Pe)<.01&&Math.abs(He)<.01)return;const Fe=Tt.current.find(rt=>rt.id===ke);Fe&&(yt(rt=>rt.map(Xe=>Xe.id===ke?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Pe,y:Xe.bounds.y+He}}:Xe)),R(rt=>rt.map(Xe=>Fe.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Pe,y:Xe.position.y+He}}:Xe)),o=Y.clientX,S=Y.clientY)},H=()=>{Qs(null),nr(null)};return document.addEventListener("mousemove",M),document.addEventListener("mouseup",H),()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",H)}},[fs,Hs]);const ca=t.useCallback(o=>{if(ws){const S=Ue({x:o.clientX,y:o.clientY});Tr(S.x,S.y);return}gr(),Ys(null),xs.current=null,wt(null),Qt.current=!1},[gr,ws,Ue,Tr]),kr=t.useRef(null),da=t.useCallback(()=>{Ye.length>0&&!kr.current&&(kr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),kr.current=null}))},[Ye.length]),ir=t.useCallback(o=>Ye.find(S=>S.nodeIds.includes(o))||null,[Ye]),ua=t.useCallback((o,S)=>{var H;if(bt||(H=S==null?void 0:S.data)!=null&&H.freeDrag)return;const M=ir(S.id);if(M){if(!M.hidden&&!a)return;Ps.current=S.id,q.current={x:S.position.x,y:S.position.y}}},[ir,a]),ga=t.useCallback((o,S)=>{var Y;if(bt||(Y=S==null?void 0:S.data)!=null&&Y.freeDrag||!q.current||Ps.current!==S.id)return;const M=ir(S.id);if(!M)return;const H=!M.hidden;if(!(H&&!a))if(H){const ke=S.position.x-q.current.x,De=S.position.y-q.current.y,Pe=[],He=M.nodeIds||[];te.current.forEach(Fe=>{if(He.includes(Fe.id)){const rt={x:Fe.id===S.id?S.position.x:Fe.position.x+ke,y:Fe.id===S.id?S.position.y:Fe.position.y+De};Pe.push({id:Fe.id,position:rt})}}),R(Fe=>Fe.map(rt=>{const Xe=Pe.find(Le=>Le.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Pe.length>0&&ts(Pe),yt(Fe=>{const rt=Fe.map(Xe=>Xe.id===M.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ke,y:Xe.bounds.y+De}}:Xe);return Tt.current=rt,rt}),q.current={x:S.position.x,y:S.position.y}}else{const ke=M.bounds.x,De=M.bounds.y,Pe=M.bounds.width,He=M.bounds.height,Fe=(Le,pt,Lt)=>Math.max(pt,Math.min(Le,Lt)),rt=Fe(S.position.x,ke+10,ke+Pe-10),Xe=Fe(S.position.y,De+10,De+He-10);R(Le=>Le.map(pt=>pt.id===S.id?{...pt,position:{x:rt,y:Xe}}:pt)),q.current={x:rt,y:Xe}}},[R,yt,ir,a,ts]),ha=t.useCallback(()=>{Ps.current=null,q.current=null,Xs.current=null,Ps.current=null,q.current=null,Xs.current=null,Qs(null),Tt.current.length>0&&Js(Tt.current)},[Js]),fa=t.useCallback((o,S)=>{const M=ir(S.id);M&&wt(M.id)},[ir]);if(t.useEffect(()=>{if(f.length===0||U.length===0)return;const o=f.filter(S=>{const M=U.find(Y=>Y.id===S.source),H=U.find(Y=>Y.id===S.target);return(H==null?void 0:H.type)==="midjourney"&&S.targetHandle==="text-input"&&(M==null?void 0:M.type)!=="agent"});o.length>0&&(x(S=>S.filter(M=>!o.some(H=>H.id===M.id))),m.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[f,U,x]),ee)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!xe)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Rr=U.filter(o=>o.selected).length>=2,xr=!!Be;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:vt,className:"flex-1 relative overflow-hidden",children:[F&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:$?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${$.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),xe&&e.jsx("div",{className:`absolute left-1/2 -translate-x-1/2 ${F?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&pe?`${xe.name} ç¬¬${pe.episodeNumber}é›†${!Oe&&re&&K?` ç¬¬${re}å¹•ç¬¬${K}é•œ`:""}`:xe.name})}),!Oe&&Ye.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-[100px] top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ye.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,S)=>o.scene!==S.scene?(o.scene||0)-(S.scene||0):(o.shot||0)-(S.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const S=o.bounds.x+o.bounds.width/2,M=o.bounds.y+o.bounds.height/2,H=vt.current;if(H){const Y=H.clientWidth,ke=H.clientHeight,De=.2,Pe=Y*(1-De),He=ke*(1-De),Fe=Pe/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(Fe,rt,1.5),Le=Math.max(Xe,.3);ce(S,M,{zoom:Le,duration:800})}else ce(S,M,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Be===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-[#deeaef]/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-[#deeaef] dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:"fixed right-[24px] top-1/2 -translate-y-1/2 z-[100] flex flex-col gap-1 p-2 rounded-2xl bg-[#deeaef] dark:bg-[#18181b] shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{onClick:()=>{if(qe&&j&&n){const o=Oe&&re&&K?`?shot=${K}`:"";T(`/projects/${j}/episodes/${n}${o}`)}else T("/quick")},className:"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"arrow_back"})}),e.jsx("div",{className:"h-px bg-neutral-200 dark:bg-neutral-700 my-1"}),!F&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!bt&&a&&er(!bs)},disabled:bt||!a,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":bs?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!bt&&a&&na()},disabled:bt||!a||!Rr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!Rr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_work"})}),e.jsx("button",{onClick:()=>{!bt&&a&&ia()},disabled:bt||!a||!xr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!xr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_off"})}),e.jsx("button",{onClick:()=>{!bt&&a&&la()},disabled:bt||!a||!xr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!xr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"edit"})}),e.jsx("button",{onClick:()=>oa(),className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${ws?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:ws?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"text_fields"})})]})]}),p&&Cs.length>0&&e.jsxs("div",{className:`absolute ${F?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:Cs.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.ai${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-neutral-600 dark:text-neutral-300",children:"person"})},o.id))}),Cs.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",Cs.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${ws?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Sa,{nodes:Bt,edges:f,onNodesChange:F?void 0:us,onEdgesChange:F?void 0:Qr,onNodesDelete:F?void 0:Zr,onEdgesDelete:F?void 0:ea,onConnect:F?void 0:Yr,onConnectStart:F?void 0:ra,onConnectEnd:F?void 0:aa,onEdgeDoubleClick:F?void 0:Kr,onPaneContextMenu:F?void 0:ta,onPaneClick:F?void 0:ca,onMove:da,onNodeClick:F?void 0:fa,onNodeDragStart:F?void 0:ua,onNodeDrag:F?void 0:ga,onNodeDragStop:F?void 0:ha,nodeTypes:xn,edgeTypes:bn,nodesDraggable:!F,nodesConnectable:!F,elementsSelectable:!F,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${F?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#525252",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:F?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Ea,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#525252"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#404040"})]})}),Ye.filter(o=>!o.hidden).map(o=>{const S=se(),M=o.bounds.x*S.zoom+S.x,H=o.bounds.y*S.zoom+S.y,Y=o.bounds.width*S.zoom,ke=o.bounds.height*S.zoom,De=12*S.zoom,Pe=Math.max(1.25,1.25*S.zoom),He=document.documentElement.classList.contains("dark"),Fe=Be===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:M,y:H,width:Y,height:ke,rx:De,ry:De,fill:"none",stroke:Fe?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Pe,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:M,y:H,width:Y,height:ke,rx:De,ry:De,fill:"transparent",stroke:"transparent",strokeWidth:Pe*3,style:{pointerEvents:"stroke",cursor:fs===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),Ur(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ye.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const S=se(),M=o.bounds.x*S.zoom+S.x,H=o.bounds.y*S.zoom+S.y,Y=40*S.zoom,ke=10*S.zoom,De=15*S.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Pe=>{Pe.stopPropagation(),Ur(Pe,o.id)},onClick:Pe=>{Pe.stopPropagation(),wt(o.id)},style:{left:M+ke,top:H-Y-ke-De,fontSize:`${Y}px`,cursor:fs===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),g&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:g.x,top:g.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("agent")},onMouseLeave:()=>{N.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ne("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),V==="agent"&&e.jsx("div",{onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("agent")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(N.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:D.length>0?D.map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),Se(!0)},onMouseLeave:()=>{N.current=window.setTimeout(()=>{Se(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),J&&e.jsxs("div",{onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),Se(!0)},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(N.current=window.setTimeout(()=>{Se(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),B(!0)},onMouseLeave:()=>{Ne.current=window.setTimeout(()=>{B(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),E&&e.jsxs("div",{onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),B(!0)},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(Ne.current=window.setTimeout(()=>{B(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ge.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ge.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ge.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ge.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ge.has("å‚è€ƒå›¾")||Ge.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ge.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("edit")},onMouseLeave:()=>{N.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),V==="edit"&&e.jsxs("div",{onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("edit")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(N.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Qe.filter(o=>Wt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),he(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),Qe.every(o=>Wt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Ks.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),Ae.current&&(clearTimeout(Ae.current),Ae.current=null),Ce(!0)},onMouseLeave:()=>{Ae.current=window.setTimeout(()=>{Ce(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Ce(!0),onMouseLeave:()=>Ce(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Ce(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Ce(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),Re&&e.jsx("div",{onMouseEnter:()=>{Ae.current&&(clearTimeout(Ae.current),Ae.current=null),Ce(!0)},onMouseLeave:()=>{Ae.current=window.setTimeout(()=>{Ce(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:D.length>0?D.map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),ls("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Ks.showAiImage&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Ks.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("imageEdit")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),me==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("imageEdit")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(h.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Ks.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("video")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),me==="video"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("video")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(h.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ls("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ge.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ls("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ge.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ge.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ge.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ge.has("å‚è€ƒå›¾")||Ge.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ls("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ge.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ls("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Ks.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),$e.current&&(clearTimeout($e.current),$e.current=null),he(!0)},onMouseLeave:()=>{$e.current=window.setTimeout(()=>{he(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>he(!0),onMouseLeave:()=>he(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),he(!0)},onMouseOver:()=>oe(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),y&&e.jsxs("div",{onMouseEnter:()=>{$e.current&&(clearTimeout($e.current),$e.current=null),he(!0)},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&($e.current=window.setTimeout(()=>{he(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Qe.filter(o=>Wt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),o==="å¯¹å£å‹"?ls("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?ls("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ls("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),he(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),Qe.every(o=>Wt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showUpload&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Ks.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Ks.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(mn,{isOpen:Ct,onClose:()=>{_t(!1),gt(null)},onAssetSelect:sa}),Is&&Ns&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Es(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Es(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),S=document.getElementById("shot-input"),M=parseInt((o==null?void 0:o.value)||"0"),H=parseInt((S==null?void 0:S.value)||"0");if(M>0&&H>0){if(Ye.find(ke=>ke.id!==Ns&&ke.scene===M&&ke.shot===H)){m.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${M}å¹•-ç¬¬${H}é•œ`);return}yt(ke=>{const De=ke.map(He=>He.id===Ns?{...He,scene:M,shot:H,name:`ç¬¬${M}å¹•-ç¬¬${H}é•œ`}:He),Pe=De.find(He=>He.id===Ns);return Pe&&R(He=>{const Fe=new Set;return f.forEach(rt=>{if(Pe.nodeIds.includes(rt.source)){const Xe=He.find(Le=>Le.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&Fe.add(rt.target)}}),He.map(rt=>Pe.nodeIds.includes(rt.id)||Fe.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Pe,nodeGroups:De}}}:rt)}),setTimeout(()=>{qs()},100),De}),Es(!1),Bs(null),m.success(`å·²å‘½åä¸ºï¼šç¬¬${M}å¹•-ç¬¬${H}é•œ`)}else m.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},En=()=>e.jsx(va,{children:e.jsx(wn,{})});export{En as default};
