const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cwo4xSFf.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-Bx9TjMy5.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Vt,u as Cr,z as $s,e as xa,d as ba}from"./react-vendor-BvY2dB7B.js";import{u as Ar,l as wa,b as Ce,_ as ds,c as m,e as ya}from"./index-Cwo4xSFf.js";import{P as ut,H as gs,a as Qt,b as Ls,d as Fs,e as zs,g as ka,R as va,f as Na,h as ja,i as Ia,j as Sa,C as Ea}from"./reactflow-D8v6_Qvs.js";import{C as Ca,L as Ds,S as mr,I as Lr,T as Br,V as Aa}from"./video-CPXLMxBS.js";import{c as Us}from"./createLucideIcon-CK1cQnin.js";import{X as _a,j as Qs,L as Vs,o as Pr,a as Ta,v as or,U as Or,b as Ua,N as Ra}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Us("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Us("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Us("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Us("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Us("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Us("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Us("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Er=Us("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Us("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Us("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hr=Us("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=Us("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),za="https://api.waule.ai";function Ba(s){const{workflowId:j,isSharedWorkflow:n,isReadOnly:V,onNodeAdd:me,onNodeUpdate:T,onNodeDelete:fe,onNodeMove:K,onNodesMove:re,onEdgeAdd:Y,onEdgeDelete:ce,onGroupsUpdate:Re,onUserJoin:de}=s,ee=t.useRef(null),ae=t.useRef(!1),{token:je}=Ar(),[ie,be]=t.useState([]);t.useEffect(()=>{if(!n||!j||!je)return;const f=wa(za,{auth:{token:je},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return ee.current=f,f.on("connect",()=>{ae.current=!0,f.emit("join-workflow",j),f.emit("user:join",{workflowId:j})}),f.on("disconnect",x=>{ae.current=!1}),f.on("connect_error",x=>{}),f.on("node:add",x=>{me==null||me(x.node,x.userId)}),f.on("node:update",x=>{T==null||T(x.nodeId,x.changes,x.userId)}),f.on("node:delete",x=>{fe==null||fe(x.nodeId,x.userId)}),f.on("node:move",x=>{K==null||K(x.nodeId,x.position,x.userId)}),f.on("nodes:move",x=>{re==null||re(x.nodes,x.userId)}),f.on("edge:add",x=>{Y==null||Y(x.edge,x.userId)}),f.on("edge:delete",x=>{ce==null||ce(x.edgeId,x.userId)}),f.on("groups:update",x=>{Re==null||Re(x.groups,x.userId)}),f.on("user:join",x=>{de==null||de(x.user)}),f.on("users:online",x=>{be(x.users)}),()=>{ee.current&&(ee.current.emit("leave-workflow",j),ee.current.disconnect(),ee.current=null),ae.current=!1,be([])}},[j,n,je]);const ge=t.useCallback(f=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("node:add",{workflowId:j,node:f})},[j,V]),pe=t.useCallback((f,x)=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("node:update",{workflowId:j,nodeId:f,changes:x})},[j,V]),Ie=t.useCallback(f=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("node:delete",{workflowId:j,nodeId:f})},[j,V]),te=t.useCallback((f,x)=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("node:move",{workflowId:j,nodeId:f,position:x})},[j,V]),Z=t.useCallback(f=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("nodes:move",{workflowId:j,nodes:f})},[j,V]),U=t.useCallback(f=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("edge:add",{workflowId:j,edge:f})},[j,V]),R=t.useCallback(f=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("edge:delete",{workflowId:j,edgeId:f})},[j,V]),L=t.useCallback(f=>{ee.current&&ae.current&&j&&!V&&ee.current.emit("groups:update",{workflowId:j,groups:f})},[j,V]);return{isConnected:ae.current,onlineUsers:ie,emitNodeAdd:ge,emitNodeUpdate:pe,emitNodeDelete:Ie,emitNodeMove:te,emitNodesMove:Z,emitEdgeAdd:U,emitEdgeDelete:R,emitGroupsUpdate:L}}const cr=2560,Ha=10,kr=(s,j=cr,n=.9)=>new Promise((V,me)=>{const T=new Image,fe=URL.createObjectURL(s);T.onload=()=>{URL.revokeObjectURL(fe);let{width:K,height:re}=T;const Y=Math.min(K,re);if(Y>j){const ee=j/Y;K=Math.round(K*ee),re=Math.round(re*ee)}const ce=document.createElement("canvas");ce.width=K,ce.height=re;const Re=ce.getContext("2d");if(!Re){me(new Error("Failed to get canvas context"));return}Re.drawImage(T,0,0,K,re);const de=ce.toDataURL("image/jpeg",n);V(de)},T.onerror=()=>{URL.revokeObjectURL(fe),me(new Error("Failed to load image for compression"))},T.src=fe}),Gr=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(n=>n.test(s)):!1,Xa=async s=>{try{const j=s.startsWith("/uploads/")?`https://api.waule.ai${s}`:s,V=await(await fetch(j)).blob();return await kr(V,cr,.9)}catch(j){throw j}},ur=async s=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(s.length>500*1024)try{const me=await(await fetch(s)).blob();return await kr(me,cr,.9)}catch{return s}return s}const j=s.includes("aliyuncs.com")||s.includes("oss-cn-"),n=s.startsWith("https://")&&!Gr(s);if(j||n)try{const V=new AbortController,me=setTimeout(()=>V.abort(),3e4);let T=0;try{const de=(await fetch(s,{method:"HEAD",signal:V.signal})).headers.get("content-length");de&&(T=parseInt(de)/(1024*1024))}catch{}const fe=await fetch(s,{signal:V.signal});clearTimeout(me);const K=await fe.blob();if(K.size/(1024*1024)>Ha)return await kr(K,cr,.85);const Y=await Ja(K);return Math.min(Y.width,Y.height)>cr?await kr(K,cr,.9):s}catch(V){if(V.name==="AbortError")throw new Error("å›¾ç‰‡ä¸‹è½½è¶…æ—¶");return s}return Gr(s)?await Xa(s):s},Ja=s=>new Promise((j,n)=>{const V=new Image,me=URL.createObjectURL(s);V.onload=()=>{URL.revokeObjectURL(me),j({width:V.width,height:V.height})},V.onerror=()=>{URL.revokeObjectURL(me),n(new Error("Failed to load image"))},V.src=me}),St=({type:s,position:j,id:n,className:V="",label:me,isConnectable:T,disabled:fe,style:K,...re})=>{const Y=j===ut.Left,ce=T===!1||fe?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${V}`;return e.jsxs("div",{className:`absolute ${Y?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...K||{}},children:[Y&&me&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:me}),e.jsx(gs,{type:s,position:j,id:n,isConnectable:fe?!1:T,style:{position:"relative",[Y?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${ce} !z-[10001]`,...re}),!Y&&me&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:me})]})},os=({value:s,onChange:j,options:n,className:V=""})=>{const[me,T]=t.useState(!1),fe=t.useRef(null);t.useEffect(()=>{if(!me)return;const Y=ce=>{fe.current&&!fe.current.contains(ce.target)&&T(!1)};return document.addEventListener("mousedown",Y,!0),()=>document.removeEventListener("mousedown",Y,!0)},[me]);const K=n.find(Y=>Y.value===s),re=Y=>{Y.stopPropagation(),T(!me)};return e.jsxs("div",{className:`relative ${V}`,ref:fe,children:[e.jsxs("div",{onClick:re,onMouseDown:Y=>Y.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(K==null?void 0:K.label)||s}),e.jsx(Ca,{size:12,className:`transition-transform ${me?"rotate-90":""}`})]}),me&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white dark:bg-[#18181b] backdrop-blur-xl border-slate-200 dark:border-white/10",children:n.map(Y=>e.jsxs("div",{onClick:ce=>{ce.stopPropagation(),j(Y.value),T(!1)},onMouseDown:ce=>ce.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[Y.label,s===Y.value&&e.jsx(Da,{size:10,className:"text-neutral-500"})]},Y.value))})]})},Ss=s=>{const[j,n]=t.useState(null),[V,me]=t.useState(!1),[T,fe]=t.useState(!1),[K,re]=t.useState(0),[Y,ce]=t.useState(0),Re=t.useCallback(()=>{ce(de=>de+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){n(null),fe(!1),re(0);return}try{me(!0);const ae=(await Ce.post("/billing/estimate",s)).data,je=(ae==null?void 0:ae.data)??ae,ie=(je==null?void 0:je.originalCredits)??(je==null?void 0:je.credits)??0;n(ie),fe((je==null?void 0:je.isFreeUsage)??!1),re((je==null?void 0:je.freeUsageRemaining)??0)}catch{n(null),fe(!1),re(0)}finally{me(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,Y]),{credits:j,loading:V,isFreeUsage:T,freeUsageRemaining:K,refetch:Re}},hs=({createdBy:s,isSharedWorkflow:j})=>{if(!j||!s||typeof s=="string")return null;const{nickname:n,avatar:V}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:n||"æœªçŸ¥ç”¨æˆ·",children:V?e.jsx("img",{src:V,alt:n||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-neutral-800 to-neutral-700 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(n||"?")[0].toUpperCase()})})},qa=({data:s,selected:j,id:n})=>{var oe;const[V,me]=t.useState(s.isExpanded!==!1),[T,fe]=t.useState(null),[K,re]=t.useState(s.config.prompt||""),[Y,ce]=t.useState(s.config.ratio||""),[Re,de]=t.useState(s.config.imageSize||"2K"),[ee,ae]=t.useState(s.config.maxImages||1),[je,ie]=t.useState(!1),[,be]=t.useState(0),[,ge]=t.useState(s.config.taskId||""),[pe,Ie]=t.useState(s.config.referenceImages||[]),[te,Z]=t.useState(null),U=t.useRef(null),R=t.useRef(!1),{setNodes:L,setEdges:f,getNode:x,getEdges:_,getNodes:F}=Qt(),G=Ls(),v=Fs(N=>N.edges.filter(h=>h.target===n)),$=t.useRef(""),r=t.useRef(""),{credits:b,loading:d,isFreeUsage:a,freeUsageRemaining:w,refetch:c}=Ss({aiModelId:T==null?void 0:T.id,quantity:1,resolution:Re}),p=t.useMemo(()=>(s.models||[]).filter(N=>N.type==="IMAGE_GENERATION"&&N.isActive&&!N.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const N=p.find(h=>h.id===s.config.modelId);if(N){fe(N);const h=N.config;h!=null&&h.supportedRatios&&h.supportedRatios.length>0&&!Y&&ce(h.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(h==null?void 0:h.acceptedInputs)||["TEXT","IMAGE"]})}}else if(p.length>0){fe(p[0]);const N=p[0].config;N!=null&&N.supportedRatios&&N.supportedRatios.length>0&&!Y&&ce(N.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(N==null?void 0:N.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,p]),t.useEffect(()=>{const N=s.config.taskId;(async()=>{if(N)try{const k=(await Ce.tasks.getTaskStatus(N)).task;if(k.status==="SUCCESS"){ie(!1),be(100);const J=k.resultUrl;if(!J){ie(!1),be(0),l({taskId:""}),Vt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ue=s.config.ratio||"1:1";l({prompt:s.config.prompt||K,ratio:ue,modelId:s.config.modelId||(T==null?void 0:T.id),generatedImageUrl:J,taskId:""});const B=F(),he=_();if(B.filter($e=>$e.type==="imagePreview"&&he.some(Ae=>Ae.source===n&&Ae.target===$e.id)).find($e=>$e.data.imageUrl===J)){l({taskId:""}),Vt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Vt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const $e=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse($e).some(Te=>Te.taskId&&Te.taskId===N||Te.sourceNodeId&&Te.sourceNodeId===n)||xe(J,ue)}catch{xe(J,ue)}}else k.status==="PROCESSING"||k.status==="PENDING"?(ie(!0),be(k.progress||0),X(N)):k.status==="FAILURE"&&(ie(!1),be(0),l({taskId:""}),Vt.error(k.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${k.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ie(!1),be(0),l({taskId:""}),Vt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const g=()=>{if(!T)return[];const N=T.config;return(N==null?void 0:N.supportedRatios)||[]},y=()=>{var k;const N=(k=s==null?void 0:s.config)==null?void 0:k.modelId,h=p.find(J=>J.id===N)||p[0],E=(h==null?void 0:h.config)||{};return E.maxReferenceImages||E.supportedReferenceImagesLimit||E.referenceImagesLimit||10};function C(N){var E,k,J,ue,B,he,Ee;const h=(N==null?void 0:N.type)||"";if(h==="upload")return(((k=(E=N==null?void 0:N.data)==null?void 0:E.config)==null?void 0:k.uploadedFiles)||[]).reduce(($e,Ae)=>{const _e=((Ae==null?void 0:Ae.type)||"").toUpperCase(),Te=((Ae==null?void 0:Ae.mimeType)||"").toLowerCase();return $e+(_e==="IMAGE"||Te.startsWith("image/")?1:0)},0);if(h==="assetSelector"){const Ne=((J=N==null?void 0:N.data)==null?void 0:J.config)||{};if(Ne.selectedAsset){const $e=(Ne.selectedAsset.type||"").toUpperCase(),Ae=(Ne.selectedAsset.mimeType||"").toLowerCase();return $e==="IMAGE"||Ae.startsWith("image/")?1:0}return Array.isArray(Ne.subjects)&&Ne.subjects.length>0&&(((ue=Ne.subjects[0])==null?void 0:ue.images)||[]).length>0?1:0}return h==="aiImage"?((he=(B=N==null?void 0:N.data)==null?void 0:B.config)==null?void 0:he.generatedImageUrl)?1:0:h==="imagePreview"&&((Ee=N==null?void 0:N.data)==null?void 0:Ee.imageUrl)?1:0}function O(N){var k,J,ue,B;const h=(N==null?void 0:N.type)||"",E=N==null?void 0:N.data;if(h==="upload"&&((J=(k=E==null?void 0:E.config)==null?void 0:k.uploadedFiles)==null?void 0:J.length)>0){const he=E.config.uploadedFiles[0],Ee=(he.type||"").toUpperCase(),Ne=(he.mimeType||"").toLowerCase();return Ee==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ee==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ee==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ee||null}if(h==="assetSelector"){if((ue=E==null?void 0:E.config)!=null&&ue.subjects)return"IMAGE";if((B=E==null?void 0:E.config)!=null&&B.selectedAsset){const he=E.config.selectedAsset,Ee=(he.type||"").toUpperCase(),Ne=(he.mimeType||"").toLowerCase();return Ee==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ee==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ee==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ee||null}}return h==="aiImage"||h==="imagePreview"?"IMAGE":(h||"").startsWith("aiVideo")||h==="videoPreview"?"VIDEO":h==="agent"?"TEXT":null}const I=t.useMemo(()=>{const N=v,h=N.some(J=>{const ue=x(J.source);return((ue==null?void 0:ue.type)||"")==="agent"}),E=y(),k=N.reduce((J,ue)=>J+C(x(ue.source)),0);return h&&k>=E},[v,x]),u=N=>{const h=x(N.source);if(!h)return!1;const E=h.type||"",k=_().filter(Ne=>Ne.target===n),J=O(h);if(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")return!1;const ue=k.some(Ne=>{const $e=x(Ne.source);return(($e==null?void 0:$e.type)||"")==="agent"});if(E==="agent"||E==="textPreview")return!ue;const B=k.reduce((Ne,$e)=>Ne+C(x($e.source)),0),he=C(h),Ee=y();return B+he<=Ee};t.useEffect(()=>{const N=v;let E=y();const k=[];N.forEach(J=>{const ue=x(J.source),B=C(ue);B<=0||(E-B>=0?E-=B:k.push(J.id))}),k.length>0&&(f(J=>J.filter(ue=>!k.includes(ue.id))),Vt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[v,x,f]),t.useEffect(()=>{const N=v,h=[];N.forEach(E=>{const k=x(E.source),J=O(k);(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")&&h.push(E.id)}),h.length>0&&(f(E=>E.filter(k=>!h.includes(k.id))),Vt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[v,x,f]),t.useEffect(()=>{const N=v.map(ue=>{var Ne,$e,Ae,_e,Te;const B=x(ue.source);if(!B)return`${ue.id}-${ue.source}`;const he=B.data||{};let Ee=[];if(B.type==="assetSelector"){const le=(Ne=he.config)==null?void 0:Ne.subjects;if(le&&le.length>0){const Ve=($e=le[0].images)==null?void 0:$e[0];Ee=Ve?[Ve]:[]}else(Ae=he.config)!=null&&Ae.selectedAsset&&he.config.selectedAsset.type==="IMAGE"&&(Ee=[he.config.selectedAsset.url])}else if(B.type==="upload")Ee=(((_e=he.config)==null?void 0:_e.uploadedFiles)||[]).filter(Ve=>Ve.type==="IMAGE").map(Ve=>Ve.url);else if(B.type==="aiImage"||B.type==="imagePreview"){const le=((Te=he.config)==null?void 0:Te.generatedImageUrl)||he.imageUrl;le&&(Ee=[le])}return`${ue.id}-${ue.source}-${Ee.join("|")}`}).sort().join(",");if(N===$.current)return;$.current=N;const h=[];let E="";v.forEach(ue=>{var he,Ee,Ne,$e,Ae,_e;const B=x(ue.source);if(B){const Te=B.data;if(B.type==="agent"&&((he=Te.config)!=null&&he.generatedText)?E||(E=Te.config.generatedText):B.type==="textPreview"&&Te.content&&(E||(E=Te.content)),B.type==="assetSelector"&&((Ee=Te.config)!=null&&Ee.subjects)&&Te.config.subjects.length>0){const Ve=(Ne=Te.config.subjects[0].images)==null?void 0:Ne[0];Ve&&!h.includes(Ve)&&h.push(Ve)}let le=(($e=Te.config)==null?void 0:$e.generatedImageUrl)||Te.imageUrl||"";if(!le&&((Ae=Te.config)!=null&&Ae.selectedAsset)){const Ve=Te.config.selectedAsset;Ve.type==="IMAGE"&&(le=Ve.url)}if(!le&&((_e=Te.config)!=null&&_e.uploadedFiles)&&Te.config.uploadedFiles.length>0){const Ve=Te.config.uploadedFiles[0];Ve.type==="IMAGE"&&(le=Ve.url)}le&&!h.includes(le)&&h.push(le)}});const k=y(),J=h.slice(0,Math.max(0,k));Ie(J),l({referenceImages:J}),E&&E!==K&&(re(E),l({prompt:E}))},[v,x,n,K,G]),t.useEffect(()=>{if(v.length===0)return;let N="",h="";v.forEach(E=>{var J;const k=G.find(ue=>ue.id===E.source);if(k&&k.type==="agent"){const ue=k.data;(J=ue.config)!=null&&J.generatedText&&(N=ue.config.generatedText,h=`${k.id}-${ue.config.generatedText.substring(0,50)}`)}}),N&&h!==r.current&&(r.current=h,re(N),l({prompt:N}))},[G,v,n]),t.useEffect(()=>{const N=U.current;N&&V&&requestAnimationFrame(()=>{N.style.height="auto";const h=Math.max(60,Math.min(N.scrollHeight,600));N.style.height=`${h}px`})},[K,V]),t.useEffect(()=>{const N=setTimeout(()=>{K!==s.config.prompt&&l({prompt:K})},300);return()=>clearTimeout(N)},[K]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==K&&re(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{Y&&Y!==s.config.ratio&&l({ratio:Y})},[Y]),t.useEffect(()=>{Re&&Re!==s.config.imageSize&&l({imageSize:Re})},[Re]),t.useEffect(()=>{var N;if((T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"){const h=((N=T==null?void 0:T.config)==null?void 0:N.supportedResolutions)||[];(h.length>0&&!h.includes(Re)||h.length===1)&&de(h[0])}},[T]),t.useEffect(()=>{ee!==s.config.maxImages&&l({maxImages:ee})},[ee]);const l=N=>{x(n)&&L(E=>E.map(k=>k.id===n?{...k,data:{...k.data,config:{...k.data.config,...N}}}:k))},i=N=>{Z(N)},z=(N,h)=>{if(N.preventDefault(),te===null||te===h)return;const E=[...pe],k=E[te];E.splice(te,1),E.splice(h,0,k),Ie(E),Z(h)},D=()=>{Z(null),l({referenceImages:pe})},X=async N=>{let E=0;const k=async()=>{var J;try{E++;const B=(await Ce.tasks.getTaskStatus(N)).task;if(be(B.progress||0),B.status==="SUCCESS"){ie(!1),be(100);const he=B.resultUrl,Ee=(J=B.metadata)==null?void 0:J.allImageUrls;l({prompt:K,ratio:Y,modelId:T==null?void 0:T.id,generatedImageUrl:he,taskId:""}),Ee&&Ee.length>1?(ne(Ee,Y),Vt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Ee.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(xe(he,Y),Vt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(B.status==="FAILURE"){ie(!1),be(0),l({taskId:""});const{useAuthStore:he}=await ds(async()=>{const{useAuthStore:Ne}=await import("./index-Cwo4xSFf.js").then($e=>$e.f);return{useAuthStore:Ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ee}=he.getState();await Ee(),Vt.error(B.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(B.status==="PROCESSING"||B.status==="PENDING")&&(E<600?setTimeout(k,1e3):(ie(!1),be(0),l({taskId:""}),Vt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ie(!1),be(0),l({taskId:""}),Vt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};k()},W=async()=>{var N,h,E,k,J;if(!(!K.trim()||!T)){ie(!0),be(0);try{let ue=[];if(pe.length>0)try{for(let Te=0;Te<pe.length;Te++){const le=pe[Te];try{const Ve=await ur(le);ue.push(Ve)}catch{}}}catch{}let B=K.trim();T.modelId==="doubao-seedream-4-5-251128"&&ee>1&&(B=`ç”Ÿæˆä¸€ç»„å…±${ee}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${B}`),T.modelId==="gemini-3-pro-image-preview"&&Y&&(B=`${B}ï¼Œç”Ÿæˆ${Y}çš„æ¯”ä¾‹`);const he={modelId:T.id,prompt:B,ratio:Y||"1:1",referenceImages:ue.length>0?ue:void 0};T.modelId==="gemini-3-pro-image-preview"&&(he.imageSize=Re),T.modelId==="doubao-seedream-4-5-251128"&&ee>1&&(he.maxImages=ee);const Ee=await Ce.tasks.createImageTask(he),Ne=Ee.taskId,$e=Ee.creditsCharged||0,Ae=Ee.isFreeUsage,_e=Ee.freeUsageRemaining??0;if(ge(Ne),l({prompt:K,ratio:Y,modelId:T.id,taskId:Ne}),Ae)Vt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${_e} æ¬¡æœºä¼š`),c();else if($e>0){const{useAuthStore:Te}=await ds(async()=>{const{useAuthStore:Ve}=await import("./index-Cwo4xSFf.js").then(et=>et.f);return{useAuthStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:le}=Te.getState();await le(),Vt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${$e} ç§¯åˆ†`),c()}else Vt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");X(Ne)}catch(ue){if(ie(!1),be(0),((N=ue.response)==null?void 0:N.status)===403){const B=((E=(h=ue.response)==null?void 0:h.data)==null?void 0:E.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Vt.error(B)}else{const B=((J=(k=ue.response)==null?void 0:k.data)==null?void 0:J.error)||ue.message||"æœªçŸ¥åŸå› ";Vt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ne=(N,h)=>{!N||N.length===0||N.forEach((E,k)=>{setTimeout(()=>{xe(E,h,k)},k*100)})},xe=(N,h,E)=>{const k=x(n);if(!k)return;const J=1,ue=F(),B=_(),he=ue.filter(yt=>yt.type==="imagePreview"&&B.some(Be=>Be.source===n&&Be.target===yt.id));if(he.find(yt=>yt.data.imageUrl===N))return;const Ne=400,$e=(yt,Be=300)=>{if(!yt||!/^[0-9]+\s*:\s*[0-9]+$/.test(yt))return Be;const[wt,Kt]=yt.split(":").map(vs=>parseFloat(vs));return!wt||!Kt?Be:Math.round(Ne*(Kt/wt))},Ae=document.querySelector(`.react-flow__node[data-id="${n}"]`),_e=(Ae==null?void 0:Ae.getBoundingClientRect().width)||400,Te=Math.round(_e/J),le=200,Ve=100,et=$e(h,300),Ft=k.position.x+Te+le,Mt=k.position.y,At=E!==void 0?he.length+E:he.length,ct=Ft,gt=Mt+At*(et+Ve),vt=Date.now(),it={id:`preview-${n}-${vt}`,type:"imagePreview",position:{x:ct,y:gt},data:{imageUrl:N,width:Ne,ratio:h,workflowContext:k.data.workflowContext,createdBy:k.data.createdBy}};L(yt=>[...yt,it]);const Ke={id:`edge-${n}-${it.id}`,source:n,target:it.id,targetHandle:`${it.id}-target`,type:"aurora"};f(yt=>yt.find(wt=>wt.source===n&&wt.target===it.id)?yt:[...yt,Ke])};if(t.useEffect(()=>{s.isExpanded!==void 0&&me(s.isExpanded)},[s.isExpanded]),!V&&s.config.generatedImageUrl){const[N,h]=(s.config.ratio||"1:1").split(":").map(Number),E=N/h,k=320,J=k/E;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:k,height:J},onDoubleClick:()=>{me(!0),x(n)&&L(B=>B.map(he=>he.id===n?{...he,data:{...he.data,isExpanded:!0}}:he))},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:I,isValidConnection:u}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),K&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:K,children:K})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!V&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{me(!0),x(n)&&L(h=>h.map(E=>E.id===n?{...E,data:{...E.data,isExpanded:!0}}:E))},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:I,isValidConnection:u}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:K?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:K})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:I,isValidConnection:u}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:V?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:(T==null?void 0:T.id)||"",onChange:N=>{const h=p.find(E=>E.id===N);if(fe(h||null),h){const E=h.config;E!=null&&E.supportedRatios&&E.supportedRatios.length>0&&ce(E.supportedRatios[0]),l({modelId:h.id,acceptedInputs:(E==null?void 0:E.acceptedInputs)||["TEXT","IMAGE"]})}},options:p.map(N=>({value:N.id,label:N.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:U,value:K,onChange:N=>{R.current=!0,re(N.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),pe.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",pe.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:pe.map((N,h)=>e.jsxs("div",{draggable:!0,onDragStart:E=>{E.stopPropagation(),i(h)},onDragEnd:E=>{E.stopPropagation(),D()},onDragOver:E=>{E.stopPropagation(),z(E,h)},className:`nodrag relative group cursor-move aspect-square ${te===h?"opacity-50":""}`,children:[e.jsx("img",{src:N,alt:`å›¾ç‰‡${h+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:h+1})]},h))})]}),(T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"&&(()=>{var h;const N=((h=T==null?void 0:T.config)==null?void 0:h.supportedResolutions)||[];return N.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${N.length} gap-2`,children:N.map(E=>e.jsx("button",{onClick:()=>de(E),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Re===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:E==="4K"?"4k":"hd"}),e.jsx("span",{children:E})]})},E))})]})})(),(T==null?void 0:T.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-neutral-500 dark:text-neutral-400",children:[ee," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:ee,onChange:N=>ae(Number(N.target.value)),className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(ee-1)/14*50}%, #06b6d4 ${(ee-1)/14*100}%, var(--range-bg-color) ${(ee-1)/14*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),ee>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),g().length>0&&e.jsx("div",{className:"space-y-1",children:((oe=T==null?void 0:T.provider)==null?void 0:oe.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>ce("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Y==="16:9"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>ce("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Y==="9:16"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(os,{value:Y,onChange:N=>ce(N),options:g().map(N=>{const[h,E]=N.split(":");return{value:N,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[N]||`${h}:${E}`}})})]})}),e.jsx("button",{onClick:N=>{N.stopPropagation(),W()},onPointerDown:N=>N.stopPropagation(),onMouseDown:N=>N.stopPropagation(),disabled:je||!K.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${je||!K.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:je?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!d&&(a?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(w),"æ¬¡"]}):b!==null&&b>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[b,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ka=t.memo(qa),fr="https://api.waule.ai",Ya=({data:s,selected:j,id:n})=>{var sr,rr,Ps,q,se,Me,Ge,qe,Oe,tt,bt;const[V,me]=t.useState(!0),[,T]=t.useState(0),[fe,K]=t.useState(s.config.taskId||""),re=s.config.modelId,Y=s.config.duration||5,ce=s.config.resolution||"720p",{credits:Re,loading:de,isFreeUsage:ee,freeUsageRemaining:ae,refetch:je}=Ss({aiModelId:re,duration:Y,resolution:ce});t.useEffect(()=>{},[fe]);const{setNodes:ie,setEdges:be,getNode:ge,getNodes:pe,getEdges:Ie}=Qt(),te=zs(),Z=Ls(),U=t.useRef(""),R=(sr=s.config)==null?void 0:sr.selectedEditingCapability,L=t.useMemo(()=>{const A=(s.models||[]).filter(P=>{var we;return((we=P.provider)==null?void 0:we.toLowerCase())!=="sora"&&P.id!=="sora-video"});if(R){const P=A.filter(Se=>Se.type==="VIDEO_EDITING").filter(Se=>{var ye;return Array.isArray((ye=Se==null?void 0:Se.config)==null?void 0:ye.supportedEditingCapabilities)&&Se.config.supportedEditingCapabilities.includes(R)}),we=A.filter(Se=>Se.type==="VIDEO_GENERATION").filter(Se=>{var kt,ht;if(R!=="è§†é¢‘æ¢äºº")return!1;const ye=((kt=Se==null?void 0:Se.config)==null?void 0:kt.supportsVideoEditing)===!0,st=(Array.isArray((ht=Se==null?void 0:Se.config)==null?void 0:ht.supportedGenerationTypes)?Se.config.supportedGenerationTypes:[]).some(We=>(We||"").toLowerCase().includes("æ¢äºº")||(We||"").includes("è§†é¢‘æ¢äºº"));return ye||st}),Ue={};return[...P,...we].forEach(Se=>{Ue[Se.id]||(Ue[Se.id]=Se)}),Object.values(Ue)}return A.filter(P=>P.type==="VIDEO_GENERATION")},[s.models,R]),[f,x]=t.useState(s.config.prompt||""),_=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==f&&x(s.config.prompt)},[s.config.prompt]);const[F,G]=t.useState(s.config.modelId||((rr=L[0])==null?void 0:rr.id)||""),[v,$]=t.useState(s.config.ratio||"16:9"),[r,b]=t.useState(s.config.resolution||""),d=t.useCallback(A=>{const P=(A||"").toLowerCase();return P?P.includes("æ–‡ç”Ÿ")||P.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":P.includes("é¦–å°¾")?"é¦–å°¾å¸§":P.includes("é¦–å¸§")||P.includes("first frame")||P.includes("start frame")||P.includes("initial frame")||P.includes("keyframe")?"é¦–å¸§":P.includes("å°¾å¸§")||P.includes("last frame")||P.includes("end frame")||P.includes("final frame")?"å°¾å¸§":P.includes("ä¸»ä½“å‚è€ƒ")||P.includes("å‚è€ƒ")||P.includes("reference image")||P.includes("image reference")||P.includes("ref image")?"å‚è€ƒå›¾":P.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":P.includes("first-last")||P.includes("two-frame")||P.includes("frame pair")?"é¦–å°¾å¸§":P.includes("first")?"é¦–å¸§":P.includes("last")?"å°¾å¸§":P.includes("subject")||P.includes("reference")?"å‚è€ƒå›¾":A||"":""},[]),[a,w]=t.useState((s.config.lockedGenerationType?d(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[c,p]=t.useState(s.config.duration||5),[g,y]=t.useState(s.config.audio||!1),[C,O]=t.useState(s.config.movementAmplitude||"auto"),[I,u]=t.useState(!1),[l,i]=t.useState([]),[z,D]=t.useState(null),[X,W]=t.useState(!1),[ne]=t.useState(""),[xe]=t.useState("confirm"),[oe]=t.useState(null),[N,h]=t.useState(!1),[E,k]=t.useState([]),[J,ue]=t.useState(""),[B,he]=t.useState(0),[Ee,Ne]=t.useState(0),[$e,Ae]=t.useState({}),[_e,Te]=t.useState([]),le=L.find(A=>A.id===F);t.useEffect(()=>{var A,P;if(!L.find(we=>we.id===F)){const we=((A=L[0])==null?void 0:A.id)||"";G(we),ct({modelId:we,modelName:(P=L[0])==null?void 0:P.name})}},[L]),t.useEffect(()=>{var A;if((A=le==null?void 0:le.config.supportedResolutions)!=null&&A.length){const P=le.config.supportedResolutions;if(!r||!P.includes(r)){const we=P[0];b(we),ct({resolution:we})}}},[le==null?void 0:le.id]),t.useEffect(()=>{var we;const A=(we=le==null?void 0:le.modelId)==null?void 0:we.includes("viduq2"),P=d(a)==="é¦–å°¾å¸§";A&&P&&c>8&&(p(8),ct({duration:8}))},[a,le==null?void 0:le.modelId]);const Ve=((Ps=le==null?void 0:le.provider)==null?void 0:Ps.toLowerCase())==="sora",et=t.useMemo(()=>{var A,P,we,Ue;if((A=le==null?void 0:le.config.supportedDurations)!=null&&A.length){let Se=le.config.supportedDurations;const ye=(P=le.modelId)==null?void 0:P.includes("viduq2"),Ze=d(a)==="é¦–å°¾å¸§";return ye&&Ze&&(Se=Se.filter(kt=>kt<=8)),(((we=le.provider)==null?void 0:we.toLowerCase())==="minimax"||((Ue=le.modelId)==null?void 0:Ue.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(Se=Se.filter(kt=>kt===6)),Se}return[c||5]},[le,c,a,d,r]),Ft=t.useMemo(()=>{var A;return(A=le==null?void 0:le.config.supportedResolutions)!=null&&A.length?le.config.supportedResolutions:[]},[le]),Mt=!le||!((q=le.config.supportedDurations)!=null&&q.length),At=!le||!((se=le.config.supportedResolutions)!=null&&se.length),ct=t.useCallback(A=>{ge(n)&&ie(we=>we.map(Ue=>Ue.id===n?{...Ue,data:{...Ue.data,config:{...Ue.data.config,...A}}}:Ue))},[ge,n,ie]);t.useEffect(()=>{if(et.length>0&&!et.includes(c)){const A=et[0];p(A),ct({duration:A})}},[et,c,ct]);const gt=(A,P)=>{const we=(kt,ht)=>ht===0?kt:we(ht,kt%ht),Ue=we(A,P),Se=A/Ue,ye=P/Ue,Ze={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},st=`${Se}:${ye}`;return Ze[st]||st},vt=()=>{const A=te.filter(Ze=>Ze.target===n),P=[];A.forEach(Ze=>{var kt;const st=ge(Ze.source);if(st&&st.type==="upload"&&(((kt=st.data.config)==null?void 0:kt.uploadedFiles)||[]).forEach(We=>{const Dt=We.type||We.mimeType||"";(Dt==="IMAGE"||Dt.startsWith("image/"))&&P.push({id:We.id||We.name,url:We.url,name:We.name||We.originalName,width:We.width,height:We.height,aspectRatio:We.width&&We.height?gt(We.width,We.height):"16:9"})}),st&&st.type==="assetSelector"){const ht=st.data.config||{},We=ht.subjects,Dt=ht.selectedAsset,Xt=d(a);We&&We.length>0?Xt==="é¦–å°¾å¸§"||(We[0].images||[]).forEach((zt,Ct)=>{P.push({id:`${st.id}-subject-${Ct}`,url:zt,name:We[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Dt&&Dt.type==="IMAGE"&&P.push({id:Dt.id,url:Dt.url,name:Dt.name||Dt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(st&&st.type==="imagePreview"){const ht=st.data.imageUrl,We=st.data.width,Dt=st.data.height;ht&&P.push({id:st.id,url:ht,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:We,height:Dt,aspectRatio:We&&Dt?gt(We,Dt):"16:9"})}});const we=new Set,Ue=[];P.forEach(Ze=>{const st=Ze.url;we.has(st)||(we.add(st),Ue.push(Ze))});const Se=d(a);let ye=[];return Se==="æ–‡ç”Ÿè§†é¢‘"?ye=[]:Se==="é¦–å¸§"||Se==="å°¾å¸§"?ye=Ue.slice(0,1):Se==="é¦–å°¾å¸§"?ye=Ue.slice(0,2):Se==="å‚è€ƒå›¾"?ye=Ue.slice(0,7):ye=Ue,ye},it=t.useMemo(()=>vt(),[te,Z,a,n]),Ke=A=>{if(!_.current)return;const P=_.current,we=P.selectionStart||f.length,Ue=f.slice(0,we),Se=f.slice(we),ye=`@${A} `,Ze=Ue+ye+Se;x(Ze),Ae(st=>({...st,[A]:`image-${A}`})),setTimeout(()=>{const st=we+ye.length;P.setSelectionRange(st,st),P.focus()},0)},yt=t.useCallback(async()=>{var A;if(!(_e.length>0))try{const P=await Ce.assetLibraries.getAll({includeShared:"true"}),we=P.data||P||[],Ue=[];for(const Se of we)if(Se.category==="ROLE")try{const ye=await Ce.assetLibraries.roles.list(Se.id),Ze=ye.data||ye||[];for(const st of Ze)Ue.push({id:st.id,name:((A=st.metadata)==null?void 0:A.name)||st.name||"",thumbnail:st.thumbnail})}catch{}Te(Ue)}catch{}},[_e.length]),Be=t.useCallback(A=>{if(!A){k(_e.slice(0,5));return}const P=_e.filter(we=>we.name.toLowerCase().includes(A.toLowerCase())).slice(0,5);k(P),Ne(0)},[_e]),wt=t.useCallback(A=>{const P=A.target.value,we=A.target.selectionStart||0;x(P);const Se=P.substring(0,we).match(/@([^@\s]*)$/);if(Se){const ye=Se[1];ue(ye),he(we-ye.length-1),h(!0),yt().then(()=>Be(ye))}else h(!1),k([])},[yt,Be]),Kt=t.useCallback(A=>{const P=f.substring(0,B),we=f.substring(B+J.length+1),Ue=`@${A.name} `,Se=P+Ue+we;x(Se),Ae(ye=>({...ye,[A.name]:A.id})),h(!1),k([]),ue(""),setTimeout(()=>{if(_.current){_.current.focus();const ye=P.length+Ue.length;_.current.setSelectionRange(ye,ye)}},0)},[f,B,J]),vs=t.useCallback(A=>{!N||E.length===0||(A.key==="ArrowDown"?(A.preventDefault(),Ne(P=>P<E.length-1?P+1:P)):A.key==="ArrowUp"?(A.preventDefault(),Ne(P=>P>0?P-1:P)):A.key==="Enter"&&E[Ee]?(A.preventDefault(),Kt(E[Ee])):A.key==="Escape"&&h(!1))},[N,E,Ee,Kt]);t.useEffect(()=>{const A=s.config.taskId;(async()=>{if(A){try{const Ue=(await Ce.tasks.getTaskStatus(A)).task;if(Ue.status==="SUCCESS"){u(!1),T(100);const Se=Ue.resultUrl;if(!Se){u(!1),T(0),ct({taskId:""}),K(""),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ye=s.config.ratio||"16:9";ct({prompt:s.config.prompt||f,ratio:ye,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:Se,taskId:""}),K("");const Ze=pe(),st=Ie();if(Ze.filter(We=>We.type==="videoPreview"&&st.some(Dt=>Dt.source===n&&Dt.target===We.id)).find(We=>We.data.videoUrl===Se)){setTimeout(()=>T(0),1e3);return}m.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const We=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(We).some(Pt=>Pt.taskId&&Pt.taskId===A||Pt.sourceNodeId&&Pt.sourceNodeId===n)||ws(Se,ye)}catch{ws(Se,ye)}setTimeout(()=>T(0),1e3)}else if(Ue.status==="PROCESSING"||Ue.status==="PENDING"){u(!0),T(Ue.progress||0),Xs(A);return}else Ue.status==="FAILURE"&&(u(!1),T(0),ct({taskId:""}),K(""),m.error(`ç”Ÿæˆå¤±è´¥: ${Ue.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{u(!1),T(0),ct({taskId:""}),K(""),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const A=te.filter(we=>we.target===n);let P="";A.forEach(we=>{var Se;const Ue=ge(we.source);if(Ue){const ye=Ue.data;Ue.type==="agent"&&((Se=ye.config)!=null&&Se.generatedText)?P||(P=ye.config.generatedText):Ue.type==="textPreview"&&ye.content&&(P||(P=ye.content))}}),P&&P!==f&&(x(P),ct({prompt:P}))},[te,n,ge,f,ct]),t.useEffect(()=>{const A=te.filter(Ue=>Ue.target===n);if(A.length===0)return;let P="",we="";A.forEach(Ue=>{var ye;const Se=Z.find(Ze=>Ze.id===Ue.source);if(Se&&Se.type==="agent"){const Ze=Se.data;(ye=Ze.config)!=null&&ye.generatedText&&(P=Ze.config.generatedText,we=`${Se.id}-${Ze.config.generatedText.substring(0,50)}`)}}),P&&we!==U.current&&(U.current=we,x(P),ct({prompt:P}))},[Z,te,n,ct]),t.useEffect(()=>{const A=JSON.stringify(it),P=JSON.stringify(l);A!==P&&i(it)},[it]);const Is=t.useMemo(()=>{const A=l.length,P=d(a);return A===0?!0:A===1?P==="å‚è€ƒå›¾":A===2?P==="é¦–å°¾å¸§"?!1:P==="å‚è€ƒå›¾":A>2?P==="å‚è€ƒå›¾":!1},[l.length,a,d]),Es=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Ns=t.useMemo(()=>{const A=d(a);return R?L:L.filter(P=>{var Ue;const we=(((Ue=P.config)==null?void 0:Ue.supportedGenerationTypes)||[]).map(Se=>d(Se));return A==="é¦–å¸§"||A==="å°¾å¸§"?we.includes("é¦–å¸§")||we.includes("å°¾å¸§"):we.includes(A)})},[L,a,d,R]),Bs=t.useMemo(()=>{const A=R?L:Ns;return A.length>0?A:R?(s.models||[]).filter(we=>(we.type||"")==="VIDEO_EDITING"):A},[R,L,Ns,s.models]);t.useEffect(()=>{var P,we;if(!Bs.find(Ue=>Ue.id===F)){const Ue=((P=Bs[0])==null?void 0:P.id)||"";G(Ue),ct({modelId:Ue||void 0,modelName:Ue?(we=Bs[0])==null?void 0:we.name:void 0})}},[Bs]);const fs=t.useCallback(A=>{const P=d(A);return R?["IMAGE","VIDEO"]:P==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[d,R]);t.useEffect(()=>{if(!Is&&l.length>0){const A=l[0].aspectRatio;A&&v!==A&&($(A),setTimeout(()=>{ct({ratio:A})},0))}},[Is,l,v]),t.useEffect(()=>{if(!R&&Es.length>0&&!Es.includes(a)){const A="æ–‡ç”Ÿè§†é¢‘";w(A),setTimeout(()=>{ct({generationType:A,acceptedInputs:fs(A)})},0)}},[Es,a,fs,R]),t.useEffect(()=>{d(a)==="é¦–å°¾å¸§"&&g&&(y(!1),ct({audio:!1}))},[a,d]),t.useEffect(()=>{const A=d(a);if(A==="æ–‡ç”Ÿè§†é¢‘")return;const P=te.filter(ye=>ye.target===n),we=[],Ue=[];P.forEach(ye=>{var kt,ht,We,Dt,Xt;const Ze=ge(ye.source);if(!Ze)return;const st=Ze.type;if((st||"").startsWith("aiVideo")||st==="videoPreview"){Ue.push(ye.id);return}if(st==="upload"){const Pt=(We=(ht=(kt=Ze.data)==null?void 0:kt.config)==null?void 0:ht.uploadedFiles)==null?void 0:We[0],zt=((Pt==null?void 0:Pt.type)||"").toUpperCase(),Ct=((Pt==null?void 0:Pt.mimeType)||"").toLowerCase();if(zt==="VIDEO"||Ct.startsWith("video/")){Ue.push(ye.id);return}(zt==="IMAGE"||Ct.startsWith("image/"))&&we.push(ye.id);return}if(st==="assetSelector"){const Pt=((Dt=Ze.data)==null?void 0:Dt.config)||{};if(Pt.selectedAsset){const zt=(Pt.selectedAsset.type||"").toUpperCase(),Ct=(Pt.selectedAsset.mimeType||"").toLowerCase();zt==="VIDEO"||Ct.startsWith("video/")?Ue.push(ye.id):(zt==="IMAGE"||Ct.startsWith("image/"))&&we.push(ye.id)}else if(Pt.subjects&&Pt.subjects.length>0){const zt=(((Xt=Pt.subjects[0])==null?void 0:Xt.images)||[]).length;A==="å‚è€ƒå›¾"||A==="é¦–å°¾å¸§"?we.push(ye.id):(A==="é¦–å¸§"||A==="å°¾å¸§")&&(zt>1?Ue.push(ye.id):we.push(ye.id))}return}(st==="aiImage"||st==="imagePreview")&&we.push(ye.id)});let Se=new Set([...Ue]);A==="é¦–å¸§"||A==="å°¾å¸§"?we.slice(1).forEach(ye=>Se.add(ye)):A==="é¦–å°¾å¸§"&&we.slice(2).forEach(ye=>Se.add(ye)),Se.size>0&&be(ye=>ye.filter(Ze=>!Se.has(Ze.id)))},[a,te,n,ge,be,d]),t.useEffect(()=>{const A=s.config.generationType;if(!A||d(A)!==d(a)){const P=d(a)||"æ–‡ç”Ÿè§†é¢‘";ct({generationType:P,acceptedInputs:fs(P)})}},[]),t.useEffect(()=>{const A=fs(a);ct({acceptedInputs:A})},[a,fs]);const Zs=A=>{D(A)},Hs=A=>{A.preventDefault()},nr=A=>{if(z===null)return;const P=[...l],[we]=P.splice(z,1);P.splice(A,0,we),i(P),D(null),ct({referenceImages:P})};t.useEffect(()=>{const A=_.current;A&&V&&requestAnimationFrame(()=>{A.style.height="auto";const P=Math.max(60,Math.min(A.scrollHeight,600));A.style.height=`${P}px`})},[f,V]),t.useEffect(()=>{if(f===s.config.prompt)return;const A=setTimeout(()=>{ct({prompt:f})},500);return()=>clearTimeout(A)},[f]);const _t=A=>{var we,Ue,Se;G(A);const P=Ns.find(ye=>ye.id===A);if(P){const ye=(we=P.config.supportedRatios)!=null&&we.length?P.config.supportedRatios:["16:9"],Ze=P.config.supportedResolutions||[],st=(Ue=P.config.supportedGenerationTypes)!=null&&Ue.length?P.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],kt=(Se=P.config.supportedDurations)!=null&&Se.length?P.config.supportedDurations:[5],ht=ye[0],We=Ze.length>0?Ze[0]:r,Dt=d(a||st[0]),Xt=kt[0],Pt=P.config.supportsAudioOutput?g:!1;$(ht),b(We),w(Dt),p(Xt),P.config.supportsAudioOutput||y(!1),ct({modelId:A,modelName:P.name,ratio:ht,resolution:We,generationType:Dt,duration:Xt,audio:Pt,acceptedInputs:fs(Dt)})}};t.useEffect(()=>{var P;const A=(P=s==null?void 0:s.config)==null?void 0:P.generatedVideoUrl;A&&ws(A,s.config.ratio||"16:9")},[(Me=s==null?void 0:s.config)==null?void 0:Me.generatedVideoUrl]);const Xs=async A=>{let we=0;const Ue=async()=>{try{we++;const ye=(await Ce.tasks.getTaskStatus(A)).task;if(T(ye.progress||0),ye.status==="SUCCESS"||ye.status==="COMPLETED"||ye.status==="DONE"){u(!1),T(100);const Ze=ye.resultUrl;ws(Ze,s.config.ratio||"16:9"),ct({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:Ze}),K(""),m.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>T(0),1e3);return}else if(ye.status==="FAILURE"){u(!1),T(0),ct({taskId:""});const{useAuthStore:Ze}=await ds(async()=>{const{useAuthStore:kt}=await import("./index-Cwo4xSFf.js").then(ht=>ht.f);return{useAuthStore:kt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:st}=Ze.getState();await st(),m.error(ye.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(ye.status==="PROCESSING"||ye.status==="PENDING")&&(we<900?setTimeout(Ue,1e3):(u(!1),T(0),ct({taskId:""}),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{u(!1),T(0),ct({taskId:""}),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Ue()},bs=async()=>{var we,Ue,Se,ye,Ze,st,kt;if(d(a)==="æ–‡ç”Ÿè§†é¢‘"&&!f.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯");return}u(!0);const P=vt();ct({referenceImages:P}),T(0);try{let ht=[],We;const Dt=l.length;if(l.length>0)try{for(const ps of l){let Bt=ps.url;!Bt.startsWith("data:")&&!Bt.startsWith("http")&&(Bt=`${fr}${Bt}`),Bt=Bt.replace(/^https?:\/\/localhost(?::\d+)?/i,fr);const Jt=await ur(Bt);ht.push(Jt)}}catch{m.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=te.filter(ps=>ps.target===n);let Pt=[];if(d(a)==="å‚è€ƒå›¾"){const ps=/@(\S+)/g,Jt=[...f.matchAll(ps)].map(us=>us[1]);for(const us of Jt){const ss=$e[us];ss&&Pt.push(ss)}const as=new Map;for(const us of Xt){const ss=ge(us.source);if((ss==null?void 0:ss.type)==="assetSelector"){const Os=(we=ss.data.config)==null?void 0:we.roleIds;if(Os&&Os.length>0)for(const ms of Os)Pt.includes(ms)||Pt.push(ms);const ks=(Ue=ss.data.config)==null?void 0:Ue.subjects;if(ks&&ks.length>0){for(const ms of ks)if(!as.has(ms.name)){const qs=(ms.images||[]).map(Gs=>Gs.startsWith("http")||Gs.startsWith("data:")?Gs:`${fr}${Gs}`);as.set(ms.name,qs)}}}}if(as.size>0){const us=Array.from(as.entries());let ss=0;const Os=[];for(const[ks,ms]of us){if(ss>=7)break;const qs=7-ss,Gs=ms.slice(0,Math.max(0,qs));Gs.length>0&&(Os.push({name:ks,images:Gs}),ss+=Gs.length)}We=Os,us.some(([,ks])=>ks.length>0)&&ss<us.reduce((ks,[,ms])=>ks+ms.length,0)&&m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(ht.length>0){const us=it.filter(ss=>!ss.id.includes("subject"));us.length>0&&(We||(We=[]),us.forEach((ss,Os)=>{const ks=`å›¾${Os+1}`,ms=ss.url.startsWith("http")||ss.url.startsWith("data:")?ss.url:`${fr}${ss.url}`;We.push({name:ks,images:[ms]})}))}}const zt=We&&We.length>0?We.reduce((ps,Bt)=>{var Jt;return ps+(((Jt=Bt.images)==null?void 0:Jt.length)||0)},0):Dt,Ct=Pt.length>0;let Tt=a;if(Tt==="é¦–å¸§"||Tt==="å°¾å¸§"){if(zt!==1&&!Ct){m.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),u(!1),T(0);return}}else if(Tt==="é¦–å°¾å¸§"){if(zt===1)Tt="é¦–å¸§";else if(zt!==2&&!Ct){m.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),u(!1),T(0);return}We&&We.length>0?We=[{...We[0],images:We[0].images.slice(0,2)}]:ht=ht.slice(0,2)}else if(Tt==="å‚è€ƒå›¾"||Tt==="ä¸»ä½“å‚è€ƒ"){if(zt<1&&!Ct){m.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),u(!1),T(0);return}if(We&&We.length>0){if(We.reduce((Bt,Jt)=>{var as;return Bt+(((as=Jt.images)==null?void 0:as.length)||0)},0)>7){let Bt=7;We=We.map(Jt=>({...Jt,images:Jt.images.slice(0,Math.max(0,Bt-=Jt.images.length,Jt.images.length))})),Bt=7,We=We.map(Jt=>{const as=Jt.images.slice(0,Math.min(Jt.images.length,Bt));return Bt-=as.length,{...Jt,images:as}}).filter(Jt=>Jt.images.length>0),m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else ht.length>7&&(ht=ht.slice(0,7),m.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}oe==="dropImages"&&(ht=[],We=void 0),(d(a)==="é¦–å¸§"||d(a)==="å°¾å¸§")&&oe==="useFirstImage"&&ht.length>=2&&(ht=[ht[0]]),d(a)==="é¦–å°¾å¸§"&&oe==="useFirstTwoImages"&&ht.length>=3&&(ht=ht.slice(0,2));const Gt={modelId:F,ratio:v,referenceImages:We&&We.length>0?void 0:ht.length>0?ht:void 0,roleIds:Pt.length>0?Pt:void 0,generationType:Tt,sourceNodeId:n,metadata:{duration:c,resolution:r,audio:g,movementAmplitude:C,roleIds:Pt.length>0?Pt:void 0},...We?{subjects:We}:{}};We&&We.length>0;const Wt=d(Tt);if(Wt==="æ–‡ç”Ÿè§†é¢‘"){if(!f.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯"),u(!1),T(0);return}Gt.prompt=f.trim()}else if(Wt==="å‚è€ƒå›¾"){if(!f.trim()){m.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),u(!1),T(0);return}Gt.prompt=f.trim()}else f.trim()&&(Gt.prompt=f.trim());const ts=await Ce.tasks.createVideoTask(Gt),rs=ts.taskId,ys=ts.creditsCharged||0,Js=ts.isFreeUsage,Cs=ts.freeUsageRemaining??0;if(K(rs),ct({prompt:f,ratio:v,resolution:r,generationType:a,duration:c,modelId:F,taskId:rs}),Js)m.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Cs} æ¬¡`),je();else if(ys>0){const{useAuthStore:ps}=await ds(async()=>{const{useAuthStore:Jt}=await import("./index-Cwo4xSFf.js").then(as=>as.f);return{useAuthStore:Jt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Bt}=ps.getState();await Bt(),m.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${ys} ç§¯åˆ†ï¼‰`),je()}else m.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Xs(rs)}catch(ht){if(u(!1),T(0),((Se=ht.response)==null?void 0:Se.status)===403){const We=((Ze=(ye=ht.response)==null?void 0:ye.data)==null?void 0:Ze.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";m.error(We)}else m.error(`æäº¤å¤±è´¥: ${((kt=(st=ht.response)==null?void 0:st.data)==null?void 0:kt.error)||ht.message}`)}},er=async()=>{const A=d(a),P=vt(),we=P.length,Ue=(()=>{var Ze;const ye=te.filter(st=>st.target===n);for(const st of ye){const kt=ge(st.source);if((kt==null?void 0:kt.type)==="assetSelector"){const ht=(Ze=kt.data.config)==null?void 0:Ze.subjects;if(ht&&ht.length>0)return!0}}return!1})(),Se=Object.keys($e).length>0;if((Ue||Se)&&(A==="é¦–å¸§"||A==="å°¾å¸§"||A==="é¦–å°¾å¸§")){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((A==="é¦–å¸§"||A==="å°¾å¸§")&&we===0&&!Se){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(A==="é¦–å°¾å¸§"&&we===0&&!Se){m.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(A==="å‚è€ƒå›¾"&&we===0&&!Se){m.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(A==="æ–‡ç”Ÿè§†é¢‘"&&we>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((A==="é¦–å¸§"||A==="å°¾å¸§")&&we>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(A==="é¦–å°¾å¸§"&&we>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(A==="æ–‡ç”Ÿè§†é¢‘"&&!f.trim()){m.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!F){m.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}i(P),ct({referenceImages:P}),u(!0),T(0),await bs()},ws=(A,P)=>{const we=ge(n);if(!we||!A)return;const Ue=P||v||"16:9",Se=pe(),ye=Ie(),Ze=Se.filter(Bt=>Bt.type==="videoPreview"&&ye.some(Jt=>Jt.source===n&&Jt.target===Bt.id));if(Ze.find(Bt=>Bt.data.videoUrl===A))return;const kt=1,ht=400,We=(Bt,Jt=300)=>{if(!Bt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Bt))return Jt;const[as,us]=Bt.split(":").map(ss=>parseFloat(ss));return!as||!us?Jt:Math.round(ht*(us/as))},Dt=document.querySelector(`.react-flow__node[data-id="${n}"]`),Xt=Dt==null?void 0:Dt.getBoundingClientRect(),Pt=Math.round(((Xt==null?void 0:Xt.width)||400)/kt),zt=100,Ct=200,Tt=We(Ue,300),Gt=Ze.length,Wt=we.position.x+Pt+Ct,ts=we.position.y,rs=Wt,ys=ts+Gt*(Tt+zt),Js=Date.now(),Cs={id:`preview-${n}-${Js}`,type:"videoPreview",position:{x:rs,y:ys},data:{videoUrl:A,width:ht,ratio:Ue,workflowContext:we.data.workflowContext,createdBy:we.data.createdBy}};ie(Bt=>[...Bt,Cs]);const ps={id:`edge-${n}-${Cs.id}`,source:n,target:Cs.id,targetHandle:`${Cs.id}-target`,type:"aurora"};be(Bt=>Bt.find(as=>as.source===n&&as.target===Cs.id)?Bt:[...Bt,ps])},tr=A=>{const P=A.target;if(P.tagName==="INPUT"||P.tagName==="TEXTAREA"||P.tagName==="SELECT"||P.tagName==="BUTTON"||P.closest("button")||P.closest("input")||P.closest("textarea")||P.closest("select"))return;const we=!V;me(we),ie(Ue=>Ue.map(Se=>Se.id===n?{...Se,data:{...Se.data,isExpanded:we}}:Se))};return e.jsxs("div",{onDoubleClick:tr,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var ht;const A=((ht=ge(n))==null?void 0:ht.type)||"",P=d(a),we=P==="æ–‡ç”Ÿè§†é¢‘"||A==="aiVideo_t2v",Ue=A==="aiVideo_i2v_first"||A==="aiVideo_i2v_last"||P==="é¦–å¸§"||P==="å°¾å¸§",Se=A==="aiVideo_first_last"||P==="é¦–å°¾å¸§",ye=A==="aiVideo_reference"||P==="å‚è€ƒå›¾",Ze=te.filter(We=>We.target===n),st=Ze.some(We=>{const Dt=ge(We.source);return(Dt==null?void 0:Dt.type)==="agent"}),kt=Ze.reduce((We,Dt)=>{var zt,Ct,Tt,Gt;const Xt=ge(Dt.source),Pt=(Xt==null?void 0:Xt.type)||"";if(Pt==="aiImage"||Pt==="imagePreview")return We+1;if(Pt==="upload"){const Wt=(Tt=(Ct=(zt=Xt==null?void 0:Xt.data)==null?void 0:zt.config)==null?void 0:Ct.uploadedFiles)==null?void 0:Tt[0],ts=((Wt==null?void 0:Wt.type)||"").toUpperCase(),rs=((Wt==null?void 0:Wt.mimeType)||"").toLowerCase();return We+(ts==="IMAGE"||rs.startsWith("image/")?1:0)}if(Pt==="assetSelector"){const Wt=((Gt=Xt==null?void 0:Xt.data)==null?void 0:Gt.config)||{};if(Wt.selectedAsset)return We+((Wt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Wt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Wt.subjects&&Wt.subjects.length>0)return We+((Wt.subjects[0].images||[]).length||0)}return We},0);return we?!st:Ue?!(st&&kt>=1):Se?!(st&&kt>=2):ye?!(st&&kt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),X&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ne}),xe==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{W(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{W(!1),m.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{W(!1),await bs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:V?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:F,onChange:A=>_t(A),options:Ns.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Ns.map(A=>({value:A.id,label:A.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ve?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:_,value:f,onChange:A=>{var Se;const P=(Se=le==null?void 0:le.modelId)==null?void 0:Se.includes("viduq2"),we=d(a)==="å‚è€ƒå›¾";P&&we?wt(A):(x(A.target.value),h(!1))},onKeyDown:A=>{var Ue;const P=(Ue=le==null?void 0:le.modelId)==null?void 0:Ue.includes("viduq2"),we=d(a)==="å‚è€ƒå›¾";P&&we&&vs(A)},placeholder:(Ge=le==null?void 0:le.modelId)!=null&&Ge.includes("viduq2")&&d(a)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),N&&E.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:E.map((A,P)=>e.jsxs("button",{type:"button",onClick:()=>Kt(A),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${P===Ee?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[A.thumbnail?e.jsx("img",{src:A.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",A.name]})})]},A.id))})]})]}),Object.keys($e).length>0&&((qe=le==null?void 0:le.modelId)==null?void 0:qe.includes("viduq2"))&&d(a)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys($e).map(A=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-neutral-500/10 dark:bg-neutral-500/20 border border-neutral-400/50 dark:border-neutral-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-neutral-700 dark:text-neutral-300",children:A}),e.jsx("button",{type:"button",onClick:()=>{Ae(Ue=>{const Se={...Ue};return delete Se[A],Se});const P=new RegExp(`@${A}\\s*`,"g"),we=f.replace(P,"");x(we)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},A))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ve&&l.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(Oe=l[0])!=null&&Oe.name&&l[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",a==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",d(a)==="å‚è€ƒå›¾"&&l.some(A=>!A.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:l.map((A,P)=>{const we=l.slice(0,P+1).filter(ye=>!ye.id.includes("subject")).length,Ue=!A.id.includes("subject"),Se=Ue?`å›¾${we}`:A.name;return e.jsxs("div",{draggable:a==="é¦–å°¾å¸§",onDragStart:()=>Zs(P),onDragOver:Hs,onDrop:()=>nr(P),onClick:()=>{Ue&&d(a)==="å‚è€ƒå›¾"&&Ke(Se)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${a==="é¦–å°¾å¸§"?"cursor-move":Ue&&d(a)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${z===P?"opacity-50":""} ${A.id.includes("subject")?"border-neutral-400 dark:border-neutral-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-neutral-400 dark:hover:border-neutral-400/50 ${Ue&&d(a)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Ue&&d(a)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${Se}`:A.name,children:[e.jsx("img",{src:`${A.url.startsWith("http")||A.url.startsWith("data:")?A.url:fr+A.url}`,alt:A.name,className:"w-full h-full object-cover"}),A.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),A.name]}),Ue&&a!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),Se]}),a==="é¦–å°¾å¸§"&&!A.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:P===0?"é¦–":P===1?"å°¾":P+1})]},A.id)})})]}),le&&!Ve&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",Mt?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:et.map(A=>e.jsxs("button",{type:"button",onClick:()=>{p(A),ct({duration:A})},disabled:Mt,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${c===A?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:[A,"ç§’"]},A))})]}),Is&&(((tt=le==null?void 0:le.config.supportedRatios)==null?void 0:tt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ve?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{$("16:9"),ct({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${v==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{$("9:16"),ct({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${v==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:v,onChange:A=>{$(A),ct({ratio:A})},options:((le==null?void 0:le.config.supportedRatios)||[]).map(A=>{const[P,we]=A.split(":");return{value:A,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[A]||`${P}:${we}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",At?"(æœªé…ç½®)":""]}),e.jsx(os,{value:r,onChange:A=>{b(A),ct({resolution:A})},options:Ft.map(A=>({value:A,label:A})),className:At?"opacity-50 pointer-events-none":""})]}),((bt=le==null?void 0:le.provider)==null?void 0:bt.toLowerCase())==="vidu"&&(le==null?void 0:le.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(A=>e.jsx("button",{type:"button",onClick:()=>{O(A),ct({movementAmplitude:A})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${C===A?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:A==="auto"?"è‡ªåŠ¨":A==="small"?"å°":A==="medium"?"ä¸­":"å¤§"},A))})]}),(le==null?void 0:le.config.supportsAudioOutput)&&d(a)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const A=!g;y(A),ct({audio:A})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${g?"bg-neutral-800 dark:bg-white text-white dark:text-black":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${g?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:er,disabled:I||s._canEdit===!1||d(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(f!=null&&f.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${I||d(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(f!=null&&f.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:I?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!de&&(ee?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ae),"æ¬¡"]}):Re!==null&&Re>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Re,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:f?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:f})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},gr=t.memo(Ya),Qa=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Za=t.memo(Qa),eo=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},to=t.memo(eo),so=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},ro=t.memo(so),ao=s=>{const{data:j}=s;return e.jsx(gr,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},oo=t.memo(ao),no=s=>{const j=(s==null?void 0:s.data)||{},n=j.config||{};return e.jsx(gr,{...s,data:{...j,config:{...n,generationType:(n==null?void 0:n.lockedGenerationType)||(n==null?void 0:n.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(n==null?void 0:n.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(n==null?void 0:n.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(n==null?void 0:n.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},io=t.memo(no),lr="https://api.waule.ai",lo=({data:s,selected:j,id:n})=>{var G,v,$,r,b,d;const[V]=t.useState(!0),[me,T]=t.useState(!1),[fe]=t.useState(""),[K,re]=t.useState("wan-std"),[Y,ce]=t.useState(0),Re=t.useRef(null),{setNodes:de,setEdges:ee,getNode:ae,getNodes:je,getEdges:ie}=Qt(),be=zs(),ge=s.config.modelId,{credits:pe,loading:Ie}=Ss({aiModelId:ge,duration:Y,mode:K==="wan-pro"?"pro":"standard"}),te=t.useMemo(()=>{var c;const a=s.models||[],w=(c=s==null?void 0:s.config)==null?void 0:c.selectedEditingCapability;return a.filter(p=>{var g;return(p.type||"")==="VIDEO_EDITING"&&Array.isArray((g=p.config)==null?void 0:g.supportedEditingCapabilities)&&(w?p.config.supportedEditingCapabilities.includes(w):p.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||p.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(G=s==null?void 0:s.config)==null?void 0:G.selectedEditingCapability]),[Z,U]=t.useState(s.config.modelId||((v=te[0])==null?void 0:v.id)||""),R=t.useMemo(()=>te.find(a=>a.id===Z),[te,Z]);t.useEffect(()=>{var a;if(!te.find(w=>w.id===Z)){const w=((a=te[0])==null?void 0:a.id)||"";U(w),de(c=>c.map(p=>{var g;return p.id===n?{...p,data:{...p.data,config:{...p.data.config,modelId:w||void 0,modelName:w?(g=te[0])==null?void 0:g.name:void 0}}}:p}))}},[te]),t.useEffect(()=>{},[R]);const L=t.useMemo(()=>{var C,O,I,u,l,i,z,D,X,W,ne,xe,oe,N,h,E;const a=be.filter(k=>k.target===n);let w=null,c=0,p=null,g=null,y=null;for(const k of a){const J=ae(k.source);if(!J)continue;const ue=String(J.type||"");if(ue==="upload"){const B=(I=(O=(C=J.data)==null?void 0:C.config)==null?void 0:O.uploadedFiles)==null?void 0:I[0];if(!B)continue;const he=String(B.mimeType||"").toLowerCase(),Ee=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!p&&(Ee==="VIDEO"||he.startsWith("video/"))&&(p=Ne,y=k.id),!w&&(Ee==="IMAGE"||he.startsWith("image/"))&&(w=Ne,c=B.size||0,g=k.id)}else if(ue==="assetSelector"){const B=(l=(u=J.data)==null?void 0:u.config)==null?void 0:l.selectedAsset;if(B){const Ee=String(B.mimeType||"").toLowerCase(),Ne=String(B.type||"").toUpperCase(),$e=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!p&&(Ne==="VIDEO"||Ee.startsWith("video/"))&&(p=$e,y=k.id),!w&&(Ne==="IMAGE"||Ee.startsWith("image/"))&&(w=$e,c=B.size||0,g=k.id)}const he=((z=(i=J.data)==null?void 0:i.config)==null?void 0:z.subjects)||[];if(!w&&Array.isArray(he)&&he.length>0){const Ne=(((D=he[0])==null?void 0:D.images)||[])[0];Ne&&(w=Ne.startsWith("http")||Ne.startsWith("data:")?Ne:`${lr}${Ne}`,g=k.id)}}else if(ue==="aiImage"){const B=(W=(X=J.data)==null?void 0:X.config)==null?void 0:W.generatedImageUrl;!w&&B&&(w=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,g=k.id)}else if(ue==="imagePreview"){const B=((ne=J.data)==null?void 0:ne.imageUrl)||((xe=J.data)==null?void 0:xe.url);!w&&B&&(w=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,g=k.id)}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const B=((oe=J.data)==null?void 0:oe.videoUrl)||((N=J.data)==null?void 0:N.url)||((E=(h=J.data)==null?void 0:h.config)==null?void 0:E.generatedVideoUrl);!p&&B&&(p=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,y=k.id)}if(w&&p)break}return{imageUrl:w,videoUrl:p,imageSize:c,imageEdgeId:g,videoEdgeId:y}},[be,n,ae]);t.useEffect(()=>{if(L.imageSize>5*1024*1024){const w=(L.imageSize/1024/1024).toFixed(2);m.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${w}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),L.imageEdgeId&&ee(c=>c.filter(p=>p.id!==L.imageEdgeId))}if(!L.videoUrl){ce(0);return}const a=document.createElement("video");a.src=L.videoUrl,a.onloadedmetadata=()=>{const w=a.duration||0,c=a.videoWidth,p=a.videoHeight;ce(w);let g="";w<2||w>30?g=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${w.toFixed(1)}ç§’ï¼‰`:(c>2048||p>2048)&&(g=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${c}x${p}ï¼‰`),g&&(m.error(g+"ï¼Œè¿æ¥å·²æ–­å¼€"),L.videoEdgeId&&ee(y=>y.filter(C=>C.id!==L.videoEdgeId)))},a.onerror=()=>ce(0),a.load()},[L.videoUrl,L.imageSize,L.videoEdgeId,L.imageEdgeId,ee]);const f=t.useMemo(()=>!!Z&&!!L.videoUrl&&!!L.imageUrl,[Z,L.videoUrl,L.imageUrl]),x=t.useCallback(a=>{var N,h,E;const w=ae(n);if(!w||!a)return;const c=je(),p=ie(),g=c.filter(k=>k.type==="videoPreview"&&p.some(J=>J.source===n&&J.target===k.id));if(g.find(k=>{var J;return((J=k.data)==null?void 0:J.videoUrl)===a}))return;const C=400,O=(k,J=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(k))return J;const[ue,B]=k.split(":").map(he=>parseFloat(he));return!ue||!B?J:Math.round(C*(B/ue))},I=200,u=100,l=O("16:9",300),i=document.querySelector(`.react-flow__node[data-id="${n}"]`),z=Math.round((i==null?void 0:i.getBoundingClientRect().width)||400),D=(((N=w.position)==null?void 0:N.x)||0)+z+I,X=((h=w.position)==null?void 0:h.y)||0,W=g.length,ne=D,xe=X+W*(l+u),oe={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:ne,y:xe},data:{videoUrl:a,width:C,ratio:"16:9",workflowContext:w.data.workflowContext,createdBy:(E=w.data)==null?void 0:E.createdBy}};de(k=>[...k,oe]),ee(k=>[...k,{id:`edge-${n}-${oe.id}`,source:n,target:oe.id,type:"aurora"}])},[n,ae,je,ie,de,ee]);t.useEffect(()=>{var w;const a=(w=s==null?void 0:s.config)==null?void 0:w.generatedVideoUrl;a&&x(a)},[($=s==null?void 0:s.config)==null?void 0:$.generatedVideoUrl]),t.useEffect(()=>{const a=s.config.taskId;(async()=>{var p,g;let c=!1;if(a)try{const C=(await Ce.tasks.getTaskStatus(a)).task;if(C.status==="SUCCESS"){const O=C.resultUrl||((p=C.previewNodeData)==null?void 0:p.url);if(O){let I=!1;try{const u=localStorage.getItem("suppressedPreviewTasks")||"[]";I=JSON.parse(u).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}I||x(O),de(u=>u.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:O,taskId:a}}}:l))}T(!1),c=!0}else if(C.status==="PROCESSING"||C.status==="PENDING"){T(!0),await _(a);return}else C.status==="FAILURE"&&(T(!1),de(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I)))}catch{T(!1)}if(!c)try{const y=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(y.tasks)&&y.tasks.length>0)for(const C of y.tasks){const O=(g=C.previewNodeData)==null?void 0:g.url;if(O){let I=!1;try{const u=localStorage.getItem("suppressedPreviewTasks")||"[]";I=JSON.parse(u).some(i=>i.taskId&&i.taskId===C.id||i.sourceNodeId&&i.sourceNodeId===n)}catch{}I||x(O),await Ce.tasks.markPreviewNodeCreated(C.id)}}}catch{}})()},[]);const _=async a=>{let w=0;const c=600,p=async()=>{var g;try{w++;const C=(await Ce.tasks.getTaskStatus(a)).task;if(C.status==="SUCCESS"){const O=C.resultUrl||((g=C.previewNodeData)==null?void 0:g.url);if(O){let I=!1;try{const u=localStorage.getItem("suppressedPreviewTasks")||"[]";I=JSON.parse(u).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}I||x(O),de(u=>u.map(l=>l.id!==n?l:{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:O,taskId:a}}}))}T(!1),m.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(C.status==="PROCESSING"||C.status==="PENDING")if(w<c)setTimeout(p,5e3);else{T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),de(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));return}else if(C.status==="FAILURE"){T(!1);try{const{useAuthStore:O}=await ds(async()=>{const{useAuthStore:u}=await import("./index-Cwo4xSFf.js").then(l=>l.f);return{useAuthStore:u}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:I}=O.getState();await I()}catch{}m.error(C.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),de(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));return}else{T(!1),m.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),de(O=>O.map(I=>I.id===n?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));return}}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),de(C=>C.map(O=>O.id===n?{...O,data:{...O.data,config:{...O.data.config,taskId:""}}}:O));return}};p()},F=async()=>{var a,w;if(!f){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}T(!0);try{const c=await Ce.post("/tasks/video-edit",{modelId:Z,prompt:fe||"",referenceImages:L.imageUrl?[L.imageUrl]:[],sourceNodeId:n,duration:Y,metadata:{videoUrl:L.videoUrl,wanMode:K,duration:Y}}),p=c.taskId,g=c.creditsCharged||0;if(g>0)try{const{useAuthStore:y}=await ds(async()=>{const{useAuthStore:O}=await import("./index-Cwo4xSFf.js").then(I=>I.f);return{useAuthStore:O}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:C}=y.getState();await C(),m.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${g} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");de(y=>y.map(C=>C.id===n?{...C,data:{...C.data,config:{...C.data.config,taskId:p}}}:C)),await _(p)}catch(c){T(!1);const p=((w=(a=c==null?void 0:c.response)==null?void 0:a.data)==null?void 0:w.error)||c.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${p}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:V?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:Z,onChange:a=>{U(a),de(w=>w.map(c=>{var p;return c.id===n?{...c,data:{...c.data,config:{...c.data.config,modelId:a,modelName:(p=te.find(g=>g.id===a))==null?void 0:p.name}}}:c}))},options:te.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:te.map(a=>({value:a.id,label:a.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>re("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${K==="wan-std"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>re("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${K==="wan-pro"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((b=s==null?void 0:s.config)==null?void 0:b.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),L.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Re,src:L.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:a=>{const w=a.currentTarget;w.duration&&w.duration!==1/0&&ce(w.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((d=s==null?void 0:s.config)==null?void 0:d.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),L.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:L.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:F,disabled:me||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${me?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:me?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ie&&(pe!==null&&pe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[pe,"ç§¯åˆ†"]}):Y===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},co=t.memo(lo),wr="https://api.waule.ai",uo=({data:s,selected:j,id:n})=>{var O,I;const[V]=t.useState(!0),[me,T]=t.useState(!1),[fe,K]=t.useState(!1),re=t.useRef(null),Y=t.useRef(null),ce=t.useRef(null),[Re,de]=t.useState(!1),[ee,ae]=t.useState(0),[je,ie]=t.useState(0),[be,ge]=t.useState(0),[pe,Ie]=t.useState(null),{setNodes:te,setEdges:Z,getNode:U,getNodes:R,getEdges:L}=Qt(),f=zs(),x=Ls(),_=t.useMemo(()=>`lipSyncTask:${n}`,[n]),F=t.useMemo(()=>(s.models||[]).filter(l=>{var i;return(l.type||"")==="VIDEO_EDITING"&&Array.isArray((i=l.config)==null?void 0:i.supportedEditingCapabilities)&&l.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[G,v]=t.useState(s.config.modelId||((O=F[0])==null?void 0:O.id)||"");t.useEffect(()=>{var u;if(!F.find(l=>l.id===G)){const l=((u=F[0])==null?void 0:u.id)||"";v(l),te(i=>i.map(z=>{var D;return z.id===n?{...z,data:{...z.data,config:{...z.data.config,modelId:l||void 0,modelName:l?(D=F[0])==null?void 0:D.name:void 0}}}:z}))}},[F]);const $=t.useMemo(()=>!je||!ee?0:je>=ee||fe?ee:je,[je,ee,fe]),{credits:r,loading:b}=Ss({aiModelId:G,duration:$,mode:"standard",operationType:"video_retalk"}),d=t.useMemo(()=>{var D,X,W,ne,xe,oe,N,h,E;const u=f.filter(k=>k.target===n);let l=null,i=null,z=null;for(const k of u){const J=x.find(B=>B.id===k.source);if(!J)continue;const ue=String(J.type||"");if(ue==="upload"){const B=(W=(X=(D=J.data)==null?void 0:D.config)==null?void 0:X.uploadedFiles)==null?void 0:W[0];if(!B)continue;const he=String(B.mimeType||"").toLowerCase(),Ee=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${wr}${B.url}`;!l&&(Ee==="VIDEO"||he.startsWith("video/"))&&(l=Ne),!i&&(Ee==="AUDIO"||he.startsWith("audio/"))&&(i=Ne),!z&&(Ee==="IMAGE"||he.startsWith("image/"))&&(z=Ne)}else if(ue==="assetSelector"){const B=(xe=(ne=J.data)==null?void 0:ne.config)==null?void 0:xe.selectedAsset;if(B){const he=String(B.mimeType||"").toLowerCase(),Ee=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${wr}${B.url}`;!l&&(Ee==="VIDEO"||he.startsWith("video/"))&&(l=Ne),!i&&(Ee==="AUDIO"||he.startsWith("audio/"))&&(i=Ne),!z&&(Ee==="IMAGE"||he.startsWith("image/"))&&(z=Ne)}}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const B=((oe=J.data)==null?void 0:oe.videoUrl)||((N=J.data)==null?void 0:N.url)||((E=(h=J.data)==null?void 0:h.config)==null?void 0:E.generatedVideoUrl);!l&&B&&(l=B.startsWith("http")||B.startsWith("data:")?B:`${wr}${B}`)}if(l&&i&&z)break}return{videoUrl:l,audioUrl:i,imageUrl:z}},[f,n,x]),a=t.useMemo(()=>{var l;const u=F.find(i=>i.id===G);return((l=u==null?void 0:u.modelId)==null?void 0:l.toLowerCase().includes("videoretalk"))||!1},[G,F]),w=t.useMemo(()=>!!G&&!!d.videoUrl&&!!d.audioUrl&&!pe,[G,d.videoUrl,d.audioUrl,pe]);t.useEffect(()=>{const u=re.current;if(!u||!d.audioUrl)return;u.src=d.audioUrl,u.load();const l=()=>{ae(u.duration||0)},i=()=>ge(u.duration?u.currentTime/u.duration:0),z=()=>de(!1);return u.addEventListener("loadedmetadata",l),u.addEventListener("timeupdate",i),u.addEventListener("ended",z),()=>{u.removeEventListener("loadedmetadata",l),u.removeEventListener("timeupdate",i),u.removeEventListener("ended",z)}},[d.audioUrl]),t.useEffect(()=>{if(!d.videoUrl){ie(0);return}const u=document.createElement("video");u.src=d.videoUrl,u.onloadedmetadata=()=>{if(ie(u.duration||0),a){const l=u.videoWidth,i=u.videoHeight;l>2048||i>2048?(Ie(`è§†é¢‘åˆ†è¾¨ç‡ ${l}x${i} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),m.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${l}x${i}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),Z(z=>z.filter(D=>{var ne,xe,oe,N,h,E,k,J;if(D.target!==n)return!0;const X=x.find(ue=>ue.id===D.source);return X?!(X.type==="upload"&&((N=(oe=(xe=(ne=X.data)==null?void 0:ne.config)==null?void 0:xe.uploadedFiles)==null?void 0:oe[0])==null?void 0:N.type)==="VIDEO"||X.type==="assetSelector"&&((k=(E=(h=X.data)==null?void 0:h.config)==null?void 0:E.selectedAsset)==null?void 0:k.type)==="VIDEO"||X.type==="videoPreview"||((J=X.type)==null?void 0:J.startsWith("aiVideo"))):!0}))):pe!=null&&pe.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ie(null)}},u.onerror=()=>ie(0),u.load()},[d.videoUrl,a,n,x,Z]),t.useEffect(()=>{const u=d.audioUrl,l=ce.current;if(!u||!l)return;const i=D=>{const X=l.getContext("2d");if(!X)return;const W=l.width,ne=l.height;X.clearRect(0,0,W,ne);const xe="#1a1033",oe="#7a0fe8";X.fillStyle=xe,X.fillRect(0,0,W,ne);const N=D.length,h=2,E=Math.max(1,Math.floor((W-(N-1)*h)/N));for(let k=0;k<N;k++){const J=Math.min(1,Math.max(0,D[k])),ue=Math.max(2,Math.floor(J*ne)),B=k*(E+h),he=Math.floor((ne-ue)/2);X.fillStyle=oe,X.fillRect(B,he,E,ue)}if(be>0){const k=Math.floor(W*be);X.fillStyle="#ffffff88",X.fillRect(k,0,2,ne)}};(async()=>{try{let D=u;u.includes("aliyuncs.com")&&(D=`https://api.waule.ai/proxy/audio?url=${encodeURIComponent(u)}`);const W=await(await fetch(D,{mode:(u.includes("aliyuncs.com"),"cors"),credentials:u.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ne=window.AudioContext||window.webkitAudioContext,N=(await new ne().decodeAudioData(W)).getChannelData(0),h=120,E=Math.max(1,Math.floor(N.length/h)),k=new Float32Array(h);for(let J=0;J<h;J++){let ue=0,B=0;const he=J*E,Ee=Math.min(N.length,he+E);for(let Ne=he;Ne<Ee;Ne++)ue+=Math.abs(N[Ne]),B++;k[J]=B?ue/B:0}i(k)}catch{const X=new Float32Array(120);for(let W=0;W<120;W++)X[W]=(Math.sin(W/5)+1)/2;i(X)}})()},[d.audioUrl,be]);const c=()=>{const u=re.current;u&&(Re?(u.pause(),de(!1)):(u.play(),de(!0)))},p=u=>{if(!u||!isFinite(u))return"0:00";const l=Math.floor(u/60),i=Math.floor(u%60);return`${l}:${i.toString().padStart(2,"0")}`},g=t.useCallback(u=>{var $e,Ae,_e;const l=U(n);if(!l||!u)return;const i=u.startsWith("http")||u.startsWith("data:")?u:`${wr}${u}`,z=R(),D=L(),X=z.filter(Te=>Te.type==="videoPreview"&&D.some(le=>le.source===n&&le.target===Te.id));if(X.find(Te=>{var le;return((le=Te.data)==null?void 0:le.videoUrl)===i}))return;const ne=400,xe=(Te,le=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(Te))return le;const[Ve,et]=Te.split(":").map(Ft=>parseFloat(Ft));return!Ve||!et?le:Math.round(ne*(et/Ve))},oe=200,N=100,h=xe("16:9",300),E=document.querySelector(`.react-flow__node[data-id="${n}"]`),k=Math.round((E==null?void 0:E.getBoundingClientRect().width)||400),J=((($e=l.position)==null?void 0:$e.x)||0)+k+oe,ue=((Ae=l.position)==null?void 0:Ae.y)||0,B=X.length,he=J,Ee=ue+B*(h+N),Ne={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:he,y:Ee},data:{videoUrl:i,ratio:"16:9",workflowContext:l.data.workflowContext,createdBy:(_e=l.data)==null?void 0:_e.createdBy}};te(Te=>[...Te,Ne]),Z(Te=>[...Te,{id:`edge-${n}-${Ne.id}`,source:n,target:Ne.id,type:"aurora"}])},[n,U,R,L,te,Z]);t.useEffect(()=>{var l;const u=(l=s==null?void 0:s.config)==null?void 0:l.generatedVideoUrl;u&&g(u)},[(I=s==null?void 0:s.config)==null?void 0:I.generatedVideoUrl]),t.useEffect(()=>{const u=s.config.taskId||(()=>{try{return localStorage.getItem(_)||""}catch{return""}})();(async()=>{var z,D;let i=!1;if(u)try{const W=(await Ce.tasks.getTaskStatus(u)).task;if(W.status==="PROCESSING"||W.status==="PENDING"){const ne=new Date(W.createdAt);if((new Date().getTime()-ne.getTime())/(1e3*60*60)>1){T(!1),te(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}}if(W.status==="SUCCESS"||W.status==="COMPLETED"||W.status==="DONE"){const ne=W.resultUrl||((z=W.previewNodeData)==null?void 0:z.url);if(ne){let xe=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";xe=JSON.parse(oe).some(h=>h.taskId&&h.taskId===u||h.sourceNodeId&&h.sourceNodeId===n)}catch{}xe||g(ne),te(oe=>oe.map(N=>N.id===n?{...N,data:{...N.data,config:{...N.data.config,generatedVideoUrl:ne,taskId:u}}}:N))}T(!1);try{localStorage.removeItem(_)}catch{}i=!0}else if(W.status==="PROCESSING"||W.status==="PENDING"){T(!0),await y(u);return}else if(W.status==="FAILURE"||W.status==="FAILED"){T(!1),te(ne=>ne.map(xe=>xe.id===n?{...xe,data:{...xe.data,config:{...xe.data.config,taskId:""}}}:xe));try{localStorage.removeItem(_)}catch{}}}catch{T(!1);try{localStorage.removeItem(_)}catch{}}if(!i)try{const X=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(X.tasks)&&X.tasks.length>0)for(const W of X.tasks){const ne=(D=W.previewNodeData)==null?void 0:D.url;if(ne){let xe=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";xe=JSON.parse(oe).some(h=>h.taskId&&h.taskId===W.id||h.sourceNodeId&&h.sourceNodeId===n)}catch{}xe||g(ne),await Ce.tasks.markPreviewNodeCreated(W.id)}}}catch{}})()},[_,n,g]);const y=async u=>{let l=0;const i=600;let z=-1,D=0;const X=60,W=async()=>{var ne;try{l++;const oe=(await Ce.tasks.getTaskStatus(u)).task;if(oe.status==="PROCESSING"||oe.status==="PENDING"){const N=oe.progress||0;if(N===z){if(D++,D>=X){T(!1),m.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),te(h=>h.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,taskId:""}}}:E));try{localStorage.removeItem(_)}catch{}return}}else z=N,D=0}if(oe.status==="SUCCESS"||oe.status==="COMPLETED"||oe.status==="DONE"){const N=oe.resultUrl||((ne=oe.previewNodeData)==null?void 0:ne.url);N&&(g(N),te(h=>h.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,generatedVideoUrl:N,taskId:u}}}:E))),T(!1),m.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(_)}catch{}return}else if(oe.status==="PROCESSING"||oe.status==="PENDING")if(l<i)setTimeout(W,5e3);else{T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),te(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}else if(oe.status==="FAILURE"||oe.status==="FAILED"){T(!1);try{const{useAuthStore:N}=await ds(async()=>{const{useAuthStore:E}=await import("./index-Cwo4xSFf.js").then(k=>k.f);return{useAuthStore:E}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:h}=N.getState();await h()}catch{}m.error(oe.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),te(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}else{T(!1),m.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),te(N=>N.map(h=>h.id===n?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),te(oe=>oe.map(N=>N.id===n?{...N,data:{...N.data,config:{...N.data.config,taskId:""}}}:N));try{localStorage.removeItem(_)}catch{}return}};W()},C=async()=>{var u,l;if(!w){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}T(!0);try{const i=await Ce.post("/tasks/video-edit",{modelId:G,prompt:"",referenceImages:d.imageUrl?[d.imageUrl]:[],sourceNodeId:n,generationType:"å¯¹å£å‹",duration:$,metadata:{videoUrl:d.videoUrl,audioUrl:d.audioUrl,videoExtension:fe,duration:$}}),z=i.taskId,D=i.creditsCharged||0;if(D>0)try{const{useAuthStore:X}=await ds(async()=>{const{useAuthStore:ne}=await import("./index-Cwo4xSFf.js").then(xe=>xe.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:W}=X.getState();await W(),m.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${D} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");te(X=>X.map(W=>W.id===n?{...W,data:{...W.data,config:{...W.data.config,taskId:z}}}:W));try{localStorage.setItem(_,z)}catch{}await y(z)}catch(i){T(!1);const z=((l=(u=i==null?void 0:i.response)==null?void 0:u.data)==null?void 0:l.error)||i.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${z}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(_)}catch{}}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:V?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:G,onChange:u=>{v(u),te(l=>l.map(i=>{var z;return i.id===n?{...i,data:{...i.data,config:{...i.data.config,modelId:u,modelName:(z=F.find(D=>D.id===u))==null?void 0:z.name}}}:i}))},options:F.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:F.map(u=>({value:u.id,label:u.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:d.videoUrl?e.jsx("video",{src:d.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},d.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:d.imageUrl?e.jsx("img",{src:d.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},d.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),d.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:c,className:"nodrag w-7 h-7 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Re?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:p(ee)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:ce,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:re,src:d.audioUrl,className:"hidden"}),e.jsx("video",{ref:Y,className:"hidden",muted:!0,onLoadedMetadata:u=>{const l=u.currentTarget;l.duration&&l.duration!==1/0&&ie(l.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:fe,onChange:u=>K(u.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:C,disabled:me||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${me?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:me?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!b&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[r,"ç§¯åˆ†"]}):$===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},go=t.memo(uo),jr="https://api.waule.ai",ho=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],fo=({data:s,selected:j,id:n})=>{var F,G;const[V]=t.useState(!0),[me,T]=t.useState(!1),[fe,K]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[re,Y]=t.useState(s.config.videoFps||15),[ce,Re]=t.useState(0),de=t.useRef(null),{setNodes:ee,setEdges:ae,getNode:je,getNodes:ie,getEdges:be}=Qt(),ge=zs(),pe=t.useMemo(()=>(s.models||[]).filter($=>{var r;return($.type||"")==="VIDEO_EDITING"&&Array.isArray((r=$.config)==null?void 0:r.supportedEditingCapabilities)&&$.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ie,te]=t.useState(s.config.modelId||((F=pe[0])==null?void 0:F.id)||""),{credits:Z,loading:U}=Ss({aiModelId:Ie,duration:ce});t.useMemo(()=>pe.find(v=>v.id===Ie),[pe,Ie]),t.useEffect(()=>{var v;if(!pe.find($=>$.id===Ie)){const $=((v=pe[0])==null?void 0:v.id)||"";te($),ee(r=>r.map(b=>{var d;return b.id===n?{...b,data:{...b.data,config:{...b.data.config,modelId:$||void 0,modelName:$?(d=pe[0])==null?void 0:d.name:void 0}}}:b}))}},[pe]);const R=t.useMemo(()=>{var r,b,d,a,w,c,p,g,y;const v=ge.filter(C=>C.target===n);let $=null;for(const C of v){const O=je(C.source);if(!O)continue;const I=String(O.type||"");if(I==="upload"){const u=(d=(b=(r=O.data)==null?void 0:r.config)==null?void 0:b.uploadedFiles)==null?void 0:d[0];if(!u)continue;const l=String(u.mimeType||"").toLowerCase(),i=String(u.type||"").toUpperCase(),z=u.url.startsWith("http")||u.url.startsWith("data:")?u.url:`${jr}${u.url}`;!$&&(i==="VIDEO"||l.startsWith("video/"))&&($=z)}else if(I==="assetSelector"){const u=(w=(a=O.data)==null?void 0:a.config)==null?void 0:w.selectedAsset;if(u){const l=String(u.mimeType||"").toLowerCase(),i=String(u.type||"").toUpperCase(),z=u.url.startsWith("http")||u.url.startsWith("data:")?u.url:`${jr}${u.url}`;!$&&(i==="VIDEO"||l.startsWith("video/"))&&($=z)}}else if(I==="videoPreview"||I.startsWith("aiVideo")){const u=((c=O.data)==null?void 0:c.videoUrl)||((p=O.data)==null?void 0:p.url)||((y=(g=O.data)==null?void 0:g.config)==null?void 0:y.generatedVideoUrl);!$&&u&&($=u.startsWith("http")||u.startsWith("data:")?u:`${jr}${u}`)}if($)break}return{videoUrl:$}},[ge,n,je]);t.useEffect(()=>{if(!R.videoUrl){Re(0);return}const v=document.createElement("video");v.preload="metadata",v.onloadedmetadata=()=>{v.duration&&v.duration!==1/0&&Re(v.duration)},v.onerror=()=>Re(0),v.src=R.videoUrl},[R.videoUrl]);const L=t.useMemo(()=>!!Ie&&!!R.videoUrl,[Ie,R.videoUrl]),f=t.useCallback(v=>{var X,W,ne;const $=je(n);if(!$||!v)return;const r=ie(),b=be(),d=r.filter(xe=>xe.type==="videoPreview"&&b.some(oe=>oe.source===n&&oe.target===xe.id));if(d.find(xe=>{var oe;return((oe=xe.data)==null?void 0:oe.videoUrl)===v}))return;const w=400,c=(xe,oe=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(xe))return oe;const[N,h]=xe.split(":").map(E=>parseFloat(E));return!N||!h?oe:Math.round(w*(h/N))},p=200,g=100,y=c("16:9",300),C=document.querySelector(`.react-flow__node[data-id="${n}"]`),O=Math.round((C==null?void 0:C.getBoundingClientRect().width)||400),I=(((X=$.position)==null?void 0:X.x)||0)+O+p,u=((W=$.position)==null?void 0:W.y)||0,l=d.length,i=I,z=u+l*(y+g),D={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:i,y:z},data:{videoUrl:v,width:w,ratio:"16:9",workflowContext:$.data.workflowContext,createdBy:(ne=$.data)==null?void 0:ne.createdBy}};ee(xe=>[...xe,D]),ae(xe=>[...xe,{id:`edge-${n}-${D.id}`,source:n,target:D.id,type:"aurora"}])},[n,je,ie,be,ee,ae]);t.useEffect(()=>{var $;const v=($=s==null?void 0:s.config)==null?void 0:$.generatedVideoUrl;v&&f(v)},[(G=s==null?void 0:s.config)==null?void 0:G.generatedVideoUrl]),t.useEffect(()=>{const v=s.config.taskId;(async()=>{var b,d;let r=!1;if(v)try{const w=(await Ce.tasks.getTaskStatus(v)).task;if(w.status==="SUCCESS"){const c=w.resultUrl||((b=w.previewNodeData)==null?void 0:b.url);if(c){let p=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";p=JSON.parse(g).some(C=>C.taskId&&C.taskId===v||C.sourceNodeId&&C.sourceNodeId===n)}catch{}p||f(c),ee(g=>g.map(y=>y.id===n?{...y,data:{...y.data,config:{...y.data.config,generatedVideoUrl:c,taskId:v}}}:y))}T(!1),r=!0}else if(w.status==="PROCESSING"||w.status==="PENDING"){T(!0),await x(v);return}else w.status==="FAILURE"&&(T(!1),ee(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p)))}catch{T(!1)}if(!r)try{const a=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(a.tasks)&&a.tasks.length>0)for(const w of a.tasks){const c=(d=w.previewNodeData)==null?void 0:d.url;if(c){let p=!1;try{const g=localStorage.getItem("suppressedPreviewTasks")||"[]";p=JSON.parse(g).some(C=>C.taskId&&C.taskId===w.id||C.sourceNodeId&&C.sourceNodeId===n)}catch{}p||f(c),await Ce.tasks.markPreviewNodeCreated(w.id)}}}catch{}})()},[]);const x=async v=>{let $=0;const r=600,b=async()=>{var d;try{$++;const w=(await Ce.tasks.getTaskStatus(v)).task;if(w.status==="SUCCESS"){const c=w.resultUrl||((d=w.previewNodeData)==null?void 0:d.url);c&&(f(c),ee(p=>p.map(g=>g.id!==n?g:{...g,data:{...g.data,config:{...g.data.config,generatedVideoUrl:c,taskId:v}}}))),T(!1),m.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else w.status==="PROCESSING"||w.status==="PENDING"?$<r?setTimeout(b,5e3):(T(!1),m.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ee(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p))):w.status==="FAILURE"&&(T(!1),m.error(w.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ee(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,taskId:""}}}:p)))}catch{T(!1),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ee(w=>w.map(c=>c.id===n?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c))}};b()},_=async()=>{var v,$;if(!L){m.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}T(!0);try{const r=await Ce.post("/tasks/video-edit",{modelId:Ie,prompt:"",referenceImages:[],sourceNodeId:n,generationType:"é£æ ¼è½¬æ¢",duration:ce,metadata:{videoUrl:R.videoUrl,styleId:fe,videoFps:re,duration:ce}}),b=r.taskId,d=r.creditsCharged||0;if(d>0)try{const{useAuthStore:a}=await ds(async()=>{const{useAuthStore:c}=await import("./index-Cwo4xSFf.js").then(p=>p.f);return{useAuthStore:c}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:w}=a.getState();await w(),m.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${d} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{m.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else m.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ee(a=>a.map(w=>w.id===n?{...w,data:{...w.data,config:{...w.data.config,taskId:b,styleId:fe,videoFps:re}}}:w)),await x(b)}catch(r){T(!1);const b=(($=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:$.error)||r.message||"æœªçŸ¥åŸå› ";m.error(`å¯åŠ¨å¤±è´¥ï¼š${b}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:V?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(os,{value:Ie,onChange:v=>{te(v),ee($=>$.map(r=>{var b;return r.id===n?{...r,data:{...r.data,config:{...r.data.config,modelId:v,modelName:(b=pe.find(d=>d.id===v))==null?void 0:b.name}}}:r}))},options:pe.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:pe.map(v=>({value:v.id,label:v.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(os,{value:String(fe),onChange:v=>{const $=parseInt(v,10);K($),ee(r=>r.map(b=>b.id===n?{...b,data:{...b.data,config:{...b.data.config,styleId:$}}}:b))},options:ho.map(v=>({value:String(v.id),label:v.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:re,min:15,max:25,onChange:v=>{let $=parseInt(v.target.value,10)||15;$<15&&($=15),$>25&&($=25),Y($),ee(r=>r.map(b=>b.id===n?{...b,data:{...b.data,config:{...b.data.config,videoFps:$}}}:b))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),R.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:de,src:R.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:v=>{const $=v.currentTarget;$.duration&&$.duration!==1/0&&Re($.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:_,disabled:me||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${me?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:me?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!U&&(Z!==null&&Z>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Z,"ç§¯åˆ†"]}):ce===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},po=t.memo(fo),mo=({data:s,selected:j,id:n})=>{const[V,me]=t.useState(null),[T,fe]=t.useState(!1),[K,re]=t.useState(s.config.prompt||""),[Y,ce]=t.useState(""),Re=t.useRef(null),de=t.useRef(!1),[ee,ae]=t.useState(!1),{setNodes:je,setEdges:ie,getNode:be,getNodes:ge,getEdges:pe}=Qt(),Ie=Fs(a=>a.edges.filter(w=>w.target===n)),te=Ls(),[Z,U]=t.useState([]),[R,L]=t.useState([]),f=t.useRef(""),x=t.useMemo(()=>((V==null?void 0:V.roles)||[]).find(a=>a.id===Y),[V,Y]),{credits:_,loading:F,isFreeUsage:G,freeUsageRemaining:v}=Ss({aiModelId:x==null?void 0:x.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&$(s.config.agentId)},[s.config.agentId]);const $=async a=>{var w,c,p,g,y;try{fe(!0);const C=await Ce.agents.getById(a);let O=[];try{O=await Ce.agents.roles.listByAgent(a)||[],me({...C,roles:O});const u=((w=s==null?void 0:s.config)==null?void 0:w.roleId)||"";ce(u||((c=O[0])==null?void 0:c.id)||"")}catch{me(C)}try{const I=await Ce.agents.getAvailableModels(),u=(O||[]).find(l=>{var i;return l.id===((i=s==null?void 0:s.config)==null?void 0:i.roleId)});if(u){const l=(I||[]).find(z=>z.id===u.aiModelId),i=((p=l==null?void 0:l.config)==null?void 0:p.acceptedInputs)||((l==null?void 0:l.type)==="TEXT_GENERATION"&&((y=(g=l==null?void 0:l.provider)==null?void 0:g.toLowerCase())!=null&&y.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:i})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{m.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{fe(!1)}};t.useEffect(()=>{r({roleId:Y}),(async()=>{var a,w,c;if(V)try{const p=await Ce.agents.getAvailableModels(),g=(V.roles||[]).find(y=>y.id===Y);if(g){const y=(p||[]).find(O=>O.id===g.aiModelId),C=((a=y==null?void 0:y.config)==null?void 0:a.acceptedInputs)||((y==null?void 0:y.type)==="TEXT_GENERATION"&&((c=(w=y==null?void 0:y.provider)==null?void 0:w.toLowerCase())!=null&&c.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:C})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[Y,V]);const r=a=>{be(n)&&je(c=>c.map(p=>p.id===n?{...p,data:{...p.data,config:{...p.data.config,...a}}}:p))};t.useEffect(()=>{const a=Re.current;a&&requestAnimationFrame(()=>{a.style.height="auto";const w=Math.max(60,Math.min(a.scrollHeight,600));a.style.height=`${w}px`})},[K]),t.useEffect(()=>{const a=setTimeout(()=>{K!==s.config.prompt&&r({prompt:K})},500);return()=>clearTimeout(a)},[K,s.config.prompt]),t.useEffect(()=>{const a=Ie;if(!a||a.length===0)return;let w="";a.some(c=>{const p=te.find(y=>y.id===c.source);if(!p)return!1;const g=p.data||{};return p.type==="textPreview"&&typeof g.content=="string"&&g.content.trim()?(w=g.content.trim(),!0):!1}),w&&!de.current&&(re(w),r({prompt:w}))},[Ie,te]),t.useEffect(()=>{const a=Ie.map(p=>`${p.id}-${p.source}`).sort().join(",");if(a===f.current)return;f.current=a;const w=[],c=[];Ie.forEach(p=>{var C,O,I;const g=be(p.source);if(!g)return;const y=g.data||{};if(g.type==="upload")(((C=y.config)==null?void 0:C.uploadedFiles)||[]).forEach(l=>{l.type==="IMAGE"&&w.push(l.url),l.type==="DOCUMENT"&&c.push({name:l.originalName,url:l.url})});else if(g.type==="assetSelector"){const u=(O=y.config)==null?void 0:O.subjects;if(u&&u.length>0)(u[0].images||[]).map(i=>{const z="https://api.waule.ai";return i.startsWith("data:")?i:i.startsWith("http")?i.replace(/^https?:\/\/localhost(?::\d+)?/i,z):`${z}${i}`}).forEach(i=>w.push(i));else{const l=(I=y.config)==null?void 0:I.selectedAsset;if(l){const i="https://api.waule.ai",z=D=>D.startsWith("http")?D.replace(/^https?:\/\/localhost(?::\d+)?/i,i):`${i}${D}`;l.type==="IMAGE"&&w.push(z(l.url)),l.type==="DOCUMENT"&&c.push({name:l.originalName,url:z(l.url)})}}}else g.type==="imagePreview"&&y.imageUrl&&w.push(y.imageUrl)}),U(w),L(c)},[Ie,be,te]);const b=()=>{if(!V)return null;const a=(V.roles||[]).find(w=>w.id===Y);return a?{systemPrompt:a.systemPrompt,aiModelId:a.aiModelId,temperature:a.temperature,maxTokens:a.maxTokens}:null},d=async()=>{var w,c,p,g,y,C,O,I,u,l,i,z,D,X;if(!V){m.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!K.trim()){m.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let a=(V.roles||[]).find(W=>W.id===Y)||(V.roles||[])[0];if(!a){m.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!Y||Y!==a.id)&&(ce(a.id),r({roleId:a.id}));try{ae(!0);const ne=pe().filter(Ae=>Ae.target===n);let xe="";const oe="https://api.waule.ai",N=[],h=[],E=[];for(const Ae of ne){const _e=be(Ae.source);if(_e)if(_e.type==="upload"){const Te=((c=(w=_e.data)==null?void 0:w.config)==null?void 0:c.uploadedFiles)||[];for(const le of Te)if(le.type==="DOCUMENT")N.push({filePath:le.url,mimeType:le.mimeType}),xe+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){const Ve=le.url.startsWith("http")?le.url:`${oe}${le.url}`;h.push(Ve),xe+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){const Ve=le.url.startsWith("http")?le.url:`${oe}${le.url}`;E.push(Ve),xe+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}else le.type==="AUDIO"&&(xe+=`[éŸ³é¢‘æ–‡ä»¶: ${le.originalName}]
`)}else if(_e.type==="assetSelector"){const Te=(g=(p=_e.data)==null?void 0:p.config)==null?void 0:g.subjects;if(Te&&Te.length>0){const le=(Te[0].images||[]).map(Ve=>Ve.startsWith("http")?Ve:`${oe}${Ve}`).map(Ve=>Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe));le.forEach(Ve=>h.push(Ve)),xe+=`[å‚è€ƒå›¾ç‰‡ç»„: ${le.length} å¼ ]
`}else{const le=(C=(y=_e.data)==null?void 0:y.config)==null?void 0:C.selectedAsset;if(le){if(le.type==="DOCUMENT")N.push({filePath:le.url,mimeType:le.mimeType}),xe+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){let Ve=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),h.push(Ve),xe+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){let Ve=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),E.push(Ve),xe+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}}}}else if(_e.type==="aiImage"){const Te=(I=(O=_e.data)==null?void 0:O.config)==null?void 0:I.generatedImageUrl;if(Te){const le=Te.startsWith("http")?Te:`${oe}${Te}`;h.push(le),xe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(_e.type==="imagePreview"){const Te=_e.data.imageUrl;Te&&(h.push(Te),xe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(_e.type==="videoPreview"){const Te=_e.data.videoUrl;if(Te){const le=Te.startsWith("http")?Te:`${oe}${Te}`;E.push(le),xe+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else _e.type==="textPreview"&&_e.data.content&&(xe+=_e.data.content+`

`)}const k=b();if(!k)return;let J=k.systemPrompt;xe&&(J+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${xe}`),J+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${K}`;const ue=await Ce.ai.text.generate({modelId:a.aiModel.id||k.aiModelId,prompt:J,systemPrompt:a.systemPrompt||k.systemPrompt,temperature:a.temperature??k.temperature,maxTokens:a.maxTokens??k.maxTokens,documentFiles:N.length>0?N:void 0,imageUrls:h.length>0?h:void 0,videoUrls:E.length>0?E:void 0}),B=ue&&(((u=ue.data)==null?void 0:u.text)||(ue==null?void 0:ue.text))||"";if(!B||B.trim()===""){m.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:B});const he=pe().filter(Ae=>Ae.source===n),Ee=ge(),Ne=he.filter(Ae=>{const _e=Ee.find(Te=>Te.id===Ae.target);return _e&&_e.type!=="textPreview"});if(Ne.length>0)je(Ae=>{const _e=new Set(Ne.map(Te=>Te.target));return Ae.map(Te=>{var Ve;if(!_e.has(Te.id))return Te;const le=((Ve=Te.data)==null?void 0:Ve.config)||{};return Te.type==="midjourney"?{...Te,data:{...Te.data,prompt:B}}:{...Te,data:{...Te.data,config:{...le,prompt:B}}}})});else{const Ae=be(n);if(Ae){const _e=Date.now(),Te=`text-preview-${n}-${_e}`,le=he.filter(gt=>{const vt=Ee.find(it=>it.id===gt.target);return vt&&vt.type==="textPreview"}),Ve=document.querySelector(`.react-flow__node[data-id="${n}"]`),et=(Ve==null?void 0:Ve.getBoundingClientRect().width)||300,Ft=Ae.position.x+et+100,Mt=Ae.position.y+le.length*700,At={id:Te,type:"textPreview",position:{x:Ft,y:Mt},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:B,createdBy:(l=Ae.data)==null?void 0:l.createdBy}},ct={id:`edge-${n}-${Te}`,source:n,target:Te,type:"aurora"};je(gt=>[...gt,At]),setTimeout(()=>{ie(gt=>[...gt,ct])},50)}}const $e=(ue==null?void 0:ue.creditsCharged)||0;if($e>0){const{useAuthStore:Ae}=await ds(async()=>{const{useAuthStore:Te}=await import("./index-Cwo4xSFf.js").then(le=>le.f);return{useAuthStore:Te}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_e}=Ae.getState();await _e(),m.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${$e} ç§¯åˆ†ï¼‰`)}else m.success("æ‰§è¡ŒæˆåŠŸ")}catch(W){const ne=((z=(i=W==null?void 0:W.response)==null?void 0:i.data)==null?void 0:z.message)||((X=(D=W==null?void 0:W.response)==null?void 0:D.data)==null?void 0:X.error)||(W==null?void 0:W.message)||"æœªçŸ¥é”™è¯¯";m.error("æ‰§è¡Œå¤±è´¥ï¼š"+ne)}finally{ae(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:T?"LOADING...":((V==null?void 0:V.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[V&&(V.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(os,{value:Y,onChange:a=>ce(a),options:[...V.roles||[]].sort((a,w)=>(a.order??0)-(w.order??0)).map(a=>({value:a.id,label:a.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Re,value:K,onChange:a=>{de.current=!0,re(a.target.value)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:d,disabled:ee||T||!V||!K.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:cursor-not-allowed bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg  border-transparent dark:border-white/10",children:ee?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!F&&(G?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(v),"æ¬¡"]}):_!==null&&_>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[_,"ç§¯åˆ†"]}):null)]})}),Z.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",Z.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:Z.map((a,w)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:a,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"})},w))})]}),R.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",R.length,")"]}),e.jsx("div",{className:"space-y-1",children:R.map((a,w)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:a.name,children:a.name})]},w))})]})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},xo=t.memo(mo),Ir="https://api.waule.ai",_s=400,bo=({data:s,id:j,selected:n})=>{const[V,me]=t.useState(!1),[T,fe]=t.useState(0),[K,re]=t.useState(s.config.uploadedFiles||[]),[Y,ce]=t.useState(null),[Re,de]=t.useState(null);t.useEffect(()=>()=>{},[j]),t.useEffect(()=>{},[Y]),t.useEffect(()=>{},[Re]);const[ee,ae]=t.useState(null),je=t.useRef(null),ie=t.useRef(null),be=t.useRef(null),[ge,pe]=t.useState(!1),[Ie,te]=t.useState(0),[Z,U]=t.useState(0),[R,L]=t.useState(!1),f=t.useRef(null),{setNodes:x,getNode:_,setEdges:F,getEdges:G}=Qt(),v=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const i=s.createdBy;if(typeof i=="object"&&(i==null||i.id),v.current)return;const z=s.config.uploadedFiles||[];!V&&JSON.stringify(z)!==JSON.stringify(K)&&(re(z),ce(null),de(null))},[s.config.uploadedFiles,V,s._currentUserId,s.createdBy]);const $=()=>{f.current&&(f.current.paused?(f.current.play(),L(!0)):(f.current.pause(),L(!1)))},r=i=>{_(j)&&(v.current=!0,x(D=>D.map(X=>X.id===j?{...X,data:{...X.data,config:{...X.data.config,uploadedFiles:i}}}:X)))},b=async i=>{var D,X;if(!i||i.length===0)return;me(!0);const z=[];try{for(let W=0;W<i.length;W++){const ne=i[W];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ne.type)){m.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ne.name}`);continue}const oe=await Ce.assets.upload(ne,void 0,{onUploadProgress:N=>{const h=(N==null?void 0:N.total)||0,E=(N==null?void 0:N.loaded)||0;if(h>0){const k=Math.round(E/h*100);fe(k)}}});if(oe.data){const N=(oe.data.type||"").toUpperCase(),h=(oe.data.mimeType||"").toLowerCase(),E=N==="IMAGE"||N==="VIDEO"||N==="AUDIO"?N:h.startsWith("image/")?"IMAGE":h.startsWith("video/")?"VIDEO":h.startsWith("audio/")?"AUDIO":N||"",k=oe.data.url;z.push({id:oe.data.id,name:oe.data.name,originalName:oe.data.originalName,type:E,mimeType:oe.data.mimeType,size:oe.data.size,url:k})}}if(z.length>0){let W=[];const ne=z[0].type;if(ee!==null)W=[...K],W[ee]=z[0];else{const oe={};for(const N of K)oe[N.id]=N;for(const N of z)oe[N.id]=N;W=Object.values(oe)}if(_(j)){const oe=G().filter(h=>h.source===j),N=[];if(oe.forEach(h=>{var J;const E=_(h.target);if(!E||E.type.startsWith("aiVideo"))return;const k=(J=E.data.config)==null?void 0:J.acceptedInputs;if(k&&k.length>0){const ue=ne.toUpperCase();k.map(he=>typeof he=="string"?he.toUpperCase():he).includes(ue)||N.push(h.id)}}),N.length>0){F(E=>E.filter(k=>!N.includes(k.id)));const h={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.warning(`å·²æ–­å¼€ ${N.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${h[ne]||ne}ç±»å‹ï¼‰`)}}ce(null),de(null),re(W),r(W);try{const oe=G().filter(h=>h.source===j);if(oe.some(h=>{const E=_(h.target);return(E==null?void 0:E.type)==="aiVideo"})){const h=localStorage.getItem("workflow:nodes"),E=h?JSON.parse(h):[],k=oe.filter(ue=>{var B;return((B=_(ue.target))==null?void 0:B.type)==="aiVideo"}).map(ue=>ue.target),J=E.filter(ue=>k.includes(ue.id));J.length>0&&x(ue=>ue.map(B=>J.find(he=>he.id===B.id)?{...B,data:{...B.data,config:{...B.data.config,_updatedAt:Date.now()}}}:B))}}catch{}m.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(W){m.error(`ä¸Šä¼ å¤±è´¥: ${((X=(D=W.response)==null?void 0:D.data)==null?void 0:X.message)||W.message}`)}finally{me(!1),fe(0),je.current&&(je.current.value=""),ae(null)}},d=()=>{x(i=>i.filter(z=>z.id!==j)),F(i=>i.filter(z=>z.source!==j&&z.target!==j)),m.success("èŠ‚ç‚¹å·²åˆ é™¤")},a=()=>{var i;ae(0),(i=je.current)==null||i.click()},w=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(2)+" KB":(i/(1024*1024)).toFixed(2)+" MB",c=i=>i.startsWith("image/")?{icon:"image",color:"text-neutral-500 dark:text-neutral-400"}:i.startsWith("video/")?{icon:"movie",color:"text-neutral-500 dark:text-neutral-400"}:i.startsWith("audio/")?{icon:"audio_file",color:"text-neutral-500 dark:text-neutral-400"}:{icon:"description",color:"text-neutral-500 dark:text-neutral-400"};t.useEffect(()=>{if(K.length>0){const i=K[0],z=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Ir}${i.url}`).replace(".oss-oss-",".oss-");if(i.type==="IMAGE"){const D=new Image;D.onload=()=>{const X=D.width/D.height,W=_s/X;ce({width:_s,height:W})},D.onerror=X=>{ce({width:_s,height:_s*.75})},D.src=z}else if(i.type==="VIDEO"){const D=document.createElement("video");D.onloadedmetadata=()=>{const X=D.videoWidth/D.videoHeight,W=_s/X;de({width:_s,height:W})},D.onerror=X=>{de({width:_s,height:_s*.5625})},D.src=z}}},[K]);const p=()=>{const i=ie.current;i&&(ge?(i.pause(),pe(!1)):(i.play(),pe(!0)))};t.useEffect(()=>{const i=ie.current;if(!i)return;const z=()=>te(i.duration||0),D=()=>U(i.duration?i.currentTime/i.duration:0),X=()=>pe(!1);return i.addEventListener("loadedmetadata",z),i.addEventListener("timeupdate",D),i.addEventListener("ended",X),()=>{i.removeEventListener("loadedmetadata",z),i.removeEventListener("timeupdate",D),i.removeEventListener("ended",X)}},[K]);const g=t.useRef(null),[y,C]=t.useState(0);t.useEffect(()=>{const i=K[0];if(!i||i.type!=="AUDIO"){g.current=null;return}const D=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Ir}${i.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let W;/https:\/\/.*aliyuncs\.com\//.test(D)?W=await Ce.assets.proxyDownload(D):W=await(await fetch(D,{mode:"cors"})).arrayBuffer();const ne=window.AudioContext||window.webkitAudioContext,N=(await new ne().decodeAudioData(W)).getChannelData(0),h=120,E=Math.max(1,Math.floor(N.length/h)),k=new Float32Array(h);for(let J=0;J<h;J++){let ue=0,B=0;const he=J*E,Ee=Math.min(N.length,he+E);for(let Ne=he;Ne<Ee;Ne++)ue+=Math.abs(N[Ne]),B++;k[J]=B?ue/B:0}g.current=k,C(J=>J+1)}catch{const ne=new Float32Array(120);for(let xe=0;xe<120;xe++)ne[xe]=(Math.sin(xe/5)+1)/2;g.current=ne,C(xe=>xe+1)}})()},[K]),t.useEffect(()=>{const i=be.current;if(!i)return;const z=g.current;if(!z)return;const D=i.getContext("2d");if(!D)return;const X=i.width,W=i.height;D.clearRect(0,0,X,W);const ne=z.length,xe=2,oe=Math.max(1,Math.floor((X-(ne-1)*xe)/ne)),N=D.createLinearGradient(0,0,X,0);N.addColorStop(0,"#525252"),N.addColorStop(.5,"#d946ef"),N.addColorStop(1,"#404040");for(let h=0;h<ne;h++){const E=Math.min(1,Math.max(0,z[h])),k=Math.max(2,Math.floor(E*W)),J=h*(oe+xe),ue=Math.floor((W-k)/2);D.fillStyle=N,D.fillRect(J,ue,oe,k)}if(Z>0){const h=Math.floor(X*Z);D.fillStyle="#ffffff88",D.fillRect(h,0,2,W)}},[Z,y]);const O=i=>{if(!i||!isFinite(i))return"0:00";const z=Math.floor(i/60),D=Math.floor(i%60);return`${z}:${D.toString().padStart(2,"0")}`},I=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"neutral"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"neutral"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"neutral"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"neutral"}],u=K[0],l=u?(u.url.startsWith("http")||u.url.startsWith("data:")?u.url:`${Ir}${u.url}`).replace(".oss-oss-",".oss-"):"";return u&&u.type==="IMAGE"&&Y?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:l,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:Y.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>b(i.target.files),className:"hidden"})]}):u&&u.type==="VIDEO"&&Re?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${R?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:i=>{i.stopPropagation(),$()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:R?"pause":"play_arrow"})})}),e.jsx("video",{ref:f,src:l,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Re.height},onEnded:()=>L(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>b(i.target.files),className:"hidden"})]}):u&&u.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:p,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:ge?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:O(Ie)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:be,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ie,src:l,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>b(i.target.files),className:"hidden"})]}):u&&u.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:u.originalName,children:u.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:w(u.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>b(i.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:je,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>b(i.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var i;s._canEdit!==!1&&((i=je.current)==null||i.click())},onDragOver:i=>{i.preventDefault(),i.stopPropagation()},onDrop:i=>{i.preventDefault(),i.stopPropagation(),s._canEdit!==!1&&b(i.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-neutral-400 dark:hover:border-neutral-400/50 transition-colors ${V||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:V?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:V?`ä¸Šä¼ ä¸­... ${T}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),V&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all",style:{width:`${T}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:I.map(i=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${i.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:i.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:i.formats.join(", ")})]},i.type))})]}),K.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",K.length,")"]}),K.map(i=>{const{icon:z,color:D}=c(i.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${D} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:z}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:i.originalName,children:i.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:w(i.size)})]}),e.jsx("button",{onClick:d,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},i.id)})]})]})}),e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},wo=t.memo(bo),Vr="https://api.waule.ai",Ms=320,yo=({data:s,id:j,selected:n})=>{const[V,me]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[T,fe]=t.useState([]),{setNodes:K,getNode:re}=Qt(),[Y,ce]=t.useState(null),[Re,de]=t.useState(null),ee=t.useRef(null),ae=t.useRef(null),[je,ie]=t.useState(!1),[be,ge]=t.useState(0),[pe,Ie]=t.useState(0),te=t.useRef(null),[Z,U]=t.useState(!1),[R,L]=t.useState(!1),f=t.useRef(null),x=()=>{f.current&&(f.current.paused?(f.current.play(),L(!0)):(f.current.pause(),L(!1)))},_=t.useRef(!1);t.useEffect(()=>{const d=s._currentUserId,a=s.createdBy,w=typeof a=="object"?a==null?void 0:a.id:a;if(d&&w&&d===w&&_.current)return;const c=s.config.selectedInput||s.config.selectedAsset||null;if(!c)return;const p=V;(()=>{if(!p)return!1;const y=p.images&&!p.type,C=c.images&&!c.type;if(y&&C){const O=p.images||[],I=c.images||[];if(O.length!==I.length)return!1;for(let u=0;u<O.length;u++)if(O[u].id!==I[u].id||O[u].url!==I[u].url)return!1;return!0}if(p.id&&c.id)return p.id===c.id&&p.url===c.url&&p.type===c.type;try{return JSON.stringify(p)===JSON.stringify(c)}catch{return!1}})()||me(c)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var a,w,c;if(V&&V.images&&!V.type){const p=V,g=(c=(w=(a=re(j))==null?void 0:a.data)==null?void 0:w.config)==null?void 0:c.referenceImages;Array.isArray(g)&&g.length>0?fe(g.map(y=>({id:y.id,url:y.url,name:y.name}))):fe(p.images||[])}else fe([])},[V,re,j]);const F=d=>{const a=re(j);a&&(_.current=!0,K(w=>w.map(c=>c.id===j?{...c,data:{...c.data,config:{...c.data.config,...d}}}:c)),me((d==null?void 0:d.selectedInput)??(d==null?void 0:d.selectedAsset)??a.data.config.selectedInput??a.data.config.selectedAsset))},G=d=>/^https?:\/\//.test(d)||d.startsWith("data:"),v=d=>!d||d.startsWith("data:")?d:/^https?:\/\/localhost(?::\d+)?\//i.test(d)?d.replace(/^https?:\/\/localhost(?::\d+)?/i,Vr):G(d)?d:`${Vr}${d}`;t.useEffect(()=>{var I,u,l,i,z,D,X,W,ne;if(!(V&&V.images&&!V.type))return;const a=V,w=T.length?T:a.images||[];if(w.length===1){const xe=w[0],oe={id:xe.id,name:xe.name,originalName:xe.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:xe.url};F({selectedInput:oe,selectedAsset:oe,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const c=[{name:a.name,images:w.map(xe=>v(xe.url))}],p=w.map(xe=>({id:xe.id,url:xe.url,name:xe.name})),g=[a.id],y=(l=(u=(I=re(j))==null?void 0:I.data)==null?void 0:u.config)==null?void 0:l.subjects,C=(D=(z=(i=re(j))==null?void 0:i.data)==null?void 0:z.config)==null?void 0:D.referenceImages,O=(ne=(W=(X=re(j))==null?void 0:X.data)==null?void 0:W.config)==null?void 0:ne.roleIds;(JSON.stringify(y)!==JSON.stringify(c)||JSON.stringify(C)!==JSON.stringify(p)||JSON.stringify(O)!==JSON.stringify(g))&&F({subjects:c,referenceImages:p,roleIds:g})},[T]);const $=d=>{if(!(V&&V.images&&!V.type))return;const w=V,c=[...T];if(d<0||d>=c.length)return;if(c.splice(d,1),fe(c),m.success("å·²åˆ é™¤å‚è€ƒå›¾"),c.length===0){me(null),F({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),m.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(c.length===1){const O=c[0],I={id:O.id,name:O.name,originalName:O.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:O.url};me(I),F({selectedInput:I,selectedAsset:I,subjects:void 0,referenceImages:void 0,roleIds:void 0}),m.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const p={id:w.id,name:w.name,coverUrl:v(c[0].url),images:c};me(p);const g=[{name:p.name,images:c.map(O=>v(O.url))}],y=c.map(O=>({id:O.id,url:O.url,name:O.name})),C=[p.id];F({selectedInput:p,subjects:g,referenceImages:y,roleIds:C}),m.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(j)};t.useEffect(()=>{if(V&&V.type){const d=V;if(d.type==="IMAGE"){const a=new Image;a.onload=()=>{const w=a.width/a.height,c=Ms/w;ce({width:Ms,height:c})},a.src=v(d.url)}else if(d.type==="VIDEO"){const a=document.createElement("video");a.onloadedmetadata=()=>{const w=a.videoWidth/a.videoHeight,c=Ms/w;de({width:Ms,height:c})},a.src=v(d.url)}}},[V]),t.useEffect(()=>{if(!(V&&V.type==="AUDIO")){U(!1);return}const w=v(V.url),c=ee.current,p=ae.current;if(!c||!p)return;c.src=w,Ie(0),U(!1);const g=()=>ge(c.duration||0),y=()=>Ie(c.duration?c.currentTime/c.duration:0),C=()=>ie(!1);return c.addEventListener("loadedmetadata",g),c.addEventListener("timeupdate",y),c.addEventListener("ended",C),(async()=>{try{const u=await(await fetch(w,{mode:"cors"})).arrayBuffer(),l=window.AudioContext||window.webkitAudioContext,D=(await new l().decodeAudioData(u)).getChannelData(0),X=120,W=Math.max(1,Math.floor(D.length/X)),ne=new Float32Array(X);for(let xe=0;xe<X;xe++){let oe=0,N=0;const h=xe*W,E=Math.min(D.length,h+W);for(let k=h;k<E;k++)oe+=Math.abs(D[k]),N++;ne[xe]=N?oe/N:0}te.current=ne,U(!0)}catch{const u=new Float32Array(120);for(let l=0;l<120;l++)u[l]=(Math.sin(l/5)+1)/2;te.current=u,U(!0)}})(),()=>{c.removeEventListener("loadedmetadata",g),c.removeEventListener("timeupdate",y),c.removeEventListener("ended",C)}},[V]),t.useEffect(()=>{if(!(V&&V.type==="AUDIO")||!Z)return;const a=ae.current,w=te.current;if(!a||!w)return;const c=a.getContext("2d");if(!c)return;const p=a.width,g=a.height;c.clearRect(0,0,p,g);const y=w.length,C=2,O=Math.max(1,Math.floor((p-(y-1)*C)/y)),I=c.createLinearGradient(0,0,p,0);I.addColorStop(0,"#525252"),I.addColorStop(.5,"#d946ef"),I.addColorStop(1,"#404040");for(let u=0;u<y;u++){const l=Math.min(1,Math.max(0,w[u])),i=Math.max(2,Math.floor(l*g)),z=u*(O+C),D=Math.floor((g-i)/2);c.fillStyle=I,c.fillRect(z,D,O,i)}if(pe>0){const u=Math.floor(p*pe);c.fillStyle="#ffffff88",c.fillRect(u,0,2,g)}},[V,pe,Z]);const b=d=>d<1024?d+" B":d<1024*1024?(d/1024).toFixed(2)+" KB":(d/(1024*1024)).toFixed(2)+" MB";if(V){if(V.images&&!V.type){const c=V;return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ms*.5625},children:T[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:p=>p.preventDefault(),src:v(T[0].url),alt:c.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:p=>{p.preventDefault(),p.stopPropagation(),p.nativeEvent&&typeof p.nativeEvent.stopImmediatePropagation=="function"&&p.nativeEvent.stopImmediatePropagation(),$(0)},onClick:p=>{p.preventDefault(),p.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:c.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:T.slice(1).map((p,g)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:y=>y.preventDefault(),src:v(p.url),alt:p.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),y.nativeEvent&&typeof y.nativeEvent.stopImmediatePropagation=="function"&&y.nativeEvent.stopImmediatePropagation(),$(g+1)},onClick:y=>{y.preventDefault(),y.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},p.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const a=V,w=v(a.url);if(a.type==="IMAGE"&&Y)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:w,alt:a.name,className:"w-full object-cover",style:{width:Ms,height:Y.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="VIDEO"&&Re)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${R?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:c=>{c.stopPropagation(),x()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:R?"pause":"play_arrow"})})}),e.jsx("video",{ref:f,src:w,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ms,height:Re.height},onEnded:()=>L(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const c=ee.current;c&&(je?(c.pause(),ie(!1)):(c.play(),ie(!0)))},className:"nodrag w-8 h-8 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:je?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const c=be;if(!c||!isFinite(c))return"0:00";const p=Math.floor(c/60),g=Math.floor(c%60);return`${p}:${g.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:ae,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ee,src:w,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(a.type==="DOCUMENT"){const c=y=>y.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:y.includes("word")?{icon:"description",color:"text-blue-400"}:y.includes("excel")||y.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:p,color:g}=c(a.mimeType);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${g} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:p}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:a.originalName,children:a.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:b(a.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},ko=t.memo(yo),pr={};function Ts(s){const{project:j,episode:n,nodeGroup:V,assetType:me,preview:T=!0}=s;if(!V||!V.scene||!V.shot)return null;const fe=`${V.id}-${me}`;pr[fe]||(pr[fe]=0);let K;T?K=pr[fe]+1:(pr[fe]++,K=pr[fe]);let re=j.name;if(j.type==="DRAMA"&&n){const Y=`S${String(n.episodeNumber).padStart(3,"0")}`;re+=`_${Y}`}return re+=`_Sc${V.scene}_Sh${V.shot}`,re+=`_${K}`,re}function Ws(s,j){return j.find(n=>n.nodeIds.includes(s))||null}const vo=({data:s,id:j})=>{var c,p;const{setNodes:n,setEdges:V,getNodes:me}=Qt(),T=Ar(g=>g.refreshUser),fe=Cr(),K=!!((c=s==null?void 0:s.workflowContext)!=null&&c.episode)||fe.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var y,C,O;if(K)try{const I=(s==null?void 0:s.workflowContext)||{},u=I.episode,l=new URLSearchParams(window.location.search),i=Number(l.get("shot"))||1,z=fe.pathname.split("/").filter(Boolean),D=z.indexOf("projects"),X=z.indexOf("episodes"),W=((y=I.project)==null?void 0:y.id)||(u==null?void 0:u.projectId)||(D>=0?z[D+1]:void 0),ne=(u==null?void 0:u.id)||(X>=0?z[X+1]:void 0);if(!W||!ne)return;const xe=await Ce.episodes.getById(W,ne),oe=(xe==null?void 0:xe.data)??xe,N=(oe==null?void 0:oe.data)??oe,E=(Array.isArray((C=N==null?void 0:N.scriptJson)==null?void 0:C.acts)?N.scriptJson.acts:[]).find(B=>B.actIndex===1),k=(O=E==null?void 0:E.shots)==null?void 0:O.find(B=>Number(B.shotIndex)===i),ue=(Array.isArray(k==null?void 0:k.mediaList)?k.mediaList:[]).some(B=>(B==null?void 0:B.nodeId)===j);n(B=>B.map(he=>he.id===j?{...he,data:{...he.data,addedToStoryboard:ue}}:he))}catch{}})()},[j,K,fe.pathname]);const[re,Y]=t.useState(!1),[ce,Re]=t.useState([]),[de,ee]=t.useState(""),[ae,je]=t.useState("ALL"),[ie,be]=t.useState(""),[ge,pe]=t.useState(!1),Ie=s.width||400,[te,Z]=t.useState(null);t.useEffect(()=>{re&&(b(),setTimeout(()=>{d()},100))},[re]);const U=t.useRef(null),R=t.useRef(!1);t.useEffect(()=>{const g=s.pendingButtonAction;if(g){try{const O=localStorage.getItem("suppressedPreviewTasks")||"[]",I=JSON.parse(O),u=localStorage.getItem("createdPreviewTasks")||"[]",l=JSON.parse(u),i=I.some(W=>W.taskId&&W.taskId===g.newTaskId||W.sourceNodeId&&W.sourceNodeId===g.sourceNodeId),D=me().some(W=>{var ne,xe,oe,N;return W.type==="imagePreview"&&((xe=(ne=W.data)==null?void 0:ne.midjourneyData)==null?void 0:xe.sourceNodeId)===g.sourceNodeId&&((N=(oe=W.data)==null?void 0:oe.midjourneyData)==null?void 0:N.taskId)===g.newTaskId}),X=l.some(W=>W.taskId&&W.taskId===g.newTaskId);if(i||X&&D){Z(null),n(W=>W.map(ne=>ne.id===g.sourceNodeId?{...ne,data:{...ne.data,pendingButtonAction:void 0}}:ne));return}}catch{}if(R.current)return;if(R.current=!0,me().some(O=>{var I,u,l,i;return O.type==="imagePreview"&&((u=(I=O.data)==null?void 0:I.midjourneyData)==null?void 0:u.sourceNodeId)===g.sourceNodeId&&((i=(l=O.data)==null?void 0:l.midjourneyData)==null?void 0:i.taskId)===g.newTaskId})){Z(null),n(O=>O.map(I=>I.id===g.sourceNodeId?{...I,data:{...I.data,pendingButtonAction:void 0}}:I)),R.current=!1;return}Z(g.buttonCustomId),L(g.newTaskId,g.buttonLabel,g.sourceNodeId)}return()=>{R.current=!1,U.current&&(clearTimeout(U.current),U.current=null)}},[]);const L=async(g,y,C)=>{const O=C||j;let I=0;const u=150,l=2e3;R.current=!0;const i=/^[UV]\d$/.test(y)||y.includes("Vary")||y.includes("Upscale")&&y!=="Upscale"||y.includes("Zoom")||y.includes("Pan")||y.includes("Make")||y.includes("Remaster"),z=async()=>{var D,X,W,ne,xe,oe,N,h;if(R.current)try{const E=await Ce.midjourney.fetchTask(g);if(!R.current)return;const k=E.task;if(k.status==="SUCCESS"){if(i&&s.imageUrl&&((D=s.midjourneyData)!=null&&D.messageId)){const gt=k.imageUrl===s.imageUrl,vt=((X=k.properties)==null?void 0:X.messageId)===((W=s.midjourneyData)==null?void 0:W.messageId);if(gt&&vt){I++;try{const it=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(it).some(Be=>{var wt;return Be.taskId&&Be.taskId===g||Be.messageId&&Be.messageId===((wt=k.properties)==null?void 0:wt.messageId)})){Z(null),n(Be=>Be.map(wt=>wt.id===O?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}I<u?U.current=setTimeout(z,l):(m.error(`${y} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),Z(null),n(it=>it.map(Ke=>Ke.id===O?{...Ke,data:{...Ke.data,pendingButtonAction:void 0}}:Ke)));return}}if(m.success(`${y} å®Œæˆï¼`),Z(null),n(gt=>gt.map(vt=>vt.id===O?{...vt,data:{...vt.data,pendingButtonAction:void 0}}:vt)),me().find(gt=>{var vt,it,Ke,yt,Be;return gt.type==="imagePreview"&&((vt=gt.data.midjourneyData)==null?void 0:vt.sourceNodeId)===O&&(((it=gt.data.midjourneyData)==null?void 0:it.taskId)===g||((Ke=k.properties)==null?void 0:Ke.messageId)&&((yt=gt.data.midjourneyData)==null?void 0:yt.messageId)===((Be=k.properties)==null?void 0:Be.messageId))})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const B=me().find(gt=>gt.id===O);if(!B)return;if(!k.imageUrl){m.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const he=200,Ee=100,Ne=s.width||400,Ae=((gt,vt=300)=>{if(!gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(gt))return vt;const[it,Ke]=gt.split(":").map(yt=>parseFloat(yt));return!it||!Ke?vt:Math.round(Ne*(Ke/it))})(s.ratio,300),_e=document.querySelector(`.react-flow__node[data-id="${B.id}"]`),Te=Math.round((_e==null?void 0:_e.getBoundingClientRect().width)||((ne=B.data)==null?void 0:ne.width)||400),le=me().filter(gt=>{var vt,it;return gt.type==="imagePreview"&&((it=(vt=gt.data)==null?void 0:vt.midjourneyData)==null?void 0:it.sourceNodeId)===O}),Ve=B.position.x+Te+he,et=B.position.y,Ft=Ve,Mt=et+le.length*(Ae+Ee),At=`preview-${Date.now()}`,ct={id:At,type:"imagePreview",position:{x:Ft,y:Mt},data:{imageUrl:k.imageUrl,width:Ne,height:Ae,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(xe=B.data)==null?void 0:xe.createdBy,midjourneyData:{taskId:g,messageId:(oe=k.properties)==null?void 0:oe.messageId,messageHash:(N=k.properties)==null?void 0:N.messageHash,sourceNodeId:O,buttons:k.buttons,action:k.action}}};n(gt=>[...gt,ct]),V(gt=>{const vt={id:`${O}-${At}`,source:O,target:At,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...gt,vt]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const vt=me().find(it=>it.id===At)})});try{const gt=localStorage.getItem("createdPreviewTasks")||"[]",it=[...JSON.parse(gt),{taskId:g,messageId:(h=k.properties)==null?void 0:h.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(it))}catch{}m.success(`å·²åˆ›å»º${y}é¢„è§ˆèŠ‚ç‚¹`);return}if(k.status==="FAILURE"){m.error(`${y} å¤±è´¥: ${k.failReason||"æœªçŸ¥é”™è¯¯"}`),Z(null),n(J=>J.map(ue=>ue.id===O?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue));return}if(k.status==="NOT_FOUND"){if(me().some(B=>{var he,Ee,Ne,$e;return B.type==="imagePreview"&&((Ee=(he=B.data)==null?void 0:he.midjourneyData)==null?void 0:Ee.sourceNodeId)===O&&(($e=(Ne=B.data)==null?void 0:Ne.midjourneyData)==null?void 0:$e.taskId)===g})){Z(null),n(B=>B.map(he=>he.id===O?{...he,data:{...he.data,pendingButtonAction:void 0}}:he));return}m.error(`${y} ä»»åŠ¡ä¸å­˜åœ¨`),Z(null),n(B=>B.map(he=>he.id===O?{...he,data:{...he.data,pendingButtonAction:void 0}}:he));return}I++,I<u?U.current=setTimeout(z,l):(m.error(`${y} è¶…æ—¶`),Z(null),n(J=>J.map(ue=>ue.id===j?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue)))}catch(E){m.error(`${y} å¤±è´¥: ${E.message}`),Z(null),n(k=>k.map(J=>J.id===j?{...J,data:{...J.data,pendingButtonAction:void 0}}:J))}};z()},f=()=>{try{const g=localStorage.getItem("midjourneyButtonConfig");if(g)return JSON.parse(g)}catch{}return{}},x=g=>{const y=f();if(Object.keys(y).length===0)return!0;const C=g.label.replace(/\s+/g,"_");return y.hasOwnProperty(C)?y[C]===!0:!0},_=g=>{if(!g)return"";let y=g.trim();return/^upscale_\d+\s/i.test(y)&&(y=y.replace(/^upscale_\d+\s+/i,"")),y},F=(((p=s.midjourneyData)==null?void 0:p.buttons)||[]).map(g=>String(g.label||"").toLowerCase()),G=F.some(g=>/^[uv][1-4]$/i.test(g)),v=F.some(g=>g.includes("redo")),$=!G&&!v&&F.some(g=>g.includes("upscale")),r=g=>{const y=String(g.label||""),C=y.toLowerCase(),O=String(g.customId||"").toLowerCase(),I=/ğŸ‘|â¤ï¸|â¤/.test(y);return C.includes("animate")||C.includes("web")||O.includes("web")||C.includes("browser")||C.includes("open in web")||C.includes("open web")||C.includes("like")||O.includes("like")||I?!1:G?/^U[1-4]$/i.test(y):$?C.includes("upscale"):!1};t.useEffect(()=>{re&&(b(),d())},[re]);const b=async()=>{try{const g=ae==="ALL"?void 0:{category:ae},C=(await Ce.assetLibraries.getAll(g)).data||[];if(Re(C),C.length>0){const O=C.find(I=>I.id===de);ee(O?O.id:C[0].id)}else ee("")}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},d=()=>{const g=window.__workflowContext;if(!g||!g.project||!g.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const y=Ws(j,g.nodeGroups);if(!y&&g.nodeGroups.length>0){const O=g.nodeGroups[0],I=Ts({project:g.project,episode:g.episode,nodeGroup:O,assetType:"image"});I?(be(I),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${I}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const C=Ts({project:g.project,episode:g.episode,nodeGroup:y,assetType:"image"});C?(be(C),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${C}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},a=async()=>{var g,y;if(!de){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ie.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{pe(!0),await Ce.assetLibraries.addFromUrl(de,s.imageUrl,ie.trim());const C=window.__workflowContext;if(C&&C.project&&C.nodeGroups){const O=Ws(j,C.nodeGroups)||C.nodeGroups[0];O&&Ts({project:C.project,episode:C.episode,nodeGroup:O,nodeId:j,assetType:"image",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),Y(!1),be("");try{n(O=>O.map(I=>I.id===j?{...I,data:{...I.data,addedToLibrary:!0}}:I))}catch{}try{const O=new CustomEvent("asset-library-updated",{detail:{libraryId:de}});window.dispatchEvent(O)}catch{}}catch(C){m.error(((y=(g=C.response)==null?void 0:g.data)==null?void 0:y.message)||"æ·»åŠ å¤±è´¥")}finally{pe(!1)}},w=async()=>{var g;try{const y=s.imageUrl;let C=`image-${Date.now()}.jpg`;const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const z=Ws(j,O.nodeGroups)||O.nodeGroups[0];if(z){const D=Ts({project:O.project,episode:O.episode,nodeGroup:z,nodeId:j,assetType:"image",preview:!0});if(D&&(C=D,!C.includes("."))){const X=((g=y.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:g[0])||".jpg";C+=X}}}m.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const I=await fetch(y);if(!I.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${I.status}`);const u=await I.blob(),l=window.URL.createObjectURL(u),i=document.createElement("a");i.href=l,i.download=C,document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>{window.URL.revokeObjectURL(l)},100),m.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${C}`)}catch(y){m.error(`æ“ä½œå¤±è´¥: ${y instanceof Error?y.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const y=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(C=>x(C)&&r(C)):[]).length>0;return e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ie,borderRadius:y?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[K&&e.jsxs("button",{onClick:async()=>{var C,O;try{const I=s.imageUrl,u=s.workflowContext||{},l=u.episode,i=new URLSearchParams(window.location.search),z=Number(i.get("shot"))||1,D=fe.pathname.split("/").filter(Boolean),X=D.indexOf("projects"),W=D.indexOf("episodes"),ne=((C=u.project)==null?void 0:C.id)||(l==null?void 0:l.projectId)||(X>=0?D[X+1]:void 0),xe=(l==null?void 0:l.id)||(W>=0?D[W+1]:void 0);if(!ne||!xe){m.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const oe=await Ce.episodes.getById(ne,xe),N=(oe==null?void 0:oe.data)??oe,h=(N==null?void 0:N.data)??N;let E=Array.isArray((O=h==null?void 0:h.scriptJson)==null?void 0:O.acts)?[...h.scriptJson.acts]:[],k=E.find(he=>he.actIndex===1);k||(k={actIndex:1,shots:[]},E.push(k)),k.shots=Array.isArray(k.shots)?[...k.shots]:[];let J=k.shots.find(he=>Number(he.shotIndex)===z);J||(J={shotIndex:z,mediaList:[]},k.shots.push(J));const ue=Array.isArray(J.mediaList)?J.mediaList.slice():[];ue.push({type:"image",url:I,nodeId:j,duration:5}),J.mediaList=ue;const B={...h.scriptJson||{},acts:E};await Ce.episodes.update(ne,xe,{scriptJson:B});try{n(he=>he.map(Ee=>Ee.id===j?{...Ee,data:{...Ee.data,addedToStoryboard:!0}}:Ee))}catch{}m.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(I){m.error((I==null?void 0:I.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{Y(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:w,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const g=(s.midjourneyData.buttons||[]).filter(y=>x(y)&&r(y));return g.length===0?null:e.jsxs("div",{className:"nodrag bg-white dark:bg-[#18181b] backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ie},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((y,C)=>{var z;const O=_(y.label),I=((z=s.clickedButtons)==null?void 0:z.includes(y.label))||!1,u=te===y.customId,l=s._canEdit===!1,i=te!==null&&te!==y.customId||I||l;return e.jsx("button",{onClick:async()=>{var D,X,W,ne,xe,oe;if(!((D=s.midjourneyData)!=null&&D.taskId)){m.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(I){m.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}Z(y.customId);try{m.info(`æ­£åœ¨æ‰§è¡Œ ${y.label}...`);const N=await Ce.midjourney.action({taskId:s.midjourneyData.taskId,customId:y.customId,messageId:s.midjourneyData.messageId,nodeId:j,mode:s.midjourneyData.mode||"relax"});if(!N.success){m.error(N.description||"æ“ä½œå¤±è´¥"),Z(null);return}const h=N.taskId;if(N.creditsCharged&&N.creditsCharged>0&&T(),!h){m.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),Z(null);return}n(E=>E.map(k=>k.id===j?{...k,data:{...k.data,pendingButtonAction:{buttonLabel:y.label,buttonCustomId:y.customId,newTaskId:h,sourceNodeId:j},clickedButtons:[...k.data.clickedButtons||[],y.label]}}:k)),m.info(`${O} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),L(h,O)}catch(N){if(((X=N.response)==null?void 0:X.status)===429)m.warning(((ne=(W=N.response)==null?void 0:W.data)==null?void 0:ne.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const h=((oe=(xe=N.response)==null?void 0:xe.data)==null?void 0:oe.error)||N.message;m.error(h)}Z(null)}},disabled:i,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${I?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":u?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-wait text-white border-transparent shadow-md":te!==null?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:I?`${O} (å·²ç‚¹å‡»)`:O,children:e.jsxs("span",{className:"flex items-center gap-1",children:[u&&e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),y.emoji&&!/^upscale_\d+$/i.test(y.emoji)&&e.jsx("span",{children:y.emoji}),O,I&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},C)})})]})})(),re&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>Y(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ie,onChange:g=>be(g.target.value),onMouseDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const g=ae==="ALL"?ce:ce.filter(y=>(y.category||"OTHER")===ae);return g.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:ae==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:de,onChange:y=>ee(y.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:g.map(y=>e.jsxs("option",{value:y.id,children:[y.name," (",y._count.assets," ä¸ªèµ„äº§)"]},y.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(g=>e.jsx("button",{type:"button",onClick:()=>{je(g);const y=ce.filter(C=>(C.category||"OTHER")===g);ee(y.length>0?y[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${ae===g?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:g==="ROLE"?"person":g==="SCENE"?"landscape":g==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:g==="ROLE"?"è§’è‰²åº“":g==="SCENE"?"åœºæ™¯åº“":g==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},g))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Y(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:a,disabled:ge||ce.length===0||!ie.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:ge?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},No=t.memo(vo),jo=({data:s,id:j})=>{var F;const n="https://api.waule.ai",[V,me]=t.useState(!1),[T,fe]=t.useState([]),[K,re]=t.useState(""),[Y,ce]=t.useState("ALL"),[Re,de]=t.useState(""),[ee,ae]=t.useState(!1),{setNodes:je}=Qt(),[ie]=t.useState(s.width||400),[be,ge]=t.useState(null),[pe,Ie]=t.useState(!1),te=t.useRef(null),Z=Cr(),U=!!((F=s==null?void 0:s.workflowContext)!=null&&F.episode)||Z.pathname.includes("/episodes/");t.useEffect(()=>{V&&(L(),setTimeout(()=>{f()},100))},[V]),t.useEffect(()=>{const G=te.current;if(!G)return;const v=()=>{const d=G.videoWidth||0,a=G.videoHeight||0;if(d>0&&a>0){const w=d/a;ge(Math.round(ie/w))}},$=()=>Ie(!0),r=()=>Ie(!1),b=()=>Ie(!1);return G.addEventListener("loadedmetadata",v),G.addEventListener("play",$),G.addEventListener("pause",r),G.addEventListener("ended",b),()=>{G.removeEventListener("loadedmetadata",v),G.removeEventListener("play",$),G.removeEventListener("pause",r),G.removeEventListener("ended",b)}},[ie,s.videoUrl]);const R=G=>{G.stopPropagation();const v=te.current;v&&(v.paused?v.play():v.pause())};t.useEffect(()=>{try{const G=localStorage.getItem("suppressedPreviewTasks")||"[]",v=JSON.parse(G),$=s==null?void 0:s.pendingButtonAction;if($&&v.some(b=>b.taskId&&b.taskId===$.newTaskId||b.sourceNodeId&&b.sourceNodeId===$.sourceNodeId)){me(!1);return}}catch{}},[]);const L=async()=>{try{const G=await Ce.assetLibraries.getAll();fe(G.data),G.data.length>0&&re(G.data[0].id)}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},f=()=>{const G=window.__workflowContext;if(!G||!G.project||!G.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const v=Ws(j,G.nodeGroups);if(!v&&G.nodeGroups.length>0){const r=G.nodeGroups[0],b=Ts({project:G.project,episode:G.episode,nodeGroup:r,assetType:"video"});b?(de(b),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${b}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const $=Ts({project:G.project,episode:G.episode,nodeGroup:v,assetType:"video"});$?(de($),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${$}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},x=async()=>{var G,v;if(!K){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Re.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ae(!0),await Ce.assetLibraries.addFromUrl(K,s.videoUrl,Re.trim());const $=window.__workflowContext;if($&&$.project&&$.nodeGroups){const r=Ws(j,$.nodeGroups)||$.nodeGroups[0];r&&Ts({project:$.project,episode:$.episode,nodeGroup:r,nodeId:j,assetType:"video",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),me(!1),de("");try{je(r=>r.map(b=>b.id===j?{...b,data:{...b.data,addedToLibrary:!0}}:b))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:K}});window.dispatchEvent(r)}catch{}}catch($){m.error(((v=(G=$.response)==null?void 0:G.data)==null?void 0:v.message)||"æ·»åŠ å¤±è´¥")}finally{ae(!1)}},_=async()=>{var G;try{const v=s.videoUrl;let $=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const c=Ws(j,r.nodeGroups)||r.nodeGroups[0];if(c){const p=Ts({project:r.project,episode:r.episode,nodeGroup:c,nodeId:j,assetType:"video",preview:!0});if(p&&($=p,!$.includes("."))){const g=((G=v.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:G[0])||".mp4";$+=g}}}m.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");const b=await fetch(v);if(!b.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${b.status}`);const d=await b.blob(),a=window.URL.createObjectURL(d),w=document.createElement("a");w.href=a,w.download=$,document.body.appendChild(w),w.click(),document.body.removeChild(w),setTimeout(()=>{window.URL.revokeObjectURL(a)},100),m.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${$}`)}catch(v){m.error(`æ“ä½œå¤±è´¥: ${v instanceof Error?v.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ie},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",onContextMenu:G=>{G.preventDefault(),G.stopPropagation()},onMouseDown:G=>{if(G.button===2){const v=G.currentTarget;v.style.pointerEvents="none",setTimeout(()=>{v.style.pointerEvents=""},100)}},children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${pe?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:R,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:pe?"pause":"play_arrow"})})}),e.jsx("video",{ref:te,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${n}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:be?`${be}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[U&&e.jsxs("button",{onClick:async()=>{var G,v;try{const $=s.videoUrl,r=s.workflowContext||{},b=r.episode,d=(()=>{try{const X=new URLSearchParams(window.location.search);return{scene:Number(X.get("scene")),shot:Number(X.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),a=r.nodeGroup||Ws(j,r.nodeGroups||[]),w=(a==null?void 0:a.scene)??d.scene,c=(a==null?void 0:a.shot)??d.shot,p=(()=>{try{const X=Z.pathname.split("/").filter(Boolean),W=X.indexOf("projects"),ne=X.indexOf("episodes"),xe=W>=0?X[W+1]:void 0,oe=ne>=0?X[ne+1]:void 0;return{pid:xe,eid:oe}}catch{return{pid:void 0,eid:void 0}}})(),g=((G=r.project)==null?void 0:G.id)||(b==null?void 0:b.projectId)||p.pid,y=(b==null?void 0:b.id)||p.eid;if(!g||!y||!w||!c){m.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const C=await Ce.episodes.getById(g,y),O=(C==null?void 0:C.data)??C,I=(O==null?void 0:O.data)??O,u=Array.isArray((v=I==null?void 0:I.scriptJson)==null?void 0:v.acts)?[...I.scriptJson.acts]:[];let l=u.find(X=>Number(X.actIndex)===Number(w));l||(l={actIndex:Number(w),shots:[]},u.push(l)),l.shots=Array.isArray(l.shots)?[...l.shots]:[];let i=l.shots.find(X=>Number(X.shotIndex)===Number(c));i||(i={shotIndex:Number(c),mediaList:[]},l.shots.push(i));const z=Array.isArray(i.mediaList)?i.mediaList.slice():[];if(z.length>=4){m.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}z.push({type:"video",url:$,nodeId:j}),i.mediaList=z;const D={...I.scriptJson||{},acts:u};await Ce.episodes.update(g,y,{scriptJson:D});try{je(X=>X.map(W=>W.id===j?{...W,data:{...W.data,addedToStoryboard:!0}}:W))}catch{}m.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch($){m.error(($==null?void 0:$.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{me(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:_,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),V&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:G=>G.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>me(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Re,onChange:G=>de(G.target.value),onMouseDown:G=>G.stopPropagation(),onTouchStart:G=>G.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const G=Y==="ALL"?T:T.filter(v=>(v.category||"OTHER")===Y);return G.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Y==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:K,onChange:v=>re(v.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:G.map(v=>e.jsxs("option",{value:v.id,children:[v.name," (",v._count.assets," ä¸ªèµ„äº§)"]},v.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(G=>e.jsx("button",{type:"button",onClick:()=>{ce(G);const v=T.filter($=>($.category||"OTHER")===G);re(v.length>0?v[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Y===G?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:G==="ROLE"?"person":G==="SCENE"?"landscape":G==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:G==="ROLE"?"è§’è‰²åº“":G==="SCENE"?"åœºæ™¯åº“":G==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},G))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>me(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:x,disabled:ee||T.length===0||!Re.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:ee?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`})]})},Io=t.memo(jo),So=({data:s,id:j,selected:n})=>{const{getNodes:V,getEdges:me,setEdges:T,setNodes:fe,getNode:K}=Qt(),[re,Y]=t.useState(s.content||""),ce=t.useRef(null),Re=t.useRef(null),de=t.useRef(null),ee=t.useRef(null);t.useEffect(()=>{const R=_=>{_.stopPropagation()},L=Re.current,f=de.current;L&&L.addEventListener("wheel",R,{passive:!0}),f&&f.addEventListener("wheel",R,{passive:!0});const x=ee.current;return x&&x.addEventListener("wheel",R,{passive:!0}),()=>{L&&L.removeEventListener("wheel",R),f&&f.removeEventListener("wheel",R),x&&x.removeEventListener("wheel",R)}},[]);const ae=t.useRef(null),je=async R=>{var L,f;try{const x=(s==null?void 0:s.workflowContext)||{},_=x.episode,F=x.nodeGroup||Array.isArray(x.nodeGroups)&&x.nodeGroups.find(y=>(y.nodeIds||[]).includes(j))||null;let G=F==null?void 0:F.scene,v=F==null?void 0:F.shot;try{const y=new URLSearchParams(window.location.search),C=Number(y.get("scene")),O=Number(y.get("shot"));Number.isFinite(C)&&C>0&&(G=G??C),Number.isFinite(O)&&O>0&&(v=v??O)}catch{}const $=((L=x.project)==null?void 0:L.id)||(_==null?void 0:_.projectId),r=_==null?void 0:_.id;if(!$||!r||!G||!v)return;const b=await Ce.episodes.getById($,r),d=(b==null?void 0:b.data)??b,a=(d==null?void 0:d.data)??d,w=Array.isArray((f=a==null?void 0:a.scriptJson)==null?void 0:f.acts)?[...a.scriptJson.acts]:[];let c=w.find(y=>Number(y.actIndex)===Number(G));c||(c={actIndex:Number(G),shots:[]},w.push(c)),c.shots=Array.isArray(c.shots)?[...c.shots]:[];let p=c.shots.find(y=>Number(y.shotIndex)===Number(v));p||(p={shotIndex:Number(v)},c.shots.push(p)),Object.keys(R).forEach(y=>{p[y]=R[y]||""});const g={...a.scriptJson||{},acts:w};await Ce.episodes.update($,r,{scriptJson:g})}catch(x){m.error((x==null?void 0:x.message)||"ä¿å­˜å¤±è´¥")}},ie=()=>{var R,L,f;try{const x=V(),_=me(),F=x.find(d=>d.id===j),G=_.filter(d=>d.source===j).map(d=>d.target),v=x.filter(d=>d.type==="agent");let $="";const r=v.find(d=>G.includes(d.id));if(r)$=r.id;else if(F&&v.length>0)$=((L=(R=v.map(a=>{var w,c,p,g;return{a,dx:(((w=a.position)==null?void 0:w.x)??0)-(((c=F.position)==null?void 0:c.x)??0),dy:Math.abs((((p=a.position)==null?void 0:p.y)??0)-(((g=F.position)==null?void 0:g.y)??0))}}).sort((a,w)=>(a.dx>=0&&w.dx>=0,a.dx-w.dx||a.dy-w.dy))[0])==null?void 0:R.a)==null?void 0:L.id)||v[0].id;else{const d=x.findIndex(a=>a.id===j);$=((f=x[d+1])==null?void 0:f.id)||""}if(!$)return;T(d=>d.some(w=>w.source===j&&w.target===$)?d:[...d,{id:`e-${Date.now()}`,source:j,target:$}]);const b=re||String((s==null?void 0:s.content)||"");fe(d=>d.map(a=>{if(a.id!==$)return a;const w=a.data||{};return a.type==="agent"?{...a,data:{...w,config:{...w.config||{},prompt:b}}}:a.type==="midjourney"?{...a,data:{...w,prompt:b}}:a.type==="aiImage"?{...a,data:{...w,config:{...w.config||{},prompt:b}}}:a.type==="textPreview"?{...a,data:{...w,content:b}}:{...a,data:{...w,config:{...w.config||{},prompt:b}}}}))}catch{}},be=(s.title||"")==="åˆ†é•œè®¾è®¡",ge=(s.title||"")==="æç¤ºè¯",pe=(()=>{if(!be)return[];const R=String(s.content||""),L=R.split(/\r?\n/).map(v=>v.trim()),f=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),x=[];let _=null;for(const v of L){if(!v)continue;const $=v.match(/^(.+?)[ï¼š:]\s*(.*)$/);if($&&f.has($[1])){_&&x.push(_),_={label:$[1],content:$[2]||""};continue}if(f.has(v)){_&&x.push(_),_={label:v,content:""};continue}_?_.content=_.content?`${_.content}
${v}`:v:_={label:"æ–‡æœ¬",content:v}}if(_&&x.push(_),x.length===0)return[{label:"æ–‡æœ¬",content:R}];const F=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],G=new Map(F.map((v,$)=>[v,$]));return x.filter(v=>v.content&&v.content.trim().length>0).sort((v,$)=>(G.get(v.label)??999)-(G.get($.label)??999))})(),[Ie,te]=t.useState(pe),Z=t.useRef(null),U=t.useRef([]);return t.useEffect(()=>{te(pe)},[s.content,be]),t.useEffect(()=>{requestAnimationFrame(()=>{U.current.forEach(R=>{R&&(R.style.height="auto",R.style.height=`${R.scrollHeight}px`)})})},[Ie]),t.useEffect(()=>{ge&&Y(s.content||"")},[s.content,ge]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:be?e.jsx("div",{ref:de,className:"space-y-2 nowheel",children:Ie.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ie.map((R,L)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:R.label}),e.jsx("textarea",{value:R.content,onChange:f=>{const x=f.target.value;f.target.style.height="auto",f.target.style.height=`${f.target.scrollHeight}px`,te(_=>{const F=_.map(($,r)=>r===L?{...$,content:x}:$),G=F.map($=>`${$.label}ï¼š${$.content}`).join(`
`);return K(j)&&fe($=>$.map(r=>r.id===j?{...r,data:{...r.data,content:G}}:r)),Z.current&&(clearTimeout(Z.current),Z.current=null),Z.current=window.setTimeout(async()=>{const $=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};F.forEach(b=>{$.has(b.label)&&(r[b.label]=b.content)}),await je(r)},600),F})},onBlur:async f=>{const x=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),_={};_[R.label]=f.currentTarget.value,x.has(R.label)&&await je(_)},onMouseDown:f=>f.stopPropagation(),onTouchStart:f=>f.stopPropagation(),ref:f=>{U.current[L]=f,f&&(f.style.height="auto",f.style.height=`${f.scrollHeight}px`,f.style.overflow="hidden",f.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",placeholder:`å¡«å†™${R.label}...`})]},`sec-${L}`))}):ge?e.jsxs("div",{ref:Re,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:re,onChange:R=>{const L=R.target.value;Y(L);const f=440;R.target.style.height="auto";const x=Math.min(R.target.scrollHeight,f);R.target.style.height=`${x}px`,R.target.style.overflowY=R.target.scrollHeight>f?"auto":"hidden",K(j)&&fe(F=>F.map(G=>G.id===j?{...G,data:{...G.data,content:L}}:G)),ae.current&&(clearTimeout(ae.current),ae.current=null),ae.current=window.setTimeout(async()=>{await je({æç¤ºè¯:L})},600)},onBlur:async R=>{const L=R.currentTarget.value;await je({æç¤ºè¯:L})},onMouseDown:R=>R.stopPropagation(),onTouchStart:R=>R.stopPropagation(),ref:R=>{if(ce.current=R,R){R.style.wordBreak="break-word",R.style.height="auto";const f=Math.min(R.scrollHeight,440);R.style.height=`${f}px`,R.style.overflowY=R.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ie,onPointerDown:R=>R.stopPropagation(),onMouseDown:R=>R.stopPropagation(),disabled:!re.trim(),className:"nodrag relative w-full mt-2 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:ee,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(St,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Eo=t.memo(So),Co=({data:s,selected:j,id:n})=>{const{setNodes:V,setEdges:me,getNode:T,getNodes:fe,getEdges:K,getViewport:re}=Qt(),Y=zs(),ce=Ls(),[Re]=t.useState(s.isExpanded??!0),[de,ee]=t.useState(s.prompt||""),[ae,je]=t.useState(s.ratio||"16:9"),[ie,be]=t.useState(s.mode||"relax"),[ge,pe]=t.useState(s.chaos??0),[Ie,te]=t.useState(s.stylize??100),[Z,U]=t.useState(s.weird??0),[R,L]=t.useState(s.quality??1),[f,x]=t.useState(s.styleRaw??!1),[_,F]=t.useState(s.omniWeight??100),[G,v]=t.useState(s.styleWeight??100),[,$]=t.useState(s.taskId||""),[r,b]=t.useState(s.status||"idle"),[d,a]=t.useState(s.progress||""),[w,c]=t.useState(s.omniReferenceImages||[]),[p,g]=t.useState(s.styleReferenceImages||[]),[y,C]=t.useState(!0);t.useEffect(()=>{(async()=>{var k;try{const J=await Ce.midjourney.getSettings();C(((k=J.settings)==null?void 0:k.fastEnabled)??!0)}catch{}})()},[]);const{credits:O,isFreeUsage:I,freeUsageRemaining:u,refetch:l}=Ss({moduleType:"midjourney",operationType:"imagine",mode:ie}),i=t.useRef(null),z=t.useRef(!1),D=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==de&&ee(s.prompt)},[s.prompt]);const X=E=>{V(k=>k.map(J=>J.id===n?{...J,data:{...J.data,...E}}:J))};t.useEffect(()=>{const E=s.taskId,k=s.status;(async()=>{var ue,B;if(E&&(k==="processing"||k==="submitting"))try{const Ee=(await Ce.midjourney.fetchTask(E)).task;if(Ee.status==="SUCCESS"){const Ne=Ee.imageUrl||"",$e=((ue=Ee.properties)==null?void 0:ue.messageId)||"",Ae=((B=Ee.properties)==null?void 0:B.messageHash)||"",_e=s.ratio||"16:9";if(b("idle"),a(""),X({status:"idle",progress:"",taskId:""}),fe().find(Ve=>{var et,Ft,Mt;return Ve.type==="imagePreview"&&((et=Ve.data.midjourneyData)==null?void 0:et.sourceNodeId)===n&&(((Ft=Ve.data.midjourneyData)==null?void 0:Ft.taskId)===E||$e&&((Mt=Ve.data.midjourneyData)==null?void 0:Mt.messageId)===$e)})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}m.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(Ne,"4å®«æ ¼",_e,{taskId:E,messageId:$e,messageHash:Ae,mode:s.mode||"relax",buttons:Ee.buttons,action:Ee.action})}else Ee.status==="IN_PROGRESS"||Ee.status==="SUBMITTED"?(b("processing"),setTimeout(()=>{D.current(E)},100)):Ee.status==="FAILURE"?(b("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error(Ee.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ee.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Ee.status==="NOT_FOUND"&&(b("idle"),a(""),X({status:"idle",progress:"",taskId:""}))}catch{b("idle"),a(""),X({status:"idle",progress:"",taskId:""}),m.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const W=t.useCallback(()=>{const E=Y.filter(Ne=>Ne.target===n),k=[],J=[];let ue="";E.forEach(Ne=>{var Ae,_e,Te,le,Ve,et,Ft,Mt;const $e=T(Ne.source);if($e){const At=$e.data,ct=Ne.targetHandle||"omni-ref";if(ct==="text-input"){if($e.type==="agent"){const gt=((Ae=At.config)==null?void 0:Ae.generatedText)||"";gt&&typeof gt=="string"&&(ue=gt)}}else{let gt=At.imageUrl||"";if(!gt&&((_e=At.config)!=null&&_e.selectedAsset)){const vt=At.config.selectedAsset;vt.type==="IMAGE"&&(gt=`https://api.waule.ai${vt.url}`.replace(".oss-oss-",".oss-"))}if(!gt&&((Te=At.config)!=null&&Te.generatedImageUrl)&&(gt=At.config.generatedImageUrl),$e.type==="assetSelector"){const vt="https://api.waule.ai",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},Ke=(le=At.config)==null?void 0:le.subjects,yt=(Ve=At.config)==null?void 0:Ve.referenceImages;if(ct==="omni-ref"){let Be="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?Be=it(Ke[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(et=At.config)!=null&&et.selectedAsset&&At.config.selectedAsset.type==="IMAGE"&&(Be=it(At.config.selectedAsset.url)),Be&&!k.includes(Be)&&k.length<1&&k.push(Be)}else if(ct==="style-ref"){let Be="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?Be=it(Ke[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Ft=At.config)!=null&&Ft.selectedAsset&&At.config.selectedAsset.type==="IMAGE"&&(Be=it(At.config.selectedAsset.url)),Be&&!J.includes(Be)&&J.length<1&&J.push(Be)}}if($e.type==="upload"){const vt="https://api.waule.ai",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},yt=(((Mt=At.config)==null?void 0:Mt.uploadedFiles)||[]).find(Be=>Be.type==="IMAGE"||(Be.mimeType||"").startsWith("image/"));if(yt){const Be=it(yt.url);ct==="omni-ref"?Be&&!k.includes(Be)&&k.length<1&&k.push(Be):ct==="style-ref"&&Be&&!J.includes(Be)&&J.length<1&&J.push(Be)}}gt&&(ct==="omni-ref"&&!k.includes(gt)?k.push(gt):ct==="style-ref"&&!J.includes(gt)&&J.push(gt))}}}),ue&&ue!==de&&!z.current&&(ee(ue),X({prompt:ue}));const B=Ne=>{if(!Ne||typeof Ne!="string")return!1;const $e=Ne.trim();return $e?!!($e.startsWith("data:image/")||/^https?:\/\//.test($e)||$e.startsWith("/")):!1},he=k.filter(B).slice(0,1),Ee=J.filter(B).slice(0,1);JSON.stringify(he)!==JSON.stringify(w)&&(c(he),X({omniReferenceImages:he})),JSON.stringify(Ee)!==JSON.stringify(p)&&(g(Ee),X({styleReferenceImages:Ee}))},[Y,n,T,ce,de,z.current]);t.useEffect(()=>{W()},[W]),t.useEffect(()=>{const E=i.current;E&&Re&&requestAnimationFrame(()=>{E.style.height="auto";const k=Math.max(60,Math.min(E.scrollHeight,600));E.style.height=`${k}px`})},[de,Re]);const ne=E=>{try{const k=new URL(E),J=new URLSearchParams(k.search);return J.has("width")||J.has("height")?(J.delete("width"),J.delete("height"),k.search=J.toString(),k.toString()):E}catch{return E}},xe=E=>{const[J,ue]=E.split(":").map(Number);if(!J||!ue)return{width:512,height:512};const B=J/ue;return B>=1?{width:512,height:Math.round(512/B)}:{width:Math.round(512*B),height:512}},oe=t.useCallback((E,k,J,ue)=>{const B=T(n);if(!B)return;const he=k.startsWith("U")?ne(E):E,Ee=fe(),Ne=K();if(Ee.filter(Be=>Be.type==="imagePreview"&&Ne.some(wt=>wt.source===n&&wt.target===Be.id)).find(Be=>Be.data.imageUrl===he))return;const _e=400,Te=200,le=100,Ve=Be=>{const wt=re().zoom||1,Kt=document.querySelector(`.react-flow__node[data-id="${Be.id}"]`),vs=(Kt==null?void 0:Kt.getBoundingClientRect().width)||Be.data&&Be.data.width||400,Is=(Kt==null?void 0:Kt.getBoundingClientRect().height)||Be.data&&Be.data.height||300,Es=Math.round(vs/wt),Ns=Math.round(Is/wt);return{w:Es,h:Ns}},et=(Be,wt=300)=>{if(!Be||!/^[0-9]+\s*:\s*[0-9]+$/.test(Be))return wt;const[Kt,vs]=Be.split(":").map(Is=>parseFloat(Is));return!Kt||!vs?wt:Math.round(_e*(vs/Kt))},Ft=Ve(B),Mt=et(J,300),At=B.position.x+Ft.w+Te,ct=B.position.y,gt=fe().filter(Be=>{var wt,Kt;return Be.type==="imagePreview"&&((Kt=(wt=Be.data)==null?void 0:wt.midjourneyData)==null?void 0:Kt.sourceNodeId)===n}).length,vt=At,it=ct+gt*(Mt+le),Ke=`preview-${Date.now()}`,yt={id:Ke,type:"imagePreview",position:{x:vt,y:it},data:{imageUrl:he,width:_e,ratio:J,workflowContext:B.data.workflowContext,createdBy:B.data.createdBy,midjourneyData:ue?{taskId:ue.taskId,messageId:ue.messageId,messageHash:ue.messageHash,sourceNodeId:n,mode:ue.mode,buttons:ue.buttons,action:ue.action}:void 0}};V(Be=>[...Be,yt]),me(Be=>[...Be,{id:`${n}-${Ke}`,source:n,target:Ke,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),m.success(`âœ¨ å·²åˆ›å»º${k}é¢„è§ˆèŠ‚ç‚¹`)},[n,T,fe,K,V,me,ne,xe]),N=t.useCallback(async()=>{var E,k,J,ue,B,he,Ee,Ne,$e,Ae,_e,Te;if(!de.trim()){m.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}b("submitting"),a(""),X({status:"submitting",progress:""});try{const le=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ve=de.toLowerCase(),et=le.find(it=>Ve.includes(it));if(et){m.error(`æ£€æµ‹åˆ°å‚æ•° "${et}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),b("idle"),X({status:"idle",progress:"",taskId:""});return}b("submitting");let Ft=de;try{m.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const it=await Ce.translation.smartTranslate({text:de});it.success&&(Ft=it.translatedText,it.needsTranslation&&m.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{m.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}m.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let Mt=Ft.trim();if(ae&&ae!=="1:1"&&!Mt.includes("--ar")&&(Mt+=` --ar ${ae}`),!Mt.includes("--v")&&!Mt.includes("--version")&&(Mt+=" --v 7.0"),ie==="fast"&&!Mt.includes("--fast")?Mt+=" --fast":ie==="relax"&&!Mt.includes("--relax")&&(Mt+=" --relax"),ge>0&&(Mt+=` --chaos ${ge}`),Ie!==100&&(Mt+=` --stylize ${Ie}`),Z>0&&(Mt+=` --weird ${Z}`),R!==1&&(Mt+=` --quality ${R}`),f&&(Mt+=" --style raw"),w.length>0){m.info(`æ­£åœ¨ä¸Šä¼  ${w.length} å¼ å‚è€ƒå›¾...`);const it=[];for(let Ke=0;Ke<w.length;Ke++){const yt=w[Ke];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{m.error(`å‚è€ƒå›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),b("idle");return}}Mt+=` --oref ${it.join(" ")}`,_!==100&&(Mt+=` --ow ${_}`),m.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(p.length>0){m.info(`æ­£åœ¨ä¸Šä¼  ${p.length} å¼ é£æ ¼å›¾...`);const it=[];for(let Ke=0;Ke<p.length;Ke++){const yt=p[Ke];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{m.error(`é£æ ¼å›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),b("idle");return}}Mt+=` --sref ${it.join(" ")}`,G!==100&&(Mt+=` --sw ${G}`),m.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const At=await Ce.midjourney.imagine({prompt:Mt,nodeId:n,mode:ie});if(!At.success)throw new Error(At.description||"ä»»åŠ¡æäº¤å¤±è´¥");const ct=At.taskId;$(ct),b("processing"),X({taskId:ct,status:"processing",progress:"",prompt:de,ratio:ae,mode:ie,chaos:ge,stylize:Ie,weird:Z,quality:R,styleRaw:f,omniWeight:_,styleWeight:G});const gt=At.isFreeUsage,vt=At.creditsCharged||0;if(gt)m.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${u} æ¬¡æœºä¼š`),l();else if(vt>0){const{useAuthStore:it}=await ds(async()=>{const{useAuthStore:yt}=await import("./index-Cwo4xSFf.js").then(Be=>Be.f);return{useAuthStore:yt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ke}=it.getState();await Ke(),m.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${vt} ç§¯åˆ†`),l()}else m.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");D.current(ct)}catch(le){if(b("error"),a(""),X({status:"error",progress:"",taskId:""}),((E=le.response)==null?void 0:E.status)===403){const Ft=((J=(k=le.response)==null?void 0:k.data)==null?void 0:J.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";m.error(Ft);return}if(((ue=le.response)==null?void 0:ue.status)===429){m.warning(((he=(B=le.response)==null?void 0:B.data)==null?void 0:he.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ve=((Ne=(Ee=le.response)==null?void 0:Ee.data)==null?void 0:Ne.description)||((Ae=($e=le.response)==null?void 0:$e.data)==null?void 0:Ae.error)||le.message,et=(Te=(_e=le.response)==null?void 0:_e.data)==null?void 0:Te.bannedWord;et?m.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${et}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):m.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ve}ï¼Œè¯·ç¨åé‡è¯•`)}},[de,ae,ie,ge,Ie,Z,R,f,w,_,p,G,X,I,u,l]),h=t.useCallback(async E=>{let k=0;const J=150,ue=2e3,B=async()=>{var he,Ee,Ne,$e;try{const _e=(await Ce.midjourney.fetchTask(E)).task;if(_e.status==="SUCCESS"){const le=_e.imageUrl||"",Ve=((he=_e.properties)==null?void 0:he.messageId)||"",et=((Ee=_e.properties)==null?void 0:Ee.messageHash)||"";if(b("idle"),a(""),X({status:"idle",taskId:"",progress:""}),fe().find(At=>{var ct,gt,vt;return At.type==="imagePreview"&&((ct=At.data.midjourneyData)==null?void 0:ct.sourceNodeId)===n&&(((gt=At.data.midjourneyData)==null?void 0:gt.taskId)===E||Ve&&((vt=At.data.midjourneyData)==null?void 0:vt.messageId)===Ve)})){m.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}m.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(le,"4å®«æ ¼",ae,{taskId:E,messageId:Ve,messageHash:et,mode:ie,buttons:_e.buttons,action:_e.action});return}const Te=_e.progress||"";if(a(Te),(_e.status==="IN_PROGRESS"||_e.status==="SUBMITTED")&&(b("processing"),X({status:"processing",progress:Te})),_e.status==="FAILURE"){b("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error(_e.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${_e.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(_e.status==="NOT_FOUND"){b("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}k++,k<J?setTimeout(B,ue):(b("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Ae){if((Ae.code==="ECONNABORTED"||Ae.code==="ERR_NETWORK"||((Ne=Ae.message)==null?void 0:Ne.includes("aborted"))||(($e=Ae.message)==null?void 0:$e.includes("Network Error")))&&k<J-1){k++,setTimeout(B,ue*2);return}b("error"),a(""),X({status:"error",progress:"",taskId:""}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};B()},[n,ae,oe,X,fe]);return D.current=h,e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Re&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:i,value:de,onChange:E=>{z.current=!0,ee(E.target.value)},onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>be("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ie==="relax"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!y){m.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}be("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${y?ie==="fast"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50":"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:cursor-not-allowed`,title:y?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!y&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(os,{value:ae,onChange:E=>je(E),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:ge})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:ge,onChange:E=>pe(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${ge/2}%, #06b6d4 ${ge}%, var(--range-bg-color) ${ge}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ie})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ie,onChange:E=>te(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Ie/1e3*50}%, #06b6d4 ${Ie/1e3*100}%, var(--range-bg-color) ${Ie/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Z})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:Z,onChange:E=>U(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Z/3e3*50}%, #06b6d4 ${Z/3e3*100}%, var(--range-bg-color) ${Z/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:R})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:R===.25?0:R===.5?1:R===1?2:3,onChange:E=>{const k=Number(E.target.value);L(k===0?.25:k===1?.5:k===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(R===.25?0:R===.5?1:R===1?2:3)/3*50}%, #06b6d4 ${(R===.25?0:R===.5?1:R===1?2:3)/3*100}%, var(--range-bg-color) ${(R===.25?0:R===.5?1:R===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>x(!f),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:cursor-not-allowed ${f?"bg-neutral-800 dark:bg-white text-white dark:text-black border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-neutral-500 dark:border-neutral-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${f?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-neutral-800 dark:bg-white text-white dark:text-black"}`})})]})})]}),w.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Lr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",w.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:w.map((E,k)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Reference ${k+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",k+1]})})]},k))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:_})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:_,onChange:E=>F(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${_/1e3*50}%, #06b6d4 ${_/1e3*100}%, var(--range-bg-color) ${_/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),p.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Lr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",p.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:p.map((E,k)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Style ${k+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",k+1]})})]},k))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:G})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:G,onChange:E=>v(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${G/1e3*50}%, #06b6d4 ${G/1e3*100}%, var(--range-bg-color) ${G/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:N,onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1||!(de!=null&&de.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 relative overflow-hidden ${r==="processing"||r==="submitting"||!(de!=null&&de.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:[r==="processing"&&d&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-neutral-400/30 to-accent-400/30 transition-all duration-300",style:{width:d}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!d||d===""||d==="0%"?ie==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${d}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),I?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(u),"æ¬¡"]}):O!==null&&O>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:[O,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(gs,{type:"target",position:ut.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>{const k=T(E.source||"");return!!k&&k.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(gs,{type:"target",position:ut.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!Y.some(J=>J.target===n&&J.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(gs,{type:"target",position:ut.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!Y.some(J=>J.target===n&&J.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(gs,{type:"source",position:ut.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},yr="https://api.waule.ai",Ao=({data:s,selected:j,id:n})=>{var bs,er,ws,tr,sr,rr,Ps;const[V,me]=t.useState(!0),[,T]=t.useState(0),[fe,K]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[fe]);const{setNodes:re,setEdges:Y,getNode:ce,getNodes:Re,getEdges:de}=Qt(),ee=zs(),ae=Ls(),je=t.useRef(""),ie=(bs=s.config)==null?void 0:bs.selectedEditingCapability,be=t.useMemo(()=>(s.models||[]).filter(se=>{var Me;return se.type==="VIDEO_GENERATION"&&((Me=se.provider)==null?void 0:Me.toLowerCase())==="sora"}),[s.models]),[ge,pe]=t.useState(s.config.prompt||""),Ie=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ge&&pe(s.config.prompt)},[s.config.prompt]);const[te,Z]=t.useState(s.config.modelId||((er=be[0])==null?void 0:er.id)||""),[U,R]=t.useState(s.config.ratio||"16:9"),[L,f]=t.useState(s.config.resolution||"1080P"),x=t.useCallback(q=>{const se=(q||"").toLowerCase();return se?se.includes("æ–‡ç”Ÿ")||se.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":se.includes("é¦–å°¾")?"é¦–å°¾å¸§":se.includes("é¦–å¸§")||se.includes("first frame")||se.includes("start frame")||se.includes("initial frame")||se.includes("keyframe")?"é¦–å¸§":se.includes("å°¾å¸§")||se.includes("last frame")||se.includes("end frame")||se.includes("final frame")?"å°¾å¸§":se.includes("ä¸»ä½“å‚è€ƒ")||se.includes("å‚è€ƒ")||se.includes("reference image")||se.includes("image reference")||se.includes("ref image")?"å‚è€ƒå›¾":se.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":se.includes("first-last")||se.includes("two-frame")||se.includes("frame pair")?"é¦–å°¾å¸§":se.includes("first")?"é¦–å¸§":se.includes("last")?"å°¾å¸§":se.includes("subject")||se.includes("reference")?"å‚è€ƒå›¾":q||"":""},[]),[_,F]=t.useState((s.config.lockedGenerationType?x(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[G,v]=t.useState(s.config.duration||10),[$,r]=t.useState(s.config.isGenerating||!1),[b,d]=t.useState([]),[a,w]=t.useState(null),[c,p]=t.useState(!1),[g]=t.useState(""),[y]=t.useState("confirm"),[C]=t.useState(null),[O,I]=t.useState(!1),[u,l]=t.useState([]),[i,z]=t.useState(""),[D,X]=t.useState(0),[W,ne]=t.useState(0),xe=t.useRef(!1),[oe,N]=t.useState(!1),h=be.find(q=>q.id===te)||be[0],{credits:E,loading:k,isFreeUsage:J,freeUsageRemaining:ue,refetch:B}=Ss({aiModelId:h==null?void 0:h.id,duration:G,resolution:L});t.useEffect(()=>{var q,se;if(!be.find(Me=>Me.id===te)){const Me=((q=be[0])==null?void 0:q.id)||"";Z(Me),et({modelId:Me,modelName:(se=be[0])==null?void 0:se.name})}},[be]);const he=((ws=h==null?void 0:h.provider)==null?void 0:ws.toLowerCase())==="sora",Ee=t.useMemo(()=>{var se;if((se=h==null?void 0:h.config.supportedDurations)!=null&&se.length)return h.config.supportedDurations;const q=((h==null?void 0:h.provider)||"").toLowerCase();return q==="sora"?[10,15]:q==="minimaxi"?[6,10]:[G||10]},[h,G]),Ne=t.useMemo(()=>{var se;return(se=h==null?void 0:h.config.supportedResolutions)!=null&&se.length?h.config.supportedResolutions:((h==null?void 0:h.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[h]),$e=t.useMemo(()=>Math.min(...Ee),[Ee]),Ae=t.useMemo(()=>Math.max(...Ee),[Ee]),_e=t.useMemo(()=>Math.max(1,Ae-$e),[Ae,$e]),Te=t.useMemo(()=>{const q=(G-$e)/_e*100;return Number.isNaN(q)?0:Math.min(100,Math.max(0,q))},[G,$e,_e]),le=!h||!((tr=h.config.supportedDurations)!=null&&tr.length),Ve=!h||!((sr=h.config.supportedResolutions)!=null&&sr.length),et=t.useCallback(q=>{ce(n)&&re(Me=>Me.map(Ge=>Ge.id===n?{...Ge,data:{...Ge.data,config:{...Ge.data.config,...q}}}:Ge))},[ce,n,re]),Ft=(q,se)=>{const Me=(A,P)=>P===0?A:Me(P,A%P),Ge=Me(q,se),qe=q/Ge,Oe=se/Ge,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},bt=`${qe}:${Oe}`;return tt[bt]||bt},Mt=()=>{const q=ee.filter(Oe=>Oe.target===n),se=[];q.forEach(Oe=>{var bt;const tt=ce(Oe.source);if(tt&&tt.type==="upload"&&(((bt=tt.data.config)==null?void 0:bt.uploadedFiles)||[]).forEach(P=>{const we=P.type||P.mimeType||"";(we==="IMAGE"||we.startsWith("image/"))&&se.push({id:P.id||P.name,url:P.url,name:P.name||P.originalName,width:P.width,height:P.height,aspectRatio:P.width&&P.height?Ft(P.width,P.height):"16:9"})}),tt&&tt.type==="assetSelector"){const A=tt.data.config||{},P=A.subjects,we=A.selectedAsset,Ue=x(_);P&&P.length>0?Ue==="é¦–å°¾å¸§"||(P[0].images||[]).forEach((ye,Ze)=>{se.push({id:`${tt.id}-subject-${Ze}`,url:ye,name:P[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):we&&we.type==="IMAGE"&&se.push({id:we.id,url:we.url,name:we.name||we.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const A=tt.data.imageUrl,P=tt.data.width,we=tt.data.height;A&&se.push({id:tt.id,url:A,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:P,height:we,aspectRatio:P&&we?Ft(P,we):"16:9"})}});const Me=new Set,Ge=[];se.forEach(Oe=>{const tt=Oe.url;Me.has(tt)||(Me.add(tt),Ge.push(Oe))});const qe=x(_);return qe==="æ–‡ç”Ÿè§†é¢‘"?he?Ge:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ge.slice(0,1):qe==="é¦–å°¾å¸§"?Ge.slice(0,2):qe==="å‚è€ƒå›¾"?Ge.slice(0,7):Ge},At=t.useMemo(()=>Mt(),[ee,ae,_,n,he]);t.useEffect(()=>{const q=s.config.taskId;(async()=>{if(q){try{const Ge=(await Ce.tasks.getTaskStatus(q)).task;if(Ge.status==="SUCCESS"){r(!1),T(100);const qe=Ge.resultUrl;if(!qe){r(!1),T(0),et({taskId:"",isGenerating:!1}),K(""),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Oe=s.config.ratio||"16:9";et({taskId:"",isGenerating:!1}),K("");const tt=Re(),bt=de();if(tt.filter(we=>we.type==="videoPreview"&&bt.some(Ue=>Ue.source===n&&Ue.target===we.id)).find(we=>we.data.videoUrl===qe)){setTimeout(()=>T(0),1e3);return}m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼");try{const we=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(we).some(ye=>ye.taskId&&ye.taskId===q||ye.sourceNodeId&&ye.sourceNodeId===n)||_t(qe,Oe)}catch{_t(qe,Oe)}setTimeout(()=>T(0),1e3)}else if(Ge.status==="PROCESSING"||Ge.status==="PENDING"){r(!0),T(Ge.progress||0),Zs(q);return}else Ge.status==="FAILURE"&&(r(!1),T(0),et({taskId:"",isGenerating:!1}),K(""),m.error(`ç”Ÿæˆå¤±è´¥: ${Ge.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{r(!1),T(0),et({taskId:"",isGenerating:!1}),K("")}return}try{const Me=await Ce.tasks.getPendingPreviewNodes(n);if(Me.tasks&&Me.tasks.length>0)for(const Ge of Me.tasks){const{previewNodeData:qe}=Ge;if(qe&&qe.url){const Oe=qe.ratio||s.config.ratio||"16:9";let tt=!1;try{const bt=localStorage.getItem("suppressedPreviewTasks")||"[]";tt=JSON.parse(bt).some(P=>P.taskId&&P.taskId===Ge.id||P.sourceNodeId&&P.sourceNodeId===n)}catch{}tt||(_t(qe.url,Oe),m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")),await Ce.tasks.markPreviewNodeCreated(Ge.id)}}}catch{}})()},[]),t.useEffect(()=>{const q=ee.filter(Me=>Me.target===n);let se="";q.forEach(Me=>{var qe;const Ge=ce(Me.source);if(Ge){const Oe=Ge.data;Ge.type==="agent"&&((qe=Oe.config)!=null&&qe.generatedText)?se||(se=Oe.config.generatedText):Ge.type==="textPreview"&&Oe.content&&(se||(se=Oe.content))}}),se&&se!==ge&&(pe(se),et({prompt:se}))},[ee,n,ce,ge,et]),t.useEffect(()=>{const q=ee.filter(Ge=>Ge.target===n);if(q.length===0)return;let se="",Me="";q.forEach(Ge=>{var Oe;const qe=ae.find(tt=>tt.id===Ge.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Oe=tt.config)!=null&&Oe.generatedText&&(se=tt.config.generatedText,Me=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),se&&Me!==je.current&&(je.current=Me,pe(se),et({prompt:se}))},[ae,ee,n,et]),t.useEffect(()=>{const q=JSON.stringify(At),se=JSON.stringify(b);q!==se&&d(At)},[At]);const ct=t.useMemo(()=>{if(he)return!0;const q=b.length,se=x(_);return q===0?!0:q===1?se==="å‚è€ƒå›¾":q===2?se==="é¦–å°¾å¸§"?!1:se==="å‚è€ƒå›¾":q>2?se==="å‚è€ƒå›¾":!1},[b.length,_,x,he]),gt=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),vt=t.useMemo(()=>{const q=x(_);return ie?be:be.filter(se=>{var Ge;const Me=(((Ge=se.config)==null?void 0:Ge.supportedGenerationTypes)||[]).map(qe=>x(qe));return q==="é¦–å¸§"||q==="å°¾å¸§"?Me.includes("é¦–å¸§")||Me.includes("å°¾å¸§"):Me.includes(q)})},[be,_,x,ie]),it=t.useMemo(()=>{const q=ie?be:vt;return q.length>0?q:ie?(s.models||[]).filter(Me=>(Me.type||"")==="VIDEO_EDITING"):q},[ie,be,vt,s.models]);t.useEffect(()=>{var se,Me;if(!it.find(Ge=>Ge.id===te)){const Ge=((se=it[0])==null?void 0:se.id)||"";Z(Ge),et({modelId:Ge||void 0,modelName:Ge?(Me=it[0])==null?void 0:Me.name:void 0})}},[it]);const Ke=t.useCallback(q=>{const se=x(q);return ie?["IMAGE","VIDEO"]:se==="æ–‡ç”Ÿè§†é¢‘"?he?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[x,ie,he]);t.useEffect(()=>{if(!ct&&b.length>0){const q=b[0].aspectRatio;q&&U!==q&&(R(q),setTimeout(()=>{et({ratio:q})},0))}},[ct,b,U]),t.useEffect(()=>{if(!ie&&gt.length>0&&!gt.includes(_)){const q="æ–‡ç”Ÿè§†é¢‘";F(q),setTimeout(()=>{et({generationType:q,acceptedInputs:Ke(q)})},0)}},[gt,_,Ke,ie]),t.useEffect(()=>{const q=x(_);if(q==="æ–‡ç”Ÿè§†é¢‘")return;const se=ee.filter(Oe=>Oe.target===n),Me=[],Ge=[];se.forEach(Oe=>{var A,P,we,Ue,Se;const tt=ce(Oe.source);if(!tt)return;const bt=tt.type;if((bt||"").startsWith("aiVideo")||bt==="videoPreview"){Ge.push(Oe.id);return}if(bt==="upload"){const ye=(we=(P=(A=tt.data)==null?void 0:A.config)==null?void 0:P.uploadedFiles)==null?void 0:we[0],Ze=((ye==null?void 0:ye.type)||"").toUpperCase(),st=((ye==null?void 0:ye.mimeType)||"").toLowerCase();if(Ze==="VIDEO"||st.startsWith("video/")){Ge.push(Oe.id);return}(Ze==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id);return}if(bt==="assetSelector"){const ye=((Ue=tt.data)==null?void 0:Ue.config)||{};if(ye.selectedAsset){const Ze=(ye.selectedAsset.type||"").toUpperCase(),st=(ye.selectedAsset.mimeType||"").toLowerCase();Ze==="VIDEO"||st.startsWith("video/")?Ge.push(Oe.id):(Ze==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id)}else if(ye.subjects&&ye.subjects.length>0){const Ze=(((Se=ye.subjects[0])==null?void 0:Se.images)||[]).length;q==="å‚è€ƒå›¾"||q==="é¦–å°¾å¸§"?Me.push(Oe.id):(q==="é¦–å¸§"||q==="å°¾å¸§")&&(Ze>1?Ge.push(Oe.id):Me.push(Oe.id))}return}(bt==="aiImage"||bt==="imagePreview")&&Me.push(Oe.id)});let qe=new Set([...Ge]);q==="é¦–å¸§"||q==="å°¾å¸§"?Me.slice(1).forEach(Oe=>qe.add(Oe)):q==="é¦–å°¾å¸§"&&Me.slice(2).forEach(Oe=>qe.add(Oe)),qe.size>0&&Y(Oe=>Oe.filter(tt=>!qe.has(tt.id)))},[_,ee,n,ce,Y,x]),t.useEffect(()=>{const q=s.config.generationType;if(!q||x(q)!==x(_)){const se=x(_)||"æ–‡ç”Ÿè§†é¢‘";et({generationType:se,acceptedInputs:Ke(se)})}},[]),t.useEffect(()=>{const q=Ke(_);et({acceptedInputs:q})},[_,Ke]);const yt=q=>{w(q)},Be=q=>{q.preventDefault()},wt=q=>{if(a===null)return;const se=[...b],[Me]=se.splice(a,1);se.splice(q,0,Me),d(se),w(null),et({referenceImages:se})};t.useEffect(()=>{const q=Ie.current;q&&V&&requestAnimationFrame(()=>{q.style.height="auto";const se=Math.max(60,Math.min(q.scrollHeight,600));q.style.height=`${se}px`})},[ge,V]),t.useEffect(()=>{if(ge===s.config.prompt)return;const q=setTimeout(()=>{et({prompt:ge})},500);return()=>clearTimeout(q)},[ge]);const Kt=t.useCallback(async q=>{if(!q){l([]);return}try{const se=await Ce.soraCharacters.search(q,5);l(se.characters||[]),ne(0)}catch{l([])}},[]),vs=t.useCallback(q=>{const se=q.target.value,Me=q.target.selectionStart||0;if(pe(se),xe.current)return;const qe=se.substring(0,Me).match(/@([^@\s#]*)$/);if(qe){const Oe=qe[1];z(Oe),X(Me-Oe.length-1),I(!0),Kt(Oe)}else I(!1),l([])},[Kt]),Is=t.useCallback(q=>{const se=ge.substring(0,D),Me=ge.substring(D+i.length+1),Ge=`@#${q.customName}#`,qe=se+Ge+Me;pe(qe),I(!1),l([]),z(""),setTimeout(()=>{if(Ie.current){Ie.current.focus();const Oe=se.length+Ge.length;Ie.current.setSelectionRange(Oe,Oe)}},0)},[ge,D,i]),Es=t.useCallback(q=>{!O||u.length===0||(q.key==="ArrowDown"?(q.preventDefault(),ne(se=>se<u.length-1?se+1:se)):q.key==="ArrowUp"?(q.preventDefault(),ne(se=>se>0?se-1:se)):q.key==="Enter"&&u[W]?(q.preventDefault(),Is(u[W])):q.key==="Escape"&&I(!1))},[O,u,W,Is]),Ns=t.useCallback(async q=>{var qe;const se=/@#([^#]+)#/g,Me=[...q.matchAll(se)];if(Me.length===0)return q;let Ge=q;for(const Oe of Me){const tt=Oe[1];try{const bt=await Ce.soraCharacters.getByCustomName(tt);(qe=bt.character)!=null&&qe.characterName&&(Ge=Ge.replace(Oe[0],` ${bt.character.characterName} `))}catch{}}return Ge},[]),Bs=q=>{var Me,Ge,qe,Oe;Z(q);const se=vt.find(tt=>tt.id===q);if(se){const tt=(Me=se.config.supportedRatios)!=null&&Me.length?se.config.supportedRatios:["16:9"],bt=(Ge=se.config.supportedResolutions)!=null&&Ge.length?se.config.supportedResolutions:["1080P"],A=(qe=se.config.supportedGenerationTypes)!=null&&qe.length?se.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],P=(se.provider||"").toLowerCase(),we=(Oe=se.config.supportedDurations)!=null&&Oe.length?se.config.supportedDurations:P==="sora"?[10,15]:P==="minimaxi"?[6,10]:[10],Ue=tt[0],Se=bt[0],ye=x(_||A[0]),Ze=we[0];R(Ue),f(Se),F(ye),v(Ze),et({modelId:q,modelName:se.name,ratio:Ue,resolution:Se,generationType:ye,duration:Ze,acceptedInputs:Ke(ye)})}},fs=t.useMemo(()=>{const q=x(_),se=b.length,qe=ee.filter(Oe=>Oe.target===n).filter(Oe=>{var A,P,we,Ue,Se;const tt=ce(Oe.source),bt=tt==null?void 0:tt.type;if(!tt)return!1;if(bt==="upload"){const ye=(we=(P=(A=tt.data)==null?void 0:A.config)==null?void 0:P.uploadedFiles)==null?void 0:we[0],Ze=((ye==null?void 0:ye.mimeType)||"").toLowerCase();return((ye==null?void 0:ye.type)||"").toUpperCase()==="VIDEO"||Ze.startsWith("video/")}if(bt==="assetSelector"){const ye=(Se=(Ue=tt.data)==null?void 0:Ue.config)==null?void 0:Se.selectedAsset,Ze=((ye==null?void 0:ye.mimeType)||"").toLowerCase();return((ye==null?void 0:ye.type)||"").toUpperCase()==="VIDEO"||Ze.startsWith("video/")}return!!((bt||"").startsWith("aiVideo")||bt==="videoPreview")}).length;return te?q==="æ–‡ç”Ÿè§†é¢‘"?he?!0:!!ge.trim():q==="é¦–å¸§"||q==="å°¾å¸§"?se>=1:q==="é¦–å°¾å¸§"?se>=2:q==="å‚è€ƒå›¾"?se>=1:q==="è§†é¢‘æ¢äºº"?qe>=1&&se>=1:q==="å¯¹å£å‹"||q==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[_,b.length,ge,$,ee,n,ce,x,he]);t.useEffect(()=>{var se;const q=(se=s==null?void 0:s.config)==null?void 0:se.generatedVideoUrl;q&&_t(q,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const Zs=async q=>{let Me=0;const Ge=async()=>{try{Me++;const Oe=(await Ce.tasks.getTaskStatus(q)).task;if(T(Oe.progress||0),Oe.status==="SUCCESS"||Oe.status==="COMPLETED"||Oe.status==="DONE"){T(100);const tt=Oe.resultUrl;r(!1),_t(tt,s.config.ratio||"16:9");try{await Ce.tasks.markPreviewNodeCreated(q)}catch{}et({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),K(""),m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>T(0),1e3);return}else if(Oe.status==="FAILURE"){r(!1),T(0),et({taskId:"",isGenerating:!1}),m.error(Oe.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Oe.status==="PROCESSING"||Oe.status==="PENDING")&&(Me<600?setTimeout(Ge,1e3):(r(!1),T(0),et({taskId:"",isGenerating:!1}),m.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),T(0),et({taskId:"",isGenerating:!1}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ge()},Hs=async()=>{var Me,Ge,qe,Oe,tt,bt;if(x(_)==="æ–‡ç”Ÿè§†é¢‘"&&!ge.trim()){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const se=Mt();et({referenceImages:se}),T(0);try{let A=[],P;const we=se.length;if(se.length>0)try{for(const zt of se){let Ct=zt.url;!Ct.startsWith("data:")&&!Ct.startsWith("http")&&(Ct=`${yr}${Ct}`),Ct=Ct.replace(/^https?:\/\/localhost(?::\d+)?/i,yr);const Tt=await ur(Ct);A.push(Tt)}}catch{m.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Ue=ee.filter(zt=>zt.target===n);if(x(_)==="å‚è€ƒå›¾"){const zt=new Map;for(const Ct of Ue){const Tt=ce(Ct.source);if((Tt==null?void 0:Tt.type)==="assetSelector"){const Gt=(Me=Tt.data.config)==null?void 0:Me.subjects;if(Gt&&Gt.length>0){for(const Wt of Gt)if(!zt.has(Wt.name)){const ts=(Wt.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${yr}${rs}`);zt.set(Wt.name,ts)}}}}if(zt.size>0){const Ct=Array.from(zt.entries());let Tt=0;const Gt=[];for(const[Wt,ts]of Ct){if(Tt>=7)break;const rs=7-Tt,ys=ts.slice(0,Math.max(0,rs));ys.length>0&&(Gt.push({name:Wt,images:ys}),Tt+=ys.length)}P=Gt,Ct.some(([,Wt])=>Wt.length>0)&&Tt<Ct.reduce((Wt,[,ts])=>Wt+ts.length,0)&&m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const Se=P&&P.length>0?P.reduce((zt,Ct)=>{var Tt;return zt+(((Tt=Ct.images)==null?void 0:Tt.length)||0)},0):we;let ye=_;if(ye==="é¦–å¸§"||ye==="å°¾å¸§"){if(Se!==1){m.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),T(0);return}}else if(ye==="é¦–å°¾å¸§"){if(Se===1)ye="é¦–å¸§";else if(Se!==2){m.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),T(0);return}P&&P.length>0?P=[{...P[0],images:P[0].images.slice(0,2)}]:A=A.slice(0,2)}else if(ye==="å‚è€ƒå›¾"||ye==="ä¸»ä½“å‚è€ƒ"){if(Se<1){m.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),T(0);return}if(P&&P.length>0){if(P.reduce((Ct,Tt)=>{var Gt;return Ct+(((Gt=Tt.images)==null?void 0:Gt.length)||0)},0)>7){let Ct=7;P=P.map(Tt=>({...Tt,images:Tt.images.slice(0,Math.max(0,Ct-=Tt.images.length,Tt.images.length))})),Ct=7,P=P.map(Tt=>{const Gt=Tt.images.slice(0,Math.min(Tt.images.length,Ct));return Ct-=Gt.length,{...Tt,images:Gt}}).filter(Tt=>Tt.images.length>0),m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else A.length>7&&(A=A.slice(0,7),m.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}C==="dropImages"&&(A=[],P=void 0),(x(_)==="é¦–å¸§"||x(_)==="å°¾å¸§")&&C==="useFirstImage"&&A.length>=2&&(A=[A[0]]),x(_)==="é¦–å°¾å¸§"&&C==="useFirstTwoImages"&&A.length>=3&&(A=A.slice(0,2));const Ze={modelId:te,ratio:U,duration:G,referenceImages:A.length>0&&!P?A:void 0,generationType:ye,sourceNodeId:n,...P?{subjects:P}:{}},st=x(ye);let kt=ge.trim();if(kt&&kt.includes("@#")&&(kt=await Ns(kt)),!oe&&kt&&(kt="No BGM. "+kt),st==="æ–‡ç”Ÿè§†é¢‘"){if(!kt){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),T(0);return}Ze.prompt=kt}else if(st==="å‚è€ƒå›¾"){if(!kt){m.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),T(0);return}Ze.prompt=kt}else kt&&(Ze.prompt=kt);const ht=await Ce.tasks.createVideoTask(Ze),We=ht.taskId,Dt=ht.creditsCharged||0,Xt=ht.isFreeUsage,Pt=ht.freeUsageRemaining??0;if(K(We),et({prompt:ge,ratio:U,resolution:L,generationType:_,duration:G,modelId:te,taskId:We,isGenerating:!0}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),Xt)m.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Pt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),B();else if(Dt>0){const{useAuthStore:zt}=await ds(async()=>{const{useAuthStore:Tt}=await import("./index-Cwo4xSFf.js").then(Gt=>Gt.f);return{useAuthStore:Tt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ct}=zt.getState();await Ct(),m.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Dt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),B()}else m.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Zs(We)}catch(A){if(r(!1),T(0),((Ge=A.response)==null?void 0:Ge.status)===403){const P=((Oe=(qe=A.response)==null?void 0:qe.data)==null?void 0:Oe.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";m.error(P)}else{const P=((bt=(tt=A.response)==null?void 0:tt.data)==null?void 0:bt.error)||A.message||"æœªçŸ¥åŸå› ";m.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${P}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const q=x(_),se=Mt(),Me=se.length;if((()=>{var Oe;const qe=ee.filter(tt=>tt.target===n);for(const tt of qe){const bt=ce(tt.source);if((bt==null?void 0:bt.type)==="assetSelector"){const A=(Oe=bt.data.config)==null?void 0:Oe.subjects;if(A&&A.length>0)return!0}}return!1})()&&(q==="é¦–å¸§"||q==="å°¾å¸§"||q==="é¦–å°¾å¸§")){m.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&Me===0){m.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(q==="é¦–å°¾å¸§"&&Me===0){m.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(q==="å‚è€ƒå›¾"&&Me===0){m.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&Me>0&&!he&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&Me>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="é¦–å°¾å¸§"&&Me>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&!ge.trim()){m.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!te){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}d(se),et({referenceImages:se}),r(!0),T(0),await Hs()},_t=(q,se)=>{const Me=ce(n);if(!Me||!q)return null;const Ge=se||U||"16:9",qe=Re(),Oe=de(),tt=qe.filter(Gt=>Gt.type==="videoPreview"&&Oe.some(Wt=>Wt.source===n&&Wt.target===Gt.id)),bt=tt.find(Gt=>Gt.data.videoUrl===q);if(bt)return bt.id;const A=1,P=400,we=(Gt,Wt=300)=>{if(!Gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Gt))return Wt;const[ts,rs]=Gt.split(":").map(ys=>parseFloat(ys));return!ts||!rs?Wt:Math.round(P*(rs/ts))},Ue=document.querySelector(`.react-flow__node[data-id="${n}"]`),Se=Ue==null?void 0:Ue.getBoundingClientRect(),ye=Math.round(((Se==null?void 0:Se.width)||400)/A),Ze=100,st=200,kt=we(Ge,300),ht=tt.length,We=Me.position.x+ye+st,Dt=Me.position.y,Xt=We,Pt=Dt+ht*(kt+Ze),zt=Date.now(),Ct={id:`preview-${n}-${zt}`,type:"videoPreview",position:{x:Xt,y:Pt},data:{videoUrl:q,width:P,ratio:Ge,workflowContext:Me.data.workflowContext,createdBy:Me.data.createdBy}};re(Gt=>[...Gt,Ct]);const Tt={id:`edge-${n}-${Ct.id}`,source:n,target:Ct.id,targetHandle:`${Ct.id}-target`,type:"aurora"};return Y(Gt=>Gt.find(ts=>ts.source===n&&ts.target===Ct.id)?Gt:[...Gt,Tt]),Ct.id},Xs=q=>{const se=q.target;if(se.tagName==="INPUT"||se.tagName==="TEXTAREA"||se.tagName==="SELECT"||se.tagName==="BUTTON"||se.closest("button")||se.closest("input")||se.closest("textarea")||se.closest("select"))return;const Me=!V;me(Me),re(Ge=>Ge.map(qe=>qe.id===n?{...qe,data:{...qe.data,isExpanded:Me}}:qe))};return e.jsxs("div",{onDoubleClick:Xs,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var P;const q=((P=ce(n))==null?void 0:P.type)||"",se=x(_),Me=se==="æ–‡ç”Ÿè§†é¢‘"||q==="aiVideo_t2v",Ge=q==="aiVideo_i2v_first"||q==="aiVideo_i2v_last"||se==="é¦–å¸§"||se==="å°¾å¸§",qe=q==="aiVideo_first_last"||se==="é¦–å°¾å¸§",Oe=q==="aiVideo_reference"||se==="å‚è€ƒå›¾",tt=ee.filter(we=>we.target===n),bt=tt.some(we=>{const Ue=ce(we.source);return(Ue==null?void 0:Ue.type)==="agent"}),A=tt.reduce((we,Ue)=>{var Ze,st,kt,ht;const Se=ce(Ue.source),ye=(Se==null?void 0:Se.type)||"";if(ye==="aiImage"||ye==="imagePreview")return we+1;if(ye==="upload"){const We=(kt=(st=(Ze=Se==null?void 0:Se.data)==null?void 0:Ze.config)==null?void 0:st.uploadedFiles)==null?void 0:kt[0],Dt=((We==null?void 0:We.type)||"").toUpperCase(),Xt=((We==null?void 0:We.mimeType)||"").toLowerCase();return we+(Dt==="IMAGE"||Xt.startsWith("image/")?1:0)}if(ye==="assetSelector"){const We=((ht=Se==null?void 0:Se.data)==null?void 0:ht.config)||{};if(We.selectedAsset)return we+((We.selectedAsset.type||"").toUpperCase()==="IMAGE"||(We.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(We.subjects&&We.subjects.length>0)return we+((We.subjects[0].images||[]).length||0)}return we},0);return Me?he||!bt:Ge?!(bt&&A>=1):qe?!(bt&&A>=2):Oe?!(bt&&A>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:g}),y==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{p(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{p(!1),m.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{p(!1),await Hs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:V?e.jsxs("div",{className:"space-y-3",children:[!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:te,onChange:q=>Bs(q),options:vt.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:vt.map(q=>({value:q.id,label:q.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-neutral-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ie,value:ge,onChange:vs,onKeyDown:Es,onCompositionStart:()=>{xe.current=!0},onCompositionEnd:q=>{xe.current=!1,vs(q)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),O&&u.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:u.map((q,se)=>e.jsxs("button",{type:"button",onMouseDown:Me=>{Me.preventDefault(),Me.stopPropagation(),Is(q)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${se===W?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[q.avatarUrl?e.jsx("img",{src:q.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:q.customName}),e.jsx("div",{className:"text-[10px] text-neutral-500 dark:text-neutral-400 font-mono truncate",children:q.characterName})]})]},q.id))})]})]}),b.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",_==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:b.map((q,se)=>e.jsxs("div",{draggable:_==="é¦–å°¾å¸§",onDragStart:()=>yt(se),onDragOver:Be,onDrop:()=>wt(se),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${_==="é¦–å°¾å¸§"?"cursor-move":""} ${a===se?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50`,children:[e.jsx("img",{src:`${q.url.startsWith("http")||q.url.startsWith("data:")?q.url:yr+q.url}`,alt:q.name,className:"w-full h-full object-cover"}),_==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:se===0?"é¦–":se===1?"å°¾":se+1})]},q.id))})]}),h&&!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",le?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[G,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:$e,max:Ae,step:"1",value:G,onChange:q=>{const se=parseInt(q.target.value,10);v(se),et({duration:se})},disabled:le,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-neutral-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-neutral-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #525252 ${Te}%, #3b0764 ${Te}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),h&&ct&&(he||(((Ps=h==null?void 0:h.config.supportedRatios)==null?void 0:Ps.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),he?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q="landscape",se=G===15?15:10,Me=`sora-video-${q}-${se}s`,Ge=be.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||be[0],qe=(Ge==null?void 0:Ge.id)||"";Z(qe),R("16:9"),et({modelId:qe,ratio:"16:9",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Landscape ${se}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${U==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const q="portrait",se=G===15?15:10,Me=`sora-video-${q}-${se}s`,Ge=be.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||be[0],qe=(Ge==null?void 0:Ge.id)||"";Z(qe),R("9:16"),et({modelId:qe,ratio:"9:16",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Portrait ${se}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${U==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:U,onChange:q=>{R(q),et({ratio:q})},options:((h==null?void 0:h.config.supportedRatios)||[]).map(q=>{const[se,Me]=q.split(":");return{value:q,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[q]||`${se}:${Me}`}})})]}),h&&he&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q=U==="9:16"?"portrait":"landscape",se=`sora-video-${q}-10s`,Me=be.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===se})||be[0],Ge=(Me==null?void 0:Me.id)||"";v(10),Z(Ge),et({duration:10,modelId:Ge,modelName:(Me==null?void 0:Me.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${G===10?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const q=U==="9:16"?"portrait":"landscape",se=`sora-video-${q}-15s`,Me=be.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===se})||be[0],Ge=(Me==null?void 0:Me.id)||"";v(15),Z(Ge),et({duration:15,modelId:Ge,modelName:(Me==null?void 0:Me.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${G===15?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),h&&he&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>N(!oe),className:`nodrag relative w-10 h-5 rounded-full transition-all ${oe?"bg-gradient-to-r from-neutral-800 to-neutral-700":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${oe?"left-5":"left-0.5"}`})})]}),h&&!he&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ve?"(æœªé…ç½®)":""]}),e.jsx(os,{value:L,onChange:q=>{f(q),et({resolution:q})},options:Ne.map(q=>({value:q,label:q})),className:Ve?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:$||!fs||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${$||!fs?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:$?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!k&&(J?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ue),"æ¬¡"]}):E!==null&&E>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[E,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:ge?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:ge})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},_o=t.memo(Ao),Wr="https://api.waule.ai",To=({data:s,selected:j,id:n})=>{var v,$;const[V,me]=t.useState(!0),[T,fe]=t.useState(s.config.customName||""),[K,re]=t.useState(!1),[Y,ce]=t.useState(0),[Re,de]=t.useState(s.config.taskId||""),[ee,ae]=t.useState(null),{credits:je,loading:ie}=Ss({nodeType:"sora_character"}),{setNodes:be,getNode:ge,setEdges:pe}=Qt(),Ie=zs(),te=Ls(),Z=t.useCallback(r=>{var a;if(!r)return!1;const b=r.type||"",d=((a=r.data)==null?void 0:a.config)||{};if(b==="upload")return(d.uploadedFiles||d.files||[]).some(c=>(c.mimeType||c.type||"").toLowerCase().startsWith("video/"));if(b==="videoPreview")return!!d.url;if(b==="assetSelector"){const w=d.selectedAsset;return((w==null?void 0:w.mimeType)||"").toLowerCase().startsWith("video/")&&!!(w!=null&&w.url)}return b.startsWith("aiVideo")||b==="soraVideo"?!!d.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=Ie.filter(a=>a.target===n);if(r.length===0)return;const b=[],d=[];for(const a of r){const w=te.find(c=>c.id===a.source)||ge(a.source);Z(w)?b.push(a.id):d.push(a.id)}b.length>1&&(d.push(...b.slice(1)),m.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),d.length>0&&(pe(a=>a.filter(w=>!d.includes(w.id))),d.length>0&&b.length<=1&&r.some(w=>{const c=te.find(p=>p.id===w.source)||ge(w.source);return!Z(c)})&&m.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ie,n,te,ge,pe,Z]);const U=t.useMemo(()=>Ie.filter(b=>b.target===n).map(b=>{var a;const d=te.find(w=>w.id===b.source);return(a=d==null?void 0:d.data)==null?void 0:a.config}),[Ie,n,te]),R=t.useMemo(()=>(s.models||[]).filter(b=>{var d;return b.type==="VIDEO_GENERATION"&&((d=b.provider)==null?void 0:d.toLowerCase())==="sora"}),[s.models]),L=((v=R.find(r=>{var b;return(b=r.modelId)==null?void 0:b.includes("landscape-10s")}))==null?void 0:v.id)||(($=R[0])==null?void 0:$.id)||"",f=t.useCallback(r=>{be(b=>b.map(d=>d.id===n?{...d,data:{...d.data,config:{...d.data.config,...r}}}:d))},[n,be]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!K&&(ae({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),fe(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,K]);const x=t.useMemo(()=>{var b;const r=Ie.filter(d=>d.target===n);for(const d of r){const a=te.find(p=>p.id===d.source)||ge(d.source);if(!a)continue;const w=a.type||"",c=((b=a.data)==null?void 0:b.config)||{};if(w==="upload"){const g=(c.uploadedFiles||c.files||[]).find(y=>(y.mimeType||y.type||"").toLowerCase().startsWith("video/"));if(g!=null&&g.url)return{url:g.url,thumbnail:g.thumbnail||g.url,name:g.name||g.originalName||"è§†é¢‘"}}if(w==="videoPreview"&&c.url)return{url:c.url,thumbnail:c.thumbnail||c.url,name:c.name||"è§†é¢‘"};if(w==="assetSelector"){const p=c.selectedAsset;if(((p==null?void 0:p.mimeType)||"").toLowerCase().startsWith("video/")&&(p!=null&&p.url))return{url:p.url,thumbnail:p.thumbnail||p.url,name:p.name||"è§†é¢‘"}}if((w.startsWith("aiVideo")||w==="soraVideo")&&c.generatedVideoUrl)return{url:c.generatedVideoUrl,thumbnail:c.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ie,n,te,U,ge]),_=!!x,F=async r=>{let d=0;const a=async()=>{try{d++;const c=(await Ce.tasks.getTaskStatus(r)).task;if(ce(c.progress||0),c.status==="SUCCESS"||c.status==="COMPLETED"||c.status==="DONE"){re(!1),ce(100);const p=c.metadata||{},g=p.characterName||"",y=p.avatarUrl||c.resultUrl||"";if(!g){m.error("æœªèƒ½è·å–è§’è‰²åç§°"),f({taskId:""}),de("");return}try{const O=(await Ce.soraCharacters.create({customName:T||g,characterName:g,avatarUrl:y,sourceVideoUrl:(x==null?void 0:x.url)||void 0})).character;ae({id:O.id,customName:O.customName,characterName:O.characterName,avatarUrl:O.avatarUrl}),f({customName:O.customName,characterName:O.characterName,avatarUrl:O.avatarUrl,taskId:""}),m.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${O.customName}`)}catch(C){ae({id:"",customName:T||g,characterName:g,avatarUrl:y}),m.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${C.message}`)}de(""),setTimeout(()=>ce(0),1e3);return}else if(c.status==="FAILURE"){re(!1),ce(0),f({taskId:""}),m.error(c.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(c.status==="PROCESSING"||c.status==="PENDING")&&(d<600?setTimeout(a,1e3):(re(!1),ce(0),f({taskId:""}),m.error("åˆ›å»ºè¶…æ—¶")))}catch{re(!1),ce(0),f({taskId:""}),m.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};a()},G=async()=>{var b,d,a,w,c;if(!x){m.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!T.trim()){m.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!L){m.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=x.url;if(!r){m.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const p=await Ce.soraCharacters.getByCustomName(T.trim());if(p!=null&&p.character){m.error(`è‡ªå®šä¹‰åç§°"${T.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}re(!0),ce(5),ae(null);try{const p=await Ce.tasks.createVideoTask({modelId:L,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:n,metadata:{isCharacterCreation:!0,customName:T.trim(),referenceType:"video",nodeType:"sora_character"}}),g=p.taskId,y=p.creditsCharged||0;if(de(g),f({customName:T.trim(),taskId:g}),y>0)try{const{useAuthStore:C}=await ds(async()=>{const{useAuthStore:I}=await import("./index-Cwo4xSFf.js").then(u=>u.f);return{useAuthStore:I}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:O}=C.getState();await O(),m.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${y} ç§¯åˆ†ï¼‰`)}catch{m.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else m.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");F(g)}catch(p){if(re(!1),ce(0),((b=p.response)==null?void 0:b.status)===403){const g=((a=(d=p.response)==null?void 0:d.data)==null?void 0:a.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";m.error(g)}else m.error(`æäº¤å¤±è´¥: ${((c=(w=p.response)==null?void 0:w.data)==null?void 0:c.error)||p.message}`)}};return t.useEffect(()=>{Re&&!K&&(re(!0),F(Re))},[]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl rounded-t-2xl",onClick:()=>me(!V),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${V?"rotate-180":""}`,children:"expand_more"})]})]}),V&&e.jsxs("div",{className:"p-4 space-y-3",children:[x&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${x.url.startsWith("http")||x.url.startsWith("data:")?x.url:Wr+x.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:x.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:T,onChange:r=>fe(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",disabled:K})]}),ee&&!K&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[ee.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("img",{src:ee.avatarUrl.startsWith("http")?ee.avatarUrl:`${Wr}${ee.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:ee.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:ee.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),K&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[Y,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all duration-300",style:{width:`${Y}%`}})})]}),e.jsx("button",{onClick:G,disabled:K||!_||!T.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${K||!_||!T.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95"}`,children:K?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ie&&je!==null&&je>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[je,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},Uo=t.memo(To),Ro=({data:s,id:j,selected:n})=>{const{setNodes:V,getNode:me}=Qt(),[T,fe]=t.useState(s.config.modelId||""),[K,re]=t.useState(s.config.voiceId||""),[Y,ce]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Re,de]=t.useState(s.config.status||""),[ee,ae]=t.useState(!1),[je,ie]=t.useState([]),[be]=t.useState(void 0),[ge]=t.useState("mp3"),[pe]=t.useState(void 0),[Ie]=t.useState(void 0),[te]=t.useState(void 0),[Z]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!T&&fe(s.config.modelId)},[s.config.modelId,T]),t.useEffect(()=>{!K&&s.config.voiceId&&re(String(s.config.voiceId))},[s.config.voiceId,K]),t.useEffect(()=>{if(!T){const x=(s.models||[]).filter(_=>_.type==="AUDIO_SYNTHESIS"&&_.isActive)[0];x&&(fe(x.id),R({modelId:x.id}))}},[s.models,T]),t.useEffect(()=>{U()},[]);const U=async()=>{try{const f=await Ce.get("/ai/audio/voices"),x=(f==null?void 0:f.data)??f;ie(Array.isArray(x)?x:[])}catch{}},R=f=>{me(j)&&V(_=>_.map(F=>F.id===j?{...F,data:{...F.data,config:{...F.data.config,...f}}}:F))},L=async()=>{var F,G,v,$;const f=(K||s.config.voiceId||"").trim(),x=(Y||"").trim();if(!f||!x){m.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let _=T;if(!_){const r=(s.models||[]).filter(b=>b.type==="AUDIO_SYNTHESIS"&&b.isActive);if(r[0])_=r[0].id,fe(_),R({modelId:_});else{m.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}ae(!0);try{if(Re!=="OK"){let a=0,w=!1;for(;a<12;){a++;try{const c=await Ce.ai.audio.queryVoice({voiceId:f,modelId:_}),p=((F=c.data)==null?void 0:F.status)||c.status;if(de(p),R({status:p}),p==="OK"){w=!0;break}if(p==="UNDEPLOYED")break}catch{}await new Promise(c=>setTimeout(c,2500))}if(!w){m.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),ae(!1);return}}const r=await Ce.ai.audio.synthesize({modelId:_,voiceId:f,text:x,format:ge,sampleRate:be,volume:Ie,rate:pe,pitch:te,output_format:Z}),b=((G=r.data)==null?void 0:G.url)||r.url;try{const d=b&&b.startsWith("http")?b:`https://api.waule.ai${b}`;let a;d?a=await Ce.assets.proxyDownload(d):a=await(await fetch(b,{mode:"cors"})).arrayBuffer();const w=URL.createObjectURL(new Blob([a],{type:ge==="wav"?"audio/wav":"audio/mpeg"}));R({outputUrl:w})}catch{R({outputUrl:b})}m.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const b=(($=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:$.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(b)?m.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(b)?m.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):m.error(b)}ae(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:T,onChange:f=>{fe(f),R({modelId:f})},options:(s.models||[]).filter(f=>f.type==="AUDIO_SYNTHESIS"&&f.isActive).map(f=>({value:f.id,label:f.name}))})]}),je.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",je.length,")"]}),e.jsx(os,{value:K||"",onChange:f=>{re(f),R({voiceId:f})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...je.map(f=>({value:f.voiceId,label:f.prefix||f.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:K,onChange:f=>{const x=f.target.value;re(x),R({voiceId:x})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:Y,onChange:f=>{ce(f.target.value),R({text:f.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:L,disabled:ee||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ee?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ee?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},$o=t.memo(Ro),Mo=({data:s,id:j,selected:n})=>{const{setNodes:V,setEdges:me,getNode:T}=Qt(),[fe,K]=t.useState(s.config.modelId||""),[re,Y]=t.useState(s.config.voiceId||""),[ce,Re]=t.useState(s.config.voiceName||""),[de,ee]=t.useState(s.config.cloneAudioUrl||""),[ae,je]=t.useState(s.config.promptAudioUrl||""),[ie,be]=t.useState(s.config.promptText||""),[ge,pe]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ie,te]=t.useState(!1);t.useEffect(()=>{const _=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!re||!re.startsWith("Waule")&&!re.startsWith("Aivider")||re.startsWith("minimax-")){const F=_();Y(F),L({voiceId:F})}},[re]);const Z=Fs(_=>_.edges.filter(F=>F.target===j)),U=Ls(),R=t.useRef("");t.useEffect(()=>{if(!fe){const F=(s.models||[]).filter(G=>{if(G.type!=="AUDIO_SYNTHESIS"||!G.isActive)return!1;const v=String(G.provider||"").toLowerCase();return v.includes("minimaxi")||v.includes("hailuo")||v.includes("æµ·èº")})[0];F&&(K(F.id),L({modelId:F.id}))}},[s.models,fe]),t.useEffect(()=>{try{const _=Z.map(v=>`${v.id}-${v.source}-${v.targetHandle||""}`).sort().join(",");if(_===R.current)return;R.current=_;let F="",G="";for(const v of Z){const $=T(v.source);if(!$)continue;const r=$.data||{},b=String($.type||"").toLowerCase(),a=(()=>{var w,c;if(b==="upload"){const p=(((w=r.config)==null?void 0:w.uploadedFiles)||[]).find(g=>{const y=((g==null?void 0:g.type)||"").toUpperCase(),C=((g==null?void 0:g.mimeType)||"").toLowerCase();return y==="AUDIO"||C.startsWith("audio/")});return p==null?void 0:p.url}if(b==="assetSelector"){const p=(c=r.config)==null?void 0:c.selectedAsset,g=((p==null?void 0:p.type)||"").toUpperCase(),y=((p==null?void 0:p.mimeType)||"").toLowerCase();if(g==="AUDIO"||y.startsWith("audio/"))return p==null?void 0:p.url}return null})();a&&(v.targetHandle===`${j}-target-clone`&&(F=a),v.targetHandle===`${j}-target-prompt`&&(G=a))}F!==de&&(ee(F),L({cloneAudioUrl:F})),G!==ae&&(je(G),L({promptAudioUrl:G}))}catch{}},[Z,U,T,j,de,ae]);const L=_=>{V(F=>F.map(G=>G.id===j?{...G,data:{...G.data,config:{...G.data.config,..._}}}:G))},f=async()=>{var _,F;if(!re||!ce){m.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await Ce.ai.audio.voices.add({voiceId:re,prefix:ce}),m.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(G){const v=((F=(_=G==null?void 0:G.response)==null?void 0:_.data)==null?void 0:F.message)||(G==null?void 0:G.message)||"ä¿å­˜å¤±è´¥";m.error(v)}},x=async()=>{var _,F,G;if(!fe||!ce||!de){m.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}te(!0),m.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const $=(s.models||[]).find(p=>p.id===fe),r=($==null?void 0:$.modelId)||"speech-2.6-hd";let b=de;b.startsWith("http");const d=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;Y(d),L({voiceId:d});const a=await Ce.ai.audio.createVoice({modelId:fe,targetModel:r,prefix:ce,url:b,promptUrl:ae||void 0,promptText:ie||void 0,voiceId:d,previewText:ge||void 0}),w=(a==null?void 0:a.data)||a,c=w==null?void 0:w.sampleUrl;if(c){L({sampleUrl:c,status:"OK",voiceName:ce}),m.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const p=T(j);if(p){const g=`audioPreview-${Date.now()}`,y={id:g,type:"audioPreview",position:{x:p.position.x+450,y:p.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:c,config:{audioUrl:c,title:`${ce} - è¯•å¬`},models:s.models,createdBy:(_=p.data)==null?void 0:_.createdBy}};V(O=>[...O,y]);const C={id:`e-${j}-source-${g}-target`,source:j,sourceHandle:`${j}-source`,target:g,targetHandle:`${g}-target`,type:"aurora"};me(O=>[...O,C])}}else L({status:"OK",voiceName:ce}),m.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(v){const $=((G=(F=v==null?void 0:v.response)==null?void 0:F.data)==null?void 0:G.message)||(v==null?void 0:v.message)||"åˆ›å»ºå¤±è´¥";m.error($)}te(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:_=>{K(_),L({modelId:_})},options:(s.models||[]).filter(_=>{if(_.type!=="AUDIO_SYNTHESIS"||!_.isActive)return!1;if(Array.isArray(_.capabilities))return _.capabilities.some(G=>G.capability==="éŸ³è‰²å…‹éš†"&&G.supported);const F=String(_.provider||"").toLowerCase();return F.includes("minimaxi")||F.includes("hailuo")||F.includes("æµ·èº")}).map(_=>({value:_.id,label:_.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:ce,onChange:_=>{Re(_.target.value),L({voiceName:_.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:_=>_.stopPropagation()}),e.jsx("button",{onClick:f,disabled:!re||!ce,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!re||!ce?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:de?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:de?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:ae?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:ae?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ie,onChange:_=>{be(_.target.value),L({promptText:_.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:ge,onChange:_=>{pe(_.target.value),L({previewText:_.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsx("button",{onClick:x,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Do=t.memo(Mo),Fr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Lo=({data:s,id:j,selected:n})=>{const{setNodes:V,getNode:me,setEdges:T}=Qt(),[fe,K]=t.useState(s.config.modelId||""),[re,Y]=t.useState(s.config.voiceId||""),[ce,Re]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),de=t.useRef(null),[ee,ae]=t.useState("zh"),je=t.useRef(null),ie=t.useRef(null),be=t.useRef(null),ge=t.useRef(null),pe=t.useRef(null),[Ie,te]=t.useState([]),Z=async()=>{try{const d=await Ce.ai.audio.voices.list(),a=(d==null?void 0:d.data)??d;te(Array.isArray(a)?a:[])}catch{}},U=async()=>{try{const d=window.AudioContext||window.webkitAudioContext;ge.current||(ge.current=new d);const a=ge.current;a.state==="suspended"&&await a.resume()}catch{}},[R,L]=t.useState(!1),[f]=t.useState(""),[x]=t.useState(void 0),[_]=t.useState("mp3"),[F]=t.useState(void 0),[G]=t.useState(void 0),[v]=t.useState(void 0),[$]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!fe&&K(s.config.modelId)},[s.config.modelId,fe]),t.useEffect(()=>{!re&&s.config.voiceId&&Y(String(s.config.voiceId))},[s.config.voiceId,re]),t.useEffect(()=>{if(!fe){const a=(s.models||[]).filter(w=>w.type==="AUDIO_SYNTHESIS"&&w.isActive)[0];a&&(K(a.id),r({modelId:a.id}))}},[s.models,fe]),t.useEffect(()=>{Z()},[]),t.useEffect(()=>{ee==="custom"&&Z()},[ee]),t.useEffect(()=>{const d=de.current;d&&(d.style.height="auto",d.style.height=`${d.scrollHeight}px`)},[ce]);const r=d=>{me(j)&&V(w=>w.map(c=>c.id===j?{...c,data:{...c.data,config:{...c.data.config,...d}}}:c))},b=async(d=!1)=>{var p,g,y,C,O;let a=(re||s.config.voiceId||"").trim();if(d&&!a)if(ee==="custom"){const I=Ie[0];I&&(a=String(I.voiceId),Y(a),r({voiceId:a}))}else{const I=Fr.find(u=>{const l=u.label;return ee==="zh"?l.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):ee==="yue"?l.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):ee==="en"?l.startsWith("è‹±æ–‡ "):ee==="ja"?l.startsWith("æ—¥æ–‡ "):ee==="ko"?l.startsWith("éŸ©æ–‡ "):!0});I&&(a=I.id,Y(a),r({voiceId:a}))}const w=d?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(ce||"").trim();if(!a||!w){m.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let c=fe;if(!c){const I=(s.models||[]).filter(u=>u.type==="AUDIO_SYNTHESIS"&&u.isActive);if(I[0])c=I[0].id,K(c),r({modelId:c});else{m.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}L(!0);try{d&&await U();const I={};if(f)try{I.voice_modify={emotion:f}}catch{}const u=await Ce.ai.audio.synthesize({modelId:c,voiceId:a,text:w,format:_,sampleRate:x,volume:G,rate:F,pitch:v,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...I}),l=((p=u==null?void 0:u.data)==null?void 0:p.url)||(u==null?void 0:u.url),i=window.location.origin,D=(k=>{if(!k)return"";try{if(k.startsWith("http://localhost:3000")||k.startsWith("http://127.0.0.1:3000")){const J=new URL(k).pathname;return`${i}${J}`}return k.startsWith("http")?k:k.startsWith("/")?`${i}${k}`:`${i}/${k}`}catch{return k}})(l);let X;const W=k=>{if(k.length>=12){if(k[0]===82&&k[1]===73&&k[2]===70&&k[3]===70&&k[8]===87&&k[9]===65&&k[10]===86&&k[11]===69)return"audio/wav";if(k[0]===73&&k[1]===68&&k[2]===51||k[0]===255&&(k[1]&224)===224)return"audio/mpeg"}return _==="wav"?"audio/wav":"audio/mpeg"},ne=k=>k.length>=12&&k[4]===102&&k[5]===116&&k[6]===121&&k[7]===112,xe=k=>k.length>=4&&k[0]===79&&k[1]===103&&k[2]===103&&k[3]===83,oe=k=>k.length>=4&&k[0]===102&&k[1]===76&&k[2]===97&&k[3]===67,N=new Uint8Array(X||new ArrayBuffer(0));let h=W(N);(!h||h==="application/octet-stream")&&(ne(N)?h="audio/mp4":xe(N)?h="audio/ogg":oe(N)&&(h="audio/flac"));let E;if(d){if(pe.current){try{pe.current.stop()}catch{}pe.current.disconnect(),pe.current=null}const k=ie.current||new Audio;k.preload="auto",k.autoplay=!0,k.playsInline=!0,k.crossOrigin="anonymous",ie.current=k;let J=!1;const ue=(B,he,Ee=1500)=>new Promise(Ne=>{let $e=!1;const Ae=()=>{$e||($e=!0,Te(),Ne(!0))},_e=()=>{$e||($e=!0,Te(),Ne(!1))},Te=()=>{B.removeEventListener(he,Ae),B.removeEventListener("error",_e)};B.addEventListener(he,Ae),B.addEventListener("error",_e),setTimeout(()=>{_e()},Ee)});try{const B=Ne=>{const $e=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor($e.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt($e.substr(_e*2,2),16);return Ae},he=((g=u==null?void 0:u.data)==null?void 0:g.hex)||(u==null?void 0:u.hex),Ee=he?B(String(he)).buffer:void 0;if(Ee&&Ee.byteLength>0){const Ne=new Uint8Array(Ee),$e=W(Ne),Ae=new Blob([Ee],{type:$e}),_e=URL.createObjectURL(Ae);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}if(be.current=_e,k.src=_e,k.load(),!await ue(k,"canplay"))throw new Error("blob not ready");await k.play(),J=!0}else throw new Error("no hex")}catch{J=!1}if(!J){try{const B=Ne=>{const $e=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor($e.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt($e.substr(_e*2,2),16);return Ae},he=((y=u==null?void 0:u.data)==null?void 0:y.hex)||(u==null?void 0:u.hex),Ee=he?B(String(he)).buffer:void 0;if(!Ee||Ee.byteLength===0){const Ne=await Ce.assets.proxyDownload(D);if(!Ne||Ne.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const $e=new Uint8Array(Ne),Ae=W($e),_e=new Blob([Ne],{type:Ae}),Te=URL.createObjectURL(_e);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}if(be.current=Te,k.src=Te,k.load(),!await ue(k,"canplay"))throw new Error("blob not ready");await k.play(),J=!0}else{const Ne=new Uint8Array(Ee),$e=W(Ne),Ae=new Blob([Ee],{type:$e}),_e=URL.createObjectURL(Ae);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}if(be.current=_e,k.src=_e,k.load(),!await ue(k,"canplay"))throw new Error("blob not ready");await k.play(),J=!0}}catch{}if(!J)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const k=await Ce.assets.proxyDownload(D),J=new Uint8Array(k),ue=W(J);E=URL.createObjectURL(new Blob([k],{type:ue}))}catch{}if(!d&&E){if(je.current)try{URL.revokeObjectURL(je.current)}catch{}je.current=E;const k=D||E;r({outputUrl:k});try{const J=me(j);if(J){const B=document.querySelector(`.react-flow__node[data-id="${J.id}"]`),he=Math.round((B==null?void 0:B.getBoundingClientRect().width)||420),Ee=J.position.x+he+160,Ne=`audio-preview-${Date.now()}`;V($e=>{var le;const Ae=$e.filter(Ve=>{var et;return Ve.type==="audioPreview"&&((et=Ve.data)==null?void 0:et.sourceNodeId)===j}),_e=J.position.y,Te=Ae.length>0?Math.max(...Ae.map(Ve=>{var et;return((et=Ve.position)==null?void 0:et.y)||_e}))+120:_e;return[...$e,{id:Ne,type:"audioPreview",position:{x:Ee,y:Te},data:{audioUrl:k,sourceNodeId:j,createdBy:(le=J.data)==null?void 0:le.createdBy}}]}),T($e=>[...$e,{id:`${j}-${Ne}`,source:j,target:Ne}])}}catch{}}d&&ie.current&&!ie.current.paused?m.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!d&&E&&m.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(I){const u=((O=(C=I==null?void 0:I.response)==null?void 0:C.data)==null?void 0:O.message)||(I==null?void 0:I.message)||(d?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");m.error(u)}L(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:d=>{K(d),r({modelId:d})},options:(s.models||[]).filter(d=>d.type==="AUDIO_SYNTHESIS"&&d.isActive).map(d=>({value:d.id,label:d.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(os,{value:ee,onChange:d=>{ae(d),d==="custom"&&Z()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(os,{value:re,onChange:d=>{Y(d),r({voiceId:d})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...ee==="custom"?Ie.map(d=>({value:d.voiceId,label:d.prefix||d.voiceId})):Fr.filter(d=>{const a=d.label;return ee==="zh"?a.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):ee==="yue"?a.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):ee==="en"?a.startsWith("è‹±æ–‡ "):ee==="ja"?a.startsWith("æ—¥æ–‡ "):ee==="ko"?a.startsWith("éŸ©æ–‡ "):!0}).map(d=>({value:d.id,label:d.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>b(!0),disabled:R,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${R?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":""}`,style:R?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:de,value:ce,onChange:d=>{Re(d.target.value),r({text:d.target.value})},onMouseDown:d=>d.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>b(!1),disabled:R||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${R||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"border-transparent dark:border-white/10"}`,style:R||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:R?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Po=t.memo(Lo),Oo=t.memo(({id:s,sourceX:j,sourceY:n,targetX:V,targetY:me,sourcePosition:T,targetPosition:fe,selected:K,markerEnd:re})=>{const[Y]=ka({sourceX:j,sourceY:n,targetX:V,targetY:me,sourcePosition:T,targetPosition:fe});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#404040",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#525252",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:Y,fill:"none",stroke:K?"#525252":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:re}),e.jsx("path",{d:Y,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:re}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:Y,calcMode:"linear"})}),e.jsx("path",{d:Y,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Go=({data:s,id:j})=>{const n=t.useRef(null),{getNode:V,setNodes:me}=Qt(),[T,fe]=t.useState(!1),[K,re]=t.useState([]),[Y,ce]=t.useState(""),[Re,de]=t.useState("ALL"),[ee,ae]=t.useState(""),[je,ie]=t.useState(!1),be=t.useMemo(()=>window.location.origin,[]),ge=t.useMemo(()=>{var R;const U=s.audioUrl||"";if(U.startsWith("blob:")){const L=s.sourceNodeId?V(s.sourceNodeId):null,f=((R=L==null?void 0:L.data)==null?void 0:R.outputUrl)||"";return f.startsWith("http")?f:f.startsWith("/")?`${be}${f}`:U}return U.startsWith("http")?`${be}/api/assets/proxy-stream?url=${encodeURIComponent(U)}`:U.startsWith("/")?`${be}${U}`:U},[s.audioUrl,s.sourceNodeId,be]);t.useEffect(()=>{const U=n.current;U&&(U.preload="auto",U.playsInline=!0,U.crossOrigin="anonymous",U.load())},[ge]),t.useEffect(()=>{T&&(pe(),setTimeout(()=>{Ie()},100))},[T]);const pe=async()=>{try{const U=Re==="ALL"?void 0:{category:Re},L=(await Ce.assetLibraries.getAll(U)).data||[];re(L);const f=Re==="ALL"?L:L.filter(x=>(x.category||"OTHER")===Re);if(f.length>0){const x=f.find(_=>_.id===Y);ce(x?x.id:f[0].id)}else ce("")}catch{m.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ie=()=>{const U=window.__workflowContext;if(!U||!U.project||!U.nodeGroups){m.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const R=Ws(j,U.nodeGroups);if(!R&&U.nodeGroups.length>0){const f=U.nodeGroups[0],x=Ts({project:U.project,episode:U.episode,nodeGroup:f,assetType:"audio"});x?(ae(x),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${x}`)):m.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const L=Ts({project:U.project,episode:U.episode,nodeGroup:R,assetType:"audio"});L?(ae(L),m.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${L}`)):m.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},te=async()=>{var U,R;if(!Y){m.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ee.trim()){m.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ie(!0),await Ce.assetLibraries.addFromUrl(Y,s.audioUrl,ee.trim());const L=window.__workflowContext;if(L&&L.project&&L.nodeGroups){const f=Ws(j,L.nodeGroups)||L.nodeGroups[0];f&&Ts({project:L.project,episode:L.episode,nodeGroup:f,nodeId:j,assetType:"audio",preview:!1})}m.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),fe(!1),ae("");try{me(f=>f.map(x=>x.id===j?{...x,data:{...x.data,addedToLibrary:!0}}:x))}catch{}try{const f=new CustomEvent("asset-library-updated",{detail:{libraryId:Y}});window.dispatchEvent(f)}catch{}}catch(L){m.error(((R=(U=L.response)==null?void 0:U.data)==null?void 0:R.message)||"æ·»åŠ å¤±è´¥")}finally{ie(!1)}},Z=async()=>{var L;let U=`audio-${Date.now()}.mp3`;const R=window.__workflowContext;if(R&&R.project&&R.nodeGroups){const f=Ws(j,R.nodeGroups)||R.nodeGroups[0];if(f){const x=Ts({project:R.project,episode:R.episode,nodeGroup:f,assetType:"audio",preview:!0});if(x&&(U=x,!U.includes("."))){const _=((L=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:L[0])||".mp3";U+=_}}}try{m.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const f=await fetch(s.audioUrl);if(!f.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${f.status}`);const x=await f.blob(),_=window.URL.createObjectURL(x),F=document.createElement("a");F.href=_,F.download=U,document.body.appendChild(F),F.click(),document.body.removeChild(F),setTimeout(()=>{window.URL.revokeObjectURL(_)},100),m.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${U}`)}catch(f){m.error(`ä¸‹è½½å¤±è´¥: ${f instanceof Error?f.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:n,controls:!0,src:ge,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{fe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:Z,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),T&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:U=>U.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>fe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ee,onChange:U=>ae(U.target.value),onMouseDown:U=>U.stopPropagation(),onTouchStart:U=>U.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const U=Re==="ALL"?K:K.filter(R=>(R.category||"OTHER")===Re);return U.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Re==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Y,onChange:R=>ce(R.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:U.map(R=>e.jsxs("option",{value:R.id,children:[R.name," (",R._count.assets," ä¸ªèµ„äº§)"]},R.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(U=>e.jsx("button",{type:"button",onClick:()=>{de(U);const R=K.filter(L=>(L.category||"OTHER")===U);ce(R.length>0?R[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Re===U?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:U==="ROLE"?"person":U==="SCENE"?"landscape":U==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:U==="ROLE"?"è§’è‰²åº“":U==="SCENE"?"åœºæ™¯åº“":U==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},U))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>fe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:te,disabled:je||K.length===0||!ee.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:je?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Vo=t.memo(Go),Wo=({data:s,id:j,selected:n})=>{const{setNodes:V,getNode:me,setEdges:T}=Qt(),[fe,K]=t.useState(s.config.modelId||""),[re,Y]=t.useState(s.config.prompt||""),[ce,Re]=t.useState(s.config.previewText||""),[de,ee]=t.useState(s.config.voiceId||""),[ae,je]=t.useState(!1),ie=t.useRef(null),be=t.useRef(null),ge=t.useRef(null),pe=t.useRef(null),[Ie,te]=t.useState([]);t.useEffect(()=>{if(!fe){const _=(s.models||[]).filter(F=>F.type==="AUDIO_SYNTHESIS"&&F.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(F.provider||"").toLowerCase())&&(Array.isArray(F.capabilities)?F.capabilities.some(G=>G.capability==="éŸ³è‰²è®¾è®¡"&&G.supported):!0))[0];_&&(K(_.id),Z({modelId:_.id}))}},[s.models,fe]);const Z=x=>{me(j)&&V(F=>F.map(G=>G.id===j?{...G,data:{...G.data,config:{...G.data.config,...x}}}:G))};t.useEffect(()=>{(async()=>{try{const x=await Ce.ai.audio.voices.list(),_=(x==null?void 0:x.data)??x;te(Array.isArray(_)?_:[])}catch{}})()},[]);const U=x=>{x&&(x.style.height="auto",x.style.height=`${x.scrollHeight}px`)};t.useEffect(()=>{U(be.current)},[re]),t.useEffect(()=>{U(ge.current)},[ce]);const R=async x=>{if(!x)return!1;try{const _=(x||"").replace(/\s+/g,""),F=new Uint8Array(Math.floor(_.length/2));for(let b=0;b<F.length;b++)F[b]=parseInt(_.substr(b*2,2),16);const G=(()=>{const b=F;return b.length>=12&&b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69?"audio/wav":(b.length>=3&&b[0]===73&&b[1]===68&&b[2]===51||b.length>=2&&b[0]===255&&(b[1]&224)===224,"audio/mpeg")})(),v=new Blob([F.buffer],{type:G}),$=URL.createObjectURL(v);if(pe.current)try{URL.revokeObjectURL(pe.current)}catch{}pe.current=$;const r=ie.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=$,ie.current=r,await r.play(),!0}catch{return!1}},L=async()=>{var _,F,G,v,$;if(!re.trim()){m.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let x=fe;if(!x){const r=(s.models||[]).filter(b=>b.type==="AUDIO_SYNTHESIS"&&b.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(b.provider||"").toLowerCase()));if(r[0])x=r[0].id,K(x),Z({modelId:x});else{m.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}je(!0);try{const r=await Ce.ai.audio.design({modelId:x,prompt:re,preview_text:ce,voice_id:de||void 0,aigc_watermark:!1}),b=((_=r==null?void 0:r.data)==null?void 0:_.voice_id)||(r==null?void 0:r.voice_id),d=((F=r==null?void 0:r.data)==null?void 0:F.trial_audio)||(r==null?void 0:r.trial_audio)||((G=r==null?void 0:r.data)==null?void 0:G.hex)||(r==null?void 0:r.hex);b&&(ee(String(b)),Z({voiceId:String(b)})),d&&typeof d=="string"?(Z({trialHex:d}),await R(d),m.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):m.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const a=me(j);if(a){const c=document.querySelector(`.react-flow__node[data-id="${a.id}"]`),p=Math.round((c==null?void 0:c.getBoundingClientRect().width)||420),g=a.position.x+p+160,y=`audio-preview-${Date.now()}`;V(C=>{var O;return[...C,{id:y,type:"audioPreview",position:{x:g,y:a.position.y},data:{audioUrl:pe.current||"",sourceNodeId:j,createdBy:(O=a.data)==null?void 0:O.createdBy}}]}),T(C=>[...C,{id:`${j}-${y}`,source:j,target:y}])}}catch{}}catch(r){const b=(($=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:$.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";m.error(b)}je(!1)},f=async()=>{var _,F;const x=(de||"").trim();if(!x){m.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ie.some(w=>String(w.voiceId)===String(x))){m.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const $=(s.models||[]).find(w=>w.id===fe),r=($==null?void 0:$.modelId)||"cosyvoice-v2",b=(re||x).slice(0,40);await Ce.ai.audio.voices.add({voiceId:x,prefix:b,targetModel:r,provider:String(($==null?void 0:$.provider)||"")});const d=await Ce.ai.audio.voices.list(),a=(d==null?void 0:d.data)??d;te(Array.isArray(a)?a:[]),m.success("å·²ä¿å­˜éŸ³è‰²")}catch(G){const v=((F=(_=G==null?void 0:G.response)==null?void 0:_.data)==null?void 0:F.message)||(G==null?void 0:G.message)||"ä¿å­˜å¤±è´¥";m.error(v)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:x=>{K(x),Z({modelId:x})},options:(s.models||[]).filter(x=>x.type!=="AUDIO_SYNTHESIS"||!x.isActive?!1:Array.isArray(x.capabilities)?x.capabilities.some(_=>_.capability==="éŸ³è‰²è®¾è®¡"&&_.supported):["minimaxi","hailuo","æµ·èº"].includes(String(x.provider||"").toLowerCase())).map(x=>({value:x.id,label:x.name}))})]}),Ie.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(os,{value:de||"",onChange:x=>{ee(x),Z({voiceId:x})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ie.map(x=>({value:x.voiceId,label:x.prefix||x.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:de,onChange:x=>{const _=x.target.value;ee(_),Z({voiceId:_})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:be,value:re,onChange:x=>{Y(x.target.value),Z({prompt:x.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:ge,value:ce,onChange:x=>{Re(x.target.value),Z({previewText:x.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:L,disabled:ae||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ae||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ae?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:f,disabled:ae||!de||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${ae||!de||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Fo=t.memo(Wo),zo=({data:s,id:j,selected:n})=>{const V=t.useRef(null),me=t.useRef(null),T=t.useRef(null),{getNodes:fe,getEdges:K,setNodes:re,setEdges:Y,getNode:ce,getViewport:Re}=Qt(),de=zs(),ee=Ls(),[ae,je]=t.useState(null),[ie,be]=t.useState("#7c3aed"),[ge,pe]=t.useState(100),Ie=t.useRef(!1),te=t.useRef(null),Z=t.useRef(null),U=t.useRef(null),R=t.useRef(new Set),L=t.useRef(null),f=t.useRef(null),x=t.useRef(null),_=4096,F=s.width||800,G=s.width||800,v=_,$=_;return t.useEffect(()=>{var u,l,i,z;if(!V.current||me.current)return;const r=document.createElement("canvas");r.width=v,r.height=$,V.current.appendChild(r);const b=new _a(r,{width:v,height:$,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),d=new Qs({left:0,top:0,width:v,height:$,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});b.add(d),b.sendObjectToBack(d),b.perPixelTargetFind=!0,b.targetFindTolerance=8;const a=F/v;b.setDimensions({width:F,height:G}),b.setZoom(a),r.style.width=`${F} px`,r.style.height=`${G} px`,me.current=b,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const w=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;b.rotationCursor=w;const c=Vs.prototype.controls||{};c.tl&&(c.tl.cursorStyle="nwse-resize",c.tl.cornerStyle="square"),c.br&&(c.br.cursorStyle="nwse-resize",c.br.cornerStyle="square"),c.tr&&(c.tr.cursorStyle="nesw-resize",c.tr.cornerStyle="square"),c.bl&&(c.bl.cursorStyle="nesw-resize",c.bl.cornerStyle="square"),c.mtr&&(c.mtr.cursorStyle=w,c.mtr.cornerStyle="circle");const p=D=>{D&&(D.borderColor="#ff2d55",D.cornerColor="#ff2d55",D.cornerStrokeColor="#ff2d55",D.transparentCorners=!1,D.cornerSize=12,D.hasBorders=!0,D.hasControls=!0)},g=()=>{const D=b.getActiveObject();D&&(D.type==="activeSelection"&&Array.isArray(D._objects)&&D._objects.forEach(p),p(D),b.requestRenderAll())};b.on("selection:created",g),b.on("selection:updated",g),b.freeDrawingBrush=new Pr(b);const y=()=>{const D=me.current;if(!D)return;const X=D.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(X.objects)&&(X.objects=X.objects.map(oe=>(oe&&oe.type==="image"&&oe.originalUrl&&(oe.src=oe.originalUrl),oe)));const W={canvasJson:X,appliedCrop:x.current},ne=JSON.stringify(W);try{localStorage.setItem(`superCanvas:${j}`,ne)}catch{}ce(j)&&re(oe=>oe.map(N=>N.id===j?{...N,data:{...N.data,canvasState:ne}}:N))},C=()=>{f.current&&(clearTimeout(f.current),f.current=null),f.current=window.setTimeout(()=>{y()},300)};b.on("object:added",C),b.on("object:modified",C),b.on("object:removed",C),b.on("path:created",C);const O=((l=(u=ce(j))==null?void 0:u.data)==null?void 0:l.canvasState)||localStorage.getItem(`superCanvas:${j}`),I=(z=(i=ce(j))==null?void 0:i.data)==null?void 0:z.canvasJson;if(O||I)try{let D,X=null;if(O){const h=JSON.parse(O);h.canvasJson?(D=h.canvasJson,X=h.appliedCrop):D=h}else I&&(D=JSON.parse(I));const W=D,ne=h=>{var E,k,J,ue,B,he,Ee,Ne,$e;if(!h||typeof h!="object")return h;if(h.type==="image"){if(h.originalUrl)h.src=h.originalUrl;else if(h.sourceNodeId){const Ae=ce(h.sourceNodeId),_e=((E=Ae==null?void 0:Ae.data)==null?void 0:E.imageUrl)||((k=Ae==null?void 0:Ae.data)==null?void 0:k.url)||((J=Ae==null?void 0:Ae.data)==null?void 0:J.output)||((B=(ue=Ae==null?void 0:Ae.data)==null?void 0:ue.config)==null?void 0:B.generatedImageUrl)||(($e=(Ne=(Ee=(he=Ae==null?void 0:Ae.data)==null?void 0:he.config)==null?void 0:Ee.uploadedFiles)==null?void 0:Ne[0])==null?void 0:$e.url);_e&&(h.originalUrl=_e,h.src=_e)}return typeof h.src=="string"&&h.src.startsWith("blob:")?null:h}return Array.isArray(h.objects)&&(h.objects=h.objects.map(ne).filter(Boolean),h.type==="group"&&h.objects.length===0)?null:h},xe=h=>h&&(typeof(h==null?void 0:h.src)=="string"&&h.src.startsWith("blob:")?null:h.type==="image"?ne(h):h),oe=h=>h&&(Array.isArray(h)?h.map(oe).filter(Boolean):typeof h=="object"&&(h.type==="image"&&typeof h.src=="string"&&h.src.startsWith("blob:")||(Object.keys(h).forEach(E=>{const k=h[E];if(typeof k=="string"&&k.startsWith("blob:"))h[E]=void 0;else if(k&&typeof k=="object"){const J=oe(k);J===null?delete h[E]:h[E]=J}}),Array.isArray(h.objects)&&(h.objects=h.objects.map(oe).filter(Boolean),h.type==="group"&&h.objects.length===0)))?null:h);Array.isArray(W.objects)&&(W.objects=W.objects.map(ne).filter(Boolean)),W.backgroundImage&&(W.backgroundImage=xe(W.backgroundImage)),W.overlayImage&&(W.overlayImage=xe(W.overlayImage)),W.clipPath&&(W.clipPath=ne(W.clipPath));const N=oe(W);b.loadFromJSON(N).then(()=>{const h=new Qs({left:0,top:0,width:v,height:$,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});b.add(h);const E=b.getObjects().find(k=>k.name==="__background__");if(E&&b.sendObjectToBack(E),X){x.current=X;const{left:k,top:J,width:ue,height:B}=X,he=new Qs({left:k,top:J,width:ue,height:B,absolutePositioned:!0});b.clipPath=he,E&&E.set({left:k,top:J,width:ue,height:B})}b.requestRenderAll()})}catch{}return V.current&&V.current.classList.add("nodrag"),()=>{b.dispose(),me.current=null,V.current&&(V.current.innerHTML="")}},[j,v,$,F]),t.useEffect(()=>{ae==="brush"?(ge<80||ge>400)&&pe(100):(ae==="pencil"||ae==="line"||ae==="arrow")&&(ge<10||ge>30)&&pe(15)},[ae,ge]),t.useEffect(()=>{const r=me.current;if(!r)return;const b="https://api.waule.ai",d=de.filter(c=>c.target===j&&c.targetHandle==="input-image");d.forEach(async c=>{var I,u;const p=ee.find(l=>l.id===c.source);if(!p||R.current.has(p.id))return;let g;const y=p.data;if(p.type==="upload"){const l=(I=y==null?void 0:y.config)==null?void 0:I.uploadedFiles;if(l&&l.length>0){const i=l[0];(i.type==="IMAGE"||(u=i.mimeType)!=null&&u.startsWith("image/"))&&(g=i.url)}}else p.type==="imagePreview"?g=y==null?void 0:y.imageUrl:g=(y==null?void 0:y.imageUrl)||(y==null?void 0:y.output)||(y==null?void 0:y.url);if(!g)return;let C=g;if(!g.startsWith("http")&&!g.startsWith("data:")&&(C=`${b}${g}`),C=C.replace(/^https?:\/\/localhost(?::\d+)?/i,b),r.getObjects().find(l=>l.sourceNodeId===p.id)){R.current.add(p.id);return}R.current.add(p.id);try{const l=await Ce.assets.proxyDownload(C),i=new Uint8Array(l);let z="image/png";i.length>=4&&(i[0]===137&&i[1]===80&&i[2]===78&&i[3]===71?z="image/png":i[0]===255&&i[1]===216&&i[2]===255?z="image/jpeg":i[0]===71&&i[1]===73&&i[2]===70?z="image/gif":i[0]===82&&i[1]===73&&i[2]===70&&i[3]===70&&i.length>=12&&i[8]===87&&i[9]===69&&i[10]===66&&i[11]===80&&(z="image/webp"));const D=new Blob([l],{type:z}),X=URL.createObjectURL(D),W=await Ta.fromURL(X);if(!W){URL.revokeObjectURL(X);return}const ne=d.indexOf(c)*20;W.set({scaleX:1,scaleY:1,left:(v-W.width)/2+ne,top:($-W.height)/2+ne,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:p.id,originalUrl:C,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),W.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(W);const xe=r.getObjects().find(oe=>oe.name==="__background__");xe?(r.sendObjectToBack(W),r.sendObjectToBack(xe)):r.sendObjectToBack(W),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(X),1e3)}catch{}});const a=new Set(d.map(c=>{var p;return(p=ee.find(g=>g.id===c.source))==null?void 0:p.id}).filter(Boolean)),w=[];R.current.forEach(c=>{if(!a.has(c)){w.push(c);const p=r.getObjects().find(g=>g.sourceNodeId===c);p&&(r.remove(p),r.requestRenderAll())}}),w.forEach(c=>R.current.delete(c))},[de,ee,j,v,$]),t.useEffect(()=>{const r=me.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,ae===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(w=>{w.name!=="__background__"&&w.name!=="__crop__"&&(w.selectable=!1,w.evented=!1)}),L.current&&(L.current.style.display="none"),x.current){const{left:w,top:c,width:p,height:g}=x.current,y=new Qs({left:w,top:c,width:p,height:g,absolutePositioned:!0});r.clipPath=y;const C=r.getObjects().find(O=>O.name==="__background__");C&&C.set({left:w,top:c,width:p,height:g})}return}const b=ie.startsWith("#")?`%23${ie.slice(1)}`:encodeURIComponent(ie),d=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${b}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(ae==="pencil"||ae==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Pr(r);const w=(p,g)=>{const y=p.replace("#",""),C=parseInt(y.substring(0,2),16),O=parseInt(y.substring(2,4),16),I=parseInt(y.substring(4,6),16);return`rgba(${C},${O},${I},${g})`};if(r.freeDrawingBrush.color=w(ie,.7),r.freeDrawingBrush.width=ge,x.current){const{left:p,top:g,width:y,height:C}=x.current,O=new Qs({left:p,top:g,width:y,height:C,absolutePositioned:!0});r.clipPath=O;const I=r.getObjects().find(u=>u.name==="__background__");I&&I.set({left:p,top:g,width:y,height:C})}const c=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${b}' stroke-width='2.2'/></svg>") 16 16, crosshair`;ae==="pencil"?(r.freeDrawingCursor=d,r.defaultCursor=d,r.hoverCursor=d,r.moveCursor=d,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=d)):(r.freeDrawingCursor=c,r.defaultCursor=c,r.hoverCursor=c,r.moveCursor=c,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=c)),r.selection=!1,r.getObjects().forEach(p=>{p.name!=="__background__"&&p.name!=="__crop__"&&(p.selectable=!0,p.evented=!0)}),ae==="brush"&&L.current&&(L.current.style.display="block"),ae==="pencil"&&L.current&&(L.current.style.display="none")}else if(ae==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const w=r.getObjects().find(C=>C.name==="__background__");w&&w.set({left:0,top:0,width:v,height:$}),r.requestRenderAll();let c=U.current;const p=v*.1,g=v-p*2,y=$-p*2;if(!c||!r.getObjects().includes(c)){const C=x.current||{left:p,top:p,width:g,height:y};c=new Qs({left:C.left,top:C.top,width:C.width,height:C.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),U.current=c,r.add(c)}c&&(c.visible=!0,c.selectable=!0,c.evented=!0,r.setActiveObject(c),r.requestRenderAll())}else if(ae==="line"||ae==="arrow"||ae==="text"||ae==="eraser"){if(r.selection=!1,x.current){const{left:c,top:p,width:g,height:y}=x.current,C=new Qs({left:c,top:p,width:g,height:y,absolutePositioned:!0});r.clipPath=C;const O=r.getObjects().find(I=>I.name==="__background__");O&&O.set({left:c,top:p,width:g,height:y})}const w=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${b}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=ae==="text"?"text":ae==="eraser"?a:w,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),ae==="line"||ae==="arrow"?(r.hoverCursor=w,r.moveCursor=w,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(c=>{c.name!=="__background__"&&c.name!=="__crop__"&&(c.selectable=!1,c.evented=!1)}),L.current&&(L.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(c=>{c.name!=="__background__"&&c.name!=="__crop__"&&(c.selectable=!0,c.evented=!0)}),ae==="eraser"&&L.current&&(L.current.style.display="none"),ae==="eraser"&&(r.moveCursor=a,r.hoverCursor=a)),L.current&&(L.current.style.display="none")}else{if(U.current&&(U.current.visible=!1,r.discardActiveObject()),x.current){const{left:w,top:c,width:p,height:g}=x.current,y=new Qs({left:w,top:c,width:p,height:g,absolutePositioned:!0});r.clipPath=y;const C=r.getObjects().find(O=>O.name==="__background__");C&&C.set({left:w,top:c,width:p,height:g})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(w=>{w.name!=="__background__"&&w.name!=="__crop__"&&(w.selectable=!0,w.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),L.current&&(L.current.style.display="none")}},[ae,ie,ge,v,$,F,G]),t.useEffect(()=>{const r=b=>{const d=me.current;if(d){if(b.key==="Escape")je("select");else if(b.key==="Enter"&&ae==="crop"){const a=U.current;if(a){const w=Math.max(0,Math.floor(a.left??0)),c=Math.max(0,Math.floor(a.top??0)),p=Math.max(1,Math.floor((a.width??0)*(a.scaleX??1))),g=Math.max(1,Math.floor((a.height??0)*(a.scaleY??1)));x.current={left:w,top:c,width:p,height:g};const y=new Qs({left:w,top:c,width:p,height:g,absolutePositioned:!0});d.clipPath=y;const C=d.getObjects().find(I=>I.name==="__background__");C&&C.set({left:w,top:c,width:p,height:g}),a.visible=!1,je("select"),d.requestRenderAll();const O=me.current?()=>{const I=me.current;if(!I)return;const u=I.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(u.objects)&&(u.objects=u.objects.map(D=>(D&&D.type==="image"&&D.originalUrl&&(D.src=D.originalUrl),D)));const l={canvasJson:u,appliedCrop:x.current},i=JSON.stringify(l);try{localStorage.setItem(`superCanvas:${j}`,i)}catch{}ce(j)&&re(D=>D.map(X=>X.id===j?{...X,data:{...X.data,canvasState:i}}:X))}:null;O&&O()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[ae]),t.useEffect(()=>{const r=me.current;if(!r)return;const b=g=>{const y=r.getPointer(g.e);if(Ie.current=!0,te.current={x:y.x,y:y.y},(ae==="line"||ae==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(C=>{C.name!=="__background__"&&C.name!=="__crop__"&&(C.selectable=!1,C.evented=!1)})),ae==="line"){const C=[y.x,y.y,y.x,y.y],O=new or(C,{strokeWidth:ge/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round"});Z.current=O,r.add(O)}else if(ae==="arrow"){const C=[y.x,y.y,y.x,y.y],O=new or(C,{strokeWidth:ge/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});Z.current=O,r.add(O)}else if(ae==="text"){const C=new Or("Type here",{left:y.x,top:y.y,fontFamily:"Arial",fill:ie,fontSize:ge*10,width:300,splitByGrapheme:!0});C.lockScalingY=!1,C.lockScalingFlip=!0,C.lockUniScaling=!1,C.setControlsVisibility({mt:!1,mb:!1}),r.add(C),r.setActiveObject(C),C.enterEditing(),je("select")}else if(ae==="eraser"){const C=r.getObjects();for(let O=C.length-1;O>=0;O--){const I=C[O];if(!(I.name==="__background__"||I.name==="__crop__"||I.name==="__input_image__"||I.sourceNodeId)&&I.containsPoint(y)){r.remove(I);break}}r.requestRenderAll()}},d=g=>{const y=r.getPointer(g.e);if(ae==="brush"&&L.current){const O=r.getZoom(),I=ge*O,u=I/2;L.current.style.width=`${I}px`,L.current.style.height=`${I}px`,L.current.style.left=`${y.x*O-u}px`,L.current.style.top=`${y.y*O-u}px`,L.current.style.borderColor=`rgba(${parseInt(ie.slice(1,3),16)},${parseInt(ie.slice(3,5),16)},${parseInt(ie.slice(5,7),16)},0.7)`,L.current.style.borderWidth="1px",L.current.style.background="transparent"}if(!Ie.current)return;const C=Z.current;if(ae==="line"&&C&&C instanceof or)C.set({x2:y.x,y2:y.y}),C.setCoords(),r.requestRenderAll();else if(ae==="arrow"&&C&&C instanceof or)C.set({x2:y.x,y2:y.y}),C.setCoords(),r.requestRenderAll();else if(ae==="eraser"){const O=r.getObjects();for(let I=O.length-1;I>=0;I--){const u=O[I];u.name==="__background__"||u.name==="__crop__"||u.name==="__input_image__"||u.sourceNodeId||u.containsPoint(y)&&r.remove(u)}r.requestRenderAll()}},a=()=>{if(Ie.current=!1,ae==="arrow"&&Z.current instanceof or){const g=Z.current,y=Math.atan2(g.y2-g.y1,g.x2-g.x1),C=Math.max(ge*10,120),O=Math.PI/6,I=-Math.cos(y),u=-Math.sin(y),l=Math.cos(O),i=Math.sin(O),z=g.x2+C*(I*l-u*i),D=g.y2+C*(I*i+u*l),X=g.x2+C*(I*l+u*i),W=g.y2+C*(-I*i+u*l),ne=g.strokeWidth||ge/2,xe=new or([g.x2,g.y2,z,D],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"}),oe=new or([g.x2,g.y2,X,W],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"});r.add(xe),r.add(oe);const N=new Ua([g,xe,oe],{selectable:!0,evented:!0});r.remove(g),r.remove(xe),r.remove(oe),r.add(N)}Z.current=null,(ae==="line"||ae==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(g=>{g.name!=="__background__"&&g.name!=="__crop__"&&(g.selectable=!1,g.evented=!1)}))},w=g=>{var I;const y=g.target;if(!y)return;const C=y.type==="textbox"||y instanceof Or,O=y.type==="i-text"||y instanceof Ra;if(C||O){const u=(I=g==null?void 0:g.transform)==null?void 0:I.corner;if(u==="ml"||u==="mr"){const l=Math.max(50,(y.width||50)*(y.scaleX||1));y.set({width:l,scaleX:1,scaleY:1})}else{const l=y.scaleX||1,i=y.fontSize||40,z=Math.max(6,Math.min(512,Math.round(i*l)));y.set({fontSize:z,scaleX:1,scaleY:1})}y.setCoords(),r.requestRenderAll()}},c=()=>{ae==="brush"&&L.current&&(L.current.style.display="block")},p=()=>{L.current&&(L.current.style.display="none")};return r.on("mouse:down",b),r.on("mouse:move",d),r.on("mouse:up",a),r.on("mouse:over",c),r.on("mouse:out",p),r.on("object:scaling",w),()=>{r.off("mouse:down",b),r.off("mouse:move",d),r.off("mouse:up",a),r.off("mouse:over",c),r.off("mouse:out",p),r.off("object:scaling",w)}},[ae,ie,ge]),e.jsxs("div",{ref:T,className:`relative flex flex-col w-[800px] h-auto bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Er,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:V,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:L,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Er,label:"Select"},{id:"pencil",icon:Hr,label:"Pencil"},{id:"brush",icon:Ma,label:"Brush"},{id:"line",icon:Ga,label:"Line"},{id:"arrow",icon:$a,label:"Arrow"},{id:"text",icon:Fa,label:"Text"},{id:"eraser",icon:Pa,label:"Eraser"},{id:"crop",icon:La,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>je(r.id),className:`p-2 rounded-lg transition-all ${ae===r.id?"bg-neutral-500/20 text-neutral-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=me.current,b=r==null?void 0:r.getActiveObject();b&&(r==null||r.remove(b),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(Br,{size:16})}),e.jsx("button",{onClick:()=>{const r=me.current,b=r==null?void 0:r.getActiveObject();b&&(r==null||r.bringObjectToFront(b),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Wa,{size:16})}),e.jsx("button",{onClick:()=>{const r=me.current,b=r==null?void 0:r.getActiveObject();if(b){r==null||r.sendObjectToBack(b);const d=r==null?void 0:r.getObjects().find(a=>a.name==="__background__");d&&(r==null||r.sendObjectToBack(d)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Va,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ie,onChange:r=>be(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:ae==="brush"?80:10,max:ae==="brush"?400:30,value:ge,onChange:r=>{const b=parseInt(r.target.value);pe(b)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:ge})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:ae==="crop",onClick:async()=>{var he,Ee,Ne;const r=me.current;if(!r)return;r.discardActiveObject();const b=[...r.viewportTransform],d=r.getWidth(),a=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(_),r.setHeight(_);const w=r.clipPath;r.clipPath=void 0;const c=x.current;let p="",g=v,y=$;c?(g=c.width,y=c.height,p=r.toDataURL({format:"png",quality:1,left:c.left,top:c.top,width:c.width,height:c.height,multiplier:1})):p=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:v,height:$}),r.clipPath=w,r.setViewportTransform(b),r.setWidth(d),r.setHeight(a),r.requestRenderAll();const C=`${g}:${y}`,O=ce(j);if(!O)return;let I=p;try{const $e=p.split(",")[1],Ae=atob($e),_e=new Array(Ae.length);for(let Ft=0;Ft<Ae.length;Ft++)_e[Ft]=Ae.charCodeAt(Ft);const Te=new Uint8Array(_e),le=new Blob([Te],{type:"image/png"}),Ve=`canvas-export-${Date.now()}.png`,et=await Ce.post("/assets/presigned-url",{fileName:Ve,contentType:"image/png"});if(et.success&&et.data){const{uploadUrl:Ft,publicUrl:Mt}=et.data;await(await ds(async()=>{const{default:ct}=await import("./utils-BcyDR7Vi.js");return{default:ct}},[])).default.put(Ft,le,{headers:{"Content-Type":"image/png"},timeout:3e5}),I=Mt}}catch{}const u=Re&&((he=Re())==null?void 0:he.zoom)||1,l=document.querySelector(`.react-flow__node[data-id="${j}"]`),i=(l==null?void 0:l.getBoundingClientRect().width)||400,z=Math.round(i/u),D=400,X=($e,Ae=300)=>{if(!$e||!/^[0-9]+\s*:\s*[0-9]+$/.test($e))return Ae;const[_e,Te]=$e.split(":").map(le=>parseFloat(le));return!_e||!Te?Ae:Math.round(D*(Te/_e))},W=200,ne=100,xe=X(C,300),oe=fe(),N=K(),E=oe.filter($e=>$e.type==="imagePreview"&&N.some(Ae=>Ae.source===j&&Ae.target===$e.id)).length,k=O.position.x+z+W,J=O.position.y+E*(xe+ne),ue={id:`preview-${j}-${Date.now()}`,type:"imagePreview",position:{x:k,y:J},data:{imageUrl:I,width:D,ratio:C,workflowContext:(Ee=O.data)==null?void 0:Ee.workflowContext,createdBy:(Ne=O.data)==null?void 0:Ne.createdBy}};re($e=>[...$e,ue]);const B={id:`edge-${j}-${ue.id}`,source:j,target:ue.id,targetHandle:`${ue.id}-target`,type:"aurora"};Y($e=>$e.find(_e=>_e.source===j&&_e.target===ue.id)?$e:[...$e,B])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:cursor-not-allowed disabled:hover:shadow-md",title:ae==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(St,{type:"target",position:ut.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(St,{type:"source",position:ut.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Bo=t.memo(zo),Ho=({data:s,selected:j,id:n})=>{const[V,me]=t.useState(s.config.upscaleResolution||"1080p"),[T,fe]=t.useState(!1),[K,re]=t.useState(s.config.inputVideoUrl||""),[,Y]=t.useState(s.config.taskId||""),{setNodes:ce,setEdges:Re}=Qt(),de=Ls(),ee=zs(),ae=ge=>{ce(pe=>pe.map(Ie=>Ie.id===n?{...Ie,data:{...Ie.data,config:{...Ie.data.config,...ge}}}:Ie))};t.useEffect(()=>{var pe,Ie,te;const ge=ee.filter(Z=>Z.target===n);if(ge.length>0){const Z=de.find(U=>U.id===ge[0].source);if(Z){const U=Z.data,R=U.videoUrl||((pe=U.config)==null?void 0:pe.videoUrl)||((Ie=U.config)==null?void 0:Ie.outputVideoUrl)||((te=U.config)==null?void 0:te.resultUrl);R&&R!==K&&(re(R),ae({inputVideoUrl:R}))}}else K&&(re(""),ae({inputVideoUrl:""}))},[ee,de,n]),t.useEffect(()=>{const ge=s.config.taskId;(async()=>{if(ge)try{const te=(await Ce.get(`/tasks/${ge}`)).task;if(te.status==="SUCCESS"){const Z=te.resultUrl;ae({outputVideoUrl:Z,taskId:""}),ee.filter(f=>f.source===n).map(f=>de.find(x=>x.id===f.target)).filter(f=>f&&f.type==="videoPreview").find(f=>f.data.videoUrl===Z)||ie(Z),Vt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),fe(!1)}else te.status==="PROCESSING"||te.status==="PENDING"?(fe(!0),je(ge)):te.status==="FAILURE"&&(fe(!1),ae({taskId:""}),Vt.error(te.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${te.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{fe(!1),ae({taskId:""}),Vt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const je=async ge=>{let Ie=0;const te=async()=>{try{Ie++;const U=(await Ce.get(`/tasks/${ge}`)).task;if(U.status==="SUCCESS"){const R=U.resultUrl;fe(!1),ae({outputVideoUrl:R,taskId:""}),ie(R),Vt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(U.status==="FAILURE"){fe(!1),ae({taskId:""}),Vt.error(U.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(U.status==="PROCESSING"||U.status==="PENDING")&&(Ie<300?setTimeout(te,3e3):(fe(!1),ae({taskId:""}),Vt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{fe(!1),ae({taskId:""}),Vt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};te()},ie=ge=>{var Ie;const pe=de.find(te=>te.id===n);if(pe){const te=`preview-video-${Date.now()}`,Z=V==="1080p"?"HD":V,U={id:te,type:"videoPreview",position:{x:pe.position.x+400,y:pe.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:ge,ratio:"16:9",resolution:Z,createdBy:(Ie=pe.data)==null?void 0:Ie.createdBy}},R={id:`edge-${n}-${te}`,source:n,target:te,type:"aurora"};ce(L=>[...L,U]),setTimeout(()=>{Re(L=>[...L,R])},100)}},be=async()=>{var ge,pe;if(!K){Vt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}fe(!0);try{const Ie=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!Ie||Ie.length===0){Vt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),fe(!1);return}const te=Ie[0],U=(await Ce.post("/ai/video-upscale",{video_url:K,upscale_resolution:V,apiKey:te.apiKey,apiUrl:te.apiUrl})).taskId;Y(U),ae({taskId:U,upscaleResolution:V}),Vt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),je(U)}catch(Ie){const te=((pe=(ge=Ie.response)==null?void 0:ge.data)==null?void 0:pe.error)||Ie.message||"æœªçŸ¥åŸå› ";Vt.error(`å¯åŠ¨å¤±è´¥ï¼š${te}ï¼Œè¯·ç¨åé‡è¯•`),fe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[K&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:K,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(ge=>e.jsx("button",{type:"button",onClick:()=>{me(ge),ae({upscaleResolution:ge})},disabled:T,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${V===ge?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${T?"cursor-not-allowed":""}`,children:ge},ge))})]}),e.jsx("button",{type:"button",onClick:ge=>{ge.preventDefault(),ge.stopPropagation(),be()},onMouseDown:ge=>{ge.stopPropagation()},disabled:T||!K||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${T||!K||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[T?e.jsx(Ds,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:T?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(gs,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Xo=t.memo(Ho),Jo=({data:s,selected:j,id:n})=>{const[V,me]=t.useState(s.config.prompt||""),[T,fe]=t.useState(s.config.duration||30),[K,re]=t.useState(s.config.ratio||"16:9"),[Y,ce]=t.useState(s.config.language||"zh"),[Re,de]=t.useState(!1),[ee,ae]=t.useState(s.config.images||[]),[,je]=t.useState(s.config.taskId||""),{credits:ie,loading:be}=Ss({nodeType:"ad_composition",duration:T}),{setNodes:ge,setEdges:pe}=Qt(),Ie=Ls(),te=zs(),Z=f=>{ge(x=>x.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,...f}}}:_))};t.useEffect(()=>{const f=te.filter(_=>_.target===n),x=[];f.forEach(_=>{var G,v,$,r,b,d,a,w,c,p;const F=Ie.find(g=>g.id===_.source);F&&(F.type==="imagePreview"&&((G=F.data)!=null&&G.imageUrl)?x.push(F.data.imageUrl):F.type==="aiImage"&&(($=(v=F.data)==null?void 0:v.config)!=null&&$.generatedImageUrl)?x.push(F.data.config.generatedImageUrl):F.type==="upload"&&((b=(r=F.data)==null?void 0:r.config)!=null&&b.uploadedFiles)?F.data.config.uploadedFiles.filter(y=>y.type==="IMAGE"||(y.mimeType||"").startsWith("image/")).forEach(y=>x.push(y.url)):F.type==="assetSelector"&&((a=(d=F.data)==null?void 0:d.config)!=null&&a.subjects?F.data.config.subjects.forEach(y=>{Array.isArray(y.images)&&y.images.forEach(C=>x.push(C.url))}):((p=(c=(w=F.data)==null?void 0:w.config)==null?void 0:c.selectedAsset)==null?void 0:p.type)==="IMAGE"&&x.push(F.data.config.selectedAsset.url)))}),JSON.stringify(x)!==JSON.stringify(ee)&&(ae(x),Z({images:x}))},[te,Ie,n]),t.useEffect(()=>{const f=s.config.taskId;(async()=>{if(f)try{const F=(await Ce.get(`/tasks/${f}`)).task;if(F.status==="SUCCESS"){const G=F.resultUrl;Z({taskId:""}),de(!1)}else F.status==="PROCESSING"||F.status==="PENDING"?(de(!0),U(f)):F.status==="FAILURE"&&(de(!1),Z({taskId:""}),Vt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${F.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{de(!1),Z({taskId:""})}})()},[]);const U=async f=>{let _=0;const F=async()=>{try{_++;const v=(await Ce.get(`/tasks/${f}`)).task;if(v.status==="SUCCESS"){const $=v.resultUrl;de(!1),Z({taskId:""}),R($),Vt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(v.status==="FAILURE"){de(!1),Z({taskId:""}),Vt.error(v.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(v.status==="PROCESSING"||v.status==="PENDING")&&(_<120?setTimeout(F,1e4):(de(!1),Z({taskId:""}),Vt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{de(!1),Z({taskId:""}),Vt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};F()},R=f=>{var _;const x=Ie.find(F=>F.id===n);if(x){const F=`preview-video-${Date.now()}`,G={id:F,type:"videoPreview",position:{x:x.position.x+400,y:x.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:f,ratio:K,width:320,createdBy:(_=x.data)==null?void 0:_.createdBy}},v={id:`edge-${n}-${F}`,source:n,target:F,type:"aurora"};ge($=>[...$,G]),setTimeout(()=>{pe($=>[...$,v])},100)}},L=async()=>{var f,x,_,F,G;if(ee.length===0){Vt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(ee.length>15){Vt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!V.trim()){Vt.error("è¯·è¾“å…¥æç¤ºè¯");return}de(!0);try{const v=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!v||v.length===0){Vt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),de(!1);return}const $=v[0],r={images:ee,prompt:V,duration:T,ratio:K,language:Y,apiKey:$.apiKey,apiUrl:$.apiUrl},b=await Ce.post("/ai/commercial-video",r),d=b.taskId,a=b.creditsCharged||0;if(je(d),Z({taskId:d,images:ee,prompt:V,duration:T,ratio:K,language:Y}),a>0)try{const{useAuthStore:w}=await ds(async()=>{const{useAuthStore:p}=await import("./index-Cwo4xSFf.js").then(g=>g.f);return{useAuthStore:p}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:c}=w.getState();await c(),Vt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${a} ç§¯åˆ†ï¼‰`)}catch{Vt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Vt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");U(d)}catch(v){((f=v.response)==null?void 0:f.status)===403?Vt.error(((_=(x=v.response)==null?void 0:x.data)==null?void 0:_.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Vt.error(((G=(F=v.response)==null?void 0:F.data)==null?void 0:G.error)||v.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),de(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",ee.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:V,onChange:f=>{me(f.target.value),Z({prompt:f.target.value}),f.target.style.height="auto",f.target.style.height=f.target.scrollHeight+"px"},onFocus:f=>{f.target.style.height="auto",f.target.style.height=f.target.scrollHeight+"px"},ref:f=>{f&&V&&(f.style.height="auto",f.style.height=f.scrollHeight+"px")},disabled:Re,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(f=>e.jsxs("button",{type:"button",onClick:()=>{fe(f),Z({duration:f})},disabled:Re,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${T===f?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Re?"cursor-not-allowed":""}`,children:[f,"s"]},f))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(f=>e.jsx("button",{type:"button",onClick:()=>{re(f),Z({ratio:f})},disabled:Re,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${K===f?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Re?"cursor-not-allowed":""}`,children:f},f))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(f=>e.jsx("button",{type:"button",onClick:()=>{ce(f.value),Z({language:f.value})},disabled:Re,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Y===f.value?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Re?"cursor-not-allowed":""}`,children:f.label},f.value))})]}),e.jsx("button",{type:"button",onClick:L,disabled:Re||ee.length===0||!V.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Re||ee.length===0||!V.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Re?e.jsx(Ds,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),e.jsx("span",{children:Re?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Re&&!be&&ie!==null&&ie>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ie,"ç§¯åˆ†"]})]})})]}),e.jsx(gs,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},qo=t.memo(Jo),Ko=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],Yo=({data:s,selected:j,id:n})=>{const{setNodes:V}=Qt(),[me,T]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[fe,K]=t.useState(!1),[re,Y]=t.useState(!1),[ce,Re]=t.useState(s.fontSize||36),[de,ee]=t.useState(s.width||200),[ae,je]=t.useState(s.bold||!1),ie=t.useRef(null),be=t.useRef(null),ge=t.useCallback(te=>{V(Z=>Z.map(U=>U.id===n?{...U,data:{...U.data,...te}}:U))},[n,V]);t.useEffect(()=>{const te=setTimeout(()=>{me!==s.text&&ge({text:me})},300);return()=>clearTimeout(te)},[me,s.text,ge]),t.useEffect(()=>{ge({fontSize:ce,width:de,bold:ae})},[ce,de,ae,ge]);const pe=()=>{K(!0),setTimeout(()=>{ie.current&&(ie.current.focus(),ie.current.select(),ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},0)},Ie=()=>{K(!1)};return t.useEffect(()=>{fe&&ie.current&&(ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},[fe,me]),t.useEffect(()=>{const te=Z=>{be.current&&!be.current.contains(Z.target)&&Y(!1)};return re&&document.addEventListener("mousedown",te),()=>document.removeEventListener("mousedown",te)},[re]),e.jsxs("div",{className:`relative group ${j?"ring-2 ring-neutral-400 ring-offset-2":""}`,style:{width:de},children:[e.jsx(hs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:te=>{te.stopPropagation(),Y(!re)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),re&&e.jsxs("div",{ref:be,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:te=>te.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:ce,onChange:te=>Re(Number(te.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-neutral-400",children:Ko.map(te=>e.jsxs("option",{value:te,children:[te,"px"]},te))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>je(!ae),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${ae?"bg-neutral-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),fe?e.jsx("textarea",{ref:ie,value:me,onChange:te=>T(te.target.value),onBlur:Ie,onMouseDown:te=>te.stopPropagation(),onKeyDown:te=>{te.key==="Escape"&&K(!1)},className:"nodrag w-full bg-transparent border-2 border-neutral-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:ae?"bold":"normal"}}):e.jsx("div",{onDoubleClick:pe,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:ae?"bold":"normal"},children:me}),!fe&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:te=>{te.stopPropagation(),te.preventDefault();const Z=te.clientX,U=de,R=f=>{f.preventDefault();const x=Math.max(100,U+(f.clientX-Z));ee(x)},L=()=>{document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",L)};document.addEventListener("mousemove",R),document.addEventListener("mouseup",L)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Qo=t.memo(Yo),Zo=({data:s,id:j,selected:n})=>{const{getNode:V,setNodes:me,setEdges:T}=Qt(),fe=Fs(t.useCallback(l=>l.edges.filter(i=>i.target===j),[j])),[K,re]=t.useState(s.prompt||""),[Y,ce]=t.useState(s.points||[]),[Re,de]=t.useState(!1),[ee,ae]=t.useState(!1),[je,ie]=t.useState(null),[be,ge]=t.useState([]),[,pe]=t.useState(s.generatedImageUrl||null),[Ie,te]=t.useState(null),[,Z]=t.useState(s.taskId||""),[,U]=t.useState(0),R=t.useRef(null),L=t.useRef(1),{credits:f,loading:x,isFreeUsage:_,freeUsageRemaining:F,refetch:G}=Ss({nodeType:"image_editing",quantity:1}),v=t.useCallback(l=>{me(i=>i.map(z=>z.id===j?{...z,data:{...z.data,...l}}:z))},[j,me]),$=Fs(t.useCallback(l=>l.edges.filter(i=>i.source===j),[j])),r=t.useCallback(l=>{var ne,xe;const i=V(j);if(!i)return;const z=$.find(oe=>{const N=V(oe.target);return(N==null?void 0:N.type)==="imagePreview"});if(z){const oe=z.target;me(N=>N.map(h=>h.id===oe?{...h,data:{...h.data,imageUrl:l}}:h));return}const D=Date.now(),X=`preview-${j}-${D}`,W={id:X,type:"imagePreview",position:{x:(((ne=i==null?void 0:i.position)==null?void 0:ne.x)||0)+450,y:((xe=i==null?void 0:i.position)==null?void 0:xe.y)||0},data:{imageUrl:l,width:400}};setTimeout(()=>{me(N=>[...N,W]);const oe={id:`edge-${j}-${X}`,source:j,target:X,targetHandle:`${X}-target`,type:"aurora"};T(N=>N.find(E=>E.source===j&&E.target===X)?N:[...N,oe])},100)},[j,V,me,T,$]),b=t.useRef({active:!1,timeoutId:null}),d=t.useCallback(async l=>{let z=0;b.current.timeoutId&&clearTimeout(b.current.timeoutId),b.current.active=!0;const D=async()=>{if(b.current.active)try{z++;const W=(await Ce.tasks.getTaskStatus(l)).task;if(!b.current.active)return;if(U(W.progress||0),W.status==="SUCCESS"){b.current.active=!1,de(!1),U(100);const ne=W.resultUrl;v({generatedImageUrl:ne,taskId:""}),pe(ne),m.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ne&&r(ne);return}else if(W.status==="FAILURE"){b.current.active=!1,de(!1),U(0),v({taskId:""}),m.error(W.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(W.status==="PROCESSING"||W.status==="PENDING")&&(z<300&&b.current.active?b.current.timeoutId=setTimeout(D,1e3):(b.current.active=!1,de(!1),U(0),v({taskId:""}),m.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{b.current.active=!1,de(!1),U(0),v({taskId:""}),m.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};D()},[v,r]);t.useEffect(()=>()=>{b.current.active=!1,b.current.timeoutId&&clearTimeout(b.current.timeoutId)},[]),t.useEffect(()=>{const l=s.taskId;if(!l)return;(async()=>{try{const D=(await Ce.tasks.getTaskStatus(l)).task;if(D.status==="SUCCESS"){de(!1),U(100);const X=D.resultUrl;X?(v({generatedImageUrl:X,taskId:""}),pe(X),m.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):v({taskId:""})}else D.status==="PROCESSING"||D.status==="PENDING"?(de(!0),U(D.progress||0),d(l)):D.status==="FAILURE"&&(de(!1),U(0),v({taskId:""}),m.error(D.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${D.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{de(!1),U(0),v({taskId:""})}})()},[]);const a=t.useCallback(l=>{const i=new Image;i.onload=()=>{te({width:i.naturalWidth,height:i.naturalHeight})},i.src=l},[]);t.useEffect(()=>{try{const l=[];fe.forEach(i=>{var W,ne,xe,oe;const z=V(i.source);if(!z)return;const D=z.data;let X=null;D!=null&&D.url?X=D.url:D!=null&&D.imageUrl?X=D.imageUrl:D!=null&&D.output?X=D.output:(W=D==null?void 0:D.config)!=null&&W.generatedImageUrl?X=D.config.generatedImageUrl:(oe=(xe=(ne=D==null?void 0:D.config)==null?void 0:ne.uploadedFiles)==null?void 0:xe[0])!=null&&oe.url&&(X=D.config.uploadedFiles[0].url),X&&l.push(X)}),l.length>0?(ie(l[0]),ge(l.slice(1)),a(l[0])):(ie(null),ge([]),te(null))}catch{}},[fe,V,a]),t.useEffect(()=>{const l=setTimeout(()=>{me(i=>i.map(z=>{if(z.id!==j)return z;const D=z.data;return D.prompt===K&&JSON.stringify(D.points)===JSON.stringify(Y)?z:{...z,data:{...z.data,prompt:K,points:Y}}}))},300);return()=>clearTimeout(l)},[K,Y,j,me]);const w=t.useCallback(l=>{if(!l.ctrlKey&&!l.metaKey||!R.current)return;const i=R.current.getBoundingClientRect(),z=(l.clientX-i.left)/i.width,D=(l.clientY-i.top)/i.height,X={id:L.current++,x:Math.max(0,Math.min(1,z)),y:Math.max(0,Math.min(1,D))};ce(W=>[...W,X])},[]),c=t.useCallback(l=>{ce(i=>i.filter(z=>z.id!==l))},[]),p=t.useCallback((l,i)=>{ce(z=>z.map(D=>D.id===l?{...D,name:i}:D))},[]),g=t.useCallback((l,i)=>{l.stopPropagation();const z=i.name?`@${i.name}`:`@ä½ç½®${i.id}`;l.dataTransfer.setData("text/plain",z),l.dataTransfer.effectAllowed="copy"},[]),y=t.useCallback((l,i)=>{l.stopPropagation();const z=`@å‚è€ƒå›¾${i+1}`;l.dataTransfer.setData("text/plain",z),l.dataTransfer.effectAllowed="copy"},[]),C=t.useCallback(l=>{l.preventDefault(),l.stopPropagation(),l.dataTransfer.dropEffect="copy"},[]),O=t.useCallback(l=>{l.preventDefault(),l.stopPropagation();const i=l.dataTransfer.getData("text/plain");if(i){const z=l.target,D=z.selectionStart,X=z.selectionEnd,W=K.slice(0,D)+i+K.slice(X);re(W),setTimeout(()=>{z.selectionStart=z.selectionEnd=D+i.length,z.focus()},0)}},[K]),I=t.useCallback(async()=>{var l;if(!(!je||Y.length===0)){ae(!0);try{const i=await Ce.ai.imageEditing.identifyPoints({image:je,points:Y.map(z=>({id:z.id,x:z.x,y:z.y}))});if(i.success&&((l=i.data)!=null&&l.points)){const z=i.data.points;ce(D=>D.map(X=>{const W=z.find(ne=>ne.id===X.id);return W?{...X,name:W.name}:X})),m.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{m.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{ae(!1)}}},[je,Y]),u=t.useCallback(async()=>{var l,i,z,D,X;if(!je){m.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!K.trim()){m.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}de(!0),U(0);try{const W=await Ce.tasks.createImageEditTask({prompt:K.trim(),mainImage:je,referenceImages:be.length>0?be:void 0,points:Y.length>0?Y:void 0,sourceImageDimensions:Ie||void 0,sourceNodeId:j}),ne=W.taskId,xe=W.creditsCharged||0,oe=W.isFreeUsage,N=W.freeUsageRemaining??0;if(Z(ne),v({prompt:K.trim(),points:Y,taskId:ne}),oe)m.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${N} æ¬¡æœºä¼š`),G();else if(xe>0){const{useAuthStore:h}=await ds(async()=>{const{useAuthStore:k}=await import("./index-Cwo4xSFf.js").then(J=>J.f);return{useAuthStore:k}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:E}=h.getState();await E(),m.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${xe} ç§¯åˆ†`),G()}else m.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");d(ne)}catch(W){if(de(!1),U(0),((l=W.response)==null?void 0:l.status)===403){const ne=((z=(i=W.response)==null?void 0:i.data)==null?void 0:z.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";m.error(ne)}else{const ne=((X=(D=W.response)==null?void 0:D.data)==null?void 0:X.error)||W.message||"æœªçŸ¥åŸå› ";m.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ne}ï¼Œè¯·ç¨åé‡è¯•`)}}},[je,K,be,Y,Ie,j,v,d,G]);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Hr,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:R,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:w,children:je?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:je,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),Y.map(l=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-neutral-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${l.x*100}%`,top:`${l.y*100}%`},onClick:i=>{i.stopPropagation(),c(l.id)},title:l.name||`ç‚¹å‡»åˆ é™¤ #${l.id}`,children:l.id},l.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Er,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),be.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[be.map((l,i)=>e.jsx("img",{src:l,alt:`Ref ${i+1}`,draggable:!0,onDragStart:z=>y(z,i),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},i)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",be.length," å‚è€ƒå›¾"]})]}),Y.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",Y.length,")"]}),e.jsxs("button",{onClick:I,disabled:ee||!je,className:"text-[10px] text-neutral-500 hover:text-neutral-600 flex items-center gap-1",children:[ee?e.jsx(Ds,{className:"w-3 h-3 animate-spin"}):e.jsx(mr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:Y.map(l=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:i=>g(i,l),className:"w-5 h-5 bg-neutral-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:l.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:l.name||"",onChange:i=>p(l.id,i.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>c(l.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Br,{className:"w-3 h-3"})})]},l.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:K,onChange:l=>re(l.target.value),onDragOver:C,onDrop:O,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:u,onPointerDown:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),disabled:Re||!je||!K.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Re||!je||!K.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Re?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!x&&(_?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(F),"æ¬¡"]}):f!==null&&f>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[f,"ç§¯åˆ†"]}):null)]})})]})]})},en=t.memo(Zo);async function dr(s){const{resultUrl:j,allImageUrls:n}=s;return{displayUrl:j,allDisplayUrls:n,isLocalStored:!1,originalUrl:j}}const tn="gemini-3-pro-image-preview",sn=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],rn=s=>{const[j,n]=s.split(":").map(Number);return j/n},an=(s,j)=>{const n=s/j;let V="1:1",me=1/0;for(const T of sn){const fe=rn(T),K=Math.abs(n-fe);K<me&&(me=K,V=T)}return V},on=s=>new Promise((j,n)=>{const V=new Image;V.onload=()=>{j({width:V.naturalWidth,height:V.naturalHeight})},V.onerror=n,V.src=s}),nn=({data:s,selected:j,id:n})=>{const[V,me]=t.useState(s.config.imageSize||"2K"),[T,fe]=t.useState(s.config.inputImage),[K,re]=t.useState(!!s.config.taskId),[Y,ce]=t.useState(null),Re=t.useMemo(()=>{const L=s.models||[];return L.find(f=>f.modelId===tn)||L.find(f=>{var x;return(x=f.modelId)==null?void 0:x.includes("gemini")})||L[0]},[s.models]),{credits:de,loading:ee,isFreeUsage:ae,freeUsageRemaining:je}=Ss({nodeType:"hd_upscale",quantity:1,resolution:V});t.useEffect(()=>{Re&&ce(Re)},[Re]);const{setNodes:ie,setEdges:be,getNode:ge,getNodes:pe}=Qt(),Ie=Fs(L=>L.edges.filter(f=>f.target===n));t.useEffect(()=>{const L=pe();let f;Ie.forEach(x=>{var F,G,v,$,r,b;const _=L.find(d=>d.id===x.source);if(_){const d=((F=_.data)==null?void 0:F.imageUrl)||((v=(G=_.data)==null?void 0:G.config)==null?void 0:v.generatedImageUrl)||((r=($=_.data)==null?void 0:$.config)==null?void 0:r.imageUrl)||((b=_.data)==null?void 0:b.url);d&&(f=d)}}),f!==T&&(fe(f),te({inputImage:f}))},[Ie,pe]),t.useEffect(()=>{const L=s.config.taskId;(async()=>{if(L)try{const _=(await Ce.tasks.getTaskStatus(L)).task;if(_.status==="SUCCESS"){re(!1);const F=_.resultUrl;if(!F){te({taskId:""});return}const v=(await dr({taskId:L,resultUrl:F,type:"IMAGE"})).displayUrl;te({generatedImageUrl:v,taskId:""})}else _.status==="PROCESSING"||_.status==="PENDING"?(re(!0),U(L)):_.status==="FAILURE"&&(re(!1),te({taskId:""}),$s.error(`ç”Ÿæˆå¤±è´¥: ${_.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{re(!1),te({taskId:""}),$s.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const te=L=>{ie(f=>f.map(x=>x.id===n?{...x,data:{...x.data,config:{...x.data.config,...L}}}:x))},Z=async()=>{var L;if(!T){$s.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}re(!0);try{const f=await ur(T);let x="1:1";try{const $=await on(T);x=an($.width,$.height)}catch{}let _="";try{const $=await Ce.get("/node-prompts/type/hdUpscale");$.success&&((L=$.data)!=null&&L.userPromptTemplate)&&(_=$.data.userPromptTemplate)}catch{}if(_||(_="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),_=`${_}ï¼Œç”Ÿæˆ${x}æ¯”ä¾‹çš„å›¾ç‰‡`,!Y){$s.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),re(!1);return}const F=await Ce.tasks.createImageTask({modelId:Y.id,prompt:_,ratio:x,referenceImages:[f],sourceNodeId:n,metadata:{imageSize:V,nodeType:"hd_upscale"}});if(!F.success)throw new Error(F.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const G=F.taskId,v=F.creditsCharged||0;if(te({taskId:G}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),v>0){const{useAuthStore:$}=await ds(async()=>{const{useAuthStore:b}=await import("./index-Cwo4xSFf.js").then(d=>d.f);return{useAuthStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:r}=$.getState();await r(),$s.success(`âœ¨ é«˜æ¸…æ”¾å¤§å·²å¼€å§‹ï¼Œæ¶ˆè€— ${v} ç§¯åˆ†`)}U(G)}catch(f){$s.error(f.message||"ç”Ÿæˆå¤±è´¥"),re(!1)}},U=async L=>{let x=0;const _=async()=>{try{const G=(await Ce.tasks.getTaskStatus(L)).task;if(G.status==="SUCCESS"){re(!1);const v=G.resultUrl;if(!v){$s.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const r=(await dr({taskId:L,resultUrl:v,type:"IMAGE"})).displayUrl;te({generatedImageUrl:r,taskId:"",imageSize:V}),R(r),$s.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else G.status==="FAILURE"?(re(!1),te({taskId:""}),$s.error(`ç”Ÿæˆå¤±è´¥: ${G.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(G.status==="PROCESSING"||G.status==="PENDING")&&(x++,x<300?setTimeout(_,2e3):(re(!1),$s.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{re(!1),$s.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};_()},R=L=>{const f=ge(n);if(!f)return;const F=pe().filter(b=>b.id.startsWith(`${n}-preview`)&&b.type==="imagePreview").length,$={id:`${n}-preview-${Date.now()}`,type:"imagePreview",position:{x:f.position.x+380,y:f.position.y+F*(220+20)},data:{imageUrl:L,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:n,createdBy:f.data.createdBy}},r={id:`edge-${n}-to-${$.id}`,source:n,target:$.id,sourceHandle:`${n}-source`,type:"aurora"};ie(b=>[...b,$]),be(b=>[...b,r])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(gs,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:T,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{me("2K"),te({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${V==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{me("4K"),te({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${V==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:Z,onPointerDown:L=>L.stopPropagation(),onMouseDown:L=>L.stopPropagation(),disabled:K||!T||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${K||!T?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:K?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"}),!ee&&(ae?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(je),"æ¬¡"]}):de!==null&&de>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[de,"ç§¯åˆ†"]}):null)]})})]})]})},ln=t.memo(nn),Xr=async(s,j,n)=>new Promise((V,me)=>{const T=new Image;T.crossOrigin="Anonymous",T.onload=()=>{try{const fe=T.width,K=T.height,re=Math.floor(fe/n),Y=Math.floor(K/j),ce=[],Re=document.createElement("canvas");Re.width=re,Re.height=Y;const de=Re.getContext("2d");if(!de){me(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let ee=0;ee<j;ee++)for(let ae=0;ae<n;ae++)de.clearRect(0,0,re,Y),de.drawImage(T,ae*re,ee*Y,re,Y,0,0,re,Y),ce.push(Re.toDataURL("image/png"));V({slices:ce,fullImage:s,rows:j,cols:n})}catch(fe){me(fe)}},T.onerror=()=>{me(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),T.src=s}),zr=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},cn=(s,j="image/png")=>{const n=s.includes(",")?s.split(",")[1]:s,V=atob(n),me=new Array(V.length);for(let fe=0;fe<V.length;fe++)me[fe]=V.charCodeAt(fe);const T=new Uint8Array(me);return new Blob([T],{type:j})},dn=({data:s,selected:j,id:n})=>{const[V,me]=t.useState(null),T="single",[fe,K]=t.useState(s.config.aspectRatio||"16:9"),[re,Y]=t.useState(s.config.imageSize||"4K"),[ce,Re]=t.useState(s.config.userPrompt||""),[de,ee]=t.useState(!!s.config.taskId),[ae,je]=t.useState(s.config.characterImages||[]),[ie,be]=t.useState(s.config.sceneImages||[]),[ge,pe]=t.useState(s.config.styleImage),Ie=t.useRef(null),{setNodes:te,setEdges:Z,getNode:U,getNodes:R,getEdges:L}=Qt(),f=Fs(I=>I.edges.filter(u=>u.target===n)),x=Fs(I=>I.edges.some(u=>u.target===n&&u.targetHandle===`${n}-scene-input`)),_=Fs(I=>I.edges.some(u=>u.target===n&&u.targetHandle===`${n}-style-input`)),F=t.useRef(""),{credits:G,loading:v,isFreeUsage:$,freeUsageRemaining:r}=Ss({nodeType:"image_fusion",quantity:1,resolution:re}),b="gemini-3-pro-image-preview",d=t.useMemo(()=>{const I=s.models||[];return I.find(u=>u.modelId===b)||I.find(u=>{var l;return(l=u.modelId)==null?void 0:l.includes("gemini")})||I[0]},[s.models]);t.useEffect(()=>{d&&me(d)},[d]),t.useEffect(()=>{const I=s.config.taskId,u=s.config.generatedImageUrl;(async()=>{if(I)try{const z=(await Ce.tasks.getTaskStatus(I)).task;if(z.status==="SUCCESS"){ee(!1);const D=z.resultUrl;if(!D){a({taskId:""}),m.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let X=D;u?X=u:X=(await dr({taskId:I,resultUrl:D,type:"IMAGE"})).displayUrl,a({generatedImageUrl:X,taskId:""});const W=R(),ne=L();if(W.filter(N=>N.type==="imagePreview"&&ne.some(h=>h.source===n&&h.target===N.id)).find(N=>N.data.imageUrl===X||N.data.imageUrl===D)){m.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}m.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),C(X,fe,0)}else z.status==="PROCESSING"||z.status==="PENDING"?(ee(!0),g(I)):z.status==="FAILURE"&&(ee(!1),a({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${z.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ee(!1),a({taskId:""}),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ie.current&&ce){const I=Ie.current;I.style.height="auto",I.style.height=`${I.scrollHeight}px`}},[]);const a=I=>{te(u=>u.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,...I}}}:l))};t.useEffect(()=>{const I=JSON.stringify(f.map(z=>({source:z.source,sourceHandle:z.sourceHandle,targetHandle:z.targetHandle})));if(I===F.current)return;F.current=I;const u=[],l=[];let i;f.forEach(z=>{const D=U(z.source);if(!D)return;const X=z.targetHandle||"",W=w(D);X.includes("character")?u.push(...W):X.includes("scene")?l.length===0&&W.length>0&&l.push(W[0]):X.includes("style")&&W.length>0&&(i=W[0])}),je(u),be(l),pe(i),a({characterImages:u,sceneImages:l,styleImage:i})},[f,U]);const w=I=>{var i,z,D,X;const u=(I==null?void 0:I.type)||"",l=I==null?void 0:I.data;if(u==="upload"&&((i=l==null?void 0:l.config)!=null&&i.uploadedFiles))return l.config.uploadedFiles.filter(W=>{var ne;return W.type==="IMAGE"||((ne=W.mimeType)==null?void 0:ne.startsWith("image/"))}).map(W=>W.url||W.localUrl);if(u==="assetSelector"&&((z=l==null?void 0:l.config)!=null&&z.selectedAsset)){const W=l.config.selectedAsset;if(W.type==="IMAGE"||(D=W.mimeType)!=null&&D.startsWith("image/"))return[W.url]}return u==="imagePreview"&&(l!=null&&l.imageUrl)?[l.imageUrl]:u==="aiImage"&&((X=l==null?void 0:l.config)!=null&&X.generatedImageUrl)?[l.config.generatedImageUrl]:[]},c=()=>{let I=ce;if(ge){const u=ae.length+ie.length+1;I+=`ï¼Œå‚è€ƒå›¾ç‰‡${u}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${u}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return I+=`ï¼Œç”Ÿæˆ${fe}æ¯”ä¾‹çš„å›¾ç‰‡`,I},p=async()=>{if(!ce.trim()){m.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!V){m.error("è¯·é€‰æ‹©æ¨¡å‹");return}ee(!0);try{const I=c(),u=[...ae,...ie,...ge?[ge]:[]],l=await Promise.all(u.map(async X=>{try{return await ur(X)}catch{return X}})),i=await Ce.tasks.createImageTask({modelId:V.id,prompt:I,ratio:fe,referenceImages:l.filter(Boolean),sourceNodeId:n,metadata:{imageSize:re,nodeType:"image_fusion"}});if(!i.success)throw new Error(i.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const z=i.taskId,D=i.creditsCharged||0;if(a({taskId:z}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),D>0){const{useAuthStore:X}=await ds(async()=>{const{useAuthStore:ne}=await import("./index-Cwo4xSFf.js").then(xe=>xe.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:W}=X.getState();await W(),m.success(`âœ¨ æ™ºèƒ½æº¶å›¾å·²å¼€å§‹ï¼Œæ¶ˆè€— ${D} ç§¯åˆ†`)}g(z)}catch(I){m.error(I.message||"ç”Ÿæˆå¤±è´¥"),ee(!1)}},g=async I=>{let l=0;const i=async()=>{try{const D=(await Ce.tasks.getTaskStatus(I)).task;if(D.status==="SUCCESS"){ee(!1);const X=D.resultUrl;if(!X){m.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ne=(await dr({taskId:I,resultUrl:X,type:"IMAGE"})).displayUrl;a({generatedImageUrl:ne,taskId:"",modelId:V==null?void 0:V.id,mode:T,aspectRatio:fe,imageSize:re,userPrompt:ce}),T!=="single"||C(ne,fe,0),m.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else D.status==="FAILURE"?(ee(!1),a({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${D.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(D.status==="PROCESSING"||D.status==="PENDING")&&(l++,l<300?setTimeout(i,2e3):(ee(!1),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ee(!1),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};i()},y=async I=>{try{const{rows:u,cols:l}=zr(T),i=await Xr(I,u,l);a({slicedImages:i.slices}),i.slices.forEach((z,D)=>{C(z,fe,D)})}catch(u){m.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+u.message)}},C=(I,u,l)=>{const i=U(n);if(!i)return;const{rows:z,cols:D}=zr(T),X=z*D,W=280,ne=320,xe=20,oe=l%D,N=Math.floor(l/D),h=i.position.x+400,E=i.position.y-(X-1)*(ne+xe)/2,k={id:`${n}-preview-${l}-${Date.now()}`,type:"imagePreview",position:{x:h+oe*(W+xe),y:E+N*(ne+xe)},data:{imageUrl:I,ratio:u,label:`æº¶å›¾ ${l+1}`,fromStoryboard:!0,sourceNodeId:n}},J={id:`edge-${n}-to-${k.id}`,source:n,target:k.id,sourceHandle:`${n}-source`,type:"aurora"};te(ue=>[...ue,k]),Z(ue=>[...ue,J])},O=ae.length+ie.length+(ge?1:0);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["è§’è‰² ",ae.length>0&&`(${ae.length})`]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["åœºæ™¯ ",ie.length>0?"âœ“":""]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!x})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["é£æ ¼ ",ge?"âœ“":""]}),e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!_})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(hs,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[O>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",O,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let I=1;const u=[];return ae.forEach(l=>{u.push({url:l,type:"char",index:I++})}),ie.forEach(l=>{u.push({url:l,type:"scene",index:I++})}),ge&&u.push({url:ge,type:"style",index:I++}),u.map(l=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:l.url,alt:`å›¾${l.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:l.index})]},`${l.type}-${l.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{Y("2K"),a({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{Y("4K"),a({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(I=>e.jsx("button",{onClick:()=>{K(I),a({aspectRatio:I})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${fe===I?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:I},I))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ie,value:ce,onChange:I=>{Re(I.target.value),a({userPrompt:I.target.value});const u=I.target;u.style.height="auto",u.style.height=`${u.scrollHeight}px`},onFocus:I=>{const u=I.target;u.style.height="auto",u.style.height=`${u.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:p,onPointerDown:I=>I.stopPropagation(),onMouseDown:I=>I.stopPropagation(),disabled:de||!ce.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${de||!ce.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:de?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(mr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!v&&($?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(r),"æ¬¡"]}):G!==null&&G>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[G,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(gs,{type:"source",position:ut.Right,id:`${n}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},un=t.memo(dn),gn=["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"],hn="gemini-3-pro-preview",fn="gemini-3-pro-image-preview",Sr=5,pn=({data:s,selected:j,id:n})=>{const[V,me]=t.useState(s.config.aspectRatio||"1:1"),[T,fe]=t.useState(s.config.inputImages||[]),[K,re]=t.useState(s.config.userPrompt||""),[Y,ce]=t.useState(!!s.config.taskId),[Re,de]=t.useState(null),[ee,ae]=t.useState(null),je=t.useMemo(()=>{const v=s.models||[];return v.find($=>$.modelId===fn)||v.find($=>{var r;return(r=$.modelId)==null?void 0:r.includes("gemini")})||v[0]},[s.models]);t.useEffect(()=>{je&&ae(je)},[je]);const{setNodes:ie,setEdges:be,getNode:ge,getNodes:pe}=Qt(),Ie=t.useRef(null),te=t.useRef(null),Z=t.useRef(null),U=t.useRef(pe),R=Fs(v=>v.edges.filter($=>$.target===n)),L=t.useRef("");t.useEffect(()=>{const v=pe(),$=[];R.forEach(b=>{var a,w,c,p,g,y,C,O;if($.length>=Sr)return;const d=v.find(I=>I.id===b.source);if(d){const I=(w=(a=d.data)==null?void 0:a.config)==null?void 0:w.uploadedFiles;Array.isArray(I)&&I.forEach(l=>{$.length>=Sr||l!=null&&l.url&&!$.includes(l.url)&&$.push(l.url)});const u=((c=d.data)==null?void 0:c.imageUrl)||((g=(p=d.data)==null?void 0:p.config)==null?void 0:g.generatedImageUrl)||((C=(y=d.data)==null?void 0:y.config)==null?void 0:C.imageUrl)||((O=d.data)==null?void 0:O.url);u&&!$.includes(u)&&$.push(u)}});const r=$.join(",");r!==L.current&&(L.current=r,fe($),f({inputImages:$}))},[R,pe]),t.useEffect(()=>{const v=s.config.taskId,r=setTimeout(async()=>{var b,d,a,w;if(v)try{const p=(await Ce.tasks.getTaskStatus(v)).task;if(p.status==="SUCCESS"){ce(!1),de(null);const g=p.resultUrl;if(!g){(b=te.current)==null||b.call(te,{taskId:""});return}const C=(await dr({taskId:v,resultUrl:g,type:"IMAGE"})).displayUrl;(d=te.current)==null||d.call(te,{generatedImageUrl:C,taskId:""}),!U.current().some(u=>{var l;return((l=u.data)==null?void 0:l.sourceNodeId)===n&&u.type==="imagePreview"})&&Ie.current&&await Ie.current(C),m.success("åˆ†é•œç”Ÿæˆå·²å®Œæˆï¼")}else p.status==="PROCESSING"||p.status==="PENDING"?(ce(!0),de("image"),setTimeout(()=>{var g;(g=Z.current)==null||g.call(Z,v)},100)):p.status==="FAILURE"&&(ce(!1),de(null),(a=te.current)==null||a.call(te,{taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${p.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ce(!1),de(null),(w=te.current)==null||w.call(te,{taskId:""}),m.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}},200);return()=>clearTimeout(r)},[]);const f=v=>{ie($=>$.map(r=>r.id===n?{...r,data:{...r.data,config:{...r.data.config,...v}}}:r))};te.current=f,U.current=pe;const x=async()=>{var v,$;if(T.length===0){m.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!K.trim()){m.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}ce(!0),de("text");try{const r=await Promise.all(T.map(y=>ur(y))),b="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",d="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚",a=await Ce.ai.text.generate({modelId:hn,systemPrompt:b,prompt:K,imageUrls:r});if(!a.success)throw new Error(a.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const w=((v=a.data)==null?void 0:v.text)||(($=a.data)==null?void 0:$.content)||a.content;if(!w||typeof w!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(de("image"),!ee){m.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),ce(!1),de(null);return}const c=`${d}

åˆ†é•œæè¿°ï¼š
${w}

ç”Ÿæˆ${V}æ¯”ä¾‹çš„å›¾ç‰‡`,p=await Ce.tasks.createImageTask({modelId:ee.id,prompt:c,ratio:V,referenceImages:r,sourceNodeId:n,metadata:{imageSize:"4K"}});if(!p.success)throw new Error(p.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const g=p.taskId;f({taskId:g,userPrompt:K}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},500),_(g)}catch(r){m.error(r.message||"ç”Ÿæˆå¤±è´¥"),ce(!1),de(null)}},_=async v=>{let r=0;const b=async()=>{try{const a=(await Ce.tasks.getTaskStatus(v)).task;if(a.status==="SUCCESS"){ce(!1),de(null);const w=a.resultUrl;if(!w){m.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const p=(await dr({taskId:v,resultUrl:w,type:"IMAGE"})).displayUrl;f({generatedImageUrl:p,taskId:"",aspectRatio:V}),await F(p),m.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else a.status==="FAILURE"?(ce(!1),de(null),f({taskId:""}),m.error(`ç”Ÿæˆå¤±è´¥: ${a.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(a.status==="PROCESSING"||a.status==="PENDING")&&(r++,r<300?setTimeout(b,2e3):(ce(!1),de(null),m.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ce(!1),de(null),m.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};b()};Z.current=_;const F=async v=>{var $;try{let r=v;if(!v.startsWith("data:"))try{const c=await Ce.assets.proxyDownload(v),p=new Blob([c],{type:"image/png"});r=await new Promise((g,y)=>{const C=new FileReader;C.onloadend=()=>g(C.result),C.onerror=y,C.readAsDataURL(p)})}catch{}const b=await Xr(r,3,3),d=[],a=[],w=3e4;for(let c=0;c<b.slices.length;c++)try{const p=b.slices[c],g=cn(p,"image/png"),y=`storyboard_${n}_slice_${c+1}_${Date.now()}.png`,C=document.createElement("a");C.href=p,C.download=y,C.click();const O=new File([g],y,{type:"image/png"}),I=Ce.assets.upload(O),u=new Promise((i,z)=>setTimeout(()=>z(new Error("ä¸Šä¼ è¶…æ—¶")),w)),l=await Promise.race([I,u]);l.success&&(($=l.data)!=null&&$.url)?d.push(l.data.url):a.push(c+1)}catch{a.push(c+1)}f({slicedImages:d}),a.length>0?m.error(`åˆ†é•œ ${a.join(", ")} ä¸Šä¼ å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°`):m.success(`æˆåŠŸä¿å­˜ ${d.length} ä¸ªåˆ†é•œåˆ°æœ¬åœ°`),G(d,V)}catch(r){m.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+r.message)}};Ie.current=F;const G=(v,$)=>{const r=ge(n);if(!r)return;const b=220,d=20,a=Date.now(),w=r.position.x+350,c=v.length*b+(v.length-1)*d,p=r.position.y-c/2+150,g=[],y=[];v.forEach((C,O)=>{const I={id:`${n}-slice-${a}-${O}`,type:"imagePreview",position:{x:w,y:p+O*(b+d)},data:{imageUrl:C,ratio:$,label:`åˆ†é•œ ${O+1}`,fromStoryboard:!0,sourceNodeId:n,createdBy:r.data.createdBy}},u={id:`edge-${n}-to-slice-${a}-${O}`,source:n,target:I.id,sourceHandle:`${n}-source`,type:"aurora"};g.push(I),y.push(u)}),ie(C=>[...C,...g]),be(C=>[...C,...y]),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},100)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(gs,{type:"target",position:ut.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(gs,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",T.length,"/",Sr,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:T.map((v,$)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:v,alt:`å›¾ç‰‡${$+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:$+1})]},$))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:K,onChange:v=>{re(v.target.value),f({userPrompt:v.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:gn.map(v=>e.jsx("button",{onClick:()=>{me(v),f({aspectRatio:v})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${V===v?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:v},v))})]}),e.jsx("button",{type:"button",onClick:v=>{v.stopPropagation(),x()},disabled:Y,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Y?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Y?e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Re==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"})]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},mn=t.memo(pn),xn="https://api.waule.ai",bn=({isOpen:s,onClose:j,onAssetSelect:n})=>{const[V,me]=t.useState([]),[T,fe]=t.useState(""),[K,re]=t.useState([]),[Y,ce]=t.useState([]),[Re,de]=t.useState(!1),[ee,ae]=t.useState("ALL"),[je,ie]=t.useState("ALL");t.useEffect(()=>{s&&be()},[s]),t.useEffect(()=>{T&&pe(T)},[T]),t.useEffect(()=>{if(!s)return;const Z=je==="ALL"?V:V.filter(U=>(U.category||"OTHER")===je);fe(Z.length>0?Z[0].id:"")},[je,V,s]);const be=async()=>{try{const U=(await Ce.assetLibraries.getAll({includeShared:"true"})).data||[];if(me(U),U.length>0&&!T){const R=je==="ALL"?U:U.filter(L=>(L.category||"OTHER")===je);fe((R[0]||U[0]).id)}}catch{m.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const Z=U=>{var L;const R=((L=U==null?void 0:U.detail)==null?void 0:L.libraryId)||T;be(),R&&pe(R)};return window.addEventListener("asset-library-updated",Z),()=>window.removeEventListener("asset-library-updated",Z)},[T]);const ge=Z=>(/^https?:\/\//.test(Z)?Z:`${xn}${Z}`).replace(".oss-oss-",".oss-"),pe=async Z=>{var U,R,L,f,x;de(!0);try{const _=V.find(G=>G.id===Z);if(_&&(_.category||"OTHER")==="ROLE"){const v=(await Ce.assetLibraries.roles.list(Z)).data||[],$=[];for(const r of v){const b=r.metadata||{},d=[(U=b.images)==null?void 0:U.frontAssetId,(R=b.images)==null?void 0:R.sideAssetId,(L=b.images)==null?void 0:L.backAssetId,(f=b.images)==null?void 0:f.faceAssetId].filter(Boolean),a=[];for(const c of d)try{const g=(await Ce.assets.getById(c)).data;a.push({id:g.id,url:ge(g.url),name:g.name})}catch{}const w=r.thumbnail?ge(r.thumbnail):((x=a[0])==null?void 0:x.url)||"";$.push({id:r.id,name:r.name,coverUrl:w,images:a})}ce($),re([])}else{const v=(await Ce.assetLibraries.getAssets(Z)).data||[];re(v),ce([])}}catch{m.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{de(!1)}},Ie=Z=>{fe(Z)},te=Z=>{n?(n(Z),setTimeout(()=>{be(),T&&pe(T)},0)):m.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:j}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-neutral-500/20 via-neutral-400/30 to-neutral-500/20"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:j,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:V.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(Z=>e.jsx("button",{onClick:()=>ae(Z),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${ee===Z?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:Z==="IMAGE"?"å›¾ç‰‡":Z==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},Z))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(Z=>e.jsx("button",{onClick:()=>ie(Z),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${je===Z?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:Z==="ROLE"?"è§’è‰²":Z==="SCENE"?"åœºæ™¯":Z==="PROP"?"é“å…·":Z==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},Z))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const Z=je==="ALL"?V:V.filter(U=>(U.category||"OTHER")===je);return e.jsx("select",{value:T,onChange:U=>Ie(U.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-neutral-500",children:Z.map(U=>{var R;return e.jsxs("option",{value:U.id,children:[U.isShared?`[å…±äº«] ${U.name}`:U.name," (",U._count.assets,")",U.isShared&&((R=U.owner)!=null&&R.nickname)?` - ${U.owner.nickname}`:""]},U.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Re?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const Z=V.find(L=>L.id===T);if(Z&&(Z.category||"OTHER")==="ROLE")return Y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:Y.map(L=>e.jsxs("div",{onClick:()=>n&&n(L),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[L.coverUrl?e.jsx("img",{src:L.coverUrl,alt:L.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:L.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[L.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},L.id))});const R=K.filter(L=>ee==="ALL"||L.type===ee);return R.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:R.map(L=>e.jsxs("div",{onClick:()=>te(L),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[L.type==="IMAGE"?e.jsx("img",{src:ge(L.url),alt:L.name,className:"w-full h-full object-cover"}):L.type==="VIDEO"?e.jsx("video",{src:ge(L.url),className:"w-full h-full object-cover"}):L.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:L.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:L.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:L.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(L.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:L.type==="IMAGE"?"image":L.type==="VIDEO"?"video_file":L.type==="AUDIO"?"audio_file":"description"})})]},L.id))})})()})]})})]})]}):null},wn={agent:xo,aiImage:Ka,aiVideo:gr,soraVideo:_o,soraCharacter:Uo,aiVideo_t2v:Za,aiVideo_i2v_first:to,aiVideo_i2v_last:ro,aiVideo_first_last:oo,aiVideo_reference:io,aiVideo_swap:co,aiVideo_lipsync:go,aiVideo_style:po,upload:wo,assetSelector:ko,imagePreview:No,videoPreview:Io,textPreview:Eo,midjourney:Co,audioVoice:$o,voiceClone:Do,audioSynthesize:Po,audioDesign:Fo,audioPreview:Vo,superCanvas:Bo,videoUpscale:Xo,commercialVideo:qo,textAnnotation:Qo,imageEditing:en,hdUpscale:ln,imageFusion:un,smartStoryboard:mn},yn={aurora:Oo},kn=()=>{const{id:s,projectId:j,episodeId:n,workflowId:V}=xa(),me=!!V,T=ba(),fe=Cr(),K=t.useMemo(()=>new URLSearchParams(fe.search),[fe.search]),re=t.useMemo(()=>{const o=Number(K.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[K]),Y=t.useMemo(()=>{const o=Number(K.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[K]),ce=t.useMemo(()=>{try{const o=K.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[K]),{screenToFlowPosition:Re,setCenter:de,getViewport:ee,fitView:ae}=Qt(),{setTitle:je}=ya(),ie=Ar(o=>o.user),[be,ge]=t.useState(null),[pe,Ie]=t.useState(null),[te,Z]=t.useState(!0),[U,R,L]=Na([]),[f,x,_]=ja([]),[F,G]=t.useState(!1),v=t.useRef(!1),[$,r]=t.useState(null),[b,d]=t.useState(null),[a,w]=t.useState(!0),c=t.useRef(null),[p,g]=t.useState(!1),y=t.useRef(null),C=t.useRef(null),[O,I]=t.useState(!1),[u,l]=t.useState(null),[i,z]=t.useState([]),[D,X]=t.useState([]),[W,ne]=t.useState(null),[xe,oe]=t.useState(null),N=t.useRef(null),h=t.useRef(null),E=W==="video",k=W==="edit",J=W==="imageEdit",ue=o=>ne(null),B=o=>ne(o?"video":null),he=o=>ne(o?"edit":null),Ee=o=>ne(o?"imageEdit":null),Ne=N,$e=xe==="agent",Ae=o=>oe(o?"agent":null),_e=h,Te=h,le=t.useCallback(o=>{const S=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return S?S.includes("æ–‡ç”Ÿ")||S.includes("text to video")||S.includes("t2v")||S.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":S.includes("é¦–å°¾")||S.includes("first last")||S.includes("two frame")||S.includes("frame pair")||S.includes("first-last")?"é¦–å°¾å¸§":S.includes("é¦–å¸§")||S.includes("first frame")||S.includes("start frame")||S.includes("initial frame")||S.includes("keyframe")?"é¦–å¸§":S.includes("å°¾å¸§")||S.includes("last frame")||S.includes("end frame")||S.includes("final frame")?"å°¾å¸§":S.includes("ä¸»ä½“å‚è€ƒ")||S.includes("subject reference")||S.includes("å‚è€ƒ")||S.includes("reference image")||S.includes("image reference")||S.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ve=t.useMemo(()=>{const o=new Set;return(i||[]).filter(M=>(M.type||"")==="VIDEO_GENERATION").forEach(M=>{var Q;(Array.isArray((Q=M==null?void 0:M.config)==null?void 0:Q.supportedGenerationTypes)?M.config.supportedGenerationTypes:[]).forEach(ke=>{const De=le(ke);De&&o.add(De)})}),o},[i,le]),et=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Ft=t.useCallback(o=>{const S=(i||[]).filter(Q=>(Q.type||"")==="VIDEO_EDITING").filter(Q=>{var ke;return Array.isArray((ke=Q==null?void 0:Q.config)==null?void 0:ke.supportedEditingCapabilities)&&Q.config.supportedEditingCapabilities.includes(o)}),M=(i||[]).filter(Q=>(Q.type||"")==="VIDEO_GENERATION").filter(Q=>{var He,Fe;if(o!=="è§†é¢‘æ¢äºº")return!1;const ke=((He=Q==null?void 0:Q.config)==null?void 0:He.supportsVideoEditing)===!0,Pe=(Array.isArray((Fe=Q==null?void 0:Q.config)==null?void 0:Fe.supportedGenerationTypes)?Q.config.supportedGenerationTypes:[]).some(rt=>le(rt)==="è§†é¢‘æ¢äºº");return ke||Pe}),H={};return[...S,...M].forEach(Q=>{H[Q.id]||(H[Q.id]=Q)}),Object.values(H)},[i,le]),[Mt,At]=t.useState(!1),[ct,gt]=t.useState(null),vt=t.useRef(null),it=t.useRef(),[Ke,yt]=t.useState([]),[Be,wt]=t.useState(null),[Kt,vs]=t.useState(null),[Is,Es]=t.useState(!1),[Ns,Bs]=t.useState(null),[fs,Zs]=t.useState(null),[Hs,nr]=t.useState(null),_t=t.useRef([]),Xs=t.useRef(null),[bs,er]=t.useState(!1),[ws,tr]=t.useState(!1),[sr,rr]=t.useState(0),Ps=t.useRef(null),q=t.useRef(null),se=t.useRef([]),Me=t.useRef([]),Ge=t.useRef(0),qe=!!n,Oe=qe&&!!re&&!!Y,tt=me?V:Oe?`${n}-${re}-${Y}`:qe?n:s,bt=Oe,[A,P]=t.useState(!1),we=t.useRef(new Set),Ue=t.useRef(new Set),Se=t.useRef(new Set),ye=t.useRef(new Set),Ze=t.useRef(new Map),st=t.useRef(new Set),kt=t.useCallback((o,S)=>{S!==c.current&&(we.current.add(o.id),R(M=>M.some(H=>H.id===o.id)?M:[...M,{...o,data:{...o.data,models:i}}]))},[i,R]),ht=t.useCallback((o,S,M)=>{M!==c.current&&(st.current.add(o),R(H=>H.map(Q=>Q.id===o?{...Q,data:{...Q.data,...S}}:Q)),setTimeout(()=>st.current.delete(o),100))},[R]),We=t.useCallback((o,S)=>{S!==c.current&&(R(M=>M.filter(H=>H.id!==o)),x(M=>M.filter(H=>H.source!==o&&H.target!==o)))},[R,x]),Dt=t.useCallback((o,S,M)=>{M!==c.current&&R(H=>H.map(Q=>Q.id===o?{...Q,position:S}:Q))},[R]),Xt=t.useCallback((o,S)=>{S!==c.current&&R(M=>M.map(H=>{const Q=o.find(ke=>ke.id===H.id);return Q?{...H,position:Q.position}:H}))},[R]),Pt=t.useCallback((o,S)=>{S!==c.current&&(Ue.current.add(o.id),x(M=>M.some(H=>H.id===o.id)?M:[...M,o]))},[x]),zt=t.useCallback((o,S)=>{S!==c.current&&x(M=>M.filter(H=>H.id!==o))},[x]),Ct=t.useCallback((o,S)=>{S!==c.current&&(yt(o),_t.current=o)},[]),{emitNodeAdd:Tt,emitNodeUpdate:Gt,emitNodeDelete:Wt,emitNodesMove:ts,emitEdgeAdd:rs,emitEdgeDelete:ys,emitGroupsUpdate:Js,onlineUsers:Cs}=Ba({workflowId:y.current,isSharedWorkflow:p,isReadOnly:F,onNodeAdd:kt,onNodeUpdate:ht,onNodeDelete:We,onNodeMove:Dt,onNodesMove:Xt,onEdgeAdd:Pt,onEdgeDelete:zt,onGroupsUpdate:Ct});t.useEffect(()=>{_t.current=Ke},[Ke]),t.useEffect(()=>{se.current=U,Ge.current=U.length},[U]),t.useEffect(()=>{Me.current=f},[f]),t.useEffect(()=>{if(!A){Se.current=new Set(U.map(Q=>Q.id));const H=new Map;U.forEach(Q=>{var ke;try{H.set(Q.id,JSON.stringify(((ke=Q.data)==null?void 0:ke.config)||{}))}catch{H.set(Q.id,"{}")}}),Ze.current=H;return}if(!p||v.current){Se.current=new Set(U.map(H=>H.id));return}const o=new Set(U.map(H=>H.id)),S=Se.current;U.forEach(H=>{var Q,ke;if(!S.has(H.id))we.current.has(H.id)||Tt(H);else if(!st.current.has(H.id))try{const De=JSON.stringify(((Q=H.data)==null?void 0:Q.config)||{}),Pe=Ze.current.get(H.id)||"{}";De!==Pe&&Gt(H.id,{config:(ke=H.data)==null?void 0:ke.config})}catch{}}),Se.current=o;const M=new Map;U.forEach(H=>{var Q;try{M.set(H.id,JSON.stringify(((Q=H.data)==null?void 0:Q.config)||{}))}catch{M.set(H.id,"{}")}}),Ze.current=M,we.current=new Set([...we.current].filter(H=>o.has(H)))},[U,p,A,Tt,Gt]),t.useEffect(()=>{if(!A){ye.current=new Set(f.map(M=>M.id));return}if(!p||v.current){ye.current=new Set(f.map(M=>M.id));return}const o=new Set(f.map(M=>M.id)),S=ye.current;f.forEach(M=>{S.has(M.id)||Ue.current.has(M.id)||rs(M)}),ye.current=o,Ue.current=new Set([...Ue.current].filter(M=>o.has(M)))},[f,p,A,rs]);const ps=t.useCallback(o=>{var Q;if(v.current)return!1;if(a)return!0;if(_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(o.id))}))return!1;if(Oe)return!0;const M=(Q=o.data)==null?void 0:Q.createdBy;return(typeof M=="object"?M==null?void 0:M.id:M)===c.current},[a,Oe]),Bt=t.useMemo(()=>{const o=new Set(Ke.filter(S=>!S.hidden).flatMap(S=>S.nodeIds||[]));return U.map(S=>{const M=o.has(S.id),H=M?!1:a?!0:ps(S);return{...S,draggable:S.draggable!==!1,connectable:M?!1:S.connectable!==!1,data:{...S.data,_canEdit:H,_isGrouped:M,_currentUserId:b,_isSharedWorkflow:p}}})},[U,Ke,a,ps,b,p,F]),Jt=t.useRef(null),as=t.useRef(new Map),us=t.useCallback(o=>{if(v.current){L(o);return}const S=o.filter(H=>{var He;if(H.type!=="position")return!0;if(_t.current.find(Fe=>{var rt;return!Fe.hidden&&((rt=Fe.nodeIds)==null?void 0:rt.includes(H.id))}))return a;if(a)return!0;const ke=se.current.find(Fe=>Fe.id===H.id);if(!ke)return!0;const De=(He=ke.data)==null?void 0:He.createdBy;return(typeof De=="object"?De==null?void 0:De.id:De)===c.current});L(S);const M=S.filter(H=>H.type==="position"&&H.position);M.length>0&&(M.forEach(H=>{as.current.set(H.id,H.position)}),Jt.current&&clearTimeout(Jt.current),Jt.current=setTimeout(()=>{const H=Array.from(as.current.entries()).map(([Q,ke])=>({id:Q,position:ke}));H.length>0&&(ts(H),as.current.clear())},100))},[a,L,ts]);t.useEffect(()=>{Xs.current=fs},[fs]),t.useEffect(()=>{const o=S=>{S.key==="Escape"&&(bs&&er(!1),ws&&tr(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,ws]),t.useEffect(()=>{tt&&(I(!1),P(!1),Gs(),Jr(),qr(),ss().finally(()=>{P(!0)}))},[tt]),t.useEffect(()=>{if(!te&&!O&&U.length>0){const o=setTimeout(()=>{ae({padding:.1,duration:800,maxZoom:1.5}),I(!0)},100);return()=>clearTimeout(o)}},[te,O,U.length,ae]),t.useEffect(()=>{var H;if(!Oe||!pe||!be||!A)return;const o=Ke.find(Q=>Q.scene===re&&Q.shot===Y),S=`${re}-${Y}`;if(o){vs(o.id),wt(o.id);try{if(C.current===S)return;if(Array.isArray(ce)&&ce.length>0){C.current=S;const Q=U,ke=[],De=280,Pe=320,He=350,Fe={role:0,scene:0,prop:0,audio:0};Q.forEach(Le=>{var pt;if(Le.type==="assetSelector"){const Lt=((pt=Le.data)==null?void 0:pt.label)||"";Lt.startsWith("è§’è‰²")?Fe.role++:Lt.startsWith("åœºæ™¯")?Fe.scene++:Lt.startsWith("é“å…·")?Fe.prop++:Lt.startsWith("éŸ³é¢‘")&&Fe.audio++}});const rt={...Fe},Xe=[];ce.forEach((Le,pt)=>{const Lt=Le.thumbnail||Le.url||"";let Ut=null;const Ot=Q.some(ot=>{var $t,Ye;if(ot.type!=="assetSelector")return!1;const Qe=($t=ot.data)==null?void 0:$t.config,ve=Qe==null?void 0:Qe.selectedAsset;if((ve==null?void 0:ve.id)===Le.id)return Ut=ot.id,!0;const Je=((Ye=ot.data)==null?void 0:Ye.label)||"",jt=Le.type==="role"?"è§’è‰²":Le.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${jt}: ${Le.name}`||(ve==null?void 0:ve.name)===Le.name?(Ut=ot.id,!0):!1});if(Ot&&Ut&&Lt&&Xe.push({nodeId:Ut,newUrl:Lt}),Ot)return;const ft=Le.type,mt=ft==="role"?0:ft==="scene"?1:ft==="prop"?2:3,Nt=rt[ft]||0;rt[ft]=(rt[ft]||0)+1;const Ht={x:mt*De,y:He+Nt*Pe},lt=Le.thumbnail||Le.url||"",ze=`assetSelector-${Date.now()}-${pt}`,nt=ft==="role"?"è§’è‰²":ft==="scene"?"åœºæ™¯":ft==="prop"?"é“å…·":"éŸ³é¢‘",dt=Le.metadata,at=ft==="role"&&(dt==null?void 0:dt.images);let qt=[];if(at){const ot=dt.images;ot.frontUrl&&qt.push({id:"front",url:ot.frontUrl,name:`${Le.name}-æ­£é¢`}),ot.sideUrl&&qt.push({id:"side",url:ot.sideUrl,name:`${Le.name}-ä¾§é¢`}),ot.backUrl&&qt.push({id:"back",url:ot.backUrl,name:`${Le.name}-èƒŒé¢`}),ot.faceUrl&&qt.push({id:"face",url:ot.faceUrl,name:`${Le.name}-é¢éƒ¨`})}let Rt;at&&qt.length>0?Rt={selectedInput:{id:Le.id,name:Le.name,coverUrl:lt,images:qt}}:ft==="audio"?Rt={selectedAsset:{id:Le.id,name:Le.name,originalName:Le.name,url:Le.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:Rt={selectedAsset:{id:Le.id,name:Le.name,originalName:Le.name,url:lt,type:"IMAGE",mimeType:"image/png",size:0}},ke.push({id:ze,type:"assetSelector",position:Ht,data:{id:ze,label:`${nt}: ${Le.name}`,config:Rt,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:be,episode:pe,nodeGroup:o,nodeGroups:Ke}}})}),Xe.length>0&&R(Le=>Le.map(pt=>{var Ut;const Lt=Xe.find(Ot=>Ot.nodeId===pt.id);if(Lt&&pt.type==="assetSelector"){const Ot=((Ut=pt.data)==null?void 0:Ut.config)||{},ft=Ot.selectedAsset||{};return{...pt,data:{...pt.data,config:{...Ot,selectedAsset:{...ft,url:Lt.newUrl}}}}}return pt})),ke.length>0&&R(Le=>[...Le,...ke])}}catch{}return}if(C.current===S)return;const M={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${re}å¹•-ç¬¬${Y}é•œ`,scene:re,shot:Y,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};yt(Q=>[...Q,M]),_t.current=[..._t.current,M],vs(M.id),wt(M.id),C.current=S;try{const Q=((H=pe==null?void 0:pe.scriptJson)==null?void 0:H.acts)||[],ke=Array.isArray(Q)?Q.find(ze=>Number(ze.actIndex)===Number(re)):null,De=ke?(ke.shots||[]).find(ze=>Number(ze.shotIndex)===Number(Y)):null,He=De?[`ç”»é¢ï¼š${(De.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(De["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(De["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(De["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(De.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=De&&(De.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,Le=280,pt=320,Lt=350,Ut={x:0,y:0},Ot={x:rt+Xe,y:0},ft=`textPreview-${Date.now()}-a`,mt=`textPreview-${Date.now()}-b`,Nt=[{id:ft,type:"textPreview",position:Ut,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:ft,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:be,episode:pe,nodeGroup:M,nodeGroups:[...Ke,M]}}},{id:mt,type:"textPreview",position:Ot,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:mt,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:be,episode:pe,nodeGroup:M,nodeGroups:[...Ke,M]}}}],Ht=[];if(Array.isArray(ce)&&ce.length>0){const ze={role:0,scene:0,prop:0,audio:0};ce.forEach((nt,dt)=>{const at=nt.type,qt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,Rt=ze[at]||0;ze[at]=(ze[at]||0)+1;const ot={x:qt*Le,y:Lt+Rt*pt},Qe=`assetSelector-${Date.now()}-${dt}`;Ht.push(Qe);const ve=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=nt.thumbnail||nt.url||"",jt=nt.metadata,$t=at==="role"&&(jt==null?void 0:jt.images);let Ye=[];if($t){const xt=jt.images;xt.frontUrl&&Ye.push({id:"front",url:xt.frontUrl,name:`${nt.name}-æ­£é¢`}),xt.sideUrl&&Ye.push({id:"side",url:xt.sideUrl,name:`${nt.name}-ä¾§é¢`}),xt.backUrl&&Ye.push({id:"back",url:xt.backUrl,name:`${nt.name}-èƒŒé¢`}),xt.faceUrl&&Ye.push({id:"face",url:xt.faceUrl,name:`${nt.name}-é¢éƒ¨`})}let It;$t&&Ye.length>0?It={selectedInput:{id:nt.id,name:nt.name,coverUrl:Je,images:Ye}}:at==="audio"?It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:nt.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},Nt.push({id:Qe,type:"assetSelector",position:ot,data:{id:Qe,label:`${ve}: ${nt.name}`,config:It,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:be,episode:pe,nodeGroup:M,nodeGroups:[...Ke,M]}}})})}R(ze=>[...ze,...Nt]);const lt=[ft,mt,...Ht];yt(ze=>ze.map(nt=>{if(nt.id!==M.id)return nt;const dt=Array.from(new Set([...nt.nodeIds||[],...lt])),at=nt.bounds;return{...nt,nodeIds:dt,bounds:at}})),_t.current=_t.current.map(ze=>{if(ze.id!==M.id)return ze;const nt=Array.from(new Set([...ze.nodeIds||[],...lt])),dt=ze.bounds;return{...ze,nodeIds:nt,bounds:dt}})}catch{}},[qe,re,Y,pe,be,Ke,R,A,ce]),t.useEffect(()=>{if(be)if(qe&&pe){const o=`${be.name} - ${pe.name||`ç¬¬${pe.episodeNumber}é›†`}`,S=re&&Y?`ç¬¬${re}å¹•ç¬¬${Y}é•œ`:"";je(Oe?o:`${o} ${S}`.trim())}else je(be.name);return()=>je("")},[be,pe,qe,Oe,re,Y,je]),t.useEffect(()=>{if(!(!tt||te||v.current))return it.current&&clearTimeout(it.current),it.current=setTimeout(()=>{qs()},2e3),()=>{it.current&&clearTimeout(it.current)}},[U,f,Ke]);const ss=async()=>{var o,S,M,H,Q,ke;try{let De;if(me&&V)De=await Ce.workflows.getById(V);else if(Oe)De=await Ce.workflows.getOrCreateByShot(j,n,re,Y);else if(qe)De=await Ce.workflows.getOrCreateByEpisode(j,n);else{if(!s)return;De=await Ce.workflows.getOrCreateByProject(s)}const Pe=De.data;Pe.canEdit===!1||Pe.canEdit===void 0&&Pe.isOwner===!1?(G(!0),v.current=!0,(o=Pe.shareInfo)!=null&&o.owner&&r(Pe.shareInfo.owner)):(G(!1),v.current=!1,r(null)),Pe.currentUserId&&(d(Pe.currentUserId),c.current=Pe.currentUserId);const Fe=Pe.isOwner!==!1||Oe&&Pe.canEdit===!0;w(Fe);const rt=me||Pe.hasCollaborators===!0;if(g(rt),y.current=Pe.id,me&&ge({id:Pe.projectId||V,name:Pe.name||"å…±äº«å·¥ä½œæµ",description:Pe.description,type:"QUICK",status:"DRAFT"}),Pe.data){const{nodes:Xe,edges:Le,nodeGroups:pt}=Pe.data;if(pt&&pt.length>0&&(yt(pt),_t.current=pt),Xe&&Xe.length>0){let Lt=Xe;if(Oe&&((S=pe==null?void 0:pe.scriptJson)!=null&&S.acts))try{const Nt=pe.scriptJson.acts.find(ze=>Number(ze.actIndex)===Number(re)),Ht=(M=Nt==null?void 0:Nt.shots)==null?void 0:M.find(ze=>Number(ze.shotIndex)===Number(Y)),lt=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(ze=>{ze.nodeId&&lt.add(ze.nodeId)}),(H=Ht.media)!=null&&H.nodeId&&lt.add(Ht.media.nodeId)),Lt=Xe.map(ze=>{var nt;return ze.type==="videoPreview"&&((nt=ze.data)!=null&&nt.addedToStoryboard)&&!lt.has(ze.id)?{...ze,data:{...ze.data,addedToStoryboard:!1}}:ze})}catch{}let Ut;if(Oe&&((Q=pe==null?void 0:pe.scriptJson)!=null&&Q.acts))try{const Nt=pe.scriptJson.acts.find(lt=>Number(lt.actIndex)===Number(re)),Ht=(ke=Nt==null?void 0:Nt.shots)==null?void 0:ke.find(lt=>Number(lt.shotIndex)===Number(Y));Ut=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Ot=new Set((pt||[]).filter(mt=>!mt.hidden).flatMap(mt=>mt.nodeIds||[])),ft=Lt.map(mt=>{const Nt=pt?pt.find(ze=>ze.nodeIds.includes(mt.id)):null,Ht=i.length>0?i:mt.data.models||[],lt=mt.type==="agent"&&Ut?{...mt.data,output:Ut,lastOutput:Ut}:mt.data;return{...mt,data:{...lt,models:Ht,onOpenAssetPanel:mt.type==="assetSelector"?mt.data.onOpenAssetPanel||ar:mt.data.onOpenAssetPanel,workflowContext:{project:be,episode:pe,nodeGroup:Nt,nodeGroups:pt||[]}},draggable:mt.draggable!==!1,connectable:Ot.has(mt.id)?!1:mt.connectable!==!1,deletable:Ot.has(mt.id)?!1:mt.deletable!==!1}});R(ft)}if(Le&&Le.length>0){const Lt=new Set(Xe.map(ft=>ft.id)),Ut=new Map(Xe.map(ft=>[ft.id,ft.type])),Ot=Le.filter(ft=>{if(!Lt.has(ft.source)||!Lt.has(ft.target))return!1;const mt=Ut.get(ft.target),Nt=Ut.get(ft.source);return!(mt==="midjourney"&&ft.targetHandle==="text-input"&&Nt!=="agent")}).map(ft=>({...ft,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:ft.targetHandle||void 0}));x(Ot)}}}catch{}};t.useEffect(()=>{i.length>0&&U.length>0&&R(o=>o.map(S=>({...S,data:{...S.data,models:i},draggable:S.draggable!==void 0?S.draggable:!0,deletable:S.deletable!==void 0?S.deletable:!0})))},[i,U.length]),t.useEffect(()=>{if(!be&&!pe||U.length===0)return;if(U.some(S=>{var De,Pe;const M=S.data.workflowContext,H=((De=M==null?void 0:M.project)==null?void 0:De.id)!==(be==null?void 0:be.id),Q=((Pe=M==null?void 0:M.episode)==null?void 0:Pe.id)!==(pe==null?void 0:pe.id),ke=(M==null?void 0:M.nodeGroups)!==_t.current;return!M||H||Q||ke})){const S=re&&Y&&_t.current.find(M=>M.scene===re&&M.shot===Y)||null;R(M=>M.map(H=>{const Q=_t.current.find(De=>De.nodeIds.includes(H.id))||null,ke=S||Q;return{...H,data:{...H.data,workflowContext:{project:be,episode:pe,nodeGroup:ke,nodeGroups:_t.current}}}}))}},[be,pe,re,Y,U.length,Ke]);const Os=async(o,S,M)=>{var H;if(!(!j||!n))try{const Q=o.find(Fe=>Fe.type==="agent");if(!Q)return;const ke=((H=Q.data)==null?void 0:H.output)||"",Pe=(await Ce.episodes.getById(j,n)).scriptJson;if(!Pe||!Pe.acts)return;const He=Pe.acts.map(Fe=>{var rt;return Fe.actIndex===S?{...Fe,shots:(rt=Fe.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===M&&Xe.æç¤ºè¯!==ke?{...Xe,æç¤ºè¯:ke}:Xe)}:Fe});await Ce.episodes.update(j,n,{scriptJson:{acts:He}})}catch{}},ks=async()=>{if(!(F||v.current)&&!(se.current.length===0&&Me.current.length===0))try{const o=se.current.map(M=>{const{data:H,...Q}=M,{workflowContext:ke,_canEdit:De,_currentUserId:Pe,...He}=H||{};return{...Q,data:He}}),S=Me.current.map(M=>({id:M.id,source:M.source,target:M.target,sourceHandle:M.sourceHandle,targetHandle:M.targetHandle,type:M.type}));if(Oe){await Ce.workflows.saveShot(j,n,re,Y,{nodes:o,edges:S,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}});try{await Os(se.current,re,Y)}catch{}}else qe?await Ce.workflows.saveEpisode(j,n,{nodes:o,edges:S,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}}):me&&V?await Ce.workflows.update(V,{data:{nodes:o,edges:S,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}}}):s&&await Ce.workflows.save(s,{nodes:o,edges:S,nodeGroups:_t.current,viewport:{x:0,y:0,zoom:1}})}catch{}},ms=t.useRef(null),qs=t.useCallback(()=>{ms.current&&clearTimeout(ms.current),ms.current=setTimeout(()=>{ks()},2e3)},[]);t.useEffect(()=>{const o=S=>{if(v.current)return;it.current&&clearTimeout(it.current);const H=S.detail;H!=null&&H.nodeId&&(H!=null&&H.config)&&(se.current=se.current.map(Q=>{var ke;return Q.id===H.nodeId?{...Q,data:{...Q.data,config:{...((ke=Q.data)==null?void 0:ke.config)||{},...H.config}}}:Q})),setTimeout(()=>{ks()},100)};return window.addEventListener("workflow:save",o),()=>{window.removeEventListener("workflow:save",o)}},[]),t.useEffect(()=>{if(be||pe){let o=_t.current;Oe&&re&&Y&&(o=_t.current.filter(S=>S.scene===re&&S.shot===Y)),window.__workflowContext={project:be,episode:pe,nodeGroups:o}}},[be,pe,Ke,Oe,re,Y]);const Gs=async()=>{try{if(me){window.__workflowContext={project:null,episode:null,nodeGroups:_t.current};return}if(qe){const[o,S]=await Promise.all([Ce.episodes.getById(j,n),Ce.projects.getById(j)]);Ie(o.data),ge(S.data);let M=_t.current;Oe&&re&&Y&&(M=_t.current.filter(H=>H.scene===re&&H.shot===Y)),window.__workflowContext={project:S.data,episode:o.data,nodeGroups:M}}else{const o=await Ce.projects.getById(s);ge(o.data);let S=_t.current;Oe&&re&&Y&&(S=_t.current.filter(M=>M.scene===re&&M.shot===Y)),window.__workflowContext={project:o.data,episode:null,nodeGroups:S}}}catch{m.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),T("/quick")}finally{Z(!1)}},Jr=async()=>{try{const o=await Ce.get("/ai/models",{params:{isActive:"true"}});z(o||[])}catch{}};t.useEffect(()=>{R(o=>o.map(S=>{const M=String(S.type||"");return!M.startsWith("aiVideo")&&M!=="audioVoice"&&M!=="voiceClone"&&M!=="audioSynthesize"&&M!=="audioDesign"?S:{...S,data:{...S.data,models:i}}}))},[i,R]);const qr=async()=>{try{const S=(await Ce.agents.getAll()).filter(M=>M.isActive&&(!M.usageScene||M.usageScene==="workflow"));X(S)}catch{}};t.useEffect(()=>{R(o=>o.map(S=>{var Pe,He,Fe,rt,Xe;if(S.type!=="agent")return S;const M=(He=(Pe=S.data)==null?void 0:Pe.config)==null?void 0:He.agentId,H=D.find(Le=>Le.id===M),Q=H==null?void 0:H.aiModelId,ke=i.find(Le=>Le.id===Q);let De=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if((!De||De.length===0)&&ke){const Le=(ke.provider||"").toLowerCase(),pt=(ke.name||"").toLowerCase();(Le.includes("google")||pt.includes("gemini"))&&(De=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(De)&&De.length>0){const Le=(Xe=(rt=S.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,pt=Lt=>Lt.map(Ut=>Ut.toUpperCase()).sort().join(",");if(!Le||pt(Le)!==pt(De))return{...S,data:{...S.data,config:{...S.data.config,acceptedInputs:De}}}}return S}))},[D,i,R]);const Kr=t.useCallback(o=>{var Pe,He,Fe,rt,Xe,Le,pt,Lt,Ut,Ot,ft,mt,Nt,Ht,lt,ze,nt;Zt.current=!1;const S=_t.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.source||""))}),M=_t.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.target||""))});if(S||M){m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Zt.current=!1;return}const H=U.find(dt=>dt.id===o.source),Q=U.find(dt=>dt.id===o.target);if(H&&Q){const dt=Rt=>{var ve,Je,jt;const ot=Rt.type,Qe=Rt.data;if(ot==="upload"&&Array.isArray((ve=Qe.config)==null?void 0:ve.uploadedFiles)&&Qe.config.uploadedFiles.length>0){const $t=Qe.config.uploadedFiles,Ye=$t.some(Et=>{const Yt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Yt==="VIDEO"||js.startsWith("video/")}),It=$t.some(Et=>{const Yt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Yt==="IMAGE"||js.startsWith("image/")}),xt=$t.some(Et=>{const Yt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Yt==="AUDIO"||js.startsWith("audio/")});return(Q==null?void 0:Q.type)==="aiVideo_swap"?Ye?"VIDEO":It?"IMAGE":xt?"AUDIO":null:It?"IMAGE":Ye?"VIDEO":xt?"AUDIO":null}if(ot==="assetSelector"){if((Je=Qe.config)!=null&&Je.subjects)return"IMAGE";if((jt=Qe.config)!=null&&jt.selectedAsset){const $t=Qe.config.selectedAsset,Ye=($t.type||"").toUpperCase(),It=($t.mimeType||"").toLowerCase();return Ye==="IMAGE"||It.startsWith("image/")?"IMAGE":Ye==="VIDEO"||It.startsWith("video/")?"VIDEO":Ye==="AUDIO"||It.startsWith("audio/")?"AUDIO":Ye||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=dt(H);let qt=(Pe=Q.data.config)==null?void 0:Pe.acceptedInputs;if(Q.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const Rt={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${Rt[at]||at}è¾“å…¥`),Zt.current=!1;return}if((!qt||qt.length===0)&&Q.data.type==="agent"){const Rt=(He=Q.data.config)==null?void 0:He.agentId,ot=D.find(jt=>jt.id===Rt),Qe=ot==null?void 0:ot.aiModelId,ve=i.find(jt=>jt.id===Qe),Je=(Fe=ve==null?void 0:ve.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)qt=Je;else{const jt=((rt=ve==null?void 0:ve.provider)==null?void 0:rt.toLowerCase())||"",$t=((ve==null?void 0:ve.name)||"").toLowerCase();(jt.includes("google")||$t.includes("gemini"))&&(qt=["TEXT","IMAGE","DOCUMENT"])}}if(Q.type!=="agent"){if(!Q.type.startsWith("aiVideo")&&qt&&qt.length>0&&at){const Rt=qt.map(Qe=>typeof Qe=="string"?Qe.toUpperCase():Qe),ot=typeof at=="string"?at.toUpperCase():at;if(!Rt.includes(ot)){const Qe={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};m.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${Qe[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${Rt.map(ve=>Qe[ve]||ve).join("ã€")}ï¼‰`),Zt.current=!1;return}}}if(Q.type==="aiVideo_swap"){const Rt=f.filter(jt=>jt.target===Q.id),ot=Rt.filter(jt=>{const $t=U.find(It=>It.id===jt.source);return dt($t)==="VIDEO"}).length,Qe=Rt.filter(jt=>{const $t=U.find(It=>It.id===jt.source);return dt($t)==="IMAGE"}).length,ve=ot+(at==="VIDEO"?1:0),Je=Qe+(at==="IMAGE"?1:0);if(ve>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){m.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Zt.current=!1;return}}if(Q.type==="aiVideo_lipsync"){const Rt=f.filter($t=>$t.target===Q.id),ot=Rt.filter($t=>{const Ye=U.find(xt=>xt.id===$t.source);return dt(Ye)==="VIDEO"}).length,Qe=Rt.filter($t=>{const Ye=U.find(xt=>xt.id===$t.source);return dt(Ye)==="AUDIO"}).length,ve=ot+(at==="VIDEO"?1:0),Je=Qe+(at==="AUDIO"?1:0),jt=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ve>1||Je>1||!jt){m.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Zt.current=!1;return}}if(Q.type.startsWith("aiVideo")&&Q.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(Qe=>{const ve=(Qe||"").toLowerCase().replace(/[_\-\s]+/g," ");return ve?ve.includes("æ–‡ç”Ÿ")||ve.includes("text to video")||ve.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("é¦–å°¾")||ve.includes("first last")||ve.includes("two frame")||ve.includes("frame pair")?"é¦–å°¾å¸§":ve.includes("é¦–å¸§")||ve.includes("first frame")||ve.includes("start frame")||ve.includes("initial frame")||ve.includes("keyframe")?"é¦–å¸§":ve.includes("å°¾å¸§")||ve.includes("last frame")||ve.includes("end frame")||ve.includes("final frame")?"å°¾å¸§":ve.includes("ä¸»ä½“å‚è€ƒ")||ve.includes("subject reference")||ve.includes("å‚è€ƒ")||ve.includes("reference image")||ve.includes("image reference")||ve.includes("ref image")?"å‚è€ƒå›¾":Qe||"":""})((Le=(Xe=Q.data)==null?void 0:Xe.config)==null?void 0:Le.generationType);if(Q.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){m.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Zt.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&H.type==="assetSelector"){const Qe=((pt=H.data)==null?void 0:pt.config)||{};if(Qe.subjects&&Qe.subjects.length>0&&(Qe.subjects[0].images||[]).length>1){m.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Zt.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&H.type==="assetSelector"){const Qe=((Lt=H.data)==null?void 0:Lt.config)||{};if(Qe.subjects&&Qe.subjects.length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Zt.current=!1;return}}}if(Q.type==="aiVideo_style"){const Qe=f.filter(ve=>ve.target===Q.id).filter(ve=>{const Je=U.find($t=>$t.id===ve.source);return dt(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){m.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Zt.current=!1;return}if(Qe>1){m.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Zt.current=!1;return}}if(Q.type.startsWith("aiVideo")&&at==="TEXT"&&f.filter(Qe=>Qe.target===Q.id).find(Qe=>{const ve=U.find(Je=>Je.id===Qe.source);return(ve==null?void 0:ve.type)==="agent"})){m.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Zt.current=!1;return}if(Q.type==="aiImage"){if(at==="TEXT"){if(f.filter(Qe=>Qe.target===Q.id).some(Qe=>{const ve=U.find(Je=>Je.id===Qe.source);return(ve==null?void 0:ve.type)==="agent"})){m.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Zt.current=!1;return}}else if(at==="IMAGE"){const ot=f.filter(Ye=>Ye.target===Q.id).reduce((Ye,It)=>{var Yt,js,es,Rs,As,Mr,Dr;const xt=U.find(cs=>cs.id===It.source),Et=(xt==null?void 0:xt.type)||"";if(Et==="upload"){const cs=((es=(js=(Yt=xt==null?void 0:xt.data)==null?void 0:Yt.config)==null?void 0:js.uploadedFiles)==null?void 0:es[0])||null,pa=((cs==null?void 0:cs.type)||"").toUpperCase(),ma=((cs==null?void 0:cs.mimeType)||"").toLowerCase();return Ye+(pa==="IMAGE"||ma.startsWith("image/")?1:0)}if(Et==="assetSelector"){const cs=((Rs=xt==null?void 0:xt.data)==null?void 0:Rs.config)||{};return cs.selectedAsset&&(Ye+=(cs.selectedAsset.type||"").toUpperCase()==="IMAGE"||(cs.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(cs.subjects)&&cs.subjects.length>0?Ye+((cs.subjects[0].images||[]).length||0):Ye}if(Et==="aiImage"){const cs=(Mr=(As=xt==null?void 0:xt.data)==null?void 0:As.config)==null?void 0:Mr.generatedImageUrl;return Ye+(cs?1:0)}if(Et==="imagePreview"){const cs=(Dr=xt==null?void 0:xt.data)==null?void 0:Dr.imageUrl;return Ye+(cs?1:0)}return Ye},0);let Qe=1;if(H.type==="assetSelector"){const Ye=((Ut=H==null?void 0:H.data)==null?void 0:Ut.config)||{};Ye.selectedAsset?Qe=(Ye.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ye.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Ye.subjects)&&Ye.subjects.length>0&&(Qe=(Ye.subjects[0].images||[]).length||0)}else if(H.type==="upload"){const Ye=((mt=(ft=(Ot=H==null?void 0:H.data)==null?void 0:Ot.config)==null?void 0:ft.uploadedFiles)==null?void 0:mt[0])||null,It=((Ye==null?void 0:Ye.type)||"").toUpperCase(),xt=((Ye==null?void 0:Ye.mimeType)||"").toLowerCase();Qe=It==="IMAGE"||xt.startsWith("image/")?1:0}else H.type==="aiImage"?Qe=((Ht=(Nt=H==null?void 0:H.data)==null?void 0:Nt.config)==null?void 0:Ht.generatedImageUrl)?1:0:H.type==="imagePreview"&&(Qe=((lt=H==null?void 0:H.data)==null?void 0:lt.imageUrl)?1:0);const ve=(nt=(ze=Q==null?void 0:Q.data)==null?void 0:ze.config)==null?void 0:nt.modelId,Je=i.find(Ye=>Ye.id===ve),jt=(Je==null?void 0:Je.config)||{},$t=jt.maxReferenceImages||jt.supportedReferenceImagesLimit||jt.referenceImagesLimit||10;if(ot+Qe>$t){m.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${$t}å¼ ï¼‰`),Zt.current=!1;return}}}}try{const dt=U.find(ot=>ot.id===o.target),at=U.find(ot=>ot.id===o.source),qt=ot=>{var ve,Je,jt,$t;if(!ot)return null;const Qe=String(ot.type||"").toLowerCase();if(Qe==="upload"){const Ye=(((Je=(ve=ot.data)==null?void 0:ve.config)==null?void 0:Je.uploadedFiles)||[]).find(It=>{const xt=((It==null?void 0:It.type)||"").toUpperCase(),Et=((It==null?void 0:It.mimeType)||"").toLowerCase();return xt==="AUDIO"||Et.startsWith("audio/")});return(Ye==null?void 0:Ye.url)||null}if(Qe==="assetSelector"){const Ye=($t=(jt=ot.data)==null?void 0:jt.config)==null?void 0:$t.selectedAsset,It=((Ye==null?void 0:Ye.type)||"").toUpperCase(),xt=((Ye==null?void 0:Ye.mimeType)||"").toLowerCase();if(It==="AUDIO"||xt.startsWith("audio/"))return(Ye==null?void 0:Ye.url)||null}return null};if(String((dt==null?void 0:dt.type)||"")==="audioVoice"){const ot=qt(at);ot&&R(Qe=>Qe.map(ve=>ve.id===dt.id?{...ve,data:{...ve.data,config:{...ve.data.config,audioUrl:ot}}}:ve))}}catch{}const De={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{x(dt=>Ia(De,dt)),rs(De)},0),xs.current=null,Zt.current=!0},[x,U,D,i,f,rs]),Yr=t.useCallback((o,S)=>{const M=_t.current.some(Q=>{var ke;return!Q.hidden&&((ke=Q.nodeIds)==null?void 0:ke.includes(S.source))}),H=_t.current.some(Q=>{var ke;return!Q.hidden&&((ke=Q.nodeIds)==null?void 0:ke.includes(S.target))});if(M||H){m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}x(Q=>Q.filter(ke=>ke.id!==S.id)),ys(S.id),m.success("å·²æ–­å¼€è¿æ¥")},[x,ys]),vr=t.useCallback(o=>{var H,Q,ke,De,Pe,He,Fe,rt,Xe,Le,pt,Lt,Ut,Ot,ft;it.current&&clearTimeout(it.current);try{const mt=localStorage.getItem("suppressedPreviewTasks")||"[]",Nt=JSON.parse(mt),Ht=ze=>{Nt.push(ze)};for(const ze of Array.isArray(o)?o:[])if((ze==null?void 0:ze.type)==="imagePreview"){const nt=(Q=(H=ze==null?void 0:ze.data)==null?void 0:H.midjourneyData)==null?void 0:Q.sourceNodeId,dt=(De=(ke=ze==null?void 0:ze.data)==null?void 0:ke.midjourneyData)==null?void 0:De.taskId,at=(He=(Pe=ze==null?void 0:ze.data)==null?void 0:Pe.midjourneyData)==null?void 0:He.messageId;if(nt||dt||at)Ht({sourceNodeId:nt,taskId:dt,messageId:at});else{const qt=Me.current.find(Rt=>Rt.target===ze.id);if(qt){const Rt=se.current.find(Qe=>Qe.id===qt.source),ot=(rt=(Fe=Rt==null?void 0:Rt.data)==null?void 0:Fe.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((ze==null?void 0:ze.type)==="videoPreview"){const nt=Me.current.find(dt=>dt.target===ze.id);if(nt){const dt=se.current.find(qt=>qt.id===nt.source),at=(Le=(Xe=dt==null?void 0:dt.data)==null?void 0:Xe.config)==null?void 0:Le.taskId;at&&Ht({taskId:at})}}const lt=Nt.slice(Math.max(0,Nt.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(lt))}catch{}try{const mt=[];for(const Nt of Array.isArray(o)?o:[]){const Ht=(Ut=(Lt=(pt=Nt==null?void 0:Nt.data)==null?void 0:pt.workflowContext)==null?void 0:Lt.project)==null?void 0:Ut.name;(Nt==null?void 0:Nt.type)==="imagePreview"&&((Ot=Nt==null?void 0:Nt.data)!=null&&Ot.imageUrl)?mt.push(Ce.post("/assets/recycle/record",{url:Nt.data.imageUrl,type:"IMAGE",projectName:Ht})):(Nt==null?void 0:Nt.type)==="videoPreview"&&((ft=Nt==null?void 0:Nt.data)!=null&&ft.videoUrl)&&mt.push(Ce.post("/assets/recycle/record",{url:Nt.data.videoUrl,type:"VIDEO",projectName:Ht}))}mt.length>0&&Promise.allSettled(mt).then(()=>{})}catch{}const S=Array.isArray(o)?o.length:0,M=Ge.current;setTimeout(()=>{const mt=se.current.length,Nt=Math.max(M-S,0);mt===Nt&&ks()},100)},[]),Qr=t.useCallback(o=>{const S=o.filter(H=>_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(H.id))})?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(S.length===0)return;if(a){vr(S),S.forEach(H=>Wt(H.id));return}const M=S.filter(H=>{var De;const Q=(De=H.data)==null?void 0:De.createdBy;return(typeof Q=="object"?Q==null?void 0:Q.id:Q)===c.current});M.length>0&&(vr(M),M.forEach(H=>Wt(H.id)))},[a,vr,Wt]),_r=t.useCallback(o=>{it.current&&clearTimeout(it.current),setTimeout(()=>{qs()},250)},[]),Zr=t.useCallback(o=>{const S=o.filter(M=>{if(M.type!=="remove")return!0;const H=Me.current.find(De=>De.id===M.id);if(!H)return!0;const Q=_t.current.some(De=>{var Pe;return!De.hidden&&((Pe=De.nodeIds)==null?void 0:Pe.includes(H.source))}),ke=_t.current.some(De=>{var Pe;return!De.hidden&&((Pe=De.nodeIds)==null?void 0:Pe.includes(H.target))});return Q||ke?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});_(S)},[_]),ea=t.useCallback(o=>{const S=o.filter(M=>{const H=_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(M.source))}),Q=_t.current.some(ke=>{var De;return!ke.hidden&&((De=ke.nodeIds)==null?void 0:De.includes(M.target))});return H||Q?(m.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});S.length>0&&(_r(S),S.forEach(M=>ys(M.id)))},[_r,ys]),ta=t.useCallback(o=>{if(o.preventDefault(),F)return;const S=200,M=400,H=10;let Q=o.clientX,ke=o.clientY;Q+S+H>window.innerWidth&&(Q=window.innerWidth-S-H),ke+M+H>window.innerHeight&&(ke=window.innerHeight-M-H),Q=Math.max(H,Q),ke=Math.max(H,ke),l({x:Q,y:ke})},[F]),hr=t.useCallback(()=>{l(null),ue(),B(!1)},[]),ar=t.useCallback(o=>{gt(o),At(!0)},[]);t.useEffect(()=>{U.length>0&&U.some(S=>S.type==="assetSelector"&&!S.data.onOpenAssetPanel)&&R(S=>S.map(M=>M.type==="assetSelector"&&!M.data.onOpenAssetPanel?{...M,data:{...M.data,onOpenAssetPanel:ar,models:M.data.models||i}}:M))},[U.length,ar,i]);const sa=t.useCallback(o=>{ct&&(R(S=>S.map(H=>H.id===ct?{...H,data:{...H.data,config:{...H.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(Q=>Q.url)}],referenceImages:o.images.map(Q=>({id:Q.id,url:Q.url,name:Q.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:H)),At(!1),gt(null),m.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[ct,R]),Tr=o=>{const M={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",H=M==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:M==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:M==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:M==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],Q=i.filter(He=>He.type==="VIDEO_GENERATION"),ke=i.filter(He=>He.type==="VIDEO_EDITING"),De=He=>{const Fe=(He||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Pe=null;return M==="è§†é¢‘æ¢äºº"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||Q.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Le=>De(Le)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):M==="å¯¹å£å‹"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:M==="é£æ ¼è½¬æ¢"?Pe=ke.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Pe=Q.find(He=>{var rt;const Fe=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>De(Xe)):[];return M==="é¦–å¸§"||M==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(M)}),{modelId:Pe==null?void 0:Pe.id,modelName:Pe==null?void 0:Pe.name,generationType:M,lockedGenerationType:M,hideGenerationTypeSelector:!0,acceptedInputs:H}},ns=(o,S,M,H,Q,ke,De,Pe)=>{if(!u)return;const He=Re({x:u.x,y:u.y}),Fe=`${o}-${Date.now()}`,rt=Kt?Ke.find(Ut=>Ut.id===Kt)||null:Ke.find(Ut=>Ut.nodeIds.includes(Fe))||null,Xe=M==="aiImage"||M.startsWith("aiVideo")||M==="midjourney",Le=M.startsWith("aiVideo")?Tr(M):{},pt=H?{agentId:H}:Le;M.startsWith("aiVideo"),M.startsWith("aiVideo")&&Pe&&Object.assign(pt,Pe);const Lt={id:Fe,type:M,position:He,data:{label:Q||S,type:o,config:pt,models:i,isExpanded:Xe,onOpenAssetPanel:M==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:be,episode:pe,nodeGroup:rt,nodeGroups:Ke}}};R(Ut=>[...Ut,Lt]),Tt(Lt),Kt&&(yt(Ut=>Ut.map(Ot=>{if(Ot.id!==Kt)return Ot;const ft=Array.from(new Set([...Ot.nodeIds||[],Fe])),mt=xr(ft)||Ot.bounds;return{...Ot,nodeIds:ft,bounds:mt}})),_t.current=_t.current.map(Ut=>{if(Ut.id!==Kt)return Ut;const Ot=Array.from(new Set([...Ut.nodeIds||[],Fe])),ft=xr(Ot)||Ut.bounds;return{...Ut,nodeIds:Ot,bounds:ft}})),hr(),m.success(`å·²æ·»åŠ ${Q||S}èŠ‚ç‚¹`),M==="assetSelector"&&setTimeout(()=>{ar(Lt.id)},100)},[is,Ks]=t.useState(null),Zt=t.useRef(!1),xs=t.useRef(null),Ys=t.useMemo(()=>{var Pe,He,Fe,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const S=is.handleType==="target",M=Xe=>{const Le=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return Le?Le.includes("æ–‡ç”Ÿ")||Le.includes("text to video")||Le.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Le.includes("é¦–å°¾")||Le.includes("first last")||Le.includes("two frame")||Le.includes("frame pair")?"é¦–å°¾å¸§":Le.includes("é¦–å¸§")||Le.includes("first frame")||Le.includes("start frame")||Le.includes("initial frame")||Le.includes("keyframe")?"é¦–å¸§":Le.includes("å°¾å¸§")||Le.includes("last frame")||Le.includes("end frame")||Le.includes("final frame")?"å°¾å¸§":Le.includes("ä¸»ä½“å‚è€ƒ")||Le.includes("subject reference")||Le.includes("å‚è€ƒ")||Le.includes("reference image")||Le.includes("image reference")||Le.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(S){const Xe=U.find(Ot=>Ot.id===is.sourceNodeId),Le=(Xe==null?void 0:Xe.type)||"",pt=Le.startsWith("aiVideo"),Lt=M((He=(Pe=Xe==null?void 0:Xe.data)==null?void 0:Pe.config)==null?void 0:He.generationType),Ut=Le==="aiVideo_t2v"||Lt==="æ–‡ç”Ÿè§†é¢‘";if(Le==="aiImage"){const Ot=f.filter(nt=>nt.target===(Xe==null?void 0:Xe.id)),ft=Ot.some(nt=>{const dt=U.find(at=>at.id===nt.source);return((dt==null?void 0:dt.type)||"")==="agent"}),mt=Ot.reduce((nt,dt)=>{var Rt,ot,Qe,ve;const at=U.find(Je=>Je.id===dt.source),qt=(at==null?void 0:at.type)||"";if(qt==="upload"){const Je=((Qe=(ot=(Rt=at==null?void 0:at.data)==null?void 0:Rt.config)==null?void 0:ot.uploadedFiles)==null?void 0:Qe[0])||null,jt=((Je==null?void 0:Je.type)||"").toUpperCase(),$t=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return nt+(jt==="IMAGE"||$t.startsWith("image/")?1:0)}if(qt==="assetSelector"){const Je=((ve=at==null?void 0:at.data)==null?void 0:ve.config)||{};if(Je.selectedAsset)return nt+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return nt+((Je.subjects[0].images||[]).length||0)}return nt},0),Nt=(rt=(Fe=Xe==null?void 0:Xe.data)==null?void 0:Fe.config)==null?void 0:rt.modelId,Ht=i.find(nt=>nt.id===Nt),lt=(Ht==null?void 0:Ht.config)||{},ze=lt.maxReferenceImages||lt.supportedReferenceImagesLimit||lt.referenceImagesLimit||10;return ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=ze?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(pt){const Ot=f.filter(ze=>ze.target===(Xe==null?void 0:Xe.id)),ft=Ot.some(ze=>{const nt=U.find(dt=>dt.id===ze.source);return((nt==null?void 0:nt.type)||"")==="agent"}),mt=Ot.reduce((ze,nt)=>{var qt,Rt,ot,Qe;const dt=U.find(ve=>ve.id===nt.source),at=(dt==null?void 0:dt.type)||"";if(at==="aiImage"||at==="imagePreview")return ze+1;if(at==="upload"){const ve=((ot=(Rt=(qt=dt==null?void 0:dt.data)==null?void 0:qt.config)==null?void 0:Rt.uploadedFiles)==null?void 0:ot[0])||null,Je=((ve==null?void 0:ve.type)||"").toUpperCase(),jt=((ve==null?void 0:ve.mimeType)||"").toLowerCase();return ze+(Je==="IMAGE"||jt.startsWith("image/")?1:0)}if(at==="assetSelector"){const ve=((Qe=dt==null?void 0:dt.data)==null?void 0:Qe.config)||{};if(ve.selectedAsset)return ze+((ve.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ve.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ve.subjects&&ve.subjects.length>0)return ze+((ve.subjects[0].images||[]).length||0)}return ze},0);return Ut?ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Le==="aiVideo_i2v_first"||Le==="aiVideo_i2v_last"||Lt==="é¦–å¸§"||Lt==="å°¾å¸§"?ft&&mt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Le==="aiVideo_first_last"||Lt==="é¦–å°¾å¸§"?ft&&mt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Le==="aiVideo_reference"||Lt==="å‚è€ƒå›¾"?ft&&mt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ft?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const H=U.find(Xe=>Xe.id===is.sourceNodeId),ke=(Xe=>{var Lt,Ut,Ot;if(!Xe)return null;const Le=Xe.type,pt=Xe.data;if(Le==="upload"&&Array.isArray((Lt=pt.config)==null?void 0:Lt.uploadedFiles)&&pt.config.uploadedFiles.length>0){const ft=pt.config.uploadedFiles;return ft.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="IMAGE"||nt.startsWith("image/")})?"IMAGE":ft.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="VIDEO"||nt.startsWith("video/")})?"VIDEO":ft.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="AUDIO"||nt.startsWith("audio/")})?"AUDIO":null}if(Le==="assetSelector"){if((Ut=pt.config)!=null&&Ut.subjects)return"IMAGE";if((Ot=pt.config)!=null&&Ot.selectedAsset){const ft=pt.config.selectedAsset,mt=(ft.type||"").toUpperCase(),Nt=(ft.mimeType||"").toLowerCase();return mt==="IMAGE"||Nt.startsWith("image/")?"IMAGE":mt==="VIDEO"||Nt.startsWith("video/")?"VIDEO":mt==="AUDIO"||Nt.startsWith("audio/")?"AUDIO":mt||null}}return Le==="aiImage"||Le==="imagePreview"||Le==="midjourney"?"IMAGE":(Le||"").startsWith("aiVideo")||Le==="videoPreview"?"VIDEO":Le==="agent"||Le==="textPreview"?"TEXT":null})(H),De=H==null?void 0:H.type;return De==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:De==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ke==="TEXT",showAiImage:ke==="IMAGE"||ke==="TEXT",showAudio:ke==="AUDIO",showVideo:ke==="VIDEO"||ke==="IMAGE"||ke==="TEXT",showEdit:ke==="VIDEO",showImageEditing:ke==="IMAGE",showMidjourney:ke==="IMAGE"||ke==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ke==="IMAGE"}},[is,U,f,i]),ra=t.useCallback((o,{nodeId:S,handleType:M})=>{if(!S){xs.current=null;return}if(M==="target"){const H=U.find(ke=>ke.id===S),Q=(H==null?void 0:H.type)||"";if(Q==="agent"||Q==="aiImage"||Q==="midjourney"||Q.startsWith("aiVideo")){m.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),xs.current=null;return}}if(M==="source"){const H=U.find(Q=>Q.id===S);if(H&&(H.type==="aiImage"||H.type.startsWith("aiVideo"))){xs.current=null;return}}Zt.current=!1,xs.current={nodeId:S,handleType:M==="target"?"target":"source"},hr(),Ks(null)},[hr,U]),aa=t.useCallback(o=>{const S=xs.current;if(!S)return;let M=0,H=0;"changedTouches"in o&&o.changedTouches.length>0?(M=o.changedTouches[0].clientX,H=o.changedTouches[0].clientY):"clientX"in o&&(M=o.clientX,H=o.clientY),setTimeout(()=>{if(Zt.current){Zt.current=!1,xs.current=null;return}const Q=o.target,ke=!!Q&&!!Q.closest(".react-flow__pane"),De=!!Q&&(Q.closest(".react-flow__node")||Q.closest(".react-flow__handle"));if(!ke||De){Zt.current=!1,xs.current=null;return}Ks({x:M,y:H,sourceNodeId:S.nodeId,handleType:S.handleType}),Zt.current=!1},100),xs.current=null},[]),ls=(o,S,M,H,Q,ke)=>{var Lt,Ut,Ot,ft,mt,Nt,Ht;if(!is)return;const De=Re({x:is.x,y:is.y}),Pe=`${M}-${Date.now()}`,He=U.find(lt=>lt.id===is.sourceNodeId),Fe=He?Ke.find(lt=>lt.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?Tr(o):{};let Le={};H?Le={agentId:H}:o.startsWith("aiVideo")?Le=Xe:o==="smartStoryboard"?Le={taskId:"",aspectRatio:"1:1",inputImages:[],userPrompt:""}:o==="hdUpscale"?Le={taskId:"",imageSize:"4K"}:o==="imageFusion"&&(Le={taskId:"",imageSize:"4K"}),o.startsWith("aiVideo")&&ke&&Object.assign(Le,ke);const pt={id:Pe,type:o,position:De,data:{label:Q||S,type:M,config:Le,models:i,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:be,episode:pe,nodeGroup:Fe,nodeGroups:Ke}}};if(R(lt=>[...lt,pt]),Fe&&(yt(lt=>lt.map(ze=>{if(ze.id!==Fe.id)return ze;const nt=Array.from(new Set([...ze.nodeIds,Pe]));return{...ze,nodeIds:nt}})),_t.current=_t.current.map(lt=>{if(lt.id!==Fe.id)return lt;const ze=Array.from(new Set([...lt.nodeIds,Pe]));return{...lt,nodeIds:ze}})),is.handleType==="source"){const lt=U.find(ve=>ve.id===is.sourceNodeId),ze=pt,nt=ve=>{const Je=(ve||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ve||"":""},dt=ve=>{var $t,Ye,It;const Je=ve.type,jt=ve.data;if(Je==="upload"&&Array.isArray(($t=jt.config)==null?void 0:$t.uploadedFiles)&&jt.config.uploadedFiles.length>0){const xt=jt.config.uploadedFiles,Et=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="VIDEO"||As.startsWith("video/")}),Yt=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="IMAGE"||As.startsWith("image/")}),js=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),As=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="AUDIO"||As.startsWith("audio/")});return(ze==null?void 0:ze.type)==="aiVideo_swap"?Et?"VIDEO":Yt?"IMAGE":js?"AUDIO":null:Yt?"IMAGE":Et?"VIDEO":js?"AUDIO":null}if(Je==="assetSelector"){if((Ye=jt.config)!=null&&Ye.subjects)return"IMAGE";if((It=jt.config)!=null&&It.selectedAsset){const xt=jt.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Yt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Yt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Yt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":Et||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ve=>{var jt,$t,Ye;if(dt(ve)!=="IMAGE")return 0;if(ve.type==="upload")return((($t=(jt=ve.data)==null?void 0:jt.config)==null?void 0:$t.uploadedFiles)||[]).filter(xt=>xt.type==="IMAGE"||(xt.mimeType||"").startsWith("image/")).length;if(ve.type==="assetSelector"){const It=((Ye=ve.data)==null?void 0:Ye.config)||{};return It.subjects&&It.subjects.length>0?(It.subjects[0].images||[]).length:It.selectedAsset&&It.selectedAsset.type==="IMAGE"?1:0}return ve.type==="imagePreview"||ve.type==="aiImage",1},qt=ve=>{var xt,Et,Yt,js,es,Rs;const Je=nt((Et=(xt=ve.data)==null?void 0:xt.config)==null?void 0:Et.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const jt=(js=(Yt=ve.data)==null?void 0:Yt.config)==null?void 0:js.modelId,Ye=(((es=ve.data)==null?void 0:es.models)||i).find(As=>As.id===jt),It=Array.isArray((Rs=Ye==null?void 0:Ye.config)==null?void 0:Rs.supportedGenerationTypes)?Ye.config.supportedGenerationTypes.map(As=>nt(As)):[];return It.includes("å‚è€ƒå›¾")||It.includes("ä¸»ä½“å‚è€ƒ")?7:It.includes("é¦–å°¾å¸§")?2:It.includes("é¦–å¸§")||It.includes("å°¾å¸§")?1:(It.includes("æ–‡ç”Ÿè§†é¢‘"),0)},Rt=lt?dt(lt):null;if(ze.type.startsWith("aiVideo")&&Rt==="IMAGE"){if(nt((Ut=(Lt=ze.data)==null?void 0:Lt.config)==null?void 0:Ut.generationType)==="é¦–å°¾å¸§"&&lt&&lt.type==="assetSelector"){const xt=((Ot=lt.data)==null?void 0:Ot.config)||{};if(xt.subjects&&(((ft=xt.subjects[0])==null?void 0:ft.images)||[]).length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ks(null),xs.current=null,Zt.current=!1;return}}const Je=f.filter(xt=>xt.target===ze.id);let jt=0;Je.forEach(xt=>{const Et=U.find(Yt=>Yt.id===xt.source);Et&&(jt+=at(Et))});const $t=lt?at(lt):0,Ye=qt(ze),It=jt+$t;if(Ye===0){m.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ks(null),xs.current=null,Zt.current=!1;return}if(It>Ye){m.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Ye}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${It}å¼ ï¼‰`),Ks(null),xs.current=null,Zt.current=!1;return}}let ot;pt.type==="superCanvas"?ot="input-image":pt.type==="midjourney"&&(Rt==="IMAGE"?ot="omni-ref":Rt==="TEXT"&&(ot="text-input"));const Qe={id:`edge-${is.sourceNodeId}-${pt.id}`,source:is.sourceNodeId,target:pt.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(ve=>[...ve,Qe])}else if(is.handleType==="target"){const lt=U.find(Qe=>Qe.id===is.sourceNodeId),ze=(lt==null?void 0:lt.type)||"";if(ze==="agent"||ze==="aiImage"||ze==="midjourney"||ze.startsWith("aiVideo")){m.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ks(null),xs.current=null,Zt.current=!1;return}const nt=pt,dt=U.find(Qe=>Qe.id===is.sourceNodeId),at=Qe=>{const ve=(Qe||"").toLowerCase();return ve?ve.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("é¦–å°¾")?"é¦–å°¾å¸§":ve.includes("é¦–å¸§")?"é¦–å¸§":ve.includes("å°¾å¸§")?"å°¾å¸§":ve.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ve.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ve.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ve.includes("first-last")?"é¦–å°¾å¸§":ve.includes("first")?"é¦–å¸§":ve.includes("last")?"å°¾å¸§":ve.includes("subject")?"ä¸»ä½“å‚è€ƒ":ve.includes("reference")?"å‚è€ƒå›¾":Qe||"":""},Rt=(Qe=>{var jt,$t,Ye,It;const ve=Qe.type,Je=Qe.data;if(ve==="upload"&&(($t=(jt=Je.config)==null?void 0:jt.uploadedFiles)==null?void 0:$t.length)>0){const xt=Je.config.uploadedFiles[0],Et=(xt.type||"").toUpperCase(),Yt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Yt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Yt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":Et||null}if(ve==="assetSelector"){if((Ye=Je.config)!=null&&Ye.subjects)return"IMAGE";if((It=Je.config)!=null&&It.selectedAsset){const xt=Je.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Yt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Yt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Yt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":Et||null}}return ve==="aiImage"||ve==="imagePreview"?"IMAGE":ve==="aiVideo"||ve==="videoPreview"?"VIDEO":ve==="agent"?"TEXT":null})(nt);if(dt&&dt.type==="aiVideo"&&Rt==="IMAGE"&&at((Nt=(mt=dt.data)==null?void 0:mt.config)==null?void 0:Nt.generationType)==="é¦–å°¾å¸§"&&nt&&nt.type==="assetSelector"){const ve=((Ht=nt.data)==null?void 0:Ht.config)||{};if(ve.subjects&&ve.subjects.length>0){m.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ks(null),xs.current=null,Zt.current=!1;return}}const ot={id:`edge-${pt.id}-${is.sourceNodeId}`,source:pt.id,sourceHandle:pt.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(Qe=>[...Qe,ot])}Ks(null),xs.current=null,Zt.current=!1,m.success(`å·²æ·»åŠ ${S}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(pt.id)},100)},xr=t.useCallback(o=>{const S=U.filter(Pe=>o.includes(Pe.id));if(S.length===0)return null;const M=50;let H=1/0,Q=1/0,ke=-1/0,De=-1/0;return S.forEach(Pe=>{const He=Pe.position.x,Fe=Pe.position.y,rt=Pe.width||320,Xe=Pe.height||200;H=Math.min(H,He),Q=Math.min(Q,Fe),ke=Math.max(ke,He+rt),De=Math.max(De,Fe+Xe)}),{x:H-M,y:Q-M,width:ke-H+M*2,height:De-Q+M*2}},[U]),oa=t.useCallback(()=>{tr(o=>!o),er(!1)},[]),Ur=t.useCallback((o,S)=>{const M={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:S-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0}};R(H=>[...H,M]),tr(!1)},[R,ie]),na=t.useCallback(()=>{if(!a){m.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=U.filter(ke=>ke.selected);if(o.length===0){m.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){m.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const S=o.map(ke=>ke.id);if(Ke.some(ke=>ke.nodeIds.some(De=>S.includes(De)))){m.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const H=xr(S);if(!H){m.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const Q={id:`group-${Date.now()}`,nodeIds:S,bounds:H};yt(ke=>{const De=[...ke,Q];return Js(De),setTimeout(()=>{qs()},100),De}),wt(Q.id),R(ke=>{const De=new Set;return f.forEach(Pe=>{if(S.includes(Pe.source)){const He=ke.find(Fe=>Fe.id===Pe.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&De.add(Pe.target)}}),ke.map(Pe=>S.includes(Pe.id)?{...Pe,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:Q,nodeGroups:[...Ke,Q]}}}:De.has(Pe.id)?{...Pe,data:{...Pe.data,workflowContext:{...Pe.data.workflowContext,nodeGroup:Q,nodeGroups:[...Ke,Q]}}}:Pe)}),m.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${S.length} ä¸ªèŠ‚ç‚¹`)},[U,xr,Ke,R]),ia=t.useCallback(()=>{if(!a){m.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Be){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ke.find(S=>S.id===Be);o&&(R(S=>S.map(M=>o.nodeIds.includes(M.id)?{...M,draggable:!0,connectable:!0,deletable:!0,data:{...M.data,workflowContext:{...M.data.workflowContext,nodeGroup:null,nodeGroups:Ke.filter(H=>H.id!==Be)}}}:M)),yt(S=>{const M=S.filter(H=>H.id!==Be);return Js(M),setTimeout(()=>{qs()},100),M}),wt(null),m.success("å·²è§£é™¤ç¼–ç»„"))},[Be,Ke,R,Js]),la=t.useCallback(()=>{if(!Be){m.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Bs(Be),Es(!0)},[Be]),Rr=t.useCallback((o,S)=>{o.stopPropagation(),o.preventDefault(),Zs(null),wt(S),nr(null)},[]);t.useEffect(()=>{if(!fs||!Hs)return;let o=Hs.x,S=Hs.y;const M=Q=>{const ke=Xs.current;if(!ke)return;const De=ee(),Pe=(Q.clientX-o)/De.zoom,He=(Q.clientY-S)/De.zoom;if(Math.abs(Pe)<.01&&Math.abs(He)<.01)return;const Fe=_t.current.find(rt=>rt.id===ke);Fe&&(yt(rt=>rt.map(Xe=>Xe.id===ke?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Pe,y:Xe.bounds.y+He}}:Xe)),R(rt=>rt.map(Xe=>Fe.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Pe,y:Xe.position.y+He}}:Xe)),o=Q.clientX,S=Q.clientY)},H=()=>{Zs(null),nr(null)};return document.addEventListener("mousemove",M),document.addEventListener("mouseup",H),()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",H)}},[fs,Hs]);const ca=t.useCallback(o=>{if(ws){const S=Re({x:o.clientX,y:o.clientY});Ur(S.x,S.y);return}hr(),Ks(null),xs.current=null,wt(null),Zt.current=!1},[hr,ws,Re,Ur]),Nr=t.useRef(null),da=t.useCallback(()=>{Ke.length>0&&!Nr.current&&(Nr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),Nr.current=null}))},[Ke.length]),ir=t.useCallback(o=>Ke.find(S=>S.nodeIds.includes(o))||null,[Ke]),ua=t.useCallback((o,S)=>{var H;if(bt||(H=S==null?void 0:S.data)!=null&&H.freeDrag)return;const M=ir(S.id);if(M){if(!M.hidden&&!a)return;Ps.current=S.id,q.current={x:S.position.x,y:S.position.y}}},[ir,a]),ga=t.useCallback((o,S)=>{var Q;if(bt||(Q=S==null?void 0:S.data)!=null&&Q.freeDrag||!q.current||Ps.current!==S.id)return;const M=ir(S.id);if(!M)return;const H=!M.hidden;if(!(H&&!a))if(H){const ke=S.position.x-q.current.x,De=S.position.y-q.current.y,Pe=[],He=M.nodeIds||[];se.current.forEach(Fe=>{if(He.includes(Fe.id)){const rt={x:Fe.id===S.id?S.position.x:Fe.position.x+ke,y:Fe.id===S.id?S.position.y:Fe.position.y+De};Pe.push({id:Fe.id,position:rt})}}),R(Fe=>Fe.map(rt=>{const Xe=Pe.find(Le=>Le.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Pe.length>0&&ts(Pe),yt(Fe=>{const rt=Fe.map(Xe=>Xe.id===M.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ke,y:Xe.bounds.y+De}}:Xe);return _t.current=rt,rt}),q.current={x:S.position.x,y:S.position.y}}else{const ke=M.bounds.x,De=M.bounds.y,Pe=M.bounds.width,He=M.bounds.height,Fe=(Le,pt,Lt)=>Math.max(pt,Math.min(Le,Lt)),rt=Fe(S.position.x,ke+10,ke+Pe-10),Xe=Fe(S.position.y,De+10,De+He-10);R(Le=>Le.map(pt=>pt.id===S.id?{...pt,position:{x:rt,y:Xe}}:pt)),q.current={x:rt,y:Xe}}},[R,yt,ir,a,ts]),ha=t.useCallback(()=>{Ps.current=null,q.current=null,Xs.current=null,Ps.current=null,q.current=null,Xs.current=null,Zs(null),_t.current.length>0&&Js(_t.current)},[Js]),fa=t.useCallback((o,S)=>{const M=ir(S.id);M&&wt(M.id)},[ir]);if(t.useEffect(()=>{if(f.length===0||U.length===0)return;const o=f.filter(S=>{const M=U.find(Q=>Q.id===S.source),H=U.find(Q=>Q.id===S.target);return(H==null?void 0:H.type)==="midjourney"&&S.targetHandle==="text-input"&&(M==null?void 0:M.type)!=="agent"});o.length>0&&(x(S=>S.filter(M=>!o.some(H=>H.id===M.id))),m.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[f,U,x]),te)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!be)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const $r=U.filter(o=>o.selected).length>=2,br=!!Be;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:vt,className:"flex-1 relative overflow-hidden",children:[F&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:$?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${$.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),be&&e.jsx("div",{className:`absolute left-1/2 -translate-x-1/2 ${F?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&pe?`${be.name} ç¬¬${pe.episodeNumber}é›†${!Oe&&re&&Y?` ç¬¬${re}å¹•ç¬¬${Y}é•œ`:""}`:be.name})}),!Oe&&Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-[100px] top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,S)=>o.scene!==S.scene?(o.scene||0)-(S.scene||0):(o.shot||0)-(S.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const S=o.bounds.x+o.bounds.width/2,M=o.bounds.y+o.bounds.height/2,H=vt.current;if(H){const Q=H.clientWidth,ke=H.clientHeight,De=.2,Pe=Q*(1-De),He=ke*(1-De),Fe=Pe/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(Fe,rt,1.5),Le=Math.max(Xe,.3);de(S,M,{zoom:Le,duration:800})}else de(S,M,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Be===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-[#deeaef]/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-[#deeaef] dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:"fixed right-[24px] top-1/2 -translate-y-1/2 z-[100] flex flex-col gap-1 p-2 rounded-2xl bg-[#deeaef] dark:bg-[#18181b] shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{onClick:()=>{if(qe&&j&&n){const o=Oe&&re&&Y?`?shot=${Y}`:"";T(`/projects/${j}/episodes/${n}${o}`)}else T("/quick")},className:"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"arrow_back"})}),e.jsx("div",{className:"h-px bg-neutral-200 dark:bg-neutral-700 my-1"}),!F&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!bt&&a&&er(!bs)},disabled:bt||!a,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":bs?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!bt&&a&&na()},disabled:bt||!a||!$r,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!$r?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_work"})}),e.jsx("button",{onClick:()=>{!bt&&a&&ia()},disabled:bt||!a||!br,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!br?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_off"})}),e.jsx("button",{onClick:()=>{!bt&&a&&la()},disabled:bt||!a||!br,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!br?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"edit"})}),e.jsx("button",{onClick:()=>oa(),className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${ws?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:ws?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"text_fields"})})]})]}),p&&Cs.length>0&&e.jsxs("div",{className:`absolute ${F?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:Cs.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.ai${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-neutral-600 dark:text-neutral-300",children:"person"})},o.id))}),Cs.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",Cs.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${ws?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Sa,{nodes:Bt,edges:f,onNodesChange:F?void 0:us,onEdgesChange:F?void 0:Zr,onNodesDelete:F?void 0:Qr,onEdgesDelete:F?void 0:ea,onConnect:F?void 0:Kr,onConnectStart:F?void 0:ra,onConnectEnd:F?void 0:aa,onEdgeDoubleClick:F?void 0:Yr,onPaneContextMenu:F?void 0:ta,onPaneClick:F?void 0:ca,onMove:da,onNodeClick:F?void 0:fa,onNodeDragStart:F?void 0:ua,onNodeDrag:F?void 0:ga,onNodeDragStop:F?void 0:ha,nodeTypes:wn,edgeTypes:yn,nodesDraggable:!F,nodesConnectable:!F,elementsSelectable:!F,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${F?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#525252",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:F?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Ea,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#525252"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#404040"})]})}),Ke.filter(o=>!o.hidden).map(o=>{const S=ee(),M=o.bounds.x*S.zoom+S.x,H=o.bounds.y*S.zoom+S.y,Q=o.bounds.width*S.zoom,ke=o.bounds.height*S.zoom,De=12*S.zoom,Pe=Math.max(1.25,1.25*S.zoom),He=document.documentElement.classList.contains("dark"),Fe=Be===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:M,y:H,width:Q,height:ke,rx:De,ry:De,fill:"none",stroke:Fe?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Pe,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:M,y:H,width:Q,height:ke,rx:De,ry:De,fill:"transparent",stroke:"transparent",strokeWidth:Pe*3,style:{pointerEvents:"stroke",cursor:fs===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),Rr(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ke.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const S=ee(),M=o.bounds.x*S.zoom+S.x,H=o.bounds.y*S.zoom+S.y,Q=40*S.zoom,ke=10*S.zoom,De=15*S.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Pe=>{Pe.stopPropagation(),Rr(Pe,o.id)},onClick:Pe=>{Pe.stopPropagation(),wt(o.id)},style:{left:M+ke,top:H-Q-ke-De,fontSize:`${Q}px`,cursor:fs===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),u&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:u.x,top:u.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("agent")},onMouseLeave:()=>{N.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ne("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),W==="agent"&&e.jsx("div",{onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("agent")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(N.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:D.length>0?D.map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),Ee(!0)},onMouseLeave:()=>{N.current=window.setTimeout(()=>{Ee(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),J&&e.jsxs("div",{onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),Ee(!0)},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(N.current=window.setTimeout(()=>{Ee(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),B(!0)},onMouseLeave:()=>{Ne.current=window.setTimeout(()=>{B(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),E&&e.jsxs("div",{onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),B(!0)},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(Ne.current=window.setTimeout(()=>{B(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("edit")},onMouseLeave:()=>{N.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),W==="edit"&&e.jsxs("div",{onMouseEnter:()=>{N.current&&(clearTimeout(N.current),N.current=null),ne("edit")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(N.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[et.filter(o=>Ft(o).length>0).map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),he(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),et.every(o=>Ft(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Ys.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Ae(!0),onMouseLeave:()=>Ae(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),$e&&e.jsx("div",{onMouseEnter:()=>{_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:D.length>0?D.map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),ls("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Ys.showAiImage&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Ys.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("imageEdit")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),xe==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("imageEdit")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(h.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Ys.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("video")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),xe==="video"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),oe("video")},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(h.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ls("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ls("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ls("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ls("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Ys.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),Te.current&&(clearTimeout(Te.current),Te.current=null),he(!0)},onMouseLeave:()=>{Te.current=window.setTimeout(()=>{he(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>he(!0),onMouseLeave:()=>he(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),he(!0)},onMouseOver:()=>oe(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),k&&e.jsxs("div",{onMouseEnter:()=>{Te.current&&(clearTimeout(Te.current),Te.current=null),he(!0)},onMouseLeave:o=>{const S=o.currentTarget.parentElement,M=o.relatedTarget;(!S||!S.contains(M))&&(Te.current=window.setTimeout(()=>{he(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[et.filter(o=>Ft(o).length>0).map(o=>e.jsxs("button",{onMouseDown:S=>{S.preventDefault(),S.stopPropagation(),o==="å¯¹å£å‹"?ls("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?ls("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ls("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),he(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),et.every(o=>Ft(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ys.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ys.showUpload&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Ys.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Ys.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(bn,{isOpen:Mt,onClose:()=>{At(!1),gt(null)},onAssetSelect:sa}),Is&&Ns&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Es(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Es(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),S=document.getElementById("shot-input"),M=parseInt((o==null?void 0:o.value)||"0"),H=parseInt((S==null?void 0:S.value)||"0");if(M>0&&H>0){if(Ke.find(ke=>ke.id!==Ns&&ke.scene===M&&ke.shot===H)){m.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${M}å¹•-ç¬¬${H}é•œ`);return}yt(ke=>{const De=ke.map(He=>He.id===Ns?{...He,scene:M,shot:H,name:`ç¬¬${M}å¹•-ç¬¬${H}é•œ`}:He),Pe=De.find(He=>He.id===Ns);return Pe&&R(He=>{const Fe=new Set;return f.forEach(rt=>{if(Pe.nodeIds.includes(rt.source)){const Xe=He.find(Le=>Le.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&Fe.add(rt.target)}}),He.map(rt=>Pe.nodeIds.includes(rt.id)||Fe.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Pe,nodeGroups:De}}}:rt)}),setTimeout(()=>{qs()},100),De}),Es(!1),Bs(null),m.success(`å·²å‘½åä¸ºï¼šç¬¬${M}å¹•-ç¬¬${H}é•œ`)}else m.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},An=()=>e.jsx(va,{children:e.jsx(kn,{})});export{An as default};
