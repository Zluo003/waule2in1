const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CKw8I0iR.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-DihS8SAn.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Wt,u as Ar,z as Ds,e as xa,d as ba}from"./react-vendor-BvY2dB7B.js";import{u as _r,l as wa,b as _e,_ as us,c as h,e as ya}from"./index-CKw8I0iR.js";import{P as gt,H as hs,a as Zt,b as Os,d as Xs,e as Js,g as ka,R as va,f as Na,h as ja,i as Ia,j as Sa,C as Ea}from"./reactflow-D8v6_Qvs.js";import{C as Ca,L as Ls,S as xr,I as Lr,T as Hr,V as Aa}from"./video-CPXLMxBS.js";import{c as Us}from"./createLucideIcon-CK1cQnin.js";import{X as _a,j as Zs,L as Bs,o as Or,a as Ta,v as or,U as Gr,b as Ua,N as Ra}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Us("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Us("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Us("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Us("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Us("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Us("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Us("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cr=Us("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Us("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Us("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xr=Us("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=Us("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),za="https://api.waule.ai";function Ba(s){const{workflowId:S,isSharedWorkflow:l,isReadOnly:F,onNodeAdd:fe,onNodeUpdate:T,onNodeDelete:he,onNodeMove:Q,onNodesMove:oe,onEdgeAdd:ee,onEdgeDelete:pe,onGroupsUpdate:Ae,onUserJoin:xe}=s,Z=t.useRef(null),te=t.useRef(!1),{token:Se}=_r(),[ie,we]=t.useState([]);t.useEffect(()=>{if(!l||!S||!Se)return;const g=wa(za,{auth:{token:Se},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return Z.current=g,g.on("connect",()=>{te.current=!0,g.emit("join-workflow",S),g.emit("user:join",{workflowId:S})}),g.on("disconnect",m=>{te.current=!1}),g.on("connect_error",m=>{}),g.on("node:add",m=>{fe==null||fe(m.node,m.userId)}),g.on("node:update",m=>{T==null||T(m.nodeId,m.changes,m.userId)}),g.on("node:delete",m=>{he==null||he(m.nodeId,m.userId)}),g.on("node:move",m=>{Q==null||Q(m.nodeId,m.position,m.userId)}),g.on("nodes:move",m=>{oe==null||oe(m.nodes,m.userId)}),g.on("edge:add",m=>{ee==null||ee(m.edge,m.userId)}),g.on("edge:delete",m=>{pe==null||pe(m.edgeId,m.userId)}),g.on("groups:update",m=>{Ae==null||Ae(m.groups,m.userId)}),g.on("user:join",m=>{xe==null||xe(m.user)}),g.on("users:online",m=>{we(m.users)}),()=>{Z.current&&(Z.current.emit("leave-workflow",S),Z.current.disconnect(),Z.current=null),te.current=!1,we([])}},[S,l,Se]);const ue=t.useCallback(g=>{Z.current&&te.current&&S&&!F&&Z.current.emit("node:add",{workflowId:S,node:g})},[S,F]),be=t.useCallback((g,m)=>{Z.current&&te.current&&S&&!F&&Z.current.emit("node:update",{workflowId:S,nodeId:g,changes:m})},[S,F]),Ee=t.useCallback(g=>{Z.current&&te.current&&S&&!F&&Z.current.emit("node:delete",{workflowId:S,nodeId:g})},[S,F]),le=t.useCallback((g,m)=>{Z.current&&te.current&&S&&!F&&Z.current.emit("node:move",{workflowId:S,nodeId:g,position:m})},[S,F]),re=t.useCallback(g=>{Z.current&&te.current&&S&&!F&&Z.current.emit("nodes:move",{workflowId:S,nodes:g})},[S,F]),R=t.useCallback(g=>{Z.current&&te.current&&S&&!F&&Z.current.emit("edge:add",{workflowId:S,edge:g})},[S,F]),$=t.useCallback(g=>{Z.current&&te.current&&S&&!F&&Z.current.emit("edge:delete",{workflowId:S,edgeId:g})},[S,F]),O=t.useCallback(g=>{Z.current&&te.current&&S&&!F&&Z.current.emit("groups:update",{workflowId:S,groups:g})},[S,F]);return{isConnected:te.current,onlineUsers:ie,emitNodeAdd:ue,emitNodeUpdate:be,emitNodeDelete:Ee,emitNodeMove:le,emitNodesMove:re,emitEdgeAdd:R,emitEdgeDelete:$,emitGroupsUpdate:O}}const cr=2560,Ha=10,vr=(s,S=cr,l=.9)=>new Promise((F,fe)=>{const T=new Image,he=URL.createObjectURL(s);T.onload=()=>{URL.revokeObjectURL(he);let{width:Q,height:oe}=T;const ee=Math.min(Q,oe);if(ee>S){const Z=S/ee;Q=Math.round(Q*Z),oe=Math.round(oe*Z)}const pe=document.createElement("canvas");pe.width=Q,pe.height=oe;const Ae=pe.getContext("2d");if(!Ae){fe(new Error("Failed to get canvas context"));return}Ae.drawImage(T,0,0,Q,oe);const xe=pe.toDataURL("image/jpeg",l);F(xe)},T.onerror=()=>{URL.revokeObjectURL(he),fe(new Error("Failed to load image for compression"))},T.src=he}),Vr=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(l=>l.test(s)):!1,Xa=async s=>{try{const S=s.startsWith("/uploads/")?`https://api.waule.ai${s}`:s,F=await(await fetch(S)).blob();return await vr(F,cr,.9)}catch(S){throw S}},ur=async(s,S)=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(S!=null&&S.skipCompression)return s;if(s.length>500*1024)try{const T=await(await fetch(s)).blob();return await vr(T,cr,.9)}catch{return s}return s}const l=s.includes("aliyuncs.com")||s.includes("oss-cn-"),F=s.startsWith("https://")&&!Vr(s);if(l||F){if(S!=null&&S.skipCompression)return s;try{const fe=new AbortController,T=setTimeout(()=>fe.abort(),3e4);let he=0;try{const Z=(await fetch(s,{method:"HEAD",signal:fe.signal})).headers.get("content-length");Z&&(he=parseInt(Z)/(1024*1024))}catch{}const Q=await fetch(s,{signal:fe.signal});clearTimeout(T);const oe=await Q.blob();if(oe.size/(1024*1024)>Ha)return await vr(oe,cr,.85);const pe=await Ja(oe);return Math.min(pe.width,pe.height)>cr?await vr(oe,cr,.9):s}catch(fe){if(fe.name==="AbortError")throw new Error("å›¾ç‰‡ä¸‹è½½è¶…æ—¶");return s}}return Vr(s)?await Xa(s):s},Ja=s=>new Promise((S,l)=>{const F=new Image,fe=URL.createObjectURL(s);F.onload=()=>{URL.revokeObjectURL(fe),S({width:F.width,height:F.height})},F.onerror=()=>{URL.revokeObjectURL(fe),l(new Error("Failed to load image"))},F.src=fe}),At=({type:s,position:S,id:l,className:F="",label:fe,isConnectable:T,disabled:he,style:Q,...oe})=>{const ee=S===gt.Left,pe=T===!1||he?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${F}`;return e.jsxs("div",{className:`absolute ${ee?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...Q||{}},children:[ee&&fe&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:fe}),e.jsx(hs,{type:s,position:S,id:l,isConnectable:he?!1:T,style:{position:"relative",[ee?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${pe} !z-[10001]`,...oe}),!ee&&fe&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:fe})]})},as=({value:s,onChange:S,options:l,className:F=""})=>{const[fe,T]=t.useState(!1),he=t.useRef(null);t.useEffect(()=>{if(!fe)return;const ee=pe=>{he.current&&!he.current.contains(pe.target)&&T(!1)};return document.addEventListener("mousedown",ee,!0),()=>document.removeEventListener("mousedown",ee,!0)},[fe]);const Q=l.find(ee=>ee.value===s),oe=ee=>{ee.stopPropagation(),T(!fe)};return e.jsxs("div",{className:`relative ${F}`,ref:he,children:[e.jsxs("div",{onClick:oe,onMouseDown:ee=>ee.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(Q==null?void 0:Q.label)||s}),e.jsx(Ca,{size:12,className:`transition-transform ${fe?"rotate-90":""}`})]}),fe&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white dark:bg-[#18181b] backdrop-blur-xl border-slate-200 dark:border-white/10",children:l.map(ee=>e.jsxs("div",{onClick:pe=>{pe.stopPropagation(),S(ee.value),T(!1)},onMouseDown:pe=>pe.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[ee.label,s===ee.value&&e.jsx(Da,{size:10,className:"text-neutral-500"})]},ee.value))})]})},Ns=s=>{const[S,l]=t.useState(null),[F,fe]=t.useState(!1),[T,he]=t.useState(!1),[Q,oe]=t.useState(0),[ee,pe]=t.useState(0),Ae=t.useCallback(()=>{pe(xe=>xe+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){l(null),he(!1),oe(0);return}try{fe(!0);const te=(await _e.post("/billing/estimate",s)).data,Se=(te==null?void 0:te.data)??te,ie=(Se==null?void 0:Se.originalCredits)??(Se==null?void 0:Se.credits)??0;l(ie),he((Se==null?void 0:Se.isFreeUsage)??!1),oe((Se==null?void 0:Se.freeUsageRemaining)??0)}catch{l(null),he(!1),oe(0)}finally{fe(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,ee]),{credits:S,loading:F,isFreeUsage:T,freeUsageRemaining:Q,refetch:Ae}},fs=({createdBy:s,isSharedWorkflow:S})=>{if(!S||!s||typeof s=="string")return null;const{nickname:l,avatar:F}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:l||"æœªçŸ¥ç”¨æˆ·",children:F?e.jsx("img",{src:F,alt:l||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-neutral-800 to-neutral-700 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(l||"?")[0].toUpperCase()})})},qa=({data:s,selected:S,id:l})=>{var q;const[F,fe]=t.useState(s.isExpanded!==!1),[T,he]=t.useState(null),[Q,oe]=t.useState(s.config.prompt||""),[ee,pe]=t.useState(s.config.ratio||""),[Ae,xe]=t.useState(s.config.imageSize||"2K"),[Z,te]=t.useState(s.config.maxImages||1),[Se,ie]=t.useState(!1),[,we]=t.useState(0),[,ue]=t.useState(s.config.taskId||""),[be,Ee]=t.useState(s.config.referenceImages||[]),[le,re]=t.useState(null),R=t.useRef(null),$=t.useRef(!1),{setNodes:O,setEdges:g,getNode:m,getEdges:_,getNodes:z}=Zt(),P=Os(),C=Xs(x=>x.edges.filter(d=>d.target===l)),W=t.useRef(""),r=t.useRef(""),{credits:y,loading:p,isFreeUsage:a,freeUsageRemaining:v,refetch:u}=Ns({aiModelId:T==null?void 0:T.id,quantity:1,resolution:Ae}),w=t.useMemo(()=>(s.models||[]).filter(x=>x.type==="IMAGE_GENERATION"&&x.isActive&&!x.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const x=w.find(d=>d.id===s.config.modelId);if(x){he(x);const d=x.config;d!=null&&d.supportedRatios&&d.supportedRatios.length>0&&!ee&&pe(d.supportedRatios[0]),s.config.acceptedInputs||i({acceptedInputs:(d==null?void 0:d.acceptedInputs)||["TEXT","IMAGE"]})}}else if(w.length>0){he(w[0]);const x=w[0].config;x!=null&&x.supportedRatios&&x.supportedRatios.length>0&&!ee&&pe(x.supportedRatios[0]),s.config.acceptedInputs||i({acceptedInputs:(x==null?void 0:x.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,w]),t.useEffect(()=>{const x=s.config.taskId;(async()=>{if(x)try{const b=(await _e.tasks.getTaskStatus(x)).task;if(b.status==="SUCCESS"){ie(!1),we(100);const J=b.resultUrl;if(!J){ie(!1),we(0),i({taskId:""}),Wt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ce=s.config.ratio||"1:1";i({prompt:s.config.prompt||Q,ratio:ce,modelId:s.config.modelId||(T==null?void 0:T.id),generatedImageUrl:J,taskId:""});const B=z(),ge=_();if(B.filter($e=>$e.type==="imagePreview"&&ge.some(Te=>Te.source===l&&Te.target===$e.id)).find($e=>$e.data.imageUrl===J)){i({taskId:""}),Wt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Wt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const $e=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse($e).some(Re=>Re.taskId&&Re.taskId===x||Re.sourceNodeId&&Re.sourceNodeId===l)||de(J,ce)}catch{de(J,ce)}}else b.status==="PROCESSING"||b.status==="PENDING"?(ie(!0),we(b.progress||0),V(x)):b.status==="FAILURE"&&(ie(!1),we(0),i({taskId:""}),Wt.error(b.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${b.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ie(!1),we(0),i({taskId:""}),Wt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const f=()=>{if(!T)return[];const x=T.config;return(x==null?void 0:x.supportedRatios)||[]},N=()=>{var b;const x=(b=s==null?void 0:s.config)==null?void 0:b.modelId,d=w.find(J=>J.id===x)||w[0],I=(d==null?void 0:d.config)||{};return I.maxReferenceImages||I.supportedReferenceImagesLimit||I.referenceImagesLimit||10};function j(x){var I,b,J,ce,B,ge,Ce;const d=(x==null?void 0:x.type)||"";if(d==="upload")return(((b=(I=x==null?void 0:x.data)==null?void 0:I.config)==null?void 0:b.uploadedFiles)||[]).reduce(($e,Te)=>{const Ue=((Te==null?void 0:Te.type)||"").toUpperCase(),Re=((Te==null?void 0:Te.mimeType)||"").toLowerCase();return $e+(Ue==="IMAGE"||Re.startsWith("image/")?1:0)},0);if(d==="assetSelector"){const ve=((J=x==null?void 0:x.data)==null?void 0:J.config)||{};if(ve.selectedAsset){const $e=(ve.selectedAsset.type||"").toUpperCase(),Te=(ve.selectedAsset.mimeType||"").toLowerCase();return $e==="IMAGE"||Te.startsWith("image/")?1:0}return Array.isArray(ve.subjects)&&ve.subjects.length>0&&(((ce=ve.subjects[0])==null?void 0:ce.images)||[]).length>0?1:0}return d==="aiImage"?((ge=(B=x==null?void 0:x.data)==null?void 0:B.config)==null?void 0:ge.generatedImageUrl)?1:0:d==="imagePreview"&&((Ce=x==null?void 0:x.data)==null?void 0:Ce.imageUrl)?1:0}function U(x){var b,J,ce,B;const d=(x==null?void 0:x.type)||"",I=x==null?void 0:x.data;if(d==="upload"&&((J=(b=I==null?void 0:I.config)==null?void 0:b.uploadedFiles)==null?void 0:J.length)>0){const ge=I.config.uploadedFiles[0],Ce=(ge.type||"").toUpperCase(),ve=(ge.mimeType||"").toLowerCase();return Ce==="IMAGE"||ve.startsWith("image/")?"IMAGE":Ce==="VIDEO"||ve.startsWith("video/")?"VIDEO":Ce==="AUDIO"||ve.startsWith("audio/")?"AUDIO":Ce||null}if(d==="assetSelector"){if((ce=I==null?void 0:I.config)!=null&&ce.subjects)return"IMAGE";if((B=I==null?void 0:I.config)!=null&&B.selectedAsset){const ge=I.config.selectedAsset,Ce=(ge.type||"").toUpperCase(),ve=(ge.mimeType||"").toLowerCase();return Ce==="IMAGE"||ve.startsWith("image/")?"IMAGE":Ce==="VIDEO"||ve.startsWith("video/")?"VIDEO":Ce==="AUDIO"||ve.startsWith("audio/")?"AUDIO":Ce||null}}return d==="aiImage"||d==="imagePreview"?"IMAGE":(d||"").startsWith("aiVideo")||d==="videoPreview"?"VIDEO":d==="agent"?"TEXT":null}const k=t.useMemo(()=>{const x=C,d=x.some(J=>{const ce=m(J.source);return((ce==null?void 0:ce.type)||"")==="agent"}),I=N(),b=x.reduce((J,ce)=>J+j(m(ce.source)),0);return d&&b>=I},[C,m]),c=x=>{const d=m(x.source);if(!d)return!1;const I=d.type||"",b=_().filter(ve=>ve.target===l),J=U(d);if(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")return!1;const ce=b.some(ve=>{const $e=m(ve.source);return(($e==null?void 0:$e.type)||"")==="agent"});if(I==="agent"||I==="textPreview")return!ce;const B=b.reduce((ve,$e)=>ve+j(m($e.source)),0),ge=j(d),Ce=N();return B+ge<=Ce};t.useEffect(()=>{const x=C;let I=N();const b=[];x.forEach(J=>{const ce=m(J.source),B=j(ce);B<=0||(I-B>=0?I-=B:b.push(J.id))}),b.length>0&&(g(J=>J.filter(ce=>!b.includes(ce.id))),Wt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[C,m,g]),t.useEffect(()=>{const x=C,d=[];x.forEach(I=>{const b=m(I.source),J=U(b);(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")&&d.push(I.id)}),d.length>0&&(g(I=>I.filter(b=>!d.includes(b.id))),Wt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[C,m,g]),t.useEffect(()=>{const x=C.map(ce=>{var ve,$e,Te,Ue,Re;const B=m(ce.source);if(!B)return`${ce.id}-${ce.source}`;const ge=B.data||{};let Ce=[];if(B.type==="assetSelector"){const se=(ve=ge.config)==null?void 0:ve.subjects;if(se&&se.length>0){const Ve=($e=se[0].images)==null?void 0:$e[0];Ce=Ve?[Ve]:[]}else(Te=ge.config)!=null&&Te.selectedAsset&&ge.config.selectedAsset.type==="IMAGE"&&(Ce=[ge.config.selectedAsset.url])}else if(B.type==="upload")Ce=(((Ue=ge.config)==null?void 0:Ue.uploadedFiles)||[]).filter(Ve=>Ve.type==="IMAGE").map(Ve=>Ve.url);else if(B.type==="aiImage"||B.type==="imagePreview"){const se=((Re=ge.config)==null?void 0:Re.generatedImageUrl)||ge.imageUrl;se&&(Ce=[se])}return`${ce.id}-${ce.source}-${Ce.join("|")}`}).sort().join(",");if(x===W.current)return;W.current=x;const d=[];let I="";C.forEach(ce=>{var ge,Ce,ve,$e,Te,Ue;const B=m(ce.source);if(B){const Re=B.data;if(B.type==="agent"&&((ge=Re.config)!=null&&ge.generatedText)?I||(I=Re.config.generatedText):B.type==="textPreview"&&Re.content&&(I||(I=Re.content)),B.type==="assetSelector"&&((Ce=Re.config)!=null&&Ce.subjects)&&Re.config.subjects.length>0){const Ve=(ve=Re.config.subjects[0].images)==null?void 0:ve[0];Ve&&!d.includes(Ve)&&d.push(Ve)}let se=(($e=Re.config)==null?void 0:$e.generatedImageUrl)||Re.imageUrl||"";if(!se&&((Te=Re.config)!=null&&Te.selectedAsset)){const Ve=Re.config.selectedAsset;Ve.type==="IMAGE"&&(se=Ve.url)}if(!se&&((Ue=Re.config)!=null&&Ue.uploadedFiles)&&Re.config.uploadedFiles.length>0){const Ve=Re.config.uploadedFiles[0];Ve.type==="IMAGE"&&(se=Ve.url)}se&&!d.includes(se)&&d.push(se)}});const b=N(),J=d.slice(0,Math.max(0,b));Ee(J),i({referenceImages:J}),I&&I!==Q&&(oe(I),i({prompt:I}))},[C,m,l,Q,P]),t.useEffect(()=>{if(C.length===0)return;let x="",d="";C.forEach(I=>{var J;const b=P.find(ce=>ce.id===I.source);if(b&&b.type==="agent"){const ce=b.data;(J=ce.config)!=null&&J.generatedText&&(x=ce.config.generatedText,d=`${b.id}-${ce.config.generatedText.substring(0,50)}`)}}),x&&d!==r.current&&(r.current=d,oe(x),i({prompt:x}))},[P,C,l]),t.useEffect(()=>{const x=R.current;x&&F&&requestAnimationFrame(()=>{x.style.height="auto";const d=Math.max(60,Math.min(x.scrollHeight,600));x.style.height=`${d}px`})},[Q,F]),t.useEffect(()=>{const x=setTimeout(()=>{Q!==s.config.prompt&&i({prompt:Q})},300);return()=>clearTimeout(x)},[Q]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Q&&oe(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{ee&&ee!==s.config.ratio&&i({ratio:ee})},[ee]),t.useEffect(()=>{Ae&&Ae!==s.config.imageSize&&i({imageSize:Ae})},[Ae]),t.useEffect(()=>{var x;if((T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"){const d=((x=T==null?void 0:T.config)==null?void 0:x.supportedResolutions)||[];(d.length>0&&!d.includes(Ae)||d.length===1)&&xe(d[0])}},[T]),t.useEffect(()=>{Z!==s.config.maxImages&&i({maxImages:Z})},[Z]);const i=x=>{m(l)&&O(I=>I.map(b=>b.id===l?{...b,data:{...b.data,config:{...b.data.config,...x}}}:b))},n=x=>{re(x)},G=(x,d)=>{if(x.preventDefault(),le===null||le===d)return;const I=[...be],b=I[le];I.splice(le,1),I.splice(d,0,b),Ee(I),re(d)},M=()=>{re(null),i({referenceImages:be})},V=async x=>{let I=0;const b=async()=>{var J;try{I++;const B=(await _e.tasks.getTaskStatus(x)).task;if(we(B.progress||0),B.status==="SUCCESS"){ie(!1),we(100);const ge=B.resultUrl,Ce=(J=B.metadata)==null?void 0:J.allImageUrls;i({prompt:Q,ratio:ee,modelId:T==null?void 0:T.id,generatedImageUrl:ge,taskId:""}),Ce&&Ce.length>1?(ne(Ce,ee),Wt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Ce.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(de(ge,ee),Wt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(B.status==="FAILURE"){ie(!1),we(0),i({taskId:""});const{useAuthStore:ge}=await us(async()=>{const{useAuthStore:ve}=await import("./index-CKw8I0iR.js").then($e=>$e.f);return{useAuthStore:ve}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ce}=ge.getState();await Ce(),Wt.error(B.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(B.status==="PROCESSING"||B.status==="PENDING")&&(I<600?setTimeout(b,1e3):(ie(!1),we(0),i({taskId:""}),Wt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ie(!1),we(0),i({taskId:""}),Wt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};b()},D=async()=>{var x,d,I,b,J;if(!(!Q.trim()||!T)){ie(!0),we(0);try{let ce=[];if(be.length>0){const Re=T.modelId==="gemini-3-pro-image-preview";try{for(let se=0;se<be.length;se++){const Ve=be[se];try{const Ze=await ur(Ve,{skipCompression:Re});ce.push(Ze)}catch{}}}catch{}}let B=Q.trim();T.modelId==="doubao-seedream-4-5-251128"&&Z>1&&(B=`ç”Ÿæˆä¸€ç»„å…±${Z}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${B}`),T.modelId==="gemini-3-pro-image-preview"&&ee&&(B=`${B}ï¼Œç”Ÿæˆ${ee}çš„æ¯”ä¾‹`);const ge={modelId:T.id,prompt:B,ratio:ee||"1:1",referenceImages:ce.length>0?ce:void 0};T.modelId==="gemini-3-pro-image-preview"&&(ge.imageSize=Ae),T.modelId==="doubao-seedream-4-5-251128"&&Z>1&&(ge.maxImages=Z);const Ce=await _e.tasks.createImageTask(ge),ve=Ce.taskId,$e=Ce.creditsCharged||0,Te=Ce.isFreeUsage,Ue=Ce.freeUsageRemaining??0;if(ue(ve),i({prompt:Q,ratio:ee,modelId:T.id,taskId:ve}),Te)Wt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Ue} æ¬¡æœºä¼š`),u();else if($e>0){const{useAuthStore:Re}=await us(async()=>{const{useAuthStore:Ve}=await import("./index-CKw8I0iR.js").then(Ze=>Ze.f);return{useAuthStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:se}=Re.getState();await se(),Wt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${$e} ç§¯åˆ†`),u()}else Wt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");V(ve)}catch(ce){if(ie(!1),we(0),((x=ce.response)==null?void 0:x.status)===403){const B=((I=(d=ce.response)==null?void 0:d.data)==null?void 0:I.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Wt.error(B)}else{const B=((J=(b=ce.response)==null?void 0:b.data)==null?void 0:J.error)||ce.message||"æœªçŸ¥åŸå› ";Wt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ne=(x,d)=>{!x||x.length===0||x.forEach((I,b)=>{setTimeout(()=>{de(I,d,b)},b*100)})},de=(x,d,I)=>{const b=m(l);if(!b)return;const J=1,ce=z(),B=_(),ge=ce.filter(vt=>vt.type==="imagePreview"&&B.some(ze=>ze.source===l&&ze.target===vt.id));if(ge.find(vt=>vt.data.imageUrl===x))return;const ve=400,$e=(vt,ze=300)=>{if(!vt||!/^[0-9]+\s*:\s*[0-9]+$/.test(vt))return ze;const[wt,ts]=vt.split(":").map(ms=>parseFloat(ms));return!wt||!ts?ze:Math.round(ve*(ts/wt))},Te=document.querySelector(`.react-flow__node[data-id="${l}"]`),Ue=(Te==null?void 0:Te.getBoundingClientRect().width)||400,Re=Math.round(Ue/J),se=200,Ve=100,Ze=$e(d,300),zt=b.position.x+Re+se,Ot=b.position.y,Tt=I!==void 0?ge.length+I:ge.length,dt=zt,pt=Ot+Tt*(Ze+Ve),Nt=Date.now(),lt={id:`preview-${l}-${Nt}`,type:"imagePreview",position:{x:dt,y:pt},data:{imageUrl:x,width:ve,ratio:d,workflowContext:b.data.workflowContext,createdBy:b.data.createdBy}};O(vt=>[...vt,lt]);const Ke={id:`edge-${l}-${lt.id}`,source:l,target:lt.id,targetHandle:`${lt.id}-target`,type:"aurora"};g(vt=>vt.find(wt=>wt.source===l&&wt.target===lt.id)?vt:[...vt,Ke])};if(t.useEffect(()=>{s.isExpanded!==void 0&&fe(s.isExpanded)},[s.isExpanded]),!F&&s.config.generatedImageUrl){const[x,d]=(s.config.ratio||"1:1").split(":").map(Number),I=x/d,b=320,J=b/I;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:b,height:J},onDoubleClick:()=>{fe(!0),m(l)&&O(B=>B.map(ge=>ge.id===l?{...ge,data:{...ge.data,isExpanded:!0}}:ge))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:k,isValidConnection:c}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),Q&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:Q,children:Q})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!F&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{fe(!0),m(l)&&O(d=>d.map(I=>I.id===l?{...I,data:{...I.data,isExpanded:!0}}:I))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:k,isValidConnection:c}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:Q})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:k,isValidConnection:c}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:(T==null?void 0:T.id)||"",onChange:x=>{const d=w.find(I=>I.id===x);if(he(d||null),d){const I=d.config;I!=null&&I.supportedRatios&&I.supportedRatios.length>0&&pe(I.supportedRatios[0]),i({modelId:d.id,acceptedInputs:(I==null?void 0:I.acceptedInputs)||["TEXT","IMAGE"]})}},options:w.map(x=>({value:x.id,label:x.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:R,value:Q,onChange:x=>{$.current=!0,oe(x.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),be.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",be.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:be.map((x,d)=>e.jsxs("div",{draggable:!0,onDragStart:I=>{I.stopPropagation(),n(d)},onDragEnd:I=>{I.stopPropagation(),M()},onDragOver:I=>{I.stopPropagation(),G(I,d)},className:`nodrag relative group cursor-move aspect-square ${le===d?"opacity-50":""}`,children:[e.jsx("img",{src:x,alt:`å›¾ç‰‡${d+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:d+1})]},d))})]}),(T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"&&(()=>{var d;const x=((d=T==null?void 0:T.config)==null?void 0:d.supportedResolutions)||[];return x.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${x.length} gap-2`,children:x.map(I=>e.jsx("button",{onClick:()=>xe(I),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Ae===I?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:I==="4K"?"4k":"hd"}),e.jsx("span",{children:I})]})},I))})]})})(),(T==null?void 0:T.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-neutral-500 dark:text-neutral-400",children:[Z," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:Z,onChange:x=>te(Number(x.target.value)),className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(Z-1)/14*50}%, #06b6d4 ${(Z-1)/14*100}%, var(--range-bg-color) ${(Z-1)/14*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),Z>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),f().length>0&&e.jsx("div",{className:"space-y-1",children:((q=T==null?void 0:T.provider)==null?void 0:q.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>pe("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${ee==="16:9"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>pe("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${ee==="9:16"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(as,{value:ee,onChange:x=>pe(x),options:f().map(x=>{const[d,I]=x.split(":");return{value:x,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[x]||`${d}:${I}`}})})]})}),e.jsx("button",{onClick:x=>{x.stopPropagation(),D()},onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),disabled:Se||!Q.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Se||!Q.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Se?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!p&&(a?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(v),"æ¬¡"]}):y!==null&&y>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[y,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ka=t.memo(qa),fr="https://api.waule.ai",Ya=({data:s,selected:S,id:l})=>{var rr,Vs,K,ae,Me,Ge,qe,Oe,tt,bt,yt;const[F,fe]=t.useState(!0),[,T]=t.useState(0),[he,Q]=t.useState(s.config.taskId||""),oe=s.config.modelId,ee=s.config.duration||5,pe=s.config.resolution||"720p",{credits:Ae,loading:xe,isFreeUsage:Z,freeUsageRemaining:te,refetch:Se}=Ns({aiModelId:oe,duration:ee,resolution:pe});t.useEffect(()=>{},[he]);const{setNodes:ie,setEdges:we,getNode:ue,getNodes:be,getEdges:Ee}=Zt(),le=Js(),re=Os(),R=t.useRef(""),$=(rr=s.config)==null?void 0:rr.selectedEditingCapability,O=t.useMemo(()=>{const E=(s.models||[]).filter(H=>{var Ne;return((Ne=H.provider)==null?void 0:Ne.toLowerCase())!=="sora"&&H.id!=="sora-video"});if($){const H=E.filter(me=>me.type==="VIDEO_EDITING").filter(me=>{var Ie;return Array.isArray((Ie=me==null?void 0:me.config)==null?void 0:Ie.supportedEditingCapabilities)&&me.config.supportedEditingCapabilities.includes($)}),Ne=E.filter(me=>me.type==="VIDEO_GENERATION").filter(me=>{var Rt,st;if($!=="è§†é¢‘æ¢äºº")return!1;const Ie=((Rt=me==null?void 0:me.config)==null?void 0:Rt.supportsVideoEditing)===!0,Ye=(Array.isArray((st=me==null?void 0:me.config)==null?void 0:st.supportedGenerationTypes)?me.config.supportedGenerationTypes:[]).some(Be=>(Be||"").toLowerCase().includes("æ¢äºº")||(Be||"").includes("è§†é¢‘æ¢äºº"));return Ie||Ye}),je={};return[...H,...Ne].forEach(me=>{je[me.id]||(je[me.id]=me)}),Object.values(je)}return E.filter(H=>H.type==="VIDEO_GENERATION")},[s.models,$]),[g,m]=t.useState(s.config.prompt||""),_=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==g&&m(s.config.prompt)},[s.config.prompt]);const[z,P]=t.useState(s.config.modelId||((Vs=O[0])==null?void 0:Vs.id)||""),[C,W]=t.useState(s.config.ratio||"16:9"),[r,y]=t.useState(s.config.resolution||""),p=t.useCallback(E=>{const H=(E||"").toLowerCase();return H?H.includes("æ–‡ç”Ÿ")||H.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":H.includes("é¦–å°¾")?"é¦–å°¾å¸§":H.includes("é¦–å¸§")||H.includes("first frame")||H.includes("start frame")||H.includes("initial frame")||H.includes("keyframe")?"é¦–å¸§":H.includes("å°¾å¸§")||H.includes("last frame")||H.includes("end frame")||H.includes("final frame")?"å°¾å¸§":H.includes("ä¸»ä½“å‚è€ƒ")||H.includes("å‚è€ƒ")||H.includes("reference image")||H.includes("image reference")||H.includes("ref image")?"å‚è€ƒå›¾":H.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":H.includes("first-last")||H.includes("two-frame")||H.includes("frame pair")?"é¦–å°¾å¸§":H.includes("first")?"é¦–å¸§":H.includes("last")?"å°¾å¸§":H.includes("subject")||H.includes("reference")?"å‚è€ƒå›¾":E||"":""},[]),[a,v]=t.useState((s.config.lockedGenerationType?p(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[u,w]=t.useState(s.config.duration||5),[f,N]=t.useState(s.config.audio||!1),[j,U]=t.useState(s.config.movementAmplitude||"auto"),[k,c]=t.useState(!1),[i,n]=t.useState([]),[G,M]=t.useState(null),[V,D]=t.useState(!1),[ne]=t.useState(""),[de]=t.useState("confirm"),[q]=t.useState(null),[x,d]=t.useState(!1),[I,b]=t.useState([]),[J,ce]=t.useState(""),[B,ge]=t.useState(0),[Ce,ve]=t.useState(0),[$e,Te]=t.useState({}),[Ue,Re]=t.useState([]),se=O.find(E=>E.id===z);t.useEffect(()=>{var E,H;if(!O.find(Ne=>Ne.id===z)){const Ne=((E=O[0])==null?void 0:E.id)||"";P(Ne),dt({modelId:Ne,modelName:(H=O[0])==null?void 0:H.name})}},[O]),t.useEffect(()=>{var E;if((E=se==null?void 0:se.config.supportedResolutions)!=null&&E.length){const H=se.config.supportedResolutions;if(!r||!H.includes(r)){const Ne=H[0];y(Ne),dt({resolution:Ne})}}},[se==null?void 0:se.id]),t.useEffect(()=>{var Ne;const E=(Ne=se==null?void 0:se.modelId)==null?void 0:Ne.includes("viduq2"),H=p(a)==="é¦–å°¾å¸§";E&&H&&u>8&&(w(8),dt({duration:8}))},[a,se==null?void 0:se.modelId]);const Ve=((K=se==null?void 0:se.provider)==null?void 0:K.toLowerCase())==="sora",Ze=t.useMemo(()=>{var E,H,Ne,je;if((E=se==null?void 0:se.config.supportedDurations)!=null&&E.length){let me=se.config.supportedDurations;const Ie=(H=se.modelId)==null?void 0:H.includes("viduq2"),nt=p(a)==="é¦–å°¾å¸§";return Ie&&nt&&(me=me.filter(Rt=>Rt<=8)),(((Ne=se.provider)==null?void 0:Ne.toLowerCase())==="minimax"||((je=se.modelId)==null?void 0:je.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(me=me.filter(Rt=>Rt===6)),me}return[u||5]},[se,u,a,p,r]),zt=t.useMemo(()=>{var E;return(E=se==null?void 0:se.config.supportedResolutions)!=null&&E.length?se.config.supportedResolutions:[]},[se]),Ot=!se||!((ae=se.config.supportedDurations)!=null&&ae.length),Tt=!se||!((Me=se.config.supportedResolutions)!=null&&Me.length),dt=t.useCallback(E=>{ue(l)&&ie(Ne=>Ne.map(je=>je.id===l?{...je,data:{...je.data,config:{...je.data.config,...E}}}:je))},[ue,l,ie]);t.useEffect(()=>{if(Ze.length>0&&!Ze.includes(u)){const E=Ze[0];w(E),dt({duration:E})}},[Ze,u,dt]);const pt=(E,H)=>{const Ne=(Rt,st)=>st===0?Rt:Ne(st,Rt%st),je=Ne(E,H),me=E/je,Ie=H/je,nt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},Ye=`${me}:${Ie}`;return nt[Ye]||Ye},Nt=()=>{const E=le.filter(nt=>nt.target===l),H=[];E.forEach(nt=>{var Rt;const Ye=ue(nt.source);if(Ye&&Ye.type==="upload"&&(((Rt=Ye.data.config)==null?void 0:Rt.uploadedFiles)||[]).forEach(Be=>{const $t=Be.type||Be.mimeType||"";($t==="IMAGE"||$t.startsWith("image/"))&&H.push({id:Be.id||Be.name,url:Be.url,name:Be.name||Be.originalName,width:Be.width,height:Be.height,aspectRatio:Be.width&&Be.height?pt(Be.width,Be.height):"16:9"})}),Ye&&Ye.type==="assetSelector"){const st=Ye.data.config||{},Be=st.subjects,$t=st.selectedAsset,Xt=p(a);Be&&Be.length>0?Xt==="é¦–å°¾å¸§"||(Be[0].images||[]).forEach((It,Ct)=>{H.push({id:`${Ye.id}-subject-${Ct}`,url:It,name:Be[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):$t&&$t.type==="IMAGE"&&H.push({id:$t.id,url:$t.url,name:$t.name||$t.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(Ye&&Ye.type==="imagePreview"){const st=Ye.data.imageUrl,Be=Ye.data.width,$t=Ye.data.height;st&&H.push({id:Ye.id,url:st,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:Be,height:$t,aspectRatio:Be&&$t?pt(Be,$t):"16:9"})}});const Ne=new Set,je=[];H.forEach(nt=>{const Ye=nt.url;Ne.has(Ye)||(Ne.add(Ye),je.push(nt))});const me=p(a);let Ie=[];if(me==="æ–‡ç”Ÿè§†é¢‘")Ie=[];else if(me==="é¦–å¸§"||me==="å°¾å¸§")Ie=je.slice(0,1);else if(me==="é¦–å°¾å¸§")Ie=je.slice(0,2);else if(me==="å‚è€ƒå›¾"){const Ye=(se==null?void 0:se.modelId)==="veo3.1-components"?3:7;Ie=je.slice(0,Ye)}else Ie=je;return Ie},lt=t.useMemo(()=>Nt(),[le,re,a,l,se==null?void 0:se.modelId]),Ke=t.useRef(0);t.useEffect(()=>{const E=(se==null?void 0:se.modelId)==="veo3.1-components",H=p(a);if(E&&H==="å‚è€ƒå›¾"){const Ne=le.filter(me=>me.target===l);let je=0;Ne.forEach(me=>{var nt,Ye,Rt,st;const Ie=ue(me.source);if((Ie==null?void 0:Ie.type)==="upload"){const Be=((nt=Ie.data.config)==null?void 0:nt.uploadedFiles)||[];je+=Be.filter($t=>{const Xt=$t.type||$t.mimeType||"";return Xt==="IMAGE"||Xt.startsWith("image/")}).length}else if((Ie==null?void 0:Ie.type)==="imagePreview"&&Ie.data.imageUrl)je+=1;else if((Ie==null?void 0:Ie.type)==="assetSelector"){const Be=Ie.data.config||{};((Ye=Be.selectedAsset)==null?void 0:Ye.type)==="IMAGE"&&(je+=1),(st=(Rt=Be.subjects)==null?void 0:Rt[0])!=null&&st.images&&(je+=Be.subjects[0].images.length)}}),je>3&&je>Ke.current&&h.error("Veo 3.1 Components æ¨¡å‹æœ€å¤šæ”¯æŒ 3 å¼ å‚è€ƒå›¾ï¼Œå¤šä½™çš„å›¾ç‰‡å°†è¢«å¿½ç•¥"),Ke.current=je}},[le,se==null?void 0:se.modelId,a,l,ue,p]);const vt=E=>{if(!_.current)return;const H=_.current,Ne=H.selectionStart||g.length,je=g.slice(0,Ne),me=g.slice(Ne),Ie=`@${E} `,nt=je+Ie+me;m(nt),Te(Ye=>({...Ye,[E]:`image-${E}`})),setTimeout(()=>{const Ye=Ne+Ie.length;H.setSelectionRange(Ye,Ye),H.focus()},0)},ze=t.useCallback(async()=>{var E;if(!(Ue.length>0))try{const H=await _e.assetLibraries.getAll({includeShared:"true"}),Ne=H.data||H||[],je=[];for(const me of Ne)if(me.category==="ROLE")try{const Ie=await _e.assetLibraries.roles.list(me.id),nt=Ie.data||Ie||[];for(const Ye of nt)je.push({id:Ye.id,name:((E=Ye.metadata)==null?void 0:E.name)||Ye.name||"",thumbnail:Ye.thumbnail})}catch{}Re(je)}catch{}},[Ue.length]),wt=t.useCallback(E=>{if(!E){b(Ue.slice(0,5));return}const H=Ue.filter(Ne=>Ne.name.toLowerCase().includes(E.toLowerCase())).slice(0,5);b(H),ve(0)},[Ue]),ts=t.useCallback(E=>{const H=E.target.value,Ne=E.target.selectionStart||0;m(H);const me=H.substring(0,Ne).match(/@([^@\s]*)$/);if(me){const Ie=me[1];ce(Ie),ge(Ne-Ie.length-1),d(!0),ze().then(()=>wt(Ie))}else d(!1),b([])},[ze,wt]),ms=t.useCallback(E=>{const H=g.substring(0,B),Ne=g.substring(B+J.length+1),je=`@${E.name} `,me=H+je+Ne;m(me),Te(Ie=>({...Ie,[E.name]:E.id})),d(!1),b([]),ce(""),setTimeout(()=>{if(_.current){_.current.focus();const Ie=H.length+je.length;_.current.setSelectionRange(Ie,Ie)}},0)},[g,B,J]),Rs=t.useCallback(E=>{!x||I.length===0||(E.key==="ArrowDown"?(E.preventDefault(),ve(H=>H<I.length-1?H+1:H)):E.key==="ArrowUp"?(E.preventDefault(),ve(H=>H>0?H-1:H)):E.key==="Enter"&&I[Ce]?(E.preventDefault(),ms(I[Ce])):E.key==="Escape"&&d(!1))},[x,I,Ce,ms]);t.useEffect(()=>{const E=s.config.taskId;(async()=>{if(E){try{const je=(await _e.tasks.getTaskStatus(E)).task;if(je.status==="SUCCESS"){c(!1),T(100);const me=je.resultUrl;if(!me){c(!1),T(0),dt({taskId:""}),Q(""),h.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Ie=s.config.ratio||"16:9";dt({prompt:s.config.prompt||g,ratio:Ie,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:me,taskId:""}),Q("");const nt=be(),Ye=Ee();if(nt.filter(Be=>Be.type==="videoPreview"&&Ye.some($t=>$t.source===l&&$t.target===Be.id)).find(Be=>Be.data.videoUrl===me)){setTimeout(()=>T(0),1e3);return}h.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const Be=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Be).some(kt=>kt.taskId&&kt.taskId===E||kt.sourceNodeId&&kt.sourceNodeId===l)||$s(me,Ie)}catch{$s(me,Ie)}setTimeout(()=>T(0),1e3)}else if(je.status==="PROCESSING"||je.status==="PENDING"){c(!0),T(je.progress||0),bs(E);return}else je.status==="FAILURE"&&(c(!1),T(0),dt({taskId:""}),Q(""),h.error(`ç”Ÿæˆå¤±è´¥: ${je.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{c(!1),T(0),dt({taskId:""}),Q(""),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const E=le.filter(Ne=>Ne.target===l);let H="";E.forEach(Ne=>{var me;const je=ue(Ne.source);if(je){const Ie=je.data;je.type==="agent"&&((me=Ie.config)!=null&&me.generatedText)?H||(H=Ie.config.generatedText):je.type==="textPreview"&&Ie.content&&(H||(H=Ie.content))}}),H&&H!==g&&(m(H),dt({prompt:H}))},[le,l,ue,g,dt]),t.useEffect(()=>{const E=le.filter(je=>je.target===l);if(E.length===0)return;let H="",Ne="";E.forEach(je=>{var Ie;const me=re.find(nt=>nt.id===je.source);if(me&&me.type==="agent"){const nt=me.data;(Ie=nt.config)!=null&&Ie.generatedText&&(H=nt.config.generatedText,Ne=`${me.id}-${nt.config.generatedText.substring(0,50)}`)}}),H&&Ne!==R.current&&(R.current=Ne,m(H),dt({prompt:H}))},[re,le,l,dt]),t.useEffect(()=>{const E=JSON.stringify(lt),H=JSON.stringify(i);E!==H&&n(lt)},[lt]);const Is=t.useMemo(()=>{const E=i.length,H=p(a);return E===0?!0:E===1?H==="å‚è€ƒå›¾":E===2?H==="é¦–å°¾å¸§"?!1:H==="å‚è€ƒå›¾":E>2?H==="å‚è€ƒå›¾":!1},[i.length,a,p]),Ss=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Gs=t.useMemo(()=>{const E=p(a);return $?O:O.filter(H=>{var je;const Ne=(((je=H.config)==null?void 0:je.supportedGenerationTypes)||[]).map(me=>p(me));return E==="é¦–å¸§"||E==="å°¾å¸§"?Ne.includes("é¦–å¸§")||Ne.includes("å°¾å¸§"):Ne.includes(E)})},[O,a,p,$]),ks=t.useMemo(()=>{const E=$?O:Gs;return E.length>0?E:$?(s.models||[]).filter(Ne=>(Ne.type||"")==="VIDEO_EDITING"):E},[$,O,Gs,s.models]);t.useEffect(()=>{var H,Ne;if(!ks.find(je=>je.id===z)){const je=((H=ks[0])==null?void 0:H.id)||"";P(je),dt({modelId:je||void 0,modelName:je?(Ne=ks[0])==null?void 0:Ne.name:void 0})}},[ks]);const js=t.useCallback(E=>{const H=p(E);return $?["IMAGE","VIDEO"]:H==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[p,$]);t.useEffect(()=>{if(!Is&&i.length>0){const E=i[0].aspectRatio;E&&C!==E&&(W(E),setTimeout(()=>{dt({ratio:E})},0))}},[Is,i,C]),t.useEffect(()=>{if(!$&&Ss.length>0&&!Ss.includes(a)){const E="æ–‡ç”Ÿè§†é¢‘";v(E),setTimeout(()=>{dt({generationType:E,acceptedInputs:js(E)})},0)}},[Ss,a,js,$]),t.useEffect(()=>{p(a)==="é¦–å°¾å¸§"&&f&&(N(!1),dt({audio:!1}))},[a,p]),t.useEffect(()=>{const E=p(a);if(E==="æ–‡ç”Ÿè§†é¢‘")return;const H=le.filter(Ie=>Ie.target===l),Ne=[],je=[];H.forEach(Ie=>{var Rt,st,Be,$t,Xt;const nt=ue(Ie.source);if(!nt)return;const Ye=nt.type;if((Ye||"").startsWith("aiVideo")||Ye==="videoPreview"){je.push(Ie.id);return}if(Ye==="upload"){const kt=(Be=(st=(Rt=nt.data)==null?void 0:Rt.config)==null?void 0:st.uploadedFiles)==null?void 0:Be[0],It=((kt==null?void 0:kt.type)||"").toUpperCase(),Ct=((kt==null?void 0:kt.mimeType)||"").toLowerCase();if(It==="VIDEO"||Ct.startsWith("video/")){je.push(Ie.id);return}(It==="IMAGE"||Ct.startsWith("image/"))&&Ne.push(Ie.id);return}if(Ye==="assetSelector"){const kt=(($t=nt.data)==null?void 0:$t.config)||{};if(kt.selectedAsset){const It=(kt.selectedAsset.type||"").toUpperCase(),Ct=(kt.selectedAsset.mimeType||"").toLowerCase();It==="VIDEO"||Ct.startsWith("video/")?je.push(Ie.id):(It==="IMAGE"||Ct.startsWith("image/"))&&Ne.push(Ie.id)}else if(kt.subjects&&kt.subjects.length>0){const It=(((Xt=kt.subjects[0])==null?void 0:Xt.images)||[]).length;E==="å‚è€ƒå›¾"||E==="é¦–å°¾å¸§"?Ne.push(Ie.id):(E==="é¦–å¸§"||E==="å°¾å¸§")&&(It>1?je.push(Ie.id):Ne.push(Ie.id))}return}(Ye==="aiImage"||Ye==="imagePreview")&&Ne.push(Ie.id)});let me=new Set([...je]);E==="é¦–å¸§"||E==="å°¾å¸§"?Ne.slice(1).forEach(Ie=>me.add(Ie)):E==="é¦–å°¾å¸§"&&Ne.slice(2).forEach(Ie=>me.add(Ie)),me.size>0&&we(Ie=>Ie.filter(nt=>!me.has(nt.id)))},[a,le,l,ue,we,p]),t.useEffect(()=>{const E=s.config.generationType;if(!E||p(E)!==p(a)){const H=p(a)||"æ–‡ç”Ÿè§†é¢‘";dt({generationType:H,acceptedInputs:js(H)})}},[]),t.useEffect(()=>{const E=js(a);dt({acceptedInputs:E})},[a,js]);const qs=E=>{M(E)},nr=E=>{E.preventDefault()},Ut=E=>{if(G===null)return;const H=[...i],[Ne]=H.splice(G,1);H.splice(E,0,Ne),n(H),M(null),dt({referenceImages:H})};t.useEffect(()=>{const E=_.current;E&&F&&requestAnimationFrame(()=>{E.style.height="auto";const H=Math.max(60,Math.min(E.scrollHeight,600));E.style.height=`${H}px`})},[g,F]),t.useEffect(()=>{if(g===s.config.prompt)return;const E=setTimeout(()=>{dt({prompt:g})},500);return()=>clearTimeout(E)},[g]);const er=E=>{var Ne,je,me;P(E);const H=Gs.find(Ie=>Ie.id===E);if(H){const Ie=(Ne=H.config.supportedRatios)!=null&&Ne.length?H.config.supportedRatios:["16:9"],nt=H.config.supportedResolutions||[],Ye=(je=H.config.supportedGenerationTypes)!=null&&je.length?H.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],Rt=(me=H.config.supportedDurations)!=null&&me.length?H.config.supportedDurations:[5],st=Ie[0],Be=nt.length>0?nt[0]:r,$t=p(a||Ye[0]),Xt=Rt[0],kt=H.config.supportsAudioOutput?f:!1;W(st),y(Be),v($t),w(Xt),H.config.supportsAudioOutput||N(!1),dt({modelId:E,modelName:H.name,ratio:st,resolution:Be,generationType:$t,duration:Xt,audio:kt,acceptedInputs:js($t)})}};t.useEffect(()=>{var H;const E=(H=s==null?void 0:s.config)==null?void 0:H.generatedVideoUrl;E&&$s(E,s.config.ratio||"16:9")},[(Ge=s==null?void 0:s.config)==null?void 0:Ge.generatedVideoUrl]);const bs=async E=>{let Ne=0;const je=async()=>{try{Ne++;const Ie=(await _e.tasks.getTaskStatus(E)).task;if(T(Ie.progress||0),Ie.status==="SUCCESS"||Ie.status==="COMPLETED"||Ie.status==="DONE"){c(!1),T(100);const nt=Ie.resultUrl;$s(nt,s.config.ratio||"16:9"),dt({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:nt}),Q(""),h.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>T(0),1e3);return}else if(Ie.status==="FAILURE"){c(!1),T(0),dt({taskId:""});const{useAuthStore:nt}=await us(async()=>{const{useAuthStore:Rt}=await import("./index-CKw8I0iR.js").then(st=>st.f);return{useAuthStore:Rt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ye}=nt.getState();await Ye(),h.error(Ie.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(Ie.status==="PROCESSING"||Ie.status==="PENDING")&&(Ne<900?setTimeout(je,1e3):(c(!1),T(0),dt({taskId:""}),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{c(!1),T(0),dt({taskId:""}),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};je()},Ks=async()=>{var Ne,je,me,Ie,nt,Ye,Rt;if(p(a)==="æ–‡ç”Ÿè§†é¢‘"&&!g.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯");return}c(!0);const H=Nt();dt({referenceImages:H}),T(0);try{let st=[],Be;const $t=i.length;if(i.length>0)try{for(const ws of i){let Ft=ws.url;!Ft.startsWith("data:")&&!Ft.startsWith("http")&&(Ft=`${fr}${Ft}`),Ft=Ft.replace(/^https?:\/\/localhost(?::\d+)?/i,fr);const ls=await ur(Ft);st.push(ls)}}catch{h.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=le.filter(ws=>ws.target===l);let kt=[];if(p(a)==="å‚è€ƒå›¾"){const ws=/@(\S+)/g,ls=[...g.matchAll(ws)].map(Kt=>Kt[1]);for(const Kt of ls){const Yt=$e[Kt];Yt&&kt.push(Yt)}const os=new Map;for(const Kt of Xt){const Yt=ue(Kt.source);if((Yt==null?void 0:Yt.type)==="assetSelector"){const Cs=(Ne=Yt.data.config)==null?void 0:Ne.roleIds;if(Cs&&Cs.length>0)for(const ps of Cs)kt.includes(ps)||kt.push(ps);const ys=(je=Yt.data.config)==null?void 0:je.subjects;if(ys&&ys.length>0){for(const ps of ys)if(!os.has(ps.name)){const pr=(ps.images||[]).map(zs=>zs.startsWith("http")||zs.startsWith("data:")?zs:`${fr}${zs}`);os.set(ps.name,pr)}}}}if(os.size>0){const Kt=Array.from(os.entries());let Yt=0;const Cs=[];for(const[ys,ps]of Kt){if(Yt>=7)break;const pr=7-Yt,zs=ps.slice(0,Math.max(0,pr));zs.length>0&&(Cs.push({name:ys,images:zs}),Yt+=zs.length)}Be=Cs,Kt.some(([,ys])=>ys.length>0)&&Yt<Kt.reduce((ys,[,ps])=>ys+ps.length,0)&&h.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(st.length>0){const Kt=lt.filter(Yt=>!Yt.id.includes("subject"));Kt.length>0&&(Be||(Be=[]),Kt.forEach((Yt,Cs)=>{const ys=`å›¾${Cs+1}`,ps=Yt.url.startsWith("http")||Yt.url.startsWith("data:")?Yt.url:`${fr}${Yt.url}`;Be.push({name:ys,images:[ps]})}))}}const It=Be&&Be.length>0?Be.reduce((ws,Ft)=>{var ls;return ws+(((ls=Ft.images)==null?void 0:ls.length)||0)},0):$t,Ct=kt.length>0;let Dt=a;if(Dt==="é¦–å¸§"||Dt==="å°¾å¸§"){if(It!==1&&!Ct){h.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),c(!1),T(0);return}}else if(Dt==="é¦–å°¾å¸§"){if(It===1)Dt="é¦–å¸§";else if(It!==2&&!Ct){h.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),c(!1),T(0);return}Be&&Be.length>0?Be=[{...Be[0],images:Be[0].images.slice(0,2)}]:st=st.slice(0,2)}else if(Dt==="å‚è€ƒå›¾"||Dt==="ä¸»ä½“å‚è€ƒ"){const Ft=(se==null?void 0:se.modelId)==="veo3.1-components"?3:7;if(It<1&&!Ct){h.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),c(!1),T(0);return}if(Be&&Be.length>0){if(Be.reduce((os,Kt)=>{var Yt;return os+(((Yt=Kt.images)==null?void 0:Yt.length)||0)},0)>Ft){let os=Ft;Be=Be.map(Kt=>({...Kt,images:Kt.images.slice(0,Math.max(0,os-=Kt.images.length,Kt.images.length))})),os=Ft,Be=Be.map(Kt=>{const Yt=Kt.images.slice(0,Math.min(Kt.images.length,os));return os-=Yt.length,{...Kt,images:Yt}}).filter(Kt=>Kt.images.length>0),h.info(`å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰${Ft}å¼ `)}}else st.length>Ft&&(st=st.slice(0,Ft),h.info(`å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰${Ft}å¼ `))}q==="dropImages"&&(st=[],Be=void 0),(p(a)==="é¦–å¸§"||p(a)==="å°¾å¸§")&&q==="useFirstImage"&&st.length>=2&&(st=[st[0]]),p(a)==="é¦–å°¾å¸§"&&q==="useFirstTwoImages"&&st.length>=3&&(st=st.slice(0,2));const qt={modelId:z,ratio:C,referenceImages:Be&&Be.length>0?void 0:st.length>0?st:void 0,roleIds:kt.length>0?kt:void 0,generationType:Dt,sourceNodeId:l,metadata:{duration:u,resolution:r,audio:f,movementAmplitude:j,roleIds:kt.length>0?kt:void 0},...Be?{subjects:Be}:{}};Be&&Be.length>0;const Bt=p(Dt);if(Bt==="æ–‡ç”Ÿè§†é¢‘"){if(!g.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯"),c(!1),T(0);return}qt.prompt=g.trim()}else if(Bt==="å‚è€ƒå›¾"){if(!g.trim()){h.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),c(!1),T(0);return}qt.prompt=g.trim()}else g.trim()&&(qt.prompt=g.trim());const rs=await _e.tasks.createVideoTask(qt),gs=rs.taskId,Ws=rs.creditsCharged||0,tr=rs.isFreeUsage,Fs=rs.freeUsageRemaining??0;if(Q(gs),dt({prompt:g,ratio:C,resolution:r,generationType:a,duration:u,modelId:z,taskId:gs}),tr)h.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Fs} æ¬¡`),Se();else if(Ws>0){const{useAuthStore:ws}=await us(async()=>{const{useAuthStore:ls}=await import("./index-CKw8I0iR.js").then(os=>os.f);return{useAuthStore:ls}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ft}=ws.getState();await Ft(),h.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${Ws} ç§¯åˆ†ï¼‰`),Se()}else h.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");bs(gs)}catch(st){if(c(!1),T(0),((me=st.response)==null?void 0:me.status)===403){const Be=((nt=(Ie=st.response)==null?void 0:Ie.data)==null?void 0:nt.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";h.error(Be)}else h.error(`æäº¤å¤±è´¥: ${((Rt=(Ye=st.response)==null?void 0:Ye.data)==null?void 0:Rt.error)||st.message}`)}},Es=async()=>{const E=p(a),H=Nt(),Ne=H.length,je=(()=>{var nt;const Ie=le.filter(Ye=>Ye.target===l);for(const Ye of Ie){const Rt=ue(Ye.source);if((Rt==null?void 0:Rt.type)==="assetSelector"){const st=(nt=Rt.data.config)==null?void 0:nt.subjects;if(st&&st.length>0)return!0}}return!1})(),me=Object.keys($e).length>0;if((je||me)&&(E==="é¦–å¸§"||E==="å°¾å¸§"||E==="é¦–å°¾å¸§")){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((E==="é¦–å¸§"||E==="å°¾å¸§")&&Ne===0&&!me){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(E==="é¦–å°¾å¸§"&&Ne===0&&!me){h.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(E==="å‚è€ƒå›¾"&&Ne===0&&!me){h.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(E==="æ–‡ç”Ÿè§†é¢‘"&&Ne>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((E==="é¦–å¸§"||E==="å°¾å¸§")&&Ne>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(E==="é¦–å°¾å¸§"&&Ne>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(E==="æ–‡ç”Ÿè§†é¢‘"&&!g.trim()){h.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!z){h.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}n(H),dt({referenceImages:H}),c(!0),T(0),await Ks()},$s=(E,H)=>{const Ne=ue(l);if(!Ne||!E)return;const je=H||C||"16:9",me=be(),Ie=Ee(),nt=me.filter(Ft=>Ft.type==="videoPreview"&&Ie.some(ls=>ls.source===l&&ls.target===Ft.id));if(nt.find(Ft=>Ft.data.videoUrl===E))return;const Rt=1,st=400,Be=(Ft,ls=300)=>{if(!Ft||!/^[0-9]+\s*:\s*[0-9]+$/.test(Ft))return ls;const[os,Kt]=Ft.split(":").map(Yt=>parseFloat(Yt));return!os||!Kt?ls:Math.round(st*(Kt/os))},$t=document.querySelector(`.react-flow__node[data-id="${l}"]`),Xt=$t==null?void 0:$t.getBoundingClientRect(),kt=Math.round(((Xt==null?void 0:Xt.width)||400)/Rt),It=100,Ct=200,Dt=Be(je,300),qt=nt.length,Bt=Ne.position.x+kt+Ct,rs=Ne.position.y,gs=Bt,Ws=rs+qt*(Dt+It),tr=Date.now(),Fs={id:`preview-${l}-${tr}`,type:"videoPreview",position:{x:gs,y:Ws},data:{videoUrl:E,width:st,ratio:je,workflowContext:Ne.data.workflowContext,createdBy:Ne.data.createdBy}};ie(Ft=>[...Ft,Fs]);const ws={id:`edge-${l}-${Fs.id}`,source:l,target:Fs.id,targetHandle:`${Fs.id}-target`,type:"aurora"};we(Ft=>Ft.find(os=>os.source===l&&os.target===Fs.id)?Ft:[...Ft,ws])},sr=E=>{const H=E.target;if(H.tagName==="INPUT"||H.tagName==="TEXTAREA"||H.tagName==="SELECT"||H.tagName==="BUTTON"||H.closest("button")||H.closest("input")||H.closest("textarea")||H.closest("select"))return;const Ne=!F;fe(Ne),ie(je=>je.map(me=>me.id===l?{...me,data:{...me.data,isExpanded:Ne}}:me))};return e.jsxs("div",{onDoubleClick:sr,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var st;const E=((st=ue(l))==null?void 0:st.type)||"",H=p(a),Ne=H==="æ–‡ç”Ÿè§†é¢‘"||E==="aiVideo_t2v",je=E==="aiVideo_i2v_first"||E==="aiVideo_i2v_last"||H==="é¦–å¸§"||H==="å°¾å¸§",me=E==="aiVideo_first_last"||H==="é¦–å°¾å¸§",Ie=E==="aiVideo_reference"||H==="å‚è€ƒå›¾",nt=le.filter(Be=>Be.target===l),Ye=nt.some(Be=>{const $t=ue(Be.source);return($t==null?void 0:$t.type)==="agent"}),Rt=nt.reduce((Be,$t)=>{var It,Ct,Dt,qt;const Xt=ue($t.source),kt=(Xt==null?void 0:Xt.type)||"";if(kt==="aiImage"||kt==="imagePreview")return Be+1;if(kt==="upload"){const Bt=(Dt=(Ct=(It=Xt==null?void 0:Xt.data)==null?void 0:It.config)==null?void 0:Ct.uploadedFiles)==null?void 0:Dt[0],rs=((Bt==null?void 0:Bt.type)||"").toUpperCase(),gs=((Bt==null?void 0:Bt.mimeType)||"").toLowerCase();return Be+(rs==="IMAGE"||gs.startsWith("image/")?1:0)}if(kt==="assetSelector"){const Bt=((qt=Xt==null?void 0:Xt.data)==null?void 0:qt.config)||{};if(Bt.selectedAsset)return Be+((Bt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Bt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Bt.subjects&&Bt.subjects.length>0)return Be+((Bt.subjects[0].images||[]).length||0)}return Be},0);if(Ne)return!Ye;if(je)return!(Ye&&Rt>=1);if(me)return!(Ye&&Rt>=2);if(Ie){const $t=(se==null?void 0:se.modelId)==="veo3.1-components"?3:7;return!(Ye&&Rt>=$t)}return!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ne}),de==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{D(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{D(!1),h.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{D(!1),await Ks()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(as,{value:z,onChange:E=>er(E),options:Gs.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Gs.map(E=>({value:E.id,label:E.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ve?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:_,value:g,onChange:E=>{var me;const H=(me=se==null?void 0:se.modelId)==null?void 0:me.includes("viduq2"),Ne=p(a)==="å‚è€ƒå›¾";H&&Ne?ts(E):(m(E.target.value),d(!1))},onKeyDown:E=>{var je;const H=(je=se==null?void 0:se.modelId)==null?void 0:je.includes("viduq2"),Ne=p(a)==="å‚è€ƒå›¾";H&&Ne&&Rs(E)},placeholder:(qe=se==null?void 0:se.modelId)!=null&&qe.includes("viduq2")&&p(a)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),x&&I.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:I.map((E,H)=>e.jsxs("button",{type:"button",onClick:()=>ms(E),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${H===Ce?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[E.thumbnail?e.jsx("img",{src:E.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",E.name]})})]},E.id))})]})]}),Object.keys($e).length>0&&((Oe=se==null?void 0:se.modelId)==null?void 0:Oe.includes("viduq2"))&&p(a)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys($e).map(E=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-neutral-500/10 dark:bg-neutral-500/20 border border-neutral-400/50 dark:border-neutral-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-neutral-700 dark:text-neutral-300",children:E}),e.jsx("button",{type:"button",onClick:()=>{Te(je=>{const me={...je};return delete me[E],me});const H=new RegExp(`@${E}\\s*`,"g"),Ne=g.replace(H,"");m(Ne)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},E))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ve&&i.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(tt=i[0])!=null&&tt.name&&i[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",a==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",p(a)==="å‚è€ƒå›¾"&&i.some(E=>!E.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:i.map((E,H)=>{const Ne=i.slice(0,H+1).filter(Ie=>!Ie.id.includes("subject")).length,je=!E.id.includes("subject"),me=je?`å›¾${Ne}`:E.name;return e.jsxs("div",{draggable:a==="é¦–å°¾å¸§",onDragStart:()=>qs(H),onDragOver:nr,onDrop:()=>Ut(H),onClick:()=>{je&&p(a)==="å‚è€ƒå›¾"&&vt(me)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${a==="é¦–å°¾å¸§"?"cursor-move":je&&p(a)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${G===H?"opacity-50":""} ${E.id.includes("subject")?"border-neutral-400 dark:border-neutral-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-neutral-400 dark:hover:border-neutral-400/50 ${je&&p(a)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:je&&p(a)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${me}`:E.name,children:[e.jsx("img",{src:`${E.url.startsWith("http")||E.url.startsWith("data:")?E.url:fr+E.url}`,alt:E.name,className:"w-full h-full object-cover"}),E.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),E.name]}),je&&a!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),me]}),a==="é¦–å°¾å¸§"&&!E.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:H===0?"é¦–":H===1?"å°¾":H+1})]},E.id)})})]}),se&&!Ve&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",Ot?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ze.map(E=>e.jsxs("button",{type:"button",onClick:()=>{w(E),dt({duration:E})},disabled:Ot,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${u===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:[E,"ç§’"]},E))})]}),Is&&(((bt=se==null?void 0:se.config.supportedRatios)==null?void 0:bt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ve?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{W("16:9"),dt({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${C==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{W("9:16"),dt({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${C==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(as,{value:C,onChange:E=>{W(E),dt({ratio:E})},options:((se==null?void 0:se.config.supportedRatios)||[]).map(E=>{const[H,Ne]=E.split(":");return{value:E,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[E]||`${H}:${Ne}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Tt?"(æœªé…ç½®)":""]}),e.jsx(as,{value:r,onChange:E=>{y(E),dt({resolution:E})},options:zt.map(E=>({value:E,label:E})),className:Tt?"opacity-50 pointer-events-none":""})]}),((yt=se==null?void 0:se.provider)==null?void 0:yt.toLowerCase())==="vidu"&&(se==null?void 0:se.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(E=>e.jsx("button",{type:"button",onClick:()=>{U(E),dt({movementAmplitude:E})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${j===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:E==="auto"?"è‡ªåŠ¨":E==="small"?"å°":E==="medium"?"ä¸­":"å¤§"},E))})]}),(se==null?void 0:se.config.supportsAudioOutput)&&p(a)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const E=!f;N(E),dt({audio:E})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${f?"bg-neutral-800 dark:bg-white text-white dark:text-black":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${f?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:Es,disabled:k||s._canEdit===!1||p(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(g!=null&&g.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${k||p(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(g!=null&&g.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:k?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!xe&&(Z?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(te),"æ¬¡"]}):Ae!==null&&Ae>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Ae,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:g?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:g})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},gr=t.memo(Ya),Qa=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Za=t.memo(Qa),eo=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},to=t.memo(eo),so=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},ro=t.memo(so),ao=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},oo=t.memo(ao),no=s=>{const S=(s==null?void 0:s.data)||{},l=S.config||{};return e.jsx(gr,{...s,data:{...S,config:{...l,generationType:(l==null?void 0:l.lockedGenerationType)||(l==null?void 0:l.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(l==null?void 0:l.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(l==null?void 0:l.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(l==null?void 0:l.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},io=t.memo(no),lr="https://api.waule.ai",lo=({data:s,selected:S,id:l})=>{var P,C,W,r,y,p;const[F]=t.useState(!0),[fe,T]=t.useState(!1),[he]=t.useState(""),[Q,oe]=t.useState("wan-std"),[ee,pe]=t.useState(0),Ae=t.useRef(null),{setNodes:xe,setEdges:Z,getNode:te,getNodes:Se,getEdges:ie}=Zt(),we=Js(),ue=s.config.modelId,{credits:be,loading:Ee}=Ns({aiModelId:ue,duration:ee,mode:Q==="wan-pro"?"pro":"standard"}),le=t.useMemo(()=>{var u;const a=s.models||[],v=(u=s==null?void 0:s.config)==null?void 0:u.selectedEditingCapability;return a.filter(w=>{var f;return(w.type||"")==="VIDEO_EDITING"&&Array.isArray((f=w.config)==null?void 0:f.supportedEditingCapabilities)&&(v?w.config.supportedEditingCapabilities.includes(v):w.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||w.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(P=s==null?void 0:s.config)==null?void 0:P.selectedEditingCapability]),[re,R]=t.useState(s.config.modelId||((C=le[0])==null?void 0:C.id)||""),$=t.useMemo(()=>le.find(a=>a.id===re),[le,re]);t.useEffect(()=>{var a;if(!le.find(v=>v.id===re)){const v=((a=le[0])==null?void 0:a.id)||"";R(v),xe(u=>u.map(w=>{var f;return w.id===l?{...w,data:{...w.data,config:{...w.data.config,modelId:v||void 0,modelName:v?(f=le[0])==null?void 0:f.name:void 0}}}:w}))}},[le]),t.useEffect(()=>{},[$]);const O=t.useMemo(()=>{var j,U,k,c,i,n,G,M,V,D,ne,de,q,x,d,I;const a=we.filter(b=>b.target===l);let v=null,u=0,w=null,f=null,N=null;for(const b of a){const J=te(b.source);if(!J)continue;const ce=String(J.type||"");if(ce==="upload"){const B=(k=(U=(j=J.data)==null?void 0:j.config)==null?void 0:U.uploadedFiles)==null?void 0:k[0];if(!B)continue;const ge=String(B.mimeType||"").toLowerCase(),Ce=String(B.type||"").toUpperCase(),ve=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!w&&(Ce==="VIDEO"||ge.startsWith("video/"))&&(w=ve,N=b.id),!v&&(Ce==="IMAGE"||ge.startsWith("image/"))&&(v=ve,u=B.size||0,f=b.id)}else if(ce==="assetSelector"){const B=(i=(c=J.data)==null?void 0:c.config)==null?void 0:i.selectedAsset;if(B){const Ce=String(B.mimeType||"").toLowerCase(),ve=String(B.type||"").toUpperCase(),$e=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!w&&(ve==="VIDEO"||Ce.startsWith("video/"))&&(w=$e,N=b.id),!v&&(ve==="IMAGE"||Ce.startsWith("image/"))&&(v=$e,u=B.size||0,f=b.id)}const ge=((G=(n=J.data)==null?void 0:n.config)==null?void 0:G.subjects)||[];if(!v&&Array.isArray(ge)&&ge.length>0){const ve=(((M=ge[0])==null?void 0:M.images)||[])[0];ve&&(v=ve.startsWith("http")||ve.startsWith("data:")?ve:`${lr}${ve}`,f=b.id)}}else if(ce==="aiImage"){const B=(D=(V=J.data)==null?void 0:V.config)==null?void 0:D.generatedImageUrl;!v&&B&&(v=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,f=b.id)}else if(ce==="imagePreview"){const B=((ne=J.data)==null?void 0:ne.imageUrl)||((de=J.data)==null?void 0:de.url);!v&&B&&(v=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,f=b.id)}else if(ce==="videoPreview"||ce.startsWith("aiVideo")){const B=((q=J.data)==null?void 0:q.videoUrl)||((x=J.data)==null?void 0:x.url)||((I=(d=J.data)==null?void 0:d.config)==null?void 0:I.generatedVideoUrl);!w&&B&&(w=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,N=b.id)}if(v&&w)break}return{imageUrl:v,videoUrl:w,imageSize:u,imageEdgeId:f,videoEdgeId:N}},[we,l,te]);t.useEffect(()=>{if(O.imageSize>5*1024*1024){const v=(O.imageSize/1024/1024).toFixed(2);h.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${v}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),O.imageEdgeId&&Z(u=>u.filter(w=>w.id!==O.imageEdgeId))}if(!O.videoUrl){pe(0);return}const a=document.createElement("video");a.src=O.videoUrl,a.onloadedmetadata=()=>{const v=a.duration||0,u=a.videoWidth,w=a.videoHeight;pe(v);let f="";v<2||v>30?f=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${v.toFixed(1)}ç§’ï¼‰`:(u>2048||w>2048)&&(f=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${u}x${w}ï¼‰`),f&&(h.error(f+"ï¼Œè¿æ¥å·²æ–­å¼€"),O.videoEdgeId&&Z(N=>N.filter(j=>j.id!==O.videoEdgeId)))},a.onerror=()=>pe(0),a.load()},[O.videoUrl,O.imageSize,O.videoEdgeId,O.imageEdgeId,Z]);const g=t.useMemo(()=>!!re&&!!O.videoUrl&&!!O.imageUrl,[re,O.videoUrl,O.imageUrl]),m=t.useCallback(a=>{var x,d,I;const v=te(l);if(!v||!a)return;const u=Se(),w=ie(),f=u.filter(b=>b.type==="videoPreview"&&w.some(J=>J.source===l&&J.target===b.id));if(f.find(b=>{var J;return((J=b.data)==null?void 0:J.videoUrl)===a}))return;const j=400,U=(b,J=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(b))return J;const[ce,B]=b.split(":").map(ge=>parseFloat(ge));return!ce||!B?J:Math.round(j*(B/ce))},k=200,c=100,i=U("16:9",300),n=document.querySelector(`.react-flow__node[data-id="${l}"]`),G=Math.round((n==null?void 0:n.getBoundingClientRect().width)||400),M=(((x=v.position)==null?void 0:x.x)||0)+G+k,V=((d=v.position)==null?void 0:d.y)||0,D=f.length,ne=M,de=V+D*(i+c),q={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:ne,y:de},data:{videoUrl:a,width:j,ratio:"16:9",workflowContext:v.data.workflowContext,createdBy:(I=v.data)==null?void 0:I.createdBy}};xe(b=>[...b,q]),Z(b=>[...b,{id:`edge-${l}-${q.id}`,source:l,target:q.id,type:"aurora"}])},[l,te,Se,ie,xe,Z]);t.useEffect(()=>{var v;const a=(v=s==null?void 0:s.config)==null?void 0:v.generatedVideoUrl;a&&m(a)},[(W=s==null?void 0:s.config)==null?void 0:W.generatedVideoUrl]),t.useEffect(()=>{const a=s.config.taskId;(async()=>{var w,f;let u=!1;if(a)try{const j=(await _e.tasks.getTaskStatus(a)).task;if(j.status==="SUCCESS"){const U=j.resultUrl||((w=j.previewNodeData)==null?void 0:w.url);if(U){let k=!1;try{const c=localStorage.getItem("suppressedPreviewTasks")||"[]";k=JSON.parse(c).some(n=>n.taskId&&n.taskId===a||n.sourceNodeId&&n.sourceNodeId===l)}catch{}k||m(U),xe(c=>c.map(i=>i.id===l?{...i,data:{...i.data,config:{...i.data.config,generatedVideoUrl:U,taskId:a}}}:i))}T(!1),u=!0}else if(j.status==="PROCESSING"||j.status==="PENDING"){T(!0),await _(a);return}else j.status==="FAILURE"&&(T(!1),xe(U=>U.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k)))}catch{T(!1)}if(!u)try{const N=await _e.tasks.getPendingPreviewNodes(l);if(Array.isArray(N.tasks)&&N.tasks.length>0)for(const j of N.tasks){const U=(f=j.previewNodeData)==null?void 0:f.url;if(U){let k=!1;try{const c=localStorage.getItem("suppressedPreviewTasks")||"[]";k=JSON.parse(c).some(n=>n.taskId&&n.taskId===j.id||n.sourceNodeId&&n.sourceNodeId===l)}catch{}k||m(U),await _e.tasks.markPreviewNodeCreated(j.id)}}}catch{}})()},[]);const _=async a=>{let v=0;const u=600,w=async()=>{var f;try{v++;const j=(await _e.tasks.getTaskStatus(a)).task;if(j.status==="SUCCESS"){const U=j.resultUrl||((f=j.previewNodeData)==null?void 0:f.url);if(U){let k=!1;try{const c=localStorage.getItem("suppressedPreviewTasks")||"[]";k=JSON.parse(c).some(n=>n.taskId&&n.taskId===a||n.sourceNodeId&&n.sourceNodeId===l)}catch{}k||m(U),xe(c=>c.map(i=>i.id!==l?i:{...i,data:{...i.data,config:{...i.data.config,generatedVideoUrl:U,taskId:a}}}))}T(!1),h.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(j.status==="PROCESSING"||j.status==="PENDING")if(v<u)setTimeout(w,5e3);else{T(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),xe(U=>U.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));return}else if(j.status==="FAILURE"){T(!1);try{const{useAuthStore:U}=await us(async()=>{const{useAuthStore:c}=await import("./index-CKw8I0iR.js").then(i=>i.f);return{useAuthStore:c}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:k}=U.getState();await k()}catch{}h.error(j.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),xe(U=>U.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));return}else{T(!1),h.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),xe(U=>U.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));return}}catch{T(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),xe(j=>j.map(U=>U.id===l?{...U,data:{...U.data,config:{...U.data.config,taskId:""}}}:U));return}};w()},z=async()=>{var a,v;if(!g){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}T(!0);try{const u=await _e.post("/tasks/video-edit",{modelId:re,prompt:he||"",referenceImages:O.imageUrl?[O.imageUrl]:[],sourceNodeId:l,duration:ee,metadata:{videoUrl:O.videoUrl,wanMode:Q,duration:ee}}),w=u.taskId,f=u.creditsCharged||0;if(f>0)try{const{useAuthStore:N}=await us(async()=>{const{useAuthStore:U}=await import("./index-CKw8I0iR.js").then(k=>k.f);return{useAuthStore:U}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:j}=N.getState();await j(),h.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${f} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");xe(N=>N.map(j=>j.id===l?{...j,data:{...j.data,config:{...j.data.config,taskId:w}}}:j)),await _(w)}catch(u){T(!1);const w=((v=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:v.error)||u.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${w}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(as,{value:re,onChange:a=>{R(a),xe(v=>v.map(u=>{var w;return u.id===l?{...u,data:{...u.data,config:{...u.data.config,modelId:a,modelName:(w=le.find(f=>f.id===a))==null?void 0:w.name}}}:u}))},options:le.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:le.map(a=>({value:a.id,label:a.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>oe("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Q==="wan-std"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>oe("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Q==="wan-pro"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((y=s==null?void 0:s.config)==null?void 0:y.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),O.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Ae,src:O.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:a=>{const v=a.currentTarget;v.duration&&v.duration!==1/0&&pe(v.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((p=s==null?void 0:s.config)==null?void 0:p.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),O.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:O.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:z,disabled:fe||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${fe?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ee&&(be!==null&&be>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[be,"ç§¯åˆ†"]}):ee===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},co=t.memo(lo),yr="https://api.waule.ai",uo=({data:s,selected:S,id:l})=>{var U,k;const[F]=t.useState(!0),[fe,T]=t.useState(!1),[he,Q]=t.useState(!1),oe=t.useRef(null),ee=t.useRef(null),pe=t.useRef(null),[Ae,xe]=t.useState(!1),[Z,te]=t.useState(0),[Se,ie]=t.useState(0),[we,ue]=t.useState(0),[be,Ee]=t.useState(null),{setNodes:le,setEdges:re,getNode:R,getNodes:$,getEdges:O}=Zt(),g=Js(),m=Os(),_=t.useMemo(()=>`lipSyncTask:${l}`,[l]),z=t.useMemo(()=>(s.models||[]).filter(i=>{var n;return(i.type||"")==="VIDEO_EDITING"&&Array.isArray((n=i.config)==null?void 0:n.supportedEditingCapabilities)&&i.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[P,C]=t.useState(s.config.modelId||((U=z[0])==null?void 0:U.id)||"");t.useEffect(()=>{var c;if(!z.find(i=>i.id===P)){const i=((c=z[0])==null?void 0:c.id)||"";C(i),le(n=>n.map(G=>{var M;return G.id===l?{...G,data:{...G.data,config:{...G.data.config,modelId:i||void 0,modelName:i?(M=z[0])==null?void 0:M.name:void 0}}}:G}))}},[z]);const W=t.useMemo(()=>!Se||!Z?0:Se>=Z||he?Z:Se,[Se,Z,he]),{credits:r,loading:y}=Ns({aiModelId:P,duration:W,mode:"standard",operationType:"video_retalk"}),p=t.useMemo(()=>{var M,V,D,ne,de,q,x,d,I;const c=g.filter(b=>b.target===l);let i=null,n=null,G=null;for(const b of c){const J=m.find(B=>B.id===b.source);if(!J)continue;const ce=String(J.type||"");if(ce==="upload"){const B=(D=(V=(M=J.data)==null?void 0:M.config)==null?void 0:V.uploadedFiles)==null?void 0:D[0];if(!B)continue;const ge=String(B.mimeType||"").toLowerCase(),Ce=String(B.type||"").toUpperCase(),ve=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${yr}${B.url}`;!i&&(Ce==="VIDEO"||ge.startsWith("video/"))&&(i=ve),!n&&(Ce==="AUDIO"||ge.startsWith("audio/"))&&(n=ve),!G&&(Ce==="IMAGE"||ge.startsWith("image/"))&&(G=ve)}else if(ce==="assetSelector"){const B=(de=(ne=J.data)==null?void 0:ne.config)==null?void 0:de.selectedAsset;if(B){const ge=String(B.mimeType||"").toLowerCase(),Ce=String(B.type||"").toUpperCase(),ve=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${yr}${B.url}`;!i&&(Ce==="VIDEO"||ge.startsWith("video/"))&&(i=ve),!n&&(Ce==="AUDIO"||ge.startsWith("audio/"))&&(n=ve),!G&&(Ce==="IMAGE"||ge.startsWith("image/"))&&(G=ve)}}else if(ce==="videoPreview"||ce.startsWith("aiVideo")){const B=((q=J.data)==null?void 0:q.videoUrl)||((x=J.data)==null?void 0:x.url)||((I=(d=J.data)==null?void 0:d.config)==null?void 0:I.generatedVideoUrl);!i&&B&&(i=B.startsWith("http")||B.startsWith("data:")?B:`${yr}${B}`)}if(i&&n&&G)break}return{videoUrl:i,audioUrl:n,imageUrl:G}},[g,l,m]),a=t.useMemo(()=>{var i;const c=z.find(n=>n.id===P);return((i=c==null?void 0:c.modelId)==null?void 0:i.toLowerCase().includes("videoretalk"))||!1},[P,z]),v=t.useMemo(()=>!!P&&!!p.videoUrl&&!!p.audioUrl&&!be,[P,p.videoUrl,p.audioUrl,be]);t.useEffect(()=>{const c=oe.current;if(!c||!p.audioUrl)return;c.src=p.audioUrl,c.load();const i=()=>{te(c.duration||0)},n=()=>ue(c.duration?c.currentTime/c.duration:0),G=()=>xe(!1);return c.addEventListener("loadedmetadata",i),c.addEventListener("timeupdate",n),c.addEventListener("ended",G),()=>{c.removeEventListener("loadedmetadata",i),c.removeEventListener("timeupdate",n),c.removeEventListener("ended",G)}},[p.audioUrl]),t.useEffect(()=>{if(!p.videoUrl){ie(0);return}const c=document.createElement("video");c.src=p.videoUrl,c.onloadedmetadata=()=>{if(ie(c.duration||0),a){const i=c.videoWidth,n=c.videoHeight;i>2048||n>2048?(Ee(`è§†é¢‘åˆ†è¾¨ç‡ ${i}x${n} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),h.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${i}x${n}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),re(G=>G.filter(M=>{var ne,de,q,x,d,I,b,J;if(M.target!==l)return!0;const V=m.find(ce=>ce.id===M.source);return V?!(V.type==="upload"&&((x=(q=(de=(ne=V.data)==null?void 0:ne.config)==null?void 0:de.uploadedFiles)==null?void 0:q[0])==null?void 0:x.type)==="VIDEO"||V.type==="assetSelector"&&((b=(I=(d=V.data)==null?void 0:d.config)==null?void 0:I.selectedAsset)==null?void 0:b.type)==="VIDEO"||V.type==="videoPreview"||((J=V.type)==null?void 0:J.startsWith("aiVideo"))):!0}))):be!=null&&be.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ee(null)}},c.onerror=()=>ie(0),c.load()},[p.videoUrl,a,l,m,re]),t.useEffect(()=>{const c=p.audioUrl,i=pe.current;if(!c||!i)return;const n=M=>{const V=i.getContext("2d");if(!V)return;const D=i.width,ne=i.height;V.clearRect(0,0,D,ne);const de="#1a1033",q="#7a0fe8";V.fillStyle=de,V.fillRect(0,0,D,ne);const x=M.length,d=2,I=Math.max(1,Math.floor((D-(x-1)*d)/x));for(let b=0;b<x;b++){const J=Math.min(1,Math.max(0,M[b])),ce=Math.max(2,Math.floor(J*ne)),B=b*(I+d),ge=Math.floor((ne-ce)/2);V.fillStyle=q,V.fillRect(B,ge,I,ce)}if(we>0){const b=Math.floor(D*we);V.fillStyle="#ffffff88",V.fillRect(b,0,2,ne)}};(async()=>{try{let M=c;c.includes("aliyuncs.com")&&(M=`https://api.waule.ai/proxy/audio?url=${encodeURIComponent(c)}`);const D=await(await fetch(M,{mode:(c.includes("aliyuncs.com"),"cors"),credentials:c.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ne=window.AudioContext||window.webkitAudioContext,x=(await new ne().decodeAudioData(D)).getChannelData(0),d=120,I=Math.max(1,Math.floor(x.length/d)),b=new Float32Array(d);for(let J=0;J<d;J++){let ce=0,B=0;const ge=J*I,Ce=Math.min(x.length,ge+I);for(let ve=ge;ve<Ce;ve++)ce+=Math.abs(x[ve]),B++;b[J]=B?ce/B:0}n(b)}catch{const V=new Float32Array(120);for(let D=0;D<120;D++)V[D]=(Math.sin(D/5)+1)/2;n(V)}})()},[p.audioUrl,we]);const u=()=>{const c=oe.current;c&&(Ae?(c.pause(),xe(!1)):(c.play(),xe(!0)))},w=c=>{if(!c||!isFinite(c))return"0:00";const i=Math.floor(c/60),n=Math.floor(c%60);return`${i}:${n.toString().padStart(2,"0")}`},f=t.useCallback(c=>{var $e,Te,Ue;const i=R(l);if(!i||!c)return;const n=c.startsWith("http")||c.startsWith("data:")?c:`${yr}${c}`,G=$(),M=O(),V=G.filter(Re=>Re.type==="videoPreview"&&M.some(se=>se.source===l&&se.target===Re.id));if(V.find(Re=>{var se;return((se=Re.data)==null?void 0:se.videoUrl)===n}))return;const ne=400,de=(Re,se=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(Re))return se;const[Ve,Ze]=Re.split(":").map(zt=>parseFloat(zt));return!Ve||!Ze?se:Math.round(ne*(Ze/Ve))},q=200,x=100,d=de("16:9",300),I=document.querySelector(`.react-flow__node[data-id="${l}"]`),b=Math.round((I==null?void 0:I.getBoundingClientRect().width)||400),J=((($e=i.position)==null?void 0:$e.x)||0)+b+q,ce=((Te=i.position)==null?void 0:Te.y)||0,B=V.length,ge=J,Ce=ce+B*(d+x),ve={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:ge,y:Ce},data:{videoUrl:n,ratio:"16:9",workflowContext:i.data.workflowContext,createdBy:(Ue=i.data)==null?void 0:Ue.createdBy}};le(Re=>[...Re,ve]),re(Re=>[...Re,{id:`edge-${l}-${ve.id}`,source:l,target:ve.id,type:"aurora"}])},[l,R,$,O,le,re]);t.useEffect(()=>{var i;const c=(i=s==null?void 0:s.config)==null?void 0:i.generatedVideoUrl;c&&f(c)},[(k=s==null?void 0:s.config)==null?void 0:k.generatedVideoUrl]),t.useEffect(()=>{const c=s.config.taskId||(()=>{try{return localStorage.getItem(_)||""}catch{return""}})();(async()=>{var G,M;let n=!1;if(c)try{const D=(await _e.tasks.getTaskStatus(c)).task;if(D.status==="PROCESSING"||D.status==="PENDING"){const ne=new Date(D.createdAt);if((new Date().getTime()-ne.getTime())/(1e3*60*60)>1){T(!1),le(x=>x.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}}if(D.status==="SUCCESS"||D.status==="COMPLETED"||D.status==="DONE"){const ne=D.resultUrl||((G=D.previewNodeData)==null?void 0:G.url);if(ne){let de=!1;try{const q=localStorage.getItem("suppressedPreviewTasks")||"[]";de=JSON.parse(q).some(d=>d.taskId&&d.taskId===c||d.sourceNodeId&&d.sourceNodeId===l)}catch{}de||f(ne),le(q=>q.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,generatedVideoUrl:ne,taskId:c}}}:x))}T(!1);try{localStorage.removeItem(_)}catch{}n=!0}else if(D.status==="PROCESSING"||D.status==="PENDING"){T(!0),await N(c);return}else if(D.status==="FAILURE"||D.status==="FAILED"){T(!1),le(ne=>ne.map(de=>de.id===l?{...de,data:{...de.data,config:{...de.data.config,taskId:""}}}:de));try{localStorage.removeItem(_)}catch{}}}catch{T(!1);try{localStorage.removeItem(_)}catch{}}if(!n)try{const V=await _e.tasks.getPendingPreviewNodes(l);if(Array.isArray(V.tasks)&&V.tasks.length>0)for(const D of V.tasks){const ne=(M=D.previewNodeData)==null?void 0:M.url;if(ne){let de=!1;try{const q=localStorage.getItem("suppressedPreviewTasks")||"[]";de=JSON.parse(q).some(d=>d.taskId&&d.taskId===D.id||d.sourceNodeId&&d.sourceNodeId===l)}catch{}de||f(ne),await _e.tasks.markPreviewNodeCreated(D.id)}}}catch{}})()},[_,l,f]);const N=async c=>{let i=0;const n=600;let G=-1,M=0;const V=60,D=async()=>{var ne;try{i++;const q=(await _e.tasks.getTaskStatus(c)).task;if(q.status==="PROCESSING"||q.status==="PENDING"){const x=q.progress||0;if(x===G){if(M++,M>=V){T(!1),h.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),le(d=>d.map(I=>I.id===l?{...I,data:{...I.data,config:{...I.data.config,taskId:""}}}:I));try{localStorage.removeItem(_)}catch{}return}}else G=x,M=0}if(q.status==="SUCCESS"||q.status==="COMPLETED"||q.status==="DONE"){const x=q.resultUrl||((ne=q.previewNodeData)==null?void 0:ne.url);x&&(f(x),le(d=>d.map(I=>I.id===l?{...I,data:{...I.data,config:{...I.data.config,generatedVideoUrl:x,taskId:c}}}:I))),T(!1),h.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(_)}catch{}return}else if(q.status==="PROCESSING"||q.status==="PENDING")if(i<n)setTimeout(D,5e3);else{T(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),le(x=>x.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}else if(q.status==="FAILURE"||q.status==="FAILED"){T(!1);try{const{useAuthStore:x}=await us(async()=>{const{useAuthStore:I}=await import("./index-CKw8I0iR.js").then(b=>b.f);return{useAuthStore:I}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:d}=x.getState();await d()}catch{}h.error(q.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),le(x=>x.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}else{T(!1),h.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),le(x=>x.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}}catch{T(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),le(q=>q.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x));try{localStorage.removeItem(_)}catch{}return}};D()},j=async()=>{var c,i;if(!v){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}T(!0);try{const n=await _e.post("/tasks/video-edit",{modelId:P,prompt:"",referenceImages:p.imageUrl?[p.imageUrl]:[],sourceNodeId:l,generationType:"å¯¹å£å‹",duration:W,metadata:{videoUrl:p.videoUrl,audioUrl:p.audioUrl,videoExtension:he,duration:W}}),G=n.taskId,M=n.creditsCharged||0;if(M>0)try{const{useAuthStore:V}=await us(async()=>{const{useAuthStore:ne}=await import("./index-CKw8I0iR.js").then(de=>de.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:D}=V.getState();await D(),h.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");le(V=>V.map(D=>D.id===l?{...D,data:{...D.data,config:{...D.data.config,taskId:G}}}:D));try{localStorage.setItem(_,G)}catch{}await N(G)}catch(n){T(!1);const G=((i=(c=n==null?void 0:n.response)==null?void 0:c.data)==null?void 0:i.error)||n.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${G}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(_)}catch{}}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(as,{value:P,onChange:c=>{C(c),le(i=>i.map(n=>{var G;return n.id===l?{...n,data:{...n.data,config:{...n.data.config,modelId:c,modelName:(G=z.find(M=>M.id===c))==null?void 0:G.name}}}:n}))},options:z.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:z.map(c=>({value:c.id,label:c.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:p.videoUrl?e.jsx("video",{src:p.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},p.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:p.imageUrl?e.jsx("img",{src:p.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},p.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),p.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:u,className:"nodrag w-7 h-7 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Ae?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:w(Z)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:pe,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:oe,src:p.audioUrl,className:"hidden"}),e.jsx("video",{ref:ee,className:"hidden",muted:!0,onLoadedMetadata:c=>{const i=c.currentTarget;i.duration&&i.duration!==1/0&&ie(i.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:he,onChange:c=>Q(c.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:j,disabled:fe||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${fe?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!y&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[r,"ç§¯åˆ†"]}):W===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},go=t.memo(uo),Ir="https://api.waule.ai",po=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],ho=({data:s,selected:S,id:l})=>{var z,P;const[F]=t.useState(!0),[fe,T]=t.useState(!1),[he,Q]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[oe,ee]=t.useState(s.config.videoFps||15),[pe,Ae]=t.useState(0),xe=t.useRef(null),{setNodes:Z,setEdges:te,getNode:Se,getNodes:ie,getEdges:we}=Zt(),ue=Js(),be=t.useMemo(()=>(s.models||[]).filter(W=>{var r;return(W.type||"")==="VIDEO_EDITING"&&Array.isArray((r=W.config)==null?void 0:r.supportedEditingCapabilities)&&W.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ee,le]=t.useState(s.config.modelId||((z=be[0])==null?void 0:z.id)||""),{credits:re,loading:R}=Ns({aiModelId:Ee,duration:pe});t.useMemo(()=>be.find(C=>C.id===Ee),[be,Ee]),t.useEffect(()=>{var C;if(!be.find(W=>W.id===Ee)){const W=((C=be[0])==null?void 0:C.id)||"";le(W),Z(r=>r.map(y=>{var p;return y.id===l?{...y,data:{...y.data,config:{...y.data.config,modelId:W||void 0,modelName:W?(p=be[0])==null?void 0:p.name:void 0}}}:y}))}},[be]);const $=t.useMemo(()=>{var r,y,p,a,v,u,w,f,N;const C=ue.filter(j=>j.target===l);let W=null;for(const j of C){const U=Se(j.source);if(!U)continue;const k=String(U.type||"");if(k==="upload"){const c=(p=(y=(r=U.data)==null?void 0:r.config)==null?void 0:y.uploadedFiles)==null?void 0:p[0];if(!c)continue;const i=String(c.mimeType||"").toLowerCase(),n=String(c.type||"").toUpperCase(),G=c.url.startsWith("http")||c.url.startsWith("data:")?c.url:`${Ir}${c.url}`;!W&&(n==="VIDEO"||i.startsWith("video/"))&&(W=G)}else if(k==="assetSelector"){const c=(v=(a=U.data)==null?void 0:a.config)==null?void 0:v.selectedAsset;if(c){const i=String(c.mimeType||"").toLowerCase(),n=String(c.type||"").toUpperCase(),G=c.url.startsWith("http")||c.url.startsWith("data:")?c.url:`${Ir}${c.url}`;!W&&(n==="VIDEO"||i.startsWith("video/"))&&(W=G)}}else if(k==="videoPreview"||k.startsWith("aiVideo")){const c=((u=U.data)==null?void 0:u.videoUrl)||((w=U.data)==null?void 0:w.url)||((N=(f=U.data)==null?void 0:f.config)==null?void 0:N.generatedVideoUrl);!W&&c&&(W=c.startsWith("http")||c.startsWith("data:")?c:`${Ir}${c}`)}if(W)break}return{videoUrl:W}},[ue,l,Se]);t.useEffect(()=>{if(!$.videoUrl){Ae(0);return}const C=document.createElement("video");C.preload="metadata",C.onloadedmetadata=()=>{C.duration&&C.duration!==1/0&&Ae(C.duration)},C.onerror=()=>Ae(0),C.src=$.videoUrl},[$.videoUrl]);const O=t.useMemo(()=>!!Ee&&!!$.videoUrl,[Ee,$.videoUrl]),g=t.useCallback(C=>{var V,D,ne;const W=Se(l);if(!W||!C)return;const r=ie(),y=we(),p=r.filter(de=>de.type==="videoPreview"&&y.some(q=>q.source===l&&q.target===de.id));if(p.find(de=>{var q;return((q=de.data)==null?void 0:q.videoUrl)===C}))return;const v=400,u=(de,q=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(de))return q;const[x,d]=de.split(":").map(I=>parseFloat(I));return!x||!d?q:Math.round(v*(d/x))},w=200,f=100,N=u("16:9",300),j=document.querySelector(`.react-flow__node[data-id="${l}"]`),U=Math.round((j==null?void 0:j.getBoundingClientRect().width)||400),k=(((V=W.position)==null?void 0:V.x)||0)+U+w,c=((D=W.position)==null?void 0:D.y)||0,i=p.length,n=k,G=c+i*(N+f),M={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:n,y:G},data:{videoUrl:C,width:v,ratio:"16:9",workflowContext:W.data.workflowContext,createdBy:(ne=W.data)==null?void 0:ne.createdBy}};Z(de=>[...de,M]),te(de=>[...de,{id:`edge-${l}-${M.id}`,source:l,target:M.id,type:"aurora"}])},[l,Se,ie,we,Z,te]);t.useEffect(()=>{var W;const C=(W=s==null?void 0:s.config)==null?void 0:W.generatedVideoUrl;C&&g(C)},[(P=s==null?void 0:s.config)==null?void 0:P.generatedVideoUrl]),t.useEffect(()=>{const C=s.config.taskId;(async()=>{var y,p;let r=!1;if(C)try{const v=(await _e.tasks.getTaskStatus(C)).task;if(v.status==="SUCCESS"){const u=v.resultUrl||((y=v.previewNodeData)==null?void 0:y.url);if(u){let w=!1;try{const f=localStorage.getItem("suppressedPreviewTasks")||"[]";w=JSON.parse(f).some(j=>j.taskId&&j.taskId===C||j.sourceNodeId&&j.sourceNodeId===l)}catch{}w||g(u),Z(f=>f.map(N=>N.id===l?{...N,data:{...N.data,config:{...N.data.config,generatedVideoUrl:u,taskId:C}}}:N))}T(!1),r=!0}else if(v.status==="PROCESSING"||v.status==="PENDING"){T(!0),await m(C);return}else v.status==="FAILURE"&&(T(!1),Z(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,taskId:""}}}:w)))}catch{T(!1)}if(!r)try{const a=await _e.tasks.getPendingPreviewNodes(l);if(Array.isArray(a.tasks)&&a.tasks.length>0)for(const v of a.tasks){const u=(p=v.previewNodeData)==null?void 0:p.url;if(u){let w=!1;try{const f=localStorage.getItem("suppressedPreviewTasks")||"[]";w=JSON.parse(f).some(j=>j.taskId&&j.taskId===v.id||j.sourceNodeId&&j.sourceNodeId===l)}catch{}w||g(u),await _e.tasks.markPreviewNodeCreated(v.id)}}}catch{}})()},[]);const m=async C=>{let W=0;const r=600,y=async()=>{var p;try{W++;const v=(await _e.tasks.getTaskStatus(C)).task;if(v.status==="SUCCESS"){const u=v.resultUrl||((p=v.previewNodeData)==null?void 0:p.url);u&&(g(u),Z(w=>w.map(f=>f.id!==l?f:{...f,data:{...f.data,config:{...f.data.config,generatedVideoUrl:u,taskId:C}}}))),T(!1),h.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else v.status==="PROCESSING"||v.status==="PENDING"?W<r?setTimeout(y,5e3):(T(!1),h.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,taskId:""}}}:w))):v.status==="FAILURE"&&(T(!1),h.error(v.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),Z(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,taskId:""}}}:w)))}catch{T(!1),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(v=>v.map(u=>u.id===l?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u))}};y()},_=async()=>{var C,W;if(!O){h.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}T(!0);try{const r=await _e.post("/tasks/video-edit",{modelId:Ee,prompt:"",referenceImages:[],sourceNodeId:l,generationType:"é£æ ¼è½¬æ¢",duration:pe,metadata:{videoUrl:$.videoUrl,styleId:he,videoFps:oe,duration:pe}}),y=r.taskId,p=r.creditsCharged||0;if(p>0)try{const{useAuthStore:a}=await us(async()=>{const{useAuthStore:u}=await import("./index-CKw8I0iR.js").then(w=>w.f);return{useAuthStore:u}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:v}=a.getState();await v(),h.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${p} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{h.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else h.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");Z(a=>a.map(v=>v.id===l?{...v,data:{...v.data,config:{...v.data.config,taskId:y,styleId:he,videoFps:oe}}}:v)),await m(y)}catch(r){T(!1);const y=((W=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:W.error)||r.message||"æœªçŸ¥åŸå› ";h.error(`å¯åŠ¨å¤±è´¥ï¼š${y}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(as,{value:Ee,onChange:C=>{le(C),Z(W=>W.map(r=>{var y;return r.id===l?{...r,data:{...r.data,config:{...r.data.config,modelId:C,modelName:(y=be.find(p=>p.id===C))==null?void 0:y.name}}}:r}))},options:be.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:be.map(C=>({value:C.id,label:C.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(as,{value:String(he),onChange:C=>{const W=parseInt(C,10);Q(W),Z(r=>r.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,styleId:W}}}:y))},options:po.map(C=>({value:String(C.id),label:C.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:oe,min:15,max:25,onChange:C=>{let W=parseInt(C.target.value,10)||15;W<15&&(W=15),W>25&&(W=25),ee(W),Z(r=>r.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,videoFps:W}}}:y))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),$.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:xe,src:$.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:C=>{const W=C.currentTarget;W.duration&&W.duration!==1/0&&Ae(W.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:_,disabled:fe||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${fe?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!R&&(re!==null&&re>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[re,"ç§¯åˆ†"]}):pe===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},fo=t.memo(ho),mo=({data:s,selected:S,id:l})=>{const[F,fe]=t.useState(null),[T,he]=t.useState(!1),[Q,oe]=t.useState(s.config.prompt||""),[ee,pe]=t.useState(""),Ae=t.useRef(null),xe=t.useRef(!1),[Z,te]=t.useState(!1),{setNodes:Se,setEdges:ie,getNode:we,getNodes:ue,getEdges:be}=Zt(),Ee=Xs(a=>a.edges.filter(v=>v.target===l)),le=Os(),[re,R]=t.useState([]),[$,O]=t.useState([]),g=t.useRef(""),m=t.useMemo(()=>((F==null?void 0:F.roles)||[]).find(a=>a.id===ee),[F,ee]),{credits:_,loading:z,isFreeUsage:P,freeUsageRemaining:C}=Ns({aiModelId:m==null?void 0:m.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&W(s.config.agentId)},[s.config.agentId]);const W=async a=>{var v,u,w,f,N;try{he(!0);const j=await _e.agents.getById(a);let U=[];try{U=await _e.agents.roles.listByAgent(a)||[],fe({...j,roles:U});const c=((v=s==null?void 0:s.config)==null?void 0:v.roleId)||"";pe(c||((u=U[0])==null?void 0:u.id)||"")}catch{fe(j)}try{const k=await _e.agents.getAvailableModels(),c=(U||[]).find(i=>{var n;return i.id===((n=s==null?void 0:s.config)==null?void 0:n.roleId)});if(c){const i=(k||[]).find(G=>G.id===c.aiModelId),n=((w=i==null?void 0:i.config)==null?void 0:w.acceptedInputs)||((i==null?void 0:i.type)==="TEXT_GENERATION"&&((N=(f=i==null?void 0:i.provider)==null?void 0:f.toLowerCase())!=null&&N.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:n})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{h.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{he(!1)}};t.useEffect(()=>{r({roleId:ee}),(async()=>{var a,v,u;if(F)try{const w=await _e.agents.getAvailableModels(),f=(F.roles||[]).find(N=>N.id===ee);if(f){const N=(w||[]).find(U=>U.id===f.aiModelId),j=((a=N==null?void 0:N.config)==null?void 0:a.acceptedInputs)||((N==null?void 0:N.type)==="TEXT_GENERATION"&&((u=(v=N==null?void 0:N.provider)==null?void 0:v.toLowerCase())!=null&&u.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:j})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[ee,F]);const r=a=>{we(l)&&Se(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,...a}}}:w))};t.useEffect(()=>{const a=Ae.current;a&&requestAnimationFrame(()=>{a.style.height="auto";const v=Math.max(60,Math.min(a.scrollHeight,600));a.style.height=`${v}px`})},[Q]),t.useEffect(()=>{const a=setTimeout(()=>{Q!==s.config.prompt&&r({prompt:Q})},500);return()=>clearTimeout(a)},[Q,s.config.prompt]),t.useEffect(()=>{const a=Ee;if(!a||a.length===0)return;let v="";a.some(u=>{const w=le.find(N=>N.id===u.source);if(!w)return!1;const f=w.data||{};return w.type==="textPreview"&&typeof f.content=="string"&&f.content.trim()?(v=f.content.trim(),!0):!1}),v&&!xe.current&&(oe(v),r({prompt:v}))},[Ee,le]),t.useEffect(()=>{const a=Ee.map(w=>`${w.id}-${w.source}`).sort().join(",");if(a===g.current)return;g.current=a;const v=[],u=[];Ee.forEach(w=>{var j,U,k;const f=we(w.source);if(!f)return;const N=f.data||{};if(f.type==="upload")(((j=N.config)==null?void 0:j.uploadedFiles)||[]).forEach(i=>{i.type==="IMAGE"&&v.push(i.url),i.type==="DOCUMENT"&&u.push({name:i.originalName,url:i.url})});else if(f.type==="assetSelector"){const c=(U=N.config)==null?void 0:U.subjects;if(c&&c.length>0)(c[0].images||[]).map(n=>{const G="https://api.waule.ai";return n.startsWith("data:")?n:n.startsWith("http")?n.replace(/^https?:\/\/localhost(?::\d+)?/i,G):`${G}${n}`}).forEach(n=>v.push(n));else{const i=(k=N.config)==null?void 0:k.selectedAsset;if(i){const n="https://api.waule.ai",G=M=>M.startsWith("http")?M.replace(/^https?:\/\/localhost(?::\d+)?/i,n):`${n}${M}`;i.type==="IMAGE"&&v.push(G(i.url)),i.type==="DOCUMENT"&&u.push({name:i.originalName,url:G(i.url)})}}}else f.type==="imagePreview"&&N.imageUrl&&v.push(N.imageUrl)}),R(v),O(u)},[Ee,we,le]);const y=()=>{if(!F)return null;const a=(F.roles||[]).find(v=>v.id===ee);return a?{systemPrompt:a.systemPrompt,aiModelId:a.aiModelId,temperature:a.temperature,maxTokens:a.maxTokens}:null},p=async()=>{var v,u,w,f,N,j,U,k,c,i,n,G,M,V;if(!F){h.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!Q.trim()){h.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let a=(F.roles||[]).find(D=>D.id===ee)||(F.roles||[])[0];if(!a){h.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!ee||ee!==a.id)&&(pe(a.id),r({roleId:a.id}));try{te(!0);const ne=be().filter(Te=>Te.target===l);let de="";const q="https://api.waule.ai",x=[],d=[],I=[];for(const Te of ne){const Ue=we(Te.source);if(Ue)if(Ue.type==="upload"){const Re=((u=(v=Ue.data)==null?void 0:v.config)==null?void 0:u.uploadedFiles)||[];for(const se of Re)if(se.type==="DOCUMENT")x.push({filePath:se.url,mimeType:se.mimeType}),de+=`[æ–‡æ¡£æ–‡ä»¶: ${se.originalName}]
`;else if(se.type==="IMAGE"){const Ve=se.url.startsWith("http")?se.url:`${q}${se.url}`;d.push(Ve),de+=`[å›¾ç‰‡æ–‡ä»¶: ${se.originalName}]
`}else if(se.type==="VIDEO"){const Ve=se.url.startsWith("http")?se.url:`${q}${se.url}`;I.push(Ve),de+=`[è§†é¢‘æ–‡ä»¶: ${se.originalName}]
`}else se.type==="AUDIO"&&(de+=`[éŸ³é¢‘æ–‡ä»¶: ${se.originalName}]
`)}else if(Ue.type==="assetSelector"){const Re=(f=(w=Ue.data)==null?void 0:w.config)==null?void 0:f.subjects;if(Re&&Re.length>0){const se=(Re[0].images||[]).map(Ve=>Ve.startsWith("http")?Ve:`${q}${Ve}`).map(Ve=>Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,q));se.forEach(Ve=>d.push(Ve)),de+=`[å‚è€ƒå›¾ç‰‡ç»„: ${se.length} å¼ ]
`}else{const se=(j=(N=Ue.data)==null?void 0:N.config)==null?void 0:j.selectedAsset;if(se){if(se.type==="DOCUMENT")x.push({filePath:se.url,mimeType:se.mimeType}),de+=`[æ–‡æ¡£æ–‡ä»¶: ${se.originalName}]
`;else if(se.type==="IMAGE"){let Ve=se.url.startsWith("http")?se.url:`${q}${se.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,q),d.push(Ve),de+=`[å›¾ç‰‡æ–‡ä»¶: ${se.originalName}]
`}else if(se.type==="VIDEO"){let Ve=se.url.startsWith("http")?se.url:`${q}${se.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,q),I.push(Ve),de+=`[è§†é¢‘æ–‡ä»¶: ${se.originalName}]
`}}}}else if(Ue.type==="aiImage"){const Re=(k=(U=Ue.data)==null?void 0:U.config)==null?void 0:k.generatedImageUrl;if(Re){const se=Re.startsWith("http")?Re:`${q}${Re}`;d.push(se),de+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(Ue.type==="imagePreview"){const Re=Ue.data.imageUrl;Re&&(d.push(Re),de+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(Ue.type==="videoPreview"){const Re=Ue.data.videoUrl;if(Re){const se=Re.startsWith("http")?Re:`${q}${Re}`;I.push(se),de+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else Ue.type==="textPreview"&&Ue.data.content&&(de+=Ue.data.content+`

`)}const b=y();if(!b)return;let J=b.systemPrompt;de&&(J+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${de}`),J+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${Q}`;const ce=await _e.ai.text.generate({modelId:a.aiModel.id||b.aiModelId,prompt:J,systemPrompt:a.systemPrompt||b.systemPrompt,temperature:a.temperature??b.temperature,maxTokens:a.maxTokens??b.maxTokens,documentFiles:x.length>0?x:void 0,imageUrls:d.length>0?d:void 0,videoUrls:I.length>0?I:void 0}),B=ce&&(((c=ce.data)==null?void 0:c.text)||(ce==null?void 0:ce.text))||"";if(!B||B.trim()===""){h.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:B});const ge=be().filter(Te=>Te.source===l),Ce=ue(),ve=ge.filter(Te=>{const Ue=Ce.find(Re=>Re.id===Te.target);return Ue&&Ue.type!=="textPreview"});if(ve.length>0)Se(Te=>{const Ue=new Set(ve.map(Re=>Re.target));return Te.map(Re=>{var Ve;if(!Ue.has(Re.id))return Re;const se=((Ve=Re.data)==null?void 0:Ve.config)||{};return Re.type==="midjourney"?{...Re,data:{...Re.data,prompt:B}}:{...Re,data:{...Re.data,config:{...se,prompt:B}}}})});else{const Te=we(l);if(Te){const Ue=Date.now(),Re=`text-preview-${l}-${Ue}`,se=ge.filter(pt=>{const Nt=Ce.find(lt=>lt.id===pt.target);return Nt&&Nt.type==="textPreview"}),Ve=document.querySelector(`.react-flow__node[data-id="${l}"]`),Ze=(Ve==null?void 0:Ve.getBoundingClientRect().width)||300,zt=Te.position.x+Ze+100,Ot=Te.position.y+se.length*700,Tt={id:Re,type:"textPreview",position:{x:zt,y:Ot},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:B,createdBy:(i=Te.data)==null?void 0:i.createdBy}},dt={id:`edge-${l}-${Re}`,source:l,target:Re,type:"aurora"};Se(pt=>[...pt,Tt]),setTimeout(()=>{ie(pt=>[...pt,dt])},50)}}const $e=(ce==null?void 0:ce.creditsCharged)||0;if($e>0){const{useAuthStore:Te}=await us(async()=>{const{useAuthStore:Re}=await import("./index-CKw8I0iR.js").then(se=>se.f);return{useAuthStore:Re}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ue}=Te.getState();await Ue(),h.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${$e} ç§¯åˆ†ï¼‰`)}else h.success("æ‰§è¡ŒæˆåŠŸ")}catch(D){const ne=((G=(n=D==null?void 0:D.response)==null?void 0:n.data)==null?void 0:G.message)||((V=(M=D==null?void 0:D.response)==null?void 0:M.data)==null?void 0:V.error)||(D==null?void 0:D.message)||"æœªçŸ¥é”™è¯¯";h.error("æ‰§è¡Œå¤±è´¥ï¼š"+ne)}finally{te(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:T?"LOADING...":((F==null?void 0:F.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[F&&(F.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(as,{value:ee,onChange:a=>pe(a),options:[...F.roles||[]].sort((a,v)=>(a.order??0)-(v.order??0)).map(a=>({value:a.id,label:a.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Ae,value:Q,onChange:a=>{xe.current=!0,oe(a.target.value)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:p,disabled:Z||T||!F||!Q.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:cursor-not-allowed bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg  border-transparent dark:border-white/10",children:Z?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!z&&(P?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(C),"æ¬¡"]}):_!==null&&_>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[_,"ç§¯åˆ†"]}):null)]})}),re.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",re.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:re.map((a,v)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:a,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"})},v))})]}),$.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",$.length,")"]}),e.jsx("div",{className:"space-y-1",children:$.map((a,v)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:a.name,children:a.name})]},v))})]})]}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},xo=t.memo(mo),Sr="https://api.waule.ai",_s=400,bo=({data:s,id:S,selected:l})=>{const[F,fe]=t.useState(!1),[T,he]=t.useState(0),[Q,oe]=t.useState(s.config.uploadedFiles||[]),[ee,pe]=t.useState(null),[Ae,xe]=t.useState(null);t.useEffect(()=>()=>{},[S]),t.useEffect(()=>{},[ee]),t.useEffect(()=>{},[Ae]);const[Z,te]=t.useState(null),Se=t.useRef(null),ie=t.useRef(null),we=t.useRef(null),[ue,be]=t.useState(!1),[Ee,le]=t.useState(0),[re,R]=t.useState(0),[$,O]=t.useState(!1),g=t.useRef(null),{setNodes:m,getNode:_,setEdges:z,getEdges:P}=Zt(),C=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const n=s.createdBy;if(typeof n=="object"&&(n==null||n.id),C.current)return;const G=s.config.uploadedFiles||[];!F&&JSON.stringify(G)!==JSON.stringify(Q)&&(oe(G),pe(null),xe(null))},[s.config.uploadedFiles,F,s._currentUserId,s.createdBy]);const W=()=>{g.current&&(g.current.paused?(g.current.play(),O(!0)):(g.current.pause(),O(!1)))},r=n=>{_(S)&&(C.current=!0,m(M=>M.map(V=>V.id===S?{...V,data:{...V.data,config:{...V.data.config,uploadedFiles:n}}}:V)))},y=async n=>{var M,V;if(!n||n.length===0)return;fe(!0);const G=[];try{for(let D=0;D<n.length;D++){const ne=n[D];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ne.type)){h.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ne.name}`);continue}const q=await _e.assets.upload(ne,void 0,{onUploadProgress:x=>{const d=(x==null?void 0:x.total)||0,I=(x==null?void 0:x.loaded)||0;if(d>0){const b=Math.round(I/d*100);he(b)}}});if(q.data){const x=(q.data.type||"").toUpperCase(),d=(q.data.mimeType||"").toLowerCase(),I=x==="IMAGE"||x==="VIDEO"||x==="AUDIO"?x:d.startsWith("image/")?"IMAGE":d.startsWith("video/")?"VIDEO":d.startsWith("audio/")?"AUDIO":x||"",b=q.data.url;G.push({id:q.data.id,name:q.data.name,originalName:q.data.originalName,type:I,mimeType:q.data.mimeType,size:q.data.size,url:b})}}if(G.length>0){let D=[];const ne=G[0].type;if(Z!==null)D=[...Q],D[Z]=G[0];else{const q={};for(const x of Q)q[x.id]=x;for(const x of G)q[x.id]=x;D=Object.values(q)}if(_(S)){const q=P().filter(d=>d.source===S),x=[];if(q.forEach(d=>{var J;const I=_(d.target);if(!I||I.type.startsWith("aiVideo"))return;const b=(J=I.data.config)==null?void 0:J.acceptedInputs;if(b&&b.length>0){const ce=ne.toUpperCase();b.map(ge=>typeof ge=="string"?ge.toUpperCase():ge).includes(ce)||x.push(d.id)}}),x.length>0){z(I=>I.filter(b=>!x.includes(b.id)));const d={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.warning(`å·²æ–­å¼€ ${x.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${d[ne]||ne}ç±»å‹ï¼‰`)}}pe(null),xe(null),oe(D),r(D);try{const q=P().filter(d=>d.source===S);if(q.some(d=>{const I=_(d.target);return(I==null?void 0:I.type)==="aiVideo"})){const d=localStorage.getItem("workflow:nodes"),I=d?JSON.parse(d):[],b=q.filter(ce=>{var B;return((B=_(ce.target))==null?void 0:B.type)==="aiVideo"}).map(ce=>ce.target),J=I.filter(ce=>b.includes(ce.id));J.length>0&&m(ce=>ce.map(B=>J.find(ge=>ge.id===B.id)?{...B,data:{...B.data,config:{...B.data.config,_updatedAt:Date.now()}}}:B))}}catch{}h.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(D){h.error(`ä¸Šä¼ å¤±è´¥: ${((V=(M=D.response)==null?void 0:M.data)==null?void 0:V.message)||D.message}`)}finally{fe(!1),he(0),Se.current&&(Se.current.value=""),te(null)}},p=()=>{m(n=>n.filter(G=>G.id!==S)),z(n=>n.filter(G=>G.source!==S&&G.target!==S)),h.success("èŠ‚ç‚¹å·²åˆ é™¤")},a=()=>{var n;te(0),(n=Se.current)==null||n.click()},v=n=>n<1024?n+" B":n<1024*1024?(n/1024).toFixed(2)+" KB":(n/(1024*1024)).toFixed(2)+" MB",u=n=>n.startsWith("image/")?{icon:"image",color:"text-neutral-500 dark:text-neutral-400"}:n.startsWith("video/")?{icon:"movie",color:"text-neutral-500 dark:text-neutral-400"}:n.startsWith("audio/")?{icon:"audio_file",color:"text-neutral-500 dark:text-neutral-400"}:{icon:"description",color:"text-neutral-500 dark:text-neutral-400"};t.useEffect(()=>{if(Q.length>0){const n=Q[0],G=(n.url.startsWith("http")||n.url.startsWith("data:")?n.url:`${Sr}${n.url}`).replace(".oss-oss-",".oss-");if(n.type==="IMAGE"){const M=new Image;M.onload=()=>{const V=M.width/M.height,D=_s/V;pe({width:_s,height:D})},M.onerror=V=>{pe({width:_s,height:_s*.75})},M.src=G}else if(n.type==="VIDEO"){const M=document.createElement("video");M.onloadedmetadata=()=>{const V=M.videoWidth/M.videoHeight,D=_s/V;xe({width:_s,height:D})},M.onerror=V=>{xe({width:_s,height:_s*.5625})},M.src=G}}},[Q]);const w=()=>{const n=ie.current;n&&(ue?(n.pause(),be(!1)):(n.play(),be(!0)))};t.useEffect(()=>{const n=ie.current;if(!n)return;const G=()=>le(n.duration||0),M=()=>R(n.duration?n.currentTime/n.duration:0),V=()=>be(!1);return n.addEventListener("loadedmetadata",G),n.addEventListener("timeupdate",M),n.addEventListener("ended",V),()=>{n.removeEventListener("loadedmetadata",G),n.removeEventListener("timeupdate",M),n.removeEventListener("ended",V)}},[Q]);const f=t.useRef(null),[N,j]=t.useState(0);t.useEffect(()=>{const n=Q[0];if(!n||n.type!=="AUDIO"){f.current=null;return}const M=(n.url.startsWith("http")||n.url.startsWith("data:")?n.url:`${Sr}${n.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let D;/https:\/\/.*aliyuncs\.com\//.test(M)?D=await _e.assets.proxyDownload(M):D=await(await fetch(M,{mode:"cors"})).arrayBuffer();const ne=window.AudioContext||window.webkitAudioContext,x=(await new ne().decodeAudioData(D)).getChannelData(0),d=120,I=Math.max(1,Math.floor(x.length/d)),b=new Float32Array(d);for(let J=0;J<d;J++){let ce=0,B=0;const ge=J*I,Ce=Math.min(x.length,ge+I);for(let ve=ge;ve<Ce;ve++)ce+=Math.abs(x[ve]),B++;b[J]=B?ce/B:0}f.current=b,j(J=>J+1)}catch{const ne=new Float32Array(120);for(let de=0;de<120;de++)ne[de]=(Math.sin(de/5)+1)/2;f.current=ne,j(de=>de+1)}})()},[Q]),t.useEffect(()=>{const n=we.current;if(!n)return;const G=f.current;if(!G)return;const M=n.getContext("2d");if(!M)return;const V=n.width,D=n.height;M.clearRect(0,0,V,D);const ne=G.length,de=2,q=Math.max(1,Math.floor((V-(ne-1)*de)/ne)),x=M.createLinearGradient(0,0,V,0);x.addColorStop(0,"#525252"),x.addColorStop(.5,"#d946ef"),x.addColorStop(1,"#404040");for(let d=0;d<ne;d++){const I=Math.min(1,Math.max(0,G[d])),b=Math.max(2,Math.floor(I*D)),J=d*(q+de),ce=Math.floor((D-b)/2);M.fillStyle=x,M.fillRect(J,ce,q,b)}if(re>0){const d=Math.floor(V*re);M.fillStyle="#ffffff88",M.fillRect(d,0,2,D)}},[re,N]);const U=n=>{if(!n||!isFinite(n))return"0:00";const G=Math.floor(n/60),M=Math.floor(n%60);return`${G}:${M.toString().padStart(2,"0")}`},k=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"neutral"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"neutral"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"neutral"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"neutral"}],c=Q[0],i=c?(c.url.startsWith("http")||c.url.startsWith("data:")?c.url:`${Sr}${c.url}`).replace(".oss-oss-",".oss-"):"";return c&&c.type==="IMAGE"&&ee?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:i,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:ee.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>y(n.target.files),className:"hidden"})]}):c&&c.type==="VIDEO"&&Ae?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${$?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:n=>{n.stopPropagation(),W()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:$?"pause":"play_arrow"})})}),e.jsx("video",{ref:g,src:i,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Ae.height},onEnded:()=>O(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>y(n.target.files),className:"hidden"})]}):c&&c.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:w,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:ue?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:U(Ee)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:we,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ie,src:i,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>y(n.target.files),className:"hidden"})]}):c&&c.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:c.originalName,children:c.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:v(c.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>y(n.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:Se,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>y(n.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var n;s._canEdit!==!1&&((n=Se.current)==null||n.click())},onDragOver:n=>{n.preventDefault(),n.stopPropagation()},onDrop:n=>{n.preventDefault(),n.stopPropagation(),s._canEdit!==!1&&y(n.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-neutral-400 dark:hover:border-neutral-400/50 transition-colors ${F||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:F?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:F?`ä¸Šä¼ ä¸­... ${T}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),F&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all",style:{width:`${T}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:k.map(n=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${n.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:n.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:n.formats.join(", ")})]},n.type))})]}),Q.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",Q.length,")"]}),Q.map(n=>{const{icon:G,color:M}=u(n.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${M} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:G}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:n.originalName,children:n.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:v(n.size)})]}),e.jsx("button",{onClick:p,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},n.id)})]})]})}),e.jsx(At,{type:"source",position:gt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},wo=t.memo(bo),Wr="https://api.waule.ai",Ps=320,yo=({data:s,id:S,selected:l})=>{const[F,fe]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[T,he]=t.useState([]),{setNodes:Q,getNode:oe}=Zt(),[ee,pe]=t.useState(null),[Ae,xe]=t.useState(null),Z=t.useRef(null),te=t.useRef(null),[Se,ie]=t.useState(!1),[we,ue]=t.useState(0),[be,Ee]=t.useState(0),le=t.useRef(null),[re,R]=t.useState(!1),[$,O]=t.useState(!1),g=t.useRef(null),m=()=>{g.current&&(g.current.paused?(g.current.play(),O(!0)):(g.current.pause(),O(!1)))},_=t.useRef(!1);t.useEffect(()=>{const p=s._currentUserId,a=s.createdBy,v=typeof a=="object"?a==null?void 0:a.id:a;if(p&&v&&p===v&&_.current)return;const u=s.config.selectedInput||s.config.selectedAsset||null;if(!u)return;const w=F;(()=>{if(!w)return!1;const N=w.images&&!w.type,j=u.images&&!u.type;if(N&&j){const U=w.images||[],k=u.images||[];if(U.length!==k.length)return!1;for(let c=0;c<U.length;c++)if(U[c].id!==k[c].id||U[c].url!==k[c].url)return!1;return!0}if(w.id&&u.id)return w.id===u.id&&w.url===u.url&&w.type===u.type;try{return JSON.stringify(w)===JSON.stringify(u)}catch{return!1}})()||fe(u)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var a,v,u;if(F&&F.images&&!F.type){const w=F,f=(u=(v=(a=oe(S))==null?void 0:a.data)==null?void 0:v.config)==null?void 0:u.referenceImages;Array.isArray(f)&&f.length>0?he(f.map(N=>({id:N.id,url:N.url,name:N.name}))):he(w.images||[])}else he([])},[F,oe,S]);const z=p=>{const a=oe(S);a&&(_.current=!0,Q(v=>v.map(u=>u.id===S?{...u,data:{...u.data,config:{...u.data.config,...p}}}:u)),fe((p==null?void 0:p.selectedInput)??(p==null?void 0:p.selectedAsset)??a.data.config.selectedInput??a.data.config.selectedAsset))},P=p=>/^https?:\/\//.test(p)||p.startsWith("data:"),C=p=>!p||p.startsWith("data:")?p:/^https?:\/\/localhost(?::\d+)?\//i.test(p)?p.replace(/^https?:\/\/localhost(?::\d+)?/i,Wr):P(p)?p:`${Wr}${p}`;t.useEffect(()=>{var k,c,i,n,G,M,V,D,ne;if(!(F&&F.images&&!F.type))return;const a=F,v=T.length?T:a.images||[];if(v.length===1){const de=v[0],q={id:de.id,name:de.name,originalName:de.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:de.url};z({selectedInput:q,selectedAsset:q,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const u=[{name:a.name,images:v.map(de=>C(de.url))}],w=v.map(de=>({id:de.id,url:de.url,name:de.name})),f=[a.id],N=(i=(c=(k=oe(S))==null?void 0:k.data)==null?void 0:c.config)==null?void 0:i.subjects,j=(M=(G=(n=oe(S))==null?void 0:n.data)==null?void 0:G.config)==null?void 0:M.referenceImages,U=(ne=(D=(V=oe(S))==null?void 0:V.data)==null?void 0:D.config)==null?void 0:ne.roleIds;(JSON.stringify(N)!==JSON.stringify(u)||JSON.stringify(j)!==JSON.stringify(w)||JSON.stringify(U)!==JSON.stringify(f))&&z({subjects:u,referenceImages:w,roleIds:f})},[T]);const W=p=>{if(!(F&&F.images&&!F.type))return;const v=F,u=[...T];if(p<0||p>=u.length)return;if(u.splice(p,1),he(u),h.success("å·²åˆ é™¤å‚è€ƒå›¾"),u.length===0){fe(null),z({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),h.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(u.length===1){const U=u[0],k={id:U.id,name:U.name,originalName:U.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:U.url};fe(k),z({selectedInput:k,selectedAsset:k,subjects:void 0,referenceImages:void 0,roleIds:void 0}),h.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const w={id:v.id,name:v.name,coverUrl:C(u[0].url),images:u};fe(w);const f=[{name:w.name,images:u.map(U=>C(U.url))}],N=u.map(U=>({id:U.id,url:U.url,name:U.name})),j=[w.id];z({selectedInput:w,subjects:f,referenceImages:N,roleIds:j}),h.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(S)};t.useEffect(()=>{if(F&&F.type){const p=F;if(p.type==="IMAGE"){const a=new Image;a.onload=()=>{const v=a.width/a.height,u=Ps/v;pe({width:Ps,height:u})},a.src=C(p.url)}else if(p.type==="VIDEO"){const a=document.createElement("video");a.onloadedmetadata=()=>{const v=a.videoWidth/a.videoHeight,u=Ps/v;xe({width:Ps,height:u})},a.src=C(p.url)}}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")){R(!1);return}const v=C(F.url),u=Z.current,w=te.current;if(!u||!w)return;u.src=v,Ee(0),R(!1);const f=()=>ue(u.duration||0),N=()=>Ee(u.duration?u.currentTime/u.duration:0),j=()=>ie(!1);return u.addEventListener("loadedmetadata",f),u.addEventListener("timeupdate",N),u.addEventListener("ended",j),(async()=>{try{const c=await(await fetch(v,{mode:"cors"})).arrayBuffer(),i=window.AudioContext||window.webkitAudioContext,M=(await new i().decodeAudioData(c)).getChannelData(0),V=120,D=Math.max(1,Math.floor(M.length/V)),ne=new Float32Array(V);for(let de=0;de<V;de++){let q=0,x=0;const d=de*D,I=Math.min(M.length,d+D);for(let b=d;b<I;b++)q+=Math.abs(M[b]),x++;ne[de]=x?q/x:0}le.current=ne,R(!0)}catch{const c=new Float32Array(120);for(let i=0;i<120;i++)c[i]=(Math.sin(i/5)+1)/2;le.current=c,R(!0)}})(),()=>{u.removeEventListener("loadedmetadata",f),u.removeEventListener("timeupdate",N),u.removeEventListener("ended",j)}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")||!re)return;const a=te.current,v=le.current;if(!a||!v)return;const u=a.getContext("2d");if(!u)return;const w=a.width,f=a.height;u.clearRect(0,0,w,f);const N=v.length,j=2,U=Math.max(1,Math.floor((w-(N-1)*j)/N)),k=u.createLinearGradient(0,0,w,0);k.addColorStop(0,"#525252"),k.addColorStop(.5,"#d946ef"),k.addColorStop(1,"#404040");for(let c=0;c<N;c++){const i=Math.min(1,Math.max(0,v[c])),n=Math.max(2,Math.floor(i*f)),G=c*(U+j),M=Math.floor((f-n)/2);u.fillStyle=k,u.fillRect(G,M,U,n)}if(be>0){const c=Math.floor(w*be);u.fillStyle="#ffffff88",u.fillRect(c,0,2,f)}},[F,be,re]);const y=p=>p<1024?p+" B":p<1024*1024?(p/1024).toFixed(2)+" KB":(p/(1024*1024)).toFixed(2)+" MB";if(F){if(F.images&&!F.type){const u=F;return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ps},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ps*.5625},children:T[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:w=>w.preventDefault(),src:C(T[0].url),alt:u.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:w=>{w.preventDefault(),w.stopPropagation(),w.nativeEvent&&typeof w.nativeEvent.stopImmediatePropagation=="function"&&w.nativeEvent.stopImmediatePropagation(),W(0)},onClick:w=>{w.preventDefault(),w.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:u.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:T.slice(1).map((w,f)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:N=>N.preventDefault(),src:C(w.url),alt:w.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:N=>{N.preventDefault(),N.stopPropagation(),N.nativeEvent&&typeof N.nativeEvent.stopImmediatePropagation=="function"&&N.nativeEvent.stopImmediatePropagation(),W(f+1)},onClick:N=>{N.preventDefault(),N.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},w.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const a=F,v=C(a.url);if(a.type==="IMAGE"&&ee)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ps},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:v,alt:a.name,className:"w-full object-cover",style:{width:Ps,height:ee.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="VIDEO"&&Ae)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ps},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${$?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:u=>{u.stopPropagation(),m()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:$?"pause":"play_arrow"})})}),e.jsx("video",{ref:g,src:v,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ps,height:Ae.height},onEnded:()=>O(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const u=Z.current;u&&(Se?(u.pause(),ie(!1)):(u.play(),ie(!0)))},className:"nodrag w-8 h-8 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:Se?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const u=we;if(!u||!isFinite(u))return"0:00";const w=Math.floor(u/60),f=Math.floor(u%60);return`${w}:${f.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:te,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:Z,src:v,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(a.type==="DOCUMENT"){const u=N=>N.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:N.includes("word")?{icon:"description",color:"text-blue-400"}:N.includes("excel")||N.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:w,color:f}=u(a.mimeType);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${f} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:w}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:a.originalName,children:a.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:y(a.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ps},children:[e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},ko=t.memo(yo),mr={};function Ts(s){const{project:S,episode:l,nodeGroup:F,assetType:fe,preview:T=!0}=s;if(!F||!F.scene||!F.shot)return null;const he=`${F.id}-${fe}`;mr[he]||(mr[he]=0);let Q;T?Q=mr[he]+1:(mr[he]++,Q=mr[he]);let oe=S.name;if(S.type==="DRAMA"&&l){const ee=`S${String(l.episodeNumber).padStart(3,"0")}`;oe+=`_${ee}`}return oe+=`_Sc${F.scene}_Sh${F.shot}`,oe+=`_${Q}`,oe}function Hs(s,S){return S.find(l=>l.nodeIds.includes(s))||null}const vo=({data:s,id:S})=>{var u,w;const{setNodes:l,setEdges:F,getNodes:fe}=Zt(),T=_r(f=>f.refreshUser),he=Ar(),Q=!!((u=s==null?void 0:s.workflowContext)!=null&&u.episode)||he.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var N,j,U;if(Q)try{const k=(s==null?void 0:s.workflowContext)||{},c=k.episode,i=new URLSearchParams(window.location.search),n=Number(i.get("shot"))||1,G=he.pathname.split("/").filter(Boolean),M=G.indexOf("projects"),V=G.indexOf("episodes"),D=((N=k.project)==null?void 0:N.id)||(c==null?void 0:c.projectId)||(M>=0?G[M+1]:void 0),ne=(c==null?void 0:c.id)||(V>=0?G[V+1]:void 0);if(!D||!ne)return;const de=await _e.episodes.getById(D,ne),q=(de==null?void 0:de.data)??de,x=(q==null?void 0:q.data)??q,I=(Array.isArray((j=x==null?void 0:x.scriptJson)==null?void 0:j.acts)?x.scriptJson.acts:[]).find(B=>B.actIndex===1),b=(U=I==null?void 0:I.shots)==null?void 0:U.find(B=>Number(B.shotIndex)===n),ce=(Array.isArray(b==null?void 0:b.mediaList)?b.mediaList:[]).some(B=>(B==null?void 0:B.nodeId)===S);l(B=>B.map(ge=>ge.id===S?{...ge,data:{...ge.data,addedToStoryboard:ce}}:ge))}catch{}})()},[S,Q,he.pathname]);const[oe,ee]=t.useState(!1),[pe,Ae]=t.useState([]),[xe,Z]=t.useState(""),[te,Se]=t.useState("ALL"),[ie,we]=t.useState(""),[ue,be]=t.useState(!1),Ee=s.width||400,[le,re]=t.useState(null);t.useEffect(()=>{oe&&(y(),setTimeout(()=>{p()},100))},[oe]);const R=t.useRef(null),$=t.useRef(!1);t.useEffect(()=>{const f=s.pendingButtonAction;if(f){try{const U=localStorage.getItem("suppressedPreviewTasks")||"[]",k=JSON.parse(U),c=localStorage.getItem("createdPreviewTasks")||"[]",i=JSON.parse(c),n=k.some(D=>D.taskId&&D.taskId===f.newTaskId||D.sourceNodeId&&D.sourceNodeId===f.sourceNodeId),M=fe().some(D=>{var ne,de,q,x;return D.type==="imagePreview"&&((de=(ne=D.data)==null?void 0:ne.midjourneyData)==null?void 0:de.sourceNodeId)===f.sourceNodeId&&((x=(q=D.data)==null?void 0:q.midjourneyData)==null?void 0:x.taskId)===f.newTaskId}),V=i.some(D=>D.taskId&&D.taskId===f.newTaskId);if(n||V&&M){re(null),l(D=>D.map(ne=>ne.id===f.sourceNodeId?{...ne,data:{...ne.data,pendingButtonAction:void 0}}:ne));return}}catch{}if($.current)return;if($.current=!0,fe().some(U=>{var k,c,i,n;return U.type==="imagePreview"&&((c=(k=U.data)==null?void 0:k.midjourneyData)==null?void 0:c.sourceNodeId)===f.sourceNodeId&&((n=(i=U.data)==null?void 0:i.midjourneyData)==null?void 0:n.taskId)===f.newTaskId})){re(null),l(U=>U.map(k=>k.id===f.sourceNodeId?{...k,data:{...k.data,pendingButtonAction:void 0}}:k)),$.current=!1;return}re(f.buttonCustomId),O(f.newTaskId,f.buttonLabel,f.sourceNodeId)}return()=>{$.current=!1,R.current&&(clearTimeout(R.current),R.current=null)}},[]);const O=async(f,N,j)=>{const U=j||S;let k=0;const c=150,i=2e3;$.current=!0;const n=/^[UV]\d$/.test(N)||N.includes("Vary")||N.includes("Upscale")&&N!=="Upscale"||N.includes("Zoom")||N.includes("Pan")||N.includes("Make")||N.includes("Remaster"),G=async()=>{var M,V,D,ne,de,q,x,d;if($.current)try{const I=await _e.midjourney.fetchTask(f);if(!$.current)return;const b=I.task;if(b.status==="SUCCESS"){if(n&&s.imageUrl&&((M=s.midjourneyData)!=null&&M.messageId)){const pt=b.imageUrl===s.imageUrl,Nt=((V=b.properties)==null?void 0:V.messageId)===((D=s.midjourneyData)==null?void 0:D.messageId);if(pt&&Nt){k++;try{const lt=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(lt).some(ze=>{var wt;return ze.taskId&&ze.taskId===f||ze.messageId&&ze.messageId===((wt=b.properties)==null?void 0:wt.messageId)})){re(null),l(ze=>ze.map(wt=>wt.id===U?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}k<c?R.current=setTimeout(G,i):(h.error(`${N} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),re(null),l(lt=>lt.map(Ke=>Ke.id===U?{...Ke,data:{...Ke.data,pendingButtonAction:void 0}}:Ke)));return}}if(h.success(`${N} å®Œæˆï¼`),re(null),l(pt=>pt.map(Nt=>Nt.id===U?{...Nt,data:{...Nt.data,pendingButtonAction:void 0}}:Nt)),fe().find(pt=>{var Nt,lt,Ke,vt,ze;return pt.type==="imagePreview"&&((Nt=pt.data.midjourneyData)==null?void 0:Nt.sourceNodeId)===U&&(((lt=pt.data.midjourneyData)==null?void 0:lt.taskId)===f||((Ke=b.properties)==null?void 0:Ke.messageId)&&((vt=pt.data.midjourneyData)==null?void 0:vt.messageId)===((ze=b.properties)==null?void 0:ze.messageId))})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const B=fe().find(pt=>pt.id===U);if(!B)return;if(!b.imageUrl){h.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const ge=200,Ce=100,ve=s.width||400,Te=((pt,Nt=300)=>{if(!pt||!/^[0-9]+\s*:\s*[0-9]+$/.test(pt))return Nt;const[lt,Ke]=pt.split(":").map(vt=>parseFloat(vt));return!lt||!Ke?Nt:Math.round(ve*(Ke/lt))})(s.ratio,300),Ue=document.querySelector(`.react-flow__node[data-id="${B.id}"]`),Re=Math.round((Ue==null?void 0:Ue.getBoundingClientRect().width)||((ne=B.data)==null?void 0:ne.width)||400),se=fe().filter(pt=>{var Nt,lt;return pt.type==="imagePreview"&&((lt=(Nt=pt.data)==null?void 0:Nt.midjourneyData)==null?void 0:lt.sourceNodeId)===U}),Ve=B.position.x+Re+ge,Ze=B.position.y,zt=Ve,Ot=Ze+se.length*(Te+Ce),Tt=`preview-${Date.now()}`,dt={id:Tt,type:"imagePreview",position:{x:zt,y:Ot},data:{imageUrl:b.imageUrl,width:ve,height:Te,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(de=B.data)==null?void 0:de.createdBy,midjourneyData:{taskId:f,messageId:(q=b.properties)==null?void 0:q.messageId,messageHash:(x=b.properties)==null?void 0:x.messageHash,sourceNodeId:U,buttons:b.buttons,action:b.action}}};l(pt=>[...pt,dt]),F(pt=>{const Nt={id:`${U}-${Tt}`,source:U,target:Tt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...pt,Nt]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const Nt=fe().find(lt=>lt.id===Tt)})});try{const pt=localStorage.getItem("createdPreviewTasks")||"[]",lt=[...JSON.parse(pt),{taskId:f,messageId:(d=b.properties)==null?void 0:d.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(lt))}catch{}h.success(`å·²åˆ›å»º${N}é¢„è§ˆèŠ‚ç‚¹`);return}if(b.status==="FAILURE"){h.error(`${N} å¤±è´¥: ${b.failReason||"æœªçŸ¥é”™è¯¯"}`),re(null),l(J=>J.map(ce=>ce.id===U?{...ce,data:{...ce.data,pendingButtonAction:void 0}}:ce));return}if(b.status==="NOT_FOUND"){if(fe().some(B=>{var ge,Ce,ve,$e;return B.type==="imagePreview"&&((Ce=(ge=B.data)==null?void 0:ge.midjourneyData)==null?void 0:Ce.sourceNodeId)===U&&(($e=(ve=B.data)==null?void 0:ve.midjourneyData)==null?void 0:$e.taskId)===f})){re(null),l(B=>B.map(ge=>ge.id===U?{...ge,data:{...ge.data,pendingButtonAction:void 0}}:ge));return}h.error(`${N} ä»»åŠ¡ä¸å­˜åœ¨`),re(null),l(B=>B.map(ge=>ge.id===U?{...ge,data:{...ge.data,pendingButtonAction:void 0}}:ge));return}k++,k<c?R.current=setTimeout(G,i):(h.error(`${N} è¶…æ—¶`),re(null),l(J=>J.map(ce=>ce.id===S?{...ce,data:{...ce.data,pendingButtonAction:void 0}}:ce)))}catch(I){h.error(`${N} å¤±è´¥: ${I.message}`),re(null),l(b=>b.map(J=>J.id===S?{...J,data:{...J.data,pendingButtonAction:void 0}}:J))}};G()},g=()=>{try{const f=localStorage.getItem("midjourneyButtonConfig");if(f)return JSON.parse(f)}catch{}return{}},m=f=>{const N=g();if(Object.keys(N).length===0)return!0;const j=f.label.replace(/\s+/g,"_");return N.hasOwnProperty(j)?N[j]===!0:!0},_=f=>{if(!f)return"";let N=f.trim();return/^upscale_\d+\s/i.test(N)&&(N=N.replace(/^upscale_\d+\s+/i,"")),N},z=(((w=s.midjourneyData)==null?void 0:w.buttons)||[]).map(f=>String(f.label||"").toLowerCase()),P=z.some(f=>/^[uv][1-4]$/i.test(f)),C=z.some(f=>f.includes("redo")),W=!P&&!C&&z.some(f=>f.includes("upscale")),r=f=>{const N=String(f.label||""),j=N.toLowerCase(),U=String(f.customId||"").toLowerCase(),k=/ğŸ‘|â¤ï¸|â¤/.test(N);return j.includes("animate")||j.includes("web")||U.includes("web")||j.includes("browser")||j.includes("open in web")||j.includes("open web")||j.includes("like")||U.includes("like")||k?!1:P?/^U[1-4]$/i.test(N):W?j.includes("upscale"):!1};t.useEffect(()=>{oe&&(y(),p())},[oe]);const y=async()=>{try{const f=te==="ALL"?void 0:{category:te},j=(await _e.assetLibraries.getAll(f)).data||[];if(Ae(j),j.length>0){const U=j.find(k=>k.id===xe);Z(U?U.id:j[0].id)}else Z("")}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},p=()=>{const f=window.__workflowContext;if(!f||!f.project||!f.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const N=Hs(S,f.nodeGroups);if(!N&&f.nodeGroups.length>0){const U=f.nodeGroups[0],k=Ts({project:f.project,episode:f.episode,nodeGroup:U,assetType:"image"});k?(we(k),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${k}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const j=Ts({project:f.project,episode:f.episode,nodeGroup:N,assetType:"image"});j?(we(j),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${j}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},a=async()=>{var f,N;if(!xe){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ie.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{be(!0),await _e.assetLibraries.addFromUrl(xe,s.imageUrl,ie.trim());const j=window.__workflowContext;if(j&&j.project&&j.nodeGroups){const U=Hs(S,j.nodeGroups)||j.nodeGroups[0];U&&Ts({project:j.project,episode:j.episode,nodeGroup:U,nodeId:S,assetType:"image",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ee(!1),we("");try{l(U=>U.map(k=>k.id===S?{...k,data:{...k.data,addedToLibrary:!0}}:k))}catch{}try{const U=new CustomEvent("asset-library-updated",{detail:{libraryId:xe}});window.dispatchEvent(U)}catch{}}catch(j){h.error(((N=(f=j.response)==null?void 0:f.data)==null?void 0:N.message)||"æ·»åŠ å¤±è´¥")}finally{be(!1)}},v=async()=>{var f;try{const N=s.imageUrl;let j=`image-${Date.now()}.jpg`;const U=window.__workflowContext;if(U&&U.project&&U.nodeGroups){const k=Hs(S,U.nodeGroups)||U.nodeGroups[0];if(k){const c=Ts({project:U.project,episode:U.episode,nodeGroup:k,nodeId:S,assetType:"image",preview:!0});if(c&&(j=c,!j.includes("."))){const i=((f=N.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:f[0])||".jpg";j+=i}}}h.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");try{const k=await fetch(N);if(!k.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${k.status}`);const c=await k.blob(),i=window.URL.createObjectURL(c),n=document.createElement("a");n.href=i,n.download=j,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>{window.URL.revokeObjectURL(i)},100),h.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${j}`)}catch{const c=`/api/assets/proxy-download-with-name?url=${encodeURIComponent(N)}&filename=${encodeURIComponent(j)}`,i=document.createElement("a");i.href=c,i.download=j,document.body.appendChild(i),i.click(),document.body.removeChild(i),h.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${j}`)}}catch(N){h.error(`æ“ä½œå¤±è´¥: ${N instanceof Error?N.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const N=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(j=>m(j)&&r(j)):[]).length>0;return e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ee,borderRadius:N?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[Q&&e.jsxs("button",{onClick:async()=>{var j,U;try{const k=s.imageUrl,c=s.workflowContext||{},i=c.episode,n=new URLSearchParams(window.location.search),G=Number(n.get("shot"))||1,M=he.pathname.split("/").filter(Boolean),V=M.indexOf("projects"),D=M.indexOf("episodes"),ne=((j=c.project)==null?void 0:j.id)||(i==null?void 0:i.projectId)||(V>=0?M[V+1]:void 0),de=(i==null?void 0:i.id)||(D>=0?M[D+1]:void 0);if(!ne||!de){h.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const q=await _e.episodes.getById(ne,de),x=(q==null?void 0:q.data)??q,d=(x==null?void 0:x.data)??x;let I=Array.isArray((U=d==null?void 0:d.scriptJson)==null?void 0:U.acts)?[...d.scriptJson.acts]:[],b=I.find(ge=>ge.actIndex===1);b||(b={actIndex:1,shots:[]},I.push(b)),b.shots=Array.isArray(b.shots)?[...b.shots]:[];let J=b.shots.find(ge=>Number(ge.shotIndex)===G);J||(J={shotIndex:G,mediaList:[]},b.shots.push(J));const ce=Array.isArray(J.mediaList)?J.mediaList.slice():[];ce.push({type:"image",url:k,nodeId:S,duration:5}),J.mediaList=ce;const B={...d.scriptJson||{},acts:I};await _e.episodes.update(ne,de,{scriptJson:B});try{l(ge=>ge.map(Ce=>Ce.id===S?{...Ce,data:{...Ce.data,addedToStoryboard:!0}}:Ce))}catch{}h.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(k){h.error((k==null?void 0:k.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{ee(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:v,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const f=(s.midjourneyData.buttons||[]).filter(N=>m(N)&&r(N));return f.length===0?null:e.jsxs("div",{className:"nodrag bg-white dark:bg-[#18181b] backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ee},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:f.map((N,j)=>{var G;const U=_(N.label),k=((G=s.clickedButtons)==null?void 0:G.includes(N.label))||!1,c=le===N.customId,i=s._canEdit===!1,n=le!==null&&le!==N.customId||k||i;return e.jsx("button",{onClick:async()=>{var M,V,D,ne,de,q;if(!((M=s.midjourneyData)!=null&&M.taskId)){h.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(k){h.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}re(N.customId);try{h.info(`æ­£åœ¨æ‰§è¡Œ ${N.label}...`);const x=await _e.midjourney.action({taskId:s.midjourneyData.taskId,customId:N.customId,messageId:s.midjourneyData.messageId,nodeId:S,mode:s.midjourneyData.mode||"relax"});if(!x.success){h.error(x.description||"æ“ä½œå¤±è´¥"),re(null);return}const d=x.taskId;if(x.creditsCharged&&x.creditsCharged>0&&T(),!d){h.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),re(null);return}l(I=>I.map(b=>b.id===S?{...b,data:{...b.data,pendingButtonAction:{buttonLabel:N.label,buttonCustomId:N.customId,newTaskId:d,sourceNodeId:S},clickedButtons:[...b.data.clickedButtons||[],N.label]}}:b)),h.info(`${U} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),O(d,U)}catch(x){if(((V=x.response)==null?void 0:V.status)===429)h.warning(((ne=(D=x.response)==null?void 0:D.data)==null?void 0:ne.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const d=((q=(de=x.response)==null?void 0:de.data)==null?void 0:q.error)||x.message;h.error(d)}re(null)}},disabled:n,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${k?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":c?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-wait text-white border-transparent shadow-md":le!==null?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:k?`${U} (å·²ç‚¹å‡»)`:U,children:e.jsxs("span",{className:"flex items-center gap-1",children:[c&&e.jsx(Ls,{className:"w-3 h-3 animate-spin"}),N.emoji&&!/^upscale_\d+$/i.test(N.emoji)&&e.jsx("span",{children:N.emoji}),U,k&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},j)})})]})})(),oe&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:f=>f.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ee(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ie,onChange:f=>we(f.target.value),onMouseDown:f=>f.stopPropagation(),onTouchStart:f=>f.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const f=te==="ALL"?pe:pe.filter(N=>(N.category||"OTHER")===te);return f.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:te==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:xe,onChange:N=>Z(N.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:f.map(N=>e.jsxs("option",{value:N.id,children:[N.name," (",N._count.assets," ä¸ªèµ„äº§)"]},N.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(f=>e.jsx("button",{type:"button",onClick:()=>{Se(f);const N=pe.filter(j=>(j.category||"OTHER")===f);Z(N.length>0?N[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${te===f?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:f==="ROLE"?"person":f==="SCENE"?"landscape":f==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:f==="ROLE"?"è§’è‰²åº“":f==="SCENE"?"åœºæ™¯åº“":f==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},f))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ee(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:a,disabled:ue||pe.length===0||!ie.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:ue?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},No=t.memo(vo),jo=({data:s,id:S})=>{var z;const l="https://api.waule.ai",[F,fe]=t.useState(!1),[T,he]=t.useState([]),[Q,oe]=t.useState(""),[ee,pe]=t.useState("ALL"),[Ae,xe]=t.useState(""),[Z,te]=t.useState(!1),{setNodes:Se}=Zt(),[ie]=t.useState(s.width||400),[we,ue]=t.useState(null),[be,Ee]=t.useState(!1),le=t.useRef(null),re=Ar(),R=!!((z=s==null?void 0:s.workflowContext)!=null&&z.episode)||re.pathname.includes("/episodes/");t.useEffect(()=>{F&&(O(),setTimeout(()=>{g()},100))},[F]),t.useEffect(()=>{const P=le.current;if(!P)return;const C=()=>{const p=P.videoWidth||0,a=P.videoHeight||0;if(p>0&&a>0){const v=p/a;ue(Math.round(ie/v))}},W=()=>Ee(!0),r=()=>Ee(!1),y=()=>Ee(!1);return P.addEventListener("loadedmetadata",C),P.addEventListener("play",W),P.addEventListener("pause",r),P.addEventListener("ended",y),()=>{P.removeEventListener("loadedmetadata",C),P.removeEventListener("play",W),P.removeEventListener("pause",r),P.removeEventListener("ended",y)}},[ie,s.videoUrl]);const $=P=>{P.stopPropagation();const C=le.current;C&&(C.paused?C.play():C.pause())};t.useEffect(()=>{try{const P=localStorage.getItem("suppressedPreviewTasks")||"[]",C=JSON.parse(P),W=s==null?void 0:s.pendingButtonAction;if(W&&C.some(y=>y.taskId&&y.taskId===W.newTaskId||y.sourceNodeId&&y.sourceNodeId===W.sourceNodeId)){fe(!1);return}}catch{}},[]);const O=async()=>{try{const P=await _e.assetLibraries.getAll();he(P.data),P.data.length>0&&oe(P.data[0].id)}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},g=()=>{const P=window.__workflowContext;if(!P||!P.project||!P.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const C=Hs(S,P.nodeGroups);if(!C&&P.nodeGroups.length>0){const r=P.nodeGroups[0],y=Ts({project:P.project,episode:P.episode,nodeGroup:r,assetType:"video"});y?(xe(y),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${y}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const W=Ts({project:P.project,episode:P.episode,nodeGroup:C,assetType:"video"});W?(xe(W),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${W}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},m=async()=>{var P,C;if(!Q){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Ae.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{te(!0),await _e.assetLibraries.addFromUrl(Q,s.videoUrl,Ae.trim());const W=window.__workflowContext;if(W&&W.project&&W.nodeGroups){const r=Hs(S,W.nodeGroups)||W.nodeGroups[0];r&&Ts({project:W.project,episode:W.episode,nodeGroup:r,nodeId:S,assetType:"video",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),fe(!1),xe("");try{Se(r=>r.map(y=>y.id===S?{...y,data:{...y.data,addedToLibrary:!0}}:y))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:Q}});window.dispatchEvent(r)}catch{}}catch(W){h.error(((C=(P=W.response)==null?void 0:P.data)==null?void 0:C.message)||"æ·»åŠ å¤±è´¥")}finally{te(!1)}},_=async()=>{var P;try{const C=s.videoUrl;let W=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const y=Hs(S,r.nodeGroups)||r.nodeGroups[0];if(y){const p=Ts({project:r.project,episode:r.episode,nodeGroup:y,nodeId:S,assetType:"video",preview:!0});if(p&&(W=p,!W.includes("."))){const a=((P=C.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:P[0])||".mp4";W+=a}}}h.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");try{const y=await fetch(C);if(!y.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${y.status}`);const p=await y.blob(),a=window.URL.createObjectURL(p),v=document.createElement("a");v.href=a,v.download=W,document.body.appendChild(v),v.click(),document.body.removeChild(v),setTimeout(()=>{window.URL.revokeObjectURL(a)},100),h.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${W}`)}catch{const p=`/api/assets/proxy-download-with-name?url=${encodeURIComponent(C)}&filename=${encodeURIComponent(W)}`,a=document.createElement("a");a.href=p,a.download=W,document.body.appendChild(a),a.click(),document.body.removeChild(a),h.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${W}`)}}catch(C){h.error(`æ“ä½œå¤±è´¥: ${C instanceof Error?C.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ie},children:[e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",onContextMenu:P=>{P.preventDefault(),P.stopPropagation()},onMouseDown:P=>{if(P.button===2){const C=P.currentTarget;C.style.pointerEvents="none",setTimeout(()=>{C.style.pointerEvents=""},100)}},children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${be?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:$,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:be?"pause":"play_arrow"})})}),e.jsx("video",{ref:le,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${l}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:we?`${we}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[R&&e.jsxs("button",{onClick:async()=>{var P,C;try{const W=s.videoUrl,r=s.workflowContext||{},y=r.episode,p=(()=>{try{const V=new URLSearchParams(window.location.search);return{scene:Number(V.get("scene")),shot:Number(V.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),a=r.nodeGroup||Hs(S,r.nodeGroups||[]),v=(a==null?void 0:a.scene)??p.scene,u=(a==null?void 0:a.shot)??p.shot,w=(()=>{try{const V=re.pathname.split("/").filter(Boolean),D=V.indexOf("projects"),ne=V.indexOf("episodes"),de=D>=0?V[D+1]:void 0,q=ne>=0?V[ne+1]:void 0;return{pid:de,eid:q}}catch{return{pid:void 0,eid:void 0}}})(),f=((P=r.project)==null?void 0:P.id)||(y==null?void 0:y.projectId)||w.pid,N=(y==null?void 0:y.id)||w.eid;if(!f||!N||!v||!u){h.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const j=await _e.episodes.getById(f,N),U=(j==null?void 0:j.data)??j,k=(U==null?void 0:U.data)??U,c=Array.isArray((C=k==null?void 0:k.scriptJson)==null?void 0:C.acts)?[...k.scriptJson.acts]:[];let i=c.find(V=>Number(V.actIndex)===Number(v));i||(i={actIndex:Number(v),shots:[]},c.push(i)),i.shots=Array.isArray(i.shots)?[...i.shots]:[];let n=i.shots.find(V=>Number(V.shotIndex)===Number(u));n||(n={shotIndex:Number(u),mediaList:[]},i.shots.push(n));const G=Array.isArray(n.mediaList)?n.mediaList.slice():[];if(G.length>=4){h.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}G.push({type:"video",url:W,nodeId:S}),n.mediaList=G;const M={...k.scriptJson||{},acts:c};await _e.episodes.update(f,N,{scriptJson:M});try{Se(V=>V.map(D=>D.id===S?{...D,data:{...D.data,addedToStoryboard:!0}}:D))}catch{}h.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(W){h.error((W==null?void 0:W.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{fe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:_,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),F&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>fe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Ae,onChange:P=>xe(P.target.value),onMouseDown:P=>P.stopPropagation(),onTouchStart:P=>P.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const P=ee==="ALL"?T:T.filter(C=>(C.category||"OTHER")===ee);return P.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:ee==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Q,onChange:C=>oe(C.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:P.map(C=>e.jsxs("option",{value:C.id,children:[C.name," (",C._count.assets," ä¸ªèµ„äº§)"]},C.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(P=>e.jsx("button",{type:"button",onClick:()=>{pe(P);const C=T.filter(W=>(W.category||"OTHER")===P);oe(C.length>0?C[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${ee===P?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:P==="ROLE"?"person":P==="SCENE"?"landscape":P==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:P==="ROLE"?"è§’è‰²åº“":P==="SCENE"?"åœºæ™¯åº“":P==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},P))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>fe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:m,disabled:Z||T.length===0||!Ae.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:Z?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`})]})},Io=t.memo(jo),So=({data:s,id:S,selected:l})=>{const{getNodes:F,getEdges:fe,setEdges:T,setNodes:he,getNode:Q}=Zt(),[oe,ee]=t.useState(s.content||""),pe=t.useRef(null),Ae=t.useRef(null),xe=t.useRef(null),Z=t.useRef(null);t.useEffect(()=>{const $=_=>{_.stopPropagation()},O=Ae.current,g=xe.current;O&&O.addEventListener("wheel",$,{passive:!0}),g&&g.addEventListener("wheel",$,{passive:!0});const m=Z.current;return m&&m.addEventListener("wheel",$,{passive:!0}),()=>{O&&O.removeEventListener("wheel",$),g&&g.removeEventListener("wheel",$),m&&m.removeEventListener("wheel",$)}},[]);const te=t.useRef(null),Se=async $=>{var O,g;try{const m=(s==null?void 0:s.workflowContext)||{},_=m.episode,z=m.nodeGroup||Array.isArray(m.nodeGroups)&&m.nodeGroups.find(N=>(N.nodeIds||[]).includes(S))||null;let P=z==null?void 0:z.scene,C=z==null?void 0:z.shot;try{const N=new URLSearchParams(window.location.search),j=Number(N.get("scene")),U=Number(N.get("shot"));Number.isFinite(j)&&j>0&&(P=P??j),Number.isFinite(U)&&U>0&&(C=C??U)}catch{}const W=((O=m.project)==null?void 0:O.id)||(_==null?void 0:_.projectId),r=_==null?void 0:_.id;if(!W||!r||!P||!C)return;const y=await _e.episodes.getById(W,r),p=(y==null?void 0:y.data)??y,a=(p==null?void 0:p.data)??p,v=Array.isArray((g=a==null?void 0:a.scriptJson)==null?void 0:g.acts)?[...a.scriptJson.acts]:[];let u=v.find(N=>Number(N.actIndex)===Number(P));u||(u={actIndex:Number(P),shots:[]},v.push(u)),u.shots=Array.isArray(u.shots)?[...u.shots]:[];let w=u.shots.find(N=>Number(N.shotIndex)===Number(C));w||(w={shotIndex:Number(C)},u.shots.push(w)),Object.keys($).forEach(N=>{w[N]=$[N]||""});const f={...a.scriptJson||{},acts:v};await _e.episodes.update(W,r,{scriptJson:f})}catch(m){h.error((m==null?void 0:m.message)||"ä¿å­˜å¤±è´¥")}},ie=()=>{var $,O,g;try{const m=F(),_=fe(),z=m.find(p=>p.id===S),P=_.filter(p=>p.source===S).map(p=>p.target),C=m.filter(p=>p.type==="agent");let W="";const r=C.find(p=>P.includes(p.id));if(r)W=r.id;else if(z&&C.length>0)W=((O=($=C.map(a=>{var v,u,w,f;return{a,dx:(((v=a.position)==null?void 0:v.x)??0)-(((u=z.position)==null?void 0:u.x)??0),dy:Math.abs((((w=a.position)==null?void 0:w.y)??0)-(((f=z.position)==null?void 0:f.y)??0))}}).sort((a,v)=>(a.dx>=0&&v.dx>=0,a.dx-v.dx||a.dy-v.dy))[0])==null?void 0:$.a)==null?void 0:O.id)||C[0].id;else{const p=m.findIndex(a=>a.id===S);W=((g=m[p+1])==null?void 0:g.id)||""}if(!W)return;T(p=>p.some(v=>v.source===S&&v.target===W)?p:[...p,{id:`e-${Date.now()}`,source:S,target:W}]);const y=oe||String((s==null?void 0:s.content)||"");he(p=>p.map(a=>{if(a.id!==W)return a;const v=a.data||{};return a.type==="agent"?{...a,data:{...v,config:{...v.config||{},prompt:y}}}:a.type==="midjourney"?{...a,data:{...v,prompt:y}}:a.type==="aiImage"?{...a,data:{...v,config:{...v.config||{},prompt:y}}}:a.type==="textPreview"?{...a,data:{...v,content:y}}:{...a,data:{...v,config:{...v.config||{},prompt:y}}}}))}catch{}},we=(s.title||"")==="åˆ†é•œè®¾è®¡",ue=(s.title||"")==="æç¤ºè¯",be=(()=>{if(!we)return[];const $=String(s.content||""),O=$.split(/\r?\n/).map(C=>C.trim()),g=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),m=[];let _=null;for(const C of O){if(!C)continue;const W=C.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(W&&g.has(W[1])){_&&m.push(_),_={label:W[1],content:W[2]||""};continue}if(g.has(C)){_&&m.push(_),_={label:C,content:""};continue}_?_.content=_.content?`${_.content}
${C}`:C:_={label:"æ–‡æœ¬",content:C}}if(_&&m.push(_),m.length===0)return[{label:"æ–‡æœ¬",content:$}];const z=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],P=new Map(z.map((C,W)=>[C,W]));return m.filter(C=>C.content&&C.content.trim().length>0).sort((C,W)=>(P.get(C.label)??999)-(P.get(W.label)??999))})(),[Ee,le]=t.useState(be),re=t.useRef(null),R=t.useRef([]);return t.useEffect(()=>{le(be)},[s.content,we]),t.useEffect(()=>{requestAnimationFrame(()=>{R.current.forEach($=>{$&&($.style.height="auto",$.style.height=`${$.scrollHeight}px`)})})},[Ee]),t.useEffect(()=>{ue&&ee(s.content||"")},[s.content,ue]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:we?e.jsx("div",{ref:xe,className:"space-y-2 nowheel",children:Ee.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ee.map(($,O)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:$.label}),e.jsx("textarea",{value:$.content,onChange:g=>{const m=g.target.value;g.target.style.height="auto",g.target.style.height=`${g.target.scrollHeight}px`,le(_=>{const z=_.map((W,r)=>r===O?{...W,content:m}:W),P=z.map(W=>`${W.label}ï¼š${W.content}`).join(`
`);return Q(S)&&he(W=>W.map(r=>r.id===S?{...r,data:{...r.data,content:P}}:r)),re.current&&(clearTimeout(re.current),re.current=null),re.current=window.setTimeout(async()=>{const W=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};z.forEach(y=>{W.has(y.label)&&(r[y.label]=y.content)}),await Se(r)},600),z})},onBlur:async g=>{const m=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),_={};_[$.label]=g.currentTarget.value,m.has($.label)&&await Se(_)},onMouseDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),ref:g=>{R.current[O]=g,g&&(g.style.height="auto",g.style.height=`${g.scrollHeight}px`,g.style.overflow="hidden",g.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",placeholder:`å¡«å†™${$.label}...`})]},`sec-${O}`))}):ue?e.jsxs("div",{ref:Ae,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:oe,onChange:$=>{const O=$.target.value;ee(O);const g=440;$.target.style.height="auto";const m=Math.min($.target.scrollHeight,g);$.target.style.height=`${m}px`,$.target.style.overflowY=$.target.scrollHeight>g?"auto":"hidden",Q(S)&&he(z=>z.map(P=>P.id===S?{...P,data:{...P.data,content:O}}:P)),te.current&&(clearTimeout(te.current),te.current=null),te.current=window.setTimeout(async()=>{await Se({æç¤ºè¯:O})},600)},onBlur:async $=>{const O=$.currentTarget.value;await Se({æç¤ºè¯:O})},onMouseDown:$=>$.stopPropagation(),onTouchStart:$=>$.stopPropagation(),ref:$=>{if(pe.current=$,$){$.style.wordBreak="break-word",$.style.height="auto";const g=Math.min($.scrollHeight,440);$.style.height=`${g}px`,$.style.overflowY=$.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ie,onPointerDown:$=>$.stopPropagation(),onMouseDown:$=>$.stopPropagation(),disabled:!oe.trim(),className:"nodrag relative w-full mt-2 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:Z,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(At,{type:"target",position:gt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(At,{type:"source",position:gt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Eo=t.memo(So),Co=({data:s,selected:S,id:l})=>{const{setNodes:F,setEdges:fe,getNode:T,getNodes:he,getEdges:Q,getViewport:oe}=Zt(),ee=Js(),pe=Os(),[Ae]=t.useState(s.isExpanded??!0),[xe,Z]=t.useState(s.prompt||""),[te,Se]=t.useState(s.ratio||"16:9"),[ie,we]=t.useState(s.mode||"relax"),[ue,be]=t.useState(s.chaos??0),[Ee,le]=t.useState(s.stylize??100),[re,R]=t.useState(s.weird??0),[$,O]=t.useState(s.quality??1),[g,m]=t.useState(s.styleRaw??!1),[_,z]=t.useState(s.omniWeight??100),[P,C]=t.useState(s.styleWeight??100),[,W]=t.useState(s.taskId||""),[r,y]=t.useState(s.status||"idle"),[p,a]=t.useState(s.progress||""),[v,u]=t.useState(s.omniReferenceImages||[]),[w,f]=t.useState(s.styleReferenceImages||[]),[N,j]=t.useState(!0);t.useEffect(()=>{(async()=>{var b;try{const J=await _e.midjourney.getSettings();j(((b=J.settings)==null?void 0:b.fastEnabled)??!0)}catch{}})()},[]);const{credits:U,isFreeUsage:k,freeUsageRemaining:c,refetch:i}=Ns({moduleType:"midjourney",operationType:"imagine",mode:ie}),n=t.useRef(null),G=t.useRef(!1),M=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==xe&&Z(s.prompt)},[s.prompt]);const V=I=>{F(b=>b.map(J=>J.id===l?{...J,data:{...J.data,...I}}:J))};t.useEffect(()=>{const I=s.taskId,b=s.status;(async()=>{var ce,B;if(I&&(b==="processing"||b==="submitting"))try{const Ce=(await _e.midjourney.fetchTask(I)).task;if(Ce.status==="SUCCESS"){const ve=Ce.imageUrl||"",$e=((ce=Ce.properties)==null?void 0:ce.messageId)||"",Te=((B=Ce.properties)==null?void 0:B.messageHash)||"",Ue=s.ratio||"16:9";if(y("idle"),a(""),V({status:"idle",progress:"",taskId:""}),he().find(Ve=>{var Ze,zt,Ot;return Ve.type==="imagePreview"&&((Ze=Ve.data.midjourneyData)==null?void 0:Ze.sourceNodeId)===l&&(((zt=Ve.data.midjourneyData)==null?void 0:zt.taskId)===I||$e&&((Ot=Ve.data.midjourneyData)==null?void 0:Ot.messageId)===$e)})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}h.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),q(ve,"4å®«æ ¼",Ue,{taskId:I,messageId:$e,messageHash:Te,mode:s.mode||"relax",buttons:Ce.buttons,action:Ce.action})}else Ce.status==="IN_PROGRESS"||Ce.status==="SUBMITTED"?(y("processing"),setTimeout(()=>{M.current(I)},100)):Ce.status==="FAILURE"?(y("error"),a(""),V({status:"error",progress:"",taskId:""}),h.error(Ce.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ce.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Ce.status==="NOT_FOUND"&&(y("idle"),a(""),V({status:"idle",progress:"",taskId:""}))}catch{y("idle"),a(""),V({status:"idle",progress:"",taskId:""}),h.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const D=t.useCallback(()=>{const I=ee.filter(ve=>ve.target===l),b=[],J=[];let ce="";I.forEach(ve=>{var Te,Ue,Re,se,Ve,Ze,zt,Ot;const $e=T(ve.source);if($e){const Tt=$e.data,dt=ve.targetHandle||"omni-ref";if(dt==="text-input"){if($e.type==="agent"){const pt=((Te=Tt.config)==null?void 0:Te.generatedText)||"";pt&&typeof pt=="string"&&(ce=pt)}}else{let pt=Tt.imageUrl||"";if(!pt&&((Ue=Tt.config)!=null&&Ue.selectedAsset)){const Nt=Tt.config.selectedAsset;Nt.type==="IMAGE"&&(pt=`https://api.waule.ai${Nt.url}`.replace(".oss-oss-",".oss-"))}if(!pt&&((Re=Tt.config)!=null&&Re.generatedImageUrl)&&(pt=Tt.config.generatedImageUrl),$e.type==="assetSelector"){const Nt="https://api.waule.ai",lt=ze=>{let wt=ze||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${Nt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,Nt))},Ke=(se=Tt.config)==null?void 0:se.subjects,vt=(Ve=Tt.config)==null?void 0:Ve.referenceImages;if(dt==="omni-ref"){let ze="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?ze=lt(Ke[0].images[0]):vt&&vt.length>0?ze=lt(vt[0].url):(Ze=Tt.config)!=null&&Ze.selectedAsset&&Tt.config.selectedAsset.type==="IMAGE"&&(ze=lt(Tt.config.selectedAsset.url)),ze&&!b.includes(ze)&&b.length<1&&b.push(ze)}else if(dt==="style-ref"){let ze="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?ze=lt(Ke[0].images[0]):vt&&vt.length>0?ze=lt(vt[0].url):(zt=Tt.config)!=null&&zt.selectedAsset&&Tt.config.selectedAsset.type==="IMAGE"&&(ze=lt(Tt.config.selectedAsset.url)),ze&&!J.includes(ze)&&J.length<1&&J.push(ze)}}if($e.type==="upload"){const Nt="https://api.waule.ai",lt=ze=>{let wt=ze||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${Nt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,Nt))},vt=(((Ot=Tt.config)==null?void 0:Ot.uploadedFiles)||[]).find(ze=>ze.type==="IMAGE"||(ze.mimeType||"").startsWith("image/"));if(vt){const ze=lt(vt.url);dt==="omni-ref"?ze&&!b.includes(ze)&&b.length<1&&b.push(ze):dt==="style-ref"&&ze&&!J.includes(ze)&&J.length<1&&J.push(ze)}}pt&&(dt==="omni-ref"&&!b.includes(pt)?b.push(pt):dt==="style-ref"&&!J.includes(pt)&&J.push(pt))}}}),ce&&ce!==xe&&!G.current&&(Z(ce),V({prompt:ce}));const B=ve=>{if(!ve||typeof ve!="string")return!1;const $e=ve.trim();return $e?!!($e.startsWith("data:image/")||/^https?:\/\//.test($e)||$e.startsWith("/")):!1},ge=b.filter(B).slice(0,1),Ce=J.filter(B).slice(0,1);JSON.stringify(ge)!==JSON.stringify(v)&&(u(ge),V({omniReferenceImages:ge})),JSON.stringify(Ce)!==JSON.stringify(w)&&(f(Ce),V({styleReferenceImages:Ce}))},[ee,l,T,pe,xe,G.current]);t.useEffect(()=>{D()},[D]),t.useEffect(()=>{const I=n.current;I&&Ae&&requestAnimationFrame(()=>{I.style.height="auto";const b=Math.max(60,Math.min(I.scrollHeight,600));I.style.height=`${b}px`})},[xe,Ae]);const ne=I=>{try{const b=new URL(I),J=new URLSearchParams(b.search);return J.has("width")||J.has("height")?(J.delete("width"),J.delete("height"),b.search=J.toString(),b.toString()):I}catch{return I}},de=I=>{const[J,ce]=I.split(":").map(Number);if(!J||!ce)return{width:512,height:512};const B=J/ce;return B>=1?{width:512,height:Math.round(512/B)}:{width:Math.round(512*B),height:512}},q=t.useCallback((I,b,J,ce)=>{const B=T(l);if(!B)return;const ge=b.startsWith("U")?ne(I):I,Ce=he(),ve=Q();if(Ce.filter(ze=>ze.type==="imagePreview"&&ve.some(wt=>wt.source===l&&wt.target===ze.id)).find(ze=>ze.data.imageUrl===ge))return;const Ue=400,Re=200,se=100,Ve=ze=>{const wt=oe().zoom||1,ts=document.querySelector(`.react-flow__node[data-id="${ze.id}"]`),ms=(ts==null?void 0:ts.getBoundingClientRect().width)||ze.data&&ze.data.width||400,Rs=(ts==null?void 0:ts.getBoundingClientRect().height)||ze.data&&ze.data.height||300,Is=Math.round(ms/wt),Ss=Math.round(Rs/wt);return{w:Is,h:Ss}},Ze=(ze,wt=300)=>{if(!ze||!/^[0-9]+\s*:\s*[0-9]+$/.test(ze))return wt;const[ts,ms]=ze.split(":").map(Rs=>parseFloat(Rs));return!ts||!ms?wt:Math.round(Ue*(ms/ts))},zt=Ve(B),Ot=Ze(J,300),Tt=B.position.x+zt.w+Re,dt=B.position.y,pt=he().filter(ze=>{var wt,ts;return ze.type==="imagePreview"&&((ts=(wt=ze.data)==null?void 0:wt.midjourneyData)==null?void 0:ts.sourceNodeId)===l}).length,Nt=Tt,lt=dt+pt*(Ot+se),Ke=`preview-${Date.now()}`,vt={id:Ke,type:"imagePreview",position:{x:Nt,y:lt},data:{imageUrl:ge,width:Ue,ratio:J,workflowContext:B.data.workflowContext,createdBy:B.data.createdBy,midjourneyData:ce?{taskId:ce.taskId,messageId:ce.messageId,messageHash:ce.messageHash,sourceNodeId:l,mode:ce.mode,buttons:ce.buttons,action:ce.action}:void 0}};F(ze=>[...ze,vt]),fe(ze=>[...ze,{id:`${l}-${Ke}`,source:l,target:Ke,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),h.success(`âœ¨ å·²åˆ›å»º${b}é¢„è§ˆèŠ‚ç‚¹`)},[l,T,he,Q,F,fe,ne,de]),x=t.useCallback(async()=>{var I,b,J,ce,B,ge,Ce,ve,$e,Te,Ue,Re;if(!xe.trim()){h.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}y("submitting"),a(""),V({status:"submitting",progress:""});try{const se=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ve=xe.toLowerCase(),Ze=se.find(lt=>Ve.includes(lt));if(Ze){h.error(`æ£€æµ‹åˆ°å‚æ•° "${Ze}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),y("idle"),V({status:"idle",progress:"",taskId:""});return}y("submitting");let zt=xe;try{h.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const lt=await _e.translation.smartTranslate({text:xe});lt.success&&(zt=lt.translatedText,lt.needsTranslation&&h.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{h.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}h.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let Ot=zt.trim();if(te&&te!=="1:1"&&!Ot.includes("--ar")&&(Ot+=` --ar ${te}`),!Ot.includes("--v")&&!Ot.includes("--version")&&(Ot+=" --v 7.0"),ie==="fast"&&!Ot.includes("--fast")?Ot+=" --fast":ie==="relax"&&!Ot.includes("--relax")&&(Ot+=" --relax"),ue>0&&(Ot+=` --chaos ${ue}`),Ee!==100&&(Ot+=` --stylize ${Ee}`),re>0&&(Ot+=` --weird ${re}`),$!==1&&(Ot+=` --quality ${$}`),g&&(Ot+=" --style raw"),v.length>0){h.info(`æ­£åœ¨ä¸Šä¼  ${v.length} å¼ å‚è€ƒå›¾...`);const lt=[];for(let Ke=0;Ke<v.length;Ke++){const vt=v[Ke];try{const ze=await _e.midjourney.uploadReferenceImage({imageUrl:vt});if(ze.success&&ze.discordUrl)lt.push(ze.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{h.error(`å‚è€ƒå›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),y("idle");return}}Ot+=` --oref ${lt.join(" ")}`,_!==100&&(Ot+=` --ow ${_}`),h.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(w.length>0){h.info(`æ­£åœ¨ä¸Šä¼  ${w.length} å¼ é£æ ¼å›¾...`);const lt=[];for(let Ke=0;Ke<w.length;Ke++){const vt=w[Ke];try{const ze=await _e.midjourney.uploadReferenceImage({imageUrl:vt});if(ze.success&&ze.discordUrl)lt.push(ze.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{h.error(`é£æ ¼å›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),y("idle");return}}Ot+=` --sref ${lt.join(" ")}`,P!==100&&(Ot+=` --sw ${P}`),h.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const Tt=await _e.midjourney.imagine({prompt:Ot,nodeId:l,mode:ie});if(!Tt.success)throw new Error(Tt.description||"ä»»åŠ¡æäº¤å¤±è´¥");const dt=Tt.taskId;W(dt),y("processing"),V({taskId:dt,status:"processing",progress:"",prompt:xe,ratio:te,mode:ie,chaos:ue,stylize:Ee,weird:re,quality:$,styleRaw:g,omniWeight:_,styleWeight:P});const pt=Tt.isFreeUsage,Nt=Tt.creditsCharged||0;if(pt)h.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${c} æ¬¡æœºä¼š`),i();else if(Nt>0){const{useAuthStore:lt}=await us(async()=>{const{useAuthStore:vt}=await import("./index-CKw8I0iR.js").then(ze=>ze.f);return{useAuthStore:vt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ke}=lt.getState();await Ke(),h.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${Nt} ç§¯åˆ†`),i()}else h.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");M.current(dt)}catch(se){if(y("error"),a(""),V({status:"error",progress:"",taskId:""}),((I=se.response)==null?void 0:I.status)===403){const zt=((J=(b=se.response)==null?void 0:b.data)==null?void 0:J.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";h.error(zt);return}if(((ce=se.response)==null?void 0:ce.status)===429){h.warning(((ge=(B=se.response)==null?void 0:B.data)==null?void 0:ge.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ve=((ve=(Ce=se.response)==null?void 0:Ce.data)==null?void 0:ve.description)||((Te=($e=se.response)==null?void 0:$e.data)==null?void 0:Te.error)||se.message,Ze=(Re=(Ue=se.response)==null?void 0:Ue.data)==null?void 0:Re.bannedWord;Ze?h.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${Ze}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):h.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ve}ï¼Œè¯·ç¨åé‡è¯•`)}},[xe,te,ie,ue,Ee,re,$,g,v,_,w,P,V,k,c,i]),d=t.useCallback(async I=>{let b=0;const J=150,ce=2e3,B=async()=>{var ge,Ce,ve,$e;try{const Ue=(await _e.midjourney.fetchTask(I)).task;if(Ue.status==="SUCCESS"){const se=Ue.imageUrl||"",Ve=((ge=Ue.properties)==null?void 0:ge.messageId)||"",Ze=((Ce=Ue.properties)==null?void 0:Ce.messageHash)||"";if(y("idle"),a(""),V({status:"idle",taskId:"",progress:""}),he().find(Tt=>{var dt,pt,Nt;return Tt.type==="imagePreview"&&((dt=Tt.data.midjourneyData)==null?void 0:dt.sourceNodeId)===l&&(((pt=Tt.data.midjourneyData)==null?void 0:pt.taskId)===I||Ve&&((Nt=Tt.data.midjourneyData)==null?void 0:Nt.messageId)===Ve)})){h.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}h.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),q(se,"4å®«æ ¼",te,{taskId:I,messageId:Ve,messageHash:Ze,mode:ie,buttons:Ue.buttons,action:Ue.action});return}const Re=Ue.progress||"";if(a(Re),(Ue.status==="IN_PROGRESS"||Ue.status==="SUBMITTED")&&(y("processing"),V({status:"processing",progress:Re})),Ue.status==="FAILURE"){y("error"),a(""),V({status:"error",progress:"",taskId:""}),h.error(Ue.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ue.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(Ue.status==="NOT_FOUND"){y("error"),a(""),V({status:"error",progress:"",taskId:""}),h.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}b++,b<J?setTimeout(B,ce):(y("error"),a(""),V({status:"error",progress:"",taskId:""}),h.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Te){if((Te.code==="ECONNABORTED"||Te.code==="ERR_NETWORK"||((ve=Te.message)==null?void 0:ve.includes("aborted"))||(($e=Te.message)==null?void 0:$e.includes("Network Error")))&&b<J-1){b++,setTimeout(B,ce*2);return}y("error"),a(""),V({status:"error",progress:"",taskId:""}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};B()},[l,te,q,V,he]);return M.current=d,e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Ae&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:n,value:xe,onChange:I=>{G.current=!0,Z(I.target.value)},onPointerDown:I=>I.stopPropagation(),onMouseDown:I=>I.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:I=>I.stopPropagation(),onMouseDown:I=>I.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>we("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ie==="relax"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!N){h.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}we("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${N?ie==="fast"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50":"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:cursor-not-allowed`,title:N?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!N&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(as,{value:te,onChange:I=>Se(I),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:ue})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:ue,onChange:I=>be(Number(I.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${ue/2}%, #06b6d4 ${ue}%, var(--range-bg-color) ${ue}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ee})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ee,onChange:I=>le(Number(I.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Ee/1e3*50}%, #06b6d4 ${Ee/1e3*100}%, var(--range-bg-color) ${Ee/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:re})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:re,onChange:I=>R(Number(I.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${re/3e3*50}%, #06b6d4 ${re/3e3*100}%, var(--range-bg-color) ${re/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:$})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:$===.25?0:$===.5?1:$===1?2:3,onChange:I=>{const b=Number(I.target.value);O(b===0?.25:b===1?.5:b===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${($===.25?0:$===.5?1:$===1?2:3)/3*50}%, #06b6d4 ${($===.25?0:$===.5?1:$===1?2:3)/3*100}%, var(--range-bg-color) ${($===.25?0:$===.5?1:$===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>m(!g),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:cursor-not-allowed ${g?"bg-neutral-800 dark:bg-white text-white dark:text-black border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-neutral-500 dark:border-neutral-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${g?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-neutral-800 dark:bg-white text-white dark:text-black"}`})})]})})]}),v.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Lr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",v.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:v.map((I,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:I,alt:`Reference ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:_})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:_,onChange:I=>z(Number(I.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${_/1e3*50}%, #06b6d4 ${_/1e3*100}%, var(--range-bg-color) ${_/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),w.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Lr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",w.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:w.map((I,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:I,alt:`Style ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:P})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:P,onChange:I=>C(Number(I.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${P/1e3*50}%, #06b6d4 ${P/1e3*100}%, var(--range-bg-color) ${P/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:x,onPointerDown:I=>I.stopPropagation(),onMouseDown:I=>I.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1||!(xe!=null&&xe.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 relative overflow-hidden ${r==="processing"||r==="submitting"||!(xe!=null&&xe.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:[r==="processing"&&p&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-neutral-400/30 to-accent-400/30 transition-all duration-300",style:{width:p}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!p||p===""||p==="0%"?ie==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${p}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),k?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(c),"æ¬¡"]}):U!==null&&U>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:[U,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(hs,{type:"target",position:gt.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:I=>{const b=T(I.source||"");return!!b&&b.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(hs,{type:"target",position:gt.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:I=>!ee.some(J=>J.target===l&&J.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(hs,{type:"target",position:gt.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:I=>!ee.some(J=>J.target===l&&J.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(hs,{type:"source",position:gt.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},kr="https://api.waule.ai",Ao=({data:s,selected:S,id:l})=>{var bs,Ks,Es,$s,sr,rr,Vs;const[F,fe]=t.useState(!0),[,T]=t.useState(0),[he,Q]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[he]);const{setNodes:oe,setEdges:ee,getNode:pe,getNodes:Ae,getEdges:xe}=Zt(),Z=Js(),te=Os(),Se=t.useRef(""),ie=(bs=s.config)==null?void 0:bs.selectedEditingCapability,we=t.useMemo(()=>(s.models||[]).filter(ae=>{var Me;return ae.type==="VIDEO_GENERATION"&&((Me=ae.provider)==null?void 0:Me.toLowerCase())==="sora"}),[s.models]),[ue,be]=t.useState(s.config.prompt||""),Ee=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ue&&be(s.config.prompt)},[s.config.prompt]);const[le,re]=t.useState(s.config.modelId||((Ks=we[0])==null?void 0:Ks.id)||""),[R,$]=t.useState(s.config.ratio||"16:9"),[O,g]=t.useState(s.config.resolution||"1080P"),m=t.useCallback(K=>{const ae=(K||"").toLowerCase();return ae?ae.includes("æ–‡ç”Ÿ")||ae.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ae.includes("é¦–å°¾")?"é¦–å°¾å¸§":ae.includes("é¦–å¸§")||ae.includes("first frame")||ae.includes("start frame")||ae.includes("initial frame")||ae.includes("keyframe")?"é¦–å¸§":ae.includes("å°¾å¸§")||ae.includes("last frame")||ae.includes("end frame")||ae.includes("final frame")?"å°¾å¸§":ae.includes("ä¸»ä½“å‚è€ƒ")||ae.includes("å‚è€ƒ")||ae.includes("reference image")||ae.includes("image reference")||ae.includes("ref image")?"å‚è€ƒå›¾":ae.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ae.includes("first-last")||ae.includes("two-frame")||ae.includes("frame pair")?"é¦–å°¾å¸§":ae.includes("first")?"é¦–å¸§":ae.includes("last")?"å°¾å¸§":ae.includes("subject")||ae.includes("reference")?"å‚è€ƒå›¾":K||"":""},[]),[_,z]=t.useState((s.config.lockedGenerationType?m(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[P,C]=t.useState(s.config.duration||10),[W,r]=t.useState(s.config.isGenerating||!1),[y,p]=t.useState([]),[a,v]=t.useState(null),[u,w]=t.useState(!1),[f]=t.useState(""),[N]=t.useState("confirm"),[j]=t.useState(null),[U,k]=t.useState(!1),[c,i]=t.useState([]),[n,G]=t.useState(""),[M,V]=t.useState(0),[D,ne]=t.useState(0),de=t.useRef(!1),[q,x]=t.useState(!1),d=we.find(K=>K.id===le)||we[0],{credits:I,loading:b,isFreeUsage:J,freeUsageRemaining:ce,refetch:B}=Ns({aiModelId:d==null?void 0:d.id,duration:P,resolution:O});t.useEffect(()=>{var K,ae;if(!we.find(Me=>Me.id===le)){const Me=((K=we[0])==null?void 0:K.id)||"";re(Me),Ze({modelId:Me,modelName:(ae=we[0])==null?void 0:ae.name})}},[we]);const ge=((Es=d==null?void 0:d.provider)==null?void 0:Es.toLowerCase())==="sora",Ce=t.useMemo(()=>{var ae;if((ae=d==null?void 0:d.config.supportedDurations)!=null&&ae.length)return d.config.supportedDurations;const K=((d==null?void 0:d.provider)||"").toLowerCase();return K==="sora"?[10,15]:K==="minimaxi"?[6,10]:[P||10]},[d,P]),ve=t.useMemo(()=>{var ae;return(ae=d==null?void 0:d.config.supportedResolutions)!=null&&ae.length?d.config.supportedResolutions:((d==null?void 0:d.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[d]),$e=t.useMemo(()=>Math.min(...Ce),[Ce]),Te=t.useMemo(()=>Math.max(...Ce),[Ce]),Ue=t.useMemo(()=>Math.max(1,Te-$e),[Te,$e]),Re=t.useMemo(()=>{const K=(P-$e)/Ue*100;return Number.isNaN(K)?0:Math.min(100,Math.max(0,K))},[P,$e,Ue]),se=!d||!(($s=d.config.supportedDurations)!=null&&$s.length),Ve=!d||!((sr=d.config.supportedResolutions)!=null&&sr.length),Ze=t.useCallback(K=>{pe(l)&&oe(Me=>Me.map(Ge=>Ge.id===l?{...Ge,data:{...Ge.data,config:{...Ge.data.config,...K}}}:Ge))},[pe,l,oe]),zt=(K,ae)=>{const Me=(yt,E)=>E===0?yt:Me(E,yt%E),Ge=Me(K,ae),qe=K/Ge,Oe=ae/Ge,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},bt=`${qe}:${Oe}`;return tt[bt]||bt},Ot=()=>{const K=Z.filter(Oe=>Oe.target===l),ae=[];K.forEach(Oe=>{var bt;const tt=pe(Oe.source);if(tt&&tt.type==="upload"&&(((bt=tt.data.config)==null?void 0:bt.uploadedFiles)||[]).forEach(E=>{const H=E.type||E.mimeType||"";(H==="IMAGE"||H.startsWith("image/"))&&ae.push({id:E.id||E.name,url:E.url,name:E.name||E.originalName,width:E.width,height:E.height,aspectRatio:E.width&&E.height?zt(E.width,E.height):"16:9"})}),tt&&tt.type==="assetSelector"){const yt=tt.data.config||{},E=yt.subjects,H=yt.selectedAsset,Ne=m(_);E&&E.length>0?Ne==="é¦–å°¾å¸§"||(E[0].images||[]).forEach((me,Ie)=>{ae.push({id:`${tt.id}-subject-${Ie}`,url:me,name:E[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):H&&H.type==="IMAGE"&&ae.push({id:H.id,url:H.url,name:H.name||H.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const yt=tt.data.imageUrl,E=tt.data.width,H=tt.data.height;yt&&ae.push({id:tt.id,url:yt,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:E,height:H,aspectRatio:E&&H?zt(E,H):"16:9"})}});const Me=new Set,Ge=[];ae.forEach(Oe=>{const tt=Oe.url;Me.has(tt)||(Me.add(tt),Ge.push(Oe))});const qe=m(_);return qe==="æ–‡ç”Ÿè§†é¢‘"?ge?Ge:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ge.slice(0,1):qe==="é¦–å°¾å¸§"?Ge.slice(0,2):qe==="å‚è€ƒå›¾"?Ge.slice(0,7):Ge},Tt=t.useMemo(()=>Ot(),[Z,te,_,l,ge]);t.useEffect(()=>{const K=s.config.taskId;(async()=>{if(K){try{const Ge=(await _e.tasks.getTaskStatus(K)).task;if(Ge.status==="SUCCESS"){r(!1),T(100);const qe=Ge.resultUrl;if(!qe){r(!1),T(0),Ze({taskId:"",isGenerating:!1}),Q(""),h.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Oe=s.config.ratio||"16:9";Ze({taskId:"",isGenerating:!1}),Q("");const tt=Ae(),bt=xe();if(tt.filter(H=>H.type==="videoPreview"&&bt.some(Ne=>Ne.source===l&&Ne.target===H.id)).find(H=>H.data.videoUrl===qe)){setTimeout(()=>T(0),1e3);return}h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼");try{const H=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(H).some(me=>me.taskId&&me.taskId===K||me.sourceNodeId&&me.sourceNodeId===l)||Ut(qe,Oe)}catch{Ut(qe,Oe)}setTimeout(()=>T(0),1e3)}else if(Ge.status==="PROCESSING"||Ge.status==="PENDING"){r(!0),T(Ge.progress||0),js(K);return}else Ge.status==="FAILURE"&&(r(!1),T(0),Ze({taskId:"",isGenerating:!1}),Q(""),h.error(`ç”Ÿæˆå¤±è´¥: ${Ge.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{r(!1),T(0),Ze({taskId:"",isGenerating:!1}),Q("")}return}try{const Me=await _e.tasks.getPendingPreviewNodes(l);if(Me.tasks&&Me.tasks.length>0)for(const Ge of Me.tasks){const{previewNodeData:qe}=Ge;if(qe&&qe.url){const Oe=qe.ratio||s.config.ratio||"16:9";let tt=!1;try{const bt=localStorage.getItem("suppressedPreviewTasks")||"[]";tt=JSON.parse(bt).some(E=>E.taskId&&E.taskId===Ge.id||E.sourceNodeId&&E.sourceNodeId===l)}catch{}tt||(Ut(qe.url,Oe),h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")),await _e.tasks.markPreviewNodeCreated(Ge.id)}}}catch{}})()},[]),t.useEffect(()=>{const K=Z.filter(Me=>Me.target===l);let ae="";K.forEach(Me=>{var qe;const Ge=pe(Me.source);if(Ge){const Oe=Ge.data;Ge.type==="agent"&&((qe=Oe.config)!=null&&qe.generatedText)?ae||(ae=Oe.config.generatedText):Ge.type==="textPreview"&&Oe.content&&(ae||(ae=Oe.content))}}),ae&&ae!==ue&&(be(ae),Ze({prompt:ae}))},[Z,l,pe,ue,Ze]),t.useEffect(()=>{const K=Z.filter(Ge=>Ge.target===l);if(K.length===0)return;let ae="",Me="";K.forEach(Ge=>{var Oe;const qe=te.find(tt=>tt.id===Ge.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Oe=tt.config)!=null&&Oe.generatedText&&(ae=tt.config.generatedText,Me=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),ae&&Me!==Se.current&&(Se.current=Me,be(ae),Ze({prompt:ae}))},[te,Z,l,Ze]),t.useEffect(()=>{const K=JSON.stringify(Tt),ae=JSON.stringify(y);K!==ae&&p(Tt)},[Tt]);const dt=t.useMemo(()=>{if(ge)return!0;const K=y.length,ae=m(_);return K===0?!0:K===1?ae==="å‚è€ƒå›¾":K===2?ae==="é¦–å°¾å¸§"?!1:ae==="å‚è€ƒå›¾":K>2?ae==="å‚è€ƒå›¾":!1},[y.length,_,m,ge]),pt=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Nt=t.useMemo(()=>{const K=m(_);return ie?we:we.filter(ae=>{var Ge;const Me=(((Ge=ae.config)==null?void 0:Ge.supportedGenerationTypes)||[]).map(qe=>m(qe));return K==="é¦–å¸§"||K==="å°¾å¸§"?Me.includes("é¦–å¸§")||Me.includes("å°¾å¸§"):Me.includes(K)})},[we,_,m,ie]),lt=t.useMemo(()=>{const K=ie?we:Nt;return K.length>0?K:ie?(s.models||[]).filter(Me=>(Me.type||"")==="VIDEO_EDITING"):K},[ie,we,Nt,s.models]);t.useEffect(()=>{var ae,Me;if(!lt.find(Ge=>Ge.id===le)){const Ge=((ae=lt[0])==null?void 0:ae.id)||"";re(Ge),Ze({modelId:Ge||void 0,modelName:Ge?(Me=lt[0])==null?void 0:Me.name:void 0})}},[lt]);const Ke=t.useCallback(K=>{const ae=m(K);return ie?["IMAGE","VIDEO"]:ae==="æ–‡ç”Ÿè§†é¢‘"?ge?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[m,ie,ge]);t.useEffect(()=>{if(!dt&&y.length>0){const K=y[0].aspectRatio;K&&R!==K&&($(K),setTimeout(()=>{Ze({ratio:K})},0))}},[dt,y,R]),t.useEffect(()=>{if(!ie&&pt.length>0&&!pt.includes(_)){const K="æ–‡ç”Ÿè§†é¢‘";z(K),setTimeout(()=>{Ze({generationType:K,acceptedInputs:Ke(K)})},0)}},[pt,_,Ke,ie]),t.useEffect(()=>{const K=m(_);if(K==="æ–‡ç”Ÿè§†é¢‘")return;const ae=Z.filter(Oe=>Oe.target===l),Me=[],Ge=[];ae.forEach(Oe=>{var yt,E,H,Ne,je;const tt=pe(Oe.source);if(!tt)return;const bt=tt.type;if((bt||"").startsWith("aiVideo")||bt==="videoPreview"){Ge.push(Oe.id);return}if(bt==="upload"){const me=(H=(E=(yt=tt.data)==null?void 0:yt.config)==null?void 0:E.uploadedFiles)==null?void 0:H[0],Ie=((me==null?void 0:me.type)||"").toUpperCase(),nt=((me==null?void 0:me.mimeType)||"").toLowerCase();if(Ie==="VIDEO"||nt.startsWith("video/")){Ge.push(Oe.id);return}(Ie==="IMAGE"||nt.startsWith("image/"))&&Me.push(Oe.id);return}if(bt==="assetSelector"){const me=((Ne=tt.data)==null?void 0:Ne.config)||{};if(me.selectedAsset){const Ie=(me.selectedAsset.type||"").toUpperCase(),nt=(me.selectedAsset.mimeType||"").toLowerCase();Ie==="VIDEO"||nt.startsWith("video/")?Ge.push(Oe.id):(Ie==="IMAGE"||nt.startsWith("image/"))&&Me.push(Oe.id)}else if(me.subjects&&me.subjects.length>0){const Ie=(((je=me.subjects[0])==null?void 0:je.images)||[]).length;K==="å‚è€ƒå›¾"||K==="é¦–å°¾å¸§"?Me.push(Oe.id):(K==="é¦–å¸§"||K==="å°¾å¸§")&&(Ie>1?Ge.push(Oe.id):Me.push(Oe.id))}return}(bt==="aiImage"||bt==="imagePreview")&&Me.push(Oe.id)});let qe=new Set([...Ge]);K==="é¦–å¸§"||K==="å°¾å¸§"?Me.slice(1).forEach(Oe=>qe.add(Oe)):K==="é¦–å°¾å¸§"&&Me.slice(2).forEach(Oe=>qe.add(Oe)),qe.size>0&&ee(Oe=>Oe.filter(tt=>!qe.has(tt.id)))},[_,Z,l,pe,ee,m]),t.useEffect(()=>{const K=s.config.generationType;if(!K||m(K)!==m(_)){const ae=m(_)||"æ–‡ç”Ÿè§†é¢‘";Ze({generationType:ae,acceptedInputs:Ke(ae)})}},[]),t.useEffect(()=>{const K=Ke(_);Ze({acceptedInputs:K})},[_,Ke]);const vt=K=>{v(K)},ze=K=>{K.preventDefault()},wt=K=>{if(a===null)return;const ae=[...y],[Me]=ae.splice(a,1);ae.splice(K,0,Me),p(ae),v(null),Ze({referenceImages:ae})};t.useEffect(()=>{const K=Ee.current;K&&F&&requestAnimationFrame(()=>{K.style.height="auto";const ae=Math.max(60,Math.min(K.scrollHeight,600));K.style.height=`${ae}px`})},[ue,F]),t.useEffect(()=>{if(ue===s.config.prompt)return;const K=setTimeout(()=>{Ze({prompt:ue})},500);return()=>clearTimeout(K)},[ue]);const ts=t.useCallback(async K=>{if(!K){i([]);return}try{const ae=await _e.soraCharacters.search(K,5);i(ae.characters||[]),ne(0)}catch{i([])}},[]),ms=t.useCallback(K=>{const ae=K.target.value,Me=K.target.selectionStart||0;if(be(ae),de.current)return;const qe=ae.substring(0,Me).match(/@([^@\s#]*)$/);if(qe){const Oe=qe[1];G(Oe),V(Me-Oe.length-1),k(!0),ts(Oe)}else k(!1),i([])},[ts]),Rs=t.useCallback(K=>{const ae=ue.substring(0,M),Me=ue.substring(M+n.length+1),Ge=`@#${K.customName}#`,qe=ae+Ge+Me;be(qe),k(!1),i([]),G(""),setTimeout(()=>{if(Ee.current){Ee.current.focus();const Oe=ae.length+Ge.length;Ee.current.setSelectionRange(Oe,Oe)}},0)},[ue,M,n]),Is=t.useCallback(K=>{!U||c.length===0||(K.key==="ArrowDown"?(K.preventDefault(),ne(ae=>ae<c.length-1?ae+1:ae)):K.key==="ArrowUp"?(K.preventDefault(),ne(ae=>ae>0?ae-1:ae)):K.key==="Enter"&&c[D]?(K.preventDefault(),Rs(c[D])):K.key==="Escape"&&k(!1))},[U,c,D,Rs]),Ss=t.useCallback(async K=>{var qe;const ae=/@#([^#]+)#/g,Me=[...K.matchAll(ae)];if(Me.length===0)return K;let Ge=K;for(const Oe of Me){const tt=Oe[1];try{const bt=await _e.soraCharacters.getByCustomName(tt);(qe=bt.character)!=null&&qe.characterName&&(Ge=Ge.replace(Oe[0],` ${bt.character.characterName} `))}catch{}}return Ge},[]),Gs=K=>{var Me,Ge,qe,Oe;re(K);const ae=Nt.find(tt=>tt.id===K);if(ae){const tt=(Me=ae.config.supportedRatios)!=null&&Me.length?ae.config.supportedRatios:["16:9"],bt=(Ge=ae.config.supportedResolutions)!=null&&Ge.length?ae.config.supportedResolutions:["1080P"],yt=(qe=ae.config.supportedGenerationTypes)!=null&&qe.length?ae.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],E=(ae.provider||"").toLowerCase(),H=(Oe=ae.config.supportedDurations)!=null&&Oe.length?ae.config.supportedDurations:E==="sora"?[10,15]:E==="minimaxi"?[6,10]:[10],Ne=tt[0],je=bt[0],me=m(_||yt[0]),Ie=H[0];$(Ne),g(je),z(me),C(Ie),Ze({modelId:K,modelName:ae.name,ratio:Ne,resolution:je,generationType:me,duration:Ie,acceptedInputs:Ke(me)})}},ks=t.useMemo(()=>{const K=m(_),ae=y.length,qe=Z.filter(Oe=>Oe.target===l).filter(Oe=>{var yt,E,H,Ne,je;const tt=pe(Oe.source),bt=tt==null?void 0:tt.type;if(!tt)return!1;if(bt==="upload"){const me=(H=(E=(yt=tt.data)==null?void 0:yt.config)==null?void 0:E.uploadedFiles)==null?void 0:H[0],Ie=((me==null?void 0:me.mimeType)||"").toLowerCase();return((me==null?void 0:me.type)||"").toUpperCase()==="VIDEO"||Ie.startsWith("video/")}if(bt==="assetSelector"){const me=(je=(Ne=tt.data)==null?void 0:Ne.config)==null?void 0:je.selectedAsset,Ie=((me==null?void 0:me.mimeType)||"").toLowerCase();return((me==null?void 0:me.type)||"").toUpperCase()==="VIDEO"||Ie.startsWith("video/")}return!!((bt||"").startsWith("aiVideo")||bt==="videoPreview")}).length;return le?K==="æ–‡ç”Ÿè§†é¢‘"?ge?!0:!!ue.trim():K==="é¦–å¸§"||K==="å°¾å¸§"?ae>=1:K==="é¦–å°¾å¸§"?ae>=2:K==="å‚è€ƒå›¾"?ae>=1:K==="è§†é¢‘æ¢äºº"?qe>=1&&ae>=1:K==="å¯¹å£å‹"||K==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[_,y.length,ue,W,Z,l,pe,m,ge]);t.useEffect(()=>{var ae;const K=(ae=s==null?void 0:s.config)==null?void 0:ae.generatedVideoUrl;K&&Ut(K,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const js=async K=>{let Me=0;const Ge=async()=>{try{Me++;const Oe=(await _e.tasks.getTaskStatus(K)).task;if(T(Oe.progress||0),Oe.status==="SUCCESS"||Oe.status==="COMPLETED"||Oe.status==="DONE"){T(100);const tt=Oe.resultUrl;r(!1),Ut(tt,s.config.ratio||"16:9");try{await _e.tasks.markPreviewNodeCreated(K)}catch{}Ze({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),Q(""),h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>T(0),1e3);return}else if(Oe.status==="FAILURE"){r(!1),T(0),Ze({taskId:"",isGenerating:!1}),h.error(Oe.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Oe.status==="PROCESSING"||Oe.status==="PENDING")&&(Me<600?setTimeout(Ge,1e3):(r(!1),T(0),Ze({taskId:"",isGenerating:!1}),h.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),T(0),Ze({taskId:"",isGenerating:!1}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ge()},qs=async()=>{var Me,Ge,qe,Oe,tt,bt;if(m(_)==="æ–‡ç”Ÿè§†é¢‘"&&!ue.trim()){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const ae=Ot();Ze({referenceImages:ae}),T(0);try{let yt=[],E;const H=ae.length;if(ae.length>0)try{for(const kt of ae){let It=kt.url;!It.startsWith("data:")&&!It.startsWith("http")&&(It=`${kr}${It}`),It=It.replace(/^https?:\/\/localhost(?::\d+)?/i,kr);const Ct=await ur(It);yt.push(Ct)}}catch{h.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Ne=Z.filter(kt=>kt.target===l);if(m(_)==="å‚è€ƒå›¾"){const kt=new Map;for(const It of Ne){const Ct=pe(It.source);if((Ct==null?void 0:Ct.type)==="assetSelector"){const Dt=(Me=Ct.data.config)==null?void 0:Me.subjects;if(Dt&&Dt.length>0){for(const qt of Dt)if(!kt.has(qt.name)){const Bt=(qt.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${kr}${rs}`);kt.set(qt.name,Bt)}}}}if(kt.size>0){const It=Array.from(kt.entries());let Ct=0;const Dt=[];for(const[qt,Bt]of It){if(Ct>=7)break;const rs=7-Ct,gs=Bt.slice(0,Math.max(0,rs));gs.length>0&&(Dt.push({name:qt,images:gs}),Ct+=gs.length)}E=Dt,It.some(([,qt])=>qt.length>0)&&Ct<It.reduce((qt,[,Bt])=>qt+Bt.length,0)&&h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const je=E&&E.length>0?E.reduce((kt,It)=>{var Ct;return kt+(((Ct=It.images)==null?void 0:Ct.length)||0)},0):H;let me=_;if(me==="é¦–å¸§"||me==="å°¾å¸§"){if(je!==1){h.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),T(0);return}}else if(me==="é¦–å°¾å¸§"){if(je===1)me="é¦–å¸§";else if(je!==2){h.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),T(0);return}E&&E.length>0?E=[{...E[0],images:E[0].images.slice(0,2)}]:yt=yt.slice(0,2)}else if(me==="å‚è€ƒå›¾"||me==="ä¸»ä½“å‚è€ƒ"){if(je<1){h.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),T(0);return}if(E&&E.length>0){if(E.reduce((It,Ct)=>{var Dt;return It+(((Dt=Ct.images)==null?void 0:Dt.length)||0)},0)>7){let It=7;E=E.map(Ct=>({...Ct,images:Ct.images.slice(0,Math.max(0,It-=Ct.images.length,Ct.images.length))})),It=7,E=E.map(Ct=>{const Dt=Ct.images.slice(0,Math.min(Ct.images.length,It));return It-=Dt.length,{...Ct,images:Dt}}).filter(Ct=>Ct.images.length>0),h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else yt.length>7&&(yt=yt.slice(0,7),h.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}j==="dropImages"&&(yt=[],E=void 0),(m(_)==="é¦–å¸§"||m(_)==="å°¾å¸§")&&j==="useFirstImage"&&yt.length>=2&&(yt=[yt[0]]),m(_)==="é¦–å°¾å¸§"&&j==="useFirstTwoImages"&&yt.length>=3&&(yt=yt.slice(0,2));const Ie={modelId:le,ratio:R,duration:P,referenceImages:yt.length>0&&!E?yt:void 0,generationType:me,sourceNodeId:l,...E?{subjects:E}:{}},nt=m(me);let Ye=ue.trim();if(Ye&&Ye.includes("@#")&&(Ye=await Ss(Ye)),!q&&Ye&&(Ye="No BGM. "+Ye),nt==="æ–‡ç”Ÿè§†é¢‘"){if(!Ye){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),T(0);return}Ie.prompt=Ye}else if(nt==="å‚è€ƒå›¾"){if(!Ye){h.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),T(0);return}Ie.prompt=Ye}else Ye&&(Ie.prompt=Ye);const Rt=await _e.tasks.createVideoTask(Ie),st=Rt.taskId,Be=Rt.creditsCharged||0,$t=Rt.isFreeUsage,Xt=Rt.freeUsageRemaining??0;if(Q(st),Ze({prompt:ue,ratio:R,resolution:O,generationType:_,duration:P,modelId:le,taskId:st,isGenerating:!0}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),$t)h.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Xt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),B();else if(Be>0){const{useAuthStore:kt}=await us(async()=>{const{useAuthStore:Ct}=await import("./index-CKw8I0iR.js").then(Dt=>Dt.f);return{useAuthStore:Ct}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:It}=kt.getState();await It(),h.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Be} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),B()}else h.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");js(st)}catch(yt){if(r(!1),T(0),((Ge=yt.response)==null?void 0:Ge.status)===403){const E=((Oe=(qe=yt.response)==null?void 0:qe.data)==null?void 0:Oe.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";h.error(E)}else{const E=((bt=(tt=yt.response)==null?void 0:tt.data)==null?void 0:bt.error)||yt.message||"æœªçŸ¥åŸå› ";h.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${E}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const K=m(_),ae=Ot(),Me=ae.length;if((()=>{var Oe;const qe=Z.filter(tt=>tt.target===l);for(const tt of qe){const bt=pe(tt.source);if((bt==null?void 0:bt.type)==="assetSelector"){const yt=(Oe=bt.data.config)==null?void 0:Oe.subjects;if(yt&&yt.length>0)return!0}}return!1})()&&(K==="é¦–å¸§"||K==="å°¾å¸§"||K==="é¦–å°¾å¸§")){h.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((K==="é¦–å¸§"||K==="å°¾å¸§")&&Me===0){h.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(K==="é¦–å°¾å¸§"&&Me===0){h.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(K==="å‚è€ƒå›¾"&&Me===0){h.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(K==="æ–‡ç”Ÿè§†é¢‘"&&Me>0&&!ge&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((K==="é¦–å¸§"||K==="å°¾å¸§")&&Me>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(K==="é¦–å°¾å¸§"&&Me>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(K==="æ–‡ç”Ÿè§†é¢‘"&&!ue.trim()){h.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!le){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}p(ae),Ze({referenceImages:ae}),r(!0),T(0),await qs()},Ut=(K,ae)=>{const Me=pe(l);if(!Me||!K)return null;const Ge=ae||R||"16:9",qe=Ae(),Oe=xe(),tt=qe.filter(Dt=>Dt.type==="videoPreview"&&Oe.some(qt=>qt.source===l&&qt.target===Dt.id)),bt=tt.find(Dt=>Dt.data.videoUrl===K);if(bt)return bt.id;const yt=1,E=400,H=(Dt,qt=300)=>{if(!Dt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Dt))return qt;const[Bt,rs]=Dt.split(":").map(gs=>parseFloat(gs));return!Bt||!rs?qt:Math.round(E*(rs/Bt))},Ne=document.querySelector(`.react-flow__node[data-id="${l}"]`),je=Ne==null?void 0:Ne.getBoundingClientRect(),me=Math.round(((je==null?void 0:je.width)||400)/yt),Ie=100,nt=200,Ye=H(Ge,300),Rt=tt.length,st=Me.position.x+me+nt,Be=Me.position.y,$t=st,Xt=Be+Rt*(Ye+Ie),kt=Date.now(),It={id:`preview-${l}-${kt}`,type:"videoPreview",position:{x:$t,y:Xt},data:{videoUrl:K,width:E,ratio:Ge,workflowContext:Me.data.workflowContext,createdBy:Me.data.createdBy}};oe(Dt=>[...Dt,It]);const Ct={id:`edge-${l}-${It.id}`,source:l,target:It.id,targetHandle:`${It.id}-target`,type:"aurora"};return ee(Dt=>Dt.find(Bt=>Bt.source===l&&Bt.target===It.id)?Dt:[...Dt,Ct]),It.id},er=K=>{const ae=K.target;if(ae.tagName==="INPUT"||ae.tagName==="TEXTAREA"||ae.tagName==="SELECT"||ae.tagName==="BUTTON"||ae.closest("button")||ae.closest("input")||ae.closest("textarea")||ae.closest("select"))return;const Me=!F;fe(Me),oe(Ge=>Ge.map(qe=>qe.id===l?{...qe,data:{...qe.data,isExpanded:Me}}:qe))};return e.jsxs("div",{onDoubleClick:er,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var E;const K=((E=pe(l))==null?void 0:E.type)||"",ae=m(_),Me=ae==="æ–‡ç”Ÿè§†é¢‘"||K==="aiVideo_t2v",Ge=K==="aiVideo_i2v_first"||K==="aiVideo_i2v_last"||ae==="é¦–å¸§"||ae==="å°¾å¸§",qe=K==="aiVideo_first_last"||ae==="é¦–å°¾å¸§",Oe=K==="aiVideo_reference"||ae==="å‚è€ƒå›¾",tt=Z.filter(H=>H.target===l),bt=tt.some(H=>{const Ne=pe(H.source);return(Ne==null?void 0:Ne.type)==="agent"}),yt=tt.reduce((H,Ne)=>{var Ie,nt,Ye,Rt;const je=pe(Ne.source),me=(je==null?void 0:je.type)||"";if(me==="aiImage"||me==="imagePreview")return H+1;if(me==="upload"){const st=(Ye=(nt=(Ie=je==null?void 0:je.data)==null?void 0:Ie.config)==null?void 0:nt.uploadedFiles)==null?void 0:Ye[0],Be=((st==null?void 0:st.type)||"").toUpperCase(),$t=((st==null?void 0:st.mimeType)||"").toLowerCase();return H+(Be==="IMAGE"||$t.startsWith("image/")?1:0)}if(me==="assetSelector"){const st=((Rt=je==null?void 0:je.data)==null?void 0:Rt.config)||{};if(st.selectedAsset)return H+((st.selectedAsset.type||"").toUpperCase()==="IMAGE"||(st.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(st.subjects&&st.subjects.length>0)return H+((st.subjects[0].images||[]).length||0)}return H},0);return Me?ge||!bt:Ge?!(bt&&yt>=1):qe?!(bt&&yt>=2):Oe?!(bt&&yt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:f}),N==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{w(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{w(!1),h.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{w(!1),await qs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(as,{value:le,onChange:K=>Gs(K),options:Nt.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Nt.map(K=>({value:K.id,label:K.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-neutral-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ee,value:ue,onChange:ms,onKeyDown:Is,onCompositionStart:()=>{de.current=!0},onCompositionEnd:K=>{de.current=!1,ms(K)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),U&&c.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:c.map((K,ae)=>e.jsxs("button",{type:"button",onMouseDown:Me=>{Me.preventDefault(),Me.stopPropagation(),Rs(K)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${ae===D?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[K.avatarUrl?e.jsx("img",{src:K.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:K.customName}),e.jsx("div",{className:"text-[10px] text-neutral-500 dark:text-neutral-400 font-mono truncate",children:K.characterName})]})]},K.id))})]})]}),y.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",_==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:y.map((K,ae)=>e.jsxs("div",{draggable:_==="é¦–å°¾å¸§",onDragStart:()=>vt(ae),onDragOver:ze,onDrop:()=>wt(ae),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${_==="é¦–å°¾å¸§"?"cursor-move":""} ${a===ae?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50`,children:[e.jsx("img",{src:`${K.url.startsWith("http")||K.url.startsWith("data:")?K.url:kr+K.url}`,alt:K.name,className:"w-full h-full object-cover"}),_==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:ae===0?"é¦–":ae===1?"å°¾":ae+1})]},K.id))})]}),d&&!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",se?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[P,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:$e,max:Te,step:"1",value:P,onChange:K=>{const ae=parseInt(K.target.value,10);C(ae),Ze({duration:ae})},disabled:se,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-neutral-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-neutral-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #525252 ${Re}%, #3b0764 ${Re}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),d&&dt&&(ge||(((Vs=d==null?void 0:d.config.supportedRatios)==null?void 0:Vs.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),ge?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const K="landscape",ae=P===15?15:10,Me=`sora-video-${K}-${ae}s`,Ge=we.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||we[0],qe=(Ge==null?void 0:Ge.id)||"";re(qe),$("16:9"),Ze({modelId:qe,ratio:"16:9",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Landscape ${ae}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${R==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const K="portrait",ae=P===15?15:10,Me=`sora-video-${K}-${ae}s`,Ge=we.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||we[0],qe=(Ge==null?void 0:Ge.id)||"";re(qe),$("9:16"),Ze({modelId:qe,ratio:"9:16",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Portrait ${ae}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${R==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(as,{value:R,onChange:K=>{$(K),Ze({ratio:K})},options:((d==null?void 0:d.config.supportedRatios)||[]).map(K=>{const[ae,Me]=K.split(":");return{value:K,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[K]||`${ae}:${Me}`}})})]}),d&&ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const K=R==="9:16"?"portrait":"landscape",ae=`sora-video-${K}-10s`,Me=we.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===ae})||we[0],Ge=(Me==null?void 0:Me.id)||"";C(10),re(Ge),Ze({duration:10,modelId:Ge,modelName:(Me==null?void 0:Me.name)||`Sora Video (${K==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${P===10?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const K=R==="9:16"?"portrait":"landscape",ae=`sora-video-${K}-15s`,Me=we.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===ae})||we[0],Ge=(Me==null?void 0:Me.id)||"";C(15),re(Ge),Ze({duration:15,modelId:Ge,modelName:(Me==null?void 0:Me.name)||`Sora Video (${K==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${P===15?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),d&&ge&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>x(!q),className:`nodrag relative w-10 h-5 rounded-full transition-all ${q?"bg-gradient-to-r from-neutral-800 to-neutral-700":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${q?"left-5":"left-0.5"}`})})]}),d&&!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ve?"(æœªé…ç½®)":""]}),e.jsx(as,{value:O,onChange:K=>{g(K),Ze({resolution:K})},options:ve.map(K=>({value:K,label:K})),className:Ve?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:W||!ks||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${W||!ks?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:W?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!b&&(J?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ce),"æ¬¡"]}):I!==null&&I>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[I,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:ue?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:ue})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(At,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},_o=t.memo(Ao),Fr="https://api.waule.ai",To=({data:s,selected:S,id:l})=>{var C,W;const[F,fe]=t.useState(!0),[T,he]=t.useState(s.config.customName||""),[Q,oe]=t.useState(!1),[ee,pe]=t.useState(0),[Ae,xe]=t.useState(s.config.taskId||""),[Z,te]=t.useState(null),{credits:Se,loading:ie}=Ns({nodeType:"sora_character"}),{setNodes:we,getNode:ue,setEdges:be}=Zt(),Ee=Js(),le=Os(),re=t.useCallback(r=>{var a;if(!r)return!1;const y=r.type||"",p=((a=r.data)==null?void 0:a.config)||{};if(y==="upload")return(p.uploadedFiles||p.files||[]).some(u=>(u.mimeType||u.type||"").toLowerCase().startsWith("video/"));if(y==="videoPreview")return!!p.url;if(y==="assetSelector"){const v=p.selectedAsset;return((v==null?void 0:v.mimeType)||"").toLowerCase().startsWith("video/")&&!!(v!=null&&v.url)}return y.startsWith("aiVideo")||y==="soraVideo"?!!p.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=Ee.filter(a=>a.target===l);if(r.length===0)return;const y=[],p=[];for(const a of r){const v=le.find(u=>u.id===a.source)||ue(a.source);re(v)?y.push(a.id):p.push(a.id)}y.length>1&&(p.push(...y.slice(1)),h.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),p.length>0&&(be(a=>a.filter(v=>!p.includes(v.id))),p.length>0&&y.length<=1&&r.some(v=>{const u=le.find(w=>w.id===v.source)||ue(v.source);return!re(u)})&&h.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ee,l,le,ue,be,re]);const R=t.useMemo(()=>Ee.filter(y=>y.target===l).map(y=>{var a;const p=le.find(v=>v.id===y.source);return(a=p==null?void 0:p.data)==null?void 0:a.config}),[Ee,l,le]),$=t.useMemo(()=>(s.models||[]).filter(y=>{var p;return y.type==="VIDEO_GENERATION"&&((p=y.provider)==null?void 0:p.toLowerCase())==="sora"}),[s.models]),O=((C=$.find(r=>{var y;return(y=r.modelId)==null?void 0:y.includes("landscape-10s")}))==null?void 0:C.id)||((W=$[0])==null?void 0:W.id)||"",g=t.useCallback(r=>{we(y=>y.map(p=>p.id===l?{...p,data:{...p.data,config:{...p.data.config,...r}}}:p))},[l,we]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!Q&&(te({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),he(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,Q]);const m=t.useMemo(()=>{var y;const r=Ee.filter(p=>p.target===l);for(const p of r){const a=le.find(w=>w.id===p.source)||ue(p.source);if(!a)continue;const v=a.type||"",u=((y=a.data)==null?void 0:y.config)||{};if(v==="upload"){const f=(u.uploadedFiles||u.files||[]).find(N=>(N.mimeType||N.type||"").toLowerCase().startsWith("video/"));if(f!=null&&f.url)return{url:f.url,thumbnail:f.thumbnail||f.url,name:f.name||f.originalName||"è§†é¢‘"}}if(v==="videoPreview"&&u.url)return{url:u.url,thumbnail:u.thumbnail||u.url,name:u.name||"è§†é¢‘"};if(v==="assetSelector"){const w=u.selectedAsset;if(((w==null?void 0:w.mimeType)||"").toLowerCase().startsWith("video/")&&(w!=null&&w.url))return{url:w.url,thumbnail:w.thumbnail||w.url,name:w.name||"è§†é¢‘"}}if((v.startsWith("aiVideo")||v==="soraVideo")&&u.generatedVideoUrl)return{url:u.generatedVideoUrl,thumbnail:u.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ee,l,le,R,ue]),_=!!m,z=async r=>{let p=0;const a=async()=>{try{p++;const u=(await _e.tasks.getTaskStatus(r)).task;if(pe(u.progress||0),u.status==="SUCCESS"||u.status==="COMPLETED"||u.status==="DONE"){oe(!1),pe(100);const w=u.metadata||{},f=w.characterName||"",N=w.avatarUrl||u.resultUrl||"";if(!f){h.error("æœªèƒ½è·å–è§’è‰²åç§°"),g({taskId:""}),xe("");return}try{const U=(await _e.soraCharacters.create({customName:T||f,characterName:f,avatarUrl:N,sourceVideoUrl:(m==null?void 0:m.url)||void 0})).character;te({id:U.id,customName:U.customName,characterName:U.characterName,avatarUrl:U.avatarUrl}),g({customName:U.customName,characterName:U.characterName,avatarUrl:U.avatarUrl,taskId:""}),h.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${U.customName}`)}catch(j){te({id:"",customName:T||f,characterName:f,avatarUrl:N}),h.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${j.message}`)}xe(""),setTimeout(()=>pe(0),1e3);return}else if(u.status==="FAILURE"){oe(!1),pe(0),g({taskId:""}),h.error(u.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(u.status==="PROCESSING"||u.status==="PENDING")&&(p<600?setTimeout(a,1e3):(oe(!1),pe(0),g({taskId:""}),h.error("åˆ›å»ºè¶…æ—¶")))}catch{oe(!1),pe(0),g({taskId:""}),h.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};a()},P=async()=>{var y,p,a,v,u;if(!m){h.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!T.trim()){h.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!O){h.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=m.url;if(!r){h.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const w=await _e.soraCharacters.getByCustomName(T.trim());if(w!=null&&w.character){h.error(`è‡ªå®šä¹‰åç§°"${T.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}oe(!0),pe(5),te(null);try{const w=await _e.tasks.createVideoTask({modelId:O,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:l,metadata:{isCharacterCreation:!0,customName:T.trim(),referenceType:"video",nodeType:"sora_character"}}),f=w.taskId,N=w.creditsCharged||0;if(xe(f),g({customName:T.trim(),taskId:f}),N>0)try{const{useAuthStore:j}=await us(async()=>{const{useAuthStore:k}=await import("./index-CKw8I0iR.js").then(c=>c.f);return{useAuthStore:k}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:U}=j.getState();await U(),h.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${N} ç§¯åˆ†ï¼‰`)}catch{h.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else h.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");z(f)}catch(w){if(oe(!1),pe(0),((y=w.response)==null?void 0:y.status)===403){const f=((a=(p=w.response)==null?void 0:p.data)==null?void 0:a.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";h.error(f)}else h.error(`æäº¤å¤±è´¥: ${((u=(v=w.response)==null?void 0:v.data)==null?void 0:u.error)||w.message}`)}};return t.useEffect(()=>{Ae&&!Q&&(oe(!0),z(Ae))},[]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl rounded-t-2xl",onClick:()=>fe(!F),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${F?"rotate-180":""}`,children:"expand_more"})]})]}),F&&e.jsxs("div",{className:"p-4 space-y-3",children:[m&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${m.url.startsWith("http")||m.url.startsWith("data:")?m.url:Fr+m.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:m.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:T,onChange:r=>he(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",disabled:Q})]}),Z&&!Q&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[Z.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("img",{src:Z.avatarUrl.startsWith("http")?Z.avatarUrl:`${Fr}${Z.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:Z.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:Z.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),Q&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[ee,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all duration-300",style:{width:`${ee}%`}})})]}),e.jsx("button",{onClick:P,disabled:Q||!_||!T.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${Q||!_||!T.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ie&&Se!==null&&Se>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[Se,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},Uo=t.memo(To),Ro=({data:s,id:S,selected:l})=>{const{setNodes:F,getNode:fe}=Zt(),[T,he]=t.useState(s.config.modelId||""),[Q,oe]=t.useState(s.config.voiceId||""),[ee,pe]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Ae,xe]=t.useState(s.config.status||""),[Z,te]=t.useState(!1),[Se,ie]=t.useState([]),[we]=t.useState(void 0),[ue]=t.useState("mp3"),[be]=t.useState(void 0),[Ee]=t.useState(void 0),[le]=t.useState(void 0),[re]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!T&&he(s.config.modelId)},[s.config.modelId,T]),t.useEffect(()=>{!Q&&s.config.voiceId&&oe(String(s.config.voiceId))},[s.config.voiceId,Q]),t.useEffect(()=>{if(!T){const m=(s.models||[]).filter(_=>_.type==="AUDIO_SYNTHESIS"&&_.isActive)[0];m&&(he(m.id),$({modelId:m.id}))}},[s.models,T]),t.useEffect(()=>{R()},[]);const R=async()=>{try{const g=await _e.get("/ai/audio/voices"),m=(g==null?void 0:g.data)??g;ie(Array.isArray(m)?m:[])}catch{}},$=g=>{fe(S)&&F(_=>_.map(z=>z.id===S?{...z,data:{...z.data,config:{...z.data.config,...g}}}:z))},O=async()=>{var z,P,C,W;const g=(Q||s.config.voiceId||"").trim(),m=(ee||"").trim();if(!g||!m){h.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let _=T;if(!_){const r=(s.models||[]).filter(y=>y.type==="AUDIO_SYNTHESIS"&&y.isActive);if(r[0])_=r[0].id,he(_),$({modelId:_});else{h.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}te(!0);try{if(Ae!=="OK"){let a=0,v=!1;for(;a<12;){a++;try{const u=await _e.ai.audio.queryVoice({voiceId:g,modelId:_}),w=((z=u.data)==null?void 0:z.status)||u.status;if(xe(w),$({status:w}),w==="OK"){v=!0;break}if(w==="UNDEPLOYED")break}catch{}await new Promise(u=>setTimeout(u,2500))}if(!v){h.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),te(!1);return}}const r=await _e.ai.audio.synthesize({modelId:_,voiceId:g,text:m,format:ue,sampleRate:we,volume:Ee,rate:be,pitch:le,output_format:re}),y=((P=r.data)==null?void 0:P.url)||r.url;try{const p=y&&y.startsWith("http")?y:`https://api.waule.ai${y}`;let a;p?a=await _e.assets.proxyDownload(p):a=await(await fetch(y,{mode:"cors"})).arrayBuffer();const v=URL.createObjectURL(new Blob([a],{type:ue==="wav"?"audio/wav":"audio/mpeg"}));$({outputUrl:v})}catch{$({outputUrl:y})}h.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const y=((W=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:W.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(y)?h.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(y)?h.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):h.error(y)}te(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:T,onChange:g=>{he(g),$({modelId:g})},options:(s.models||[]).filter(g=>g.type==="AUDIO_SYNTHESIS"&&g.isActive).map(g=>({value:g.id,label:g.name}))})]}),Se.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",Se.length,")"]}),e.jsx(as,{value:Q||"",onChange:g=>{oe(g),$({voiceId:g})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Se.map(g=>({value:g.voiceId,label:g.prefix||g.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:Q,onChange:g=>{const m=g.target.value;oe(m),$({voiceId:m})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:ee,onChange:g=>{pe(g.target.value),$({text:g.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:O,disabled:Z||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Z?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Z?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},$o=t.memo(Ro),Mo=({data:s,id:S,selected:l})=>{const{setNodes:F,setEdges:fe,getNode:T}=Zt(),[he,Q]=t.useState(s.config.modelId||""),[oe,ee]=t.useState(s.config.voiceId||""),[pe,Ae]=t.useState(s.config.voiceName||""),[xe,Z]=t.useState(s.config.cloneAudioUrl||""),[te,Se]=t.useState(s.config.promptAudioUrl||""),[ie,we]=t.useState(s.config.promptText||""),[ue,be]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ee,le]=t.useState(!1);t.useEffect(()=>{const _=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!oe||!oe.startsWith("Waule")&&!oe.startsWith("Aivider")||oe.startsWith("minimax-")){const z=_();ee(z),O({voiceId:z})}},[oe]);const re=Xs(_=>_.edges.filter(z=>z.target===S)),R=Os(),$=t.useRef("");t.useEffect(()=>{if(!he){const z=(s.models||[]).filter(P=>{if(P.type!=="AUDIO_SYNTHESIS"||!P.isActive)return!1;const C=String(P.provider||"").toLowerCase();return C.includes("minimaxi")||C.includes("hailuo")||C.includes("æµ·èº")})[0];z&&(Q(z.id),O({modelId:z.id}))}},[s.models,he]),t.useEffect(()=>{try{const _=re.map(C=>`${C.id}-${C.source}-${C.targetHandle||""}`).sort().join(",");if(_===$.current)return;$.current=_;let z="",P="";for(const C of re){const W=T(C.source);if(!W)continue;const r=W.data||{},y=String(W.type||"").toLowerCase(),a=(()=>{var v,u;if(y==="upload"){const w=(((v=r.config)==null?void 0:v.uploadedFiles)||[]).find(f=>{const N=((f==null?void 0:f.type)||"").toUpperCase(),j=((f==null?void 0:f.mimeType)||"").toLowerCase();return N==="AUDIO"||j.startsWith("audio/")});return w==null?void 0:w.url}if(y==="assetSelector"){const w=(u=r.config)==null?void 0:u.selectedAsset,f=((w==null?void 0:w.type)||"").toUpperCase(),N=((w==null?void 0:w.mimeType)||"").toLowerCase();if(f==="AUDIO"||N.startsWith("audio/"))return w==null?void 0:w.url}return null})();a&&(C.targetHandle===`${S}-target-clone`&&(z=a),C.targetHandle===`${S}-target-prompt`&&(P=a))}z!==xe&&(Z(z),O({cloneAudioUrl:z})),P!==te&&(Se(P),O({promptAudioUrl:P}))}catch{}},[re,R,T,S,xe,te]);const O=_=>{F(z=>z.map(P=>P.id===S?{...P,data:{...P.data,config:{...P.data.config,..._}}}:P))},g=async()=>{var _,z;if(!oe||!pe){h.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await _e.ai.audio.voices.add({voiceId:oe,prefix:pe}),h.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(P){const C=((z=(_=P==null?void 0:P.response)==null?void 0:_.data)==null?void 0:z.message)||(P==null?void 0:P.message)||"ä¿å­˜å¤±è´¥";h.error(C)}},m=async()=>{var _,z,P;if(!he||!pe||!xe){h.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}le(!0),h.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const W=(s.models||[]).find(w=>w.id===he),r=(W==null?void 0:W.modelId)||"speech-2.6-hd";let y=xe;y.startsWith("http");const p=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;ee(p),O({voiceId:p});const a=await _e.ai.audio.createVoice({modelId:he,targetModel:r,prefix:pe,url:y,promptUrl:te||void 0,promptText:ie||void 0,voiceId:p,previewText:ue||void 0}),v=(a==null?void 0:a.data)||a,u=v==null?void 0:v.sampleUrl;if(u){O({sampleUrl:u,status:"OK",voiceName:pe}),h.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const w=T(S);if(w){const f=`audioPreview-${Date.now()}`,N={id:f,type:"audioPreview",position:{x:w.position.x+450,y:w.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:u,config:{audioUrl:u,title:`${pe} - è¯•å¬`},models:s.models,createdBy:(_=w.data)==null?void 0:_.createdBy}};F(U=>[...U,N]);const j={id:`e-${S}-source-${f}-target`,source:S,sourceHandle:`${S}-source`,target:f,targetHandle:`${f}-target`,type:"aurora"};fe(U=>[...U,j])}}else O({status:"OK",voiceName:pe}),h.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(C){const W=((P=(z=C==null?void 0:C.response)==null?void 0:z.data)==null?void 0:P.message)||(C==null?void 0:C.message)||"åˆ›å»ºå¤±è´¥";h.error(W)}le(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:he,onChange:_=>{Q(_),O({modelId:_})},options:(s.models||[]).filter(_=>{if(_.type!=="AUDIO_SYNTHESIS"||!_.isActive)return!1;if(Array.isArray(_.capabilities))return _.capabilities.some(P=>P.capability==="éŸ³è‰²å…‹éš†"&&P.supported);const z=String(_.provider||"").toLowerCase();return z.includes("minimaxi")||z.includes("hailuo")||z.includes("æµ·èº")}).map(_=>({value:_.id,label:_.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:pe,onChange:_=>{Ae(_.target.value),O({voiceName:_.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:_=>_.stopPropagation()}),e.jsx("button",{onClick:g,disabled:!oe||!pe,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!oe||!pe?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:xe?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:xe?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:te?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:te?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ie,onChange:_=>{we(_.target.value),O({promptText:_.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:ue,onChange:_=>{be(_.target.value),O({previewText:_.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsx("button",{onClick:m,disabled:Ee||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ee||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ee?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Do=t.memo(Mo),zr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Po=({data:s,id:S,selected:l})=>{const{setNodes:F,getNode:fe,setEdges:T}=Zt(),[he,Q]=t.useState(s.config.modelId||""),[oe,ee]=t.useState(s.config.voiceId||""),[pe,Ae]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),xe=t.useRef(null),[Z,te]=t.useState("zh"),Se=t.useRef(null),ie=t.useRef(null),we=t.useRef(null),ue=t.useRef(null),be=t.useRef(null),[Ee,le]=t.useState([]),re=async()=>{try{const p=await _e.ai.audio.voices.list(),a=(p==null?void 0:p.data)??p;le(Array.isArray(a)?a:[])}catch{}},R=async()=>{try{const p=window.AudioContext||window.webkitAudioContext;ue.current||(ue.current=new p);const a=ue.current;a.state==="suspended"&&await a.resume()}catch{}},[$,O]=t.useState(!1),[g]=t.useState(""),[m]=t.useState(void 0),[_]=t.useState("mp3"),[z]=t.useState(void 0),[P]=t.useState(void 0),[C]=t.useState(void 0),[W]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!he&&Q(s.config.modelId)},[s.config.modelId,he]),t.useEffect(()=>{!oe&&s.config.voiceId&&ee(String(s.config.voiceId))},[s.config.voiceId,oe]),t.useEffect(()=>{if(!he){const a=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive)[0];a&&(Q(a.id),r({modelId:a.id}))}},[s.models,he]),t.useEffect(()=>{re()},[]),t.useEffect(()=>{Z==="custom"&&re()},[Z]),t.useEffect(()=>{const p=xe.current;p&&(p.style.height="auto",p.style.height=`${p.scrollHeight}px`)},[pe]);const r=p=>{fe(S)&&F(v=>v.map(u=>u.id===S?{...u,data:{...u.data,config:{...u.data.config,...p}}}:u))},y=async(p=!1)=>{var w,f,N,j,U;let a=(oe||s.config.voiceId||"").trim();if(p&&!a)if(Z==="custom"){const k=Ee[0];k&&(a=String(k.voiceId),ee(a),r({voiceId:a}))}else{const k=zr.find(c=>{const i=c.label;return Z==="zh"?i.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):Z==="yue"?i.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):Z==="en"?i.startsWith("è‹±æ–‡ "):Z==="ja"?i.startsWith("æ—¥æ–‡ "):Z==="ko"?i.startsWith("éŸ©æ–‡ "):!0});k&&(a=k.id,ee(a),r({voiceId:a}))}const v=p?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(pe||"").trim();if(!a||!v){h.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let u=he;if(!u){const k=(s.models||[]).filter(c=>c.type==="AUDIO_SYNTHESIS"&&c.isActive);if(k[0])u=k[0].id,Q(u),r({modelId:u});else{h.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}O(!0);try{p&&await R();const k={};if(g)try{k.voice_modify={emotion:g}}catch{}const c=await _e.ai.audio.synthesize({modelId:u,voiceId:a,text:v,format:_,sampleRate:m,volume:P,rate:z,pitch:C,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...k}),i=((w=c==null?void 0:c.data)==null?void 0:w.url)||(c==null?void 0:c.url),n=window.location.origin,M=(b=>{if(!b)return"";try{if(b.startsWith("http://localhost:3000")||b.startsWith("http://127.0.0.1:3000")){const J=new URL(b).pathname;return`${n}${J}`}return b.startsWith("http")?b:b.startsWith("/")?`${n}${b}`:`${n}/${b}`}catch{return b}})(i);let V;const D=b=>{if(b.length>=12){if(b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69)return"audio/wav";if(b[0]===73&&b[1]===68&&b[2]===51||b[0]===255&&(b[1]&224)===224)return"audio/mpeg"}return _==="wav"?"audio/wav":"audio/mpeg"},ne=b=>b.length>=12&&b[4]===102&&b[5]===116&&b[6]===121&&b[7]===112,de=b=>b.length>=4&&b[0]===79&&b[1]===103&&b[2]===103&&b[3]===83,q=b=>b.length>=4&&b[0]===102&&b[1]===76&&b[2]===97&&b[3]===67,x=new Uint8Array(V||new ArrayBuffer(0));let d=D(x);(!d||d==="application/octet-stream")&&(ne(x)?d="audio/mp4":de(x)?d="audio/ogg":q(x)&&(d="audio/flac"));let I;if(p){if(be.current){try{be.current.stop()}catch{}be.current.disconnect(),be.current=null}const b=ie.current||new Audio;b.preload="auto",b.autoplay=!0,b.playsInline=!0,b.crossOrigin="anonymous",ie.current=b;let J=!1;const ce=(B,ge,Ce=1500)=>new Promise(ve=>{let $e=!1;const Te=()=>{$e||($e=!0,Re(),ve(!0))},Ue=()=>{$e||($e=!0,Re(),ve(!1))},Re=()=>{B.removeEventListener(ge,Te),B.removeEventListener("error",Ue)};B.addEventListener(ge,Te),B.addEventListener("error",Ue),setTimeout(()=>{Ue()},Ce)});try{const B=ve=>{const $e=(ve||"").replace(/\s+/g,""),Te=new Uint8Array(Math.floor($e.length/2));for(let Ue=0;Ue<Te.length;Ue++)Te[Ue]=parseInt($e.substr(Ue*2,2),16);return Te},ge=((f=c==null?void 0:c.data)==null?void 0:f.hex)||(c==null?void 0:c.hex),Ce=ge?B(String(ge)).buffer:void 0;if(Ce&&Ce.byteLength>0){const ve=new Uint8Array(Ce),$e=D(ve),Te=new Blob([Ce],{type:$e}),Ue=URL.createObjectURL(Te);if(we.current)try{URL.revokeObjectURL(we.current)}catch{}if(we.current=Ue,b.src=Ue,b.load(),!await ce(b,"canplay"))throw new Error("blob not ready");await b.play(),J=!0}else throw new Error("no hex")}catch{J=!1}if(!J){try{const B=ve=>{const $e=(ve||"").replace(/\s+/g,""),Te=new Uint8Array(Math.floor($e.length/2));for(let Ue=0;Ue<Te.length;Ue++)Te[Ue]=parseInt($e.substr(Ue*2,2),16);return Te},ge=((N=c==null?void 0:c.data)==null?void 0:N.hex)||(c==null?void 0:c.hex),Ce=ge?B(String(ge)).buffer:void 0;if(!Ce||Ce.byteLength===0){const ve=await _e.assets.proxyDownload(M);if(!ve||ve.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const $e=new Uint8Array(ve),Te=D($e),Ue=new Blob([ve],{type:Te}),Re=URL.createObjectURL(Ue);if(we.current)try{URL.revokeObjectURL(we.current)}catch{}if(we.current=Re,b.src=Re,b.load(),!await ce(b,"canplay"))throw new Error("blob not ready");await b.play(),J=!0}else{const ve=new Uint8Array(Ce),$e=D(ve),Te=new Blob([Ce],{type:$e}),Ue=URL.createObjectURL(Te);if(we.current)try{URL.revokeObjectURL(we.current)}catch{}if(we.current=Ue,b.src=Ue,b.load(),!await ce(b,"canplay"))throw new Error("blob not ready");await b.play(),J=!0}}catch{}if(!J)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const b=await _e.assets.proxyDownload(M),J=new Uint8Array(b),ce=D(J);I=URL.createObjectURL(new Blob([b],{type:ce}))}catch{}if(!p&&I){if(Se.current)try{URL.revokeObjectURL(Se.current)}catch{}Se.current=I;const b=M||I;r({outputUrl:b});try{const J=fe(S);if(J){const B=document.querySelector(`.react-flow__node[data-id="${J.id}"]`),ge=Math.round((B==null?void 0:B.getBoundingClientRect().width)||420),Ce=J.position.x+ge+160,ve=`audio-preview-${Date.now()}`;F($e=>{var se;const Te=$e.filter(Ve=>{var Ze;return Ve.type==="audioPreview"&&((Ze=Ve.data)==null?void 0:Ze.sourceNodeId)===S}),Ue=J.position.y,Re=Te.length>0?Math.max(...Te.map(Ve=>{var Ze;return((Ze=Ve.position)==null?void 0:Ze.y)||Ue}))+120:Ue;return[...$e,{id:ve,type:"audioPreview",position:{x:Ce,y:Re},data:{audioUrl:b,sourceNodeId:S,createdBy:(se=J.data)==null?void 0:se.createdBy}}]}),T($e=>[...$e,{id:`${S}-${ve}`,source:S,target:ve}])}}catch{}}p&&ie.current&&!ie.current.paused?h.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!p&&I&&h.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(k){const c=((U=(j=k==null?void 0:k.response)==null?void 0:j.data)==null?void 0:U.message)||(k==null?void 0:k.message)||(p?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");h.error(c)}O(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:he,onChange:p=>{Q(p),r({modelId:p})},options:(s.models||[]).filter(p=>p.type==="AUDIO_SYNTHESIS"&&p.isActive).map(p=>({value:p.id,label:p.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(as,{value:Z,onChange:p=>{te(p),p==="custom"&&re()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(as,{value:oe,onChange:p=>{ee(p),r({voiceId:p})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Z==="custom"?Ee.map(p=>({value:p.voiceId,label:p.prefix||p.voiceId})):zr.filter(p=>{const a=p.label;return Z==="zh"?a.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):Z==="yue"?a.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):Z==="en"?a.startsWith("è‹±æ–‡ "):Z==="ja"?a.startsWith("æ—¥æ–‡ "):Z==="ko"?a.startsWith("éŸ©æ–‡ "):!0}).map(p=>({value:p.id,label:p.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>y(!0),disabled:$,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${$?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":""}`,style:$?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:xe,value:pe,onChange:p=>{Ae(p.target.value),r({text:p.target.value})},onMouseDown:p=>p.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>y(!1),disabled:$||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${$||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"border-transparent dark:border-white/10"}`,style:$||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:$?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Lo=t.memo(Po),Oo=t.memo(({id:s,sourceX:S,sourceY:l,targetX:F,targetY:fe,sourcePosition:T,targetPosition:he,selected:Q,markerEnd:oe})=>{const[ee]=ka({sourceX:S,sourceY:l,targetX:F,targetY:fe,sourcePosition:T,targetPosition:he});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#404040",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#525252",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:ee,fill:"none",stroke:Q?"#525252":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:oe}),e.jsx("path",{d:ee,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:oe}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:ee,calcMode:"linear"})}),e.jsx("path",{d:ee,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Go=({data:s,id:S})=>{const l=t.useRef(null),{getNode:F,setNodes:fe}=Zt(),[T,he]=t.useState(!1),[Q,oe]=t.useState([]),[ee,pe]=t.useState(""),[Ae,xe]=t.useState("ALL"),[Z,te]=t.useState(""),[Se,ie]=t.useState(!1),we=t.useMemo(()=>window.location.origin,[]),ue=t.useMemo(()=>{var $;const R=s.audioUrl||"";if(R.startsWith("blob:")){const O=s.sourceNodeId?F(s.sourceNodeId):null,g=(($=O==null?void 0:O.data)==null?void 0:$.outputUrl)||"";return g.startsWith("http")?g:g.startsWith("/")?`${we}${g}`:R}return R.startsWith("http")?`${we}/api/assets/proxy-stream?url=${encodeURIComponent(R)}`:R.startsWith("/")?`${we}${R}`:R},[s.audioUrl,s.sourceNodeId,we]);t.useEffect(()=>{const R=l.current;R&&(R.preload="auto",R.playsInline=!0,R.crossOrigin="anonymous",R.load())},[ue]),t.useEffect(()=>{T&&(be(),setTimeout(()=>{Ee()},100))},[T]);const be=async()=>{try{const R=Ae==="ALL"?void 0:{category:Ae},O=(await _e.assetLibraries.getAll(R)).data||[];oe(O);const g=Ae==="ALL"?O:O.filter(m=>(m.category||"OTHER")===Ae);if(g.length>0){const m=g.find(_=>_.id===ee);pe(m?m.id:g[0].id)}else pe("")}catch{h.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ee=()=>{const R=window.__workflowContext;if(!R||!R.project||!R.nodeGroups){h.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const $=Hs(S,R.nodeGroups);if(!$&&R.nodeGroups.length>0){const g=R.nodeGroups[0],m=Ts({project:R.project,episode:R.episode,nodeGroup:g,assetType:"audio"});m?(te(m),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${m}`)):h.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const O=Ts({project:R.project,episode:R.episode,nodeGroup:$,assetType:"audio"});O?(te(O),h.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${O}`)):h.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},le=async()=>{var R,$;if(!ee){h.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Z.trim()){h.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ie(!0),await _e.assetLibraries.addFromUrl(ee,s.audioUrl,Z.trim());const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const g=Hs(S,O.nodeGroups)||O.nodeGroups[0];g&&Ts({project:O.project,episode:O.episode,nodeGroup:g,nodeId:S,assetType:"audio",preview:!1})}h.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),he(!1),te("");try{fe(g=>g.map(m=>m.id===S?{...m,data:{...m.data,addedToLibrary:!0}}:m))}catch{}try{const g=new CustomEvent("asset-library-updated",{detail:{libraryId:ee}});window.dispatchEvent(g)}catch{}}catch(O){h.error((($=(R=O.response)==null?void 0:R.data)==null?void 0:$.message)||"æ·»åŠ å¤±è´¥")}finally{ie(!1)}},re=async()=>{var O;let R=`audio-${Date.now()}.mp3`;const $=window.__workflowContext;if($&&$.project&&$.nodeGroups){const g=Hs(S,$.nodeGroups)||$.nodeGroups[0];if(g){const m=Ts({project:$.project,episode:$.episode,nodeGroup:g,assetType:"audio",preview:!0});if(m&&(R=m,!R.includes("."))){const _=((O=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:O[0])||".mp3";R+=_}}}try{h.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const g=await fetch(s.audioUrl);if(!g.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${g.status}`);const m=await g.blob(),_=window.URL.createObjectURL(m),z=document.createElement("a");z.href=_,z.download=R,document.body.appendChild(z),z.click(),document.body.removeChild(z),setTimeout(()=>{window.URL.revokeObjectURL(_)},100),h.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${R}`)}catch(g){h.error(`ä¸‹è½½å¤±è´¥: ${g instanceof Error?g.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:l,controls:!0,src:ue,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{he(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:re,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),T&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>he(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Z,onChange:R=>te(R.target.value),onMouseDown:R=>R.stopPropagation(),onTouchStart:R=>R.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const R=Ae==="ALL"?Q:Q.filter($=>($.category||"OTHER")===Ae);return R.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Ae==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:ee,onChange:$=>pe($.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:R.map($=>e.jsxs("option",{value:$.id,children:[$.name," (",$._count.assets," ä¸ªèµ„äº§)"]},$.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(R=>e.jsx("button",{type:"button",onClick:()=>{xe(R);const $=Q.filter(O=>(O.category||"OTHER")===R);pe($.length>0?$[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Ae===R?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:R==="ROLE"?"person":R==="SCENE"?"landscape":R==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:R==="ROLE"?"è§’è‰²åº“":R==="SCENE"?"åœºæ™¯åº“":R==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},R))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>he(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:le,disabled:Se||Q.length===0||!Z.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:Se?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Vo=t.memo(Go),Wo=({data:s,id:S,selected:l})=>{const{setNodes:F,getNode:fe,setEdges:T}=Zt(),[he,Q]=t.useState(s.config.modelId||""),[oe,ee]=t.useState(s.config.prompt||""),[pe,Ae]=t.useState(s.config.previewText||""),[xe,Z]=t.useState(s.config.voiceId||""),[te,Se]=t.useState(!1),ie=t.useRef(null),we=t.useRef(null),ue=t.useRef(null),be=t.useRef(null),[Ee,le]=t.useState([]);t.useEffect(()=>{if(!he){const _=(s.models||[]).filter(z=>z.type==="AUDIO_SYNTHESIS"&&z.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(z.provider||"").toLowerCase())&&(Array.isArray(z.capabilities)?z.capabilities.some(P=>P.capability==="éŸ³è‰²è®¾è®¡"&&P.supported):!0))[0];_&&(Q(_.id),re({modelId:_.id}))}},[s.models,he]);const re=m=>{fe(S)&&F(z=>z.map(P=>P.id===S?{...P,data:{...P.data,config:{...P.data.config,...m}}}:P))};t.useEffect(()=>{(async()=>{try{const m=await _e.ai.audio.voices.list(),_=(m==null?void 0:m.data)??m;le(Array.isArray(_)?_:[])}catch{}})()},[]);const R=m=>{m&&(m.style.height="auto",m.style.height=`${m.scrollHeight}px`)};t.useEffect(()=>{R(we.current)},[oe]),t.useEffect(()=>{R(ue.current)},[pe]);const $=async m=>{if(!m)return!1;try{const _=(m||"").replace(/\s+/g,""),z=new Uint8Array(Math.floor(_.length/2));for(let y=0;y<z.length;y++)z[y]=parseInt(_.substr(y*2,2),16);const P=(()=>{const y=z;return y.length>=12&&y[0]===82&&y[1]===73&&y[2]===70&&y[3]===70&&y[8]===87&&y[9]===65&&y[10]===86&&y[11]===69?"audio/wav":(y.length>=3&&y[0]===73&&y[1]===68&&y[2]===51||y.length>=2&&y[0]===255&&(y[1]&224)===224,"audio/mpeg")})(),C=new Blob([z.buffer],{type:P}),W=URL.createObjectURL(C);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}be.current=W;const r=ie.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=W,ie.current=r,await r.play(),!0}catch{return!1}},O=async()=>{var _,z,P,C,W;if(!oe.trim()){h.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let m=he;if(!m){const r=(s.models||[]).filter(y=>y.type==="AUDIO_SYNTHESIS"&&y.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(y.provider||"").toLowerCase()));if(r[0])m=r[0].id,Q(m),re({modelId:m});else{h.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}Se(!0);try{const r=await _e.ai.audio.design({modelId:m,prompt:oe,preview_text:pe,voice_id:xe||void 0,aigc_watermark:!1}),y=((_=r==null?void 0:r.data)==null?void 0:_.voice_id)||(r==null?void 0:r.voice_id),p=((z=r==null?void 0:r.data)==null?void 0:z.trial_audio)||(r==null?void 0:r.trial_audio)||((P=r==null?void 0:r.data)==null?void 0:P.hex)||(r==null?void 0:r.hex);y&&(Z(String(y)),re({voiceId:String(y)})),p&&typeof p=="string"?(re({trialHex:p}),await $(p),h.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):h.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const a=fe(S);if(a){const u=document.querySelector(`.react-flow__node[data-id="${a.id}"]`),w=Math.round((u==null?void 0:u.getBoundingClientRect().width)||420),f=a.position.x+w+160,N=`audio-preview-${Date.now()}`;F(j=>{var U;return[...j,{id:N,type:"audioPreview",position:{x:f,y:a.position.y},data:{audioUrl:be.current||"",sourceNodeId:S,createdBy:(U=a.data)==null?void 0:U.createdBy}}]}),T(j=>[...j,{id:`${S}-${N}`,source:S,target:N}])}}catch{}}catch(r){const y=((W=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:W.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";h.error(y)}Se(!1)},g=async()=>{var _,z;const m=(xe||"").trim();if(!m){h.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ee.some(v=>String(v.voiceId)===String(m))){h.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const W=(s.models||[]).find(v=>v.id===he),r=(W==null?void 0:W.modelId)||"cosyvoice-v2",y=(oe||m).slice(0,40);await _e.ai.audio.voices.add({voiceId:m,prefix:y,targetModel:r,provider:String((W==null?void 0:W.provider)||"")});const p=await _e.ai.audio.voices.list(),a=(p==null?void 0:p.data)??p;le(Array.isArray(a)?a:[]),h.success("å·²ä¿å­˜éŸ³è‰²")}catch(P){const C=((z=(_=P==null?void 0:P.response)==null?void 0:_.data)==null?void 0:z.message)||(P==null?void 0:P.message)||"ä¿å­˜å¤±è´¥";h.error(C)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:he,onChange:m=>{Q(m),re({modelId:m})},options:(s.models||[]).filter(m=>m.type!=="AUDIO_SYNTHESIS"||!m.isActive?!1:Array.isArray(m.capabilities)?m.capabilities.some(_=>_.capability==="éŸ³è‰²è®¾è®¡"&&_.supported):["minimaxi","hailuo","æµ·èº"].includes(String(m.provider||"").toLowerCase())).map(m=>({value:m.id,label:m.name}))})]}),Ee.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(as,{value:xe||"",onChange:m=>{Z(m),re({voiceId:m})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ee.map(m=>({value:m.voiceId,label:m.prefix||m.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:xe,onChange:m=>{const _=m.target.value;Z(_),re({voiceId:_})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:we,value:oe,onChange:m=>{ee(m.target.value),re({prompt:m.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:ue,value:pe,onChange:m=>{Ae(m.target.value),re({previewText:m.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:O,disabled:te||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${te||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:te?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:g,disabled:te||!xe||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${te||!xe||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Fo=t.memo(Wo),zo=({data:s,id:S,selected:l})=>{const F=t.useRef(null),fe=t.useRef(null),T=t.useRef(null),{getNodes:he,getEdges:Q,setNodes:oe,setEdges:ee,getNode:pe,getViewport:Ae}=Zt(),xe=Js(),Z=Os(),[te,Se]=t.useState(null),[ie,we]=t.useState("#7c3aed"),[ue,be]=t.useState(100),Ee=t.useRef(!1),le=t.useRef(null),re=t.useRef(null),R=t.useRef(null),$=t.useRef(new Set),O=t.useRef(null),g=t.useRef(null),m=t.useRef(null),_=4096,z=s.width||800,P=s.width||800,C=_,W=_;return t.useEffect(()=>{var c,i,n,G;if(!F.current||fe.current)return;const r=document.createElement("canvas");r.width=C,r.height=W,F.current.appendChild(r);const y=new _a(r,{width:C,height:W,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),p=new Zs({left:0,top:0,width:C,height:W,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});y.add(p),y.sendObjectToBack(p),y.perPixelTargetFind=!0,y.targetFindTolerance=8;const a=z/C;y.setDimensions({width:z,height:P}),y.setZoom(a),r.style.width=`${z} px`,r.style.height=`${P} px`,fe.current=y,Bs.prototype.borderColor="#ff2d55",Bs.prototype.cornerColor="#ff2d55",Bs.prototype.cornerStrokeColor="#ff2d55",Bs.prototype.selectionBorderColor="#ff2d55",Bs.prototype.selectionColor="rgba(255,45,85,0.08)",Bs.prototype.transparentCorners=!1,Bs.prototype.cornerSize=12,Bs.prototype.selectionLineWidth=2,Bs.prototype.borderScaleFactor=2;const v=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;y.rotationCursor=v;const u=Bs.prototype.controls||{};u.tl&&(u.tl.cursorStyle="nwse-resize",u.tl.cornerStyle="square"),u.br&&(u.br.cursorStyle="nwse-resize",u.br.cornerStyle="square"),u.tr&&(u.tr.cursorStyle="nesw-resize",u.tr.cornerStyle="square"),u.bl&&(u.bl.cursorStyle="nesw-resize",u.bl.cornerStyle="square"),u.mtr&&(u.mtr.cursorStyle=v,u.mtr.cornerStyle="circle");const w=M=>{M&&(M.borderColor="#ff2d55",M.cornerColor="#ff2d55",M.cornerStrokeColor="#ff2d55",M.transparentCorners=!1,M.cornerSize=12,M.hasBorders=!0,M.hasControls=!0)},f=()=>{const M=y.getActiveObject();M&&(M.type==="activeSelection"&&Array.isArray(M._objects)&&M._objects.forEach(w),w(M),y.requestRenderAll())};y.on("selection:created",f),y.on("selection:updated",f),y.freeDrawingBrush=new Or(y);const N=()=>{const M=fe.current;if(!M)return;const V=M.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(V.objects)&&(V.objects=V.objects.map(q=>(q&&q.type==="image"&&q.originalUrl&&(q.src=q.originalUrl),q)));const D={canvasJson:V,appliedCrop:m.current},ne=JSON.stringify(D);try{localStorage.setItem(`superCanvas:${S}`,ne)}catch{}pe(S)&&oe(q=>q.map(x=>x.id===S?{...x,data:{...x.data,canvasState:ne}}:x))},j=()=>{g.current&&(clearTimeout(g.current),g.current=null),g.current=window.setTimeout(()=>{N()},300)};y.on("object:added",j),y.on("object:modified",j),y.on("object:removed",j),y.on("path:created",j);const U=((i=(c=pe(S))==null?void 0:c.data)==null?void 0:i.canvasState)||localStorage.getItem(`superCanvas:${S}`),k=(G=(n=pe(S))==null?void 0:n.data)==null?void 0:G.canvasJson;if(U||k)try{let M,V=null;if(U){const d=JSON.parse(U);d.canvasJson?(M=d.canvasJson,V=d.appliedCrop):M=d}else k&&(M=JSON.parse(k));const D=M,ne=d=>{var I,b,J,ce,B,ge,Ce,ve,$e;if(!d||typeof d!="object")return d;if(d.type==="image"){if(d.originalUrl)d.src=d.originalUrl;else if(d.sourceNodeId){const Te=pe(d.sourceNodeId),Ue=((I=Te==null?void 0:Te.data)==null?void 0:I.imageUrl)||((b=Te==null?void 0:Te.data)==null?void 0:b.url)||((J=Te==null?void 0:Te.data)==null?void 0:J.output)||((B=(ce=Te==null?void 0:Te.data)==null?void 0:ce.config)==null?void 0:B.generatedImageUrl)||(($e=(ve=(Ce=(ge=Te==null?void 0:Te.data)==null?void 0:ge.config)==null?void 0:Ce.uploadedFiles)==null?void 0:ve[0])==null?void 0:$e.url);Ue&&(d.originalUrl=Ue,d.src=Ue)}return typeof d.src=="string"&&d.src.startsWith("blob:")?null:d}return Array.isArray(d.objects)&&(d.objects=d.objects.map(ne).filter(Boolean),d.type==="group"&&d.objects.length===0)?null:d},de=d=>d&&(typeof(d==null?void 0:d.src)=="string"&&d.src.startsWith("blob:")?null:d.type==="image"?ne(d):d),q=d=>d&&(Array.isArray(d)?d.map(q).filter(Boolean):typeof d=="object"&&(d.type==="image"&&typeof d.src=="string"&&d.src.startsWith("blob:")||(Object.keys(d).forEach(I=>{const b=d[I];if(typeof b=="string"&&b.startsWith("blob:"))d[I]=void 0;else if(b&&typeof b=="object"){const J=q(b);J===null?delete d[I]:d[I]=J}}),Array.isArray(d.objects)&&(d.objects=d.objects.map(q).filter(Boolean),d.type==="group"&&d.objects.length===0)))?null:d);Array.isArray(D.objects)&&(D.objects=D.objects.map(ne).filter(Boolean)),D.backgroundImage&&(D.backgroundImage=de(D.backgroundImage)),D.overlayImage&&(D.overlayImage=de(D.overlayImage)),D.clipPath&&(D.clipPath=ne(D.clipPath));const x=q(D);y.loadFromJSON(x).then(()=>{const d=new Zs({left:0,top:0,width:C,height:W,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});y.add(d);const I=y.getObjects().find(b=>b.name==="__background__");if(I&&y.sendObjectToBack(I),V){m.current=V;const{left:b,top:J,width:ce,height:B}=V,ge=new Zs({left:b,top:J,width:ce,height:B,absolutePositioned:!0});y.clipPath=ge,I&&I.set({left:b,top:J,width:ce,height:B})}y.requestRenderAll()})}catch{}return F.current&&F.current.classList.add("nodrag"),()=>{y.dispose(),fe.current=null,F.current&&(F.current.innerHTML="")}},[S,C,W,z]),t.useEffect(()=>{te==="brush"?(ue<80||ue>400)&&be(100):(te==="pencil"||te==="line"||te==="arrow")&&(ue<10||ue>30)&&be(15)},[te,ue]),t.useEffect(()=>{const r=fe.current;if(!r)return;const y="https://api.waule.ai",p=xe.filter(u=>u.target===S&&u.targetHandle==="input-image");p.forEach(async u=>{var k,c;const w=Z.find(i=>i.id===u.source);if(!w||$.current.has(w.id))return;let f;const N=w.data;if(w.type==="upload"){const i=(k=N==null?void 0:N.config)==null?void 0:k.uploadedFiles;if(i&&i.length>0){const n=i[0];(n.type==="IMAGE"||(c=n.mimeType)!=null&&c.startsWith("image/"))&&(f=n.url)}}else w.type==="imagePreview"?f=N==null?void 0:N.imageUrl:f=(N==null?void 0:N.imageUrl)||(N==null?void 0:N.output)||(N==null?void 0:N.url);if(!f)return;let j=f;if(!f.startsWith("http")&&!f.startsWith("data:")&&(j=`${y}${f}`),j=j.replace(/^https?:\/\/localhost(?::\d+)?/i,y),r.getObjects().find(i=>i.sourceNodeId===w.id)){$.current.add(w.id);return}$.current.add(w.id);try{const i=await _e.assets.proxyDownload(j),n=new Uint8Array(i);let G="image/png";n.length>=4&&(n[0]===137&&n[1]===80&&n[2]===78&&n[3]===71?G="image/png":n[0]===255&&n[1]===216&&n[2]===255?G="image/jpeg":n[0]===71&&n[1]===73&&n[2]===70?G="image/gif":n[0]===82&&n[1]===73&&n[2]===70&&n[3]===70&&n.length>=12&&n[8]===87&&n[9]===69&&n[10]===66&&n[11]===80&&(G="image/webp"));const M=new Blob([i],{type:G}),V=URL.createObjectURL(M),D=await Ta.fromURL(V);if(!D){URL.revokeObjectURL(V);return}const ne=p.indexOf(u)*20;D.set({scaleX:1,scaleY:1,left:(C-D.width)/2+ne,top:(W-D.height)/2+ne,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:w.id,originalUrl:j,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),D.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(D);const de=r.getObjects().find(q=>q.name==="__background__");de?(r.sendObjectToBack(D),r.sendObjectToBack(de)):r.sendObjectToBack(D),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(V),1e3)}catch{}});const a=new Set(p.map(u=>{var w;return(w=Z.find(f=>f.id===u.source))==null?void 0:w.id}).filter(Boolean)),v=[];$.current.forEach(u=>{if(!a.has(u)){v.push(u);const w=r.getObjects().find(f=>f.sourceNodeId===u);w&&(r.remove(w),r.requestRenderAll())}}),v.forEach(u=>$.current.delete(u))},[xe,Z,S,C,W]),t.useEffect(()=>{const r=fe.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,te===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(v=>{v.name!=="__background__"&&v.name!=="__crop__"&&(v.selectable=!1,v.evented=!1)}),O.current&&(O.current.style.display="none"),m.current){const{left:v,top:u,width:w,height:f}=m.current,N=new Zs({left:v,top:u,width:w,height:f,absolutePositioned:!0});r.clipPath=N;const j=r.getObjects().find(U=>U.name==="__background__");j&&j.set({left:v,top:u,width:w,height:f})}return}const y=ie.startsWith("#")?`%23${ie.slice(1)}`:encodeURIComponent(ie),p=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${y}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(te==="pencil"||te==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Or(r);const v=(w,f)=>{const N=w.replace("#",""),j=parseInt(N.substring(0,2),16),U=parseInt(N.substring(2,4),16),k=parseInt(N.substring(4,6),16);return`rgba(${j},${U},${k},${f})`};if(r.freeDrawingBrush.color=v(ie,.7),r.freeDrawingBrush.width=ue,m.current){const{left:w,top:f,width:N,height:j}=m.current,U=new Zs({left:w,top:f,width:N,height:j,absolutePositioned:!0});r.clipPath=U;const k=r.getObjects().find(c=>c.name==="__background__");k&&k.set({left:w,top:f,width:N,height:j})}const u=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${y}' stroke-width='2.2'/></svg>") 16 16, crosshair`;te==="pencil"?(r.freeDrawingCursor=p,r.defaultCursor=p,r.hoverCursor=p,r.moveCursor=p,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=p)):(r.freeDrawingCursor=u,r.defaultCursor=u,r.hoverCursor=u,r.moveCursor=u,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=u)),r.selection=!1,r.getObjects().forEach(w=>{w.name!=="__background__"&&w.name!=="__crop__"&&(w.selectable=!0,w.evented=!0)}),te==="brush"&&O.current&&(O.current.style.display="block"),te==="pencil"&&O.current&&(O.current.style.display="none")}else if(te==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const v=r.getObjects().find(j=>j.name==="__background__");v&&v.set({left:0,top:0,width:C,height:W}),r.requestRenderAll();let u=R.current;const w=C*.1,f=C-w*2,N=W-w*2;if(!u||!r.getObjects().includes(u)){const j=m.current||{left:w,top:w,width:f,height:N};u=new Zs({left:j.left,top:j.top,width:j.width,height:j.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),R.current=u,r.add(u)}u&&(u.visible=!0,u.selectable=!0,u.evented=!0,r.setActiveObject(u),r.requestRenderAll())}else if(te==="line"||te==="arrow"||te==="text"||te==="eraser"){if(r.selection=!1,m.current){const{left:u,top:w,width:f,height:N}=m.current,j=new Zs({left:u,top:w,width:f,height:N,absolutePositioned:!0});r.clipPath=j;const U=r.getObjects().find(k=>k.name==="__background__");U&&U.set({left:u,top:w,width:f,height:N})}const v=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${y}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=te==="text"?"text":te==="eraser"?a:v,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),te==="line"||te==="arrow"?(r.hoverCursor=v,r.moveCursor=v,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(u=>{u.name!=="__background__"&&u.name!=="__crop__"&&(u.selectable=!1,u.evented=!1)}),O.current&&(O.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(u=>{u.name!=="__background__"&&u.name!=="__crop__"&&(u.selectable=!0,u.evented=!0)}),te==="eraser"&&O.current&&(O.current.style.display="none"),te==="eraser"&&(r.moveCursor=a,r.hoverCursor=a)),O.current&&(O.current.style.display="none")}else{if(R.current&&(R.current.visible=!1,r.discardActiveObject()),m.current){const{left:v,top:u,width:w,height:f}=m.current,N=new Zs({left:v,top:u,width:w,height:f,absolutePositioned:!0});r.clipPath=N;const j=r.getObjects().find(U=>U.name==="__background__");j&&j.set({left:v,top:u,width:w,height:f})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(v=>{v.name!=="__background__"&&v.name!=="__crop__"&&(v.selectable=!0,v.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),O.current&&(O.current.style.display="none")}},[te,ie,ue,C,W,z,P]),t.useEffect(()=>{const r=y=>{const p=fe.current;if(p){if(y.key==="Escape")Se("select");else if(y.key==="Enter"&&te==="crop"){const a=R.current;if(a){const v=Math.max(0,Math.floor(a.left??0)),u=Math.max(0,Math.floor(a.top??0)),w=Math.max(1,Math.floor((a.width??0)*(a.scaleX??1))),f=Math.max(1,Math.floor((a.height??0)*(a.scaleY??1)));m.current={left:v,top:u,width:w,height:f};const N=new Zs({left:v,top:u,width:w,height:f,absolutePositioned:!0});p.clipPath=N;const j=p.getObjects().find(k=>k.name==="__background__");j&&j.set({left:v,top:u,width:w,height:f}),a.visible=!1,Se("select"),p.requestRenderAll();const U=fe.current?()=>{const k=fe.current;if(!k)return;const c=k.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(c.objects)&&(c.objects=c.objects.map(M=>(M&&M.type==="image"&&M.originalUrl&&(M.src=M.originalUrl),M)));const i={canvasJson:c,appliedCrop:m.current},n=JSON.stringify(i);try{localStorage.setItem(`superCanvas:${S}`,n)}catch{}pe(S)&&oe(M=>M.map(V=>V.id===S?{...V,data:{...V.data,canvasState:n}}:V))}:null;U&&U()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[te]),t.useEffect(()=>{const r=fe.current;if(!r)return;const y=f=>{const N=r.getPointer(f.e);if(Ee.current=!0,le.current={x:N.x,y:N.y},(te==="line"||te==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(j=>{j.name!=="__background__"&&j.name!=="__crop__"&&(j.selectable=!1,j.evented=!1)})),te==="line"){const j=[N.x,N.y,N.x,N.y],U=new or(j,{strokeWidth:ue/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round"});re.current=U,r.add(U)}else if(te==="arrow"){const j=[N.x,N.y,N.x,N.y],U=new or(j,{strokeWidth:ue/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});re.current=U,r.add(U)}else if(te==="text"){const j=new Gr("Type here",{left:N.x,top:N.y,fontFamily:"Arial",fill:ie,fontSize:ue*10,width:300,splitByGrapheme:!0});j.lockScalingY=!1,j.lockScalingFlip=!0,j.lockUniScaling=!1,j.setControlsVisibility({mt:!1,mb:!1}),r.add(j),r.setActiveObject(j),j.enterEditing(),Se("select")}else if(te==="eraser"){const j=r.getObjects();for(let U=j.length-1;U>=0;U--){const k=j[U];if(!(k.name==="__background__"||k.name==="__crop__"||k.name==="__input_image__"||k.sourceNodeId)&&k.containsPoint(N)){r.remove(k);break}}r.requestRenderAll()}},p=f=>{const N=r.getPointer(f.e);if(te==="brush"&&O.current){const U=r.getZoom(),k=ue*U,c=k/2;O.current.style.width=`${k}px`,O.current.style.height=`${k}px`,O.current.style.left=`${N.x*U-c}px`,O.current.style.top=`${N.y*U-c}px`,O.current.style.borderColor=`rgba(${parseInt(ie.slice(1,3),16)},${parseInt(ie.slice(3,5),16)},${parseInt(ie.slice(5,7),16)},0.7)`,O.current.style.borderWidth="1px",O.current.style.background="transparent"}if(!Ee.current)return;const j=re.current;if(te==="line"&&j&&j instanceof or)j.set({x2:N.x,y2:N.y}),j.setCoords(),r.requestRenderAll();else if(te==="arrow"&&j&&j instanceof or)j.set({x2:N.x,y2:N.y}),j.setCoords(),r.requestRenderAll();else if(te==="eraser"){const U=r.getObjects();for(let k=U.length-1;k>=0;k--){const c=U[k];c.name==="__background__"||c.name==="__crop__"||c.name==="__input_image__"||c.sourceNodeId||c.containsPoint(N)&&r.remove(c)}r.requestRenderAll()}},a=()=>{if(Ee.current=!1,te==="arrow"&&re.current instanceof or){const f=re.current,N=Math.atan2(f.y2-f.y1,f.x2-f.x1),j=Math.max(ue*10,120),U=Math.PI/6,k=-Math.cos(N),c=-Math.sin(N),i=Math.cos(U),n=Math.sin(U),G=f.x2+j*(k*i-c*n),M=f.y2+j*(k*n+c*i),V=f.x2+j*(k*i+c*n),D=f.y2+j*(-k*n+c*i),ne=f.strokeWidth||ue/2,de=new or([f.x2,f.y2,G,M],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"}),q=new or([f.x2,f.y2,V,D],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"});r.add(de),r.add(q);const x=new Ua([f,de,q],{selectable:!0,evented:!0});r.remove(f),r.remove(de),r.remove(q),r.add(x)}re.current=null,(te==="line"||te==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(f=>{f.name!=="__background__"&&f.name!=="__crop__"&&(f.selectable=!1,f.evented=!1)}))},v=f=>{var k;const N=f.target;if(!N)return;const j=N.type==="textbox"||N instanceof Gr,U=N.type==="i-text"||N instanceof Ra;if(j||U){const c=(k=f==null?void 0:f.transform)==null?void 0:k.corner;if(c==="ml"||c==="mr"){const i=Math.max(50,(N.width||50)*(N.scaleX||1));N.set({width:i,scaleX:1,scaleY:1})}else{const i=N.scaleX||1,n=N.fontSize||40,G=Math.max(6,Math.min(512,Math.round(n*i)));N.set({fontSize:G,scaleX:1,scaleY:1})}N.setCoords(),r.requestRenderAll()}},u=()=>{te==="brush"&&O.current&&(O.current.style.display="block")},w=()=>{O.current&&(O.current.style.display="none")};return r.on("mouse:down",y),r.on("mouse:move",p),r.on("mouse:up",a),r.on("mouse:over",u),r.on("mouse:out",w),r.on("object:scaling",v),()=>{r.off("mouse:down",y),r.off("mouse:move",p),r.off("mouse:up",a),r.off("mouse:over",u),r.off("mouse:out",w),r.off("object:scaling",v)}},[te,ie,ue]),e.jsxs("div",{ref:T,className:`relative flex flex-col w-[800px] h-auto bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cr,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:F,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:O,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Cr,label:"Select"},{id:"pencil",icon:Xr,label:"Pencil"},{id:"brush",icon:Ma,label:"Brush"},{id:"line",icon:Ga,label:"Line"},{id:"arrow",icon:$a,label:"Arrow"},{id:"text",icon:Fa,label:"Text"},{id:"eraser",icon:La,label:"Eraser"},{id:"crop",icon:Pa,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>Se(r.id),className:`p-2 rounded-lg transition-all ${te===r.id?"bg-neutral-500/20 text-neutral-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=fe.current,y=r==null?void 0:r.getActiveObject();y&&(r==null||r.remove(y),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(Hr,{size:16})}),e.jsx("button",{onClick:()=>{const r=fe.current,y=r==null?void 0:r.getActiveObject();y&&(r==null||r.bringObjectToFront(y),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Wa,{size:16})}),e.jsx("button",{onClick:()=>{const r=fe.current,y=r==null?void 0:r.getActiveObject();if(y){r==null||r.sendObjectToBack(y);const p=r==null?void 0:r.getObjects().find(a=>a.name==="__background__");p&&(r==null||r.sendObjectToBack(p)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Va,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ie,onChange:r=>we(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:te==="brush"?80:10,max:te==="brush"?400:30,value:ue,onChange:r=>{const y=parseInt(r.target.value);be(y)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:ue})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:te==="crop",onClick:async()=>{var ge,Ce,ve;const r=fe.current;if(!r)return;r.discardActiveObject();const y=[...r.viewportTransform],p=r.getWidth(),a=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(_),r.setHeight(_);const v=r.clipPath;r.clipPath=void 0;const u=m.current;let w="",f=C,N=W;u?(f=u.width,N=u.height,w=r.toDataURL({format:"png",quality:1,left:u.left,top:u.top,width:u.width,height:u.height,multiplier:1})):w=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:C,height:W}),r.clipPath=v,r.setViewportTransform(y),r.setWidth(p),r.setHeight(a),r.requestRenderAll();const j=`${f}:${N}`,U=pe(S);if(!U)return;let k=w;try{const $e=w.split(",")[1],Te=atob($e),Ue=new Array(Te.length);for(let zt=0;zt<Te.length;zt++)Ue[zt]=Te.charCodeAt(zt);const Re=new Uint8Array(Ue),se=new Blob([Re],{type:"image/png"}),Ve=`canvas-export-${Date.now()}.png`,Ze=await _e.post("/assets/presigned-url",{fileName:Ve,contentType:"image/png"});if(Ze.success&&Ze.data){const{uploadUrl:zt,publicUrl:Ot}=Ze.data;await(await us(async()=>{const{default:dt}=await import("./utils-BcyDR7Vi.js");return{default:dt}},[])).default.put(zt,se,{headers:{"Content-Type":"image/png"},timeout:3e5}),k=Ot}}catch{}const c=Ae&&((ge=Ae())==null?void 0:ge.zoom)||1,i=document.querySelector(`.react-flow__node[data-id="${S}"]`),n=(i==null?void 0:i.getBoundingClientRect().width)||400,G=Math.round(n/c),M=400,V=($e,Te=300)=>{if(!$e||!/^[0-9]+\s*:\s*[0-9]+$/.test($e))return Te;const[Ue,Re]=$e.split(":").map(se=>parseFloat(se));return!Ue||!Re?Te:Math.round(M*(Re/Ue))},D=200,ne=100,de=V(j,300),q=he(),x=Q(),I=q.filter($e=>$e.type==="imagePreview"&&x.some(Te=>Te.source===S&&Te.target===$e.id)).length,b=U.position.x+G+D,J=U.position.y+I*(de+ne),ce={id:`preview-${S}-${Date.now()}`,type:"imagePreview",position:{x:b,y:J},data:{imageUrl:k,width:M,ratio:j,workflowContext:(Ce=U.data)==null?void 0:Ce.workflowContext,createdBy:(ve=U.data)==null?void 0:ve.createdBy}};oe($e=>[...$e,ce]);const B={id:`edge-${S}-${ce.id}`,source:S,target:ce.id,targetHandle:`${ce.id}-target`,type:"aurora"};ee($e=>$e.find(Ue=>Ue.source===S&&Ue.target===ce.id)?$e:[...$e,B])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:cursor-not-allowed disabled:hover:shadow-md",title:te==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(At,{type:"target",position:gt.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(At,{type:"source",position:gt.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Bo=t.memo(zo),Ho=({data:s,selected:S,id:l})=>{const[F,fe]=t.useState(s.config.upscaleResolution||"1080p"),[T,he]=t.useState(!1),[Q,oe]=t.useState(s.config.inputVideoUrl||""),[,ee]=t.useState(s.config.taskId||""),{setNodes:pe,setEdges:Ae}=Zt(),xe=Os(),Z=Js(),te=ue=>{pe(be=>be.map(Ee=>Ee.id===l?{...Ee,data:{...Ee.data,config:{...Ee.data.config,...ue}}}:Ee))};t.useEffect(()=>{var be,Ee,le;const ue=Z.filter(re=>re.target===l);if(ue.length>0){const re=xe.find(R=>R.id===ue[0].source);if(re){const R=re.data,$=R.videoUrl||((be=R.config)==null?void 0:be.videoUrl)||((Ee=R.config)==null?void 0:Ee.outputVideoUrl)||((le=R.config)==null?void 0:le.resultUrl);$&&$!==Q&&(oe($),te({inputVideoUrl:$}))}}else Q&&(oe(""),te({inputVideoUrl:""}))},[Z,xe,l]),t.useEffect(()=>{const ue=s.config.taskId;(async()=>{if(ue)try{const le=(await _e.get(`/tasks/${ue}`)).task;if(le.status==="SUCCESS"){const re=le.resultUrl;te({outputVideoUrl:re,taskId:""}),Z.filter(g=>g.source===l).map(g=>xe.find(m=>m.id===g.target)).filter(g=>g&&g.type==="videoPreview").find(g=>g.data.videoUrl===re)||ie(re),Wt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),he(!1)}else le.status==="PROCESSING"||le.status==="PENDING"?(he(!0),Se(ue)):le.status==="FAILURE"&&(he(!1),te({taskId:""}),Wt.error(le.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${le.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{he(!1),te({taskId:""}),Wt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const Se=async ue=>{let Ee=0;const le=async()=>{try{Ee++;const R=(await _e.get(`/tasks/${ue}`)).task;if(R.status==="SUCCESS"){const $=R.resultUrl;he(!1),te({outputVideoUrl:$,taskId:""}),ie($),Wt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(R.status==="FAILURE"){he(!1),te({taskId:""}),Wt.error(R.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(R.status==="PROCESSING"||R.status==="PENDING")&&(Ee<300?setTimeout(le,3e3):(he(!1),te({taskId:""}),Wt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{he(!1),te({taskId:""}),Wt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};le()},ie=ue=>{var Ee;const be=xe.find(le=>le.id===l);if(be){const le=`preview-video-${Date.now()}`,re=F==="1080p"?"HD":F,R={id:le,type:"videoPreview",position:{x:be.position.x+400,y:be.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:ue,ratio:"16:9",resolution:re,createdBy:(Ee=be.data)==null?void 0:Ee.createdBy}},$={id:`edge-${l}-${le}`,source:l,target:le,type:"aurora"};pe(O=>[...O,R]),setTimeout(()=>{Ae(O=>[...O,$])},100)}},we=async()=>{var ue,be;if(!Q){Wt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}he(!0);try{const Ee=await _e.get("/ai/models?provider=vidu&isActive=true");if(!Ee||Ee.length===0){Wt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),he(!1);return}const le=Ee[0],R=(await _e.post("/ai/video-upscale",{video_url:Q,upscale_resolution:F,apiKey:le.apiKey,apiUrl:le.apiUrl})).taskId;ee(R),te({taskId:R,upscaleResolution:F}),Wt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),Se(R)}catch(Ee){const le=((be=(ue=Ee.response)==null?void 0:ue.data)==null?void 0:be.error)||Ee.message||"æœªçŸ¥åŸå› ";Wt.error(`å¯åŠ¨å¤±è´¥ï¼š${le}ï¼Œè¯·ç¨åé‡è¯•`),he(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{type:"target",position:gt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[Q&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:Q,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(ue=>e.jsx("button",{type:"button",onClick:()=>{fe(ue),te({upscaleResolution:ue})},disabled:T,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${F===ue?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${T?"cursor-not-allowed":""}`,children:ue},ue))})]}),e.jsx("button",{type:"button",onClick:ue=>{ue.preventDefault(),ue.stopPropagation(),we()},onMouseDown:ue=>{ue.stopPropagation()},disabled:T||!Q||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${T||!Q||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[T?e.jsx(Ls,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:T?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(hs,{type:"source",position:gt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Xo=t.memo(Ho),Jo=({data:s,selected:S,id:l})=>{const[F,fe]=t.useState(s.config.prompt||""),[T,he]=t.useState(s.config.duration||30),[Q,oe]=t.useState(s.config.ratio||"16:9"),[ee,pe]=t.useState(s.config.language||"zh"),[Ae,xe]=t.useState(!1),[Z,te]=t.useState(s.config.images||[]),[,Se]=t.useState(s.config.taskId||""),{credits:ie,loading:we}=Ns({nodeType:"ad_composition",duration:T}),{setNodes:ue,setEdges:be}=Zt(),Ee=Os(),le=Js(),re=g=>{ue(m=>m.map(_=>_.id===l?{..._,data:{..._.data,config:{..._.data.config,...g}}}:_))};t.useEffect(()=>{const g=le.filter(_=>_.target===l),m=[];g.forEach(_=>{var P,C,W,r,y,p,a,v,u,w;const z=Ee.find(f=>f.id===_.source);z&&(z.type==="imagePreview"&&((P=z.data)!=null&&P.imageUrl)?m.push(z.data.imageUrl):z.type==="aiImage"&&((W=(C=z.data)==null?void 0:C.config)!=null&&W.generatedImageUrl)?m.push(z.data.config.generatedImageUrl):z.type==="upload"&&((y=(r=z.data)==null?void 0:r.config)!=null&&y.uploadedFiles)?z.data.config.uploadedFiles.filter(N=>N.type==="IMAGE"||(N.mimeType||"").startsWith("image/")).forEach(N=>m.push(N.url)):z.type==="assetSelector"&&((a=(p=z.data)==null?void 0:p.config)!=null&&a.subjects?z.data.config.subjects.forEach(N=>{Array.isArray(N.images)&&N.images.forEach(j=>m.push(j.url))}):((w=(u=(v=z.data)==null?void 0:v.config)==null?void 0:u.selectedAsset)==null?void 0:w.type)==="IMAGE"&&m.push(z.data.config.selectedAsset.url)))}),JSON.stringify(m)!==JSON.stringify(Z)&&(te(m),re({images:m}))},[le,Ee,l]),t.useEffect(()=>{const g=s.config.taskId;(async()=>{if(g)try{const z=(await _e.get(`/tasks/${g}`)).task;if(z.status==="SUCCESS"){const P=z.resultUrl;re({taskId:""}),xe(!1)}else z.status==="PROCESSING"||z.status==="PENDING"?(xe(!0),R(g)):z.status==="FAILURE"&&(xe(!1),re({taskId:""}),Wt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${z.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{xe(!1),re({taskId:""})}})()},[]);const R=async g=>{let _=0;const z=async()=>{try{_++;const C=(await _e.get(`/tasks/${g}`)).task;if(C.status==="SUCCESS"){const W=C.resultUrl;xe(!1),re({taskId:""}),$(W),Wt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(C.status==="FAILURE"){xe(!1),re({taskId:""}),Wt.error(C.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(C.status==="PROCESSING"||C.status==="PENDING")&&(_<120?setTimeout(z,1e4):(xe(!1),re({taskId:""}),Wt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{xe(!1),re({taskId:""}),Wt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};z()},$=g=>{var _;const m=Ee.find(z=>z.id===l);if(m){const z=`preview-video-${Date.now()}`,P={id:z,type:"videoPreview",position:{x:m.position.x+400,y:m.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:g,ratio:Q,width:320,createdBy:(_=m.data)==null?void 0:_.createdBy}},C={id:`edge-${l}-${z}`,source:l,target:z,type:"aurora"};ue(W=>[...W,P]),setTimeout(()=>{be(W=>[...W,C])},100)}},O=async()=>{var g,m,_,z,P;if(Z.length===0){Wt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(Z.length>15){Wt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!F.trim()){Wt.error("è¯·è¾“å…¥æç¤ºè¯");return}xe(!0);try{const C=await _e.get("/ai/models?provider=vidu&isActive=true");if(!C||C.length===0){Wt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),xe(!1);return}const W=C[0],r={images:Z,prompt:F,duration:T,ratio:Q,language:ee,apiKey:W.apiKey,apiUrl:W.apiUrl},y=await _e.post("/ai/commercial-video",r),p=y.taskId,a=y.creditsCharged||0;if(Se(p),re({taskId:p,images:Z,prompt:F,duration:T,ratio:Q,language:ee}),a>0)try{const{useAuthStore:v}=await us(async()=>{const{useAuthStore:w}=await import("./index-CKw8I0iR.js").then(f=>f.f);return{useAuthStore:w}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:u}=v.getState();await u(),Wt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${a} ç§¯åˆ†ï¼‰`)}catch{Wt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Wt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");R(p)}catch(C){((g=C.response)==null?void 0:g.status)===403?Wt.error(((_=(m=C.response)==null?void 0:m.data)==null?void 0:_.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Wt.error(((P=(z=C.response)==null?void 0:z.data)==null?void 0:P.error)||C.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),xe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{type:"target",position:gt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",Z.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:F,onChange:g=>{fe(g.target.value),re({prompt:g.target.value}),g.target.style.height="auto",g.target.style.height=g.target.scrollHeight+"px"},onFocus:g=>{g.target.style.height="auto",g.target.style.height=g.target.scrollHeight+"px"},ref:g=>{g&&F&&(g.style.height="auto",g.style.height=g.scrollHeight+"px")},disabled:Ae,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(g=>e.jsxs("button",{type:"button",onClick:()=>{he(g),re({duration:g})},disabled:Ae,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${T===g?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ae?"cursor-not-allowed":""}`,children:[g,"s"]},g))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(g=>e.jsx("button",{type:"button",onClick:()=>{oe(g),re({ratio:g})},disabled:Ae,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Q===g?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ae?"cursor-not-allowed":""}`,children:g},g))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(g=>e.jsx("button",{type:"button",onClick:()=>{pe(g.value),re({language:g.value})},disabled:Ae,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${ee===g.value?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ae?"cursor-not-allowed":""}`,children:g.label},g.value))})]}),e.jsx("button",{type:"button",onClick:O,disabled:Ae||Z.length===0||!F.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Ae||Z.length===0||!F.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Ae?e.jsx(Ls,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),e.jsx("span",{children:Ae?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Ae&&!we&&ie!==null&&ie>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ie,"ç§¯åˆ†"]})]})})]}),e.jsx(hs,{type:"source",position:gt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},qo=t.memo(Jo),Ko=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],Yo=({data:s,selected:S,id:l})=>{const{setNodes:F}=Zt(),[fe,T]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[he,Q]=t.useState(!1),[oe,ee]=t.useState(!1),[pe,Ae]=t.useState(s.fontSize||36),[xe,Z]=t.useState(s.width||200),[te,Se]=t.useState(s.bold||!1),ie=t.useRef(null),we=t.useRef(null),ue=t.useCallback(le=>{F(re=>re.map(R=>R.id===l?{...R,data:{...R.data,...le}}:R))},[l,F]);t.useEffect(()=>{const le=setTimeout(()=>{fe!==s.text&&ue({text:fe})},300);return()=>clearTimeout(le)},[fe,s.text,ue]),t.useEffect(()=>{ue({fontSize:pe,width:xe,bold:te})},[pe,xe,te,ue]);const be=()=>{Q(!0),setTimeout(()=>{ie.current&&(ie.current.focus(),ie.current.select(),ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},0)},Ee=()=>{Q(!1)};return t.useEffect(()=>{he&&ie.current&&(ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},[he,fe]),t.useEffect(()=>{const le=re=>{we.current&&!we.current.contains(re.target)&&ee(!1)};return oe&&document.addEventListener("mousedown",le),()=>document.removeEventListener("mousedown",le)},[oe]),e.jsxs("div",{className:`relative group ${S?"ring-2 ring-neutral-400 ring-offset-2":""}`,style:{width:xe},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:le=>{le.stopPropagation(),ee(!oe)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),oe&&e.jsxs("div",{ref:we,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:le=>le.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:pe,onChange:le=>Ae(Number(le.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-neutral-400",children:Ko.map(le=>e.jsxs("option",{value:le,children:[le,"px"]},le))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>Se(!te),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${te?"bg-neutral-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),he?e.jsx("textarea",{ref:ie,value:fe,onChange:le=>T(le.target.value),onBlur:Ee,onMouseDown:le=>le.stopPropagation(),onKeyDown:le=>{le.key==="Escape"&&Q(!1)},className:"nodrag w-full bg-transparent border-2 border-neutral-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${pe}px`,fontWeight:te?"bold":"normal"}}):e.jsx("div",{onDoubleClick:be,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${pe}px`,fontWeight:te?"bold":"normal"},children:fe}),!he&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:le=>{le.stopPropagation(),le.preventDefault();const re=le.clientX,R=xe,$=g=>{g.preventDefault();const m=Math.max(100,R+(g.clientX-re));Z(m)},O=()=>{document.removeEventListener("mousemove",$),document.removeEventListener("mouseup",O)};document.addEventListener("mousemove",$),document.addEventListener("mouseup",O)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Qo=t.memo(Yo),Zo=({data:s,id:S,selected:l})=>{const{getNode:F,setNodes:fe,setEdges:T}=Zt(),he=Xs(t.useCallback(i=>i.edges.filter(n=>n.target===S),[S])),[Q,oe]=t.useState(s.prompt||""),[ee,pe]=t.useState(s.points||[]),[Ae,xe]=t.useState(!1),[Z,te]=t.useState(!1),[Se,ie]=t.useState(null),[we,ue]=t.useState([]),[,be]=t.useState(s.generatedImageUrl||null),[Ee,le]=t.useState(null),[,re]=t.useState(s.taskId||""),[,R]=t.useState(0),$=t.useRef(null),O=t.useRef(1),{credits:g,loading:m,isFreeUsage:_,freeUsageRemaining:z,refetch:P}=Ns({nodeType:"image_editing",quantity:1}),C=t.useCallback(i=>{fe(n=>n.map(G=>G.id===S?{...G,data:{...G.data,...i}}:G))},[S,fe]),W=Xs(t.useCallback(i=>i.edges.filter(n=>n.source===S),[S])),r=t.useCallback(i=>{var ne,de;const n=F(S);if(!n)return;const G=W.find(q=>{const x=F(q.target);return(x==null?void 0:x.type)==="imagePreview"});if(G){const q=G.target;fe(x=>x.map(d=>d.id===q?{...d,data:{...d.data,imageUrl:i}}:d));return}const M=Date.now(),V=`preview-${S}-${M}`,D={id:V,type:"imagePreview",position:{x:(((ne=n==null?void 0:n.position)==null?void 0:ne.x)||0)+450,y:((de=n==null?void 0:n.position)==null?void 0:de.y)||0},data:{imageUrl:i,width:400}};setTimeout(()=>{fe(x=>[...x,D]);const q={id:`edge-${S}-${V}`,source:S,target:V,targetHandle:`${V}-target`,type:"aurora"};T(x=>x.find(I=>I.source===S&&I.target===V)?x:[...x,q])},100)},[S,F,fe,T,W]),y=t.useRef({active:!1,timeoutId:null}),p=t.useCallback(async i=>{let G=0;y.current.timeoutId&&clearTimeout(y.current.timeoutId),y.current.active=!0;const M=async()=>{if(y.current.active)try{G++;const D=(await _e.tasks.getTaskStatus(i)).task;if(!y.current.active)return;if(R(D.progress||0),D.status==="SUCCESS"){y.current.active=!1,xe(!1),R(100);const ne=D.resultUrl;C({generatedImageUrl:ne,taskId:""}),be(ne),h.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ne&&r(ne);return}else if(D.status==="FAILURE"){y.current.active=!1,xe(!1),R(0),C({taskId:""}),h.error(D.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(D.status==="PROCESSING"||D.status==="PENDING")&&(G<300&&y.current.active?y.current.timeoutId=setTimeout(M,1e3):(y.current.active=!1,xe(!1),R(0),C({taskId:""}),h.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{y.current.active=!1,xe(!1),R(0),C({taskId:""}),h.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};M()},[C,r]);t.useEffect(()=>()=>{y.current.active=!1,y.current.timeoutId&&clearTimeout(y.current.timeoutId)},[]),t.useEffect(()=>{const i=s.taskId;if(!i)return;(async()=>{try{const M=(await _e.tasks.getTaskStatus(i)).task;if(M.status==="SUCCESS"){xe(!1),R(100);const V=M.resultUrl;V?(C({generatedImageUrl:V,taskId:""}),be(V),h.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):C({taskId:""})}else M.status==="PROCESSING"||M.status==="PENDING"?(xe(!0),R(M.progress||0),p(i)):M.status==="FAILURE"&&(xe(!1),R(0),C({taskId:""}),h.error(M.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${M.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{xe(!1),R(0),C({taskId:""})}})()},[]);const a=t.useCallback(i=>{const n=new Image;n.onload=()=>{le({width:n.naturalWidth,height:n.naturalHeight})},n.src=i},[]);t.useEffect(()=>{try{const i=[];he.forEach(n=>{var D,ne,de,q;const G=F(n.source);if(!G)return;const M=G.data;let V=null;M!=null&&M.url?V=M.url:M!=null&&M.imageUrl?V=M.imageUrl:M!=null&&M.output?V=M.output:(D=M==null?void 0:M.config)!=null&&D.generatedImageUrl?V=M.config.generatedImageUrl:(q=(de=(ne=M==null?void 0:M.config)==null?void 0:ne.uploadedFiles)==null?void 0:de[0])!=null&&q.url&&(V=M.config.uploadedFiles[0].url),V&&i.push(V)}),i.length>0?(ie(i[0]),ue(i.slice(1)),a(i[0])):(ie(null),ue([]),le(null))}catch{}},[he,F,a]),t.useEffect(()=>{const i=setTimeout(()=>{fe(n=>n.map(G=>{if(G.id!==S)return G;const M=G.data;return M.prompt===Q&&JSON.stringify(M.points)===JSON.stringify(ee)?G:{...G,data:{...G.data,prompt:Q,points:ee}}}))},300);return()=>clearTimeout(i)},[Q,ee,S,fe]);const v=t.useCallback(i=>{if(!i.ctrlKey&&!i.metaKey||!$.current)return;const n=$.current.getBoundingClientRect(),G=(i.clientX-n.left)/n.width,M=(i.clientY-n.top)/n.height,V={id:O.current++,x:Math.max(0,Math.min(1,G)),y:Math.max(0,Math.min(1,M))};pe(D=>[...D,V])},[]),u=t.useCallback(i=>{pe(n=>n.filter(G=>G.id!==i))},[]),w=t.useCallback((i,n)=>{pe(G=>G.map(M=>M.id===i?{...M,name:n}:M))},[]),f=t.useCallback((i,n)=>{i.stopPropagation();const G=n.name?`@${n.name}`:`@ä½ç½®${n.id}`;i.dataTransfer.setData("text/plain",G),i.dataTransfer.effectAllowed="copy"},[]),N=t.useCallback((i,n)=>{i.stopPropagation();const G=`@å‚è€ƒå›¾${n+1}`;i.dataTransfer.setData("text/plain",G),i.dataTransfer.effectAllowed="copy"},[]),j=t.useCallback(i=>{i.preventDefault(),i.stopPropagation(),i.dataTransfer.dropEffect="copy"},[]),U=t.useCallback(i=>{i.preventDefault(),i.stopPropagation();const n=i.dataTransfer.getData("text/plain");if(n){const G=i.target,M=G.selectionStart,V=G.selectionEnd,D=Q.slice(0,M)+n+Q.slice(V);oe(D),setTimeout(()=>{G.selectionStart=G.selectionEnd=M+n.length,G.focus()},0)}},[Q]),k=t.useCallback(async()=>{var i;if(!(!Se||ee.length===0)){te(!0);try{const n=await _e.ai.imageEditing.identifyPoints({image:Se,points:ee.map(G=>({id:G.id,x:G.x,y:G.y}))});if(n.success&&((i=n.data)!=null&&i.points)){const G=n.data.points;pe(M=>M.map(V=>{const D=G.find(ne=>ne.id===V.id);return D?{...V,name:D.name}:V})),h.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{h.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{te(!1)}}},[Se,ee]),c=t.useCallback(async()=>{var i,n,G,M,V;if(!Se){h.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!Q.trim()){h.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}xe(!0),R(0);try{const D=await _e.tasks.createImageEditTask({prompt:Q.trim(),mainImage:Se,referenceImages:we.length>0?we:void 0,points:ee.length>0?ee:void 0,sourceImageDimensions:Ee||void 0,sourceNodeId:S}),ne=D.taskId,de=D.creditsCharged||0,q=D.isFreeUsage,x=D.freeUsageRemaining??0;if(re(ne),C({prompt:Q.trim(),points:ee,taskId:ne}),q)h.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${x} æ¬¡æœºä¼š`),P();else if(de>0){const{useAuthStore:d}=await us(async()=>{const{useAuthStore:b}=await import("./index-CKw8I0iR.js").then(J=>J.f);return{useAuthStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:I}=d.getState();await I(),h.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${de} ç§¯åˆ†`),P()}else h.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");p(ne)}catch(D){if(xe(!1),R(0),((i=D.response)==null?void 0:i.status)===403){const ne=((G=(n=D.response)==null?void 0:n.data)==null?void 0:G.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";h.error(ne)}else{const ne=((V=(M=D.response)==null?void 0:M.data)==null?void 0:V.error)||D.message||"æœªçŸ¥åŸå› ";h.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ne}ï¼Œè¯·ç¨åé‡è¯•`)}}},[Se,Q,we,ee,Ee,S,C,p,P]);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(At,{type:"target",position:gt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(At,{type:"source",position:gt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xr,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:$,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:v,children:Se?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Se,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),ee.map(i=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-neutral-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${i.x*100}%`,top:`${i.y*100}%`},onClick:n=>{n.stopPropagation(),u(i.id)},title:i.name||`ç‚¹å‡»åˆ é™¤ #${i.id}`,children:i.id},i.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Cr,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),we.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[we.map((i,n)=>e.jsx("img",{src:i,alt:`Ref ${n+1}`,draggable:!0,onDragStart:G=>N(G,n),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},n)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",we.length," å‚è€ƒå›¾"]})]}),ee.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",ee.length,")"]}),e.jsxs("button",{onClick:k,disabled:Z||!Se,className:"text-[10px] text-neutral-500 hover:text-neutral-600 flex items-center gap-1",children:[Z?e.jsx(Ls,{className:"w-3 h-3 animate-spin"}):e.jsx(xr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:ee.map(i=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:n=>f(n,i),className:"w-5 h-5 bg-neutral-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:i.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:i.name||"",onChange:n=>w(i.id,n.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>u(i.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Hr,{className:"w-3 h-3"})})]},i.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:Q,onChange:i=>oe(i.target.value),onDragOver:j,onDrop:U,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:c,onPointerDown:i=>i.stopPropagation(),onMouseDown:i=>i.stopPropagation(),disabled:Ae||!Se||!Q.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Ae||!Se||!Q.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Ae?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!m&&(_?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(z),"æ¬¡"]}):g!==null&&g>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[g,"ç§¯åˆ†"]}):null)]})})]})]})},en=t.memo(Zo);async function dr(s){const{resultUrl:S,allImageUrls:l}=s;return{displayUrl:S,allDisplayUrls:l,isLocalStored:!1,originalUrl:S}}const tn="gemini-3-pro-image-preview",sn=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],rn=s=>{const[S,l]=s.split(":").map(Number);return S/l},an=(s,S)=>{const l=s/S;let F="1:1",fe=1/0;for(const T of sn){const he=rn(T),Q=Math.abs(l-he);Q<fe&&(fe=Q,F=T)}return F},on=s=>new Promise((S,l)=>{const F=new Image;F.onload=()=>{S({width:F.naturalWidth,height:F.naturalHeight})},F.onerror=l,F.src=s}),nn=({data:s,selected:S,id:l})=>{const[F,fe]=t.useState(s.config.imageSize||"2K"),[T,he]=t.useState(s.config.inputImage),[Q,oe]=t.useState(!!s.config.taskId),[ee,pe]=t.useState(null),Ae=t.useMemo(()=>{const O=s.models||[];return O.find(g=>g.modelId===tn)||O.find(g=>{var m;return(m=g.modelId)==null?void 0:m.includes("gemini")})||O[0]},[s.models]),{credits:xe,loading:Z,isFreeUsage:te,freeUsageRemaining:Se}=Ns({nodeType:"hd_upscale",quantity:1,resolution:F});t.useEffect(()=>{Ae&&pe(Ae)},[Ae]);const{setNodes:ie,setEdges:we,getNode:ue,getNodes:be}=Zt(),Ee=Xs(O=>O.edges.filter(g=>g.target===l));t.useEffect(()=>{const O=be();let g;Ee.forEach(m=>{var z,P,C,W,r,y,p,a;const _=O.find(v=>v.id===m.source);if(_){const v=(P=(z=_.data)==null?void 0:z.config)==null?void 0:P.uploadedFiles;if(Array.isArray(v)&&v.length>0){const u=v[0];u!=null&&u.url&&(g=u.url)}if(!g){const u=((C=_.data)==null?void 0:C.imageUrl)||((r=(W=_.data)==null?void 0:W.config)==null?void 0:r.generatedImageUrl)||((p=(y=_.data)==null?void 0:y.config)==null?void 0:p.imageUrl)||((a=_.data)==null?void 0:a.url);u&&(g=u)}}}),g!==T&&(he(g),le({inputImage:g}))},[Ee,be]),t.useEffect(()=>{const O=s.config.taskId;(async()=>{if(O)try{const _=(await _e.tasks.getTaskStatus(O)).task;if(_.status==="SUCCESS"){oe(!1);const z=_.resultUrl;if(!z){le({taskId:""});return}const C=(await dr({taskId:O,resultUrl:z,type:"IMAGE"})).displayUrl;le({generatedImageUrl:C,taskId:""})}else _.status==="PROCESSING"||_.status==="PENDING"?(oe(!0),R(O)):_.status==="FAILURE"&&(oe(!1),le({taskId:""}),Ds.error(`ç”Ÿæˆå¤±è´¥: ${_.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{oe(!1),le({taskId:""}),Ds.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const le=O=>{ie(g=>g.map(m=>m.id===l?{...m,data:{...m.data,config:{...m.data.config,...O}}}:m))},re=async()=>{var O;if(!T){Ds.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}oe(!0);try{const g=await ur(T,{skipCompression:!0});let m="1:1";try{const W=await on(T);m=an(W.width,W.height)}catch{}let _="";try{const W=await _e.get("/node-prompts/type/hdUpscale");W.success&&((O=W.data)!=null&&O.userPromptTemplate)&&(_=W.data.userPromptTemplate)}catch{}if(_||(_="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),_=`${_}ï¼Œç”Ÿæˆ${m}æ¯”ä¾‹çš„å›¾ç‰‡`,!ee){Ds.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),oe(!1);return}const z=await _e.tasks.createImageTask({modelId:ee.id,prompt:_,ratio:m,referenceImages:[g],sourceNodeId:l,metadata:{imageSize:F,nodeType:"hd_upscale"}});if(!z.success)throw new Error(z.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const P=z.taskId,C=z.creditsCharged||0;if(le({taskId:P}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),C>0){const{useAuthStore:W}=await us(async()=>{const{useAuthStore:y}=await import("./index-CKw8I0iR.js").then(p=>p.f);return{useAuthStore:y}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:r}=W.getState();await r(),Ds.success(`âœ¨ é«˜æ¸…æ”¾å¤§å·²å¼€å§‹ï¼Œæ¶ˆè€— ${C} ç§¯åˆ†`)}R(P)}catch(g){Ds.error(g.message||"ç”Ÿæˆå¤±è´¥"),oe(!1)}},R=async O=>{let m=0;const _=async()=>{try{const P=(await _e.tasks.getTaskStatus(O)).task;if(P.status==="SUCCESS"){oe(!1);const C=P.resultUrl;if(!C){Ds.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const r=(await dr({taskId:O,resultUrl:C,type:"IMAGE"})).displayUrl;le({generatedImageUrl:r,taskId:"",imageSize:F}),$(r),Ds.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else P.status==="FAILURE"?(oe(!1),le({taskId:""}),Ds.error(`ç”Ÿæˆå¤±è´¥: ${P.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(P.status==="PROCESSING"||P.status==="PENDING")&&(m++,m<300?setTimeout(_,2e3):(oe(!1),Ds.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{oe(!1),Ds.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};_()},$=O=>{const g=ue(l);if(!g)return;const z=be().filter(y=>y.id.startsWith(`${l}-preview`)&&y.type==="imagePreview").length,W={id:`${l}-preview-${Date.now()}`,type:"imagePreview",position:{x:g.position.x+380,y:g.position.y+z*(220+20)},data:{imageUrl:O,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:l,createdBy:g.data.createdBy}},r={id:`edge-${l}-to-${W.id}`,source:l,target:W.id,sourceHandle:`${l}-source`,type:"aurora"};ie(y=>[...y,W]),we(y=>[...y,r])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(hs,{type:"target",position:gt.Left,id:`${l}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(hs,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:T,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{fe("2K"),le({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{fe("4K"),le({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:re,onPointerDown:O=>O.stopPropagation(),onMouseDown:O=>O.stopPropagation(),disabled:Q||!T,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Q||!T?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"}),!Z&&(te?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(Se),"æ¬¡"]}):xe!==null&&xe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[xe,"ç§¯åˆ†"]}):null)]})})]})]})},ln=t.memo(nn),Jr=async(s,S,l)=>new Promise((F,fe)=>{const T=new Image;T.crossOrigin="Anonymous",T.onload=()=>{try{const he=T.width,Q=T.height,oe=Math.floor(he/l),ee=Math.floor(Q/S),pe=[],Ae=document.createElement("canvas");Ae.width=oe,Ae.height=ee;const xe=Ae.getContext("2d");if(!xe){fe(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let Z=0;Z<S;Z++)for(let te=0;te<l;te++)xe.clearRect(0,0,oe,ee),xe.drawImage(T,te*oe,Z*ee,oe,ee,0,0,oe,ee),pe.push(Ae.toDataURL("image/png"));F({slices:pe,fullImage:s,rows:S,cols:l})}catch(he){fe(he)}},T.onerror=()=>{fe(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),T.src=s}),Br=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},cn=(s,S="image/png")=>{const l=s.includes(",")?s.split(",")[1]:s,F=atob(l),fe=new Array(F.length);for(let he=0;he<F.length;he++)fe[he]=F.charCodeAt(he);const T=new Uint8Array(fe);return new Blob([T],{type:S})},dn=({data:s,selected:S,id:l})=>{const[F,fe]=t.useState(null),T="single",[he,Q]=t.useState(s.config.aspectRatio||"16:9"),[oe,ee]=t.useState(s.config.imageSize||"4K"),[pe,Ae]=t.useState(s.config.userPrompt||""),[xe,Z]=t.useState(!!s.config.taskId),[te,Se]=t.useState(s.config.characterImages||[]),[ie,we]=t.useState(s.config.sceneImages||[]),[ue,be]=t.useState(s.config.styleImage),Ee=t.useRef(null),{setNodes:le,setEdges:re,getNode:R,getNodes:$,getEdges:O}=Zt(),g=Xs(k=>k.edges.filter(c=>c.target===l)),m=Xs(k=>k.edges.some(c=>c.target===l&&c.targetHandle===`${l}-scene-input`)),_=Xs(k=>k.edges.some(c=>c.target===l&&c.targetHandle===`${l}-style-input`)),z=t.useRef(""),{credits:P,loading:C,isFreeUsage:W,freeUsageRemaining:r}=Ns({nodeType:"image_fusion",quantity:1,resolution:oe}),y="gemini-3-pro-image-preview",p=t.useMemo(()=>{const k=s.models||[];return k.find(c=>c.modelId===y)||k.find(c=>{var i;return(i=c.modelId)==null?void 0:i.includes("gemini")})||k[0]},[s.models]);t.useEffect(()=>{p&&fe(p)},[p]),t.useEffect(()=>{const k=s.config.taskId,c=s.config.generatedImageUrl;(async()=>{if(k)try{const G=(await _e.tasks.getTaskStatus(k)).task;if(G.status==="SUCCESS"){Z(!1);const M=G.resultUrl;if(!M){a({taskId:""}),h.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let V=M;c?V=c:V=(await dr({taskId:k,resultUrl:M,type:"IMAGE"})).displayUrl,a({generatedImageUrl:V,taskId:""});const D=$(),ne=O();if(D.filter(x=>x.type==="imagePreview"&&ne.some(d=>d.source===l&&d.target===x.id)).find(x=>x.data.imageUrl===V||x.data.imageUrl===M)){h.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}h.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),j(V,he,0)}else G.status==="PROCESSING"||G.status==="PENDING"?(Z(!0),f(k)):G.status==="FAILURE"&&(Z(!1),a({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${G.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{Z(!1),a({taskId:""}),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ee.current&&pe){const k=Ee.current;k.style.height="auto",k.style.height=`${k.scrollHeight}px`}},[]);const a=k=>{le(c=>c.map(i=>i.id===l?{...i,data:{...i.data,config:{...i.data.config,...k}}}:i))};t.useEffect(()=>{const k=JSON.stringify(g.map(G=>({source:G.source,sourceHandle:G.sourceHandle,targetHandle:G.targetHandle})));if(k===z.current)return;z.current=k;const c=[],i=[];let n;g.forEach(G=>{const M=R(G.source);if(!M)return;const V=G.targetHandle||"",D=v(M);V.includes("character")?c.push(...D):V.includes("scene")?i.length===0&&D.length>0&&i.push(D[0]):V.includes("style")&&D.length>0&&(n=D[0])}),Se(c),we(i),be(n),a({characterImages:c,sceneImages:i,styleImage:n})},[g,R]);const v=k=>{var n,G,M,V;const c=(k==null?void 0:k.type)||"",i=k==null?void 0:k.data;if(c==="upload"&&((n=i==null?void 0:i.config)!=null&&n.uploadedFiles))return i.config.uploadedFiles.filter(D=>{var ne;return D.type==="IMAGE"||((ne=D.mimeType)==null?void 0:ne.startsWith("image/"))}).map(D=>D.url||D.localUrl);if(c==="assetSelector"&&((G=i==null?void 0:i.config)!=null&&G.selectedAsset)){const D=i.config.selectedAsset;if(D.type==="IMAGE"||(M=D.mimeType)!=null&&M.startsWith("image/"))return[D.url]}return c==="imagePreview"&&(i!=null&&i.imageUrl)?[i.imageUrl]:c==="aiImage"&&((V=i==null?void 0:i.config)!=null&&V.generatedImageUrl)?[i.config.generatedImageUrl]:[]},u=()=>{let k=pe;if(ue){const c=te.length+ie.length+1;k+=`ï¼Œå‚è€ƒå›¾ç‰‡${c}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${c}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return k+=`ï¼Œç”Ÿæˆ${he}æ¯”ä¾‹çš„å›¾ç‰‡`,k},w=async()=>{if(!pe.trim()){h.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!F){h.error("è¯·é€‰æ‹©æ¨¡å‹");return}Z(!0);try{const k=u(),c=[...te,...ie,...ue?[ue]:[]],i=await Promise.all(c.map(async V=>{try{return await ur(V,{skipCompression:!0})}catch{return V}})),n=await _e.tasks.createImageTask({modelId:F.id,prompt:k,ratio:he,referenceImages:i.filter(Boolean),sourceNodeId:l,metadata:{imageSize:oe,nodeType:"image_fusion"}});if(!n.success)throw new Error(n.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const G=n.taskId,M=n.creditsCharged||0;if(a({taskId:G}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),M>0){const{useAuthStore:V}=await us(async()=>{const{useAuthStore:ne}=await import("./index-CKw8I0iR.js").then(de=>de.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:D}=V.getState();await D(),h.success(`âœ¨ æ™ºèƒ½æº¶å›¾å·²å¼€å§‹ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†`)}f(G)}catch(k){h.error(k.message||"ç”Ÿæˆå¤±è´¥"),Z(!1)}},f=async k=>{let i=0;const n=async()=>{try{const M=(await _e.tasks.getTaskStatus(k)).task;if(M.status==="SUCCESS"){Z(!1);const V=M.resultUrl;if(!V){h.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ne=(await dr({taskId:k,resultUrl:V,type:"IMAGE"})).displayUrl;a({generatedImageUrl:ne,taskId:"",modelId:F==null?void 0:F.id,mode:T,aspectRatio:he,imageSize:oe,userPrompt:pe}),T!=="single"||j(ne,he,0),h.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else M.status==="FAILURE"?(Z(!1),a({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${M.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(M.status==="PROCESSING"||M.status==="PENDING")&&(i++,i<300?setTimeout(n,2e3):(Z(!1),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{Z(!1),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};n()},N=async k=>{try{const{rows:c,cols:i}=Br(T),n=await Jr(k,c,i);a({slicedImages:n.slices}),n.slices.forEach((G,M)=>{j(G,he,M)})}catch(c){h.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+c.message)}},j=(k,c,i)=>{const n=R(l);if(!n)return;const{rows:G,cols:M}=Br(T),V=G*M,D=280,ne=320,de=20,q=i%M,x=Math.floor(i/M),d=n.position.x+400,I=n.position.y-(V-1)*(ne+de)/2,b={id:`${l}-preview-${i}-${Date.now()}`,type:"imagePreview",position:{x:d+q*(D+de),y:I+x*(ne+de)},data:{imageUrl:k,ratio:c,label:`æº¶å›¾ ${i+1}`,fromStoryboard:!0,sourceNodeId:l}},J={id:`edge-${l}-to-${b.id}`,source:l,target:b.id,sourceHandle:`${l}-source`,type:"aurora"};le(ce=>[...ce,b]),re(ce=>[...ce,J])},U=te.length+ie.length+(ue?1:0);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["è§’è‰² ",te.length>0&&`(${te.length})`]}),e.jsx(hs,{type:"target",position:gt.Left,id:`${l}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["åœºæ™¯ ",ie.length>0?"âœ“":""]}),e.jsx(hs,{type:"target",position:gt.Left,id:`${l}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!m})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["é£æ ¼ ",ue?"âœ“":""]}),e.jsx(hs,{type:"target",position:gt.Left,id:`${l}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!_})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(fs,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[U>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",U,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let k=1;const c=[];return te.forEach(i=>{c.push({url:i,type:"char",index:k++})}),ie.forEach(i=>{c.push({url:i,type:"scene",index:k++})}),ue&&c.push({url:ue,type:"style",index:k++}),c.map(i=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:i.url,alt:`å›¾${i.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:i.index})]},`${i.type}-${i.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{ee("2K"),a({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${oe==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{ee("4K"),a({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${oe==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(k=>e.jsx("button",{onClick:()=>{Q(k),a({aspectRatio:k})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${he===k?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:k},k))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ee,value:pe,onChange:k=>{Ae(k.target.value),a({userPrompt:k.target.value});const c=k.target;c.style.height="auto",c.style.height=`${c.scrollHeight}px`},onFocus:k=>{const c=k.target;c.style.height="auto",c.style.height=`${c.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:w,onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),disabled:xe||!pe.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${xe||!pe.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:xe?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!C&&(W?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(r),"æ¬¡"]}):P!==null&&P>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[P,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(hs,{type:"source",position:gt.Right,id:`${l}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},un=t.memo(dn),gn=["16:9","9:16"],pn="gemini-3-pro-preview",hn="gemini-3-pro-image-preview",Er=5,fn=({data:s,selected:S,id:l})=>{const[F,fe]=t.useState(s.config.aspectRatio||"16:9"),[T,he]=t.useState(s.config.inputImages||[]),[Q,oe]=t.useState(s.config.userPrompt||""),[ee,pe]=t.useState(s.config.imageStyle||""),[Ae,xe]=t.useState(s.config.autoSlice!==!1),[Z,te]=t.useState(!!s.config.taskId),[Se,ie]=t.useState(null),[we,ue]=t.useState(null),{credits:be,loading:Ee,isFreeUsage:le,freeUsageRemaining:re}=Ns({nodeType:"smart_storyboard",quantity:1}),R=t.useMemo(()=>{const j=s.models||[];return j.find(U=>U.modelId===hn)||j.find(U=>{var k;return(k=U.modelId)==null?void 0:k.includes("gemini")})||j[0]},[s.models]);t.useEffect(()=>{R&&ue(R)},[R]);const{setNodes:$,setEdges:O,getNode:g,getNodes:m}=Zt(),_=t.useRef(null),z=t.useRef(null),P=t.useRef(null),C=t.useRef(null),W=t.useRef(m),r=t.useRef(Ae),y=Xs(j=>j.edges.filter(U=>U.target===l)),p=t.useRef("");t.useEffect(()=>{const j=m(),U=[];y.forEach(c=>{var n,G,M,V,D,ne,de,q;if(U.length>=Er)return;const i=j.find(x=>x.id===c.source);if(i){const x=(G=(n=i.data)==null?void 0:n.config)==null?void 0:G.uploadedFiles;Array.isArray(x)&&x.forEach(I=>{U.length>=Er||I!=null&&I.url&&!U.includes(I.url)&&U.push(I.url)});const d=((M=i.data)==null?void 0:M.imageUrl)||((D=(V=i.data)==null?void 0:V.config)==null?void 0:D.generatedImageUrl)||((de=(ne=i.data)==null?void 0:ne.config)==null?void 0:de.imageUrl)||((q=i.data)==null?void 0:q.url);d&&!U.includes(d)&&U.push(d)}});const k=U.join(",");k!==p.current&&(p.current=k,he(U),a({inputImages:U}))},[y,m]),t.useEffect(()=>{const j=s.config.taskId,k=setTimeout(async()=>{var c,i,n,G;if(j)try{const V=(await _e.tasks.getTaskStatus(j)).task;if(V.status==="SUCCESS"){te(!1),ie(null);const D=V.resultUrl;if(!D){(c=P.current)==null||c.call(P,{taskId:""});return}const de=(await dr({taskId:j,resultUrl:D,type:"IMAGE"})).displayUrl;(i=P.current)==null||i.call(P,{generatedImageUrl:de,taskId:""}),W.current().some(d=>{var I;return((I=d.data)==null?void 0:I.sourceNodeId)===l&&d.type==="imagePreview"})||(r.current&&_.current?await _.current(de):z.current&&z.current(de,s.config.aspectRatio||"16:9")),h.success("åˆ†é•œç”Ÿæˆå·²å®Œæˆï¼")}else V.status==="PROCESSING"||V.status==="PENDING"?(te(!0),ie("image"),setTimeout(()=>{var D;(D=C.current)==null||D.call(C,j)},100)):V.status==="FAILURE"&&(te(!1),ie(null),(n=P.current)==null||n.call(P,{taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${V.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{te(!1),ie(null),(G=P.current)==null||G.call(P,{taskId:""}),h.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}},200);return()=>clearTimeout(k)},[]);const a=j=>{$(U=>U.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,...j}}}:k))};P.current=a,W.current=m,r.current=Ae;const v=async()=>{var j,U;if(T.length===0){h.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!Q.trim()){h.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}te(!0),ie("text");try{const k=await Promise.all(T.map(q=>ur(q,{skipCompression:!0})));let c="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",i="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚";try{const q=await _e.get("/node-prompts/type/smartStoryboard");q.success&&q.data&&(q.data.systemPrompt&&(c=q.data.systemPrompt),q.data.userPromptTemplate&&(i=q.data.userPromptTemplate))}catch{}const n=q=>q.replace(/\{\{userPrompt\}\}/g,Q).replace(/\{\{imageStyle\}\}/g,ee||"").replace(/\{\{aspectRatio\}\}/g,F);c=n(c),i=n(i);const G=await _e.ai.text.generate({modelId:pn,systemPrompt:c,prompt:Q,imageUrls:k,skipBilling:!0});if(!G.success)throw new Error(G.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const M=((j=G.data)==null?void 0:j.text)||((U=G.data)==null?void 0:U.content)||G.content;if(!M||typeof M!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(ie("image"),!we){h.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),te(!1),ie(null);return}const V=`${i}

åˆ†é•œæè¿°ï¼š
${M}

ç”Ÿæˆ${F}æ¯”ä¾‹çš„å›¾ç‰‡`,D=await _e.tasks.createImageTask({modelId:we.id,prompt:V,ratio:F,referenceImages:k,sourceNodeId:l,metadata:{imageSize:"4K",nodeType:"smart_storyboard"}});if(!D.success)throw new Error(D.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const ne=D.taskId,de=D.creditsCharged||0;if(a({taskId:ne,userPrompt:Q}),de>0){const{useAuthStore:q}=await us(async()=>{const{useAuthStore:d}=await import("./index-CKw8I0iR.js").then(I=>I.f);return{useAuthStore:d}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:x}=q.getState();await x()}setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},500),u(ne)}catch(k){h.error(k.message||"ç”Ÿæˆå¤±è´¥"),te(!1),ie(null)}},u=async j=>{let k=0;const c=async()=>{try{const n=(await _e.tasks.getTaskStatus(j)).task;if(n.status==="SUCCESS"){te(!1),ie(null);const G=n.resultUrl;if(!G){h.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const V=(await dr({taskId:j,resultUrl:G,type:"IMAGE"})).displayUrl;a({generatedImageUrl:V,taskId:"",aspectRatio:F}),Ae?await w(V):f(V,F),h.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else n.status==="FAILURE"?(te(!1),ie(null),a({taskId:""}),h.error(`ç”Ÿæˆå¤±è´¥: ${n.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(n.status==="PROCESSING"||n.status==="PENDING")&&(k++,k<300?setTimeout(c,2e3):(te(!1),ie(null),h.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{te(!1),ie(null),h.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};c()};C.current=u;const w=async j=>{try{let U=j;if(!j.startsWith("data:"))try{const V=await _e.assets.proxyDownload(j),D=new Blob([V],{type:"image/png"});U=await new Promise((ne,de)=>{const q=new FileReader;q.onloadend=()=>ne(q.result),q.onerror=de,q.readAsDataURL(D)})}catch{}const k=await Jr(U,3,3),c=3e4;h.info(`å¼€å§‹ä¸Šä¼  ${k.slices.length} ä¸ªåˆ†é•œ...`);const i=k.slices.map(async(V,D)=>{var ne;try{const de=cn(V,"image/png"),q=`storyboard_${l}_slice_${D+1}_${Date.now()}.png`,x=new File([de],q,{type:"image/png"}),d=_e.assets.upload(x),I=new Promise((J,ce)=>setTimeout(()=>ce(new Error("ä¸Šä¼ è¶…æ—¶")),c)),b=await Promise.race([d,I]);return b.success&&((ne=b.data)!=null&&ne.url)?{success:!0,url:b.data.url,index:D+1}:{success:!1,index:D+1,error:b.message}}catch(de){return{success:!1,index:D+1,error:de.message}}}),n=await Promise.all(i),G=[],M=[];n.forEach(V=>{V.success&&V.url?G.push(V.url):M.push(V.index)}),a({slicedImages:G}),M.length>0?h.error(`åˆ†é•œ ${M.join(", ")} ä¸Šä¼ å¤±è´¥`):h.success(`æˆåŠŸç”Ÿæˆ ${G.length} ä¸ªåˆ†é•œ`),N(G,F)}catch(U){h.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+U.message)}};_.current=w;const f=(j,U)=>{const k=g(l);if(!k)return;const c=Date.now(),i={id:`${l}-preview-${c}`,type:"imagePreview",position:{x:k.position.x+350,y:k.position.y},data:{imageUrl:j,ratio:U,label:"åˆ†é•œç»“æœ",fromStoryboard:!0,sourceNodeId:l,createdBy:k.data.createdBy}},n={id:`edge-${l}-to-preview-${c}`,source:l,target:i.id,sourceHandle:`${l}-source`,type:"aurora"};$(G=>[...G,i]),O(G=>[...G,n]),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},100)};z.current=f;const N=(j,U)=>{const k=g(l);if(!k)return;const c=3,i=20,n=Date.now(),G=.15;let M,V;U==="16:9"?(M=Math.round(1835*G),V=Math.round(1024*G)):(M=Math.round(1024*G),V=Math.round(1835*G));const D=k.position.x+350,ne=3*V+2*i,de=k.position.y-ne/2+150,q=[],x=[];j.forEach((d,I)=>{const b=Math.floor(I/c),J=I%c,ce={id:`${l}-slice-${n}-${I}`,type:"imagePreview",position:{x:D+J*(M+i),y:de+b*(V+i)},data:{imageUrl:d,ratio:U,width:M,height:V,label:`åˆ†é•œ ${I+1}`,fromStoryboard:!0,sourceNodeId:l,createdBy:k.data.createdBy}},B={id:`edge-${l}-to-slice-${n}-${I}`,source:l,target:ce.id,sourceHandle:`${l}-source`,type:"aurora"};q.push(ce),x.push(B)}),$(d=>[...d,...q]),O(d=>[...d,...x]),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},100)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(hs,{type:"target",position:gt.Left,id:`${l}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(hs,{type:"source",position:gt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",T.length,"/",Er,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:T.map((j,U)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:j,alt:`å›¾ç‰‡${U+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:U+1})]},U))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:Q,onChange:j=>{oe(j.target.value),a({userPrompt:j.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡é£æ ¼"}),e.jsx("input",{type:"text",value:ee,onChange:j=>{pe(j.target.value),a({imageStyle:j.target.value})},placeholder:"å¦‚ï¼šèµ›åšæœ‹å…‹ã€æ°´å½©ç”»ã€æ—¥ç³»åŠ¨æ¼«...",className:"nodrag w-full px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:gn.map(j=>e.jsx("button",{onClick:()=>{fe(j),a({aspectRatio:j})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${F===j?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:j},j))})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è‡ªåŠ¨åˆ‡å‰²ä¹å®«æ ¼"}),e.jsx("button",{type:"button",onClick:()=>{const j=!Ae;xe(j),a({autoSlice:j})},className:`nodrag relative w-10 h-5 rounded-full transition-colors ${Ae?"bg-neutral-800 dark:bg-white":"bg-slate-300 dark:bg-white/20"}`,disabled:s._canEdit===!1,children:e.jsx("div",{className:`absolute top-0.5 w-4 h-4 rounded-full shadow transition-transform ${Ae?"translate-x-5 bg-white dark:bg-black":"translate-x-0.5 bg-white"}`})})]}),e.jsx("button",{type:"button",onClick:j=>{j.stopPropagation(),v()},disabled:Z,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Z?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Z?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Se==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"}),!Ee&&(le?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(re),"æ¬¡"]}):be!==null&&be>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[be,"ç§¯åˆ†"]}):null)]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},mn=t.memo(fn),xn="https://api.waule.ai",bn=({isOpen:s,onClose:S,onAssetSelect:l})=>{const[F,fe]=t.useState([]),[T,he]=t.useState(""),[Q,oe]=t.useState([]),[ee,pe]=t.useState([]),[Ae,xe]=t.useState(!1),[Z,te]=t.useState("ALL"),[Se,ie]=t.useState("ALL");t.useEffect(()=>{s&&we()},[s]),t.useEffect(()=>{T&&be(T)},[T]),t.useEffect(()=>{if(!s)return;const re=Se==="ALL"?F:F.filter(R=>(R.category||"OTHER")===Se);he(re.length>0?re[0].id:"")},[Se,F,s]);const we=async()=>{try{const R=(await _e.assetLibraries.getAll({includeShared:"true"})).data||[];if(fe(R),R.length>0&&!T){const $=Se==="ALL"?R:R.filter(O=>(O.category||"OTHER")===Se);he(($[0]||R[0]).id)}}catch{h.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const re=R=>{var O;const $=((O=R==null?void 0:R.detail)==null?void 0:O.libraryId)||T;we(),$&&be($)};return window.addEventListener("asset-library-updated",re),()=>window.removeEventListener("asset-library-updated",re)},[T]);const ue=re=>(/^https?:\/\//.test(re)?re:`${xn}${re}`).replace(".oss-oss-",".oss-"),be=async re=>{var R,$,O,g,m;xe(!0);try{const _=F.find(P=>P.id===re);if(_&&(_.category||"OTHER")==="ROLE"){const C=(await _e.assetLibraries.roles.list(re)).data||[],W=[];for(const r of C){const y=r.metadata||{},p=[(R=y.images)==null?void 0:R.frontAssetId,($=y.images)==null?void 0:$.sideAssetId,(O=y.images)==null?void 0:O.backAssetId,(g=y.images)==null?void 0:g.faceAssetId].filter(Boolean),a=[];for(const u of p)try{const f=(await _e.assets.getById(u)).data;a.push({id:f.id,url:ue(f.url),name:f.name})}catch{}const v=r.thumbnail?ue(r.thumbnail):((m=a[0])==null?void 0:m.url)||"";W.push({id:r.id,name:r.name,coverUrl:v,images:a})}pe(W),oe([])}else{const C=(await _e.assetLibraries.getAssets(re)).data||[];oe(C),pe([])}}catch{h.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{xe(!1)}},Ee=re=>{he(re)},le=re=>{l?(l(re),setTimeout(()=>{we(),T&&be(T)},0)):h.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:S}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-neutral-500/20 via-neutral-400/30 to-neutral-500/20"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:S,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:F.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(re=>e.jsx("button",{onClick:()=>te(re),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${Z===re?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:re==="IMAGE"?"å›¾ç‰‡":re==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},re))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(re=>e.jsx("button",{onClick:()=>ie(re),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${Se===re?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:re==="ROLE"?"è§’è‰²":re==="SCENE"?"åœºæ™¯":re==="PROP"?"é“å…·":re==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},re))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const re=Se==="ALL"?F:F.filter(R=>(R.category||"OTHER")===Se);return e.jsx("select",{value:T,onChange:R=>Ee(R.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-neutral-500",children:re.map(R=>{var $;return e.jsxs("option",{value:R.id,children:[R.isShared?`[å…±äº«] ${R.name}`:R.name," (",R._count.assets,")",R.isShared&&(($=R.owner)!=null&&$.nickname)?` - ${R.owner.nickname}`:""]},R.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Ae?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const re=F.find(O=>O.id===T);if(re&&(re.category||"OTHER")==="ROLE")return ee.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:ee.map(O=>e.jsxs("div",{onClick:()=>l&&l(O),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[O.coverUrl?e.jsx("img",{src:O.coverUrl,alt:O.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:O.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[O.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},O.id))});const $=Q.filter(O=>Z==="ALL"||O.type===Z);return $.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:$.map(O=>e.jsxs("div",{onClick:()=>le(O),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[O.type==="IMAGE"?e.jsx("img",{src:ue(O.url),alt:O.name,className:"w-full h-full object-cover"}):O.type==="VIDEO"?e.jsx("video",{src:ue(O.url),className:"w-full h-full object-cover"}):O.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:O.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:O.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:O.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(O.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:O.type==="IMAGE"?"image":O.type==="VIDEO"?"video_file":O.type==="AUDIO"?"audio_file":"description"})})]},O.id))})})()})]})})]})]}):null},wn={agent:xo,aiImage:Ka,aiVideo:gr,soraVideo:_o,soraCharacter:Uo,aiVideo_t2v:Za,aiVideo_i2v_first:to,aiVideo_i2v_last:ro,aiVideo_first_last:oo,aiVideo_reference:io,aiVideo_swap:co,aiVideo_lipsync:go,aiVideo_style:fo,upload:wo,assetSelector:ko,imagePreview:No,videoPreview:Io,textPreview:Eo,midjourney:Co,audioVoice:$o,voiceClone:Do,audioSynthesize:Lo,audioDesign:Fo,audioPreview:Vo,superCanvas:Bo,videoUpscale:Xo,commercialVideo:qo,textAnnotation:Qo,imageEditing:en,hdUpscale:ln,imageFusion:un,smartStoryboard:mn},yn={aurora:Oo},kn=()=>{const{id:s,projectId:S,episodeId:l,workflowId:F}=xa(),fe=!!F,T=ba(),he=Ar(),Q=t.useMemo(()=>new URLSearchParams(he.search),[he.search]),oe=t.useMemo(()=>{const o=Number(Q.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[Q]),ee=t.useMemo(()=>{const o=Number(Q.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[Q]),pe=t.useMemo(()=>{try{const o=Q.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[Q]),{screenToFlowPosition:Ae,setCenter:xe,getViewport:Z,fitView:te}=Zt(),{setTitle:Se}=ya(),ie=_r(o=>o.user),[we,ue]=t.useState(null),[be,Ee]=t.useState(null),[le,re]=t.useState(!0),[R,$,O]=Na([]),[g,m,_]=ja([]),[z,P]=t.useState(!1),C=t.useRef(!1),[W,r]=t.useState(null),[y,p]=t.useState(null),[a,v]=t.useState(!0),u=t.useRef(null),[w,f]=t.useState(!1),N=t.useRef(null),j=t.useRef(null),[U,k]=t.useState(!1),[c,i]=t.useState(null),[n,G]=t.useState([]),[M,V]=t.useState([]),[D,ne]=t.useState(null),[de,q]=t.useState(null),x=t.useRef(null),d=t.useRef(null),I=D==="video",b=D==="edit",J=D==="imageEdit",ce=o=>ne(null),B=o=>ne(o?"video":null),ge=o=>ne(o?"edit":null),Ce=o=>ne(o?"imageEdit":null),ve=x,$e=de==="agent",Te=o=>q(o?"agent":null),Ue=d,Re=d,se=t.useCallback(o=>{const A=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return A?A.includes("æ–‡ç”Ÿ")||A.includes("text to video")||A.includes("t2v")||A.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":A.includes("é¦–å°¾")||A.includes("first last")||A.includes("two frame")||A.includes("frame pair")||A.includes("first-last")?"é¦–å°¾å¸§":A.includes("é¦–å¸§")||A.includes("first frame")||A.includes("start frame")||A.includes("initial frame")||A.includes("keyframe")?"é¦–å¸§":A.includes("å°¾å¸§")||A.includes("last frame")||A.includes("end frame")||A.includes("final frame")?"å°¾å¸§":A.includes("ä¸»ä½“å‚è€ƒ")||A.includes("subject reference")||A.includes("å‚è€ƒ")||A.includes("reference image")||A.includes("image reference")||A.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ve=t.useMemo(()=>{const o=new Set;return(n||[]).filter(L=>(L.type||"")==="VIDEO_GENERATION").forEach(L=>{var Y;(Array.isArray((Y=L==null?void 0:L.config)==null?void 0:Y.supportedGenerationTypes)?L.config.supportedGenerationTypes:[]).forEach(ye=>{const De=se(ye);De&&o.add(De)})}),o},[n,se]),Ze=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),zt=t.useCallback(o=>{const A=(n||[]).filter(Y=>(Y.type||"")==="VIDEO_EDITING").filter(Y=>{var ye;return Array.isArray((ye=Y==null?void 0:Y.config)==null?void 0:ye.supportedEditingCapabilities)&&Y.config.supportedEditingCapabilities.includes(o)}),L=(n||[]).filter(Y=>(Y.type||"")==="VIDEO_GENERATION").filter(Y=>{var He,We;if(o!=="è§†é¢‘æ¢äºº")return!1;const ye=((He=Y==null?void 0:Y.config)==null?void 0:He.supportsVideoEditing)===!0,Le=(Array.isArray((We=Y==null?void 0:Y.config)==null?void 0:We.supportedGenerationTypes)?Y.config.supportedGenerationTypes:[]).some(rt=>se(rt)==="è§†é¢‘æ¢äºº");return ye||Le}),X={};return[...A,...L].forEach(Y=>{X[Y.id]||(X[Y.id]=Y)}),Object.values(X)},[n,se]),[Ot,Tt]=t.useState(!1),[dt,pt]=t.useState(null),Nt=t.useRef(null),lt=t.useRef(),[Ke,vt]=t.useState([]),[ze,wt]=t.useState(null),[ts,ms]=t.useState(null),[Rs,Is]=t.useState(!1),[Ss,Gs]=t.useState(null),[ks,js]=t.useState(null),[qs,nr]=t.useState(null),Ut=t.useRef([]),er=t.useRef(null),[bs,Ks]=t.useState(!1),[Es,$s]=t.useState(!1),[sr,rr]=t.useState(0),Vs=t.useRef(null),K=t.useRef(null),ae=t.useRef([]),Me=t.useRef([]),Ge=t.useRef(0),qe=!!l,Oe=qe&&!!oe&&!!ee,tt=fe?F:Oe?`${l}-${oe}-${ee}`:qe?l:s,bt=Oe,[yt,E]=t.useState(!1),H=t.useRef(new Set),Ne=t.useRef(new Set),je=t.useRef(new Set),me=t.useRef(new Set),Ie=t.useRef(new Map),nt=t.useRef(new Set),Ye=t.useCallback((o,A)=>{A!==u.current&&(H.current.add(o.id),$(L=>L.some(X=>X.id===o.id)?L:[...L,{...o,data:{...o.data,models:n}}]))},[n,$]),Rt=t.useCallback((o,A,L)=>{L!==u.current&&(nt.current.add(o),$(X=>X.map(Y=>Y.id===o?{...Y,data:{...Y.data,...A}}:Y)),setTimeout(()=>nt.current.delete(o),100))},[$]),st=t.useCallback((o,A)=>{A!==u.current&&($(L=>L.filter(X=>X.id!==o)),m(L=>L.filter(X=>X.source!==o&&X.target!==o)))},[$,m]),Be=t.useCallback((o,A,L)=>{L!==u.current&&$(X=>X.map(Y=>Y.id===o?{...Y,position:A}:Y))},[$]),$t=t.useCallback((o,A)=>{A!==u.current&&$(L=>L.map(X=>{const Y=o.find(ye=>ye.id===X.id);return Y?{...X,position:Y.position}:X}))},[$]),Xt=t.useCallback((o,A)=>{A!==u.current&&(Ne.current.add(o.id),m(L=>L.some(X=>X.id===o.id)?L:[...L,o]))},[m]),kt=t.useCallback((o,A)=>{A!==u.current&&m(L=>L.filter(X=>X.id!==o))},[m]),It=t.useCallback((o,A)=>{A!==u.current&&(vt(o),Ut.current=o)},[]),{emitNodeAdd:Ct,emitNodeUpdate:Dt,emitNodeDelete:qt,emitNodesMove:Bt,emitEdgeAdd:rs,emitEdgeDelete:gs,emitGroupsUpdate:Ws,onlineUsers:tr}=Ba({workflowId:N.current,isSharedWorkflow:w,isReadOnly:z,onNodeAdd:Ye,onNodeUpdate:Rt,onNodeDelete:st,onNodeMove:Be,onNodesMove:$t,onEdgeAdd:Xt,onEdgeDelete:kt,onGroupsUpdate:It});t.useEffect(()=>{Ut.current=Ke},[Ke]),t.useEffect(()=>{ae.current=R,Ge.current=R.length},[R]),t.useEffect(()=>{Me.current=g},[g]),t.useEffect(()=>{if(!yt){je.current=new Set(R.map(Y=>Y.id));const X=new Map;R.forEach(Y=>{var ye;try{X.set(Y.id,JSON.stringify(((ye=Y.data)==null?void 0:ye.config)||{}))}catch{X.set(Y.id,"{}")}}),Ie.current=X;return}if(!w||C.current){je.current=new Set(R.map(X=>X.id));return}const o=new Set(R.map(X=>X.id)),A=je.current;R.forEach(X=>{var Y,ye;if(!A.has(X.id))H.current.has(X.id)||Ct(X);else if(!nt.current.has(X.id))try{const De=JSON.stringify(((Y=X.data)==null?void 0:Y.config)||{}),Le=Ie.current.get(X.id)||"{}";De!==Le&&Dt(X.id,{config:(ye=X.data)==null?void 0:ye.config})}catch{}}),je.current=o;const L=new Map;R.forEach(X=>{var Y;try{L.set(X.id,JSON.stringify(((Y=X.data)==null?void 0:Y.config)||{}))}catch{L.set(X.id,"{}")}}),Ie.current=L,H.current=new Set([...H.current].filter(X=>o.has(X)))},[R,w,yt,Ct,Dt]),t.useEffect(()=>{if(!yt){me.current=new Set(g.map(L=>L.id));return}if(!w||C.current){me.current=new Set(g.map(L=>L.id));return}const o=new Set(g.map(L=>L.id)),A=me.current;g.forEach(L=>{A.has(L.id)||Ne.current.has(L.id)||rs(L)}),me.current=o,Ne.current=new Set([...Ne.current].filter(L=>o.has(L)))},[g,w,yt,rs]);const Fs=t.useCallback(o=>{var Y;if(C.current)return!1;if(a)return!0;if(Ut.current.some(ye=>{var De;return!ye.hidden&&((De=ye.nodeIds)==null?void 0:De.includes(o.id))}))return!1;if(Oe)return!0;const L=(Y=o.data)==null?void 0:Y.createdBy;return(typeof L=="object"?L==null?void 0:L.id:L)===u.current},[a,Oe]),ws=t.useMemo(()=>{const o=new Set(Ke.filter(A=>!A.hidden).flatMap(A=>A.nodeIds||[]));return R.map(A=>{const L=o.has(A.id),X=L?!1:a?!0:Fs(A);return{...A,draggable:A.draggable!==!1,connectable:L?!1:A.connectable!==!1,data:{...A.data,_canEdit:X,_isGrouped:L,_currentUserId:y,_isSharedWorkflow:w}}})},[R,Ke,a,Fs,y,w,z]),Ft=t.useRef(null),ls=t.useRef(new Map),os=t.useCallback(o=>{if(C.current){O(o);return}const A=o.filter(X=>{var He;if(X.type!=="position")return!0;if(Ut.current.find(We=>{var rt;return!We.hidden&&((rt=We.nodeIds)==null?void 0:rt.includes(X.id))}))return a;if(a)return!0;const ye=ae.current.find(We=>We.id===X.id);if(!ye)return!0;const De=(He=ye.data)==null?void 0:He.createdBy;return(typeof De=="object"?De==null?void 0:De.id:De)===u.current});O(A);const L=A.filter(X=>X.type==="position"&&X.position);L.length>0&&(L.forEach(X=>{ls.current.set(X.id,X.position)}),Ft.current&&clearTimeout(Ft.current),Ft.current=setTimeout(()=>{const X=Array.from(ls.current.entries()).map(([Y,ye])=>({id:Y,position:ye}));X.length>0&&(Bt(X),ls.current.clear())},100))},[a,O,Bt]);t.useEffect(()=>{er.current=ks},[ks]),t.useEffect(()=>{const o=A=>{A.key==="Escape"&&(bs&&Ks(!1),Es&&$s(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,Es]),t.useEffect(()=>{tt&&(k(!1),E(!1),pr(),zs(),qr(),Kt().finally(()=>{E(!0)}))},[tt]),t.useEffect(()=>{if(!le&&!U&&R.length>0){const o=setTimeout(()=>{te({padding:.1,duration:800,maxZoom:1.5}),k(!0)},100);return()=>clearTimeout(o)}},[le,U,R.length,te]),t.useEffect(()=>{var X;if(!Oe||!be||!we||!yt)return;const o=Ke.find(Y=>Y.scene===oe&&Y.shot===ee),A=`${oe}-${ee}`;if(o){ms(o.id),wt(o.id);try{if(j.current===A)return;if(Array.isArray(pe)&&pe.length>0){j.current=A;const Y=R,ye=[],De=280,Le=320,He=350,We={role:0,scene:0,prop:0,audio:0};Y.forEach(Pe=>{var ft;if(Pe.type==="assetSelector"){const Gt=((ft=Pe.data)==null?void 0:ft.label)||"";Gt.startsWith("è§’è‰²")?We.role++:Gt.startsWith("åœºæ™¯")?We.scene++:Gt.startsWith("é“å…·")?We.prop++:Gt.startsWith("éŸ³é¢‘")&&We.audio++}});const rt={...We},Xe=[];pe.forEach((Pe,ft)=>{const Gt=Pe.thumbnail||Pe.url||"";let Mt=null;const Vt=Y.some(ot=>{var Lt,Qe;if(ot.type!=="assetSelector")return!1;const et=(Lt=ot.data)==null?void 0:Lt.config,ke=et==null?void 0:et.selectedAsset;if((ke==null?void 0:ke.id)===Pe.id)return Mt=ot.id,!0;const Je=((Qe=ot.data)==null?void 0:Qe.label)||"",St=Pe.type==="role"?"è§’è‰²":Pe.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${St}: ${Pe.name}`||(ke==null?void 0:ke.name)===Pe.name?(Mt=ot.id,!0):!1});if(Vt&&Mt&&Gt&&Xe.push({nodeId:Mt,newUrl:Gt}),Vt)return;const ht=Pe.type,mt=ht==="role"?0:ht==="scene"?1:ht==="prop"?2:3,jt=rt[ht]||0;rt[ht]=(rt[ht]||0)+1;const Ht={x:mt*De,y:He+jt*Le},ct=Pe.thumbnail||Pe.url||"",Fe=`assetSelector-${Date.now()}-${ft}`,it=ht==="role"?"è§’è‰²":ht==="scene"?"åœºæ™¯":ht==="prop"?"é“å…·":"éŸ³é¢‘",ut=Pe.metadata,at=ht==="role"&&(ut==null?void 0:ut.images);let Jt=[];if(at){const ot=ut.images;ot.frontUrl&&Jt.push({id:"front",url:ot.frontUrl,name:`${Pe.name}-æ­£é¢`}),ot.sideUrl&&Jt.push({id:"side",url:ot.sideUrl,name:`${Pe.name}-ä¾§é¢`}),ot.backUrl&&Jt.push({id:"back",url:ot.backUrl,name:`${Pe.name}-èƒŒé¢`}),ot.faceUrl&&Jt.push({id:"face",url:ot.faceUrl,name:`${Pe.name}-é¢éƒ¨`})}let Pt;at&&Jt.length>0?Pt={selectedInput:{id:Pe.id,name:Pe.name,coverUrl:ct,images:Jt}}:ht==="audio"?Pt={selectedAsset:{id:Pe.id,name:Pe.name,originalName:Pe.name,url:Pe.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:Pt={selectedAsset:{id:Pe.id,name:Pe.name,originalName:Pe.name,url:ct,type:"IMAGE",mimeType:"image/png",size:0}},ye.push({id:Fe,type:"assetSelector",position:Ht,data:{id:Fe,label:`${it}: ${Pe.name}`,config:Pt,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:o,nodeGroups:Ke}}})}),Xe.length>0&&$(Pe=>Pe.map(ft=>{var Mt;const Gt=Xe.find(Vt=>Vt.nodeId===ft.id);if(Gt&&ft.type==="assetSelector"){const Vt=((Mt=ft.data)==null?void 0:Mt.config)||{},ht=Vt.selectedAsset||{};return{...ft,data:{...ft.data,config:{...Vt,selectedAsset:{...ht,url:Gt.newUrl}}}}}return ft})),ye.length>0&&$(Pe=>[...Pe,...ye])}}catch{}return}if(j.current===A)return;const L={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${oe}å¹•-ç¬¬${ee}é•œ`,scene:oe,shot:ee,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};vt(Y=>[...Y,L]),Ut.current=[...Ut.current,L],ms(L.id),wt(L.id),j.current=A;try{const Y=((X=be==null?void 0:be.scriptJson)==null?void 0:X.acts)||[],ye=Array.isArray(Y)?Y.find(Fe=>Number(Fe.actIndex)===Number(oe)):null,De=ye?(ye.shots||[]).find(Fe=>Number(Fe.shotIndex)===Number(ee)):null,He=De?[`ç”»é¢ï¼š${(De.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(De["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(De["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(De["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(De.æ—¶é•¿||"").trim()}`].join(`
`):"",We=De&&(De.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,Pe=280,ft=320,Gt=350,Mt={x:0,y:0},Vt={x:rt+Xe,y:0},ht=`textPreview-${Date.now()}-a`,mt=`textPreview-${Date.now()}-b`,jt=[{id:ht,type:"textPreview",position:Mt,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:ht,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:L,nodeGroups:[...Ke,L]}}},{id:mt,type:"textPreview",position:Vt,data:{content:We||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:mt,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:L,nodeGroups:[...Ke,L]}}}],Ht=[];if(Array.isArray(pe)&&pe.length>0){const Fe={role:0,scene:0,prop:0,audio:0};pe.forEach((it,ut)=>{const at=it.type,Jt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,Pt=Fe[at]||0;Fe[at]=(Fe[at]||0)+1;const ot={x:Jt*Pe,y:Gt+Pt*ft},et=`assetSelector-${Date.now()}-${ut}`;Ht.push(et);const ke=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=it.thumbnail||it.url||"",St=it.metadata,Lt=at==="role"&&(St==null?void 0:St.images);let Qe=[];if(Lt){const xt=St.images;xt.frontUrl&&Qe.push({id:"front",url:xt.frontUrl,name:`${it.name}-æ­£é¢`}),xt.sideUrl&&Qe.push({id:"side",url:xt.sideUrl,name:`${it.name}-ä¾§é¢`}),xt.backUrl&&Qe.push({id:"back",url:xt.backUrl,name:`${it.name}-èƒŒé¢`}),xt.faceUrl&&Qe.push({id:"face",url:xt.faceUrl,name:`${it.name}-é¢éƒ¨`})}let Et;Lt&&Qe.length>0?Et={selectedInput:{id:it.id,name:it.name,coverUrl:Je,images:Qe}}:at==="audio"?Et={selectedAsset:{id:it.id,name:it.name,originalName:it.name,url:it.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:Et={selectedAsset:{id:it.id,name:it.name,originalName:it.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},jt.push({id:et,type:"assetSelector",position:ot,data:{id:et,label:`${ke}: ${it.name}`,config:Et,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:L,nodeGroups:[...Ke,L]}}})})}$(Fe=>[...Fe,...jt]);const ct=[ht,mt,...Ht];vt(Fe=>Fe.map(it=>{if(it.id!==L.id)return it;const ut=Array.from(new Set([...it.nodeIds||[],...ct])),at=it.bounds;return{...it,nodeIds:ut,bounds:at}})),Ut.current=Ut.current.map(Fe=>{if(Fe.id!==L.id)return Fe;const it=Array.from(new Set([...Fe.nodeIds||[],...ct])),ut=Fe.bounds;return{...Fe,nodeIds:it,bounds:ut}})}catch{}},[qe,oe,ee,be,we,Ke,$,yt,pe]),t.useEffect(()=>{if(we)if(qe&&be){const o=`${we.name} - ${be.name||`ç¬¬${be.episodeNumber}é›†`}`,A=oe&&ee?`ç¬¬${oe}å¹•ç¬¬${ee}é•œ`:"";Se(Oe?o:`${o} ${A}`.trim())}else Se(we.name);return()=>Se("")},[we,be,qe,Oe,oe,ee,Se]),t.useEffect(()=>{if(!(!tt||le||C.current))return lt.current&&clearTimeout(lt.current),lt.current=setTimeout(()=>{ps()},2e3),()=>{lt.current&&clearTimeout(lt.current)}},[R,g,Ke]);const Kt=async()=>{var o,A,L,X,Y,ye;try{let De;if(fe&&F)De=await _e.workflows.getById(F);else if(Oe)De=await _e.workflows.getOrCreateByShot(S,l,oe,ee);else if(qe)De=await _e.workflows.getOrCreateByEpisode(S,l);else{if(!s)return;De=await _e.workflows.getOrCreateByProject(s)}const Le=De.data;Le.canEdit===!1||Le.canEdit===void 0&&Le.isOwner===!1?(P(!0),C.current=!0,(o=Le.shareInfo)!=null&&o.owner&&r(Le.shareInfo.owner)):(P(!1),C.current=!1,r(null)),Le.currentUserId&&(p(Le.currentUserId),u.current=Le.currentUserId);const We=Le.isOwner!==!1||Oe&&Le.canEdit===!0;v(We);const rt=fe||Le.hasCollaborators===!0;if(f(rt),N.current=Le.id,fe&&ue({id:Le.projectId||F,name:Le.name||"å…±äº«å·¥ä½œæµ",description:Le.description,type:"QUICK",status:"DRAFT"}),Le.data){const{nodes:Xe,edges:Pe,nodeGroups:ft}=Le.data;if(ft&&ft.length>0&&(vt(ft),Ut.current=ft),Xe&&Xe.length>0){let Gt=Xe;if(Oe&&((A=be==null?void 0:be.scriptJson)!=null&&A.acts))try{const jt=be.scriptJson.acts.find(Fe=>Number(Fe.actIndex)===Number(oe)),Ht=(L=jt==null?void 0:jt.shots)==null?void 0:L.find(Fe=>Number(Fe.shotIndex)===Number(ee)),ct=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(Fe=>{Fe.nodeId&&ct.add(Fe.nodeId)}),(X=Ht.media)!=null&&X.nodeId&&ct.add(Ht.media.nodeId)),Gt=Xe.map(Fe=>{var it;return Fe.type==="videoPreview"&&((it=Fe.data)!=null&&it.addedToStoryboard)&&!ct.has(Fe.id)?{...Fe,data:{...Fe.data,addedToStoryboard:!1}}:Fe})}catch{}let Mt;if(Oe&&((Y=be==null?void 0:be.scriptJson)!=null&&Y.acts))try{const jt=be.scriptJson.acts.find(ct=>Number(ct.actIndex)===Number(oe)),Ht=(ye=jt==null?void 0:jt.shots)==null?void 0:ye.find(ct=>Number(ct.shotIndex)===Number(ee));Mt=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Vt=new Set((ft||[]).filter(mt=>!mt.hidden).flatMap(mt=>mt.nodeIds||[])),ht=Gt.map(mt=>{const jt=ft?ft.find(Fe=>Fe.nodeIds.includes(mt.id)):null,Ht=n.length>0?n:mt.data.models||[],ct=mt.type==="agent"&&Mt?{...mt.data,output:Mt,lastOutput:Mt}:mt.data;return{...mt,data:{...ct,models:Ht,onOpenAssetPanel:mt.type==="assetSelector"?mt.data.onOpenAssetPanel||ar:mt.data.onOpenAssetPanel,workflowContext:{project:we,episode:be,nodeGroup:jt,nodeGroups:ft||[]}},draggable:mt.draggable!==!1,connectable:Vt.has(mt.id)?!1:mt.connectable!==!1,deletable:Vt.has(mt.id)?!1:mt.deletable!==!1}});$(ht)}if(Pe&&Pe.length>0){const Gt=new Set(Xe.map(ht=>ht.id)),Mt=new Map(Xe.map(ht=>[ht.id,ht.type])),Vt=Pe.filter(ht=>{if(!Gt.has(ht.source)||!Gt.has(ht.target))return!1;const mt=Mt.get(ht.target),jt=Mt.get(ht.source);return!(mt==="midjourney"&&ht.targetHandle==="text-input"&&jt!=="agent")}).map(ht=>({...ht,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:ht.targetHandle||void 0}));m(Vt)}}}catch{}};t.useEffect(()=>{n.length>0&&R.length>0&&$(o=>o.map(A=>({...A,data:{...A.data,models:n},draggable:A.draggable!==void 0?A.draggable:!0,deletable:A.deletable!==void 0?A.deletable:!0})))},[n,R.length]),t.useEffect(()=>{if(!we&&!be||R.length===0)return;if(R.some(A=>{var De,Le;const L=A.data.workflowContext,X=((De=L==null?void 0:L.project)==null?void 0:De.id)!==(we==null?void 0:we.id),Y=((Le=L==null?void 0:L.episode)==null?void 0:Le.id)!==(be==null?void 0:be.id),ye=(L==null?void 0:L.nodeGroups)!==Ut.current;return!L||X||Y||ye})){const A=oe&&ee&&Ut.current.find(L=>L.scene===oe&&L.shot===ee)||null;$(L=>L.map(X=>{const Y=Ut.current.find(De=>De.nodeIds.includes(X.id))||null,ye=A||Y;return{...X,data:{...X.data,workflowContext:{project:we,episode:be,nodeGroup:ye,nodeGroups:Ut.current}}}}))}},[we,be,oe,ee,R.length,Ke]);const Yt=async(o,A,L)=>{var X;if(!(!S||!l))try{const Y=o.find(We=>We.type==="agent");if(!Y)return;const ye=((X=Y.data)==null?void 0:X.output)||"",Le=(await _e.episodes.getById(S,l)).scriptJson;if(!Le||!Le.acts)return;const He=Le.acts.map(We=>{var rt;return We.actIndex===A?{...We,shots:(rt=We.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===L&&Xe.æç¤ºè¯!==ye?{...Xe,æç¤ºè¯:ye}:Xe)}:We});await _e.episodes.update(S,l,{scriptJson:{acts:He}})}catch{}},Cs=async()=>{if(!(z||C.current)&&!(ae.current.length===0&&Me.current.length===0))try{const o=ae.current.map(L=>{const{data:X,...Y}=L,{workflowContext:ye,_canEdit:De,_currentUserId:Le,...He}=X||{};return{...Y,data:He}}),A=Me.current.map(L=>({id:L.id,source:L.source,target:L.target,sourceHandle:L.sourceHandle,targetHandle:L.targetHandle,type:L.type}));if(Oe){await _e.workflows.saveShot(S,l,oe,ee,{nodes:o,edges:A,nodeGroups:Ut.current,viewport:{x:0,y:0,zoom:1}});try{await Yt(ae.current,oe,ee)}catch{}}else qe?await _e.workflows.saveEpisode(S,l,{nodes:o,edges:A,nodeGroups:Ut.current,viewport:{x:0,y:0,zoom:1}}):fe&&F?await _e.workflows.update(F,{data:{nodes:o,edges:A,nodeGroups:Ut.current,viewport:{x:0,y:0,zoom:1}}}):s&&await _e.workflows.save(s,{nodes:o,edges:A,nodeGroups:Ut.current,viewport:{x:0,y:0,zoom:1}})}catch{}},ys=t.useRef(null),ps=t.useCallback(()=>{ys.current&&clearTimeout(ys.current),ys.current=setTimeout(()=>{Cs()},2e3)},[]);t.useEffect(()=>{const o=A=>{if(C.current)return;lt.current&&clearTimeout(lt.current);const X=A.detail;X!=null&&X.nodeId&&(X!=null&&X.config)&&(ae.current=ae.current.map(Y=>{var ye;return Y.id===X.nodeId?{...Y,data:{...Y.data,config:{...((ye=Y.data)==null?void 0:ye.config)||{},...X.config}}}:Y})),setTimeout(()=>{Cs()},100)};return window.addEventListener("workflow:save",o),()=>{window.removeEventListener("workflow:save",o)}},[]),t.useEffect(()=>{if(we||be){let o=Ut.current;Oe&&oe&&ee&&(o=Ut.current.filter(A=>A.scene===oe&&A.shot===ee)),window.__workflowContext={project:we,episode:be,nodeGroups:o}}},[we,be,Ke,Oe,oe,ee]);const pr=async()=>{try{if(fe){window.__workflowContext={project:null,episode:null,nodeGroups:Ut.current};return}if(qe){const[o,A]=await Promise.all([_e.episodes.getById(S,l),_e.projects.getById(S)]);Ee(o.data),ue(A.data);let L=Ut.current;Oe&&oe&&ee&&(L=Ut.current.filter(X=>X.scene===oe&&X.shot===ee)),window.__workflowContext={project:A.data,episode:o.data,nodeGroups:L}}else{const o=await _e.projects.getById(s);ue(o.data);let A=Ut.current;Oe&&oe&&ee&&(A=Ut.current.filter(L=>L.scene===oe&&L.shot===ee)),window.__workflowContext={project:o.data,episode:null,nodeGroups:A}}}catch{h.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),T("/quick")}finally{re(!1)}},zs=async()=>{try{const o=await _e.get("/ai/models",{params:{isActive:"true"}});G(o||[])}catch{}};t.useEffect(()=>{$(o=>o.map(A=>{const L=String(A.type||"");return!L.startsWith("aiVideo")&&L!=="audioVoice"&&L!=="voiceClone"&&L!=="audioSynthesize"&&L!=="audioDesign"?A:{...A,data:{...A.data,models:n}}}))},[n,$]);const qr=async()=>{try{const A=(await _e.agents.getAll()).filter(L=>L.isActive&&(!L.usageScene||L.usageScene==="workflow"));V(A)}catch{}};t.useEffect(()=>{$(o=>o.map(A=>{var Le,He,We,rt,Xe;if(A.type!=="agent")return A;const L=(He=(Le=A.data)==null?void 0:Le.config)==null?void 0:He.agentId,X=M.find(Pe=>Pe.id===L),Y=X==null?void 0:X.aiModelId,ye=n.find(Pe=>Pe.id===Y);let De=(We=ye==null?void 0:ye.config)==null?void 0:We.acceptedInputs;if((!De||De.length===0)&&ye){const Pe=(ye.provider||"").toLowerCase(),ft=(ye.name||"").toLowerCase();(Pe.includes("google")||ft.includes("gemini"))&&(De=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(De)&&De.length>0){const Pe=(Xe=(rt=A.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,ft=Gt=>Gt.map(Mt=>Mt.toUpperCase()).sort().join(",");if(!Pe||ft(Pe)!==ft(De))return{...A,data:{...A.data,config:{...A.data.config,acceptedInputs:De}}}}return A}))},[M,n,$]);const Kr=t.useCallback(o=>{var Le,He,We,rt,Xe,Pe,ft,Gt,Mt,Vt,ht,mt,jt,Ht,ct,Fe,it;es.current=!1;const A=Ut.current.some(ut=>{var at;return!ut.hidden&&((at=ut.nodeIds)==null?void 0:at.includes(o.source||""))}),L=Ut.current.some(ut=>{var at;return!ut.hidden&&((at=ut.nodeIds)==null?void 0:at.includes(o.target||""))});if(A||L){h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),es.current=!1;return}const X=R.find(ut=>ut.id===o.source),Y=R.find(ut=>ut.id===o.target);if(X&&Y){const ut=Pt=>{var ke,Je,St;const ot=Pt.type,et=Pt.data;if(ot==="upload"&&Array.isArray((ke=et.config)==null?void 0:ke.uploadedFiles)&&et.config.uploadedFiles.length>0){const Lt=et.config.uploadedFiles,Qe=Lt.some(_t=>{const Qt=((_t==null?void 0:_t.type)||"").toUpperCase(),vs=((_t==null?void 0:_t.mimeType)||"").toLowerCase();return Qt==="VIDEO"||vs.startsWith("video/")}),Et=Lt.some(_t=>{const Qt=((_t==null?void 0:_t.type)||"").toUpperCase(),vs=((_t==null?void 0:_t.mimeType)||"").toLowerCase();return Qt==="IMAGE"||vs.startsWith("image/")}),xt=Lt.some(_t=>{const Qt=((_t==null?void 0:_t.type)||"").toUpperCase(),vs=((_t==null?void 0:_t.mimeType)||"").toLowerCase();return Qt==="AUDIO"||vs.startsWith("audio/")});return(Y==null?void 0:Y.type)==="aiVideo_swap"?Qe?"VIDEO":Et?"IMAGE":xt?"AUDIO":null:Et?"IMAGE":Qe?"VIDEO":xt?"AUDIO":null}if(ot==="assetSelector"){if((Je=et.config)!=null&&Je.subjects)return"IMAGE";if((St=et.config)!=null&&St.selectedAsset){const Lt=et.config.selectedAsset,Qe=(Lt.type||"").toUpperCase(),Et=(Lt.mimeType||"").toLowerCase();return Qe==="IMAGE"||Et.startsWith("image/")?"IMAGE":Qe==="VIDEO"||Et.startsWith("video/")?"VIDEO":Qe==="AUDIO"||Et.startsWith("audio/")?"AUDIO":Qe||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=ut(X);let Jt=(Le=Y.data.config)==null?void 0:Le.acceptedInputs;if(Y.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const Pt={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${Pt[at]||at}è¾“å…¥`),es.current=!1;return}if((!Jt||Jt.length===0)&&Y.data.type==="agent"){const Pt=(He=Y.data.config)==null?void 0:He.agentId,ot=M.find(St=>St.id===Pt),et=ot==null?void 0:ot.aiModelId,ke=n.find(St=>St.id===et),Je=(We=ke==null?void 0:ke.config)==null?void 0:We.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)Jt=Je;else{const St=((rt=ke==null?void 0:ke.provider)==null?void 0:rt.toLowerCase())||"",Lt=((ke==null?void 0:ke.name)||"").toLowerCase();(St.includes("google")||Lt.includes("gemini"))&&(Jt=["TEXT","IMAGE","DOCUMENT"])}}if(Y.type!=="agent"){if(!Y.type.startsWith("aiVideo")&&Jt&&Jt.length>0&&at){const Pt=Jt.map(et=>typeof et=="string"?et.toUpperCase():et),ot=typeof at=="string"?at.toUpperCase():at;if(!Pt.includes(ot)){const et={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};h.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${et[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${Pt.map(ke=>et[ke]||ke).join("ã€")}ï¼‰`),es.current=!1;return}}}if(Y.type==="aiVideo_swap"){const Pt=g.filter(St=>St.target===Y.id),ot=Pt.filter(St=>{const Lt=R.find(Et=>Et.id===St.source);return ut(Lt)==="VIDEO"}).length,et=Pt.filter(St=>{const Lt=R.find(Et=>Et.id===St.source);return ut(Lt)==="IMAGE"}).length,ke=ot+(at==="VIDEO"?1:0),Je=et+(at==="IMAGE"?1:0);if(ke>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){h.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),es.current=!1;return}}if(Y.type==="aiVideo_lipsync"){const Pt=g.filter(Lt=>Lt.target===Y.id),ot=Pt.filter(Lt=>{const Qe=R.find(xt=>xt.id===Lt.source);return ut(Qe)==="VIDEO"}).length,et=Pt.filter(Lt=>{const Qe=R.find(xt=>xt.id===Lt.source);return ut(Qe)==="AUDIO"}).length,ke=ot+(at==="VIDEO"?1:0),Je=et+(at==="AUDIO"?1:0),St=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ke>1||Je>1||!St){h.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),es.current=!1;return}}if(Y.type.startsWith("aiVideo")&&Y.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(et=>{const ke=(et||"").toLowerCase().replace(/[_\-\s]+/g," ");return ke?ke.includes("æ–‡ç”Ÿ")||ke.includes("text to video")||ke.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")||ke.includes("first last")||ke.includes("two frame")||ke.includes("frame pair")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")||ke.includes("first frame")||ke.includes("start frame")||ke.includes("initial frame")||ke.includes("keyframe")?"é¦–å¸§":ke.includes("å°¾å¸§")||ke.includes("last frame")||ke.includes("end frame")||ke.includes("final frame")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")||ke.includes("subject reference")||ke.includes("å‚è€ƒ")||ke.includes("reference image")||ke.includes("image reference")||ke.includes("ref image")?"å‚è€ƒå›¾":et||"":""})((Pe=(Xe=Y.data)==null?void 0:Xe.config)==null?void 0:Pe.generationType);if(Y.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){h.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),es.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&X.type==="assetSelector"){const et=((ft=X.data)==null?void 0:ft.config)||{};if(et.subjects&&et.subjects.length>0&&(et.subjects[0].images||[]).length>1){h.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),es.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&X.type==="assetSelector"){const et=((Gt=X.data)==null?void 0:Gt.config)||{};if(et.subjects&&et.subjects.length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),es.current=!1;return}}}if(Y.type==="aiVideo_style"){const et=g.filter(ke=>ke.target===Y.id).filter(ke=>{const Je=R.find(Lt=>Lt.id===ke.source);return ut(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){h.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),es.current=!1;return}if(et>1){h.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),es.current=!1;return}}if(Y.type.startsWith("aiVideo")&&at==="TEXT"&&g.filter(et=>et.target===Y.id).find(et=>{const ke=R.find(Je=>Je.id===et.source);return(ke==null?void 0:ke.type)==="agent"})){h.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),es.current=!1;return}if(Y.type==="aiImage"){if(at==="TEXT"){if(g.filter(et=>et.target===Y.id).some(et=>{const ke=R.find(Je=>Je.id===et.source);return(ke==null?void 0:ke.type)==="agent"})){h.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),es.current=!1;return}}else if(at==="IMAGE"){const ot=g.filter(Qe=>Qe.target===Y.id).reduce((Qe,Et)=>{var Qt,vs,ss,Ms,As,Dr,Pr;const xt=R.find(ds=>ds.id===Et.source),_t=(xt==null?void 0:xt.type)||"";if(_t==="upload"){const ds=((ss=(vs=(Qt=xt==null?void 0:xt.data)==null?void 0:Qt.config)==null?void 0:vs.uploadedFiles)==null?void 0:ss[0])||null,fa=((ds==null?void 0:ds.type)||"").toUpperCase(),ma=((ds==null?void 0:ds.mimeType)||"").toLowerCase();return Qe+(fa==="IMAGE"||ma.startsWith("image/")?1:0)}if(_t==="assetSelector"){const ds=((Ms=xt==null?void 0:xt.data)==null?void 0:Ms.config)||{};return ds.selectedAsset&&(Qe+=(ds.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ds.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(ds.subjects)&&ds.subjects.length>0?Qe+((ds.subjects[0].images||[]).length||0):Qe}if(_t==="aiImage"){const ds=(Dr=(As=xt==null?void 0:xt.data)==null?void 0:As.config)==null?void 0:Dr.generatedImageUrl;return Qe+(ds?1:0)}if(_t==="imagePreview"){const ds=(Pr=xt==null?void 0:xt.data)==null?void 0:Pr.imageUrl;return Qe+(ds?1:0)}return Qe},0);let et=1;if(X.type==="assetSelector"){const Qe=((Mt=X==null?void 0:X.data)==null?void 0:Mt.config)||{};Qe.selectedAsset?et=(Qe.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Qe.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Qe.subjects)&&Qe.subjects.length>0&&(et=(Qe.subjects[0].images||[]).length||0)}else if(X.type==="upload"){const Qe=((mt=(ht=(Vt=X==null?void 0:X.data)==null?void 0:Vt.config)==null?void 0:ht.uploadedFiles)==null?void 0:mt[0])||null,Et=((Qe==null?void 0:Qe.type)||"").toUpperCase(),xt=((Qe==null?void 0:Qe.mimeType)||"").toLowerCase();et=Et==="IMAGE"||xt.startsWith("image/")?1:0}else X.type==="aiImage"?et=((Ht=(jt=X==null?void 0:X.data)==null?void 0:jt.config)==null?void 0:Ht.generatedImageUrl)?1:0:X.type==="imagePreview"&&(et=((ct=X==null?void 0:X.data)==null?void 0:ct.imageUrl)?1:0);const ke=(it=(Fe=Y==null?void 0:Y.data)==null?void 0:Fe.config)==null?void 0:it.modelId,Je=n.find(Qe=>Qe.id===ke),St=(Je==null?void 0:Je.config)||{},Lt=St.maxReferenceImages||St.supportedReferenceImagesLimit||St.referenceImagesLimit||10;if(ot+et>Lt){h.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Lt}å¼ ï¼‰`),es.current=!1;return}}}}try{const ut=R.find(ot=>ot.id===o.target),at=R.find(ot=>ot.id===o.source),Jt=ot=>{var ke,Je,St,Lt;if(!ot)return null;const et=String(ot.type||"").toLowerCase();if(et==="upload"){const Qe=(((Je=(ke=ot.data)==null?void 0:ke.config)==null?void 0:Je.uploadedFiles)||[]).find(Et=>{const xt=((Et==null?void 0:Et.type)||"").toUpperCase(),_t=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return xt==="AUDIO"||_t.startsWith("audio/")});return(Qe==null?void 0:Qe.url)||null}if(et==="assetSelector"){const Qe=(Lt=(St=ot.data)==null?void 0:St.config)==null?void 0:Lt.selectedAsset,Et=((Qe==null?void 0:Qe.type)||"").toUpperCase(),xt=((Qe==null?void 0:Qe.mimeType)||"").toLowerCase();if(Et==="AUDIO"||xt.startsWith("audio/"))return(Qe==null?void 0:Qe.url)||null}return null};if(String((ut==null?void 0:ut.type)||"")==="audioVoice"){const ot=Jt(at);ot&&$(et=>et.map(ke=>ke.id===ut.id?{...ke,data:{...ke.data,config:{...ke.data.config,audioUrl:ot}}}:ke))}}catch{}const De={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{m(ut=>Ia(De,ut)),rs(De)},0),xs.current=null,es.current=!0},[m,R,M,n,g,rs]),Yr=t.useCallback((o,A)=>{const L=Ut.current.some(Y=>{var ye;return!Y.hidden&&((ye=Y.nodeIds)==null?void 0:ye.includes(A.source))}),X=Ut.current.some(Y=>{var ye;return!Y.hidden&&((ye=Y.nodeIds)==null?void 0:ye.includes(A.target))});if(L||X){h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}m(Y=>Y.filter(ye=>ye.id!==A.id)),gs(A.id),h.success("å·²æ–­å¼€è¿æ¥")},[m,gs]),Nr=t.useCallback(o=>{var X,Y,ye,De,Le,He,We,rt,Xe,Pe,ft,Gt,Mt,Vt,ht;lt.current&&clearTimeout(lt.current);try{const mt=localStorage.getItem("suppressedPreviewTasks")||"[]",jt=JSON.parse(mt),Ht=Fe=>{jt.push(Fe)};for(const Fe of Array.isArray(o)?o:[])if((Fe==null?void 0:Fe.type)==="imagePreview"){const it=(Y=(X=Fe==null?void 0:Fe.data)==null?void 0:X.midjourneyData)==null?void 0:Y.sourceNodeId,ut=(De=(ye=Fe==null?void 0:Fe.data)==null?void 0:ye.midjourneyData)==null?void 0:De.taskId,at=(He=(Le=Fe==null?void 0:Fe.data)==null?void 0:Le.midjourneyData)==null?void 0:He.messageId;if(it||ut||at)Ht({sourceNodeId:it,taskId:ut,messageId:at});else{const Jt=Me.current.find(Pt=>Pt.target===Fe.id);if(Jt){const Pt=ae.current.find(et=>et.id===Jt.source),ot=(rt=(We=Pt==null?void 0:Pt.data)==null?void 0:We.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((Fe==null?void 0:Fe.type)==="videoPreview"){const it=Me.current.find(ut=>ut.target===Fe.id);if(it){const ut=ae.current.find(Jt=>Jt.id===it.source),at=(Pe=(Xe=ut==null?void 0:ut.data)==null?void 0:Xe.config)==null?void 0:Pe.taskId;at&&Ht({taskId:at})}}const ct=jt.slice(Math.max(0,jt.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(ct))}catch{}try{const mt=[];for(const jt of Array.isArray(o)?o:[]){const Ht=(Mt=(Gt=(ft=jt==null?void 0:jt.data)==null?void 0:ft.workflowContext)==null?void 0:Gt.project)==null?void 0:Mt.name;(jt==null?void 0:jt.type)==="imagePreview"&&((Vt=jt==null?void 0:jt.data)!=null&&Vt.imageUrl)?mt.push(_e.post("/assets/recycle/record",{url:jt.data.imageUrl,type:"IMAGE",projectName:Ht})):(jt==null?void 0:jt.type)==="videoPreview"&&((ht=jt==null?void 0:jt.data)!=null&&ht.videoUrl)&&mt.push(_e.post("/assets/recycle/record",{url:jt.data.videoUrl,type:"VIDEO",projectName:Ht}))}mt.length>0&&Promise.allSettled(mt).then(()=>{})}catch{}const A=Array.isArray(o)?o.length:0,L=Ge.current;setTimeout(()=>{const mt=ae.current.length,jt=Math.max(L-A,0);mt===jt&&Cs()},100)},[]),Qr=t.useCallback(o=>{const A=o.filter(X=>Ut.current.some(ye=>{var De;return!ye.hidden&&((De=ye.nodeIds)==null?void 0:De.includes(X.id))})?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(A.length===0)return;if(a){Nr(A),A.forEach(X=>qt(X.id));return}const L=A.filter(X=>{var De;const Y=(De=X.data)==null?void 0:De.createdBy;return(typeof Y=="object"?Y==null?void 0:Y.id:Y)===u.current});L.length>0&&(Nr(L),L.forEach(X=>qt(X.id)))},[a,Nr,qt]),Tr=t.useCallback(o=>{lt.current&&clearTimeout(lt.current),setTimeout(()=>{ps()},250)},[]),Zr=t.useCallback(o=>{const A=o.filter(L=>{if(L.type!=="remove")return!0;const X=Me.current.find(De=>De.id===L.id);if(!X)return!0;const Y=Ut.current.some(De=>{var Le;return!De.hidden&&((Le=De.nodeIds)==null?void 0:Le.includes(X.source))}),ye=Ut.current.some(De=>{var Le;return!De.hidden&&((Le=De.nodeIds)==null?void 0:Le.includes(X.target))});return Y||ye?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});_(A)},[_]),ea=t.useCallback(o=>{const A=o.filter(L=>{const X=Ut.current.some(ye=>{var De;return!ye.hidden&&((De=ye.nodeIds)==null?void 0:De.includes(L.source))}),Y=Ut.current.some(ye=>{var De;return!ye.hidden&&((De=ye.nodeIds)==null?void 0:De.includes(L.target))});return X||Y?(h.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});A.length>0&&(Tr(A),A.forEach(L=>gs(L.id)))},[Tr,gs]),ta=t.useCallback(o=>{if(o.preventDefault(),z)return;const A=200,L=400,X=10;let Y=o.clientX,ye=o.clientY;Y+A+X>window.innerWidth&&(Y=window.innerWidth-A-X),ye+L+X>window.innerHeight&&(ye=window.innerHeight-L-X),Y=Math.max(X,Y),ye=Math.max(X,ye),i({x:Y,y:ye})},[z]),hr=t.useCallback(()=>{i(null),ce(),B(!1)},[]),ar=t.useCallback(o=>{pt(o),Tt(!0)},[]);t.useEffect(()=>{R.length>0&&R.some(A=>A.type==="assetSelector"&&!A.data.onOpenAssetPanel)&&$(A=>A.map(L=>L.type==="assetSelector"&&!L.data.onOpenAssetPanel?{...L,data:{...L.data,onOpenAssetPanel:ar,models:L.data.models||n}}:L))},[R.length,ar,n]);const sa=t.useCallback(o=>{dt&&($(A=>A.map(X=>X.id===dt?{...X,data:{...X.data,config:{...X.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(Y=>Y.url)}],referenceImages:o.images.map(Y=>({id:Y.id,url:Y.url,name:Y.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:X)),Tt(!1),pt(null),h.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[dt,$]),Ur=o=>{const L={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",X=L==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:L==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:L==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:L==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],Y=n.filter(He=>He.type==="VIDEO_GENERATION"),ye=n.filter(He=>He.type==="VIDEO_EDITING"),De=He=>{const We=(He||"").toLowerCase();return We.includes("text")||We.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":We.includes("first-last")||We.includes("é¦–å°¾")?"é¦–å°¾å¸§":We.includes("first")||We.includes("é¦–å¸§")?"é¦–å¸§":We.includes("last")||We.includes("å°¾å¸§")?"å°¾å¸§":We.includes("å‚è€ƒ")?"å‚è€ƒå›¾":We.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Le=null;return L==="è§†é¢‘æ¢äºº"?Le=ye.find(He=>{var We;return Array.isArray((We=He==null?void 0:He.config)==null?void 0:We.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||Y.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Pe=>De(Pe)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):L==="å¯¹å£å‹"?Le=ye.find(He=>{var We;return Array.isArray((We=He==null?void 0:He.config)==null?void 0:We.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:L==="é£æ ¼è½¬æ¢"?Le=ye.find(He=>{var We;return Array.isArray((We=He==null?void 0:He.config)==null?void 0:We.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Le=Y.find(He=>{var rt;const We=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>De(Xe)):[];return L==="é¦–å¸§"||L==="å°¾å¸§"?We.includes("é¦–å¸§")||We.includes("å°¾å¸§"):We.includes(L)}),{modelId:Le==null?void 0:Le.id,modelName:Le==null?void 0:Le.name,generationType:L,lockedGenerationType:L,hideGenerationTypeSelector:!0,acceptedInputs:X}},ns=(o,A,L,X,Y,ye,De,Le)=>{if(!c)return;const He=Ae({x:c.x,y:c.y}),We=`${o}-${Date.now()}`,rt=ts?Ke.find(Mt=>Mt.id===ts)||null:Ke.find(Mt=>Mt.nodeIds.includes(We))||null,Xe=L==="aiImage"||L.startsWith("aiVideo")||L==="midjourney",Pe=L.startsWith("aiVideo")?Ur(L):{},ft=X?{agentId:X}:Pe;L.startsWith("aiVideo"),L.startsWith("aiVideo")&&Le&&Object.assign(ft,Le);const Gt={id:We,type:L,position:He,data:{label:Y||A,type:o,config:ft,models:n,isExpanded:Xe,onOpenAssetPanel:L==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:rt,nodeGroups:Ke}}};$(Mt=>[...Mt,Gt]),Ct(Gt),ts&&(vt(Mt=>Mt.map(Vt=>{if(Vt.id!==ts)return Vt;const ht=Array.from(new Set([...Vt.nodeIds||[],We])),mt=br(ht)||Vt.bounds;return{...Vt,nodeIds:ht,bounds:mt}})),Ut.current=Ut.current.map(Mt=>{if(Mt.id!==ts)return Mt;const Vt=Array.from(new Set([...Mt.nodeIds||[],We])),ht=br(Vt)||Mt.bounds;return{...Mt,nodeIds:Vt,bounds:ht}})),hr(),h.success(`å·²æ·»åŠ ${Y||A}èŠ‚ç‚¹`),L==="assetSelector"&&setTimeout(()=>{ar(Gt.id)},100)},[is,Ys]=t.useState(null),es=t.useRef(!1),xs=t.useRef(null),Qs=t.useMemo(()=>{var Le,He,We,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const A=is.handleType==="target",L=Xe=>{const Pe=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return Pe?Pe.includes("æ–‡ç”Ÿ")||Pe.includes("text to video")||Pe.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Pe.includes("é¦–å°¾")||Pe.includes("first last")||Pe.includes("two frame")||Pe.includes("frame pair")?"é¦–å°¾å¸§":Pe.includes("é¦–å¸§")||Pe.includes("first frame")||Pe.includes("start frame")||Pe.includes("initial frame")||Pe.includes("keyframe")?"é¦–å¸§":Pe.includes("å°¾å¸§")||Pe.includes("last frame")||Pe.includes("end frame")||Pe.includes("final frame")?"å°¾å¸§":Pe.includes("ä¸»ä½“å‚è€ƒ")||Pe.includes("subject reference")||Pe.includes("å‚è€ƒ")||Pe.includes("reference image")||Pe.includes("image reference")||Pe.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(A){const Xe=R.find(Vt=>Vt.id===is.sourceNodeId),Pe=(Xe==null?void 0:Xe.type)||"",ft=Pe.startsWith("aiVideo"),Gt=L((He=(Le=Xe==null?void 0:Xe.data)==null?void 0:Le.config)==null?void 0:He.generationType),Mt=Pe==="aiVideo_t2v"||Gt==="æ–‡ç”Ÿè§†é¢‘";if(Pe==="aiImage"){const Vt=g.filter(it=>it.target===(Xe==null?void 0:Xe.id)),ht=Vt.some(it=>{const ut=R.find(at=>at.id===it.source);return((ut==null?void 0:ut.type)||"")==="agent"}),mt=Vt.reduce((it,ut)=>{var Pt,ot,et,ke;const at=R.find(Je=>Je.id===ut.source),Jt=(at==null?void 0:at.type)||"";if(Jt==="upload"){const Je=((et=(ot=(Pt=at==null?void 0:at.data)==null?void 0:Pt.config)==null?void 0:ot.uploadedFiles)==null?void 0:et[0])||null,St=((Je==null?void 0:Je.type)||"").toUpperCase(),Lt=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return it+(St==="IMAGE"||Lt.startsWith("image/")?1:0)}if(Jt==="assetSelector"){const Je=((ke=at==null?void 0:at.data)==null?void 0:ke.config)||{};if(Je.selectedAsset)return it+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return it+((Je.subjects[0].images||[]).length||0)}return it},0),jt=(rt=(We=Xe==null?void 0:Xe.data)==null?void 0:We.config)==null?void 0:rt.modelId,Ht=n.find(it=>it.id===jt),ct=(Ht==null?void 0:Ht.config)||{},Fe=ct.maxReferenceImages||ct.supportedReferenceImagesLimit||ct.referenceImagesLimit||10;return ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=Fe?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(ft){const Vt=g.filter(Fe=>Fe.target===(Xe==null?void 0:Xe.id)),ht=Vt.some(Fe=>{const it=R.find(ut=>ut.id===Fe.source);return((it==null?void 0:it.type)||"")==="agent"}),mt=Vt.reduce((Fe,it)=>{var Jt,Pt,ot,et;const ut=R.find(ke=>ke.id===it.source),at=(ut==null?void 0:ut.type)||"";if(at==="aiImage"||at==="imagePreview")return Fe+1;if(at==="upload"){const ke=((ot=(Pt=(Jt=ut==null?void 0:ut.data)==null?void 0:Jt.config)==null?void 0:Pt.uploadedFiles)==null?void 0:ot[0])||null,Je=((ke==null?void 0:ke.type)||"").toUpperCase(),St=((ke==null?void 0:ke.mimeType)||"").toLowerCase();return Fe+(Je==="IMAGE"||St.startsWith("image/")?1:0)}if(at==="assetSelector"){const ke=((et=ut==null?void 0:ut.data)==null?void 0:et.config)||{};if(ke.selectedAsset)return Fe+((ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ke.subjects&&ke.subjects.length>0)return Fe+((ke.subjects[0].images||[]).length||0)}return Fe},0);return Mt?ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Pe==="aiVideo_i2v_first"||Pe==="aiVideo_i2v_last"||Gt==="é¦–å¸§"||Gt==="å°¾å¸§"?ht&&mt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Pe==="aiVideo_first_last"||Gt==="é¦–å°¾å¸§"?ht&&mt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Pe==="aiVideo_reference"||Gt==="å‚è€ƒå›¾"?ht&&mt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const X=R.find(Xe=>Xe.id===is.sourceNodeId),ye=(Xe=>{var Gt,Mt,Vt;if(!Xe)return null;const Pe=Xe.type,ft=Xe.data;if(Pe==="upload"&&Array.isArray((Gt=ft.config)==null?void 0:Gt.uploadedFiles)&&ft.config.uploadedFiles.length>0){const ht=ft.config.uploadedFiles;return ht.some(ct=>{const Fe=((ct==null?void 0:ct.type)||"").toUpperCase(),it=((ct==null?void 0:ct.mimeType)||"").toLowerCase();return Fe==="IMAGE"||it.startsWith("image/")})?"IMAGE":ht.some(ct=>{const Fe=((ct==null?void 0:ct.type)||"").toUpperCase(),it=((ct==null?void 0:ct.mimeType)||"").toLowerCase();return Fe==="VIDEO"||it.startsWith("video/")})?"VIDEO":ht.some(ct=>{const Fe=((ct==null?void 0:ct.type)||"").toUpperCase(),it=((ct==null?void 0:ct.mimeType)||"").toLowerCase();return Fe==="AUDIO"||it.startsWith("audio/")})?"AUDIO":null}if(Pe==="assetSelector"){if((Mt=ft.config)!=null&&Mt.subjects)return"IMAGE";if((Vt=ft.config)!=null&&Vt.selectedAsset){const ht=ft.config.selectedAsset,mt=(ht.type||"").toUpperCase(),jt=(ht.mimeType||"").toLowerCase();return mt==="IMAGE"||jt.startsWith("image/")?"IMAGE":mt==="VIDEO"||jt.startsWith("video/")?"VIDEO":mt==="AUDIO"||jt.startsWith("audio/")?"AUDIO":mt||null}}return Pe==="aiImage"||Pe==="imagePreview"||Pe==="midjourney"?"IMAGE":(Pe||"").startsWith("aiVideo")||Pe==="videoPreview"?"VIDEO":Pe==="agent"||Pe==="textPreview"?"TEXT":null})(X),De=X==null?void 0:X.type;return De==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:De==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ye==="TEXT",showAiImage:ye==="IMAGE"||ye==="TEXT",showAudio:ye==="AUDIO",showVideo:ye==="VIDEO"||ye==="IMAGE"||ye==="TEXT",showEdit:ye==="VIDEO",showImageEditing:ye==="IMAGE",showMidjourney:ye==="IMAGE"||ye==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ye==="IMAGE"}},[is,R,g,n]),ra=t.useCallback((o,{nodeId:A,handleType:L})=>{if(!A){xs.current=null;return}if(L==="target"){const X=R.find(ye=>ye.id===A),Y=(X==null?void 0:X.type)||"";if(Y==="agent"||Y==="aiImage"||Y==="midjourney"||Y.startsWith("aiVideo")){h.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),xs.current=null;return}}if(L==="source"){const X=R.find(Y=>Y.id===A);if(X&&(X.type==="aiImage"||X.type.startsWith("aiVideo"))){xs.current=null;return}}es.current=!1,xs.current={nodeId:A,handleType:L==="target"?"target":"source"},hr(),Ys(null)},[hr,R]),aa=t.useCallback(o=>{const A=xs.current;if(!A)return;let L=0,X=0;"changedTouches"in o&&o.changedTouches.length>0?(L=o.changedTouches[0].clientX,X=o.changedTouches[0].clientY):"clientX"in o&&(L=o.clientX,X=o.clientY),setTimeout(()=>{if(es.current){es.current=!1,xs.current=null;return}const Y=o.target,ye=!!Y&&!!Y.closest(".react-flow__pane"),De=!!Y&&(Y.closest(".react-flow__node")||Y.closest(".react-flow__handle"));if(!ye||De){es.current=!1,xs.current=null;return}Ys({x:L,y:X,sourceNodeId:A.nodeId,handleType:A.handleType}),es.current=!1},100),xs.current=null},[]),cs=(o,A,L,X,Y,ye)=>{var Gt,Mt,Vt,ht,mt,jt,Ht;if(!is)return;const De=Ae({x:is.x,y:is.y}),Le=`${L}-${Date.now()}`,He=R.find(ct=>ct.id===is.sourceNodeId),We=He?Ke.find(ct=>ct.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?Ur(o):{};let Pe={};X?Pe={agentId:X}:o.startsWith("aiVideo")?Pe=Xe:o==="smartStoryboard"?Pe={taskId:"",aspectRatio:"1:1",inputImages:[],userPrompt:""}:o==="hdUpscale"?Pe={taskId:"",imageSize:"4K"}:o==="imageFusion"&&(Pe={taskId:"",imageSize:"4K"}),o.startsWith("aiVideo")&&ye&&Object.assign(Pe,ye);const ft={id:Le,type:o,position:De,data:{label:Y||A,type:L,config:Pe,models:n,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:We,nodeGroups:Ke}}};if($(ct=>[...ct,ft]),We&&(vt(ct=>ct.map(Fe=>{if(Fe.id!==We.id)return Fe;const it=Array.from(new Set([...Fe.nodeIds,Le]));return{...Fe,nodeIds:it}})),Ut.current=Ut.current.map(ct=>{if(ct.id!==We.id)return ct;const Fe=Array.from(new Set([...ct.nodeIds,Le]));return{...ct,nodeIds:Fe}})),is.handleType==="source"){const ct=R.find(ke=>ke.id===is.sourceNodeId),Fe=ft,it=ke=>{const Je=(ke||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ke||"":""},ut=ke=>{var Lt,Qe,Et;const Je=ke.type,St=ke.data;if(Je==="upload"&&Array.isArray((Lt=St.config)==null?void 0:Lt.uploadedFiles)&&St.config.uploadedFiles.length>0){const xt=St.config.uploadedFiles,_t=xt.some(ss=>{const Ms=((ss==null?void 0:ss.type)||"").toUpperCase(),As=((ss==null?void 0:ss.mimeType)||"").toLowerCase();return Ms==="VIDEO"||As.startsWith("video/")}),Qt=xt.some(ss=>{const Ms=((ss==null?void 0:ss.type)||"").toUpperCase(),As=((ss==null?void 0:ss.mimeType)||"").toLowerCase();return Ms==="IMAGE"||As.startsWith("image/")}),vs=xt.some(ss=>{const Ms=((ss==null?void 0:ss.type)||"").toUpperCase(),As=((ss==null?void 0:ss.mimeType)||"").toLowerCase();return Ms==="AUDIO"||As.startsWith("audio/")});return(Fe==null?void 0:Fe.type)==="aiVideo_swap"?_t?"VIDEO":Qt?"IMAGE":vs?"AUDIO":null:Qt?"IMAGE":_t?"VIDEO":vs?"AUDIO":null}if(Je==="assetSelector"){if((Qe=St.config)!=null&&Qe.subjects)return"IMAGE";if((Et=St.config)!=null&&Et.selectedAsset){const xt=St.config.selectedAsset,_t=(xt.type||"").toUpperCase(),Qt=(xt.mimeType||"").toLowerCase();return _t==="IMAGE"||Qt.startsWith("image/")?"IMAGE":_t==="VIDEO"||Qt.startsWith("video/")?"VIDEO":_t==="AUDIO"||Qt.startsWith("audio/")?"AUDIO":_t||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ke=>{var St,Lt,Qe;if(ut(ke)!=="IMAGE")return 0;if(ke.type==="upload")return(((Lt=(St=ke.data)==null?void 0:St.config)==null?void 0:Lt.uploadedFiles)||[]).filter(xt=>xt.type==="IMAGE"||(xt.mimeType||"").startsWith("image/")).length;if(ke.type==="assetSelector"){const Et=((Qe=ke.data)==null?void 0:Qe.config)||{};return Et.subjects&&Et.subjects.length>0?(Et.subjects[0].images||[]).length:Et.selectedAsset&&Et.selectedAsset.type==="IMAGE"?1:0}return ke.type==="imagePreview"||ke.type==="aiImage",1},Jt=ke=>{var xt,_t,Qt,vs,ss,Ms;const Je=it((_t=(xt=ke.data)==null?void 0:xt.config)==null?void 0:_t.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const St=(vs=(Qt=ke.data)==null?void 0:Qt.config)==null?void 0:vs.modelId,Qe=(((ss=ke.data)==null?void 0:ss.models)||n).find(As=>As.id===St),Et=Array.isArray((Ms=Qe==null?void 0:Qe.config)==null?void 0:Ms.supportedGenerationTypes)?Qe.config.supportedGenerationTypes.map(As=>it(As)):[];return Et.includes("å‚è€ƒå›¾")||Et.includes("ä¸»ä½“å‚è€ƒ")?7:Et.includes("é¦–å°¾å¸§")?2:Et.includes("é¦–å¸§")||Et.includes("å°¾å¸§")?1:(Et.includes("æ–‡ç”Ÿè§†é¢‘"),0)},Pt=ct?ut(ct):null;if(Fe.type.startsWith("aiVideo")&&Pt==="IMAGE"){if(it((Mt=(Gt=Fe.data)==null?void 0:Gt.config)==null?void 0:Mt.generationType)==="é¦–å°¾å¸§"&&ct&&ct.type==="assetSelector"){const xt=((Vt=ct.data)==null?void 0:Vt.config)||{};if(xt.subjects&&(((ht=xt.subjects[0])==null?void 0:ht.images)||[]).length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),xs.current=null,es.current=!1;return}}const Je=g.filter(xt=>xt.target===Fe.id);let St=0;Je.forEach(xt=>{const _t=R.find(Qt=>Qt.id===xt.source);_t&&(St+=at(_t))});const Lt=ct?at(ct):0,Qe=Jt(Fe),Et=St+Lt;if(Qe===0){h.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ys(null),xs.current=null,es.current=!1;return}if(Et>Qe){h.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Qe}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${Et}å¼ ï¼‰`),Ys(null),xs.current=null,es.current=!1;return}}let ot;ft.type==="superCanvas"?ot="input-image":ft.type==="midjourney"&&(Pt==="IMAGE"?ot="omni-ref":Pt==="TEXT"&&(ot="text-input"));const et={id:`edge-${is.sourceNodeId}-${ft.id}`,source:is.sourceNodeId,target:ft.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};m(ke=>[...ke,et])}else if(is.handleType==="target"){const ct=R.find(et=>et.id===is.sourceNodeId),Fe=(ct==null?void 0:ct.type)||"";if(Fe==="agent"||Fe==="aiImage"||Fe==="midjourney"||Fe.startsWith("aiVideo")){h.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ys(null),xs.current=null,es.current=!1;return}const it=ft,ut=R.find(et=>et.id===is.sourceNodeId),at=et=>{const ke=(et||"").toLowerCase();return ke?ke.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")?"é¦–å¸§":ke.includes("å°¾å¸§")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ke.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ke.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("first-last")?"é¦–å°¾å¸§":ke.includes("first")?"é¦–å¸§":ke.includes("last")?"å°¾å¸§":ke.includes("subject")?"ä¸»ä½“å‚è€ƒ":ke.includes("reference")?"å‚è€ƒå›¾":et||"":""},Pt=(et=>{var St,Lt,Qe,Et;const ke=et.type,Je=et.data;if(ke==="upload"&&((Lt=(St=Je.config)==null?void 0:St.uploadedFiles)==null?void 0:Lt.length)>0){const xt=Je.config.uploadedFiles[0],_t=(xt.type||"").toUpperCase(),Qt=(xt.mimeType||"").toLowerCase();return _t==="IMAGE"||Qt.startsWith("image/")?"IMAGE":_t==="VIDEO"||Qt.startsWith("video/")?"VIDEO":_t==="AUDIO"||Qt.startsWith("audio/")?"AUDIO":_t||null}if(ke==="assetSelector"){if((Qe=Je.config)!=null&&Qe.subjects)return"IMAGE";if((Et=Je.config)!=null&&Et.selectedAsset){const xt=Je.config.selectedAsset,_t=(xt.type||"").toUpperCase(),Qt=(xt.mimeType||"").toLowerCase();return _t==="IMAGE"||Qt.startsWith("image/")?"IMAGE":_t==="VIDEO"||Qt.startsWith("video/")?"VIDEO":_t==="AUDIO"||Qt.startsWith("audio/")?"AUDIO":_t||null}}return ke==="aiImage"||ke==="imagePreview"?"IMAGE":ke==="aiVideo"||ke==="videoPreview"?"VIDEO":ke==="agent"?"TEXT":null})(it);if(ut&&ut.type==="aiVideo"&&Pt==="IMAGE"&&at((jt=(mt=ut.data)==null?void 0:mt.config)==null?void 0:jt.generationType)==="é¦–å°¾å¸§"&&it&&it.type==="assetSelector"){const ke=((Ht=it.data)==null?void 0:Ht.config)||{};if(ke.subjects&&ke.subjects.length>0){h.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),xs.current=null,es.current=!1;return}}const ot={id:`edge-${ft.id}-${is.sourceNodeId}`,source:ft.id,sourceHandle:ft.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};m(et=>[...et,ot])}Ys(null),xs.current=null,es.current=!1,h.success(`å·²æ·»åŠ ${A}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(ft.id)},100)},br=t.useCallback(o=>{const A=R.filter(Le=>o.includes(Le.id));if(A.length===0)return null;const L=50;let X=1/0,Y=1/0,ye=-1/0,De=-1/0;return A.forEach(Le=>{const He=Le.position.x,We=Le.position.y,rt=Le.width||320,Xe=Le.height||200;X=Math.min(X,He),Y=Math.min(Y,We),ye=Math.max(ye,He+rt),De=Math.max(De,We+Xe)}),{x:X-L,y:Y-L,width:ye-X+L*2,height:De-Y+L*2}},[R]),oa=t.useCallback(()=>{$s(o=>!o),Ks(!1)},[]),Rr=t.useCallback((o,A)=>{const L={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:A-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0}};$(X=>[...X,L]),$s(!1)},[$,ie]),na=t.useCallback(()=>{if(!a){h.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=R.filter(ye=>ye.selected);if(o.length===0){h.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){h.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const A=o.map(ye=>ye.id);if(Ke.some(ye=>ye.nodeIds.some(De=>A.includes(De)))){h.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const X=br(A);if(!X){h.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const Y={id:`group-${Date.now()}`,nodeIds:A,bounds:X};vt(ye=>{const De=[...ye,Y];return Ws(De),setTimeout(()=>{ps()},100),De}),wt(Y.id),$(ye=>{const De=new Set;return g.forEach(Le=>{if(A.includes(Le.source)){const He=ye.find(We=>We.id===Le.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&De.add(Le.target)}}),ye.map(Le=>A.includes(Le.id)?{...Le,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Le.data,workflowContext:{...Le.data.workflowContext,nodeGroup:Y,nodeGroups:[...Ke,Y]}}}:De.has(Le.id)?{...Le,data:{...Le.data,workflowContext:{...Le.data.workflowContext,nodeGroup:Y,nodeGroups:[...Ke,Y]}}}:Le)}),h.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${A.length} ä¸ªèŠ‚ç‚¹`)},[R,br,Ke,$]),ia=t.useCallback(()=>{if(!a){h.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!ze){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ke.find(A=>A.id===ze);o&&($(A=>A.map(L=>o.nodeIds.includes(L.id)?{...L,draggable:!0,connectable:!0,deletable:!0,data:{...L.data,workflowContext:{...L.data.workflowContext,nodeGroup:null,nodeGroups:Ke.filter(X=>X.id!==ze)}}}:L)),vt(A=>{const L=A.filter(X=>X.id!==ze);return Ws(L),setTimeout(()=>{ps()},100),L}),wt(null),h.success("å·²è§£é™¤ç¼–ç»„"))},[ze,Ke,$,Ws]),la=t.useCallback(()=>{if(!ze){h.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Gs(ze),Is(!0)},[ze]),$r=t.useCallback((o,A)=>{o.stopPropagation(),o.preventDefault(),js(null),wt(A),nr(null)},[]);t.useEffect(()=>{if(!ks||!qs)return;let o=qs.x,A=qs.y;const L=Y=>{const ye=er.current;if(!ye)return;const De=Z(),Le=(Y.clientX-o)/De.zoom,He=(Y.clientY-A)/De.zoom;if(Math.abs(Le)<.01&&Math.abs(He)<.01)return;const We=Ut.current.find(rt=>rt.id===ye);We&&(vt(rt=>rt.map(Xe=>Xe.id===ye?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Le,y:Xe.bounds.y+He}}:Xe)),$(rt=>rt.map(Xe=>We.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Le,y:Xe.position.y+He}}:Xe)),o=Y.clientX,A=Y.clientY)},X=()=>{js(null),nr(null)};return document.addEventListener("mousemove",L),document.addEventListener("mouseup",X),()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",X)}},[ks,qs]);const ca=t.useCallback(o=>{if(Es){const A=Ae({x:o.clientX,y:o.clientY});Rr(A.x,A.y);return}hr(),Ys(null),xs.current=null,wt(null),es.current=!1},[hr,Es,Ae,Rr]),jr=t.useRef(null),da=t.useCallback(()=>{Ke.length>0&&!jr.current&&(jr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),jr.current=null}))},[Ke.length]),ir=t.useCallback(o=>Ke.find(A=>A.nodeIds.includes(o))||null,[Ke]),ua=t.useCallback((o,A)=>{var X;if(bt||(X=A==null?void 0:A.data)!=null&&X.freeDrag)return;const L=ir(A.id);if(L){if(!L.hidden&&!a)return;Vs.current=A.id,K.current={x:A.position.x,y:A.position.y}}},[ir,a]),ga=t.useCallback((o,A)=>{var Y;if(bt||(Y=A==null?void 0:A.data)!=null&&Y.freeDrag||!K.current||Vs.current!==A.id)return;const L=ir(A.id);if(!L)return;const X=!L.hidden;if(!(X&&!a))if(X){const ye=A.position.x-K.current.x,De=A.position.y-K.current.y,Le=[],He=L.nodeIds||[];ae.current.forEach(We=>{if(He.includes(We.id)){const rt={x:We.id===A.id?A.position.x:We.position.x+ye,y:We.id===A.id?A.position.y:We.position.y+De};Le.push({id:We.id,position:rt})}}),$(We=>We.map(rt=>{const Xe=Le.find(Pe=>Pe.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Le.length>0&&Bt(Le),vt(We=>{const rt=We.map(Xe=>Xe.id===L.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ye,y:Xe.bounds.y+De}}:Xe);return Ut.current=rt,rt}),K.current={x:A.position.x,y:A.position.y}}else{const ye=L.bounds.x,De=L.bounds.y,Le=L.bounds.width,He=L.bounds.height,We=(Pe,ft,Gt)=>Math.max(ft,Math.min(Pe,Gt)),rt=We(A.position.x,ye+10,ye+Le-10),Xe=We(A.position.y,De+10,De+He-10);$(Pe=>Pe.map(ft=>ft.id===A.id?{...ft,position:{x:rt,y:Xe}}:ft)),K.current={x:rt,y:Xe}}},[$,vt,ir,a,Bt]),pa=t.useCallback(()=>{Vs.current=null,K.current=null,er.current=null,Vs.current=null,K.current=null,er.current=null,js(null),Ut.current.length>0&&Ws(Ut.current)},[Ws]),ha=t.useCallback((o,A)=>{const L=ir(A.id);L&&wt(L.id)},[ir]);if(t.useEffect(()=>{if(g.length===0||R.length===0)return;const o=g.filter(A=>{const L=R.find(Y=>Y.id===A.source),X=R.find(Y=>Y.id===A.target);return(X==null?void 0:X.type)==="midjourney"&&A.targetHandle==="text-input"&&(L==null?void 0:L.type)!=="agent"});o.length>0&&(m(A=>A.filter(L=>!o.some(X=>X.id===L.id))),h.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[g,R,m]),le)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!we)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Mr=R.filter(o=>o.selected).length>=2,wr=!!ze;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:Nt,className:"flex-1 relative overflow-hidden",children:[z&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:W?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${W.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),we&&e.jsx("div",{className:`absolute left-1/2 -translate-x-1/2 ${z?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&be?`${we.name} ç¬¬${be.episodeNumber}é›†${!Oe&&oe&&ee?` ç¬¬${oe}å¹•ç¬¬${ee}é•œ`:""}`:we.name})}),!Oe&&Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-[100px] top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,A)=>o.scene!==A.scene?(o.scene||0)-(A.scene||0):(o.shot||0)-(A.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const A=o.bounds.x+o.bounds.width/2,L=o.bounds.y+o.bounds.height/2,X=Nt.current;if(X){const Y=X.clientWidth,ye=X.clientHeight,De=.2,Le=Y*(1-De),He=ye*(1-De),We=Le/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(We,rt,1.5),Pe=Math.max(Xe,.3);xe(A,L,{zoom:Pe,duration:800})}else xe(A,L,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${ze===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-[#deeaef]/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-[#deeaef] dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:"fixed right-[24px] top-1/2 -translate-y-1/2 z-[100] flex flex-col gap-1 p-2 rounded-2xl bg-[#deeaef] dark:bg-[#18181b] shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{onClick:()=>{if(qe&&S&&l){const o=Oe&&oe&&ee?`?shot=${ee}`:"";T(`/projects/${S}/episodes/${l}${o}`)}else T("/quick")},className:"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"arrow_back"})}),e.jsx("div",{className:"h-px bg-neutral-200 dark:bg-neutral-700 my-1"}),!z&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!bt&&a&&Ks(!bs)},disabled:bt||!a,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":bs?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!bt&&a&&na()},disabled:bt||!a||!Mr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!Mr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_work"})}),e.jsx("button",{onClick:()=>{!bt&&a&&ia()},disabled:bt||!a||!wr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!wr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_off"})}),e.jsx("button",{onClick:()=>{!bt&&a&&la()},disabled:bt||!a||!wr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!wr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"edit"})}),e.jsx("button",{onClick:()=>oa(),className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${Es?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:Es?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"text_fields"})})]})]}),w&&tr.length>0&&e.jsxs("div",{className:`absolute ${z?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:tr.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.ai${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-neutral-600 dark:text-neutral-300",children:"person"})},o.id))}),tr.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",tr.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${Es?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Sa,{nodes:ws,edges:g,onNodesChange:z?void 0:os,onEdgesChange:z?void 0:Zr,onNodesDelete:z?void 0:Qr,onEdgesDelete:z?void 0:ea,onConnect:z?void 0:Kr,onConnectStart:z?void 0:ra,onConnectEnd:z?void 0:aa,onEdgeDoubleClick:z?void 0:Yr,onPaneContextMenu:z?void 0:ta,onPaneClick:z?void 0:ca,onMove:da,onNodeClick:z?void 0:ha,onNodeDragStart:z?void 0:ua,onNodeDrag:z?void 0:ga,onNodeDragStop:z?void 0:pa,nodeTypes:wn,edgeTypes:yn,nodesDraggable:!z,nodesConnectable:!z,elementsSelectable:!z,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${z?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#525252",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:z?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Ea,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#525252"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#404040"})]})}),Ke.filter(o=>!o.hidden).map(o=>{const A=Z(),L=o.bounds.x*A.zoom+A.x,X=o.bounds.y*A.zoom+A.y,Y=o.bounds.width*A.zoom,ye=o.bounds.height*A.zoom,De=12*A.zoom,Le=Math.max(1.25,1.25*A.zoom),He=document.documentElement.classList.contains("dark"),We=ze===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:L,y:X,width:Y,height:ye,rx:De,ry:De,fill:"none",stroke:We?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Le,style:{filter:We?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:L,y:X,width:Y,height:ye,rx:De,ry:De,fill:"transparent",stroke:"transparent",strokeWidth:Le*3,style:{pointerEvents:"stroke",cursor:ks===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),$r(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ke.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const A=Z(),L=o.bounds.x*A.zoom+A.x,X=o.bounds.y*A.zoom+A.y,Y=40*A.zoom,ye=10*A.zoom,De=15*A.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Le=>{Le.stopPropagation(),$r(Le,o.id)},onClick:Le=>{Le.stopPropagation(),wt(o.id)},style:{left:L+ye,top:X-Y-ye-De,fontSize:`${Y}px`,cursor:ks===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),c&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:c.x,top:c.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{x.current&&(clearTimeout(x.current),x.current=null),ne("agent")},onMouseLeave:()=>{x.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ne("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),D==="agent"&&e.jsx("div",{onMouseEnter:()=>{x.current&&(clearTimeout(x.current),x.current=null),ne("agent")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(x.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{x.current&&(clearTimeout(x.current),x.current=null),Ce(!0)},onMouseLeave:()=>{x.current=window.setTimeout(()=>{Ce(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),J&&e.jsxs("div",{onMouseEnter:()=>{x.current&&(clearTimeout(x.current),x.current=null),Ce(!0)},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(x.current=window.setTimeout(()=>{Ce(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{ve.current&&(clearTimeout(ve.current),ve.current=null),B(!0)},onMouseLeave:()=>{ve.current=window.setTimeout(()=>{B(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),I&&e.jsxs("div",{onMouseEnter:()=>{ve.current&&(clearTimeout(ve.current),ve.current=null),B(!0)},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(ve.current=window.setTimeout(()=>{B(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{x.current&&(clearTimeout(x.current),x.current=null),ne("edit")},onMouseLeave:()=>{x.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),D==="edit"&&e.jsxs("div",{onMouseEnter:()=>{x.current&&(clearTimeout(x.current),x.current=null),ne("edit")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(x.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Ze.filter(o=>zt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),ge(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),Ze.every(o=>zt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Qs.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{q(null),Ue.current&&(clearTimeout(Ue.current),Ue.current=null),Te(!0)},onMouseLeave:()=>{Ue.current=window.setTimeout(()=>{Te(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Te(!0),onMouseLeave:()=>Te(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Te(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Te(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),$e&&e.jsx("div",{onMouseEnter:()=>{Ue.current&&(clearTimeout(Ue.current),Ue.current=null),Te(!0)},onMouseLeave:()=>{Ue.current=window.setTimeout(()=>{Te(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),cs("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Qs.showAiImage&&e.jsxs("button",{onMouseEnter:()=>q(null),onClick:()=>cs("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Qs.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),q("imageEdit")},onMouseLeave:()=>{d.current=window.setTimeout(()=>{q(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>q("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),de==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),q("imageEdit")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(d.current=window.setTimeout(()=>{q(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Qs.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),q("video")},onMouseLeave:()=>{d.current=window.setTimeout(()=>{q(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>q("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),de==="video"&&e.jsxs("div",{onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),q("video")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(d.current=window.setTimeout(()=>{q(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>cs("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>cs("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>cs("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>cs("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>cs("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>cs("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>cs("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Qs.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{q(null),Re.current&&(clearTimeout(Re.current),Re.current=null),ge(!0)},onMouseLeave:()=>{Re.current=window.setTimeout(()=>{ge(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>ge(!0),onMouseLeave:()=>ge(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),ge(!0)},onMouseOver:()=>q(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),b&&e.jsxs("div",{onMouseEnter:()=>{Re.current&&(clearTimeout(Re.current),Re.current=null),ge(!0)},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(Re.current=window.setTimeout(()=>{ge(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Ze.filter(o=>zt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),o==="å¯¹å£å‹"?cs("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?cs("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):cs("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),ge(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),Ze.every(o=>zt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Qs.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>q(null),onClick:()=>cs("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Qs.showUpload&&e.jsxs("button",{onMouseEnter:()=>q(null),onClick:()=>cs("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Qs.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>q(null),onClick:()=>cs("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Qs.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>q(null),onClick:()=>cs("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(bn,{isOpen:Ot,onClose:()=>{Tt(!1),pt(null)},onAssetSelect:sa}),Rs&&Ss&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Is(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Is(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),A=document.getElementById("shot-input"),L=parseInt((o==null?void 0:o.value)||"0"),X=parseInt((A==null?void 0:A.value)||"0");if(L>0&&X>0){if(Ke.find(ye=>ye.id!==Ss&&ye.scene===L&&ye.shot===X)){h.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${L}å¹•-ç¬¬${X}é•œ`);return}vt(ye=>{const De=ye.map(He=>He.id===Ss?{...He,scene:L,shot:X,name:`ç¬¬${L}å¹•-ç¬¬${X}é•œ`}:He),Le=De.find(He=>He.id===Ss);return Le&&$(He=>{const We=new Set;return g.forEach(rt=>{if(Le.nodeIds.includes(rt.source)){const Xe=He.find(Pe=>Pe.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&We.add(rt.target)}}),He.map(rt=>Le.nodeIds.includes(rt.id)||We.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Le,nodeGroups:De}}}:rt)}),setTimeout(()=>{ps()},100),De}),Is(!1),Gs(null),h.success(`å·²å‘½åä¸ºï¼šç¬¬${L}å¹•-ç¬¬${X}é•œ`)}else h.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},An=()=>e.jsx(va,{children:e.jsx(kn,{})});export{An as default};
