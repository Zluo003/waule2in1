const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CiJ2Nd2F.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-CT1-IETa.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Ft,u as Ar,z as Ds,e as ma,d as xa}from"./react-vendor-BvY2dB7B.js";import{u as _r,l as ba,b as _e,_ as us,c as f,e as wa}from"./index-CiJ2Nd2F.js";import{P as pt,H as hs,a as Zt,b as Os,d as Xs,e as Js,g as ya,R as ka,f as va,h as Na,i as ja,j as Ia,C as Sa}from"./reactflow-D8v6_Qvs.js";import{C as Ea,L as Ps,S as xr,I as Pr,T as Hr,V as Ca}from"./video-CPXLMxBS.js";import{c as Us}from"./createLucideIcon-CK1cQnin.js";import{X as Aa,j as Zs,L as Bs,o as Or,a as _a,v as or,U as Gr,b as Ta,N as Ua}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ra=Us("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Us("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Us("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Us("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Us("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Us("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Us("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cr=Us("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Us("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Us("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xr=Us("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Us("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),Fa="https://api.waule.ai";function za(s){const{workflowId:S,isSharedWorkflow:l,isReadOnly:F,onNodeAdd:me,onNodeUpdate:T,onNodeDelete:xe,onNodeMove:Y,onNodesMove:ae,onEdgeAdd:Z,onEdgeDelete:ge,onGroupsUpdate:Ae,onUserJoin:fe}=s,Q=t.useRef(null),ee=t.useRef(!1),{token:Se}=_r(),[ie,we]=t.useState([]);t.useEffect(()=>{if(!l||!S||!Se)return;const g=ba(Fa,{auth:{token:Se},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return Q.current=g,g.on("connect",()=>{ee.current=!0,g.emit("join-workflow",S),g.emit("user:join",{workflowId:S})}),g.on("disconnect",x=>{ee.current=!1}),g.on("connect_error",x=>{}),g.on("node:add",x=>{me==null||me(x.node,x.userId)}),g.on("node:update",x=>{T==null||T(x.nodeId,x.changes,x.userId)}),g.on("node:delete",x=>{xe==null||xe(x.nodeId,x.userId)}),g.on("node:move",x=>{Y==null||Y(x.nodeId,x.position,x.userId)}),g.on("nodes:move",x=>{ae==null||ae(x.nodes,x.userId)}),g.on("edge:add",x=>{Z==null||Z(x.edge,x.userId)}),g.on("edge:delete",x=>{ge==null||ge(x.edgeId,x.userId)}),g.on("groups:update",x=>{Ae==null||Ae(x.groups,x.userId)}),g.on("user:join",x=>{fe==null||fe(x.user)}),g.on("users:online",x=>{we(x.users)}),()=>{Q.current&&(Q.current.emit("leave-workflow",S),Q.current.disconnect(),Q.current=null),ee.current=!1,we([])}},[S,l,Se]);const ce=t.useCallback(g=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("node:add",{workflowId:S,node:g})},[S,F]),be=t.useCallback((g,x)=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("node:update",{workflowId:S,nodeId:g,changes:x})},[S,F]),Ee=t.useCallback(g=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("node:delete",{workflowId:S,nodeId:g})},[S,F]),le=t.useCallback((g,x)=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("node:move",{workflowId:S,nodeId:g,position:x})},[S,F]),te=t.useCallback(g=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("nodes:move",{workflowId:S,nodes:g})},[S,F]),R=t.useCallback(g=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("edge:add",{workflowId:S,edge:g})},[S,F]),$=t.useCallback(g=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("edge:delete",{workflowId:S,edgeId:g})},[S,F]),P=t.useCallback(g=>{Q.current&&ee.current&&S&&!F&&Q.current.emit("groups:update",{workflowId:S,groups:g})},[S,F]);return{isConnected:ee.current,onlineUsers:ie,emitNodeAdd:ce,emitNodeUpdate:be,emitNodeDelete:Ee,emitNodeMove:le,emitNodesMove:te,emitEdgeAdd:R,emitEdgeDelete:$,emitGroupsUpdate:P}}const cr=2560,Ba=10,vr=(s,S=cr,l=.9)=>new Promise((F,me)=>{const T=new Image,xe=URL.createObjectURL(s);T.onload=()=>{URL.revokeObjectURL(xe);let{width:Y,height:ae}=T;const Z=Math.min(Y,ae);if(Z>S){const Q=S/Z;Y=Math.round(Y*Q),ae=Math.round(ae*Q)}const ge=document.createElement("canvas");ge.width=Y,ge.height=ae;const Ae=ge.getContext("2d");if(!Ae){me(new Error("Failed to get canvas context"));return}Ae.drawImage(T,0,0,Y,ae);const fe=ge.toDataURL("image/jpeg",l);F(fe)},T.onerror=()=>{URL.revokeObjectURL(xe),me(new Error("Failed to load image for compression"))},T.src=xe}),Vr=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(l=>l.test(s)):!1,Ha=async s=>{try{const S=s.startsWith("/uploads/")?`https://api.waule.ai${s}`:s,F=await(await fetch(S)).blob();return await vr(F,cr,.9)}catch(S){throw S}},ur=async(s,S)=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(S!=null&&S.skipCompression)return s;if(s.length>500*1024)try{const T=await(await fetch(s)).blob();return await vr(T,cr,.9)}catch{return s}return s}const l=s.includes("aliyuncs.com")||s.includes("oss-cn-"),F=s.startsWith("https://")&&!Vr(s);if(l||F){if(S!=null&&S.skipCompression)return s;try{const me=new AbortController,T=setTimeout(()=>me.abort(),3e4);let xe=0;try{const Q=(await fetch(s,{method:"HEAD",signal:me.signal})).headers.get("content-length");Q&&(xe=parseInt(Q)/(1024*1024))}catch{}const Y=await fetch(s,{signal:me.signal});clearTimeout(T);const ae=await Y.blob();if(ae.size/(1024*1024)>Ba)return await vr(ae,cr,.85);const ge=await Xa(ae);return Math.min(ge.width,ge.height)>cr?await vr(ae,cr,.9):s}catch(me){if(me.name==="AbortError")throw new Error("å›¾ç‰‡ä¸‹è½½è¶…æ—¶");return s}}return Vr(s)?await Ha(s):s},Xa=s=>new Promise((S,l)=>{const F=new Image,me=URL.createObjectURL(s);F.onload=()=>{URL.revokeObjectURL(me),S({width:F.width,height:F.height})},F.onerror=()=>{URL.revokeObjectURL(me),l(new Error("Failed to load image"))},F.src=me}),Ut=({type:s,position:S,id:l,className:F="",label:me,isConnectable:T,disabled:xe,style:Y,...ae})=>{const Z=S===pt.Left,ge=T===!1||xe?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${F}`;return e.jsxs("div",{className:`absolute ${Z?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...Y||{}},children:[Z&&me&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:me}),e.jsx(hs,{type:s,position:S,id:l,isConnectable:xe?!1:T,style:{position:"relative",[Z?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${ge} !z-[10001]`,...ae}),!Z&&me&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:me})]})},as=({value:s,onChange:S,options:l,className:F=""})=>{const[me,T]=t.useState(!1),xe=t.useRef(null);t.useEffect(()=>{if(!me)return;const Z=ge=>{xe.current&&!xe.current.contains(ge.target)&&T(!1)};return document.addEventListener("mousedown",Z,!0),()=>document.removeEventListener("mousedown",Z,!0)},[me]);const Y=l.find(Z=>Z.value===s),ae=Z=>{Z.stopPropagation(),T(!me)};return e.jsxs("div",{className:`relative ${F}`,ref:xe,children:[e.jsxs("div",{onClick:ae,onMouseDown:Z=>Z.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(Y==null?void 0:Y.label)||s}),e.jsx(Ea,{size:12,className:`transition-transform ${me?"rotate-90":""}`})]}),me&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white dark:bg-[#18181b] backdrop-blur-xl border-slate-200 dark:border-white/10",children:l.map(Z=>e.jsxs("div",{onClick:ge=>{ge.stopPropagation(),S(Z.value),T(!1)},onMouseDown:ge=>ge.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[Z.label,s===Z.value&&e.jsx(Ma,{size:10,className:"text-neutral-500"})]},Z.value))})]})},Ns=s=>{const[S,l]=t.useState(null),[F,me]=t.useState(!1),[T,xe]=t.useState(!1),[Y,ae]=t.useState(0),[Z,ge]=t.useState(0),Ae=t.useCallback(()=>{ge(fe=>fe+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){l(null),xe(!1),ae(0);return}try{me(!0);const ee=(await _e.post("/billing/estimate",s)).data,Se=(ee==null?void 0:ee.data)??ee,ie=(Se==null?void 0:Se.originalCredits)??(Se==null?void 0:Se.credits)??0;l(ie),xe((Se==null?void 0:Se.isFreeUsage)??!1),ae((Se==null?void 0:Se.freeUsageRemaining)??0)}catch{l(null),xe(!1),ae(0)}finally{me(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,Z]),{credits:S,loading:F,isFreeUsage:T,freeUsageRemaining:Y,refetch:Ae}},fs=({createdBy:s,isSharedWorkflow:S})=>{if(!S||!s||typeof s=="string")return null;const{nickname:l,avatar:F}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:l||"æœªçŸ¥ç”¨æˆ·",children:F?e.jsx("img",{src:F,alt:l||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-neutral-800 to-neutral-700 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(l||"?")[0].toUpperCase()})})},Ja=({data:s,selected:S,id:l})=>{var oe;const[F,me]=t.useState(s.isExpanded!==!1),[T,xe]=t.useState(null),[Y,ae]=t.useState(s.config.prompt||""),[Z,ge]=t.useState(s.config.ratio||""),[Ae,fe]=t.useState(s.config.imageSize||"2K"),[Q,ee]=t.useState(s.config.maxImages||1),[Se,ie]=t.useState(!1),[,we]=t.useState(0),[,ce]=t.useState(s.config.taskId||""),[be,Ee]=t.useState(s.config.referenceImages||[]),[le,te]=t.useState(null),R=t.useRef(null),$=t.useRef(!1),{setNodes:P,setEdges:g,getNode:x,getEdges:_,getNodes:z}=Zt(),D=Os(),C=Xs(h=>h.edges.filter(d=>d.target===l)),W=t.useRef(""),r=t.useRef(""),{credits:k,loading:p,isFreeUsage:a,freeUsageRemaining:v,refetch:u}=Ns({aiModelId:T==null?void 0:T.id,quantity:1,resolution:Ae}),w=t.useMemo(()=>(s.models||[]).filter(h=>h.type==="IMAGE_GENERATION"&&h.isActive&&!h.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const h=w.find(d=>d.id===s.config.modelId);if(h){xe(h);const d=h.config;d!=null&&d.supportedRatios&&d.supportedRatios.length>0&&!Z&&ge(d.supportedRatios[0]),s.config.acceptedInputs||i({acceptedInputs:(d==null?void 0:d.acceptedInputs)||["TEXT","IMAGE"]})}}else if(w.length>0){xe(w[0]);const h=w[0].config;h!=null&&h.supportedRatios&&h.supportedRatios.length>0&&!Z&&ge(h.supportedRatios[0]),s.config.acceptedInputs||i({acceptedInputs:(h==null?void 0:h.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,w]),t.useEffect(()=>{const h=s.config.taskId;(async()=>{if(h)try{const b=(await _e.tasks.getTaskStatus(h)).task;if(b.status==="SUCCESS"){ie(!1),we(100);const J=b.resultUrl;if(!J){ie(!1),we(0),i({taskId:""}),Ft.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const de=s.config.ratio||"1:1";i({prompt:s.config.prompt||Y,ratio:de,modelId:s.config.modelId||(T==null?void 0:T.id),generatedImageUrl:J,taskId:""});const B=z(),pe=_();if(B.filter(Oe=>Oe.type==="imagePreview"&&pe.some(Ue=>Ue.source===l&&Ue.target===Oe.id)).find(Oe=>Oe.data.imageUrl===J)){i({taskId:""}),Ft.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Ft.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const Oe=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Oe).some(Te=>Te.taskId&&Te.taskId===h||Te.sourceNodeId&&Te.sourceNodeId===l)||ue(J,de)}catch{ue(J,de)}}else b.status==="PROCESSING"||b.status==="PENDING"?(ie(!0),we(b.progress||0),G(h)):b.status==="FAILURE"&&(ie(!1),we(0),i({taskId:""}),Ft.error(b.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${b.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ie(!1),we(0),i({taskId:""}),Ft.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const m=()=>{if(!T)return[];const h=T.config;return(h==null?void 0:h.supportedRatios)||[]},N=()=>{var b;const h=(b=s==null?void 0:s.config)==null?void 0:b.modelId,d=w.find(J=>J.id===h)||w[0],j=(d==null?void 0:d.config)||{};return j.maxReferenceImages||j.supportedReferenceImagesLimit||j.referenceImagesLimit||10};function I(h){var j,b,J,de,B,pe,Ce;const d=(h==null?void 0:h.type)||"";if(d==="upload")return(((b=(j=h==null?void 0:h.data)==null?void 0:j.config)==null?void 0:b.uploadedFiles)||[]).reduce((Oe,Ue)=>{const Re=((Ue==null?void 0:Ue.type)||"").toUpperCase(),Te=((Ue==null?void 0:Ue.mimeType)||"").toLowerCase();return Oe+(Re==="IMAGE"||Te.startsWith("image/")?1:0)},0);if(d==="assetSelector"){const Ne=((J=h==null?void 0:h.data)==null?void 0:J.config)||{};if(Ne.selectedAsset){const Oe=(Ne.selectedAsset.type||"").toUpperCase(),Ue=(Ne.selectedAsset.mimeType||"").toLowerCase();return Oe==="IMAGE"||Ue.startsWith("image/")?1:0}return Array.isArray(Ne.subjects)&&Ne.subjects.length>0&&(((de=Ne.subjects[0])==null?void 0:de.images)||[]).length>0?1:0}return d==="aiImage"?((pe=(B=h==null?void 0:h.data)==null?void 0:B.config)==null?void 0:pe.generatedImageUrl)?1:0:d==="imagePreview"&&((Ce=h==null?void 0:h.data)==null?void 0:Ce.imageUrl)?1:0}function U(h){var b,J,de,B;const d=(h==null?void 0:h.type)||"",j=h==null?void 0:h.data;if(d==="upload"&&((J=(b=j==null?void 0:j.config)==null?void 0:b.uploadedFiles)==null?void 0:J.length)>0){const pe=j.config.uploadedFiles[0],Ce=(pe.type||"").toUpperCase(),Ne=(pe.mimeType||"").toLowerCase();return Ce==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ce==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ce==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ce||null}if(d==="assetSelector"){if((de=j==null?void 0:j.config)!=null&&de.subjects)return"IMAGE";if((B=j==null?void 0:j.config)!=null&&B.selectedAsset){const pe=j.config.selectedAsset,Ce=(pe.type||"").toUpperCase(),Ne=(pe.mimeType||"").toLowerCase();return Ce==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ce==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ce==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ce||null}}return d==="aiImage"||d==="imagePreview"?"IMAGE":(d||"").startsWith("aiVideo")||d==="videoPreview"?"VIDEO":d==="agent"?"TEXT":null}const y=t.useMemo(()=>{const h=C,d=h.some(J=>{const de=x(J.source);return((de==null?void 0:de.type)||"")==="agent"}),j=N(),b=h.reduce((J,de)=>J+I(x(de.source)),0);return d&&b>=j},[C,x]),c=h=>{const d=x(h.source);if(!d)return!1;const j=d.type||"",b=_().filter(Ne=>Ne.target===l),J=U(d);if(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")return!1;const de=b.some(Ne=>{const Oe=x(Ne.source);return((Oe==null?void 0:Oe.type)||"")==="agent"});if(j==="agent"||j==="textPreview")return!de;const B=b.reduce((Ne,Oe)=>Ne+I(x(Oe.source)),0),pe=I(d),Ce=N();return B+pe<=Ce};t.useEffect(()=>{const h=C;let j=N();const b=[];h.forEach(J=>{const de=x(J.source),B=I(de);B<=0||(j-B>=0?j-=B:b.push(J.id))}),b.length>0&&(g(J=>J.filter(de=>!b.includes(de.id))),Ft.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[C,x,g]),t.useEffect(()=>{const h=C,d=[];h.forEach(j=>{const b=x(j.source),J=U(b);(J==="VIDEO"||J==="AUDIO"||J==="DOCUMENT")&&d.push(j.id)}),d.length>0&&(g(j=>j.filter(b=>!d.includes(b.id))),Ft.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[C,x,g]),t.useEffect(()=>{const h=C.map(de=>{var Ne,Oe,Ue,Re,Te;const B=x(de.source);if(!B)return`${de.id}-${de.source}`;const pe=B.data||{};let Ce=[];if(B.type==="assetSelector"){const se=(Ne=pe.config)==null?void 0:Ne.subjects;if(se&&se.length>0){const Ve=(Oe=se[0].images)==null?void 0:Oe[0];Ce=Ve?[Ve]:[]}else(Ue=pe.config)!=null&&Ue.selectedAsset&&pe.config.selectedAsset.type==="IMAGE"&&(Ce=[pe.config.selectedAsset.url])}else if(B.type==="upload")Ce=(((Re=pe.config)==null?void 0:Re.uploadedFiles)||[]).filter(Ve=>Ve.type==="IMAGE").map(Ve=>Ve.url);else if(B.type==="aiImage"||B.type==="imagePreview"){const se=((Te=pe.config)==null?void 0:Te.generatedImageUrl)||pe.imageUrl;se&&(Ce=[se])}return`${de.id}-${de.source}-${Ce.join("|")}`}).sort().join(",");if(h===W.current)return;W.current=h;const d=[];let j="";C.forEach(de=>{var pe,Ce,Ne,Oe,Ue,Re;const B=x(de.source);if(B){const Te=B.data;if(B.type==="agent"&&((pe=Te.config)!=null&&pe.generatedText)?j||(j=Te.config.generatedText):B.type==="textPreview"&&Te.content&&(j||(j=Te.content)),B.type==="assetSelector"&&((Ce=Te.config)!=null&&Ce.subjects)&&Te.config.subjects.length>0){const Ve=(Ne=Te.config.subjects[0].images)==null?void 0:Ne[0];Ve&&!d.includes(Ve)&&d.push(Ve)}let se=((Oe=Te.config)==null?void 0:Oe.generatedImageUrl)||Te.imageUrl||"";if(!se&&((Ue=Te.config)!=null&&Ue.selectedAsset)){const Ve=Te.config.selectedAsset;Ve.type==="IMAGE"&&(se=Ve.url)}if(!se&&((Re=Te.config)!=null&&Re.uploadedFiles)&&Te.config.uploadedFiles.length>0){const Ve=Te.config.uploadedFiles[0];Ve.type==="IMAGE"&&(se=Ve.url)}se&&!d.includes(se)&&d.push(se)}});const b=N(),J=d.slice(0,Math.max(0,b));Ee(J),i({referenceImages:J}),j&&j!==Y&&(ae(j),i({prompt:j}))},[C,x,l,Y,D]),t.useEffect(()=>{if(C.length===0)return;let h="",d="";C.forEach(j=>{var J;const b=D.find(de=>de.id===j.source);if(b&&b.type==="agent"){const de=b.data;(J=de.config)!=null&&J.generatedText&&(h=de.config.generatedText,d=`${b.id}-${de.config.generatedText.substring(0,50)}`)}}),h&&d!==r.current&&(r.current=d,ae(h),i({prompt:h}))},[D,C,l]),t.useEffect(()=>{const h=R.current;h&&F&&requestAnimationFrame(()=>{h.style.height="auto";const d=Math.max(60,Math.min(h.scrollHeight,600));h.style.height=`${d}px`})},[Y,F]),t.useEffect(()=>{const h=setTimeout(()=>{Y!==s.config.prompt&&i({prompt:Y})},300);return()=>clearTimeout(h)},[Y]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Y&&ae(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{Z&&Z!==s.config.ratio&&i({ratio:Z})},[Z]),t.useEffect(()=>{Ae&&Ae!==s.config.imageSize&&i({imageSize:Ae})},[Ae]),t.useEffect(()=>{var h;if((T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"){const d=((h=T==null?void 0:T.config)==null?void 0:h.supportedResolutions)||[];(d.length>0&&!d.includes(Ae)||d.length===1)&&fe(d[0])}},[T]),t.useEffect(()=>{Q!==s.config.maxImages&&i({maxImages:Q})},[Q]);const i=h=>{x(l)&&P(j=>j.map(b=>b.id===l?{...b,data:{...b.data,config:{...b.data.config,...h}}}:b))},n=h=>{te(h)},V=(h,d)=>{if(h.preventDefault(),le===null||le===d)return;const j=[...be],b=j[le];j.splice(le,1),j.splice(d,0,b),Ee(j),te(d)},M=()=>{te(null),i({referenceImages:be})},G=async h=>{let j=0;const b=async()=>{var J;try{j++;const B=(await _e.tasks.getTaskStatus(h)).task;if(we(B.progress||0),B.status==="SUCCESS"){ie(!1),we(100);const pe=B.resultUrl,Ce=(J=B.metadata)==null?void 0:J.allImageUrls;i({prompt:Y,ratio:Z,modelId:T==null?void 0:T.id,generatedImageUrl:pe,taskId:""}),Ce&&Ce.length>1?(ne(Ce,Z),Ft.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Ce.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(ue(pe,Z),Ft.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(B.status==="FAILURE"){ie(!1),we(0),i({taskId:""});const{useAuthStore:pe}=await us(async()=>{const{useAuthStore:Ne}=await import("./index-CiJ2Nd2F.js").then(Oe=>Oe.f);return{useAuthStore:Ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ce}=pe.getState();await Ce(),Ft.error(B.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(B.status==="PROCESSING"||B.status==="PENDING")&&(j<600?setTimeout(b,1e3):(ie(!1),we(0),i({taskId:""}),Ft.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ie(!1),we(0),i({taskId:""}),Ft.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};b()},O=async()=>{var h,d,j,b,J;if(!(!Y.trim()||!T)){ie(!0),we(0);try{let de=[];if(be.length>0){const Te=T.modelId==="gemini-3-pro-image-preview";try{for(let se=0;se<be.length;se++){const Ve=be[se];try{const et=await ur(Ve,{skipCompression:Te});de.push(et)}catch{}}}catch{}}let B=Y.trim();T.modelId==="doubao-seedream-4-5-251128"&&Q>1&&(B=`ç”Ÿæˆä¸€ç»„å…±${Q}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${B}`),T.modelId==="gemini-3-pro-image-preview"&&Z&&(B=`${B}ï¼Œç”Ÿæˆ${Z}çš„æ¯”ä¾‹`);const pe={modelId:T.id,prompt:B,ratio:Z||"1:1",referenceImages:de.length>0?de:void 0};T.modelId==="gemini-3-pro-image-preview"&&(pe.imageSize=Ae),T.modelId==="doubao-seedream-4-5-251128"&&Q>1&&(pe.maxImages=Q);const Ce=await _e.tasks.createImageTask(pe),Ne=Ce.taskId,Oe=Ce.creditsCharged||0,Ue=Ce.isFreeUsage,Re=Ce.freeUsageRemaining??0;if(ce(Ne),i({prompt:Y,ratio:Z,modelId:T.id,taskId:Ne}),Ue)Ft.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Re} æ¬¡æœºä¼š`),u();else if(Oe>0){const{useAuthStore:Te}=await us(async()=>{const{useAuthStore:Ve}=await import("./index-CiJ2Nd2F.js").then(et=>et.f);return{useAuthStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:se}=Te.getState();await se(),Ft.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${Oe} ç§¯åˆ†`),u()}else Ft.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");G(Ne)}catch(de){if(ie(!1),we(0),((h=de.response)==null?void 0:h.status)===403){const B=((j=(d=de.response)==null?void 0:d.data)==null?void 0:j.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Ft.error(B)}else{const B=((J=(b=de.response)==null?void 0:b.data)==null?void 0:J.error)||de.message||"æœªçŸ¥åŸå› ";Ft.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ne=(h,d)=>{!h||h.length===0||h.forEach((j,b)=>{setTimeout(()=>{ue(j,d,b)},b*100)})},ue=(h,d,j)=>{const b=x(l);if(!b)return;const J=1,de=z(),B=_(),pe=de.filter(It=>It.type==="imagePreview"&&B.some(ze=>ze.source===l&&ze.target===It.id));if(pe.find(It=>It.data.imageUrl===h))return;const Ne=400,Oe=(It,ze=300)=>{if(!It||!/^[0-9]+\s*:\s*[0-9]+$/.test(It))return ze;const[wt,ts]=It.split(":").map(ms=>parseFloat(ms));return!wt||!ts?ze:Math.round(Ne*(ts/wt))},Ue=document.querySelector(`.react-flow__node[data-id="${l}"]`),Re=(Ue==null?void 0:Ue.getBoundingClientRect().width)||400,Te=Math.round(Re/J),se=200,Ve=100,et=Oe(d,300),kt=b.position.x+Te+se,vt=b.position.y,Nt=j!==void 0?pe.length+j:pe.length,ct=kt,ut=vt+Nt*(et+Ve),St=Date.now(),lt={id:`preview-${l}-${St}`,type:"imagePreview",position:{x:ct,y:ut},data:{imageUrl:h,width:Ne,ratio:d,workflowContext:b.data.workflowContext,createdBy:b.data.createdBy}};P(It=>[...It,lt]);const Ke={id:`edge-${l}-${lt.id}`,source:l,target:lt.id,targetHandle:`${lt.id}-target`,type:"aurora"};g(It=>It.find(wt=>wt.source===l&&wt.target===lt.id)?It:[...It,Ke])};if(t.useEffect(()=>{s.isExpanded!==void 0&&me(s.isExpanded)},[s.isExpanded]),!F&&s.config.generatedImageUrl){const[h,d]=(s.config.ratio||"1:1").split(":").map(Number),j=h/d,b=320,J=b/j;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:b,height:J},onDoubleClick:()=>{me(!0),x(l)&&P(B=>B.map(pe=>pe.id===l?{...pe,data:{...pe.data,isExpanded:!0}}:pe))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:y,isValidConnection:c}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),Y&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:Y,children:Y})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!F&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{me(!0),x(l)&&P(d=>d.map(j=>j.id===l?{...j,data:{...j.data,isExpanded:!0}}:j))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:y,isValidConnection:c}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Y?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:Y})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:y,isValidConnection:c}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:(T==null?void 0:T.id)||"",onChange:h=>{const d=w.find(j=>j.id===h);if(xe(d||null),d){const j=d.config;j!=null&&j.supportedRatios&&j.supportedRatios.length>0&&ge(j.supportedRatios[0]),i({modelId:d.id,acceptedInputs:(j==null?void 0:j.acceptedInputs)||["TEXT","IMAGE"]})}},options:w.map(h=>({value:h.id,label:h.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:R,value:Y,onChange:h=>{$.current=!0,ae(h.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),be.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",be.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:be.map((h,d)=>e.jsxs("div",{draggable:!0,onDragStart:j=>{j.stopPropagation(),n(d)},onDragEnd:j=>{j.stopPropagation(),M()},onDragOver:j=>{j.stopPropagation(),V(j,d)},className:`nodrag relative group cursor-move aspect-square ${le===d?"opacity-50":""}`,children:[e.jsx("img",{src:h,alt:`å›¾ç‰‡${d+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:d+1})]},d))})]}),(T==null?void 0:T.modelId)==="gemini-3-pro-image-preview"&&(()=>{var d;const h=((d=T==null?void 0:T.config)==null?void 0:d.supportedResolutions)||[];return h.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${h.length} gap-2`,children:h.map(j=>e.jsx("button",{onClick:()=>fe(j),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Ae===j?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:j==="4K"?"4k":"hd"}),e.jsx("span",{children:j})]})},j))})]})})(),(T==null?void 0:T.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-neutral-500 dark:text-neutral-400",children:[Q," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:Q,onChange:h=>ee(Number(h.target.value)),className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(Q-1)/14*50}%, #06b6d4 ${(Q-1)/14*100}%, var(--range-bg-color) ${(Q-1)/14*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),Q>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),m().length>0&&e.jsx("div",{className:"space-y-1",children:((oe=T==null?void 0:T.provider)==null?void 0:oe.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>ge("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Z==="16:9"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>ge("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Z==="9:16"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(as,{value:Z,onChange:h=>ge(h),options:m().map(h=>{const[d,j]=h.split(":");return{value:h,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[h]||`${d}:${j}`}})})]})}),e.jsx("button",{onClick:h=>{h.stopPropagation(),O()},onPointerDown:h=>h.stopPropagation(),onMouseDown:h=>h.stopPropagation(),disabled:Se||!Y.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Se||!Y.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Se?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!p&&(a?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(v),"æ¬¡"]}):k!==null&&k>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[k,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},qa=t.memo(Ja),fr="https://api.waule.ai",Ka=({data:s,selected:S,id:l})=>{var rr,Vs,q,re,$e,Ge,qe,Pe,tt,bt,yt;const[F,me]=t.useState(!0),[,T]=t.useState(0),[xe,Y]=t.useState(s.config.taskId||""),ae=s.config.modelId,Z=s.config.duration||5,ge=s.config.resolution||"720p",{credits:Ae,loading:fe,isFreeUsage:Q,freeUsageRemaining:ee,refetch:Se}=Ns({aiModelId:ae,duration:Z,resolution:ge});t.useEffect(()=>{},[xe]);const{setNodes:ie,setEdges:we,getNode:ce,getNodes:be,getEdges:Ee}=Zt(),le=Js(),te=Os(),R=t.useRef(""),$=(rr=s.config)==null?void 0:rr.selectedEditingCapability,P=t.useMemo(()=>{const E=(s.models||[]).filter(H=>{var ve;return((ve=H.provider)==null?void 0:ve.toLowerCase())!=="sora"&&H.id!=="sora-video"});if($){const H=E.filter(he=>he.type==="VIDEO_EDITING").filter(he=>{var Ie;return Array.isArray((Ie=he==null?void 0:he.config)==null?void 0:Ie.supportedEditingCapabilities)&&he.config.supportedEditingCapabilities.includes($)}),ve=E.filter(he=>he.type==="VIDEO_GENERATION").filter(he=>{var Mt,st;if($!=="è§†é¢‘æ¢äºº")return!1;const Ie=((Mt=he==null?void 0:he.config)==null?void 0:Mt.supportsVideoEditing)===!0,Ye=(Array.isArray((st=he==null?void 0:he.config)==null?void 0:st.supportedGenerationTypes)?he.config.supportedGenerationTypes:[]).some(Be=>(Be||"").toLowerCase().includes("æ¢äºº")||(Be||"").includes("è§†é¢‘æ¢äºº"));return Ie||Ye}),je={};return[...H,...ve].forEach(he=>{je[he.id]||(je[he.id]=he)}),Object.values(je)}return E.filter(H=>H.type==="VIDEO_GENERATION")},[s.models,$]),[g,x]=t.useState(s.config.prompt||""),_=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==g&&x(s.config.prompt)},[s.config.prompt]);const[z,D]=t.useState(s.config.modelId||((Vs=P[0])==null?void 0:Vs.id)||""),[C,W]=t.useState(s.config.ratio||"16:9"),[r,k]=t.useState(s.config.resolution||""),p=t.useCallback(E=>{const H=(E||"").toLowerCase();return H?H.includes("æ–‡ç”Ÿ")||H.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":H.includes("é¦–å°¾")?"é¦–å°¾å¸§":H.includes("é¦–å¸§")||H.includes("first frame")||H.includes("start frame")||H.includes("initial frame")||H.includes("keyframe")?"é¦–å¸§":H.includes("å°¾å¸§")||H.includes("last frame")||H.includes("end frame")||H.includes("final frame")?"å°¾å¸§":H.includes("ä¸»ä½“å‚è€ƒ")||H.includes("å‚è€ƒ")||H.includes("reference image")||H.includes("image reference")||H.includes("ref image")?"å‚è€ƒå›¾":H.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":H.includes("first-last")||H.includes("two-frame")||H.includes("frame pair")?"é¦–å°¾å¸§":H.includes("first")?"é¦–å¸§":H.includes("last")?"å°¾å¸§":H.includes("subject")||H.includes("reference")?"å‚è€ƒå›¾":E||"":""},[]),[a,v]=t.useState((s.config.lockedGenerationType?p(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[u,w]=t.useState(s.config.duration||5),[m,N]=t.useState(s.config.audio||!1),[I,U]=t.useState(s.config.movementAmplitude||"auto"),[y,c]=t.useState(!1),[i,n]=t.useState([]),[V,M]=t.useState(null),[G,O]=t.useState(!1),[ne]=t.useState(""),[ue]=t.useState("confirm"),[oe]=t.useState(null),[h,d]=t.useState(!1),[j,b]=t.useState([]),[J,de]=t.useState(""),[B,pe]=t.useState(0),[Ce,Ne]=t.useState(0),[Oe,Ue]=t.useState({}),[Re,Te]=t.useState([]),se=P.find(E=>E.id===z);t.useEffect(()=>{var E,H;if(!P.find(ve=>ve.id===z)){const ve=((E=P[0])==null?void 0:E.id)||"";D(ve),ct({modelId:ve,modelName:(H=P[0])==null?void 0:H.name})}},[P]),t.useEffect(()=>{var E;if((E=se==null?void 0:se.config.supportedResolutions)!=null&&E.length){const H=se.config.supportedResolutions;if(!r||!H.includes(r)){const ve=H[0];k(ve),ct({resolution:ve})}}},[se==null?void 0:se.id]),t.useEffect(()=>{var ve;const E=(ve=se==null?void 0:se.modelId)==null?void 0:ve.includes("viduq2"),H=p(a)==="é¦–å°¾å¸§";E&&H&&u>8&&(w(8),ct({duration:8}))},[a,se==null?void 0:se.modelId]);const Ve=((q=se==null?void 0:se.provider)==null?void 0:q.toLowerCase())==="sora",et=t.useMemo(()=>{var E,H,ve,je;if((E=se==null?void 0:se.config.supportedDurations)!=null&&E.length){let he=se.config.supportedDurations;const Ie=(H=se.modelId)==null?void 0:H.includes("viduq2"),nt=p(a)==="é¦–å°¾å¸§";return Ie&&nt&&(he=he.filter(Mt=>Mt<=8)),(((ve=se.provider)==null?void 0:ve.toLowerCase())==="minimax"||((je=se.modelId)==null?void 0:je.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(he=he.filter(Mt=>Mt===6)),he}return[u||5]},[se,u,a,p,r]),kt=t.useMemo(()=>{var E;return(E=se==null?void 0:se.config.supportedResolutions)!=null&&E.length?se.config.supportedResolutions:[]},[se]),vt=!se||!((re=se.config.supportedDurations)!=null&&re.length),Nt=!se||!(($e=se.config.supportedResolutions)!=null&&$e.length),ct=t.useCallback(E=>{ce(l)&&ie(ve=>ve.map(je=>je.id===l?{...je,data:{...je.data,config:{...je.data.config,...E}}}:je))},[ce,l,ie]);t.useEffect(()=>{if(et.length>0&&!et.includes(u)){const E=et[0];w(E),ct({duration:E})}},[et,u,ct]);const ut=(E,H)=>{const ve=(Mt,st)=>st===0?Mt:ve(st,Mt%st),je=ve(E,H),he=E/je,Ie=H/je,nt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},Ye=`${he}:${Ie}`;return nt[Ye]||Ye},St=()=>{const E=le.filter(nt=>nt.target===l),H=[];E.forEach(nt=>{var Mt;const Ye=ce(nt.source);if(Ye&&Ye.type==="upload"&&(((Mt=Ye.data.config)==null?void 0:Mt.uploadedFiles)||[]).forEach(Be=>{const Dt=Be.type||Be.mimeType||"";(Dt==="IMAGE"||Dt.startsWith("image/"))&&H.push({id:Be.id||Be.name,url:Be.url,name:Be.name||Be.originalName,width:Be.width,height:Be.height,aspectRatio:Be.width&&Be.height?ut(Be.width,Be.height):"16:9"})}),Ye&&Ye.type==="assetSelector"){const st=Ye.data.config||{},Be=st.subjects,Dt=st.selectedAsset,Xt=p(a);Be&&Be.length>0?Xt==="é¦–å°¾å¸§"||(Be[0].images||[]).forEach((Ct,Tt)=>{H.push({id:`${Ye.id}-subject-${Tt}`,url:Ct,name:Be[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Dt&&Dt.type==="IMAGE"&&H.push({id:Dt.id,url:Dt.url,name:Dt.name||Dt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(Ye&&Ye.type==="imagePreview"){const st=Ye.data.imageUrl,Be=Ye.data.width,Dt=Ye.data.height;st&&H.push({id:Ye.id,url:st,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:Be,height:Dt,aspectRatio:Be&&Dt?ut(Be,Dt):"16:9"})}});const ve=new Set,je=[];H.forEach(nt=>{const Ye=nt.url;ve.has(Ye)||(ve.add(Ye),je.push(nt))});const he=p(a);let Ie=[];if(he==="æ–‡ç”Ÿè§†é¢‘")Ie=[];else if(he==="é¦–å¸§"||he==="å°¾å¸§")Ie=je.slice(0,1);else if(he==="é¦–å°¾å¸§")Ie=je.slice(0,2);else if(he==="å‚è€ƒå›¾"){const Ye=(se==null?void 0:se.modelId)==="veo3.1-components"?3:7;Ie=je.slice(0,Ye)}else Ie=je;return Ie},lt=t.useMemo(()=>St(),[le,te,a,l,se==null?void 0:se.modelId]),Ke=t.useRef(0);t.useEffect(()=>{const E=(se==null?void 0:se.modelId)==="veo3.1-components",H=p(a);if(E&&H==="å‚è€ƒå›¾"){const ve=le.filter(he=>he.target===l);let je=0;ve.forEach(he=>{var nt,Ye,Mt,st;const Ie=ce(he.source);if((Ie==null?void 0:Ie.type)==="upload"){const Be=((nt=Ie.data.config)==null?void 0:nt.uploadedFiles)||[];je+=Be.filter(Dt=>{const Xt=Dt.type||Dt.mimeType||"";return Xt==="IMAGE"||Xt.startsWith("image/")}).length}else if((Ie==null?void 0:Ie.type)==="imagePreview"&&Ie.data.imageUrl)je+=1;else if((Ie==null?void 0:Ie.type)==="assetSelector"){const Be=Ie.data.config||{};((Ye=Be.selectedAsset)==null?void 0:Ye.type)==="IMAGE"&&(je+=1),(st=(Mt=Be.subjects)==null?void 0:Mt[0])!=null&&st.images&&(je+=Be.subjects[0].images.length)}}),je>3&&je>Ke.current&&f.error("Veo 3.1 Components æ¨¡å‹æœ€å¤šæ”¯æŒ 3 å¼ å‚è€ƒå›¾ï¼Œå¤šä½™çš„å›¾ç‰‡å°†è¢«å¿½ç•¥"),Ke.current=je}},[le,se==null?void 0:se.modelId,a,l,ce,p]);const It=E=>{if(!_.current)return;const H=_.current,ve=H.selectionStart||g.length,je=g.slice(0,ve),he=g.slice(ve),Ie=`@${E} `,nt=je+Ie+he;x(nt),Ue(Ye=>({...Ye,[E]:`image-${E}`})),setTimeout(()=>{const Ye=ve+Ie.length;H.setSelectionRange(Ye,Ye),H.focus()},0)},ze=t.useCallback(async()=>{var E;if(!(Re.length>0))try{const H=await _e.assetLibraries.getAll({includeShared:"true"}),ve=H.data||H||[],je=[];for(const he of ve)if(he.category==="ROLE")try{const Ie=await _e.assetLibraries.roles.list(he.id),nt=Ie.data||Ie||[];for(const Ye of nt)je.push({id:Ye.id,name:((E=Ye.metadata)==null?void 0:E.name)||Ye.name||"",thumbnail:Ye.thumbnail})}catch{}Te(je)}catch{}},[Re.length]),wt=t.useCallback(E=>{if(!E){b(Re.slice(0,5));return}const H=Re.filter(ve=>ve.name.toLowerCase().includes(E.toLowerCase())).slice(0,5);b(H),Ne(0)},[Re]),ts=t.useCallback(E=>{const H=E.target.value,ve=E.target.selectionStart||0;x(H);const he=H.substring(0,ve).match(/@([^@\s]*)$/);if(he){const Ie=he[1];de(Ie),pe(ve-Ie.length-1),d(!0),ze().then(()=>wt(Ie))}else d(!1),b([])},[ze,wt]),ms=t.useCallback(E=>{const H=g.substring(0,B),ve=g.substring(B+J.length+1),je=`@${E.name} `,he=H+je+ve;x(he),Ue(Ie=>({...Ie,[E.name]:E.id})),d(!1),b([]),de(""),setTimeout(()=>{if(_.current){_.current.focus();const Ie=H.length+je.length;_.current.setSelectionRange(Ie,Ie)}},0)},[g,B,J]),Rs=t.useCallback(E=>{!h||j.length===0||(E.key==="ArrowDown"?(E.preventDefault(),Ne(H=>H<j.length-1?H+1:H)):E.key==="ArrowUp"?(E.preventDefault(),Ne(H=>H>0?H-1:H)):E.key==="Enter"&&j[Ce]?(E.preventDefault(),ms(j[Ce])):E.key==="Escape"&&d(!1))},[h,j,Ce,ms]);t.useEffect(()=>{const E=s.config.taskId;(async()=>{if(E){try{const je=(await _e.tasks.getTaskStatus(E)).task;if(je.status==="SUCCESS"){c(!1),T(100);const he=je.resultUrl;if(!he){c(!1),T(0),ct({taskId:""}),Y(""),f.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Ie=s.config.ratio||"16:9";ct({prompt:s.config.prompt||g,ratio:Ie,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:he,taskId:""}),Y("");const nt=be(),Ye=Ee();if(nt.filter(Be=>Be.type==="videoPreview"&&Ye.some(Dt=>Dt.source===l&&Dt.target===Be.id)).find(Be=>Be.data.videoUrl===he)){setTimeout(()=>T(0),1e3);return}f.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const Be=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Be).some(jt=>jt.taskId&&jt.taskId===E||jt.sourceNodeId&&jt.sourceNodeId===l)||$s(he,Ie)}catch{$s(he,Ie)}setTimeout(()=>T(0),1e3)}else if(je.status==="PROCESSING"||je.status==="PENDING"){c(!0),T(je.progress||0),bs(E);return}else je.status==="FAILURE"&&(c(!1),T(0),ct({taskId:""}),Y(""),f.error(`ç”Ÿæˆå¤±è´¥: ${je.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{c(!1),T(0),ct({taskId:""}),Y(""),f.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const E=le.filter(ve=>ve.target===l);let H="";E.forEach(ve=>{var he;const je=ce(ve.source);if(je){const Ie=je.data;je.type==="agent"&&((he=Ie.config)!=null&&he.generatedText)?H||(H=Ie.config.generatedText):je.type==="textPreview"&&Ie.content&&(H||(H=Ie.content))}}),H&&H!==g&&(x(H),ct({prompt:H}))},[le,l,ce,g,ct]),t.useEffect(()=>{const E=le.filter(je=>je.target===l);if(E.length===0)return;let H="",ve="";E.forEach(je=>{var Ie;const he=te.find(nt=>nt.id===je.source);if(he&&he.type==="agent"){const nt=he.data;(Ie=nt.config)!=null&&Ie.generatedText&&(H=nt.config.generatedText,ve=`${he.id}-${nt.config.generatedText.substring(0,50)}`)}}),H&&ve!==R.current&&(R.current=ve,x(H),ct({prompt:H}))},[te,le,l,ct]),t.useEffect(()=>{const E=JSON.stringify(lt),H=JSON.stringify(i);E!==H&&n(lt)},[lt]);const Is=t.useMemo(()=>{const E=i.length,H=p(a);return E===0?!0:E===1?H==="å‚è€ƒå›¾":E===2?H==="é¦–å°¾å¸§"?!1:H==="å‚è€ƒå›¾":E>2?H==="å‚è€ƒå›¾":!1},[i.length,a,p]),Ss=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Gs=t.useMemo(()=>{const E=p(a);return $?P:P.filter(H=>{var je;const ve=(((je=H.config)==null?void 0:je.supportedGenerationTypes)||[]).map(he=>p(he));return E==="é¦–å¸§"||E==="å°¾å¸§"?ve.includes("é¦–å¸§")||ve.includes("å°¾å¸§"):ve.includes(E)})},[P,a,p,$]),ks=t.useMemo(()=>{const E=$?P:Gs;return E.length>0?E:$?(s.models||[]).filter(ve=>(ve.type||"")==="VIDEO_EDITING"):E},[$,P,Gs,s.models]);t.useEffect(()=>{var H,ve;if(!ks.find(je=>je.id===z)){const je=((H=ks[0])==null?void 0:H.id)||"";D(je),ct({modelId:je||void 0,modelName:je?(ve=ks[0])==null?void 0:ve.name:void 0})}},[ks]);const js=t.useCallback(E=>{const H=p(E);return $?["IMAGE","VIDEO"]:H==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[p,$]);t.useEffect(()=>{if(!Is&&i.length>0){const E=i[0].aspectRatio;E&&C!==E&&(W(E),setTimeout(()=>{ct({ratio:E})},0))}},[Is,i,C]),t.useEffect(()=>{if(!$&&Ss.length>0&&!Ss.includes(a)){const E="æ–‡ç”Ÿè§†é¢‘";v(E),setTimeout(()=>{ct({generationType:E,acceptedInputs:js(E)})},0)}},[Ss,a,js,$]),t.useEffect(()=>{p(a)==="é¦–å°¾å¸§"&&m&&(N(!1),ct({audio:!1}))},[a,p]),t.useEffect(()=>{const E=p(a);if(E==="æ–‡ç”Ÿè§†é¢‘")return;const H=le.filter(Ie=>Ie.target===l),ve=[],je=[];H.forEach(Ie=>{var Mt,st,Be,Dt,Xt;const nt=ce(Ie.source);if(!nt)return;const Ye=nt.type;if((Ye||"").startsWith("aiVideo")||Ye==="videoPreview"){je.push(Ie.id);return}if(Ye==="upload"){const jt=(Be=(st=(Mt=nt.data)==null?void 0:Mt.config)==null?void 0:st.uploadedFiles)==null?void 0:Be[0],Ct=((jt==null?void 0:jt.type)||"").toUpperCase(),Tt=((jt==null?void 0:jt.mimeType)||"").toLowerCase();if(Ct==="VIDEO"||Tt.startsWith("video/")){je.push(Ie.id);return}(Ct==="IMAGE"||Tt.startsWith("image/"))&&ve.push(Ie.id);return}if(Ye==="assetSelector"){const jt=((Dt=nt.data)==null?void 0:Dt.config)||{};if(jt.selectedAsset){const Ct=(jt.selectedAsset.type||"").toUpperCase(),Tt=(jt.selectedAsset.mimeType||"").toLowerCase();Ct==="VIDEO"||Tt.startsWith("video/")?je.push(Ie.id):(Ct==="IMAGE"||Tt.startsWith("image/"))&&ve.push(Ie.id)}else if(jt.subjects&&jt.subjects.length>0){const Ct=(((Xt=jt.subjects[0])==null?void 0:Xt.images)||[]).length;E==="å‚è€ƒå›¾"||E==="é¦–å°¾å¸§"?ve.push(Ie.id):(E==="é¦–å¸§"||E==="å°¾å¸§")&&(Ct>1?je.push(Ie.id):ve.push(Ie.id))}return}(Ye==="aiImage"||Ye==="imagePreview")&&ve.push(Ie.id)});let he=new Set([...je]);E==="é¦–å¸§"||E==="å°¾å¸§"?ve.slice(1).forEach(Ie=>he.add(Ie)):E==="é¦–å°¾å¸§"&&ve.slice(2).forEach(Ie=>he.add(Ie)),he.size>0&&we(Ie=>Ie.filter(nt=>!he.has(nt.id)))},[a,le,l,ce,we,p]),t.useEffect(()=>{const E=s.config.generationType;if(!E||p(E)!==p(a)){const H=p(a)||"æ–‡ç”Ÿè§†é¢‘";ct({generationType:H,acceptedInputs:js(H)})}},[]),t.useEffect(()=>{const E=js(a);ct({acceptedInputs:E})},[a,js]);const qs=E=>{M(E)},nr=E=>{E.preventDefault()},$t=E=>{if(V===null)return;const H=[...i],[ve]=H.splice(V,1);H.splice(E,0,ve),n(H),M(null),ct({referenceImages:H})};t.useEffect(()=>{const E=_.current;E&&F&&requestAnimationFrame(()=>{E.style.height="auto";const H=Math.max(60,Math.min(E.scrollHeight,600));E.style.height=`${H}px`})},[g,F]),t.useEffect(()=>{if(g===s.config.prompt)return;const E=setTimeout(()=>{ct({prompt:g})},500);return()=>clearTimeout(E)},[g]);const er=E=>{var ve,je,he;D(E);const H=Gs.find(Ie=>Ie.id===E);if(H){const Ie=(ve=H.config.supportedRatios)!=null&&ve.length?H.config.supportedRatios:["16:9"],nt=H.config.supportedResolutions||[],Ye=(je=H.config.supportedGenerationTypes)!=null&&je.length?H.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],Mt=(he=H.config.supportedDurations)!=null&&he.length?H.config.supportedDurations:[5],st=Ie[0],Be=nt.length>0?nt[0]:r,Dt=p(a||Ye[0]),Xt=Mt[0],jt=H.config.supportsAudioOutput?m:!1;W(st),k(Be),v(Dt),w(Xt),H.config.supportsAudioOutput||N(!1),ct({modelId:E,modelName:H.name,ratio:st,resolution:Be,generationType:Dt,duration:Xt,audio:jt,acceptedInputs:js(Dt)})}};t.useEffect(()=>{var H;const E=(H=s==null?void 0:s.config)==null?void 0:H.generatedVideoUrl;E&&$s(E,s.config.ratio||"16:9")},[(Ge=s==null?void 0:s.config)==null?void 0:Ge.generatedVideoUrl]);const bs=async E=>{let ve=0;const je=async()=>{try{ve++;const Ie=(await _e.tasks.getTaskStatus(E)).task;if(T(Ie.progress||0),Ie.status==="SUCCESS"||Ie.status==="COMPLETED"||Ie.status==="DONE"){c(!1),T(100);const nt=Ie.resultUrl;$s(nt,s.config.ratio||"16:9"),ct({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:nt}),Y(""),f.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>T(0),1e3);return}else if(Ie.status==="FAILURE"){c(!1),T(0),ct({taskId:""});const{useAuthStore:nt}=await us(async()=>{const{useAuthStore:Mt}=await import("./index-CiJ2Nd2F.js").then(st=>st.f);return{useAuthStore:Mt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ye}=nt.getState();await Ye(),f.error(Ie.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(Ie.status==="PROCESSING"||Ie.status==="PENDING")&&(ve<900?setTimeout(je,1e3):(c(!1),T(0),ct({taskId:""}),f.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{c(!1),T(0),ct({taskId:""}),f.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};je()},Ks=async()=>{var ve,je,he,Ie,nt,Ye,Mt;if(p(a)==="æ–‡ç”Ÿè§†é¢‘"&&!g.trim()){f.error("è¯·è¾“å…¥æç¤ºè¯");return}c(!0);const H=St();ct({referenceImages:H}),T(0);try{let st=[],Be;const Dt=i.length;if(i.length>0)try{for(const ws of i){let zt=ws.url;!zt.startsWith("data:")&&!zt.startsWith("http")&&(zt=`${fr}${zt}`),zt=zt.replace(/^https?:\/\/localhost(?::\d+)?/i,fr);const ls=await ur(zt);st.push(ls)}}catch{f.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=le.filter(ws=>ws.target===l);let jt=[];if(p(a)==="å‚è€ƒå›¾"){const ws=/@(\S+)/g,ls=[...g.matchAll(ws)].map(Kt=>Kt[1]);for(const Kt of ls){const Yt=Oe[Kt];Yt&&jt.push(Yt)}const os=new Map;for(const Kt of Xt){const Yt=ce(Kt.source);if((Yt==null?void 0:Yt.type)==="assetSelector"){const Cs=(ve=Yt.data.config)==null?void 0:ve.roleIds;if(Cs&&Cs.length>0)for(const ps of Cs)jt.includes(ps)||jt.push(ps);const ys=(je=Yt.data.config)==null?void 0:je.subjects;if(ys&&ys.length>0){for(const ps of ys)if(!os.has(ps.name)){const pr=(ps.images||[]).map(zs=>zs.startsWith("http")||zs.startsWith("data:")?zs:`${fr}${zs}`);os.set(ps.name,pr)}}}}if(os.size>0){const Kt=Array.from(os.entries());let Yt=0;const Cs=[];for(const[ys,ps]of Kt){if(Yt>=7)break;const pr=7-Yt,zs=ps.slice(0,Math.max(0,pr));zs.length>0&&(Cs.push({name:ys,images:zs}),Yt+=zs.length)}Be=Cs,Kt.some(([,ys])=>ys.length>0)&&Yt<Kt.reduce((ys,[,ps])=>ys+ps.length,0)&&f.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(st.length>0){const Kt=lt.filter(Yt=>!Yt.id.includes("subject"));Kt.length>0&&(Be||(Be=[]),Kt.forEach((Yt,Cs)=>{const ys=`å›¾${Cs+1}`,ps=Yt.url.startsWith("http")||Yt.url.startsWith("data:")?Yt.url:`${fr}${Yt.url}`;Be.push({name:ys,images:[ps]})}))}}const Ct=Be&&Be.length>0?Be.reduce((ws,zt)=>{var ls;return ws+(((ls=zt.images)==null?void 0:ls.length)||0)},0):Dt,Tt=jt.length>0;let Pt=a;if(Pt==="é¦–å¸§"||Pt==="å°¾å¸§"){if(Ct!==1&&!Tt){f.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),c(!1),T(0);return}}else if(Pt==="é¦–å°¾å¸§"){if(Ct===1)Pt="é¦–å¸§";else if(Ct!==2&&!Tt){f.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),c(!1),T(0);return}Be&&Be.length>0?Be=[{...Be[0],images:Be[0].images.slice(0,2)}]:st=st.slice(0,2)}else if(Pt==="å‚è€ƒå›¾"||Pt==="ä¸»ä½“å‚è€ƒ"){const zt=(se==null?void 0:se.modelId)==="veo3.1-components"?3:7;if(Ct<1&&!Tt){f.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),c(!1),T(0);return}if(Be&&Be.length>0){if(Be.reduce((os,Kt)=>{var Yt;return os+(((Yt=Kt.images)==null?void 0:Yt.length)||0)},0)>zt){let os=zt;Be=Be.map(Kt=>({...Kt,images:Kt.images.slice(0,Math.max(0,os-=Kt.images.length,Kt.images.length))})),os=zt,Be=Be.map(Kt=>{const Yt=Kt.images.slice(0,Math.min(Kt.images.length,os));return os-=Yt.length,{...Kt,images:Yt}}).filter(Kt=>Kt.images.length>0),f.info(`å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰${zt}å¼ `)}}else st.length>zt&&(st=st.slice(0,zt),f.info(`å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰${zt}å¼ `))}oe==="dropImages"&&(st=[],Be=void 0),(p(a)==="é¦–å¸§"||p(a)==="å°¾å¸§")&&oe==="useFirstImage"&&st.length>=2&&(st=[st[0]]),p(a)==="é¦–å°¾å¸§"&&oe==="useFirstTwoImages"&&st.length>=3&&(st=st.slice(0,2));const qt={modelId:z,ratio:C,referenceImages:Be&&Be.length>0?void 0:st.length>0?st:void 0,roleIds:jt.length>0?jt:void 0,generationType:Pt,sourceNodeId:l,metadata:{duration:u,resolution:r,audio:m,movementAmplitude:I,roleIds:jt.length>0?jt:void 0},...Be?{subjects:Be}:{}};Be&&Be.length>0;const Bt=p(Pt);if(Bt==="æ–‡ç”Ÿè§†é¢‘"){if(!g.trim()){f.error("è¯·è¾“å…¥æç¤ºè¯"),c(!1),T(0);return}qt.prompt=g.trim()}else if(Bt==="å‚è€ƒå›¾"){if(!g.trim()){f.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),c(!1),T(0);return}qt.prompt=g.trim()}else g.trim()&&(qt.prompt=g.trim());const rs=await _e.tasks.createVideoTask(qt),gs=rs.taskId,Ws=rs.creditsCharged||0,tr=rs.isFreeUsage,Fs=rs.freeUsageRemaining??0;if(Y(gs),ct({prompt:g,ratio:C,resolution:r,generationType:a,duration:u,modelId:z,taskId:gs}),tr)f.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Fs} æ¬¡`),Se();else if(Ws>0){const{useAuthStore:ws}=await us(async()=>{const{useAuthStore:ls}=await import("./index-CiJ2Nd2F.js").then(os=>os.f);return{useAuthStore:ls}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:zt}=ws.getState();await zt(),f.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${Ws} ç§¯åˆ†ï¼‰`),Se()}else f.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");bs(gs)}catch(st){if(c(!1),T(0),((he=st.response)==null?void 0:he.status)===403){const Be=((nt=(Ie=st.response)==null?void 0:Ie.data)==null?void 0:nt.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";f.error(Be)}else f.error(`æäº¤å¤±è´¥: ${((Mt=(Ye=st.response)==null?void 0:Ye.data)==null?void 0:Mt.error)||st.message}`)}},Es=async()=>{const E=p(a),H=St(),ve=H.length,je=(()=>{var nt;const Ie=le.filter(Ye=>Ye.target===l);for(const Ye of Ie){const Mt=ce(Ye.source);if((Mt==null?void 0:Mt.type)==="assetSelector"){const st=(nt=Mt.data.config)==null?void 0:nt.subjects;if(st&&st.length>0)return!0}}return!1})(),he=Object.keys(Oe).length>0;if((je||he)&&(E==="é¦–å¸§"||E==="å°¾å¸§"||E==="é¦–å°¾å¸§")){f.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((E==="é¦–å¸§"||E==="å°¾å¸§")&&ve===0&&!he){f.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(E==="é¦–å°¾å¸§"&&ve===0&&!he){f.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(E==="å‚è€ƒå›¾"&&ve===0&&!he){f.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(E==="æ–‡ç”Ÿè§†é¢‘"&&ve>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((E==="é¦–å¸§"||E==="å°¾å¸§")&&ve>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(E==="é¦–å°¾å¸§"&&ve>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(E==="æ–‡ç”Ÿè§†é¢‘"&&!g.trim()){f.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!z){f.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}n(H),ct({referenceImages:H}),c(!0),T(0),await Ks()},$s=(E,H)=>{const ve=ce(l);if(!ve||!E)return;const je=H||C||"16:9",he=be(),Ie=Ee(),nt=he.filter(zt=>zt.type==="videoPreview"&&Ie.some(ls=>ls.source===l&&ls.target===zt.id));if(nt.find(zt=>zt.data.videoUrl===E))return;const Mt=1,st=400,Be=(zt,ls=300)=>{if(!zt||!/^[0-9]+\s*:\s*[0-9]+$/.test(zt))return ls;const[os,Kt]=zt.split(":").map(Yt=>parseFloat(Yt));return!os||!Kt?ls:Math.round(st*(Kt/os))},Dt=document.querySelector(`.react-flow__node[data-id="${l}"]`),Xt=Dt==null?void 0:Dt.getBoundingClientRect(),jt=Math.round(((Xt==null?void 0:Xt.width)||400)/Mt),Ct=100,Tt=200,Pt=Be(je,300),qt=nt.length,Bt=ve.position.x+jt+Tt,rs=ve.position.y,gs=Bt,Ws=rs+qt*(Pt+Ct),tr=Date.now(),Fs={id:`preview-${l}-${tr}`,type:"videoPreview",position:{x:gs,y:Ws},data:{videoUrl:E,width:st,ratio:je,workflowContext:ve.data.workflowContext,createdBy:ve.data.createdBy}};ie(zt=>[...zt,Fs]);const ws={id:`edge-${l}-${Fs.id}`,source:l,target:Fs.id,targetHandle:`${Fs.id}-target`,type:"aurora"};we(zt=>zt.find(os=>os.source===l&&os.target===Fs.id)?zt:[...zt,ws])},sr=E=>{const H=E.target;if(H.tagName==="INPUT"||H.tagName==="TEXTAREA"||H.tagName==="SELECT"||H.tagName==="BUTTON"||H.closest("button")||H.closest("input")||H.closest("textarea")||H.closest("select"))return;const ve=!F;me(ve),ie(je=>je.map(he=>he.id===l?{...he,data:{...he.data,isExpanded:ve}}:he))};return e.jsxs("div",{onDoubleClick:sr,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var st;const E=((st=ce(l))==null?void 0:st.type)||"",H=p(a),ve=H==="æ–‡ç”Ÿè§†é¢‘"||E==="aiVideo_t2v",je=E==="aiVideo_i2v_first"||E==="aiVideo_i2v_last"||H==="é¦–å¸§"||H==="å°¾å¸§",he=E==="aiVideo_first_last"||H==="é¦–å°¾å¸§",Ie=E==="aiVideo_reference"||H==="å‚è€ƒå›¾",nt=le.filter(Be=>Be.target===l),Ye=nt.some(Be=>{const Dt=ce(Be.source);return(Dt==null?void 0:Dt.type)==="agent"}),Mt=nt.reduce((Be,Dt)=>{var Ct,Tt,Pt,qt;const Xt=ce(Dt.source),jt=(Xt==null?void 0:Xt.type)||"";if(jt==="aiImage"||jt==="imagePreview")return Be+1;if(jt==="upload"){const Bt=(Pt=(Tt=(Ct=Xt==null?void 0:Xt.data)==null?void 0:Ct.config)==null?void 0:Tt.uploadedFiles)==null?void 0:Pt[0],rs=((Bt==null?void 0:Bt.type)||"").toUpperCase(),gs=((Bt==null?void 0:Bt.mimeType)||"").toLowerCase();return Be+(rs==="IMAGE"||gs.startsWith("image/")?1:0)}if(jt==="assetSelector"){const Bt=((qt=Xt==null?void 0:Xt.data)==null?void 0:qt.config)||{};if(Bt.selectedAsset)return Be+((Bt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Bt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Bt.subjects&&Bt.subjects.length>0)return Be+((Bt.subjects[0].images||[]).length||0)}return Be},0);if(ve)return!Ye;if(je)return!(Ye&&Mt>=1);if(he)return!(Ye&&Mt>=2);if(Ie){const Dt=(se==null?void 0:se.modelId)==="veo3.1-components"?3:7;return!(Ye&&Mt>=Dt)}return!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),G&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ne}),ue==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{O(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{O(!1),f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{O(!1),await Ks()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(as,{value:z,onChange:E=>er(E),options:Gs.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Gs.map(E=>({value:E.id,label:E.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ve?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:_,value:g,onChange:E=>{var he;const H=(he=se==null?void 0:se.modelId)==null?void 0:he.includes("viduq2"),ve=p(a)==="å‚è€ƒå›¾";H&&ve?ts(E):(x(E.target.value),d(!1))},onKeyDown:E=>{var je;const H=(je=se==null?void 0:se.modelId)==null?void 0:je.includes("viduq2"),ve=p(a)==="å‚è€ƒå›¾";H&&ve&&Rs(E)},placeholder:(qe=se==null?void 0:se.modelId)!=null&&qe.includes("viduq2")&&p(a)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),h&&j.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:j.map((E,H)=>e.jsxs("button",{type:"button",onClick:()=>ms(E),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${H===Ce?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[E.thumbnail?e.jsx("img",{src:E.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",E.name]})})]},E.id))})]})]}),Object.keys(Oe).length>0&&((Pe=se==null?void 0:se.modelId)==null?void 0:Pe.includes("viduq2"))&&p(a)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys(Oe).map(E=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-neutral-500/10 dark:bg-neutral-500/20 border border-neutral-400/50 dark:border-neutral-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-neutral-700 dark:text-neutral-300",children:E}),e.jsx("button",{type:"button",onClick:()=>{Ue(je=>{const he={...je};return delete he[E],he});const H=new RegExp(`@${E}\\s*`,"g"),ve=g.replace(H,"");x(ve)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},E))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ve&&i.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(tt=i[0])!=null&&tt.name&&i[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",a==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",p(a)==="å‚è€ƒå›¾"&&i.some(E=>!E.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:i.map((E,H)=>{const ve=i.slice(0,H+1).filter(Ie=>!Ie.id.includes("subject")).length,je=!E.id.includes("subject"),he=je?`å›¾${ve}`:E.name;return e.jsxs("div",{draggable:a==="é¦–å°¾å¸§",onDragStart:()=>qs(H),onDragOver:nr,onDrop:()=>$t(H),onClick:()=>{je&&p(a)==="å‚è€ƒå›¾"&&It(he)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${a==="é¦–å°¾å¸§"?"cursor-move":je&&p(a)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${V===H?"opacity-50":""} ${E.id.includes("subject")?"border-neutral-400 dark:border-neutral-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-neutral-400 dark:hover:border-neutral-400/50 ${je&&p(a)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:je&&p(a)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${he}`:E.name,children:[e.jsx("img",{src:`${E.url.startsWith("http")||E.url.startsWith("data:")?E.url:fr+E.url}`,alt:E.name,className:"w-full h-full object-cover"}),E.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),E.name]}),je&&a!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),he]}),a==="é¦–å°¾å¸§"&&!E.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:H===0?"é¦–":H===1?"å°¾":H+1})]},E.id)})})]}),se&&!Ve&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",vt?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:et.map(E=>e.jsxs("button",{type:"button",onClick:()=>{w(E),ct({duration:E})},disabled:vt,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${u===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:[E,"ç§’"]},E))})]}),Is&&(((bt=se==null?void 0:se.config.supportedRatios)==null?void 0:bt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ve?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{W("16:9"),ct({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${C==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{W("9:16"),ct({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${C==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(as,{value:C,onChange:E=>{W(E),ct({ratio:E})},options:((se==null?void 0:se.config.supportedRatios)||[]).map(E=>{const[H,ve]=E.split(":");return{value:E,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[E]||`${H}:${ve}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Nt?"(æœªé…ç½®)":""]}),e.jsx(as,{value:r,onChange:E=>{k(E),ct({resolution:E})},options:kt.map(E=>({value:E,label:E})),className:Nt?"opacity-50 pointer-events-none":""})]}),((yt=se==null?void 0:se.provider)==null?void 0:yt.toLowerCase())==="vidu"&&(se==null?void 0:se.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(E=>e.jsx("button",{type:"button",onClick:()=>{U(E),ct({movementAmplitude:E})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${I===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:E==="auto"?"è‡ªåŠ¨":E==="small"?"å°":E==="medium"?"ä¸­":"å¤§"},E))})]}),(se==null?void 0:se.config.supportsAudioOutput)&&p(a)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const E=!m;N(E),ct({audio:E})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${m?"bg-neutral-800 dark:bg-white text-white dark:text-black":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${m?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:Es,disabled:y||s._canEdit===!1||p(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(g!=null&&g.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${y||p(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(g!=null&&g.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!fe&&(Q?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ee),"æ¬¡"]}):Ae!==null&&Ae>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Ae,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:g?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:g})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},gr=t.memo(Ka),Ya=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Qa=t.memo(Ya),Za=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},eo=t.memo(Za),to=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},so=t.memo(to),ro=s=>{const{data:S}=s;return e.jsx(gr,{...s,data:{...S,config:{...S==null?void 0:S.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},ao=t.memo(ro),oo=s=>{const S=(s==null?void 0:s.data)||{},l=S.config||{};return e.jsx(gr,{...s,data:{...S,config:{...l,generationType:(l==null?void 0:l.lockedGenerationType)||(l==null?void 0:l.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(l==null?void 0:l.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(l==null?void 0:l.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(l==null?void 0:l.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},no=t.memo(oo),lr="https://api.waule.ai",io=({data:s,selected:S,id:l})=>{var D,C,W,r,k,p;const[F]=t.useState(!0),[me,T]=t.useState(!1),[xe]=t.useState(""),[Y,ae]=t.useState("wan-std"),[Z,ge]=t.useState(0),Ae=t.useRef(null),{setNodes:fe,setEdges:Q,getNode:ee,getNodes:Se,getEdges:ie}=Zt(),we=Js(),ce=s.config.modelId,{credits:be,loading:Ee}=Ns({aiModelId:ce,duration:Z,mode:Y==="wan-pro"?"pro":"standard"}),le=t.useMemo(()=>{var u;const a=s.models||[],v=(u=s==null?void 0:s.config)==null?void 0:u.selectedEditingCapability;return a.filter(w=>{var m;return(w.type||"")==="VIDEO_EDITING"&&Array.isArray((m=w.config)==null?void 0:m.supportedEditingCapabilities)&&(v?w.config.supportedEditingCapabilities.includes(v):w.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||w.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(D=s==null?void 0:s.config)==null?void 0:D.selectedEditingCapability]),[te,R]=t.useState(s.config.modelId||((C=le[0])==null?void 0:C.id)||""),$=t.useMemo(()=>le.find(a=>a.id===te),[le,te]);t.useEffect(()=>{var a;if(!le.find(v=>v.id===te)){const v=((a=le[0])==null?void 0:a.id)||"";R(v),fe(u=>u.map(w=>{var m;return w.id===l?{...w,data:{...w.data,config:{...w.data.config,modelId:v||void 0,modelName:v?(m=le[0])==null?void 0:m.name:void 0}}}:w}))}},[le]),t.useEffect(()=>{},[$]);const P=t.useMemo(()=>{var I,U,y,c,i,n,V,M,G,O,ne,ue,oe,h,d,j;const a=we.filter(b=>b.target===l);let v=null,u=0,w=null,m=null,N=null;for(const b of a){const J=ee(b.source);if(!J)continue;const de=String(J.type||"");if(de==="upload"){const B=(y=(U=(I=J.data)==null?void 0:I.config)==null?void 0:U.uploadedFiles)==null?void 0:y[0];if(!B)continue;const pe=String(B.mimeType||"").toLowerCase(),Ce=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!w&&(Ce==="VIDEO"||pe.startsWith("video/"))&&(w=Ne,N=b.id),!v&&(Ce==="IMAGE"||pe.startsWith("image/"))&&(v=Ne,u=B.size||0,m=b.id)}else if(de==="assetSelector"){const B=(i=(c=J.data)==null?void 0:c.config)==null?void 0:i.selectedAsset;if(B){const Ce=String(B.mimeType||"").toLowerCase(),Ne=String(B.type||"").toUpperCase(),Oe=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${lr}${B.url}`;!w&&(Ne==="VIDEO"||Ce.startsWith("video/"))&&(w=Oe,N=b.id),!v&&(Ne==="IMAGE"||Ce.startsWith("image/"))&&(v=Oe,u=B.size||0,m=b.id)}const pe=((V=(n=J.data)==null?void 0:n.config)==null?void 0:V.subjects)||[];if(!v&&Array.isArray(pe)&&pe.length>0){const Ne=(((M=pe[0])==null?void 0:M.images)||[])[0];Ne&&(v=Ne.startsWith("http")||Ne.startsWith("data:")?Ne:`${lr}${Ne}`,m=b.id)}}else if(de==="aiImage"){const B=(O=(G=J.data)==null?void 0:G.config)==null?void 0:O.generatedImageUrl;!v&&B&&(v=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,m=b.id)}else if(de==="imagePreview"){const B=((ne=J.data)==null?void 0:ne.imageUrl)||((ue=J.data)==null?void 0:ue.url);!v&&B&&(v=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,m=b.id)}else if(de==="videoPreview"||de.startsWith("aiVideo")){const B=((oe=J.data)==null?void 0:oe.videoUrl)||((h=J.data)==null?void 0:h.url)||((j=(d=J.data)==null?void 0:d.config)==null?void 0:j.generatedVideoUrl);!w&&B&&(w=B.startsWith("http")||B.startsWith("data:")?B:`${lr}${B}`,N=b.id)}if(v&&w)break}return{imageUrl:v,videoUrl:w,imageSize:u,imageEdgeId:m,videoEdgeId:N}},[we,l,ee]);t.useEffect(()=>{if(P.imageSize>5*1024*1024){const v=(P.imageSize/1024/1024).toFixed(2);f.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${v}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),P.imageEdgeId&&Q(u=>u.filter(w=>w.id!==P.imageEdgeId))}if(!P.videoUrl){ge(0);return}const a=document.createElement("video");a.src=P.videoUrl,a.onloadedmetadata=()=>{const v=a.duration||0,u=a.videoWidth,w=a.videoHeight;ge(v);let m="";v<2||v>30?m=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${v.toFixed(1)}ç§’ï¼‰`:(u>2048||w>2048)&&(m=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${u}x${w}ï¼‰`),m&&(f.error(m+"ï¼Œè¿æ¥å·²æ–­å¼€"),P.videoEdgeId&&Q(N=>N.filter(I=>I.id!==P.videoEdgeId)))},a.onerror=()=>ge(0),a.load()},[P.videoUrl,P.imageSize,P.videoEdgeId,P.imageEdgeId,Q]);const g=t.useMemo(()=>!!te&&!!P.videoUrl&&!!P.imageUrl,[te,P.videoUrl,P.imageUrl]),x=t.useCallback(a=>{var h,d,j;const v=ee(l);if(!v||!a)return;const u=Se(),w=ie(),m=u.filter(b=>b.type==="videoPreview"&&w.some(J=>J.source===l&&J.target===b.id));if(m.find(b=>{var J;return((J=b.data)==null?void 0:J.videoUrl)===a}))return;const I=400,U=(b,J=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(b))return J;const[de,B]=b.split(":").map(pe=>parseFloat(pe));return!de||!B?J:Math.round(I*(B/de))},y=200,c=100,i=U("16:9",300),n=document.querySelector(`.react-flow__node[data-id="${l}"]`),V=Math.round((n==null?void 0:n.getBoundingClientRect().width)||400),M=(((h=v.position)==null?void 0:h.x)||0)+V+y,G=((d=v.position)==null?void 0:d.y)||0,O=m.length,ne=M,ue=G+O*(i+c),oe={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:ne,y:ue},data:{videoUrl:a,width:I,ratio:"16:9",workflowContext:v.data.workflowContext,createdBy:(j=v.data)==null?void 0:j.createdBy}};fe(b=>[...b,oe]),Q(b=>[...b,{id:`edge-${l}-${oe.id}`,source:l,target:oe.id,type:"aurora"}])},[l,ee,Se,ie,fe,Q]);t.useEffect(()=>{var v;const a=(v=s==null?void 0:s.config)==null?void 0:v.generatedVideoUrl;a&&x(a)},[(W=s==null?void 0:s.config)==null?void 0:W.generatedVideoUrl]),t.useEffect(()=>{const a=s.config.taskId;(async()=>{var w,m;let u=!1;if(a)try{const I=(await _e.tasks.getTaskStatus(a)).task;if(I.status==="SUCCESS"){const U=I.resultUrl||((w=I.previewNodeData)==null?void 0:w.url);if(U){let y=!1;try{const c=localStorage.getItem("suppressedPreviewTasks")||"[]";y=JSON.parse(c).some(n=>n.taskId&&n.taskId===a||n.sourceNodeId&&n.sourceNodeId===l)}catch{}y||x(U),fe(c=>c.map(i=>i.id===l?{...i,data:{...i.data,config:{...i.data.config,generatedVideoUrl:U,taskId:a}}}:i))}T(!1),u=!0}else if(I.status==="PROCESSING"||I.status==="PENDING"){T(!0),await _(a);return}else I.status==="FAILURE"&&(T(!1),fe(U=>U.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,taskId:""}}}:y)))}catch{T(!1)}if(!u)try{const N=await _e.tasks.getPendingPreviewNodes(l);if(Array.isArray(N.tasks)&&N.tasks.length>0)for(const I of N.tasks){const U=(m=I.previewNodeData)==null?void 0:m.url;if(U){let y=!1;try{const c=localStorage.getItem("suppressedPreviewTasks")||"[]";y=JSON.parse(c).some(n=>n.taskId&&n.taskId===I.id||n.sourceNodeId&&n.sourceNodeId===l)}catch{}y||x(U),await _e.tasks.markPreviewNodeCreated(I.id)}}}catch{}})()},[]);const _=async a=>{let v=0;const u=600,w=async()=>{var m;try{v++;const I=(await _e.tasks.getTaskStatus(a)).task;if(I.status==="SUCCESS"){const U=I.resultUrl||((m=I.previewNodeData)==null?void 0:m.url);if(U){let y=!1;try{const c=localStorage.getItem("suppressedPreviewTasks")||"[]";y=JSON.parse(c).some(n=>n.taskId&&n.taskId===a||n.sourceNodeId&&n.sourceNodeId===l)}catch{}y||x(U),fe(c=>c.map(i=>i.id!==l?i:{...i,data:{...i.data,config:{...i.data.config,generatedVideoUrl:U,taskId:a}}}))}T(!1),f.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(I.status==="PROCESSING"||I.status==="PENDING")if(v<u)setTimeout(w,5e3);else{T(!1),f.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),fe(U=>U.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,taskId:""}}}:y));return}else if(I.status==="FAILURE"){T(!1);try{const{useAuthStore:U}=await us(async()=>{const{useAuthStore:c}=await import("./index-CiJ2Nd2F.js").then(i=>i.f);return{useAuthStore:c}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:y}=U.getState();await y()}catch{}f.error(I.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),fe(U=>U.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,taskId:""}}}:y));return}else{T(!1),f.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),fe(U=>U.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,taskId:""}}}:y));return}}catch{T(!1),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),fe(I=>I.map(U=>U.id===l?{...U,data:{...U.data,config:{...U.data.config,taskId:""}}}:U));return}};w()},z=async()=>{var a,v;if(!g){f.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}T(!0);try{const u=await _e.post("/tasks/video-edit",{modelId:te,prompt:xe||"",referenceImages:P.imageUrl?[P.imageUrl]:[],sourceNodeId:l,duration:Z,metadata:{videoUrl:P.videoUrl,wanMode:Y,duration:Z}}),w=u.taskId,m=u.creditsCharged||0;if(m>0)try{const{useAuthStore:N}=await us(async()=>{const{useAuthStore:U}=await import("./index-CiJ2Nd2F.js").then(y=>y.f);return{useAuthStore:U}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:I}=N.getState();await I(),f.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${m} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{f.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else f.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");fe(N=>N.map(I=>I.id===l?{...I,data:{...I.data,config:{...I.data.config,taskId:w}}}:I)),await _(w)}catch(u){T(!1);const w=((v=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:v.error)||u.message||"æœªçŸ¥åŸå› ";f.error(`å¯åŠ¨å¤±è´¥ï¼š${w}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(as,{value:te,onChange:a=>{R(a),fe(v=>v.map(u=>{var w;return u.id===l?{...u,data:{...u.data,config:{...u.data.config,modelId:a,modelName:(w=le.find(m=>m.id===a))==null?void 0:w.name}}}:u}))},options:le.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:le.map(a=>({value:a.id,label:a.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>ae("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Y==="wan-std"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>ae("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Y==="wan-pro"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((k=s==null?void 0:s.config)==null?void 0:k.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),P.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Ae,src:P.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:a=>{const v=a.currentTarget;v.duration&&v.duration!==1/0&&ge(v.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((p=s==null?void 0:s.config)==null?void 0:p.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),P.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:P.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:z,disabled:me||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${me?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:me?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ee&&(be!==null&&be>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[be,"ç§¯åˆ†"]}):Z===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},lo=t.memo(io),yr="https://api.waule.ai",co=({data:s,selected:S,id:l})=>{var U,y;const[F]=t.useState(!0),[me,T]=t.useState(!1),[xe,Y]=t.useState(!1),ae=t.useRef(null),Z=t.useRef(null),ge=t.useRef(null),[Ae,fe]=t.useState(!1),[Q,ee]=t.useState(0),[Se,ie]=t.useState(0),[we,ce]=t.useState(0),[be,Ee]=t.useState(null),{setNodes:le,setEdges:te,getNode:R,getNodes:$,getEdges:P}=Zt(),g=Js(),x=Os(),_=t.useMemo(()=>`lipSyncTask:${l}`,[l]),z=t.useMemo(()=>(s.models||[]).filter(i=>{var n;return(i.type||"")==="VIDEO_EDITING"&&Array.isArray((n=i.config)==null?void 0:n.supportedEditingCapabilities)&&i.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[D,C]=t.useState(s.config.modelId||((U=z[0])==null?void 0:U.id)||"");t.useEffect(()=>{var c;if(!z.find(i=>i.id===D)){const i=((c=z[0])==null?void 0:c.id)||"";C(i),le(n=>n.map(V=>{var M;return V.id===l?{...V,data:{...V.data,config:{...V.data.config,modelId:i||void 0,modelName:i?(M=z[0])==null?void 0:M.name:void 0}}}:V}))}},[z]);const W=t.useMemo(()=>!Se||!Q?0:Se>=Q||xe?Q:Se,[Se,Q,xe]),{credits:r,loading:k}=Ns({aiModelId:D,duration:W,mode:"standard",operationType:"video_retalk"}),p=t.useMemo(()=>{var M,G,O,ne,ue,oe,h,d,j;const c=g.filter(b=>b.target===l);let i=null,n=null,V=null;for(const b of c){const J=x.find(B=>B.id===b.source);if(!J)continue;const de=String(J.type||"");if(de==="upload"){const B=(O=(G=(M=J.data)==null?void 0:M.config)==null?void 0:G.uploadedFiles)==null?void 0:O[0];if(!B)continue;const pe=String(B.mimeType||"").toLowerCase(),Ce=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${yr}${B.url}`;!i&&(Ce==="VIDEO"||pe.startsWith("video/"))&&(i=Ne),!n&&(Ce==="AUDIO"||pe.startsWith("audio/"))&&(n=Ne),!V&&(Ce==="IMAGE"||pe.startsWith("image/"))&&(V=Ne)}else if(de==="assetSelector"){const B=(ue=(ne=J.data)==null?void 0:ne.config)==null?void 0:ue.selectedAsset;if(B){const pe=String(B.mimeType||"").toLowerCase(),Ce=String(B.type||"").toUpperCase(),Ne=B.url.startsWith("http")||B.url.startsWith("data:")?B.url:`${yr}${B.url}`;!i&&(Ce==="VIDEO"||pe.startsWith("video/"))&&(i=Ne),!n&&(Ce==="AUDIO"||pe.startsWith("audio/"))&&(n=Ne),!V&&(Ce==="IMAGE"||pe.startsWith("image/"))&&(V=Ne)}}else if(de==="videoPreview"||de.startsWith("aiVideo")){const B=((oe=J.data)==null?void 0:oe.videoUrl)||((h=J.data)==null?void 0:h.url)||((j=(d=J.data)==null?void 0:d.config)==null?void 0:j.generatedVideoUrl);!i&&B&&(i=B.startsWith("http")||B.startsWith("data:")?B:`${yr}${B}`)}if(i&&n&&V)break}return{videoUrl:i,audioUrl:n,imageUrl:V}},[g,l,x]),a=t.useMemo(()=>{var i;const c=z.find(n=>n.id===D);return((i=c==null?void 0:c.modelId)==null?void 0:i.toLowerCase().includes("videoretalk"))||!1},[D,z]),v=t.useMemo(()=>!!D&&!!p.videoUrl&&!!p.audioUrl&&!be,[D,p.videoUrl,p.audioUrl,be]);t.useEffect(()=>{const c=ae.current;if(!c||!p.audioUrl)return;c.src=p.audioUrl,c.load();const i=()=>{ee(c.duration||0)},n=()=>ce(c.duration?c.currentTime/c.duration:0),V=()=>fe(!1);return c.addEventListener("loadedmetadata",i),c.addEventListener("timeupdate",n),c.addEventListener("ended",V),()=>{c.removeEventListener("loadedmetadata",i),c.removeEventListener("timeupdate",n),c.removeEventListener("ended",V)}},[p.audioUrl]),t.useEffect(()=>{if(!p.videoUrl){ie(0);return}const c=document.createElement("video");c.src=p.videoUrl,c.onloadedmetadata=()=>{if(ie(c.duration||0),a){const i=c.videoWidth,n=c.videoHeight;i>2048||n>2048?(Ee(`è§†é¢‘åˆ†è¾¨ç‡ ${i}x${n} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),f.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${i}x${n}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),te(V=>V.filter(M=>{var ne,ue,oe,h,d,j,b,J;if(M.target!==l)return!0;const G=x.find(de=>de.id===M.source);return G?!(G.type==="upload"&&((h=(oe=(ue=(ne=G.data)==null?void 0:ne.config)==null?void 0:ue.uploadedFiles)==null?void 0:oe[0])==null?void 0:h.type)==="VIDEO"||G.type==="assetSelector"&&((b=(j=(d=G.data)==null?void 0:d.config)==null?void 0:j.selectedAsset)==null?void 0:b.type)==="VIDEO"||G.type==="videoPreview"||((J=G.type)==null?void 0:J.startsWith("aiVideo"))):!0}))):be!=null&&be.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ee(null)}},c.onerror=()=>ie(0),c.load()},[p.videoUrl,a,l,x,te]),t.useEffect(()=>{const c=p.audioUrl,i=ge.current;if(!c||!i)return;const n=M=>{const G=i.getContext("2d");if(!G)return;const O=i.width,ne=i.height;G.clearRect(0,0,O,ne);const ue="#1a1033",oe="#7a0fe8";G.fillStyle=ue,G.fillRect(0,0,O,ne);const h=M.length,d=2,j=Math.max(1,Math.floor((O-(h-1)*d)/h));for(let b=0;b<h;b++){const J=Math.min(1,Math.max(0,M[b])),de=Math.max(2,Math.floor(J*ne)),B=b*(j+d),pe=Math.floor((ne-de)/2);G.fillStyle=oe,G.fillRect(B,pe,j,de)}if(we>0){const b=Math.floor(O*we);G.fillStyle="#ffffff88",G.fillRect(b,0,2,ne)}};(async()=>{try{let M=c;c.includes("aliyuncs.com")&&(M=`https://api.waule.ai/proxy/audio?url=${encodeURIComponent(c)}`);const O=await(await fetch(M,{mode:(c.includes("aliyuncs.com"),"cors"),credentials:c.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ne=window.AudioContext||window.webkitAudioContext,h=(await new ne().decodeAudioData(O)).getChannelData(0),d=120,j=Math.max(1,Math.floor(h.length/d)),b=new Float32Array(d);for(let J=0;J<d;J++){let de=0,B=0;const pe=J*j,Ce=Math.min(h.length,pe+j);for(let Ne=pe;Ne<Ce;Ne++)de+=Math.abs(h[Ne]),B++;b[J]=B?de/B:0}n(b)}catch{const G=new Float32Array(120);for(let O=0;O<120;O++)G[O]=(Math.sin(O/5)+1)/2;n(G)}})()},[p.audioUrl,we]);const u=()=>{const c=ae.current;c&&(Ae?(c.pause(),fe(!1)):(c.play(),fe(!0)))},w=c=>{if(!c||!isFinite(c))return"0:00";const i=Math.floor(c/60),n=Math.floor(c%60);return`${i}:${n.toString().padStart(2,"0")}`},m=t.useCallback(c=>{var Oe,Ue,Re;const i=R(l);if(!i||!c)return;const n=c.startsWith("http")||c.startsWith("data:")?c:`${yr}${c}`,V=$(),M=P(),G=V.filter(Te=>Te.type==="videoPreview"&&M.some(se=>se.source===l&&se.target===Te.id));if(G.find(Te=>{var se;return((se=Te.data)==null?void 0:se.videoUrl)===n}))return;const ne=400,ue=(Te,se=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(Te))return se;const[Ve,et]=Te.split(":").map(kt=>parseFloat(kt));return!Ve||!et?se:Math.round(ne*(et/Ve))},oe=200,h=100,d=ue("16:9",300),j=document.querySelector(`.react-flow__node[data-id="${l}"]`),b=Math.round((j==null?void 0:j.getBoundingClientRect().width)||400),J=(((Oe=i.position)==null?void 0:Oe.x)||0)+b+oe,de=((Ue=i.position)==null?void 0:Ue.y)||0,B=G.length,pe=J,Ce=de+B*(d+h),Ne={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:pe,y:Ce},data:{videoUrl:n,ratio:"16:9",workflowContext:i.data.workflowContext,createdBy:(Re=i.data)==null?void 0:Re.createdBy}};le(Te=>[...Te,Ne]),te(Te=>[...Te,{id:`edge-${l}-${Ne.id}`,source:l,target:Ne.id,type:"aurora"}])},[l,R,$,P,le,te]);t.useEffect(()=>{var i;const c=(i=s==null?void 0:s.config)==null?void 0:i.generatedVideoUrl;c&&m(c)},[(y=s==null?void 0:s.config)==null?void 0:y.generatedVideoUrl]),t.useEffect(()=>{const c=s.config.taskId||(()=>{try{return localStorage.getItem(_)||""}catch{return""}})();(async()=>{var V,M;let n=!1;if(c)try{const O=(await _e.tasks.getTaskStatus(c)).task;if(O.status==="PROCESSING"||O.status==="PENDING"){const ne=new Date(O.createdAt);if((new Date().getTime()-ne.getTime())/(1e3*60*60)>1){T(!1),le(h=>h.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}}if(O.status==="SUCCESS"||O.status==="COMPLETED"||O.status==="DONE"){const ne=O.resultUrl||((V=O.previewNodeData)==null?void 0:V.url);if(ne){let ue=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";ue=JSON.parse(oe).some(d=>d.taskId&&d.taskId===c||d.sourceNodeId&&d.sourceNodeId===l)}catch{}ue||m(ne),le(oe=>oe.map(h=>h.id===l?{...h,data:{...h.data,config:{...h.data.config,generatedVideoUrl:ne,taskId:c}}}:h))}T(!1);try{localStorage.removeItem(_)}catch{}n=!0}else if(O.status==="PROCESSING"||O.status==="PENDING"){T(!0),await N(c);return}else if(O.status==="FAILURE"||O.status==="FAILED"){T(!1),le(ne=>ne.map(ue=>ue.id===l?{...ue,data:{...ue.data,config:{...ue.data.config,taskId:""}}}:ue));try{localStorage.removeItem(_)}catch{}}}catch{T(!1);try{localStorage.removeItem(_)}catch{}}if(!n)try{const G=await _e.tasks.getPendingPreviewNodes(l);if(Array.isArray(G.tasks)&&G.tasks.length>0)for(const O of G.tasks){const ne=(M=O.previewNodeData)==null?void 0:M.url;if(ne){let ue=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";ue=JSON.parse(oe).some(d=>d.taskId&&d.taskId===O.id||d.sourceNodeId&&d.sourceNodeId===l)}catch{}ue||m(ne),await _e.tasks.markPreviewNodeCreated(O.id)}}}catch{}})()},[_,l,m]);const N=async c=>{let i=0;const n=600;let V=-1,M=0;const G=60,O=async()=>{var ne;try{i++;const oe=(await _e.tasks.getTaskStatus(c)).task;if(oe.status==="PROCESSING"||oe.status==="PENDING"){const h=oe.progress||0;if(h===V){if(M++,M>=G){T(!1),f.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),le(d=>d.map(j=>j.id===l?{...j,data:{...j.data,config:{...j.data.config,taskId:""}}}:j));try{localStorage.removeItem(_)}catch{}return}}else V=h,M=0}if(oe.status==="SUCCESS"||oe.status==="COMPLETED"||oe.status==="DONE"){const h=oe.resultUrl||((ne=oe.previewNodeData)==null?void 0:ne.url);h&&(m(h),le(d=>d.map(j=>j.id===l?{...j,data:{...j.data,config:{...j.data.config,generatedVideoUrl:h,taskId:c}}}:j))),T(!1),f.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(_)}catch{}return}else if(oe.status==="PROCESSING"||oe.status==="PENDING")if(i<n)setTimeout(O,5e3);else{T(!1),f.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),le(h=>h.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}else if(oe.status==="FAILURE"||oe.status==="FAILED"){T(!1);try{const{useAuthStore:h}=await us(async()=>{const{useAuthStore:j}=await import("./index-CiJ2Nd2F.js").then(b=>b.f);return{useAuthStore:j}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:d}=h.getState();await d()}catch{}f.error(oe.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),le(h=>h.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}else{T(!1),f.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),le(h=>h.map(d=>d.id===l?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d));try{localStorage.removeItem(_)}catch{}return}}catch{T(!1),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),le(oe=>oe.map(h=>h.id===l?{...h,data:{...h.data,config:{...h.data.config,taskId:""}}}:h));try{localStorage.removeItem(_)}catch{}return}};O()},I=async()=>{var c,i;if(!v){f.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}T(!0);try{const n=await _e.post("/tasks/video-edit",{modelId:D,prompt:"",referenceImages:p.imageUrl?[p.imageUrl]:[],sourceNodeId:l,generationType:"å¯¹å£å‹",duration:W,metadata:{videoUrl:p.videoUrl,audioUrl:p.audioUrl,videoExtension:xe,duration:W}}),V=n.taskId,M=n.creditsCharged||0;if(M>0)try{const{useAuthStore:G}=await us(async()=>{const{useAuthStore:ne}=await import("./index-CiJ2Nd2F.js").then(ue=>ue.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:O}=G.getState();await O(),f.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{f.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else f.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");le(G=>G.map(O=>O.id===l?{...O,data:{...O.data,config:{...O.data.config,taskId:V}}}:O));try{localStorage.setItem(_,V)}catch{}await N(V)}catch(n){T(!1);const V=((i=(c=n==null?void 0:n.response)==null?void 0:c.data)==null?void 0:i.error)||n.message||"æœªçŸ¥åŸå› ";f.error(`å¯åŠ¨å¤±è´¥ï¼š${V}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(_)}catch{}}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(as,{value:D,onChange:c=>{C(c),le(i=>i.map(n=>{var V;return n.id===l?{...n,data:{...n.data,config:{...n.data.config,modelId:c,modelName:(V=z.find(M=>M.id===c))==null?void 0:V.name}}}:n}))},options:z.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:z.map(c=>({value:c.id,label:c.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:p.videoUrl?e.jsx("video",{src:p.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},p.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:p.imageUrl?e.jsx("img",{src:p.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},p.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),p.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:u,className:"nodrag w-7 h-7 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Ae?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:w(Q)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:ge,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:ae,src:p.audioUrl,className:"hidden"}),e.jsx("video",{ref:Z,className:"hidden",muted:!0,onLoadedMetadata:c=>{const i=c.currentTarget;i.duration&&i.duration!==1/0&&ie(i.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:xe,onChange:c=>Y(c.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:I,disabled:me||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${me?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:me?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!k&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[r,"ç§¯åˆ†"]}):W===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},uo=t.memo(co),Ir="https://api.waule.ai",go=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],po=({data:s,selected:S,id:l})=>{var z,D;const[F]=t.useState(!0),[me,T]=t.useState(!1),[xe,Y]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[ae,Z]=t.useState(s.config.videoFps||15),[ge,Ae]=t.useState(0),fe=t.useRef(null),{setNodes:Q,setEdges:ee,getNode:Se,getNodes:ie,getEdges:we}=Zt(),ce=Js(),be=t.useMemo(()=>(s.models||[]).filter(W=>{var r;return(W.type||"")==="VIDEO_EDITING"&&Array.isArray((r=W.config)==null?void 0:r.supportedEditingCapabilities)&&W.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ee,le]=t.useState(s.config.modelId||((z=be[0])==null?void 0:z.id)||""),{credits:te,loading:R}=Ns({aiModelId:Ee,duration:ge});t.useMemo(()=>be.find(C=>C.id===Ee),[be,Ee]),t.useEffect(()=>{var C;if(!be.find(W=>W.id===Ee)){const W=((C=be[0])==null?void 0:C.id)||"";le(W),Q(r=>r.map(k=>{var p;return k.id===l?{...k,data:{...k.data,config:{...k.data.config,modelId:W||void 0,modelName:W?(p=be[0])==null?void 0:p.name:void 0}}}:k}))}},[be]);const $=t.useMemo(()=>{var r,k,p,a,v,u,w,m,N;const C=ce.filter(I=>I.target===l);let W=null;for(const I of C){const U=Se(I.source);if(!U)continue;const y=String(U.type||"");if(y==="upload"){const c=(p=(k=(r=U.data)==null?void 0:r.config)==null?void 0:k.uploadedFiles)==null?void 0:p[0];if(!c)continue;const i=String(c.mimeType||"").toLowerCase(),n=String(c.type||"").toUpperCase(),V=c.url.startsWith("http")||c.url.startsWith("data:")?c.url:`${Ir}${c.url}`;!W&&(n==="VIDEO"||i.startsWith("video/"))&&(W=V)}else if(y==="assetSelector"){const c=(v=(a=U.data)==null?void 0:a.config)==null?void 0:v.selectedAsset;if(c){const i=String(c.mimeType||"").toLowerCase(),n=String(c.type||"").toUpperCase(),V=c.url.startsWith("http")||c.url.startsWith("data:")?c.url:`${Ir}${c.url}`;!W&&(n==="VIDEO"||i.startsWith("video/"))&&(W=V)}}else if(y==="videoPreview"||y.startsWith("aiVideo")){const c=((u=U.data)==null?void 0:u.videoUrl)||((w=U.data)==null?void 0:w.url)||((N=(m=U.data)==null?void 0:m.config)==null?void 0:N.generatedVideoUrl);!W&&c&&(W=c.startsWith("http")||c.startsWith("data:")?c:`${Ir}${c}`)}if(W)break}return{videoUrl:W}},[ce,l,Se]);t.useEffect(()=>{if(!$.videoUrl){Ae(0);return}const C=document.createElement("video");C.preload="metadata",C.onloadedmetadata=()=>{C.duration&&C.duration!==1/0&&Ae(C.duration)},C.onerror=()=>Ae(0),C.src=$.videoUrl},[$.videoUrl]);const P=t.useMemo(()=>!!Ee&&!!$.videoUrl,[Ee,$.videoUrl]),g=t.useCallback(C=>{var G,O,ne;const W=Se(l);if(!W||!C)return;const r=ie(),k=we(),p=r.filter(ue=>ue.type==="videoPreview"&&k.some(oe=>oe.source===l&&oe.target===ue.id));if(p.find(ue=>{var oe;return((oe=ue.data)==null?void 0:oe.videoUrl)===C}))return;const v=400,u=(ue,oe=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(ue))return oe;const[h,d]=ue.split(":").map(j=>parseFloat(j));return!h||!d?oe:Math.round(v*(d/h))},w=200,m=100,N=u("16:9",300),I=document.querySelector(`.react-flow__node[data-id="${l}"]`),U=Math.round((I==null?void 0:I.getBoundingClientRect().width)||400),y=(((G=W.position)==null?void 0:G.x)||0)+U+w,c=((O=W.position)==null?void 0:O.y)||0,i=p.length,n=y,V=c+i*(N+m),M={id:`preview-${l}-${Date.now()}`,type:"videoPreview",position:{x:n,y:V},data:{videoUrl:C,width:v,ratio:"16:9",workflowContext:W.data.workflowContext,createdBy:(ne=W.data)==null?void 0:ne.createdBy}};Q(ue=>[...ue,M]),ee(ue=>[...ue,{id:`edge-${l}-${M.id}`,source:l,target:M.id,type:"aurora"}])},[l,Se,ie,we,Q,ee]);t.useEffect(()=>{var W;const C=(W=s==null?void 0:s.config)==null?void 0:W.generatedVideoUrl;C&&g(C)},[(D=s==null?void 0:s.config)==null?void 0:D.generatedVideoUrl]),t.useEffect(()=>{const C=s.config.taskId;(async()=>{var k,p;let r=!1;if(C)try{const v=(await _e.tasks.getTaskStatus(C)).task;if(v.status==="SUCCESS"){const u=v.resultUrl||((k=v.previewNodeData)==null?void 0:k.url);if(u){let w=!1;try{const m=localStorage.getItem("suppressedPreviewTasks")||"[]";w=JSON.parse(m).some(I=>I.taskId&&I.taskId===C||I.sourceNodeId&&I.sourceNodeId===l)}catch{}w||g(u),Q(m=>m.map(N=>N.id===l?{...N,data:{...N.data,config:{...N.data.config,generatedVideoUrl:u,taskId:C}}}:N))}T(!1),r=!0}else if(v.status==="PROCESSING"||v.status==="PENDING"){T(!0),await x(C);return}else v.status==="FAILURE"&&(T(!1),Q(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,taskId:""}}}:w)))}catch{T(!1)}if(!r)try{const a=await _e.tasks.getPendingPreviewNodes(l);if(Array.isArray(a.tasks)&&a.tasks.length>0)for(const v of a.tasks){const u=(p=v.previewNodeData)==null?void 0:p.url;if(u){let w=!1;try{const m=localStorage.getItem("suppressedPreviewTasks")||"[]";w=JSON.parse(m).some(I=>I.taskId&&I.taskId===v.id||I.sourceNodeId&&I.sourceNodeId===l)}catch{}w||g(u),await _e.tasks.markPreviewNodeCreated(v.id)}}}catch{}})()},[]);const x=async C=>{let W=0;const r=600,k=async()=>{var p;try{W++;const v=(await _e.tasks.getTaskStatus(C)).task;if(v.status==="SUCCESS"){const u=v.resultUrl||((p=v.previewNodeData)==null?void 0:p.url);u&&(g(u),Q(w=>w.map(m=>m.id!==l?m:{...m,data:{...m.data,config:{...m.data.config,generatedVideoUrl:u,taskId:C}}}))),T(!1),f.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else v.status==="PROCESSING"||v.status==="PENDING"?W<r?setTimeout(k,5e3):(T(!1),f.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Q(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,taskId:""}}}:w))):v.status==="FAILURE"&&(T(!1),f.error(v.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),Q(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,taskId:""}}}:w)))}catch{T(!1),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Q(v=>v.map(u=>u.id===l?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u))}};k()},_=async()=>{var C,W;if(!P){f.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}T(!0);try{const r=await _e.post("/tasks/video-edit",{modelId:Ee,prompt:"",referenceImages:[],sourceNodeId:l,generationType:"é£æ ¼è½¬æ¢",duration:ge,metadata:{videoUrl:$.videoUrl,styleId:xe,videoFps:ae,duration:ge}}),k=r.taskId,p=r.creditsCharged||0;if(p>0)try{const{useAuthStore:a}=await us(async()=>{const{useAuthStore:u}=await import("./index-CiJ2Nd2F.js").then(w=>w.f);return{useAuthStore:u}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:v}=a.getState();await v(),f.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${p} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{f.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else f.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");Q(a=>a.map(v=>v.id===l?{...v,data:{...v.data,config:{...v.data.config,taskId:k,styleId:xe,videoFps:ae}}}:v)),await x(k)}catch(r){T(!1);const k=((W=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:W.error)||r.message||"æœªçŸ¥åŸå› ";f.error(`å¯åŠ¨å¤±è´¥ï¼š${k}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(as,{value:Ee,onChange:C=>{le(C),Q(W=>W.map(r=>{var k;return r.id===l?{...r,data:{...r.data,config:{...r.data.config,modelId:C,modelName:(k=be.find(p=>p.id===C))==null?void 0:k.name}}}:r}))},options:be.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:be.map(C=>({value:C.id,label:C.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(as,{value:String(xe),onChange:C=>{const W=parseInt(C,10);Y(W),Q(r=>r.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,styleId:W}}}:k))},options:go.map(C=>({value:String(C.id),label:C.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:ae,min:15,max:25,onChange:C=>{let W=parseInt(C.target.value,10)||15;W<15&&(W=15),W>25&&(W=25),Z(W),Q(r=>r.map(k=>k.id===l?{...k,data:{...k.data,config:{...k.data.config,videoFps:W}}}:k))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),$.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:fe,src:$.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:C=>{const W=C.currentTarget;W.duration&&W.duration!==1/0&&Ae(W.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:_,disabled:me||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${me?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:me?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!R&&(te!==null&&te>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[te,"ç§¯åˆ†"]}):ge===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ho=t.memo(po),fo=({data:s,selected:S,id:l})=>{const[F,me]=t.useState(null),[T,xe]=t.useState(!1),[Y,ae]=t.useState(s.config.prompt||""),[Z,ge]=t.useState(""),Ae=t.useRef(null),fe=t.useRef(!1),[Q,ee]=t.useState(!1),{setNodes:Se,setEdges:ie,getNode:we,getNodes:ce,getEdges:be}=Zt(),Ee=Xs(a=>a.edges.filter(v=>v.target===l)),le=Os(),[te,R]=t.useState([]),[$,P]=t.useState([]),g=t.useRef(""),x=t.useMemo(()=>((F==null?void 0:F.roles)||[]).find(a=>a.id===Z),[F,Z]),{credits:_,loading:z,isFreeUsage:D,freeUsageRemaining:C}=Ns({aiModelId:x==null?void 0:x.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&W(s.config.agentId)},[s.config.agentId]);const W=async a=>{var v,u,w,m,N;try{xe(!0);const I=await _e.agents.getById(a);let U=[];try{U=await _e.agents.roles.listByAgent(a)||[],me({...I,roles:U});const c=((v=s==null?void 0:s.config)==null?void 0:v.roleId)||"";ge(c||((u=U[0])==null?void 0:u.id)||"")}catch{me(I)}try{const y=await _e.agents.getAvailableModels(),c=(U||[]).find(i=>{var n;return i.id===((n=s==null?void 0:s.config)==null?void 0:n.roleId)});if(c){const i=(y||[]).find(V=>V.id===c.aiModelId),n=((w=i==null?void 0:i.config)==null?void 0:w.acceptedInputs)||((i==null?void 0:i.type)==="TEXT_GENERATION"&&((N=(m=i==null?void 0:i.provider)==null?void 0:m.toLowerCase())!=null&&N.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:n})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{f.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{xe(!1)}};t.useEffect(()=>{r({roleId:Z}),(async()=>{var a,v,u;if(F)try{const w=await _e.agents.getAvailableModels(),m=(F.roles||[]).find(N=>N.id===Z);if(m){const N=(w||[]).find(U=>U.id===m.aiModelId),I=((a=N==null?void 0:N.config)==null?void 0:a.acceptedInputs)||((N==null?void 0:N.type)==="TEXT_GENERATION"&&((u=(v=N==null?void 0:N.provider)==null?void 0:v.toLowerCase())!=null&&u.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:I})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[Z,F]);const r=a=>{we(l)&&Se(u=>u.map(w=>w.id===l?{...w,data:{...w.data,config:{...w.data.config,...a}}}:w))};t.useEffect(()=>{const a=Ae.current;a&&requestAnimationFrame(()=>{a.style.height="auto";const v=Math.max(60,Math.min(a.scrollHeight,600));a.style.height=`${v}px`})},[Y]),t.useEffect(()=>{const a=setTimeout(()=>{Y!==s.config.prompt&&r({prompt:Y})},500);return()=>clearTimeout(a)},[Y,s.config.prompt]),t.useEffect(()=>{const a=Ee;if(!a||a.length===0)return;let v="";a.some(u=>{const w=le.find(N=>N.id===u.source);if(!w)return!1;const m=w.data||{};return w.type==="textPreview"&&typeof m.content=="string"&&m.content.trim()?(v=m.content.trim(),!0):!1}),v&&!fe.current&&(ae(v),r({prompt:v}))},[Ee,le]),t.useEffect(()=>{const a=Ee.map(w=>`${w.id}-${w.source}`).sort().join(",");if(a===g.current)return;g.current=a;const v=[],u=[];Ee.forEach(w=>{var I,U,y;const m=we(w.source);if(!m)return;const N=m.data||{};if(m.type==="upload")(((I=N.config)==null?void 0:I.uploadedFiles)||[]).forEach(i=>{i.type==="IMAGE"&&v.push(i.url),i.type==="DOCUMENT"&&u.push({name:i.originalName,url:i.url})});else if(m.type==="assetSelector"){const c=(U=N.config)==null?void 0:U.subjects;if(c&&c.length>0)(c[0].images||[]).map(n=>{const V="https://api.waule.ai";return n.startsWith("data:")?n:n.startsWith("http")?n.replace(/^https?:\/\/localhost(?::\d+)?/i,V):`${V}${n}`}).forEach(n=>v.push(n));else{const i=(y=N.config)==null?void 0:y.selectedAsset;if(i){const n="https://api.waule.ai",V=M=>M.startsWith("http")?M.replace(/^https?:\/\/localhost(?::\d+)?/i,n):`${n}${M}`;i.type==="IMAGE"&&v.push(V(i.url)),i.type==="DOCUMENT"&&u.push({name:i.originalName,url:V(i.url)})}}}else m.type==="imagePreview"&&N.imageUrl&&v.push(N.imageUrl)}),R(v),P(u)},[Ee,we,le]);const k=()=>{if(!F)return null;const a=(F.roles||[]).find(v=>v.id===Z);return a?{systemPrompt:a.systemPrompt,aiModelId:a.aiModelId,temperature:a.temperature,maxTokens:a.maxTokens}:null},p=async()=>{var v,u,w,m,N,I,U,y,c,i,n,V,M,G;if(!F){f.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!Y.trim()){f.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let a=(F.roles||[]).find(O=>O.id===Z)||(F.roles||[])[0];if(!a){f.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!Z||Z!==a.id)&&(ge(a.id),r({roleId:a.id}));try{ee(!0);const ne=be().filter(Ue=>Ue.target===l);let ue="";const oe="https://api.waule.ai",h=[],d=[],j=[];for(const Ue of ne){const Re=we(Ue.source);if(Re)if(Re.type==="upload"){const Te=((u=(v=Re.data)==null?void 0:v.config)==null?void 0:u.uploadedFiles)||[];for(const se of Te)if(se.type==="DOCUMENT")h.push({filePath:se.url,mimeType:se.mimeType}),ue+=`[æ–‡æ¡£æ–‡ä»¶: ${se.originalName}]
`;else if(se.type==="IMAGE"){const Ve=se.url.startsWith("http")?se.url:`${oe}${se.url}`;d.push(Ve),ue+=`[å›¾ç‰‡æ–‡ä»¶: ${se.originalName}]
`}else if(se.type==="VIDEO"){const Ve=se.url.startsWith("http")?se.url:`${oe}${se.url}`;j.push(Ve),ue+=`[è§†é¢‘æ–‡ä»¶: ${se.originalName}]
`}else se.type==="AUDIO"&&(ue+=`[éŸ³é¢‘æ–‡ä»¶: ${se.originalName}]
`)}else if(Re.type==="assetSelector"){const Te=(m=(w=Re.data)==null?void 0:w.config)==null?void 0:m.subjects;if(Te&&Te.length>0){const se=(Te[0].images||[]).map(Ve=>Ve.startsWith("http")?Ve:`${oe}${Ve}`).map(Ve=>Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe));se.forEach(Ve=>d.push(Ve)),ue+=`[å‚è€ƒå›¾ç‰‡ç»„: ${se.length} å¼ ]
`}else{const se=(I=(N=Re.data)==null?void 0:N.config)==null?void 0:I.selectedAsset;if(se){if(se.type==="DOCUMENT")h.push({filePath:se.url,mimeType:se.mimeType}),ue+=`[æ–‡æ¡£æ–‡ä»¶: ${se.originalName}]
`;else if(se.type==="IMAGE"){let Ve=se.url.startsWith("http")?se.url:`${oe}${se.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),d.push(Ve),ue+=`[å›¾ç‰‡æ–‡ä»¶: ${se.originalName}]
`}else if(se.type==="VIDEO"){let Ve=se.url.startsWith("http")?se.url:`${oe}${se.url}`;Ve=Ve.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),j.push(Ve),ue+=`[è§†é¢‘æ–‡ä»¶: ${se.originalName}]
`}}}}else if(Re.type==="aiImage"){const Te=(y=(U=Re.data)==null?void 0:U.config)==null?void 0:y.generatedImageUrl;if(Te){const se=Te.startsWith("http")?Te:`${oe}${Te}`;d.push(se),ue+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(Re.type==="imagePreview"){const Te=Re.data.imageUrl;Te&&(d.push(Te),ue+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(Re.type==="videoPreview"){const Te=Re.data.videoUrl;if(Te){const se=Te.startsWith("http")?Te:`${oe}${Te}`;j.push(se),ue+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else Re.type==="textPreview"&&Re.data.content&&(ue+=Re.data.content+`

`)}const b=k();if(!b)return;let J=b.systemPrompt;ue&&(J+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${ue}`),J+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${Y}`;const de=await _e.ai.text.generate({modelId:a.aiModel.id||b.aiModelId,prompt:J,systemPrompt:a.systemPrompt||b.systemPrompt,temperature:a.temperature??b.temperature,maxTokens:a.maxTokens??b.maxTokens,documentFiles:h.length>0?h:void 0,imageUrls:d.length>0?d:void 0,videoUrls:j.length>0?j:void 0}),B=de&&(((c=de.data)==null?void 0:c.text)||(de==null?void 0:de.text))||"";if(!B||B.trim()===""){f.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:B});const pe=be().filter(Ue=>Ue.source===l),Ce=ce(),Ne=pe.filter(Ue=>{const Re=Ce.find(Te=>Te.id===Ue.target);return Re&&Re.type!=="textPreview"});if(Ne.length>0)Se(Ue=>{const Re=new Set(Ne.map(Te=>Te.target));return Ue.map(Te=>{var Ve;if(!Re.has(Te.id))return Te;const se=((Ve=Te.data)==null?void 0:Ve.config)||{};return Te.type==="midjourney"?{...Te,data:{...Te.data,prompt:B}}:{...Te,data:{...Te.data,config:{...se,prompt:B}}}})});else{const Ue=we(l);if(Ue){const Re=Date.now(),Te=`text-preview-${l}-${Re}`,se=pe.filter(ut=>{const St=Ce.find(lt=>lt.id===ut.target);return St&&St.type==="textPreview"}),Ve=document.querySelector(`.react-flow__node[data-id="${l}"]`),et=(Ve==null?void 0:Ve.getBoundingClientRect().width)||300,kt=Ue.position.x+et+100,vt=Ue.position.y+se.length*700,Nt={id:Te,type:"textPreview",position:{x:kt,y:vt},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:B,createdBy:(i=Ue.data)==null?void 0:i.createdBy}},ct={id:`edge-${l}-${Te}`,source:l,target:Te,type:"aurora"};Se(ut=>[...ut,Nt]),setTimeout(()=>{ie(ut=>[...ut,ct])},50)}}const Oe=(de==null?void 0:de.creditsCharged)||0;if(Oe>0){const{useAuthStore:Ue}=await us(async()=>{const{useAuthStore:Te}=await import("./index-CiJ2Nd2F.js").then(se=>se.f);return{useAuthStore:Te}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Re}=Ue.getState();await Re(),f.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${Oe} ç§¯åˆ†ï¼‰`)}else f.success("æ‰§è¡ŒæˆåŠŸ")}catch(O){const ne=((V=(n=O==null?void 0:O.response)==null?void 0:n.data)==null?void 0:V.message)||((G=(M=O==null?void 0:O.response)==null?void 0:M.data)==null?void 0:G.error)||(O==null?void 0:O.message)||"æœªçŸ¥é”™è¯¯";f.error("æ‰§è¡Œå¤±è´¥ï¼š"+ne)}finally{ee(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:T?"LOADING...":((F==null?void 0:F.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[F&&(F.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(as,{value:Z,onChange:a=>ge(a),options:[...F.roles||[]].sort((a,v)=>(a.order??0)-(v.order??0)).map(a=>({value:a.id,label:a.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Ae,value:Y,onChange:a=>{fe.current=!0,ae(a.target.value)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:p,disabled:Q||T||!F||!Y.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:cursor-not-allowed bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg  border-transparent dark:border-white/10",children:Q?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!z&&(D?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(C),"æ¬¡"]}):_!==null&&_>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[_,"ç§¯åˆ†"]}):null)]})}),te.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",te.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:te.map((a,v)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:a,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"})},v))})]}),$.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",$.length,")"]}),e.jsx("div",{className:"space-y-1",children:$.map((a,v)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:a.name,children:a.name})]},v))})]})]}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},mo=t.memo(fo),Sr="https://api.waule.ai",_s=400,xo=({data:s,id:S,selected:l})=>{const[F,me]=t.useState(!1),[T,xe]=t.useState(0),[Y,ae]=t.useState(s.config.uploadedFiles||[]),[Z,ge]=t.useState(null),[Ae,fe]=t.useState(null);t.useEffect(()=>()=>{},[S]),t.useEffect(()=>{},[Z]),t.useEffect(()=>{},[Ae]);const[Q,ee]=t.useState(null),Se=t.useRef(null),ie=t.useRef(null),we=t.useRef(null),[ce,be]=t.useState(!1),[Ee,le]=t.useState(0),[te,R]=t.useState(0),[$,P]=t.useState(!1),g=t.useRef(null),{setNodes:x,getNode:_,setEdges:z,getEdges:D}=Zt(),C=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const n=s.createdBy;if(typeof n=="object"&&(n==null||n.id),C.current)return;const V=s.config.uploadedFiles||[];!F&&JSON.stringify(V)!==JSON.stringify(Y)&&(ae(V),ge(null),fe(null))},[s.config.uploadedFiles,F,s._currentUserId,s.createdBy]);const W=()=>{g.current&&(g.current.paused?(g.current.play(),P(!0)):(g.current.pause(),P(!1)))},r=n=>{_(S)&&(C.current=!0,x(M=>M.map(G=>G.id===S?{...G,data:{...G.data,config:{...G.data.config,uploadedFiles:n}}}:G)))},k=async n=>{var M,G;if(!n||n.length===0)return;me(!0);const V=[];try{for(let O=0;O<n.length;O++){const ne=n[O];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ne.type)){f.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ne.name}`);continue}const oe=await _e.assets.upload(ne,void 0,{onUploadProgress:h=>{const d=(h==null?void 0:h.total)||0,j=(h==null?void 0:h.loaded)||0;if(d>0){const b=Math.round(j/d*100);xe(b)}}});if(oe.data){const h=(oe.data.type||"").toUpperCase(),d=(oe.data.mimeType||"").toLowerCase(),j=h==="IMAGE"||h==="VIDEO"||h==="AUDIO"?h:d.startsWith("image/")?"IMAGE":d.startsWith("video/")?"VIDEO":d.startsWith("audio/")?"AUDIO":h||"",b=oe.data.url;V.push({id:oe.data.id,name:oe.data.name,originalName:oe.data.originalName,type:j,mimeType:oe.data.mimeType,size:oe.data.size,url:b})}}if(V.length>0){let O=[];const ne=V[0].type;if(Q!==null)O=[...Y],O[Q]=V[0];else{const oe={};for(const h of Y)oe[h.id]=h;for(const h of V)oe[h.id]=h;O=Object.values(oe)}if(_(S)){const oe=D().filter(d=>d.source===S),h=[];if(oe.forEach(d=>{var J;const j=_(d.target);if(!j||j.type.startsWith("aiVideo"))return;const b=(J=j.data.config)==null?void 0:J.acceptedInputs;if(b&&b.length>0){const de=ne.toUpperCase();b.map(pe=>typeof pe=="string"?pe.toUpperCase():pe).includes(de)||h.push(d.id)}}),h.length>0){z(j=>j.filter(b=>!h.includes(b.id)));const d={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};f.warning(`å·²æ–­å¼€ ${h.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${d[ne]||ne}ç±»å‹ï¼‰`)}}ge(null),fe(null),ae(O),r(O);try{const oe=D().filter(d=>d.source===S);if(oe.some(d=>{const j=_(d.target);return(j==null?void 0:j.type)==="aiVideo"})){const d=localStorage.getItem("workflow:nodes"),j=d?JSON.parse(d):[],b=oe.filter(de=>{var B;return((B=_(de.target))==null?void 0:B.type)==="aiVideo"}).map(de=>de.target),J=j.filter(de=>b.includes(de.id));J.length>0&&x(de=>de.map(B=>J.find(pe=>pe.id===B.id)?{...B,data:{...B.data,config:{...B.data.config,_updatedAt:Date.now()}}}:B))}}catch{}f.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(O){f.error(`ä¸Šä¼ å¤±è´¥: ${((G=(M=O.response)==null?void 0:M.data)==null?void 0:G.message)||O.message}`)}finally{me(!1),xe(0),Se.current&&(Se.current.value=""),ee(null)}},p=()=>{x(n=>n.filter(V=>V.id!==S)),z(n=>n.filter(V=>V.source!==S&&V.target!==S)),f.success("èŠ‚ç‚¹å·²åˆ é™¤")},a=()=>{var n;ee(0),(n=Se.current)==null||n.click()},v=n=>n<1024?n+" B":n<1024*1024?(n/1024).toFixed(2)+" KB":(n/(1024*1024)).toFixed(2)+" MB",u=n=>n.startsWith("image/")?{icon:"image",color:"text-neutral-500 dark:text-neutral-400"}:n.startsWith("video/")?{icon:"movie",color:"text-neutral-500 dark:text-neutral-400"}:n.startsWith("audio/")?{icon:"audio_file",color:"text-neutral-500 dark:text-neutral-400"}:{icon:"description",color:"text-neutral-500 dark:text-neutral-400"};t.useEffect(()=>{if(Y.length>0){const n=Y[0],V=(n.url.startsWith("http")||n.url.startsWith("data:")?n.url:`${Sr}${n.url}`).replace(".oss-oss-",".oss-");if(n.type==="IMAGE"){const M=new Image;M.onload=()=>{const G=M.width/M.height,O=_s/G;ge({width:_s,height:O})},M.onerror=G=>{ge({width:_s,height:_s*.75})},M.src=V}else if(n.type==="VIDEO"){const M=document.createElement("video");M.onloadedmetadata=()=>{const G=M.videoWidth/M.videoHeight,O=_s/G;fe({width:_s,height:O})},M.onerror=G=>{fe({width:_s,height:_s*.5625})},M.src=V}}},[Y]);const w=()=>{const n=ie.current;n&&(ce?(n.pause(),be(!1)):(n.play(),be(!0)))};t.useEffect(()=>{const n=ie.current;if(!n)return;const V=()=>le(n.duration||0),M=()=>R(n.duration?n.currentTime/n.duration:0),G=()=>be(!1);return n.addEventListener("loadedmetadata",V),n.addEventListener("timeupdate",M),n.addEventListener("ended",G),()=>{n.removeEventListener("loadedmetadata",V),n.removeEventListener("timeupdate",M),n.removeEventListener("ended",G)}},[Y]);const m=t.useRef(null),[N,I]=t.useState(0);t.useEffect(()=>{const n=Y[0];if(!n||n.type!=="AUDIO"){m.current=null;return}const M=(n.url.startsWith("http")||n.url.startsWith("data:")?n.url:`${Sr}${n.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let O;/https:\/\/.*aliyuncs\.com\//.test(M)?O=await _e.assets.proxyDownload(M):O=await(await fetch(M,{mode:"cors"})).arrayBuffer();const ne=window.AudioContext||window.webkitAudioContext,h=(await new ne().decodeAudioData(O)).getChannelData(0),d=120,j=Math.max(1,Math.floor(h.length/d)),b=new Float32Array(d);for(let J=0;J<d;J++){let de=0,B=0;const pe=J*j,Ce=Math.min(h.length,pe+j);for(let Ne=pe;Ne<Ce;Ne++)de+=Math.abs(h[Ne]),B++;b[J]=B?de/B:0}m.current=b,I(J=>J+1)}catch{const ne=new Float32Array(120);for(let ue=0;ue<120;ue++)ne[ue]=(Math.sin(ue/5)+1)/2;m.current=ne,I(ue=>ue+1)}})()},[Y]),t.useEffect(()=>{const n=we.current;if(!n)return;const V=m.current;if(!V)return;const M=n.getContext("2d");if(!M)return;const G=n.width,O=n.height;M.clearRect(0,0,G,O);const ne=V.length,ue=2,oe=Math.max(1,Math.floor((G-(ne-1)*ue)/ne)),h=M.createLinearGradient(0,0,G,0);h.addColorStop(0,"#525252"),h.addColorStop(.5,"#d946ef"),h.addColorStop(1,"#404040");for(let d=0;d<ne;d++){const j=Math.min(1,Math.max(0,V[d])),b=Math.max(2,Math.floor(j*O)),J=d*(oe+ue),de=Math.floor((O-b)/2);M.fillStyle=h,M.fillRect(J,de,oe,b)}if(te>0){const d=Math.floor(G*te);M.fillStyle="#ffffff88",M.fillRect(d,0,2,O)}},[te,N]);const U=n=>{if(!n||!isFinite(n))return"0:00";const V=Math.floor(n/60),M=Math.floor(n%60);return`${V}:${M.toString().padStart(2,"0")}`},y=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"neutral"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"neutral"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"neutral"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"neutral"}],c=Y[0],i=c?(c.url.startsWith("http")||c.url.startsWith("data:")?c.url:`${Sr}${c.url}`).replace(".oss-oss-",".oss-"):"";return c&&c.type==="IMAGE"&&Z?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:i,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:Z.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>k(n.target.files),className:"hidden"})]}):c&&c.type==="VIDEO"&&Ae?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${$?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:n=>{n.stopPropagation(),W()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:$?"pause":"play_arrow"})})}),e.jsx("video",{ref:g,src:i,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Ae.height},onEnded:()=>P(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>k(n.target.files),className:"hidden"})]}):c&&c.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:w,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:ce?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:U(Ee)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:we,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ie,src:i,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>k(n.target.files),className:"hidden"})]}):c&&c.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:c.originalName,children:c.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:v(c.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:Se,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>k(n.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:Se,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:n=>k(n.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var n;s._canEdit!==!1&&((n=Se.current)==null||n.click())},onDragOver:n=>{n.preventDefault(),n.stopPropagation()},onDrop:n=>{n.preventDefault(),n.stopPropagation(),s._canEdit!==!1&&k(n.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-neutral-400 dark:hover:border-neutral-400/50 transition-colors ${F||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:F?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:F?`ä¸Šä¼ ä¸­... ${T}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),F&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all",style:{width:`${T}%`}})})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:y.map(n=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${n.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:n.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:n.formats.join(", ")})]},n.type))})]}),Y.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",Y.length,")"]}),Y.map(n=>{const{icon:V,color:M}=u(n.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${M} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:V}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:n.originalName,children:n.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:v(n.size)})]}),e.jsx("button",{onClick:p,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},n.id)})]})]})}),e.jsx(Ut,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},bo=t.memo(xo),Wr="https://api.waule.ai",Ls=320,wo=({data:s,id:S,selected:l})=>{const[F,me]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[T,xe]=t.useState([]),{setNodes:Y,getNode:ae}=Zt(),[Z,ge]=t.useState(null),[Ae,fe]=t.useState(null),Q=t.useRef(null),ee=t.useRef(null),[Se,ie]=t.useState(!1),[we,ce]=t.useState(0),[be,Ee]=t.useState(0),le=t.useRef(null),[te,R]=t.useState(!1),[$,P]=t.useState(!1),g=t.useRef(null),x=()=>{g.current&&(g.current.paused?(g.current.play(),P(!0)):(g.current.pause(),P(!1)))},_=t.useRef(!1);t.useEffect(()=>{const p=s._currentUserId,a=s.createdBy,v=typeof a=="object"?a==null?void 0:a.id:a;if(p&&v&&p===v&&_.current)return;const u=s.config.selectedInput||s.config.selectedAsset||null;if(!u)return;const w=F;(()=>{if(!w)return!1;const N=w.images&&!w.type,I=u.images&&!u.type;if(N&&I){const U=w.images||[],y=u.images||[];if(U.length!==y.length)return!1;for(let c=0;c<U.length;c++)if(U[c].id!==y[c].id||U[c].url!==y[c].url)return!1;return!0}if(w.id&&u.id)return w.id===u.id&&w.url===u.url&&w.type===u.type;try{return JSON.stringify(w)===JSON.stringify(u)}catch{return!1}})()||me(u)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var a,v,u;if(F&&F.images&&!F.type){const w=F,m=(u=(v=(a=ae(S))==null?void 0:a.data)==null?void 0:v.config)==null?void 0:u.referenceImages;Array.isArray(m)&&m.length>0?xe(m.map(N=>({id:N.id,url:N.url,name:N.name}))):xe(w.images||[])}else xe([])},[F,ae,S]);const z=p=>{const a=ae(S);a&&(_.current=!0,Y(v=>v.map(u=>u.id===S?{...u,data:{...u.data,config:{...u.data.config,...p}}}:u)),me((p==null?void 0:p.selectedInput)??(p==null?void 0:p.selectedAsset)??a.data.config.selectedInput??a.data.config.selectedAsset))},D=p=>/^https?:\/\//.test(p)||p.startsWith("data:"),C=p=>!p||p.startsWith("data:")?p:/^https?:\/\/localhost(?::\d+)?\//i.test(p)?p.replace(/^https?:\/\/localhost(?::\d+)?/i,Wr):D(p)?p:`${Wr}${p}`;t.useEffect(()=>{var y,c,i,n,V,M,G,O,ne;if(!(F&&F.images&&!F.type))return;const a=F,v=T.length?T:a.images||[];if(v.length===1){const ue=v[0],oe={id:ue.id,name:ue.name,originalName:ue.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:ue.url};z({selectedInput:oe,selectedAsset:oe,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const u=[{name:a.name,images:v.map(ue=>C(ue.url))}],w=v.map(ue=>({id:ue.id,url:ue.url,name:ue.name})),m=[a.id],N=(i=(c=(y=ae(S))==null?void 0:y.data)==null?void 0:c.config)==null?void 0:i.subjects,I=(M=(V=(n=ae(S))==null?void 0:n.data)==null?void 0:V.config)==null?void 0:M.referenceImages,U=(ne=(O=(G=ae(S))==null?void 0:G.data)==null?void 0:O.config)==null?void 0:ne.roleIds;(JSON.stringify(N)!==JSON.stringify(u)||JSON.stringify(I)!==JSON.stringify(w)||JSON.stringify(U)!==JSON.stringify(m))&&z({subjects:u,referenceImages:w,roleIds:m})},[T]);const W=p=>{if(!(F&&F.images&&!F.type))return;const v=F,u=[...T];if(p<0||p>=u.length)return;if(u.splice(p,1),xe(u),f.success("å·²åˆ é™¤å‚è€ƒå›¾"),u.length===0){me(null),z({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),f.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(u.length===1){const U=u[0],y={id:U.id,name:U.name,originalName:U.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:U.url};me(y),z({selectedInput:y,selectedAsset:y,subjects:void 0,referenceImages:void 0,roleIds:void 0}),f.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const w={id:v.id,name:v.name,coverUrl:C(u[0].url),images:u};me(w);const m=[{name:w.name,images:u.map(U=>C(U.url))}],N=u.map(U=>({id:U.id,url:U.url,name:U.name})),I=[w.id];z({selectedInput:w,subjects:m,referenceImages:N,roleIds:I}),f.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(S)};t.useEffect(()=>{if(F&&F.type){const p=F;if(p.type==="IMAGE"){const a=new Image;a.onload=()=>{const v=a.width/a.height,u=Ls/v;ge({width:Ls,height:u})},a.src=C(p.url)}else if(p.type==="VIDEO"){const a=document.createElement("video");a.onloadedmetadata=()=>{const v=a.videoWidth/a.videoHeight,u=Ls/v;fe({width:Ls,height:u})},a.src=C(p.url)}}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")){R(!1);return}const v=C(F.url),u=Q.current,w=ee.current;if(!u||!w)return;u.src=v,Ee(0),R(!1);const m=()=>ce(u.duration||0),N=()=>Ee(u.duration?u.currentTime/u.duration:0),I=()=>ie(!1);return u.addEventListener("loadedmetadata",m),u.addEventListener("timeupdate",N),u.addEventListener("ended",I),(async()=>{try{const c=await(await fetch(v,{mode:"cors"})).arrayBuffer(),i=window.AudioContext||window.webkitAudioContext,M=(await new i().decodeAudioData(c)).getChannelData(0),G=120,O=Math.max(1,Math.floor(M.length/G)),ne=new Float32Array(G);for(let ue=0;ue<G;ue++){let oe=0,h=0;const d=ue*O,j=Math.min(M.length,d+O);for(let b=d;b<j;b++)oe+=Math.abs(M[b]),h++;ne[ue]=h?oe/h:0}le.current=ne,R(!0)}catch{const c=new Float32Array(120);for(let i=0;i<120;i++)c[i]=(Math.sin(i/5)+1)/2;le.current=c,R(!0)}})(),()=>{u.removeEventListener("loadedmetadata",m),u.removeEventListener("timeupdate",N),u.removeEventListener("ended",I)}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")||!te)return;const a=ee.current,v=le.current;if(!a||!v)return;const u=a.getContext("2d");if(!u)return;const w=a.width,m=a.height;u.clearRect(0,0,w,m);const N=v.length,I=2,U=Math.max(1,Math.floor((w-(N-1)*I)/N)),y=u.createLinearGradient(0,0,w,0);y.addColorStop(0,"#525252"),y.addColorStop(.5,"#d946ef"),y.addColorStop(1,"#404040");for(let c=0;c<N;c++){const i=Math.min(1,Math.max(0,v[c])),n=Math.max(2,Math.floor(i*m)),V=c*(U+I),M=Math.floor((m-n)/2);u.fillStyle=y,u.fillRect(V,M,U,n)}if(be>0){const c=Math.floor(w*be);u.fillStyle="#ffffff88",u.fillRect(c,0,2,m)}},[F,be,te]);const k=p=>p<1024?p+" B":p<1024*1024?(p/1024).toFixed(2)+" KB":(p/(1024*1024)).toFixed(2)+" MB";if(F){if(F.images&&!F.type){const u=F;return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ls},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ls*.5625},children:T[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:w=>w.preventDefault(),src:C(T[0].url),alt:u.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:w=>{w.preventDefault(),w.stopPropagation(),w.nativeEvent&&typeof w.nativeEvent.stopImmediatePropagation=="function"&&w.nativeEvent.stopImmediatePropagation(),W(0)},onClick:w=>{w.preventDefault(),w.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:u.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:T.slice(1).map((w,m)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:N=>N.preventDefault(),src:C(w.url),alt:w.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:N=>{N.preventDefault(),N.stopPropagation(),N.nativeEvent&&typeof N.nativeEvent.stopImmediatePropagation=="function"&&N.nativeEvent.stopImmediatePropagation(),W(m+1)},onClick:N=>{N.preventDefault(),N.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},w.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const a=F,v=C(a.url);if(a.type==="IMAGE"&&Z)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ls},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:v,alt:a.name,className:"w-full object-cover",style:{width:Ls,height:Z.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="VIDEO"&&Ae)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ls},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${$?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:u=>{u.stopPropagation(),x()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:$?"pause":"play_arrow"})})}),e.jsx("video",{ref:g,src:v,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ls,height:Ae.height},onEnded:()=>P(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const u=Q.current;u&&(Se?(u.pause(),ie(!1)):(u.play(),ie(!0)))},className:"nodrag w-8 h-8 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:Se?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const u=we;if(!u||!isFinite(u))return"0:00";const w=Math.floor(u/60),m=Math.floor(u%60);return`${w}:${m.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:ee,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:Q,src:v,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(a.type==="DOCUMENT"){const u=N=>N.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:N.includes("word")?{icon:"description",color:"text-blue-400"}:N.includes("excel")||N.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:w,color:m}=u(a.mimeType);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${m} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:w}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:a.originalName,children:a.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:k(a.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ls},children:[e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},yo=t.memo(wo),mr={};function Ts(s){const{project:S,episode:l,nodeGroup:F,assetType:me,preview:T=!0}=s;if(!F||!F.scene||!F.shot)return null;const xe=`${F.id}-${me}`;mr[xe]||(mr[xe]=0);let Y;T?Y=mr[xe]+1:(mr[xe]++,Y=mr[xe]);let ae=S.name;if(S.type==="DRAMA"&&l){const Z=`S${String(l.episodeNumber).padStart(3,"0")}`;ae+=`_${Z}`}return ae+=`_Sc${F.scene}_Sh${F.shot}`,ae+=`_${Y}`,ae}function Hs(s,S){return S.find(l=>l.nodeIds.includes(s))||null}const ko=({data:s,id:S})=>{var u,w;const{setNodes:l,setEdges:F,getNodes:me}=Zt(),T=_r(m=>m.refreshUser),xe=Ar(),Y=!!((u=s==null?void 0:s.workflowContext)!=null&&u.episode)||xe.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var N,I,U;if(Y)try{const y=(s==null?void 0:s.workflowContext)||{},c=y.episode,i=new URLSearchParams(window.location.search),n=Number(i.get("shot"))||1,V=xe.pathname.split("/").filter(Boolean),M=V.indexOf("projects"),G=V.indexOf("episodes"),O=((N=y.project)==null?void 0:N.id)||(c==null?void 0:c.projectId)||(M>=0?V[M+1]:void 0),ne=(c==null?void 0:c.id)||(G>=0?V[G+1]:void 0);if(!O||!ne)return;const ue=await _e.episodes.getById(O,ne),oe=(ue==null?void 0:ue.data)??ue,h=(oe==null?void 0:oe.data)??oe,j=(Array.isArray((I=h==null?void 0:h.scriptJson)==null?void 0:I.acts)?h.scriptJson.acts:[]).find(B=>B.actIndex===1),b=(U=j==null?void 0:j.shots)==null?void 0:U.find(B=>Number(B.shotIndex)===n),de=(Array.isArray(b==null?void 0:b.mediaList)?b.mediaList:[]).some(B=>(B==null?void 0:B.nodeId)===S);l(B=>B.map(pe=>pe.id===S?{...pe,data:{...pe.data,addedToStoryboard:de}}:pe))}catch{}})()},[S,Y,xe.pathname]);const[ae,Z]=t.useState(!1),[ge,Ae]=t.useState([]),[fe,Q]=t.useState(""),[ee,Se]=t.useState("ALL"),[ie,we]=t.useState(""),[ce,be]=t.useState(!1),Ee=s.width||400,[le,te]=t.useState(null);t.useEffect(()=>{ae&&(k(),setTimeout(()=>{p()},100))},[ae]);const R=t.useRef(null),$=t.useRef(!1);t.useEffect(()=>{const m=s.pendingButtonAction;if(m){try{const U=localStorage.getItem("suppressedPreviewTasks")||"[]",y=JSON.parse(U),c=localStorage.getItem("createdPreviewTasks")||"[]",i=JSON.parse(c),n=y.some(O=>O.taskId&&O.taskId===m.newTaskId||O.sourceNodeId&&O.sourceNodeId===m.sourceNodeId),M=me().some(O=>{var ne,ue,oe,h;return O.type==="imagePreview"&&((ue=(ne=O.data)==null?void 0:ne.midjourneyData)==null?void 0:ue.sourceNodeId)===m.sourceNodeId&&((h=(oe=O.data)==null?void 0:oe.midjourneyData)==null?void 0:h.taskId)===m.newTaskId}),G=i.some(O=>O.taskId&&O.taskId===m.newTaskId);if(n||G&&M){te(null),l(O=>O.map(ne=>ne.id===m.sourceNodeId?{...ne,data:{...ne.data,pendingButtonAction:void 0}}:ne));return}}catch{}if($.current)return;if($.current=!0,me().some(U=>{var y,c,i,n;return U.type==="imagePreview"&&((c=(y=U.data)==null?void 0:y.midjourneyData)==null?void 0:c.sourceNodeId)===m.sourceNodeId&&((n=(i=U.data)==null?void 0:i.midjourneyData)==null?void 0:n.taskId)===m.newTaskId})){te(null),l(U=>U.map(y=>y.id===m.sourceNodeId?{...y,data:{...y.data,pendingButtonAction:void 0}}:y)),$.current=!1;return}te(m.buttonCustomId),P(m.newTaskId,m.buttonLabel,m.sourceNodeId)}return()=>{$.current=!1,R.current&&(clearTimeout(R.current),R.current=null)}},[]);const P=async(m,N,I)=>{const U=I||S;let y=0;const c=150,i=2e3;$.current=!0;const n=/^[UV]\d$/.test(N)||N.includes("Vary")||N.includes("Upscale")&&N!=="Upscale"||N.includes("Zoom")||N.includes("Pan")||N.includes("Make")||N.includes("Remaster"),V=async()=>{var M,G,O,ne,ue,oe,h,d;if($.current)try{const j=await _e.midjourney.fetchTask(m);if(!$.current)return;const b=j.task;if(b.status==="SUCCESS"){if(n&&s.imageUrl&&((M=s.midjourneyData)!=null&&M.messageId)){const ut=b.imageUrl===s.imageUrl,St=((G=b.properties)==null?void 0:G.messageId)===((O=s.midjourneyData)==null?void 0:O.messageId);if(ut&&St){y++;try{const lt=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(lt).some(ze=>{var wt;return ze.taskId&&ze.taskId===m||ze.messageId&&ze.messageId===((wt=b.properties)==null?void 0:wt.messageId)})){te(null),l(ze=>ze.map(wt=>wt.id===U?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}y<c?R.current=setTimeout(V,i):(f.error(`${N} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),te(null),l(lt=>lt.map(Ke=>Ke.id===U?{...Ke,data:{...Ke.data,pendingButtonAction:void 0}}:Ke)));return}}if(f.success(`${N} å®Œæˆï¼`),te(null),l(ut=>ut.map(St=>St.id===U?{...St,data:{...St.data,pendingButtonAction:void 0}}:St)),me().find(ut=>{var St,lt,Ke,It,ze;return ut.type==="imagePreview"&&((St=ut.data.midjourneyData)==null?void 0:St.sourceNodeId)===U&&(((lt=ut.data.midjourneyData)==null?void 0:lt.taskId)===m||((Ke=b.properties)==null?void 0:Ke.messageId)&&((It=ut.data.midjourneyData)==null?void 0:It.messageId)===((ze=b.properties)==null?void 0:ze.messageId))})){f.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const B=me().find(ut=>ut.id===U);if(!B)return;if(!b.imageUrl){f.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const pe=200,Ce=100,Ne=s.width||400,Ue=((ut,St=300)=>{if(!ut||!/^[0-9]+\s*:\s*[0-9]+$/.test(ut))return St;const[lt,Ke]=ut.split(":").map(It=>parseFloat(It));return!lt||!Ke?St:Math.round(Ne*(Ke/lt))})(s.ratio,300),Re=document.querySelector(`.react-flow__node[data-id="${B.id}"]`),Te=Math.round((Re==null?void 0:Re.getBoundingClientRect().width)||((ne=B.data)==null?void 0:ne.width)||400),se=me().filter(ut=>{var St,lt;return ut.type==="imagePreview"&&((lt=(St=ut.data)==null?void 0:St.midjourneyData)==null?void 0:lt.sourceNodeId)===U}),Ve=B.position.x+Te+pe,et=B.position.y,kt=Ve,vt=et+se.length*(Ue+Ce),Nt=`preview-${Date.now()}`,ct={id:Nt,type:"imagePreview",position:{x:kt,y:vt},data:{imageUrl:b.imageUrl,width:Ne,height:Ue,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(ue=B.data)==null?void 0:ue.createdBy,midjourneyData:{taskId:m,messageId:(oe=b.properties)==null?void 0:oe.messageId,messageHash:(h=b.properties)==null?void 0:h.messageHash,sourceNodeId:U,buttons:b.buttons,action:b.action}}};l(ut=>[...ut,ct]),F(ut=>{const St={id:`${U}-${Nt}`,source:U,target:Nt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...ut,St]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const St=me().find(lt=>lt.id===Nt)})});try{const ut=localStorage.getItem("createdPreviewTasks")||"[]",lt=[...JSON.parse(ut),{taskId:m,messageId:(d=b.properties)==null?void 0:d.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(lt))}catch{}f.success(`å·²åˆ›å»º${N}é¢„è§ˆèŠ‚ç‚¹`);return}if(b.status==="FAILURE"){f.error(`${N} å¤±è´¥: ${b.failReason||"æœªçŸ¥é”™è¯¯"}`),te(null),l(J=>J.map(de=>de.id===U?{...de,data:{...de.data,pendingButtonAction:void 0}}:de));return}if(b.status==="NOT_FOUND"){if(me().some(B=>{var pe,Ce,Ne,Oe;return B.type==="imagePreview"&&((Ce=(pe=B.data)==null?void 0:pe.midjourneyData)==null?void 0:Ce.sourceNodeId)===U&&((Oe=(Ne=B.data)==null?void 0:Ne.midjourneyData)==null?void 0:Oe.taskId)===m})){te(null),l(B=>B.map(pe=>pe.id===U?{...pe,data:{...pe.data,pendingButtonAction:void 0}}:pe));return}f.error(`${N} ä»»åŠ¡ä¸å­˜åœ¨`),te(null),l(B=>B.map(pe=>pe.id===U?{...pe,data:{...pe.data,pendingButtonAction:void 0}}:pe));return}y++,y<c?R.current=setTimeout(V,i):(f.error(`${N} è¶…æ—¶`),te(null),l(J=>J.map(de=>de.id===S?{...de,data:{...de.data,pendingButtonAction:void 0}}:de)))}catch(j){f.error(`${N} å¤±è´¥: ${j.message}`),te(null),l(b=>b.map(J=>J.id===S?{...J,data:{...J.data,pendingButtonAction:void 0}}:J))}};V()},g=()=>{try{const m=localStorage.getItem("midjourneyButtonConfig");if(m)return JSON.parse(m)}catch{}return{}},x=m=>{const N=g();if(Object.keys(N).length===0)return!0;const I=m.label.replace(/\s+/g,"_");return N.hasOwnProperty(I)?N[I]===!0:!0},_=m=>{if(!m)return"";let N=m.trim();return/^upscale_\d+\s/i.test(N)&&(N=N.replace(/^upscale_\d+\s+/i,"")),N},z=(((w=s.midjourneyData)==null?void 0:w.buttons)||[]).map(m=>String(m.label||"").toLowerCase()),D=z.some(m=>/^[uv][1-4]$/i.test(m)),C=z.some(m=>m.includes("redo")),W=!D&&!C&&z.some(m=>m.includes("upscale")),r=m=>{const N=String(m.label||""),I=N.toLowerCase(),U=String(m.customId||"").toLowerCase(),y=/ğŸ‘|â¤ï¸|â¤/.test(N);return I.includes("animate")||I.includes("web")||U.includes("web")||I.includes("browser")||I.includes("open in web")||I.includes("open web")||I.includes("like")||U.includes("like")||y?!1:D?/^U[1-4]$/i.test(N):W?I.includes("upscale"):!1};t.useEffect(()=>{ae&&(k(),p())},[ae]);const k=async()=>{try{const m=ee==="ALL"?void 0:{category:ee},I=(await _e.assetLibraries.getAll(m)).data||[];if(Ae(I),I.length>0){const U=I.find(y=>y.id===fe);Q(U?U.id:I[0].id)}else Q("")}catch{f.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},p=()=>{const m=window.__workflowContext;if(!m||!m.project||!m.nodeGroups){f.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const N=Hs(S,m.nodeGroups);if(!N&&m.nodeGroups.length>0){const U=m.nodeGroups[0],y=Ts({project:m.project,episode:m.episode,nodeGroup:U,assetType:"image"});y?(we(y),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${y}`)):f.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const I=Ts({project:m.project,episode:m.episode,nodeGroup:N,assetType:"image"});I?(we(I),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${I}`)):f.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},a=async()=>{var m,N;if(!fe){f.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ie.trim()){f.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{be(!0),await _e.assetLibraries.addFromUrl(fe,s.imageUrl,ie.trim());const I=window.__workflowContext;if(I&&I.project&&I.nodeGroups){const U=Hs(S,I.nodeGroups)||I.nodeGroups[0];U&&Ts({project:I.project,episode:I.episode,nodeGroup:U,nodeId:S,assetType:"image",preview:!1})}f.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),Z(!1),we("");try{l(U=>U.map(y=>y.id===S?{...y,data:{...y.data,addedToLibrary:!0}}:y))}catch{}try{const U=new CustomEvent("asset-library-updated",{detail:{libraryId:fe}});window.dispatchEvent(U)}catch{}}catch(I){f.error(((N=(m=I.response)==null?void 0:m.data)==null?void 0:N.message)||"æ·»åŠ å¤±è´¥")}finally{be(!1)}},v=async()=>{var m;try{const N=s.imageUrl;let I=`image-${Date.now()}.jpg`;const U=window.__workflowContext;if(U&&U.project&&U.nodeGroups){const y=Hs(S,U.nodeGroups)||U.nodeGroups[0];if(y){const c=Ts({project:U.project,episode:U.episode,nodeGroup:y,nodeId:S,assetType:"image",preview:!0});if(c&&(I=c,!I.includes("."))){const i=((m=N.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:m[0])||".jpg";I+=i}}}f.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");try{const y=await fetch(N);if(!y.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${y.status}`);const c=await y.blob(),i=window.URL.createObjectURL(c),n=document.createElement("a");n.href=i,n.download=I,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>{window.URL.revokeObjectURL(i)},100),f.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${I}`)}catch{const c=`/api/assets/proxy-download-with-name?url=${encodeURIComponent(N)}&filename=${encodeURIComponent(I)}`,i=document.createElement("a");i.href=c,i.download=I,document.body.appendChild(i),i.click(),document.body.removeChild(i),f.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${I}`)}}catch(N){f.error(`æ“ä½œå¤±è´¥: ${N instanceof Error?N.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const N=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(I=>x(I)&&r(I)):[]).length>0;return e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ee,borderRadius:N?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[Y&&e.jsxs("button",{onClick:async()=>{var I,U;try{const y=s.imageUrl,c=s.workflowContext||{},i=c.episode,n=new URLSearchParams(window.location.search),V=Number(n.get("shot"))||1,M=xe.pathname.split("/").filter(Boolean),G=M.indexOf("projects"),O=M.indexOf("episodes"),ne=((I=c.project)==null?void 0:I.id)||(i==null?void 0:i.projectId)||(G>=0?M[G+1]:void 0),ue=(i==null?void 0:i.id)||(O>=0?M[O+1]:void 0);if(!ne||!ue){f.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const oe=await _e.episodes.getById(ne,ue),h=(oe==null?void 0:oe.data)??oe,d=(h==null?void 0:h.data)??h;let j=Array.isArray((U=d==null?void 0:d.scriptJson)==null?void 0:U.acts)?[...d.scriptJson.acts]:[],b=j.find(pe=>pe.actIndex===1);b||(b={actIndex:1,shots:[]},j.push(b)),b.shots=Array.isArray(b.shots)?[...b.shots]:[];let J=b.shots.find(pe=>Number(pe.shotIndex)===V);J||(J={shotIndex:V,mediaList:[]},b.shots.push(J));const de=Array.isArray(J.mediaList)?J.mediaList.slice():[];de.push({type:"image",url:y,nodeId:S,duration:5}),J.mediaList=de;const B={...d.scriptJson||{},acts:j};await _e.episodes.update(ne,ue,{scriptJson:B});try{l(pe=>pe.map(Ce=>Ce.id===S?{...Ce,data:{...Ce.data,addedToStoryboard:!0}}:Ce))}catch{}f.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(y){f.error((y==null?void 0:y.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{Z(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:v,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const m=(s.midjourneyData.buttons||[]).filter(N=>x(N)&&r(N));return m.length===0?null:e.jsxs("div",{className:"nodrag bg-white dark:bg-[#18181b] backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ee},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:m.map((N,I)=>{var V;const U=_(N.label),y=((V=s.clickedButtons)==null?void 0:V.includes(N.label))||!1,c=le===N.customId,i=s._canEdit===!1,n=le!==null&&le!==N.customId||y||i;return e.jsx("button",{onClick:async()=>{var M,G,O,ne,ue,oe;if(!((M=s.midjourneyData)!=null&&M.taskId)){f.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(y){f.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}te(N.customId);try{f.info(`æ­£åœ¨æ‰§è¡Œ ${N.label}...`);const h=await _e.midjourney.action({taskId:s.midjourneyData.taskId,customId:N.customId,messageId:s.midjourneyData.messageId,nodeId:S,mode:s.midjourneyData.mode||"relax"});if(!h.success){f.error(h.description||"æ“ä½œå¤±è´¥"),te(null);return}const d=h.taskId;if(h.creditsCharged&&h.creditsCharged>0&&T(),!d){f.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),te(null);return}l(j=>j.map(b=>b.id===S?{...b,data:{...b.data,pendingButtonAction:{buttonLabel:N.label,buttonCustomId:N.customId,newTaskId:d,sourceNodeId:S},clickedButtons:[...b.data.clickedButtons||[],N.label]}}:b)),f.info(`${U} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),P(d,U)}catch(h){if(((G=h.response)==null?void 0:G.status)===429)f.warning(((ne=(O=h.response)==null?void 0:O.data)==null?void 0:ne.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const d=((oe=(ue=h.response)==null?void 0:ue.data)==null?void 0:oe.error)||h.message;f.error(d)}te(null)}},disabled:n,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${y?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":c?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-wait text-white border-transparent shadow-md":le!==null?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:y?`${U} (å·²ç‚¹å‡»)`:U,children:e.jsxs("span",{className:"flex items-center gap-1",children:[c&&e.jsx(Ps,{className:"w-3 h-3 animate-spin"}),N.emoji&&!/^upscale_\d+$/i.test(N.emoji)&&e.jsx("span",{children:N.emoji}),U,y&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},I)})})]})})(),ae&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>Z(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ie,onChange:m=>we(m.target.value),onMouseDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const m=ee==="ALL"?ge:ge.filter(N=>(N.category||"OTHER")===ee);return m.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:ee==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:fe,onChange:N=>Q(N.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:m.map(N=>e.jsxs("option",{value:N.id,children:[N.name," (",N._count.assets," ä¸ªèµ„äº§)"]},N.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(m=>e.jsx("button",{type:"button",onClick:()=>{Se(m);const N=ge.filter(I=>(I.category||"OTHER")===m);Q(N.length>0?N[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${ee===m?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:m==="ROLE"?"person":m==="SCENE"?"landscape":m==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:m==="ROLE"?"è§’è‰²åº“":m==="SCENE"?"åœºæ™¯åº“":m==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},m))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Z(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:a,disabled:ce||ge.length===0||!ie.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:ce?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},vo=t.memo(ko),No=({data:s,id:S})=>{var z;const l="https://api.waule.ai",[F,me]=t.useState(!1),[T,xe]=t.useState([]),[Y,ae]=t.useState(""),[Z,ge]=t.useState("ALL"),[Ae,fe]=t.useState(""),[Q,ee]=t.useState(!1),{setNodes:Se}=Zt(),[ie]=t.useState(s.width||400),[we,ce]=t.useState(null),[be,Ee]=t.useState(!1),le=t.useRef(null),te=Ar(),R=!!((z=s==null?void 0:s.workflowContext)!=null&&z.episode)||te.pathname.includes("/episodes/");t.useEffect(()=>{F&&(P(),setTimeout(()=>{g()},100))},[F]),t.useEffect(()=>{const D=le.current;if(!D)return;const C=()=>{const p=D.videoWidth||0,a=D.videoHeight||0;if(p>0&&a>0){const v=p/a;ce(Math.round(ie/v))}},W=()=>Ee(!0),r=()=>Ee(!1),k=()=>Ee(!1);return D.addEventListener("loadedmetadata",C),D.addEventListener("play",W),D.addEventListener("pause",r),D.addEventListener("ended",k),()=>{D.removeEventListener("loadedmetadata",C),D.removeEventListener("play",W),D.removeEventListener("pause",r),D.removeEventListener("ended",k)}},[ie,s.videoUrl]);const $=D=>{D.stopPropagation();const C=le.current;C&&(C.paused?C.play():C.pause())};t.useEffect(()=>{try{const D=localStorage.getItem("suppressedPreviewTasks")||"[]",C=JSON.parse(D),W=s==null?void 0:s.pendingButtonAction;if(W&&C.some(k=>k.taskId&&k.taskId===W.newTaskId||k.sourceNodeId&&k.sourceNodeId===W.sourceNodeId)){me(!1);return}}catch{}},[]);const P=async()=>{try{const D=await _e.assetLibraries.getAll();xe(D.data),D.data.length>0&&ae(D.data[0].id)}catch{f.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},g=()=>{const D=window.__workflowContext;if(!D||!D.project||!D.nodeGroups){f.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const C=Hs(S,D.nodeGroups);if(!C&&D.nodeGroups.length>0){const r=D.nodeGroups[0],k=Ts({project:D.project,episode:D.episode,nodeGroup:r,assetType:"video"});k?(fe(k),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${k}`)):f.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const W=Ts({project:D.project,episode:D.episode,nodeGroup:C,assetType:"video"});W?(fe(W),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${W}`)):f.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},x=async()=>{var D,C;if(!Y){f.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Ae.trim()){f.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ee(!0),await _e.assetLibraries.addFromUrl(Y,s.videoUrl,Ae.trim());const W=window.__workflowContext;if(W&&W.project&&W.nodeGroups){const r=Hs(S,W.nodeGroups)||W.nodeGroups[0];r&&Ts({project:W.project,episode:W.episode,nodeGroup:r,nodeId:S,assetType:"video",preview:!1})}f.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),me(!1),fe("");try{Se(r=>r.map(k=>k.id===S?{...k,data:{...k.data,addedToLibrary:!0}}:k))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:Y}});window.dispatchEvent(r)}catch{}}catch(W){f.error(((C=(D=W.response)==null?void 0:D.data)==null?void 0:C.message)||"æ·»åŠ å¤±è´¥")}finally{ee(!1)}},_=async()=>{var D;try{const C=s.videoUrl;let W=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const k=Hs(S,r.nodeGroups)||r.nodeGroups[0];if(k){const p=Ts({project:r.project,episode:r.episode,nodeGroup:k,nodeId:S,assetType:"video",preview:!0});if(p&&(W=p,!W.includes("."))){const a=((D=C.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:D[0])||".mp4";W+=a}}}f.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");try{const k=await fetch(C);if(!k.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${k.status}`);const p=await k.blob(),a=window.URL.createObjectURL(p),v=document.createElement("a");v.href=a,v.download=W,document.body.appendChild(v),v.click(),document.body.removeChild(v),setTimeout(()=>{window.URL.revokeObjectURL(a)},100),f.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${W}`)}catch{const p=`/api/assets/proxy-download-with-name?url=${encodeURIComponent(C)}&filename=${encodeURIComponent(W)}`,a=document.createElement("a");a.href=p,a.download=W,document.body.appendChild(a),a.click(),document.body.removeChild(a),f.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${W}`)}}catch(C){f.error(`æ“ä½œå¤±è´¥: ${C instanceof Error?C.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ie},children:[e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",onContextMenu:D=>{D.preventDefault(),D.stopPropagation()},onMouseDown:D=>{if(D.button===2){const C=D.currentTarget;C.style.pointerEvents="none",setTimeout(()=>{C.style.pointerEvents=""},100)}},children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${be?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:$,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:be?"pause":"play_arrow"})})}),e.jsx("video",{ref:le,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${l}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:we?`${we}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[R&&e.jsxs("button",{onClick:async()=>{var D,C;try{const W=s.videoUrl,r=s.workflowContext||{},k=r.episode,p=(()=>{try{const G=new URLSearchParams(window.location.search);return{scene:Number(G.get("scene")),shot:Number(G.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),a=r.nodeGroup||Hs(S,r.nodeGroups||[]),v=(a==null?void 0:a.scene)??p.scene,u=(a==null?void 0:a.shot)??p.shot,w=(()=>{try{const G=te.pathname.split("/").filter(Boolean),O=G.indexOf("projects"),ne=G.indexOf("episodes"),ue=O>=0?G[O+1]:void 0,oe=ne>=0?G[ne+1]:void 0;return{pid:ue,eid:oe}}catch{return{pid:void 0,eid:void 0}}})(),m=((D=r.project)==null?void 0:D.id)||(k==null?void 0:k.projectId)||w.pid,N=(k==null?void 0:k.id)||w.eid;if(!m||!N||!v||!u){f.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const I=await _e.episodes.getById(m,N),U=(I==null?void 0:I.data)??I,y=(U==null?void 0:U.data)??U,c=Array.isArray((C=y==null?void 0:y.scriptJson)==null?void 0:C.acts)?[...y.scriptJson.acts]:[];let i=c.find(G=>Number(G.actIndex)===Number(v));i||(i={actIndex:Number(v),shots:[]},c.push(i)),i.shots=Array.isArray(i.shots)?[...i.shots]:[];let n=i.shots.find(G=>Number(G.shotIndex)===Number(u));n||(n={shotIndex:Number(u),mediaList:[]},i.shots.push(n));const V=Array.isArray(n.mediaList)?n.mediaList.slice():[];if(V.length>=4){f.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}V.push({type:"video",url:W,nodeId:S}),n.mediaList=V;const M={...y.scriptJson||{},acts:c};await _e.episodes.update(m,N,{scriptJson:M});try{Se(G=>G.map(O=>O.id===S?{...O,data:{...O.data,addedToStoryboard:!0}}:O))}catch{}f.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(W){f.error((W==null?void 0:W.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{me(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:_,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),F&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:D=>D.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>me(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Ae,onChange:D=>fe(D.target.value),onMouseDown:D=>D.stopPropagation(),onTouchStart:D=>D.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const D=Z==="ALL"?T:T.filter(C=>(C.category||"OTHER")===Z);return D.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Z==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Y,onChange:C=>ae(C.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:D.map(C=>e.jsxs("option",{value:C.id,children:[C.name," (",C._count.assets," ä¸ªèµ„äº§)"]},C.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(D=>e.jsx("button",{type:"button",onClick:()=>{ge(D);const C=T.filter(W=>(W.category||"OTHER")===D);ae(C.length>0?C[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Z===D?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:D==="ROLE"?"person":D==="SCENE"?"landscape":D==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:D==="ROLE"?"è§’è‰²åº“":D==="SCENE"?"åœºæ™¯åº“":D==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},D))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>me(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:x,disabled:Q||T.length===0||!Ae.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:Q?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`})]})},jo=t.memo(No),Io=({data:s,id:S,selected:l})=>{const{getNodes:F,getEdges:me,setEdges:T,setNodes:xe,getNode:Y}=Zt(),[ae,Z]=t.useState(s.content||""),ge=t.useRef(null),Ae=t.useRef(null),fe=t.useRef(null),Q=t.useRef(null);t.useEffect(()=>{const $=_=>{_.stopPropagation()},P=Ae.current,g=fe.current;P&&P.addEventListener("wheel",$,{passive:!0}),g&&g.addEventListener("wheel",$,{passive:!0});const x=Q.current;return x&&x.addEventListener("wheel",$,{passive:!0}),()=>{P&&P.removeEventListener("wheel",$),g&&g.removeEventListener("wheel",$),x&&x.removeEventListener("wheel",$)}},[]);const ee=t.useRef(null),Se=async $=>{var P,g;try{const x=(s==null?void 0:s.workflowContext)||{},_=x.episode,z=x.nodeGroup||Array.isArray(x.nodeGroups)&&x.nodeGroups.find(N=>(N.nodeIds||[]).includes(S))||null;let D=z==null?void 0:z.scene,C=z==null?void 0:z.shot;try{const N=new URLSearchParams(window.location.search),I=Number(N.get("scene")),U=Number(N.get("shot"));Number.isFinite(I)&&I>0&&(D=D??I),Number.isFinite(U)&&U>0&&(C=C??U)}catch{}const W=((P=x.project)==null?void 0:P.id)||(_==null?void 0:_.projectId),r=_==null?void 0:_.id;if(!W||!r||!D||!C)return;const k=await _e.episodes.getById(W,r),p=(k==null?void 0:k.data)??k,a=(p==null?void 0:p.data)??p,v=Array.isArray((g=a==null?void 0:a.scriptJson)==null?void 0:g.acts)?[...a.scriptJson.acts]:[];let u=v.find(N=>Number(N.actIndex)===Number(D));u||(u={actIndex:Number(D),shots:[]},v.push(u)),u.shots=Array.isArray(u.shots)?[...u.shots]:[];let w=u.shots.find(N=>Number(N.shotIndex)===Number(C));w||(w={shotIndex:Number(C)},u.shots.push(w)),Object.keys($).forEach(N=>{w[N]=$[N]||""});const m={...a.scriptJson||{},acts:v};await _e.episodes.update(W,r,{scriptJson:m})}catch(x){f.error((x==null?void 0:x.message)||"ä¿å­˜å¤±è´¥")}},ie=()=>{var $,P,g;try{const x=F(),_=me(),z=x.find(p=>p.id===S),D=_.filter(p=>p.source===S).map(p=>p.target),C=x.filter(p=>p.type==="agent");let W="";const r=C.find(p=>D.includes(p.id));if(r)W=r.id;else if(z&&C.length>0)W=((P=($=C.map(a=>{var v,u,w,m;return{a,dx:(((v=a.position)==null?void 0:v.x)??0)-(((u=z.position)==null?void 0:u.x)??0),dy:Math.abs((((w=a.position)==null?void 0:w.y)??0)-(((m=z.position)==null?void 0:m.y)??0))}}).sort((a,v)=>(a.dx>=0&&v.dx>=0,a.dx-v.dx||a.dy-v.dy))[0])==null?void 0:$.a)==null?void 0:P.id)||C[0].id;else{const p=x.findIndex(a=>a.id===S);W=((g=x[p+1])==null?void 0:g.id)||""}if(!W)return;T(p=>p.some(v=>v.source===S&&v.target===W)?p:[...p,{id:`e-${Date.now()}`,source:S,target:W}]);const k=ae||String((s==null?void 0:s.content)||"");xe(p=>p.map(a=>{if(a.id!==W)return a;const v=a.data||{};return a.type==="agent"?{...a,data:{...v,config:{...v.config||{},prompt:k}}}:a.type==="midjourney"?{...a,data:{...v,prompt:k}}:a.type==="aiImage"?{...a,data:{...v,config:{...v.config||{},prompt:k}}}:a.type==="textPreview"?{...a,data:{...v,content:k}}:{...a,data:{...v,config:{...v.config||{},prompt:k}}}}))}catch{}},we=(s.title||"")==="åˆ†é•œè®¾è®¡",ce=(s.title||"")==="æç¤ºè¯",be=(()=>{if(!we)return[];const $=String(s.content||""),P=$.split(/\r?\n/).map(C=>C.trim()),g=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),x=[];let _=null;for(const C of P){if(!C)continue;const W=C.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(W&&g.has(W[1])){_&&x.push(_),_={label:W[1],content:W[2]||""};continue}if(g.has(C)){_&&x.push(_),_={label:C,content:""};continue}_?_.content=_.content?`${_.content}
${C}`:C:_={label:"æ–‡æœ¬",content:C}}if(_&&x.push(_),x.length===0)return[{label:"æ–‡æœ¬",content:$}];const z=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],D=new Map(z.map((C,W)=>[C,W]));return x.filter(C=>C.content&&C.content.trim().length>0).sort((C,W)=>(D.get(C.label)??999)-(D.get(W.label)??999))})(),[Ee,le]=t.useState(be),te=t.useRef(null),R=t.useRef([]);return t.useEffect(()=>{le(be)},[s.content,we]),t.useEffect(()=>{requestAnimationFrame(()=>{R.current.forEach($=>{$&&($.style.height="auto",$.style.height=`${$.scrollHeight}px`)})})},[Ee]),t.useEffect(()=>{ce&&Z(s.content||"")},[s.content,ce]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:we?e.jsx("div",{ref:fe,className:"space-y-2 nowheel",children:Ee.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ee.map(($,P)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:$.label}),e.jsx("textarea",{value:$.content,onChange:g=>{const x=g.target.value;g.target.style.height="auto",g.target.style.height=`${g.target.scrollHeight}px`,le(_=>{const z=_.map((W,r)=>r===P?{...W,content:x}:W),D=z.map(W=>`${W.label}ï¼š${W.content}`).join(`
`);return Y(S)&&xe(W=>W.map(r=>r.id===S?{...r,data:{...r.data,content:D}}:r)),te.current&&(clearTimeout(te.current),te.current=null),te.current=window.setTimeout(async()=>{const W=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};z.forEach(k=>{W.has(k.label)&&(r[k.label]=k.content)}),await Se(r)},600),z})},onBlur:async g=>{const x=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),_={};_[$.label]=g.currentTarget.value,x.has($.label)&&await Se(_)},onMouseDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),ref:g=>{R.current[P]=g,g&&(g.style.height="auto",g.style.height=`${g.scrollHeight}px`,g.style.overflow="hidden",g.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",placeholder:`å¡«å†™${$.label}...`})]},`sec-${P}`))}):ce?e.jsxs("div",{ref:Ae,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:ae,onChange:$=>{const P=$.target.value;Z(P);const g=440;$.target.style.height="auto";const x=Math.min($.target.scrollHeight,g);$.target.style.height=`${x}px`,$.target.style.overflowY=$.target.scrollHeight>g?"auto":"hidden",Y(S)&&xe(z=>z.map(D=>D.id===S?{...D,data:{...D.data,content:P}}:D)),ee.current&&(clearTimeout(ee.current),ee.current=null),ee.current=window.setTimeout(async()=>{await Se({æç¤ºè¯:P})},600)},onBlur:async $=>{const P=$.currentTarget.value;await Se({æç¤ºè¯:P})},onMouseDown:$=>$.stopPropagation(),onTouchStart:$=>$.stopPropagation(),ref:$=>{if(ge.current=$,$){$.style.wordBreak="break-word",$.style.height="auto";const g=Math.min($.scrollHeight,440);$.style.height=`${g}px`,$.style.overflowY=$.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ie,onPointerDown:$=>$.stopPropagation(),onMouseDown:$=>$.stopPropagation(),disabled:!ae.trim(),className:"nodrag relative w-full mt-2 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:Q,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(Ut,{type:"target",position:pt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(Ut,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},So=t.memo(Io),Eo=({data:s,selected:S,id:l})=>{const{setNodes:F,setEdges:me,getNode:T,getNodes:xe,getEdges:Y,getViewport:ae}=Zt(),Z=Js(),ge=Os(),[Ae]=t.useState(s.isExpanded??!0),[fe,Q]=t.useState(s.prompt||""),[ee,Se]=t.useState(s.ratio||"16:9"),[ie,we]=t.useState(s.mode||"relax"),[ce,be]=t.useState(s.chaos??0),[Ee,le]=t.useState(s.stylize??100),[te,R]=t.useState(s.weird??0),[$,P]=t.useState(s.quality??1),[g,x]=t.useState(s.styleRaw??!1),[_,z]=t.useState(s.omniWeight??100),[D,C]=t.useState(s.styleWeight??100),[,W]=t.useState(s.taskId||""),[r,k]=t.useState(s.status||"idle"),[p,a]=t.useState(s.progress||""),[v,u]=t.useState(s.omniReferenceImages||[]),[w,m]=t.useState(s.styleReferenceImages||[]),[N,I]=t.useState(!0);t.useEffect(()=>{(async()=>{var b;try{const J=await _e.midjourney.getSettings();I(((b=J.settings)==null?void 0:b.fastEnabled)??!0)}catch{}})()},[]);const{credits:U,isFreeUsage:y,freeUsageRemaining:c,refetch:i}=Ns({moduleType:"midjourney",operationType:"imagine",mode:ie}),n=t.useRef(null),V=t.useRef(!1),M=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==fe&&Q(s.prompt)},[s.prompt]);const G=j=>{F(b=>b.map(J=>J.id===l?{...J,data:{...J.data,...j}}:J))};t.useEffect(()=>{const j=s.taskId,b=s.status;(async()=>{var de,B;if(j&&(b==="processing"||b==="submitting"))try{const Ce=(await _e.midjourney.fetchTask(j)).task;if(Ce.status==="SUCCESS"){const Ne=Ce.imageUrl||"",Oe=((de=Ce.properties)==null?void 0:de.messageId)||"",Ue=((B=Ce.properties)==null?void 0:B.messageHash)||"",Re=s.ratio||"16:9";if(k("idle"),a(""),G({status:"idle",progress:"",taskId:""}),xe().find(Ve=>{var et,kt,vt;return Ve.type==="imagePreview"&&((et=Ve.data.midjourneyData)==null?void 0:et.sourceNodeId)===l&&(((kt=Ve.data.midjourneyData)==null?void 0:kt.taskId)===j||Oe&&((vt=Ve.data.midjourneyData)==null?void 0:vt.messageId)===Oe)})){f.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}f.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(Ne,"4å®«æ ¼",Re,{taskId:j,messageId:Oe,messageHash:Ue,mode:s.mode||"relax",buttons:Ce.buttons,action:Ce.action})}else Ce.status==="IN_PROGRESS"||Ce.status==="SUBMITTED"?(k("processing"),setTimeout(()=>{M.current(j)},100)):Ce.status==="FAILURE"?(k("error"),a(""),G({status:"error",progress:"",taskId:""}),f.error(Ce.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ce.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Ce.status==="NOT_FOUND"&&(k("idle"),a(""),G({status:"idle",progress:"",taskId:""}))}catch{k("idle"),a(""),G({status:"idle",progress:"",taskId:""}),f.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const O=t.useCallback(()=>{const j=Z.filter(Ne=>Ne.target===l),b=[],J=[];let de="";j.forEach(Ne=>{var Ue,Re,Te,se,Ve,et,kt,vt;const Oe=T(Ne.source);if(Oe){const Nt=Oe.data,ct=Ne.targetHandle||"omni-ref";if(ct==="text-input"){if(Oe.type==="agent"){const ut=((Ue=Nt.config)==null?void 0:Ue.generatedText)||"";ut&&typeof ut=="string"&&(de=ut)}}else{let ut=Nt.imageUrl||"";if(!ut&&((Re=Nt.config)!=null&&Re.selectedAsset)){const St=Nt.config.selectedAsset;St.type==="IMAGE"&&(ut=`https://api.waule.ai${St.url}`.replace(".oss-oss-",".oss-"))}if(!ut&&((Te=Nt.config)!=null&&Te.generatedImageUrl)&&(ut=Nt.config.generatedImageUrl),Oe.type==="assetSelector"){const St="https://api.waule.ai",lt=ze=>{let wt=ze||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${St}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,St))},Ke=(se=Nt.config)==null?void 0:se.subjects,It=(Ve=Nt.config)==null?void 0:Ve.referenceImages;if(ct==="omni-ref"){let ze="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?ze=lt(Ke[0].images[0]):It&&It.length>0?ze=lt(It[0].url):(et=Nt.config)!=null&&et.selectedAsset&&Nt.config.selectedAsset.type==="IMAGE"&&(ze=lt(Nt.config.selectedAsset.url)),ze&&!b.includes(ze)&&b.length<1&&b.push(ze)}else if(ct==="style-ref"){let ze="";Ke&&Ke.length>0&&Ke[0].images&&Ke[0].images.length>0?ze=lt(Ke[0].images[0]):It&&It.length>0?ze=lt(It[0].url):(kt=Nt.config)!=null&&kt.selectedAsset&&Nt.config.selectedAsset.type==="IMAGE"&&(ze=lt(Nt.config.selectedAsset.url)),ze&&!J.includes(ze)&&J.length<1&&J.push(ze)}}if(Oe.type==="upload"){const St="https://api.waule.ai",lt=ze=>{let wt=ze||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${St}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,St))},It=(((vt=Nt.config)==null?void 0:vt.uploadedFiles)||[]).find(ze=>ze.type==="IMAGE"||(ze.mimeType||"").startsWith("image/"));if(It){const ze=lt(It.url);ct==="omni-ref"?ze&&!b.includes(ze)&&b.length<1&&b.push(ze):ct==="style-ref"&&ze&&!J.includes(ze)&&J.length<1&&J.push(ze)}}ut&&(ct==="omni-ref"&&!b.includes(ut)?b.push(ut):ct==="style-ref"&&!J.includes(ut)&&J.push(ut))}}}),de&&de!==fe&&!V.current&&(Q(de),G({prompt:de}));const B=Ne=>{if(!Ne||typeof Ne!="string")return!1;const Oe=Ne.trim();return Oe?!!(Oe.startsWith("data:image/")||/^https?:\/\//.test(Oe)||Oe.startsWith("/")):!1},pe=b.filter(B).slice(0,1),Ce=J.filter(B).slice(0,1);JSON.stringify(pe)!==JSON.stringify(v)&&(u(pe),G({omniReferenceImages:pe})),JSON.stringify(Ce)!==JSON.stringify(w)&&(m(Ce),G({styleReferenceImages:Ce}))},[Z,l,T,ge,fe,V.current]);t.useEffect(()=>{O()},[O]),t.useEffect(()=>{const j=n.current;j&&Ae&&requestAnimationFrame(()=>{j.style.height="auto";const b=Math.max(60,Math.min(j.scrollHeight,600));j.style.height=`${b}px`})},[fe,Ae]);const ne=j=>{try{const b=new URL(j),J=new URLSearchParams(b.search);return J.has("width")||J.has("height")?(J.delete("width"),J.delete("height"),b.search=J.toString(),b.toString()):j}catch{return j}},ue=j=>{const[J,de]=j.split(":").map(Number);if(!J||!de)return{width:512,height:512};const B=J/de;return B>=1?{width:512,height:Math.round(512/B)}:{width:Math.round(512*B),height:512}},oe=t.useCallback((j,b,J,de)=>{const B=T(l);if(!B)return;const pe=b.startsWith("U")?ne(j):j,Ce=xe(),Ne=Y();if(Ce.filter(ze=>ze.type==="imagePreview"&&Ne.some(wt=>wt.source===l&&wt.target===ze.id)).find(ze=>ze.data.imageUrl===pe))return;const Re=400,Te=200,se=100,Ve=ze=>{const wt=ae().zoom||1,ts=document.querySelector(`.react-flow__node[data-id="${ze.id}"]`),ms=(ts==null?void 0:ts.getBoundingClientRect().width)||ze.data&&ze.data.width||400,Rs=(ts==null?void 0:ts.getBoundingClientRect().height)||ze.data&&ze.data.height||300,Is=Math.round(ms/wt),Ss=Math.round(Rs/wt);return{w:Is,h:Ss}},et=(ze,wt=300)=>{if(!ze||!/^[0-9]+\s*:\s*[0-9]+$/.test(ze))return wt;const[ts,ms]=ze.split(":").map(Rs=>parseFloat(Rs));return!ts||!ms?wt:Math.round(Re*(ms/ts))},kt=Ve(B),vt=et(J,300),Nt=B.position.x+kt.w+Te,ct=B.position.y,ut=xe().filter(ze=>{var wt,ts;return ze.type==="imagePreview"&&((ts=(wt=ze.data)==null?void 0:wt.midjourneyData)==null?void 0:ts.sourceNodeId)===l}).length,St=Nt,lt=ct+ut*(vt+se),Ke=`preview-${Date.now()}`,It={id:Ke,type:"imagePreview",position:{x:St,y:lt},data:{imageUrl:pe,width:Re,ratio:J,workflowContext:B.data.workflowContext,createdBy:B.data.createdBy,midjourneyData:de?{taskId:de.taskId,messageId:de.messageId,messageHash:de.messageHash,sourceNodeId:l,mode:de.mode,buttons:de.buttons,action:de.action}:void 0}};F(ze=>[...ze,It]),me(ze=>[...ze,{id:`${l}-${Ke}`,source:l,target:Ke,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),f.success(`âœ¨ å·²åˆ›å»º${b}é¢„è§ˆèŠ‚ç‚¹`)},[l,T,xe,Y,F,me,ne,ue]),h=t.useCallback(async()=>{var j,b,J,de,B,pe,Ce,Ne,Oe,Ue,Re,Te;if(!fe.trim()){f.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}k("submitting"),a(""),G({status:"submitting",progress:""});try{const se=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ve=fe.toLowerCase(),et=se.find(lt=>Ve.includes(lt));if(et){f.error(`æ£€æµ‹åˆ°å‚æ•° "${et}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),k("idle"),G({status:"idle",progress:"",taskId:""});return}k("submitting");let kt=fe;try{f.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const lt=await _e.translation.smartTranslate({text:fe});lt.success&&(kt=lt.translatedText,lt.needsTranslation&&f.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{f.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}f.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let vt=kt.trim();if(ee&&ee!=="1:1"&&!vt.includes("--ar")&&(vt+=` --ar ${ee}`),!vt.includes("--v")&&!vt.includes("--version")&&(vt+=" --v 7.0"),ie==="fast"&&!vt.includes("--fast")?vt+=" --fast":ie==="relax"&&!vt.includes("--relax")&&(vt+=" --relax"),ce>0&&(vt+=` --chaos ${ce}`),Ee!==100&&(vt+=` --stylize ${Ee}`),te>0&&(vt+=` --weird ${te}`),$!==1&&(vt+=` --quality ${$}`),g&&(vt+=" --style raw"),v.length>0){f.info(`æ­£åœ¨ä¸Šä¼  ${v.length} å¼ å‚è€ƒå›¾...`);const lt=[];for(let Ke=0;Ke<v.length;Ke++){const It=v[Ke];try{const ze=await _e.midjourney.uploadReferenceImage({imageUrl:It});if(ze.success&&ze.discordUrl)lt.push(ze.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{f.error(`å‚è€ƒå›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),k("idle");return}}vt+=` --oref ${lt.join(" ")}`,_!==100&&(vt+=` --ow ${_}`),f.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(w.length>0){f.info(`æ­£åœ¨ä¸Šä¼  ${w.length} å¼ é£æ ¼å›¾...`);const lt=[];for(let Ke=0;Ke<w.length;Ke++){const It=w[Ke];try{const ze=await _e.midjourney.uploadReferenceImage({imageUrl:It});if(ze.success&&ze.discordUrl)lt.push(ze.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{f.error(`é£æ ¼å›¾ ${Ke+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),k("idle");return}}vt+=` --sref ${lt.join(" ")}`,D!==100&&(vt+=` --sw ${D}`),f.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const Nt=await _e.midjourney.imagine({prompt:vt,nodeId:l,mode:ie});if(!Nt.success)throw new Error(Nt.description||"ä»»åŠ¡æäº¤å¤±è´¥");const ct=Nt.taskId;W(ct),k("processing"),G({taskId:ct,status:"processing",progress:"",prompt:fe,ratio:ee,mode:ie,chaos:ce,stylize:Ee,weird:te,quality:$,styleRaw:g,omniWeight:_,styleWeight:D});const ut=Nt.isFreeUsage,St=Nt.creditsCharged||0;if(ut)f.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${c} æ¬¡æœºä¼š`),i();else if(St>0){const{useAuthStore:lt}=await us(async()=>{const{useAuthStore:It}=await import("./index-CiJ2Nd2F.js").then(ze=>ze.f);return{useAuthStore:It}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ke}=lt.getState();await Ke(),f.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${St} ç§¯åˆ†`),i()}else f.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");M.current(ct)}catch(se){if(k("error"),a(""),G({status:"error",progress:"",taskId:""}),((j=se.response)==null?void 0:j.status)===403){const kt=((J=(b=se.response)==null?void 0:b.data)==null?void 0:J.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";f.error(kt);return}if(((de=se.response)==null?void 0:de.status)===429){f.warning(((pe=(B=se.response)==null?void 0:B.data)==null?void 0:pe.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ve=((Ne=(Ce=se.response)==null?void 0:Ce.data)==null?void 0:Ne.description)||((Ue=(Oe=se.response)==null?void 0:Oe.data)==null?void 0:Ue.error)||se.message,et=(Te=(Re=se.response)==null?void 0:Re.data)==null?void 0:Te.bannedWord;et?f.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${et}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):f.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ve}ï¼Œè¯·ç¨åé‡è¯•`)}},[fe,ee,ie,ce,Ee,te,$,g,v,_,w,D,G,y,c,i]),d=t.useCallback(async j=>{let b=0;const J=150,de=2e3,B=async()=>{var pe,Ce,Ne,Oe;try{const Re=(await _e.midjourney.fetchTask(j)).task;if(Re.status==="SUCCESS"){const se=Re.imageUrl||"",Ve=((pe=Re.properties)==null?void 0:pe.messageId)||"",et=((Ce=Re.properties)==null?void 0:Ce.messageHash)||"";if(k("idle"),a(""),G({status:"idle",taskId:"",progress:""}),xe().find(Nt=>{var ct,ut,St;return Nt.type==="imagePreview"&&((ct=Nt.data.midjourneyData)==null?void 0:ct.sourceNodeId)===l&&(((ut=Nt.data.midjourneyData)==null?void 0:ut.taskId)===j||Ve&&((St=Nt.data.midjourneyData)==null?void 0:St.messageId)===Ve)})){f.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}f.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(se,"4å®«æ ¼",ee,{taskId:j,messageId:Ve,messageHash:et,mode:ie,buttons:Re.buttons,action:Re.action});return}const Te=Re.progress||"";if(a(Te),(Re.status==="IN_PROGRESS"||Re.status==="SUBMITTED")&&(k("processing"),G({status:"processing",progress:Te})),Re.status==="FAILURE"){k("error"),a(""),G({status:"error",progress:"",taskId:""}),f.error(Re.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Re.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(Re.status==="NOT_FOUND"){k("error"),a(""),G({status:"error",progress:"",taskId:""}),f.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}b++,b<J?setTimeout(B,de):(k("error"),a(""),G({status:"error",progress:"",taskId:""}),f.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Ue){if((Ue.code==="ECONNABORTED"||Ue.code==="ERR_NETWORK"||((Ne=Ue.message)==null?void 0:Ne.includes("aborted"))||((Oe=Ue.message)==null?void 0:Oe.includes("Network Error")))&&b<J-1){b++,setTimeout(B,de*2);return}k("error"),a(""),G({status:"error",progress:"",taskId:""}),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};B()},[l,ee,oe,G,xe]);return M.current=d,e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Ae&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:n,value:fe,onChange:j=>{V.current=!0,Q(j.target.value)},onPointerDown:j=>j.stopPropagation(),onMouseDown:j=>j.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:j=>j.stopPropagation(),onMouseDown:j=>j.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>we("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ie==="relax"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!N){f.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}we("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${N?ie==="fast"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50":"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:cursor-not-allowed`,title:N?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!N&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(as,{value:ee,onChange:j=>Se(j),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:ce})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:ce,onChange:j=>be(Number(j.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${ce/2}%, #06b6d4 ${ce}%, var(--range-bg-color) ${ce}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ee})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ee,onChange:j=>le(Number(j.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Ee/1e3*50}%, #06b6d4 ${Ee/1e3*100}%, var(--range-bg-color) ${Ee/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:te})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:te,onChange:j=>R(Number(j.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${te/3e3*50}%, #06b6d4 ${te/3e3*100}%, var(--range-bg-color) ${te/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:$})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:$===.25?0:$===.5?1:$===1?2:3,onChange:j=>{const b=Number(j.target.value);P(b===0?.25:b===1?.5:b===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${($===.25?0:$===.5?1:$===1?2:3)/3*50}%, #06b6d4 ${($===.25?0:$===.5?1:$===1?2:3)/3*100}%, var(--range-bg-color) ${($===.25?0:$===.5?1:$===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>x(!g),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:cursor-not-allowed ${g?"bg-neutral-800 dark:bg-white text-white dark:text-black border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-neutral-500 dark:border-neutral-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${g?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-neutral-800 dark:bg-white text-white dark:text-black"}`})})]})})]}),v.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Pr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",v.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:v.map((j,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:j,alt:`Reference ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:_})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:_,onChange:j=>z(Number(j.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${_/1e3*50}%, #06b6d4 ${_/1e3*100}%, var(--range-bg-color) ${_/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),w.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Pr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",w.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:w.map((j,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:j,alt:`Style ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:D})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:D,onChange:j=>C(Number(j.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${D/1e3*50}%, #06b6d4 ${D/1e3*100}%, var(--range-bg-color) ${D/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:h,onPointerDown:j=>j.stopPropagation(),onMouseDown:j=>j.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1||!(fe!=null&&fe.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 relative overflow-hidden ${r==="processing"||r==="submitting"||!(fe!=null&&fe.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:[r==="processing"&&p&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-neutral-400/30 to-accent-400/30 transition-all duration-300",style:{width:p}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!p||p===""||p==="0%"?ie==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${p}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),y?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(c),"æ¬¡"]}):U!==null&&U>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:[U,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(hs,{type:"target",position:pt.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:j=>{const b=T(j.source||"");return!!b&&b.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(hs,{type:"target",position:pt.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:j=>!Z.some(J=>J.target===l&&J.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(hs,{type:"target",position:pt.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:j=>!Z.some(J=>J.target===l&&J.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(hs,{type:"source",position:pt.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},kr="https://api.waule.ai",Co=({data:s,selected:S,id:l})=>{var bs,Ks,Es,$s,sr,rr,Vs;const[F,me]=t.useState(!0),[,T]=t.useState(0),[xe,Y]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[xe]);const{setNodes:ae,setEdges:Z,getNode:ge,getNodes:Ae,getEdges:fe}=Zt(),Q=Js(),ee=Os(),Se=t.useRef(""),ie=(bs=s.config)==null?void 0:bs.selectedEditingCapability,we=t.useMemo(()=>(s.models||[]).filter(re=>{var $e;return re.type==="VIDEO_GENERATION"&&(($e=re.provider)==null?void 0:$e.toLowerCase())==="sora"}),[s.models]),[ce,be]=t.useState(s.config.prompt||""),Ee=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ce&&be(s.config.prompt)},[s.config.prompt]);const[le,te]=t.useState(s.config.modelId||((Ks=we[0])==null?void 0:Ks.id)||""),[R,$]=t.useState(s.config.ratio||"16:9"),[P,g]=t.useState(s.config.resolution||"1080P"),x=t.useCallback(q=>{const re=(q||"").toLowerCase();return re?re.includes("æ–‡ç”Ÿ")||re.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":re.includes("é¦–å°¾")?"é¦–å°¾å¸§":re.includes("é¦–å¸§")||re.includes("first frame")||re.includes("start frame")||re.includes("initial frame")||re.includes("keyframe")?"é¦–å¸§":re.includes("å°¾å¸§")||re.includes("last frame")||re.includes("end frame")||re.includes("final frame")?"å°¾å¸§":re.includes("ä¸»ä½“å‚è€ƒ")||re.includes("å‚è€ƒ")||re.includes("reference image")||re.includes("image reference")||re.includes("ref image")?"å‚è€ƒå›¾":re.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":re.includes("first-last")||re.includes("two-frame")||re.includes("frame pair")?"é¦–å°¾å¸§":re.includes("first")?"é¦–å¸§":re.includes("last")?"å°¾å¸§":re.includes("subject")||re.includes("reference")?"å‚è€ƒå›¾":q||"":""},[]),[_,z]=t.useState((s.config.lockedGenerationType?x(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[D,C]=t.useState(s.config.duration||10),[W,r]=t.useState(s.config.isGenerating||!1),[k,p]=t.useState([]),[a,v]=t.useState(null),[u,w]=t.useState(!1),[m]=t.useState(""),[N]=t.useState("confirm"),[I]=t.useState(null),[U,y]=t.useState(!1),[c,i]=t.useState([]),[n,V]=t.useState(""),[M,G]=t.useState(0),[O,ne]=t.useState(0),ue=t.useRef(!1),[oe,h]=t.useState(!1),d=we.find(q=>q.id===le)||we[0],{credits:j,loading:b,isFreeUsage:J,freeUsageRemaining:de,refetch:B}=Ns({aiModelId:d==null?void 0:d.id,duration:D,resolution:P});t.useEffect(()=>{var q,re;if(!we.find($e=>$e.id===le)){const $e=((q=we[0])==null?void 0:q.id)||"";te($e),et({modelId:$e,modelName:(re=we[0])==null?void 0:re.name})}},[we]);const pe=((Es=d==null?void 0:d.provider)==null?void 0:Es.toLowerCase())==="sora",Ce=t.useMemo(()=>{var re;if((re=d==null?void 0:d.config.supportedDurations)!=null&&re.length)return d.config.supportedDurations;const q=((d==null?void 0:d.provider)||"").toLowerCase();return q==="sora"?[10,15]:q==="minimaxi"?[6,10]:[D||10]},[d,D]),Ne=t.useMemo(()=>{var re;return(re=d==null?void 0:d.config.supportedResolutions)!=null&&re.length?d.config.supportedResolutions:((d==null?void 0:d.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[d]),Oe=t.useMemo(()=>Math.min(...Ce),[Ce]),Ue=t.useMemo(()=>Math.max(...Ce),[Ce]),Re=t.useMemo(()=>Math.max(1,Ue-Oe),[Ue,Oe]),Te=t.useMemo(()=>{const q=(D-Oe)/Re*100;return Number.isNaN(q)?0:Math.min(100,Math.max(0,q))},[D,Oe,Re]),se=!d||!(($s=d.config.supportedDurations)!=null&&$s.length),Ve=!d||!((sr=d.config.supportedResolutions)!=null&&sr.length),et=t.useCallback(q=>{ge(l)&&ae($e=>$e.map(Ge=>Ge.id===l?{...Ge,data:{...Ge.data,config:{...Ge.data.config,...q}}}:Ge))},[ge,l,ae]),kt=(q,re)=>{const $e=(yt,E)=>E===0?yt:$e(E,yt%E),Ge=$e(q,re),qe=q/Ge,Pe=re/Ge,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},bt=`${qe}:${Pe}`;return tt[bt]||bt},vt=()=>{const q=Q.filter(Pe=>Pe.target===l),re=[];q.forEach(Pe=>{var bt;const tt=ge(Pe.source);if(tt&&tt.type==="upload"&&(((bt=tt.data.config)==null?void 0:bt.uploadedFiles)||[]).forEach(E=>{const H=E.type||E.mimeType||"";(H==="IMAGE"||H.startsWith("image/"))&&re.push({id:E.id||E.name,url:E.url,name:E.name||E.originalName,width:E.width,height:E.height,aspectRatio:E.width&&E.height?kt(E.width,E.height):"16:9"})}),tt&&tt.type==="assetSelector"){const yt=tt.data.config||{},E=yt.subjects,H=yt.selectedAsset,ve=x(_);E&&E.length>0?ve==="é¦–å°¾å¸§"||(E[0].images||[]).forEach((he,Ie)=>{re.push({id:`${tt.id}-subject-${Ie}`,url:he,name:E[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):H&&H.type==="IMAGE"&&re.push({id:H.id,url:H.url,name:H.name||H.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const yt=tt.data.imageUrl,E=tt.data.width,H=tt.data.height;yt&&re.push({id:tt.id,url:yt,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:E,height:H,aspectRatio:E&&H?kt(E,H):"16:9"})}});const $e=new Set,Ge=[];re.forEach(Pe=>{const tt=Pe.url;$e.has(tt)||($e.add(tt),Ge.push(Pe))});const qe=x(_);return qe==="æ–‡ç”Ÿè§†é¢‘"?pe?Ge:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ge.slice(0,1):qe==="é¦–å°¾å¸§"?Ge.slice(0,2):qe==="å‚è€ƒå›¾"?Ge.slice(0,7):Ge},Nt=t.useMemo(()=>vt(),[Q,ee,_,l,pe]);t.useEffect(()=>{const q=s.config.taskId;(async()=>{if(q){try{const Ge=(await _e.tasks.getTaskStatus(q)).task;if(Ge.status==="SUCCESS"){r(!1),T(100);const qe=Ge.resultUrl;if(!qe){r(!1),T(0),et({taskId:"",isGenerating:!1}),Y(""),f.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Pe=s.config.ratio||"16:9";et({taskId:"",isGenerating:!1}),Y("");const tt=Ae(),bt=fe();if(tt.filter(H=>H.type==="videoPreview"&&bt.some(ve=>ve.source===l&&ve.target===H.id)).find(H=>H.data.videoUrl===qe)){setTimeout(()=>T(0),1e3);return}f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼");try{const H=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(H).some(he=>he.taskId&&he.taskId===q||he.sourceNodeId&&he.sourceNodeId===l)||$t(qe,Pe)}catch{$t(qe,Pe)}setTimeout(()=>T(0),1e3)}else if(Ge.status==="PROCESSING"||Ge.status==="PENDING"){r(!0),T(Ge.progress||0),js(q);return}else Ge.status==="FAILURE"&&(r(!1),T(0),et({taskId:"",isGenerating:!1}),Y(""),f.error(`ç”Ÿæˆå¤±è´¥: ${Ge.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{r(!1),T(0),et({taskId:"",isGenerating:!1}),Y("")}return}try{const $e=await _e.tasks.getPendingPreviewNodes(l);if($e.tasks&&$e.tasks.length>0)for(const Ge of $e.tasks){const{previewNodeData:qe}=Ge;if(qe&&qe.url){const Pe=qe.ratio||s.config.ratio||"16:9";let tt=!1;try{const bt=localStorage.getItem("suppressedPreviewTasks")||"[]";tt=JSON.parse(bt).some(E=>E.taskId&&E.taskId===Ge.id||E.sourceNodeId&&E.sourceNodeId===l)}catch{}tt||($t(qe.url,Pe),f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")),await _e.tasks.markPreviewNodeCreated(Ge.id)}}}catch{}})()},[]),t.useEffect(()=>{const q=Q.filter($e=>$e.target===l);let re="";q.forEach($e=>{var qe;const Ge=ge($e.source);if(Ge){const Pe=Ge.data;Ge.type==="agent"&&((qe=Pe.config)!=null&&qe.generatedText)?re||(re=Pe.config.generatedText):Ge.type==="textPreview"&&Pe.content&&(re||(re=Pe.content))}}),re&&re!==ce&&(be(re),et({prompt:re}))},[Q,l,ge,ce,et]),t.useEffect(()=>{const q=Q.filter(Ge=>Ge.target===l);if(q.length===0)return;let re="",$e="";q.forEach(Ge=>{var Pe;const qe=ee.find(tt=>tt.id===Ge.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Pe=tt.config)!=null&&Pe.generatedText&&(re=tt.config.generatedText,$e=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),re&&$e!==Se.current&&(Se.current=$e,be(re),et({prompt:re}))},[ee,Q,l,et]),t.useEffect(()=>{const q=JSON.stringify(Nt),re=JSON.stringify(k);q!==re&&p(Nt)},[Nt]);const ct=t.useMemo(()=>{if(pe)return!0;const q=k.length,re=x(_);return q===0?!0:q===1?re==="å‚è€ƒå›¾":q===2?re==="é¦–å°¾å¸§"?!1:re==="å‚è€ƒå›¾":q>2?re==="å‚è€ƒå›¾":!1},[k.length,_,x,pe]),ut=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),St=t.useMemo(()=>{const q=x(_);return ie?we:we.filter(re=>{var Ge;const $e=(((Ge=re.config)==null?void 0:Ge.supportedGenerationTypes)||[]).map(qe=>x(qe));return q==="é¦–å¸§"||q==="å°¾å¸§"?$e.includes("é¦–å¸§")||$e.includes("å°¾å¸§"):$e.includes(q)})},[we,_,x,ie]),lt=t.useMemo(()=>{const q=ie?we:St;return q.length>0?q:ie?(s.models||[]).filter($e=>($e.type||"")==="VIDEO_EDITING"):q},[ie,we,St,s.models]);t.useEffect(()=>{var re,$e;if(!lt.find(Ge=>Ge.id===le)){const Ge=((re=lt[0])==null?void 0:re.id)||"";te(Ge),et({modelId:Ge||void 0,modelName:Ge?($e=lt[0])==null?void 0:$e.name:void 0})}},[lt]);const Ke=t.useCallback(q=>{const re=x(q);return ie?["IMAGE","VIDEO"]:re==="æ–‡ç”Ÿè§†é¢‘"?pe?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[x,ie,pe]);t.useEffect(()=>{if(!ct&&k.length>0){const q=k[0].aspectRatio;q&&R!==q&&($(q),setTimeout(()=>{et({ratio:q})},0))}},[ct,k,R]),t.useEffect(()=>{if(!ie&&ut.length>0&&!ut.includes(_)){const q="æ–‡ç”Ÿè§†é¢‘";z(q),setTimeout(()=>{et({generationType:q,acceptedInputs:Ke(q)})},0)}},[ut,_,Ke,ie]),t.useEffect(()=>{const q=x(_);if(q==="æ–‡ç”Ÿè§†é¢‘")return;const re=Q.filter(Pe=>Pe.target===l),$e=[],Ge=[];re.forEach(Pe=>{var yt,E,H,ve,je;const tt=ge(Pe.source);if(!tt)return;const bt=tt.type;if((bt||"").startsWith("aiVideo")||bt==="videoPreview"){Ge.push(Pe.id);return}if(bt==="upload"){const he=(H=(E=(yt=tt.data)==null?void 0:yt.config)==null?void 0:E.uploadedFiles)==null?void 0:H[0],Ie=((he==null?void 0:he.type)||"").toUpperCase(),nt=((he==null?void 0:he.mimeType)||"").toLowerCase();if(Ie==="VIDEO"||nt.startsWith("video/")){Ge.push(Pe.id);return}(Ie==="IMAGE"||nt.startsWith("image/"))&&$e.push(Pe.id);return}if(bt==="assetSelector"){const he=((ve=tt.data)==null?void 0:ve.config)||{};if(he.selectedAsset){const Ie=(he.selectedAsset.type||"").toUpperCase(),nt=(he.selectedAsset.mimeType||"").toLowerCase();Ie==="VIDEO"||nt.startsWith("video/")?Ge.push(Pe.id):(Ie==="IMAGE"||nt.startsWith("image/"))&&$e.push(Pe.id)}else if(he.subjects&&he.subjects.length>0){const Ie=(((je=he.subjects[0])==null?void 0:je.images)||[]).length;q==="å‚è€ƒå›¾"||q==="é¦–å°¾å¸§"?$e.push(Pe.id):(q==="é¦–å¸§"||q==="å°¾å¸§")&&(Ie>1?Ge.push(Pe.id):$e.push(Pe.id))}return}(bt==="aiImage"||bt==="imagePreview")&&$e.push(Pe.id)});let qe=new Set([...Ge]);q==="é¦–å¸§"||q==="å°¾å¸§"?$e.slice(1).forEach(Pe=>qe.add(Pe)):q==="é¦–å°¾å¸§"&&$e.slice(2).forEach(Pe=>qe.add(Pe)),qe.size>0&&Z(Pe=>Pe.filter(tt=>!qe.has(tt.id)))},[_,Q,l,ge,Z,x]),t.useEffect(()=>{const q=s.config.generationType;if(!q||x(q)!==x(_)){const re=x(_)||"æ–‡ç”Ÿè§†é¢‘";et({generationType:re,acceptedInputs:Ke(re)})}},[]),t.useEffect(()=>{const q=Ke(_);et({acceptedInputs:q})},[_,Ke]);const It=q=>{v(q)},ze=q=>{q.preventDefault()},wt=q=>{if(a===null)return;const re=[...k],[$e]=re.splice(a,1);re.splice(q,0,$e),p(re),v(null),et({referenceImages:re})};t.useEffect(()=>{const q=Ee.current;q&&F&&requestAnimationFrame(()=>{q.style.height="auto";const re=Math.max(60,Math.min(q.scrollHeight,600));q.style.height=`${re}px`})},[ce,F]),t.useEffect(()=>{if(ce===s.config.prompt)return;const q=setTimeout(()=>{et({prompt:ce})},500);return()=>clearTimeout(q)},[ce]);const ts=t.useCallback(async q=>{if(!q){i([]);return}try{const re=await _e.soraCharacters.search(q,5);i(re.characters||[]),ne(0)}catch{i([])}},[]),ms=t.useCallback(q=>{const re=q.target.value,$e=q.target.selectionStart||0;if(be(re),ue.current)return;const qe=re.substring(0,$e).match(/@([^@\s#]*)$/);if(qe){const Pe=qe[1];V(Pe),G($e-Pe.length-1),y(!0),ts(Pe)}else y(!1),i([])},[ts]),Rs=t.useCallback(q=>{const re=ce.substring(0,M),$e=ce.substring(M+n.length+1),Ge=`@#${q.customName}#`,qe=re+Ge+$e;be(qe),y(!1),i([]),V(""),setTimeout(()=>{if(Ee.current){Ee.current.focus();const Pe=re.length+Ge.length;Ee.current.setSelectionRange(Pe,Pe)}},0)},[ce,M,n]),Is=t.useCallback(q=>{!U||c.length===0||(q.key==="ArrowDown"?(q.preventDefault(),ne(re=>re<c.length-1?re+1:re)):q.key==="ArrowUp"?(q.preventDefault(),ne(re=>re>0?re-1:re)):q.key==="Enter"&&c[O]?(q.preventDefault(),Rs(c[O])):q.key==="Escape"&&y(!1))},[U,c,O,Rs]),Ss=t.useCallback(async q=>{var qe;const re=/@#([^#]+)#/g,$e=[...q.matchAll(re)];if($e.length===0)return q;let Ge=q;for(const Pe of $e){const tt=Pe[1];try{const bt=await _e.soraCharacters.getByCustomName(tt);(qe=bt.character)!=null&&qe.characterName&&(Ge=Ge.replace(Pe[0],` ${bt.character.characterName} `))}catch{}}return Ge},[]),Gs=q=>{var $e,Ge,qe,Pe;te(q);const re=St.find(tt=>tt.id===q);if(re){const tt=($e=re.config.supportedRatios)!=null&&$e.length?re.config.supportedRatios:["16:9"],bt=(Ge=re.config.supportedResolutions)!=null&&Ge.length?re.config.supportedResolutions:["1080P"],yt=(qe=re.config.supportedGenerationTypes)!=null&&qe.length?re.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],E=(re.provider||"").toLowerCase(),H=(Pe=re.config.supportedDurations)!=null&&Pe.length?re.config.supportedDurations:E==="sora"?[10,15]:E==="minimaxi"?[6,10]:[10],ve=tt[0],je=bt[0],he=x(_||yt[0]),Ie=H[0];$(ve),g(je),z(he),C(Ie),et({modelId:q,modelName:re.name,ratio:ve,resolution:je,generationType:he,duration:Ie,acceptedInputs:Ke(he)})}},ks=t.useMemo(()=>{const q=x(_),re=k.length,qe=Q.filter(Pe=>Pe.target===l).filter(Pe=>{var yt,E,H,ve,je;const tt=ge(Pe.source),bt=tt==null?void 0:tt.type;if(!tt)return!1;if(bt==="upload"){const he=(H=(E=(yt=tt.data)==null?void 0:yt.config)==null?void 0:E.uploadedFiles)==null?void 0:H[0],Ie=((he==null?void 0:he.mimeType)||"").toLowerCase();return((he==null?void 0:he.type)||"").toUpperCase()==="VIDEO"||Ie.startsWith("video/")}if(bt==="assetSelector"){const he=(je=(ve=tt.data)==null?void 0:ve.config)==null?void 0:je.selectedAsset,Ie=((he==null?void 0:he.mimeType)||"").toLowerCase();return((he==null?void 0:he.type)||"").toUpperCase()==="VIDEO"||Ie.startsWith("video/")}return!!((bt||"").startsWith("aiVideo")||bt==="videoPreview")}).length;return le?q==="æ–‡ç”Ÿè§†é¢‘"?pe?!0:!!ce.trim():q==="é¦–å¸§"||q==="å°¾å¸§"?re>=1:q==="é¦–å°¾å¸§"?re>=2:q==="å‚è€ƒå›¾"?re>=1:q==="è§†é¢‘æ¢äºº"?qe>=1&&re>=1:q==="å¯¹å£å‹"||q==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[_,k.length,ce,W,Q,l,ge,x,pe]);t.useEffect(()=>{var re;const q=(re=s==null?void 0:s.config)==null?void 0:re.generatedVideoUrl;q&&$t(q,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const js=async q=>{let $e=0;const Ge=async()=>{try{$e++;const Pe=(await _e.tasks.getTaskStatus(q)).task;if(T(Pe.progress||0),Pe.status==="SUCCESS"||Pe.status==="COMPLETED"||Pe.status==="DONE"){T(100);const tt=Pe.resultUrl;r(!1),$t(tt,s.config.ratio||"16:9");try{await _e.tasks.markPreviewNodeCreated(q)}catch{}et({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),Y(""),f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>T(0),1e3);return}else if(Pe.status==="FAILURE"){r(!1),T(0),et({taskId:"",isGenerating:!1}),f.error(Pe.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Pe.status==="PROCESSING"||Pe.status==="PENDING")&&($e<600?setTimeout(Ge,1e3):(r(!1),T(0),et({taskId:"",isGenerating:!1}),f.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),T(0),et({taskId:"",isGenerating:!1}),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ge()},qs=async()=>{var $e,Ge,qe,Pe,tt,bt;if(x(_)==="æ–‡ç”Ÿè§†é¢‘"&&!ce.trim()){f.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const re=vt();et({referenceImages:re}),T(0);try{let yt=[],E;const H=re.length;if(re.length>0)try{for(const jt of re){let Ct=jt.url;!Ct.startsWith("data:")&&!Ct.startsWith("http")&&(Ct=`${kr}${Ct}`),Ct=Ct.replace(/^https?:\/\/localhost(?::\d+)?/i,kr);const Tt=await ur(Ct);yt.push(Tt)}}catch{f.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const ve=Q.filter(jt=>jt.target===l);if(x(_)==="å‚è€ƒå›¾"){const jt=new Map;for(const Ct of ve){const Tt=ge(Ct.source);if((Tt==null?void 0:Tt.type)==="assetSelector"){const Pt=($e=Tt.data.config)==null?void 0:$e.subjects;if(Pt&&Pt.length>0){for(const qt of Pt)if(!jt.has(qt.name)){const Bt=(qt.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${kr}${rs}`);jt.set(qt.name,Bt)}}}}if(jt.size>0){const Ct=Array.from(jt.entries());let Tt=0;const Pt=[];for(const[qt,Bt]of Ct){if(Tt>=7)break;const rs=7-Tt,gs=Bt.slice(0,Math.max(0,rs));gs.length>0&&(Pt.push({name:qt,images:gs}),Tt+=gs.length)}E=Pt,Ct.some(([,qt])=>qt.length>0)&&Tt<Ct.reduce((qt,[,Bt])=>qt+Bt.length,0)&&f.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const je=E&&E.length>0?E.reduce((jt,Ct)=>{var Tt;return jt+(((Tt=Ct.images)==null?void 0:Tt.length)||0)},0):H;let he=_;if(he==="é¦–å¸§"||he==="å°¾å¸§"){if(je!==1){f.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),T(0);return}}else if(he==="é¦–å°¾å¸§"){if(je===1)he="é¦–å¸§";else if(je!==2){f.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),T(0);return}E&&E.length>0?E=[{...E[0],images:E[0].images.slice(0,2)}]:yt=yt.slice(0,2)}else if(he==="å‚è€ƒå›¾"||he==="ä¸»ä½“å‚è€ƒ"){if(je<1){f.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),T(0);return}if(E&&E.length>0){if(E.reduce((Ct,Tt)=>{var Pt;return Ct+(((Pt=Tt.images)==null?void 0:Pt.length)||0)},0)>7){let Ct=7;E=E.map(Tt=>({...Tt,images:Tt.images.slice(0,Math.max(0,Ct-=Tt.images.length,Tt.images.length))})),Ct=7,E=E.map(Tt=>{const Pt=Tt.images.slice(0,Math.min(Tt.images.length,Ct));return Ct-=Pt.length,{...Tt,images:Pt}}).filter(Tt=>Tt.images.length>0),f.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else yt.length>7&&(yt=yt.slice(0,7),f.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}I==="dropImages"&&(yt=[],E=void 0),(x(_)==="é¦–å¸§"||x(_)==="å°¾å¸§")&&I==="useFirstImage"&&yt.length>=2&&(yt=[yt[0]]),x(_)==="é¦–å°¾å¸§"&&I==="useFirstTwoImages"&&yt.length>=3&&(yt=yt.slice(0,2));const Ie={modelId:le,ratio:R,duration:D,referenceImages:yt.length>0&&!E?yt:void 0,generationType:he,sourceNodeId:l,...E?{subjects:E}:{}},nt=x(he);let Ye=ce.trim();if(Ye&&Ye.includes("@#")&&(Ye=await Ss(Ye)),!oe&&Ye&&(Ye="No BGM. "+Ye),nt==="æ–‡ç”Ÿè§†é¢‘"){if(!Ye){f.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),T(0);return}Ie.prompt=Ye}else if(nt==="å‚è€ƒå›¾"){if(!Ye){f.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),T(0);return}Ie.prompt=Ye}else Ye&&(Ie.prompt=Ye);const Mt=await _e.tasks.createVideoTask(Ie),st=Mt.taskId,Be=Mt.creditsCharged||0,Dt=Mt.isFreeUsage,Xt=Mt.freeUsageRemaining??0;if(Y(st),et({prompt:ce,ratio:R,resolution:P,generationType:_,duration:D,modelId:le,taskId:st,isGenerating:!0}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),Dt)f.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Xt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),B();else if(Be>0){const{useAuthStore:jt}=await us(async()=>{const{useAuthStore:Tt}=await import("./index-CiJ2Nd2F.js").then(Pt=>Pt.f);return{useAuthStore:Tt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ct}=jt.getState();await Ct(),f.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Be} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),B()}else f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");js(st)}catch(yt){if(r(!1),T(0),((Ge=yt.response)==null?void 0:Ge.status)===403){const E=((Pe=(qe=yt.response)==null?void 0:qe.data)==null?void 0:Pe.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";f.error(E)}else{const E=((bt=(tt=yt.response)==null?void 0:tt.data)==null?void 0:bt.error)||yt.message||"æœªçŸ¥åŸå› ";f.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${E}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const q=x(_),re=vt(),$e=re.length;if((()=>{var Pe;const qe=Q.filter(tt=>tt.target===l);for(const tt of qe){const bt=ge(tt.source);if((bt==null?void 0:bt.type)==="assetSelector"){const yt=(Pe=bt.data.config)==null?void 0:Pe.subjects;if(yt&&yt.length>0)return!0}}return!1})()&&(q==="é¦–å¸§"||q==="å°¾å¸§"||q==="é¦–å°¾å¸§")){f.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&$e===0){f.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(q==="é¦–å°¾å¸§"&&$e===0){f.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(q==="å‚è€ƒå›¾"&&$e===0){f.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&$e>0&&!pe&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((q==="é¦–å¸§"||q==="å°¾å¸§")&&$e>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="é¦–å°¾å¸§"&&$e>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(q==="æ–‡ç”Ÿè§†é¢‘"&&!ce.trim()){f.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!le){f.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}p(re),et({referenceImages:re}),r(!0),T(0),await qs()},$t=(q,re)=>{const $e=ge(l);if(!$e||!q)return null;const Ge=re||R||"16:9",qe=Ae(),Pe=fe(),tt=qe.filter(Pt=>Pt.type==="videoPreview"&&Pe.some(qt=>qt.source===l&&qt.target===Pt.id)),bt=tt.find(Pt=>Pt.data.videoUrl===q);if(bt)return bt.id;const yt=1,E=400,H=(Pt,qt=300)=>{if(!Pt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Pt))return qt;const[Bt,rs]=Pt.split(":").map(gs=>parseFloat(gs));return!Bt||!rs?qt:Math.round(E*(rs/Bt))},ve=document.querySelector(`.react-flow__node[data-id="${l}"]`),je=ve==null?void 0:ve.getBoundingClientRect(),he=Math.round(((je==null?void 0:je.width)||400)/yt),Ie=100,nt=200,Ye=H(Ge,300),Mt=tt.length,st=$e.position.x+he+nt,Be=$e.position.y,Dt=st,Xt=Be+Mt*(Ye+Ie),jt=Date.now(),Ct={id:`preview-${l}-${jt}`,type:"videoPreview",position:{x:Dt,y:Xt},data:{videoUrl:q,width:E,ratio:Ge,workflowContext:$e.data.workflowContext,createdBy:$e.data.createdBy}};ae(Pt=>[...Pt,Ct]);const Tt={id:`edge-${l}-${Ct.id}`,source:l,target:Ct.id,targetHandle:`${Ct.id}-target`,type:"aurora"};return Z(Pt=>Pt.find(Bt=>Bt.source===l&&Bt.target===Ct.id)?Pt:[...Pt,Tt]),Ct.id},er=q=>{const re=q.target;if(re.tagName==="INPUT"||re.tagName==="TEXTAREA"||re.tagName==="SELECT"||re.tagName==="BUTTON"||re.closest("button")||re.closest("input")||re.closest("textarea")||re.closest("select"))return;const $e=!F;me($e),ae(Ge=>Ge.map(qe=>qe.id===l?{...qe,data:{...qe.data,isExpanded:$e}}:qe))};return e.jsxs("div",{onDoubleClick:er,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${l}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var E;const q=((E=ge(l))==null?void 0:E.type)||"",re=x(_),$e=re==="æ–‡ç”Ÿè§†é¢‘"||q==="aiVideo_t2v",Ge=q==="aiVideo_i2v_first"||q==="aiVideo_i2v_last"||re==="é¦–å¸§"||re==="å°¾å¸§",qe=q==="aiVideo_first_last"||re==="é¦–å°¾å¸§",Pe=q==="aiVideo_reference"||re==="å‚è€ƒå›¾",tt=Q.filter(H=>H.target===l),bt=tt.some(H=>{const ve=ge(H.source);return(ve==null?void 0:ve.type)==="agent"}),yt=tt.reduce((H,ve)=>{var Ie,nt,Ye,Mt;const je=ge(ve.source),he=(je==null?void 0:je.type)||"";if(he==="aiImage"||he==="imagePreview")return H+1;if(he==="upload"){const st=(Ye=(nt=(Ie=je==null?void 0:je.data)==null?void 0:Ie.config)==null?void 0:nt.uploadedFiles)==null?void 0:Ye[0],Be=((st==null?void 0:st.type)||"").toUpperCase(),Dt=((st==null?void 0:st.mimeType)||"").toLowerCase();return H+(Be==="IMAGE"||Dt.startsWith("image/")?1:0)}if(he==="assetSelector"){const st=((Mt=je==null?void 0:je.data)==null?void 0:Mt.config)||{};if(st.selectedAsset)return H+((st.selectedAsset.type||"").toUpperCase()==="IMAGE"||(st.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(st.subjects&&st.subjects.length>0)return H+((st.subjects[0].images||[]).length||0)}return H},0);return $e?pe||!bt:Ge?!(bt&&yt>=1):qe?!(bt&&yt>=2):Pe?!(bt&&yt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:m}),N==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{w(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{w(!1),f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{w(!1),await qs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[!pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(as,{value:le,onChange:q=>Gs(q),options:St.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:St.map(q=>({value:q.id,label:q.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-neutral-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ee,value:ce,onChange:ms,onKeyDown:Is,onCompositionStart:()=>{ue.current=!0},onCompositionEnd:q=>{ue.current=!1,ms(q)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),U&&c.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:c.map((q,re)=>e.jsxs("button",{type:"button",onMouseDown:$e=>{$e.preventDefault(),$e.stopPropagation(),Rs(q)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${re===O?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[q.avatarUrl?e.jsx("img",{src:q.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:q.customName}),e.jsx("div",{className:"text-[10px] text-neutral-500 dark:text-neutral-400 font-mono truncate",children:q.characterName})]})]},q.id))})]})]}),k.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",_==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:k.map((q,re)=>e.jsxs("div",{draggable:_==="é¦–å°¾å¸§",onDragStart:()=>It(re),onDragOver:ze,onDrop:()=>wt(re),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${_==="é¦–å°¾å¸§"?"cursor-move":""} ${a===re?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50`,children:[e.jsx("img",{src:`${q.url.startsWith("http")||q.url.startsWith("data:")?q.url:kr+q.url}`,alt:q.name,className:"w-full h-full object-cover"}),_==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:re===0?"é¦–":re===1?"å°¾":re+1})]},q.id))})]}),d&&!pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",se?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[D,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:Oe,max:Ue,step:"1",value:D,onChange:q=>{const re=parseInt(q.target.value,10);C(re),et({duration:re})},disabled:se,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-neutral-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-neutral-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #525252 ${Te}%, #3b0764 ${Te}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),d&&ct&&(pe||(((Vs=d==null?void 0:d.config.supportedRatios)==null?void 0:Vs.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),pe?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q="landscape",re=D===15?15:10,$e=`sora-video-${q}-${re}s`,Ge=we.find(Pe=>{var tt;return((tt=Pe.modelId)==null?void 0:tt.toLowerCase())===$e})||we[0],qe=(Ge==null?void 0:Ge.id)||"";te(qe),$("16:9"),et({modelId:qe,ratio:"16:9",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Landscape ${re}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${R==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const q="portrait",re=D===15?15:10,$e=`sora-video-${q}-${re}s`,Ge=we.find(Pe=>{var tt;return((tt=Pe.modelId)==null?void 0:tt.toLowerCase())===$e})||we[0],qe=(Ge==null?void 0:Ge.id)||"";te(qe),$("9:16"),et({modelId:qe,ratio:"9:16",modelName:(Ge==null?void 0:Ge.name)||`Sora Video (Portrait ${re}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${R==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(as,{value:R,onChange:q=>{$(q),et({ratio:q})},options:((d==null?void 0:d.config.supportedRatios)||[]).map(q=>{const[re,$e]=q.split(":");return{value:q,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[q]||`${re}:${$e}`}})})]}),d&&pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const q=R==="9:16"?"portrait":"landscape",re=`sora-video-${q}-10s`,$e=we.find(qe=>{var Pe;return((Pe=qe.modelId)==null?void 0:Pe.toLowerCase())===re})||we[0],Ge=($e==null?void 0:$e.id)||"";C(10),te(Ge),et({duration:10,modelId:Ge,modelName:($e==null?void 0:$e.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${D===10?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const q=R==="9:16"?"portrait":"landscape",re=`sora-video-${q}-15s`,$e=we.find(qe=>{var Pe;return((Pe=qe.modelId)==null?void 0:Pe.toLowerCase())===re})||we[0],Ge=($e==null?void 0:$e.id)||"";C(15),te(Ge),et({duration:15,modelId:Ge,modelName:($e==null?void 0:$e.name)||`Sora Video (${q==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${D===15?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),d&&pe&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>h(!oe),className:`nodrag relative w-10 h-5 rounded-full transition-all ${oe?"bg-gradient-to-r from-neutral-800 to-neutral-700":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${oe?"left-5":"left-0.5"}`})})]}),d&&!pe&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ve?"(æœªé…ç½®)":""]}),e.jsx(as,{value:P,onChange:q=>{g(q),et({resolution:q})},options:Ne.map(q=>({value:q,label:q})),className:Ve?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:W||!ks||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${W||!ks?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:W?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!b&&(J?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(de),"æ¬¡"]}):j!==null&&j>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[j,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:ce?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:ce})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ao=t.memo(Co),Fr="https://api.waule.ai",_o=({data:s,selected:S,id:l})=>{var C,W;const[F,me]=t.useState(!0),[T,xe]=t.useState(s.config.customName||""),[Y,ae]=t.useState(!1),[Z,ge]=t.useState(0),[Ae,fe]=t.useState(s.config.taskId||""),[Q,ee]=t.useState(null),{credits:Se,loading:ie}=Ns({nodeType:"sora_character"}),{setNodes:we,getNode:ce,setEdges:be}=Zt(),Ee=Js(),le=Os(),te=t.useCallback(r=>{var a;if(!r)return!1;const k=r.type||"",p=((a=r.data)==null?void 0:a.config)||{};if(k==="upload")return(p.uploadedFiles||p.files||[]).some(u=>(u.mimeType||u.type||"").toLowerCase().startsWith("video/"));if(k==="videoPreview")return!!p.url;if(k==="assetSelector"){const v=p.selectedAsset;return((v==null?void 0:v.mimeType)||"").toLowerCase().startsWith("video/")&&!!(v!=null&&v.url)}return k.startsWith("aiVideo")||k==="soraVideo"?!!p.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=Ee.filter(a=>a.target===l);if(r.length===0)return;const k=[],p=[];for(const a of r){const v=le.find(u=>u.id===a.source)||ce(a.source);te(v)?k.push(a.id):p.push(a.id)}k.length>1&&(p.push(...k.slice(1)),f.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),p.length>0&&(be(a=>a.filter(v=>!p.includes(v.id))),p.length>0&&k.length<=1&&r.some(v=>{const u=le.find(w=>w.id===v.source)||ce(v.source);return!te(u)})&&f.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ee,l,le,ce,be,te]);const R=t.useMemo(()=>Ee.filter(k=>k.target===l).map(k=>{var a;const p=le.find(v=>v.id===k.source);return(a=p==null?void 0:p.data)==null?void 0:a.config}),[Ee,l,le]),$=t.useMemo(()=>(s.models||[]).filter(k=>{var p;return k.type==="VIDEO_GENERATION"&&((p=k.provider)==null?void 0:p.toLowerCase())==="sora"}),[s.models]),P=((C=$.find(r=>{var k;return(k=r.modelId)==null?void 0:k.includes("landscape-10s")}))==null?void 0:C.id)||((W=$[0])==null?void 0:W.id)||"",g=t.useCallback(r=>{we(k=>k.map(p=>p.id===l?{...p,data:{...p.data,config:{...p.data.config,...r}}}:p))},[l,we]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!Y&&(ee({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),xe(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,Y]);const x=t.useMemo(()=>{var k;const r=Ee.filter(p=>p.target===l);for(const p of r){const a=le.find(w=>w.id===p.source)||ce(p.source);if(!a)continue;const v=a.type||"",u=((k=a.data)==null?void 0:k.config)||{};if(v==="upload"){const m=(u.uploadedFiles||u.files||[]).find(N=>(N.mimeType||N.type||"").toLowerCase().startsWith("video/"));if(m!=null&&m.url)return{url:m.url,thumbnail:m.thumbnail||m.url,name:m.name||m.originalName||"è§†é¢‘"}}if(v==="videoPreview"&&u.url)return{url:u.url,thumbnail:u.thumbnail||u.url,name:u.name||"è§†é¢‘"};if(v==="assetSelector"){const w=u.selectedAsset;if(((w==null?void 0:w.mimeType)||"").toLowerCase().startsWith("video/")&&(w!=null&&w.url))return{url:w.url,thumbnail:w.thumbnail||w.url,name:w.name||"è§†é¢‘"}}if((v.startsWith("aiVideo")||v==="soraVideo")&&u.generatedVideoUrl)return{url:u.generatedVideoUrl,thumbnail:u.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ee,l,le,R,ce]),_=!!x,z=async r=>{let p=0;const a=async()=>{try{p++;const u=(await _e.tasks.getTaskStatus(r)).task;if(ge(u.progress||0),u.status==="SUCCESS"||u.status==="COMPLETED"||u.status==="DONE"){ae(!1),ge(100);const w=u.metadata||{},m=w.characterName||"",N=w.avatarUrl||u.resultUrl||"";if(!m){f.error("æœªèƒ½è·å–è§’è‰²åç§°"),g({taskId:""}),fe("");return}try{const U=(await _e.soraCharacters.create({customName:T||m,characterName:m,avatarUrl:N,sourceVideoUrl:(x==null?void 0:x.url)||void 0})).character;ee({id:U.id,customName:U.customName,characterName:U.characterName,avatarUrl:U.avatarUrl}),g({customName:U.customName,characterName:U.characterName,avatarUrl:U.avatarUrl,taskId:""}),f.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${U.customName}`)}catch(I){ee({id:"",customName:T||m,characterName:m,avatarUrl:N}),f.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${I.message}`)}fe(""),setTimeout(()=>ge(0),1e3);return}else if(u.status==="FAILURE"){ae(!1),ge(0),g({taskId:""}),f.error(u.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(u.status==="PROCESSING"||u.status==="PENDING")&&(p<600?setTimeout(a,1e3):(ae(!1),ge(0),g({taskId:""}),f.error("åˆ›å»ºè¶…æ—¶")))}catch{ae(!1),ge(0),g({taskId:""}),f.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};a()},D=async()=>{var k,p,a,v,u;if(!x){f.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!T.trim()){f.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!P){f.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=x.url;if(!r){f.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const w=await _e.soraCharacters.getByCustomName(T.trim());if(w!=null&&w.character){f.error(`è‡ªå®šä¹‰åç§°"${T.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}ae(!0),ge(5),ee(null);try{const w=await _e.tasks.createVideoTask({modelId:P,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:l,metadata:{isCharacterCreation:!0,customName:T.trim(),referenceType:"video",nodeType:"sora_character"}}),m=w.taskId,N=w.creditsCharged||0;if(fe(m),g({customName:T.trim(),taskId:m}),N>0)try{const{useAuthStore:I}=await us(async()=>{const{useAuthStore:y}=await import("./index-CiJ2Nd2F.js").then(c=>c.f);return{useAuthStore:y}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:U}=I.getState();await U(),f.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${N} ç§¯åˆ†ï¼‰`)}catch{f.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else f.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");z(m)}catch(w){if(ae(!1),ge(0),((k=w.response)==null?void 0:k.status)===403){const m=((a=(p=w.response)==null?void 0:p.data)==null?void 0:a.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";f.error(m)}else f.error(`æäº¤å¤±è´¥: ${((u=(v=w.response)==null?void 0:v.data)==null?void 0:u.error)||w.message}`)}};return t.useEffect(()=>{Ae&&!Y&&(ae(!0),z(Ae))},[]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl rounded-t-2xl",onClick:()=>me(!F),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${F?"rotate-180":""}`,children:"expand_more"})]})]}),F&&e.jsxs("div",{className:"p-4 space-y-3",children:[x&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${x.url.startsWith("http")||x.url.startsWith("data:")?x.url:Fr+x.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:x.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:T,onChange:r=>xe(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",disabled:Y})]}),Q&&!Y&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[Q.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("img",{src:Q.avatarUrl.startsWith("http")?Q.avatarUrl:`${Fr}${Q.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:Q.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:Q.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),Y&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[Z,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all duration-300",style:{width:`${Z}%`}})})]}),e.jsx("button",{onClick:D,disabled:Y||!_||!T.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${Y||!_||!T.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95"}`,children:Y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ie&&Se!==null&&Se>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[Se,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},To=t.memo(_o),Uo=({data:s,id:S,selected:l})=>{const{setNodes:F,getNode:me}=Zt(),[T,xe]=t.useState(s.config.modelId||""),[Y,ae]=t.useState(s.config.voiceId||""),[Z,ge]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Ae,fe]=t.useState(s.config.status||""),[Q,ee]=t.useState(!1),[Se,ie]=t.useState([]),[we]=t.useState(void 0),[ce]=t.useState("mp3"),[be]=t.useState(void 0),[Ee]=t.useState(void 0),[le]=t.useState(void 0),[te]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!T&&xe(s.config.modelId)},[s.config.modelId,T]),t.useEffect(()=>{!Y&&s.config.voiceId&&ae(String(s.config.voiceId))},[s.config.voiceId,Y]),t.useEffect(()=>{if(!T){const x=(s.models||[]).filter(_=>_.type==="AUDIO_SYNTHESIS"&&_.isActive)[0];x&&(xe(x.id),$({modelId:x.id}))}},[s.models,T]),t.useEffect(()=>{R()},[]);const R=async()=>{try{const g=await _e.get("/ai/audio/voices"),x=(g==null?void 0:g.data)??g;ie(Array.isArray(x)?x:[])}catch{}},$=g=>{me(S)&&F(_=>_.map(z=>z.id===S?{...z,data:{...z.data,config:{...z.data.config,...g}}}:z))},P=async()=>{var z,D,C,W;const g=(Y||s.config.voiceId||"").trim(),x=(Z||"").trim();if(!g||!x){f.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let _=T;if(!_){const r=(s.models||[]).filter(k=>k.type==="AUDIO_SYNTHESIS"&&k.isActive);if(r[0])_=r[0].id,xe(_),$({modelId:_});else{f.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}ee(!0);try{if(Ae!=="OK"){let a=0,v=!1;for(;a<12;){a++;try{const u=await _e.ai.audio.queryVoice({voiceId:g,modelId:_}),w=((z=u.data)==null?void 0:z.status)||u.status;if(fe(w),$({status:w}),w==="OK"){v=!0;break}if(w==="UNDEPLOYED")break}catch{}await new Promise(u=>setTimeout(u,2500))}if(!v){f.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),ee(!1);return}}const r=await _e.ai.audio.synthesize({modelId:_,voiceId:g,text:x,format:ce,sampleRate:we,volume:Ee,rate:be,pitch:le,output_format:te}),k=((D=r.data)==null?void 0:D.url)||r.url;try{const p=k&&k.startsWith("http")?k:`https://api.waule.ai${k}`;let a;p?a=await _e.assets.proxyDownload(p):a=await(await fetch(k,{mode:"cors"})).arrayBuffer();const v=URL.createObjectURL(new Blob([a],{type:ce==="wav"?"audio/wav":"audio/mpeg"}));$({outputUrl:v})}catch{$({outputUrl:k})}f.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const k=((W=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:W.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(k)?f.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(k)?f.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):f.error(k)}ee(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:T,onChange:g=>{xe(g),$({modelId:g})},options:(s.models||[]).filter(g=>g.type==="AUDIO_SYNTHESIS"&&g.isActive).map(g=>({value:g.id,label:g.name}))})]}),Se.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",Se.length,")"]}),e.jsx(as,{value:Y||"",onChange:g=>{ae(g),$({voiceId:g})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Se.map(g=>({value:g.voiceId,label:g.prefix||g.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:Y,onChange:g=>{const x=g.target.value;ae(x),$({voiceId:x})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:Z,onChange:g=>{ge(g.target.value),$({text:g.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:P,disabled:Q||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Q?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Q?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ro=t.memo(Uo),$o=({data:s,id:S,selected:l})=>{const{setNodes:F,setEdges:me,getNode:T}=Zt(),[xe,Y]=t.useState(s.config.modelId||""),[ae,Z]=t.useState(s.config.voiceId||""),[ge,Ae]=t.useState(s.config.voiceName||""),[fe,Q]=t.useState(s.config.cloneAudioUrl||""),[ee,Se]=t.useState(s.config.promptAudioUrl||""),[ie,we]=t.useState(s.config.promptText||""),[ce,be]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ee,le]=t.useState(!1);t.useEffect(()=>{const _=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!ae||!ae.startsWith("Waule")&&!ae.startsWith("Aivider")||ae.startsWith("minimax-")){const z=_();Z(z),P({voiceId:z})}},[ae]);const te=Xs(_=>_.edges.filter(z=>z.target===S)),R=Os(),$=t.useRef("");t.useEffect(()=>{if(!xe){const z=(s.models||[]).filter(D=>{if(D.type!=="AUDIO_SYNTHESIS"||!D.isActive)return!1;const C=String(D.provider||"").toLowerCase();return C.includes("minimaxi")||C.includes("hailuo")||C.includes("æµ·èº")})[0];z&&(Y(z.id),P({modelId:z.id}))}},[s.models,xe]),t.useEffect(()=>{try{const _=te.map(C=>`${C.id}-${C.source}-${C.targetHandle||""}`).sort().join(",");if(_===$.current)return;$.current=_;let z="",D="";for(const C of te){const W=T(C.source);if(!W)continue;const r=W.data||{},k=String(W.type||"").toLowerCase(),a=(()=>{var v,u;if(k==="upload"){const w=(((v=r.config)==null?void 0:v.uploadedFiles)||[]).find(m=>{const N=((m==null?void 0:m.type)||"").toUpperCase(),I=((m==null?void 0:m.mimeType)||"").toLowerCase();return N==="AUDIO"||I.startsWith("audio/")});return w==null?void 0:w.url}if(k==="assetSelector"){const w=(u=r.config)==null?void 0:u.selectedAsset,m=((w==null?void 0:w.type)||"").toUpperCase(),N=((w==null?void 0:w.mimeType)||"").toLowerCase();if(m==="AUDIO"||N.startsWith("audio/"))return w==null?void 0:w.url}return null})();a&&(C.targetHandle===`${S}-target-clone`&&(z=a),C.targetHandle===`${S}-target-prompt`&&(D=a))}z!==fe&&(Q(z),P({cloneAudioUrl:z})),D!==ee&&(Se(D),P({promptAudioUrl:D}))}catch{}},[te,R,T,S,fe,ee]);const P=_=>{F(z=>z.map(D=>D.id===S?{...D,data:{...D.data,config:{...D.data.config,..._}}}:D))},g=async()=>{var _,z;if(!ae||!ge){f.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await _e.ai.audio.voices.add({voiceId:ae,prefix:ge}),f.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(D){const C=((z=(_=D==null?void 0:D.response)==null?void 0:_.data)==null?void 0:z.message)||(D==null?void 0:D.message)||"ä¿å­˜å¤±è´¥";f.error(C)}},x=async()=>{var _,z,D;if(!xe||!ge||!fe){f.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}le(!0),f.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const W=(s.models||[]).find(w=>w.id===xe),r=(W==null?void 0:W.modelId)||"speech-2.6-hd";let k=fe;k.startsWith("http");const p=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;Z(p),P({voiceId:p});const a=await _e.ai.audio.createVoice({modelId:xe,targetModel:r,prefix:ge,url:k,promptUrl:ee||void 0,promptText:ie||void 0,voiceId:p,previewText:ce||void 0}),v=(a==null?void 0:a.data)||a,u=v==null?void 0:v.sampleUrl;if(u){P({sampleUrl:u,status:"OK",voiceName:ge}),f.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const w=T(S);if(w){const m=`audioPreview-${Date.now()}`,N={id:m,type:"audioPreview",position:{x:w.position.x+450,y:w.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:u,config:{audioUrl:u,title:`${ge} - è¯•å¬`},models:s.models,createdBy:(_=w.data)==null?void 0:_.createdBy}};F(U=>[...U,N]);const I={id:`e-${S}-source-${m}-target`,source:S,sourceHandle:`${S}-source`,target:m,targetHandle:`${m}-target`,type:"aurora"};me(U=>[...U,I])}}else P({status:"OK",voiceName:ge}),f.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(C){const W=((D=(z=C==null?void 0:C.response)==null?void 0:z.data)==null?void 0:D.message)||(C==null?void 0:C.message)||"åˆ›å»ºå¤±è´¥";f.error(W)}le(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:xe,onChange:_=>{Y(_),P({modelId:_})},options:(s.models||[]).filter(_=>{if(_.type!=="AUDIO_SYNTHESIS"||!_.isActive)return!1;if(Array.isArray(_.capabilities))return _.capabilities.some(D=>D.capability==="éŸ³è‰²å…‹éš†"&&D.supported);const z=String(_.provider||"").toLowerCase();return z.includes("minimaxi")||z.includes("hailuo")||z.includes("æµ·èº")}).map(_=>({value:_.id,label:_.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:ge,onChange:_=>{Ae(_.target.value),P({voiceName:_.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:_=>_.stopPropagation()}),e.jsx("button",{onClick:g,disabled:!ae||!ge,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!ae||!ge?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:fe?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:fe?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:ee?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:ee?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ie,onChange:_=>{we(_.target.value),P({promptText:_.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:ce,onChange:_=>{be(_.target.value),P({previewText:_.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:_=>_.stopPropagation()})]}),e.jsx("button",{onClick:x,disabled:Ee||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ee||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ee?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Mo=t.memo($o),zr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Do=({data:s,id:S,selected:l})=>{const{setNodes:F,getNode:me,setEdges:T}=Zt(),[xe,Y]=t.useState(s.config.modelId||""),[ae,Z]=t.useState(s.config.voiceId||""),[ge,Ae]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),fe=t.useRef(null),[Q,ee]=t.useState("zh"),Se=t.useRef(null),ie=t.useRef(null),we=t.useRef(null),ce=t.useRef(null),be=t.useRef(null),[Ee,le]=t.useState([]),te=async()=>{try{const p=await _e.ai.audio.voices.list(),a=(p==null?void 0:p.data)??p;le(Array.isArray(a)?a:[])}catch{}},R=async()=>{try{const p=window.AudioContext||window.webkitAudioContext;ce.current||(ce.current=new p);const a=ce.current;a.state==="suspended"&&await a.resume()}catch{}},[$,P]=t.useState(!1),[g]=t.useState(""),[x]=t.useState(void 0),[_]=t.useState("mp3"),[z]=t.useState(void 0),[D]=t.useState(void 0),[C]=t.useState(void 0),[W]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!xe&&Y(s.config.modelId)},[s.config.modelId,xe]),t.useEffect(()=>{!ae&&s.config.voiceId&&Z(String(s.config.voiceId))},[s.config.voiceId,ae]),t.useEffect(()=>{if(!xe){const a=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive)[0];a&&(Y(a.id),r({modelId:a.id}))}},[s.models,xe]),t.useEffect(()=>{te()},[]),t.useEffect(()=>{Q==="custom"&&te()},[Q]),t.useEffect(()=>{const p=fe.current;p&&(p.style.height="auto",p.style.height=`${p.scrollHeight}px`)},[ge]);const r=p=>{me(S)&&F(v=>v.map(u=>u.id===S?{...u,data:{...u.data,config:{...u.data.config,...p}}}:u))},k=async(p=!1)=>{var w,m,N,I,U;let a=(ae||s.config.voiceId||"").trim();if(p&&!a)if(Q==="custom"){const y=Ee[0];y&&(a=String(y.voiceId),Z(a),r({voiceId:a}))}else{const y=zr.find(c=>{const i=c.label;return Q==="zh"?i.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):Q==="yue"?i.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):Q==="en"?i.startsWith("è‹±æ–‡ "):Q==="ja"?i.startsWith("æ—¥æ–‡ "):Q==="ko"?i.startsWith("éŸ©æ–‡ "):!0});y&&(a=y.id,Z(a),r({voiceId:a}))}const v=p?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(ge||"").trim();if(!a||!v){f.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let u=xe;if(!u){const y=(s.models||[]).filter(c=>c.type==="AUDIO_SYNTHESIS"&&c.isActive);if(y[0])u=y[0].id,Y(u),r({modelId:u});else{f.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}P(!0);try{p&&await R();const y={};if(g)try{y.voice_modify={emotion:g}}catch{}const c=await _e.ai.audio.synthesize({modelId:u,voiceId:a,text:v,format:_,sampleRate:x,volume:D,rate:z,pitch:C,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...y}),i=((w=c==null?void 0:c.data)==null?void 0:w.url)||(c==null?void 0:c.url),n=window.location.origin,M=(b=>{if(!b)return"";try{if(b.startsWith("http://localhost:3000")||b.startsWith("http://127.0.0.1:3000")){const J=new URL(b).pathname;return`${n}${J}`}return b.startsWith("http")?b:b.startsWith("/")?`${n}${b}`:`${n}/${b}`}catch{return b}})(i);let G;const O=b=>{if(b.length>=12){if(b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69)return"audio/wav";if(b[0]===73&&b[1]===68&&b[2]===51||b[0]===255&&(b[1]&224)===224)return"audio/mpeg"}return _==="wav"?"audio/wav":"audio/mpeg"},ne=b=>b.length>=12&&b[4]===102&&b[5]===116&&b[6]===121&&b[7]===112,ue=b=>b.length>=4&&b[0]===79&&b[1]===103&&b[2]===103&&b[3]===83,oe=b=>b.length>=4&&b[0]===102&&b[1]===76&&b[2]===97&&b[3]===67,h=new Uint8Array(G||new ArrayBuffer(0));let d=O(h);(!d||d==="application/octet-stream")&&(ne(h)?d="audio/mp4":ue(h)?d="audio/ogg":oe(h)&&(d="audio/flac"));let j;if(p){if(be.current){try{be.current.stop()}catch{}be.current.disconnect(),be.current=null}const b=ie.current||new Audio;b.preload="auto",b.autoplay=!0,b.playsInline=!0,b.crossOrigin="anonymous",ie.current=b;let J=!1;const de=(B,pe,Ce=1500)=>new Promise(Ne=>{let Oe=!1;const Ue=()=>{Oe||(Oe=!0,Te(),Ne(!0))},Re=()=>{Oe||(Oe=!0,Te(),Ne(!1))},Te=()=>{B.removeEventListener(pe,Ue),B.removeEventListener("error",Re)};B.addEventListener(pe,Ue),B.addEventListener("error",Re),setTimeout(()=>{Re()},Ce)});try{const B=Ne=>{const Oe=(Ne||"").replace(/\s+/g,""),Ue=new Uint8Array(Math.floor(Oe.length/2));for(let Re=0;Re<Ue.length;Re++)Ue[Re]=parseInt(Oe.substr(Re*2,2),16);return Ue},pe=((m=c==null?void 0:c.data)==null?void 0:m.hex)||(c==null?void 0:c.hex),Ce=pe?B(String(pe)).buffer:void 0;if(Ce&&Ce.byteLength>0){const Ne=new Uint8Array(Ce),Oe=O(Ne),Ue=new Blob([Ce],{type:Oe}),Re=URL.createObjectURL(Ue);if(we.current)try{URL.revokeObjectURL(we.current)}catch{}if(we.current=Re,b.src=Re,b.load(),!await de(b,"canplay"))throw new Error("blob not ready");await b.play(),J=!0}else throw new Error("no hex")}catch{J=!1}if(!J){try{const B=Ne=>{const Oe=(Ne||"").replace(/\s+/g,""),Ue=new Uint8Array(Math.floor(Oe.length/2));for(let Re=0;Re<Ue.length;Re++)Ue[Re]=parseInt(Oe.substr(Re*2,2),16);return Ue},pe=((N=c==null?void 0:c.data)==null?void 0:N.hex)||(c==null?void 0:c.hex),Ce=pe?B(String(pe)).buffer:void 0;if(!Ce||Ce.byteLength===0){const Ne=await _e.assets.proxyDownload(M);if(!Ne||Ne.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const Oe=new Uint8Array(Ne),Ue=O(Oe),Re=new Blob([Ne],{type:Ue}),Te=URL.createObjectURL(Re);if(we.current)try{URL.revokeObjectURL(we.current)}catch{}if(we.current=Te,b.src=Te,b.load(),!await de(b,"canplay"))throw new Error("blob not ready");await b.play(),J=!0}else{const Ne=new Uint8Array(Ce),Oe=O(Ne),Ue=new Blob([Ce],{type:Oe}),Re=URL.createObjectURL(Ue);if(we.current)try{URL.revokeObjectURL(we.current)}catch{}if(we.current=Re,b.src=Re,b.load(),!await de(b,"canplay"))throw new Error("blob not ready");await b.play(),J=!0}}catch{}if(!J)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const b=await _e.assets.proxyDownload(M),J=new Uint8Array(b),de=O(J);j=URL.createObjectURL(new Blob([b],{type:de}))}catch{}if(!p&&j){if(Se.current)try{URL.revokeObjectURL(Se.current)}catch{}Se.current=j;const b=M||j;r({outputUrl:b});try{const J=me(S);if(J){const B=document.querySelector(`.react-flow__node[data-id="${J.id}"]`),pe=Math.round((B==null?void 0:B.getBoundingClientRect().width)||420),Ce=J.position.x+pe+160,Ne=`audio-preview-${Date.now()}`;F(Oe=>{var se;const Ue=Oe.filter(Ve=>{var et;return Ve.type==="audioPreview"&&((et=Ve.data)==null?void 0:et.sourceNodeId)===S}),Re=J.position.y,Te=Ue.length>0?Math.max(...Ue.map(Ve=>{var et;return((et=Ve.position)==null?void 0:et.y)||Re}))+120:Re;return[...Oe,{id:Ne,type:"audioPreview",position:{x:Ce,y:Te},data:{audioUrl:b,sourceNodeId:S,createdBy:(se=J.data)==null?void 0:se.createdBy}}]}),T(Oe=>[...Oe,{id:`${S}-${Ne}`,source:S,target:Ne}])}}catch{}}p&&ie.current&&!ie.current.paused?f.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!p&&j&&f.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(y){const c=((U=(I=y==null?void 0:y.response)==null?void 0:I.data)==null?void 0:U.message)||(y==null?void 0:y.message)||(p?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");f.error(c)}P(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:xe,onChange:p=>{Y(p),r({modelId:p})},options:(s.models||[]).filter(p=>p.type==="AUDIO_SYNTHESIS"&&p.isActive).map(p=>({value:p.id,label:p.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(as,{value:Q,onChange:p=>{ee(p),p==="custom"&&te()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(as,{value:ae,onChange:p=>{Z(p),r({voiceId:p})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Q==="custom"?Ee.map(p=>({value:p.voiceId,label:p.prefix||p.voiceId})):zr.filter(p=>{const a=p.label;return Q==="zh"?a.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):Q==="yue"?a.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):Q==="en"?a.startsWith("è‹±æ–‡ "):Q==="ja"?a.startsWith("æ—¥æ–‡ "):Q==="ko"?a.startsWith("éŸ©æ–‡ "):!0}).map(p=>({value:p.id,label:p.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>k(!0),disabled:$,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${$?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":""}`,style:$?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:fe,value:ge,onChange:p=>{Ae(p.target.value),r({text:p.target.value})},onMouseDown:p=>p.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>k(!1),disabled:$||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${$||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"border-transparent dark:border-white/10"}`,style:$||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:$?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Lo=t.memo(Do),Po=t.memo(({id:s,sourceX:S,sourceY:l,targetX:F,targetY:me,sourcePosition:T,targetPosition:xe,selected:Y,markerEnd:ae})=>{const[Z]=ya({sourceX:S,sourceY:l,targetX:F,targetY:me,sourcePosition:T,targetPosition:xe});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#404040",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#525252",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:Z,fill:"none",stroke:Y?"#525252":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:ae}),e.jsx("path",{d:Z,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:ae}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:Z,calcMode:"linear"})}),e.jsx("path",{d:Z,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Oo=({data:s,id:S})=>{const l=t.useRef(null),{getNode:F,setNodes:me}=Zt(),[T,xe]=t.useState(!1),[Y,ae]=t.useState([]),[Z,ge]=t.useState(""),[Ae,fe]=t.useState("ALL"),[Q,ee]=t.useState(""),[Se,ie]=t.useState(!1),we=t.useMemo(()=>window.location.origin,[]),ce=t.useMemo(()=>{var $;const R=s.audioUrl||"";if(R.startsWith("blob:")){const P=s.sourceNodeId?F(s.sourceNodeId):null,g=(($=P==null?void 0:P.data)==null?void 0:$.outputUrl)||"";return g.startsWith("http")?g:g.startsWith("/")?`${we}${g}`:R}return R.startsWith("http")?`${we}/api/assets/proxy-stream?url=${encodeURIComponent(R)}`:R.startsWith("/")?`${we}${R}`:R},[s.audioUrl,s.sourceNodeId,we]);t.useEffect(()=>{const R=l.current;R&&(R.preload="auto",R.playsInline=!0,R.crossOrigin="anonymous",R.load())},[ce]),t.useEffect(()=>{T&&(be(),setTimeout(()=>{Ee()},100))},[T]);const be=async()=>{try{const R=Ae==="ALL"?void 0:{category:Ae},P=(await _e.assetLibraries.getAll(R)).data||[];ae(P);const g=Ae==="ALL"?P:P.filter(x=>(x.category||"OTHER")===Ae);if(g.length>0){const x=g.find(_=>_.id===Z);ge(x?x.id:g[0].id)}else ge("")}catch{f.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ee=()=>{const R=window.__workflowContext;if(!R||!R.project||!R.nodeGroups){f.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const $=Hs(S,R.nodeGroups);if(!$&&R.nodeGroups.length>0){const g=R.nodeGroups[0],x=Ts({project:R.project,episode:R.episode,nodeGroup:g,assetType:"audio"});x?(ee(x),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${x}`)):f.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const P=Ts({project:R.project,episode:R.episode,nodeGroup:$,assetType:"audio"});P?(ee(P),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${P}`)):f.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},le=async()=>{var R,$;if(!Z){f.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Q.trim()){f.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ie(!0),await _e.assetLibraries.addFromUrl(Z,s.audioUrl,Q.trim());const P=window.__workflowContext;if(P&&P.project&&P.nodeGroups){const g=Hs(S,P.nodeGroups)||P.nodeGroups[0];g&&Ts({project:P.project,episode:P.episode,nodeGroup:g,nodeId:S,assetType:"audio",preview:!1})}f.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),xe(!1),ee("");try{me(g=>g.map(x=>x.id===S?{...x,data:{...x.data,addedToLibrary:!0}}:x))}catch{}try{const g=new CustomEvent("asset-library-updated",{detail:{libraryId:Z}});window.dispatchEvent(g)}catch{}}catch(P){f.error((($=(R=P.response)==null?void 0:R.data)==null?void 0:$.message)||"æ·»åŠ å¤±è´¥")}finally{ie(!1)}},te=async()=>{var P;let R=`audio-${Date.now()}.mp3`;const $=window.__workflowContext;if($&&$.project&&$.nodeGroups){const g=Hs(S,$.nodeGroups)||$.nodeGroups[0];if(g){const x=Ts({project:$.project,episode:$.episode,nodeGroup:g,assetType:"audio",preview:!0});if(x&&(R=x,!R.includes("."))){const _=((P=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:P[0])||".mp3";R+=_}}}try{f.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const g=await fetch(s.audioUrl);if(!g.ok)throw new Error(`ä¸‹è½½å¤±è´¥: ${g.status}`);const x=await g.blob(),_=window.URL.createObjectURL(x),z=document.createElement("a");z.href=_,z.download=R,document.body.appendChild(z),z.click(),document.body.removeChild(z),setTimeout(()=>{window.URL.revokeObjectURL(_)},100),f.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${R}`)}catch(g){f.error(`ä¸‹è½½å¤±è´¥: ${g instanceof Error?g.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:l,controls:!0,src:ce,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{xe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:te,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),T&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>xe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Q,onChange:R=>ee(R.target.value),onMouseDown:R=>R.stopPropagation(),onTouchStart:R=>R.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const R=Ae==="ALL"?Y:Y.filter($=>($.category||"OTHER")===Ae);return R.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Ae==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Z,onChange:$=>ge($.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:R.map($=>e.jsxs("option",{value:$.id,children:[$.name," (",$._count.assets," ä¸ªèµ„äº§)"]},$.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(R=>e.jsx("button",{type:"button",onClick:()=>{fe(R);const $=Y.filter(P=>(P.category||"OTHER")===R);ge($.length>0?$[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Ae===R?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:R==="ROLE"?"person":R==="SCENE"?"landscape":R==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:R==="ROLE"?"è§’è‰²åº“":R==="SCENE"?"åœºæ™¯åº“":R==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},R))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>xe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:le,disabled:Se||Y.length===0||!Q.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:Se?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Go=t.memo(Oo),Vo=({data:s,id:S,selected:l})=>{const{setNodes:F,getNode:me,setEdges:T}=Zt(),[xe,Y]=t.useState(s.config.modelId||""),[ae,Z]=t.useState(s.config.prompt||""),[ge,Ae]=t.useState(s.config.previewText||""),[fe,Q]=t.useState(s.config.voiceId||""),[ee,Se]=t.useState(!1),ie=t.useRef(null),we=t.useRef(null),ce=t.useRef(null),be=t.useRef(null),[Ee,le]=t.useState([]);t.useEffect(()=>{if(!xe){const _=(s.models||[]).filter(z=>z.type==="AUDIO_SYNTHESIS"&&z.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(z.provider||"").toLowerCase())&&(Array.isArray(z.capabilities)?z.capabilities.some(D=>D.capability==="éŸ³è‰²è®¾è®¡"&&D.supported):!0))[0];_&&(Y(_.id),te({modelId:_.id}))}},[s.models,xe]);const te=x=>{me(S)&&F(z=>z.map(D=>D.id===S?{...D,data:{...D.data,config:{...D.data.config,...x}}}:D))};t.useEffect(()=>{(async()=>{try{const x=await _e.ai.audio.voices.list(),_=(x==null?void 0:x.data)??x;le(Array.isArray(_)?_:[])}catch{}})()},[]);const R=x=>{x&&(x.style.height="auto",x.style.height=`${x.scrollHeight}px`)};t.useEffect(()=>{R(we.current)},[ae]),t.useEffect(()=>{R(ce.current)},[ge]);const $=async x=>{if(!x)return!1;try{const _=(x||"").replace(/\s+/g,""),z=new Uint8Array(Math.floor(_.length/2));for(let k=0;k<z.length;k++)z[k]=parseInt(_.substr(k*2,2),16);const D=(()=>{const k=z;return k.length>=12&&k[0]===82&&k[1]===73&&k[2]===70&&k[3]===70&&k[8]===87&&k[9]===65&&k[10]===86&&k[11]===69?"audio/wav":(k.length>=3&&k[0]===73&&k[1]===68&&k[2]===51||k.length>=2&&k[0]===255&&(k[1]&224)===224,"audio/mpeg")})(),C=new Blob([z.buffer],{type:D}),W=URL.createObjectURL(C);if(be.current)try{URL.revokeObjectURL(be.current)}catch{}be.current=W;const r=ie.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=W,ie.current=r,await r.play(),!0}catch{return!1}},P=async()=>{var _,z,D,C,W;if(!ae.trim()){f.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let x=xe;if(!x){const r=(s.models||[]).filter(k=>k.type==="AUDIO_SYNTHESIS"&&k.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(k.provider||"").toLowerCase()));if(r[0])x=r[0].id,Y(x),te({modelId:x});else{f.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}Se(!0);try{const r=await _e.ai.audio.design({modelId:x,prompt:ae,preview_text:ge,voice_id:fe||void 0,aigc_watermark:!1}),k=((_=r==null?void 0:r.data)==null?void 0:_.voice_id)||(r==null?void 0:r.voice_id),p=((z=r==null?void 0:r.data)==null?void 0:z.trial_audio)||(r==null?void 0:r.trial_audio)||((D=r==null?void 0:r.data)==null?void 0:D.hex)||(r==null?void 0:r.hex);k&&(Q(String(k)),te({voiceId:String(k)})),p&&typeof p=="string"?(te({trialHex:p}),await $(p),f.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):f.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const a=me(S);if(a){const u=document.querySelector(`.react-flow__node[data-id="${a.id}"]`),w=Math.round((u==null?void 0:u.getBoundingClientRect().width)||420),m=a.position.x+w+160,N=`audio-preview-${Date.now()}`;F(I=>{var U;return[...I,{id:N,type:"audioPreview",position:{x:m,y:a.position.y},data:{audioUrl:be.current||"",sourceNodeId:S,createdBy:(U=a.data)==null?void 0:U.createdBy}}]}),T(I=>[...I,{id:`${S}-${N}`,source:S,target:N}])}}catch{}}catch(r){const k=((W=(C=r==null?void 0:r.response)==null?void 0:C.data)==null?void 0:W.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";f.error(k)}Se(!1)},g=async()=>{var _,z;const x=(fe||"").trim();if(!x){f.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ee.some(v=>String(v.voiceId)===String(x))){f.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const W=(s.models||[]).find(v=>v.id===xe),r=(W==null?void 0:W.modelId)||"cosyvoice-v2",k=(ae||x).slice(0,40);await _e.ai.audio.voices.add({voiceId:x,prefix:k,targetModel:r,provider:String((W==null?void 0:W.provider)||"")});const p=await _e.ai.audio.voices.list(),a=(p==null?void 0:p.data)??p;le(Array.isArray(a)?a:[]),f.success("å·²ä¿å­˜éŸ³è‰²")}catch(D){const C=((z=(_=D==null?void 0:D.response)==null?void 0:_.data)==null?void 0:z.message)||(D==null?void 0:D.message)||"ä¿å­˜å¤±è´¥";f.error(C)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(as,{value:xe,onChange:x=>{Y(x),te({modelId:x})},options:(s.models||[]).filter(x=>x.type!=="AUDIO_SYNTHESIS"||!x.isActive?!1:Array.isArray(x.capabilities)?x.capabilities.some(_=>_.capability==="éŸ³è‰²è®¾è®¡"&&_.supported):["minimaxi","hailuo","æµ·èº"].includes(String(x.provider||"").toLowerCase())).map(x=>({value:x.id,label:x.name}))})]}),Ee.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(as,{value:fe||"",onChange:x=>{Q(x),te({voiceId:x})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ee.map(x=>({value:x.voiceId,label:x.prefix||x.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:fe,onChange:x=>{const _=x.target.value;Q(_),te({voiceId:_})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:we,value:ae,onChange:x=>{Z(x.target.value),te({prompt:x.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:ce,value:ge,onChange:x=>{Ae(x.target.value),te({previewText:x.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:P,disabled:ee||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ee||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ee?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:g,disabled:ee||!fe||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${ee||!fe||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ie,className:"hidden"}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Wo=t.memo(Vo),Fo=({data:s,id:S,selected:l})=>{const F=t.useRef(null),me=t.useRef(null),T=t.useRef(null),{getNodes:xe,getEdges:Y,setNodes:ae,setEdges:Z,getNode:ge,getViewport:Ae}=Zt(),fe=Js(),Q=Os(),[ee,Se]=t.useState(null),[ie,we]=t.useState("#7c3aed"),[ce,be]=t.useState(100),Ee=t.useRef(!1),le=t.useRef(null),te=t.useRef(null),R=t.useRef(null),$=t.useRef(new Set),P=t.useRef(null),g=t.useRef(null),x=t.useRef(null),_=4096,z=s.width||800,D=s.width||800,C=_,W=_;return t.useEffect(()=>{var c,i,n,V;if(!F.current||me.current)return;const r=document.createElement("canvas");r.width=C,r.height=W,F.current.appendChild(r);const k=new Aa(r,{width:C,height:W,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),p=new Zs({left:0,top:0,width:C,height:W,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});k.add(p),k.sendObjectToBack(p),k.perPixelTargetFind=!0,k.targetFindTolerance=8;const a=z/C;k.setDimensions({width:z,height:D}),k.setZoom(a),r.style.width=`${z} px`,r.style.height=`${D} px`,me.current=k,Bs.prototype.borderColor="#ff2d55",Bs.prototype.cornerColor="#ff2d55",Bs.prototype.cornerStrokeColor="#ff2d55",Bs.prototype.selectionBorderColor="#ff2d55",Bs.prototype.selectionColor="rgba(255,45,85,0.08)",Bs.prototype.transparentCorners=!1,Bs.prototype.cornerSize=12,Bs.prototype.selectionLineWidth=2,Bs.prototype.borderScaleFactor=2;const v=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;k.rotationCursor=v;const u=Bs.prototype.controls||{};u.tl&&(u.tl.cursorStyle="nwse-resize",u.tl.cornerStyle="square"),u.br&&(u.br.cursorStyle="nwse-resize",u.br.cornerStyle="square"),u.tr&&(u.tr.cursorStyle="nesw-resize",u.tr.cornerStyle="square"),u.bl&&(u.bl.cursorStyle="nesw-resize",u.bl.cornerStyle="square"),u.mtr&&(u.mtr.cursorStyle=v,u.mtr.cornerStyle="circle");const w=M=>{M&&(M.borderColor="#ff2d55",M.cornerColor="#ff2d55",M.cornerStrokeColor="#ff2d55",M.transparentCorners=!1,M.cornerSize=12,M.hasBorders=!0,M.hasControls=!0)},m=()=>{const M=k.getActiveObject();M&&(M.type==="activeSelection"&&Array.isArray(M._objects)&&M._objects.forEach(w),w(M),k.requestRenderAll())};k.on("selection:created",m),k.on("selection:updated",m),k.freeDrawingBrush=new Or(k);const N=()=>{const M=me.current;if(!M)return;const G=M.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(G.objects)&&(G.objects=G.objects.map(oe=>(oe&&oe.type==="image"&&oe.originalUrl&&(oe.src=oe.originalUrl),oe)));const O={canvasJson:G,appliedCrop:x.current},ne=JSON.stringify(O);try{localStorage.setItem(`superCanvas:${S}`,ne)}catch{}ge(S)&&ae(oe=>oe.map(h=>h.id===S?{...h,data:{...h.data,canvasState:ne}}:h))},I=()=>{g.current&&(clearTimeout(g.current),g.current=null),g.current=window.setTimeout(()=>{N()},300)};k.on("object:added",I),k.on("object:modified",I),k.on("object:removed",I),k.on("path:created",I);const U=((i=(c=ge(S))==null?void 0:c.data)==null?void 0:i.canvasState)||localStorage.getItem(`superCanvas:${S}`),y=(V=(n=ge(S))==null?void 0:n.data)==null?void 0:V.canvasJson;if(U||y)try{let M,G=null;if(U){const d=JSON.parse(U);d.canvasJson?(M=d.canvasJson,G=d.appliedCrop):M=d}else y&&(M=JSON.parse(y));const O=M,ne=d=>{var j,b,J,de,B,pe,Ce,Ne,Oe;if(!d||typeof d!="object")return d;if(d.type==="image"){if(d.crossOrigin="anonymous",d.originalUrl)d.src=d.originalUrl;else if(d.sourceNodeId){const Ue=ge(d.sourceNodeId),Re=((j=Ue==null?void 0:Ue.data)==null?void 0:j.imageUrl)||((b=Ue==null?void 0:Ue.data)==null?void 0:b.url)||((J=Ue==null?void 0:Ue.data)==null?void 0:J.output)||((B=(de=Ue==null?void 0:Ue.data)==null?void 0:de.config)==null?void 0:B.generatedImageUrl)||((Oe=(Ne=(Ce=(pe=Ue==null?void 0:Ue.data)==null?void 0:pe.config)==null?void 0:Ce.uploadedFiles)==null?void 0:Ne[0])==null?void 0:Oe.url);Re&&(d.originalUrl=Re,d.src=Re)}return typeof d.src=="string"&&d.src.startsWith("blob:")?null:d}return Array.isArray(d.objects)&&(d.objects=d.objects.map(ne).filter(Boolean),d.type==="group"&&d.objects.length===0)?null:d},ue=d=>d&&(typeof(d==null?void 0:d.src)=="string"&&d.src.startsWith("blob:")?null:d.type==="image"?(d.crossOrigin="anonymous",ne(d)):d),oe=d=>d&&(Array.isArray(d)?d.map(oe).filter(Boolean):typeof d=="object"&&(d.type==="image"&&typeof d.src=="string"&&d.src.startsWith("blob:")||(Object.keys(d).forEach(j=>{const b=d[j];if(typeof b=="string"&&b.startsWith("blob:"))d[j]=void 0;else if(b&&typeof b=="object"){const J=oe(b);J===null?delete d[j]:d[j]=J}}),Array.isArray(d.objects)&&(d.objects=d.objects.map(oe).filter(Boolean),d.type==="group"&&d.objects.length===0)))?null:d);Array.isArray(O.objects)&&(O.objects=O.objects.map(ne).filter(Boolean)),O.backgroundImage&&(O.backgroundImage=ue(O.backgroundImage)),O.overlayImage&&(O.overlayImage=ue(O.overlayImage)),O.clipPath&&(O.clipPath=ne(O.clipPath));const h=oe(O);k.loadFromJSON(h).then(()=>{const d=new Zs({left:0,top:0,width:C,height:W,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});k.add(d);const j=k.getObjects().find(b=>b.name==="__background__");if(j&&k.sendObjectToBack(j),G){x.current=G;const{left:b,top:J,width:de,height:B}=G,pe=new Zs({left:b,top:J,width:de,height:B,absolutePositioned:!0});k.clipPath=pe,j&&j.set({left:b,top:J,width:de,height:B})}k.requestRenderAll()})}catch{}return F.current&&F.current.classList.add("nodrag"),()=>{k.dispose(),me.current=null,F.current&&(F.current.innerHTML="")}},[S,C,W,z]),t.useEffect(()=>{ee==="brush"?(ce<80||ce>400)&&be(100):(ee==="pencil"||ee==="line"||ee==="arrow")&&(ce<10||ce>30)&&be(15)},[ee,ce]),t.useEffect(()=>{const r=me.current;if(!r)return;const k="https://api.waule.ai",p=fe.filter(u=>u.target===S&&u.targetHandle==="input-image");p.forEach(async u=>{var y,c;const w=Q.find(i=>i.id===u.source);if(!w||$.current.has(w.id))return;let m;const N=w.data;if(w.type==="upload"){const i=(y=N==null?void 0:N.config)==null?void 0:y.uploadedFiles;if(i&&i.length>0){const n=i[0];(n.type==="IMAGE"||(c=n.mimeType)!=null&&c.startsWith("image/"))&&(m=n.url)}}else w.type==="imagePreview"?m=N==null?void 0:N.imageUrl:m=(N==null?void 0:N.imageUrl)||(N==null?void 0:N.output)||(N==null?void 0:N.url);if(!m)return;let I=m;if(!m.startsWith("http")&&!m.startsWith("data:")&&(I=`${k}${m}`),I=I.replace(/^https?:\/\/localhost(?::\d+)?/i,k),r.getObjects().find(i=>i.sourceNodeId===w.id)){$.current.add(w.id);return}$.current.add(w.id);try{const i=await _e.assets.proxyDownload(I),n=new Uint8Array(i);let V="image/png";n.length>=4&&(n[0]===137&&n[1]===80&&n[2]===78&&n[3]===71?V="image/png":n[0]===255&&n[1]===216&&n[2]===255?V="image/jpeg":n[0]===71&&n[1]===73&&n[2]===70?V="image/gif":n[0]===82&&n[1]===73&&n[2]===70&&n[3]===70&&n.length>=12&&n[8]===87&&n[9]===69&&n[10]===66&&n[11]===80&&(V="image/webp"));const M=new Blob([i],{type:V}),G=URL.createObjectURL(M),O=await _a.fromURL(G);if(!O){URL.revokeObjectURL(G);return}const ne=p.indexOf(u)*20;O.set({scaleX:1,scaleY:1,left:(C-O.width)/2+ne,top:(W-O.height)/2+ne,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:w.id,originalUrl:I,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),O.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(O);const ue=r.getObjects().find(oe=>oe.name==="__background__");ue?(r.sendObjectToBack(O),r.sendObjectToBack(ue)):r.sendObjectToBack(O),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(G),1e3)}catch{}});const a=new Set(p.map(u=>{var w;return(w=Q.find(m=>m.id===u.source))==null?void 0:w.id}).filter(Boolean)),v=[];$.current.forEach(u=>{if(!a.has(u)){v.push(u);const w=r.getObjects().find(m=>m.sourceNodeId===u);w&&(r.remove(w),r.requestRenderAll())}}),v.forEach(u=>$.current.delete(u))},[fe,Q,S,C,W]),t.useEffect(()=>{const r=me.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,ee===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(v=>{v.name!=="__background__"&&v.name!=="__crop__"&&(v.selectable=!1,v.evented=!1)}),P.current&&(P.current.style.display="none"),x.current){const{left:v,top:u,width:w,height:m}=x.current,N=new Zs({left:v,top:u,width:w,height:m,absolutePositioned:!0});r.clipPath=N;const I=r.getObjects().find(U=>U.name==="__background__");I&&I.set({left:v,top:u,width:w,height:m})}return}const k=ie.startsWith("#")?`%23${ie.slice(1)}`:encodeURIComponent(ie),p=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${k}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(ee==="pencil"||ee==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Or(r);const v=(w,m)=>{const N=w.replace("#",""),I=parseInt(N.substring(0,2),16),U=parseInt(N.substring(2,4),16),y=parseInt(N.substring(4,6),16);return`rgba(${I},${U},${y},${m})`};if(r.freeDrawingBrush.color=v(ie,.7),r.freeDrawingBrush.width=ce,x.current){const{left:w,top:m,width:N,height:I}=x.current,U=new Zs({left:w,top:m,width:N,height:I,absolutePositioned:!0});r.clipPath=U;const y=r.getObjects().find(c=>c.name==="__background__");y&&y.set({left:w,top:m,width:N,height:I})}const u=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${k}' stroke-width='2.2'/></svg>") 16 16, crosshair`;ee==="pencil"?(r.freeDrawingCursor=p,r.defaultCursor=p,r.hoverCursor=p,r.moveCursor=p,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=p)):(r.freeDrawingCursor=u,r.defaultCursor=u,r.hoverCursor=u,r.moveCursor=u,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=u)),r.selection=!1,r.getObjects().forEach(w=>{w.name!=="__background__"&&w.name!=="__crop__"&&(w.selectable=!0,w.evented=!0)}),ee==="brush"&&P.current&&(P.current.style.display="block"),ee==="pencil"&&P.current&&(P.current.style.display="none")}else if(ee==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const v=r.getObjects().find(I=>I.name==="__background__");v&&v.set({left:0,top:0,width:C,height:W}),r.requestRenderAll();let u=R.current;const w=C*.1,m=C-w*2,N=W-w*2;if(!u||!r.getObjects().includes(u)){const I=x.current||{left:w,top:w,width:m,height:N};u=new Zs({left:I.left,top:I.top,width:I.width,height:I.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),R.current=u,r.add(u)}u&&(u.visible=!0,u.selectable=!0,u.evented=!0,r.setActiveObject(u),r.requestRenderAll())}else if(ee==="line"||ee==="arrow"||ee==="text"||ee==="eraser"){if(r.selection=!1,x.current){const{left:u,top:w,width:m,height:N}=x.current,I=new Zs({left:u,top:w,width:m,height:N,absolutePositioned:!0});r.clipPath=I;const U=r.getObjects().find(y=>y.name==="__background__");U&&U.set({left:u,top:w,width:m,height:N})}const v=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${k}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=ee==="text"?"text":ee==="eraser"?a:v,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),ee==="line"||ee==="arrow"?(r.hoverCursor=v,r.moveCursor=v,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(u=>{u.name!=="__background__"&&u.name!=="__crop__"&&(u.selectable=!1,u.evented=!1)}),P.current&&(P.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(u=>{u.name!=="__background__"&&u.name!=="__crop__"&&(u.selectable=!0,u.evented=!0)}),ee==="eraser"&&P.current&&(P.current.style.display="none"),ee==="eraser"&&(r.moveCursor=a,r.hoverCursor=a)),P.current&&(P.current.style.display="none")}else{if(R.current&&(R.current.visible=!1,r.discardActiveObject()),x.current){const{left:v,top:u,width:w,height:m}=x.current,N=new Zs({left:v,top:u,width:w,height:m,absolutePositioned:!0});r.clipPath=N;const I=r.getObjects().find(U=>U.name==="__background__");I&&I.set({left:v,top:u,width:w,height:m})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(v=>{v.name!=="__background__"&&v.name!=="__crop__"&&(v.selectable=!0,v.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),P.current&&(P.current.style.display="none")}},[ee,ie,ce,C,W,z,D]),t.useEffect(()=>{const r=k=>{const p=me.current;if(p){if(k.key==="Escape")Se("select");else if(k.key==="Enter"&&ee==="crop"){const a=R.current;if(a){const v=Math.max(0,Math.floor(a.left??0)),u=Math.max(0,Math.floor(a.top??0)),w=Math.max(1,Math.floor((a.width??0)*(a.scaleX??1))),m=Math.max(1,Math.floor((a.height??0)*(a.scaleY??1)));x.current={left:v,top:u,width:w,height:m};const N=new Zs({left:v,top:u,width:w,height:m,absolutePositioned:!0});p.clipPath=N;const I=p.getObjects().find(y=>y.name==="__background__");I&&I.set({left:v,top:u,width:w,height:m}),a.visible=!1,Se("select"),p.requestRenderAll();const U=me.current?()=>{const y=me.current;if(!y)return;const c=y.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(c.objects)&&(c.objects=c.objects.map(M=>(M&&M.type==="image"&&M.originalUrl&&(M.src=M.originalUrl),M)));const i={canvasJson:c,appliedCrop:x.current},n=JSON.stringify(i);try{localStorage.setItem(`superCanvas:${S}`,n)}catch{}ge(S)&&ae(M=>M.map(G=>G.id===S?{...G,data:{...G.data,canvasState:n}}:G))}:null;U&&U()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[ee]),t.useEffect(()=>{const r=me.current;if(!r)return;const k=m=>{const N=r.getPointer(m.e);if(Ee.current=!0,le.current={x:N.x,y:N.y},(ee==="line"||ee==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(I=>{I.name!=="__background__"&&I.name!=="__crop__"&&(I.selectable=!1,I.evented=!1)})),ee==="line"){const I=[N.x,N.y,N.x,N.y],U=new or(I,{strokeWidth:ce/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round"});te.current=U,r.add(U)}else if(ee==="arrow"){const I=[N.x,N.y,N.x,N.y],U=new or(I,{strokeWidth:ce/2,fill:ie,stroke:ie,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});te.current=U,r.add(U)}else if(ee==="text"){const I=new Gr("Type here",{left:N.x,top:N.y,fontFamily:"Arial",fill:ie,fontSize:ce*10,width:300,splitByGrapheme:!0});I.lockScalingY=!1,I.lockScalingFlip=!0,I.lockUniScaling=!1,I.setControlsVisibility({mt:!1,mb:!1}),r.add(I),r.setActiveObject(I),I.enterEditing(),Se("select")}else if(ee==="eraser"){const I=r.getObjects();for(let U=I.length-1;U>=0;U--){const y=I[U];if(!(y.name==="__background__"||y.name==="__crop__"||y.name==="__input_image__"||y.sourceNodeId)&&y.containsPoint(N)){r.remove(y);break}}r.requestRenderAll()}},p=m=>{const N=r.getPointer(m.e);if(ee==="brush"&&P.current){const U=r.getZoom(),y=ce*U,c=y/2;P.current.style.width=`${y}px`,P.current.style.height=`${y}px`,P.current.style.left=`${N.x*U-c}px`,P.current.style.top=`${N.y*U-c}px`,P.current.style.borderColor=`rgba(${parseInt(ie.slice(1,3),16)},${parseInt(ie.slice(3,5),16)},${parseInt(ie.slice(5,7),16)},0.7)`,P.current.style.borderWidth="1px",P.current.style.background="transparent"}if(!Ee.current)return;const I=te.current;if(ee==="line"&&I&&I instanceof or)I.set({x2:N.x,y2:N.y}),I.setCoords(),r.requestRenderAll();else if(ee==="arrow"&&I&&I instanceof or)I.set({x2:N.x,y2:N.y}),I.setCoords(),r.requestRenderAll();else if(ee==="eraser"){const U=r.getObjects();for(let y=U.length-1;y>=0;y--){const c=U[y];c.name==="__background__"||c.name==="__crop__"||c.name==="__input_image__"||c.sourceNodeId||c.containsPoint(N)&&r.remove(c)}r.requestRenderAll()}},a=()=>{if(Ee.current=!1,ee==="arrow"&&te.current instanceof or){const m=te.current,N=Math.atan2(m.y2-m.y1,m.x2-m.x1),I=Math.max(ce*10,120),U=Math.PI/6,y=-Math.cos(N),c=-Math.sin(N),i=Math.cos(U),n=Math.sin(U),V=m.x2+I*(y*i-c*n),M=m.y2+I*(y*n+c*i),G=m.x2+I*(y*i+c*n),O=m.y2+I*(-y*n+c*i),ne=m.strokeWidth||ce/2,ue=new or([m.x2,m.y2,V,M],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"}),oe=new or([m.x2,m.y2,G,O],{stroke:ie,strokeWidth:ne,strokeLineCap:"round"});r.add(ue),r.add(oe);const h=new Ta([m,ue,oe],{selectable:!0,evented:!0});r.remove(m),r.remove(ue),r.remove(oe),r.add(h)}te.current=null,(ee==="line"||ee==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(m=>{m.name!=="__background__"&&m.name!=="__crop__"&&(m.selectable=!1,m.evented=!1)}))},v=m=>{var y;const N=m.target;if(!N)return;const I=N.type==="textbox"||N instanceof Gr,U=N.type==="i-text"||N instanceof Ua;if(I||U){const c=(y=m==null?void 0:m.transform)==null?void 0:y.corner;if(c==="ml"||c==="mr"){const i=Math.max(50,(N.width||50)*(N.scaleX||1));N.set({width:i,scaleX:1,scaleY:1})}else{const i=N.scaleX||1,n=N.fontSize||40,V=Math.max(6,Math.min(512,Math.round(n*i)));N.set({fontSize:V,scaleX:1,scaleY:1})}N.setCoords(),r.requestRenderAll()}},u=()=>{ee==="brush"&&P.current&&(P.current.style.display="block")},w=()=>{P.current&&(P.current.style.display="none")};return r.on("mouse:down",k),r.on("mouse:move",p),r.on("mouse:up",a),r.on("mouse:over",u),r.on("mouse:out",w),r.on("object:scaling",v),()=>{r.off("mouse:down",k),r.off("mouse:move",p),r.off("mouse:up",a),r.off("mouse:over",u),r.off("mouse:out",w),r.off("object:scaling",v)}},[ee,ie,ce]),e.jsxs("div",{ref:T,className:`relative flex flex-col w-[800px] h-auto bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cr,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:F,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:P,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Cr,label:"Select"},{id:"pencil",icon:Xr,label:"Pencil"},{id:"brush",icon:$a,label:"Brush"},{id:"line",icon:Oa,label:"Line"},{id:"arrow",icon:Ra,label:"Arrow"},{id:"text",icon:Wa,label:"Text"},{id:"eraser",icon:La,label:"Eraser"},{id:"crop",icon:Da,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>Se(r.id),className:`p-2 rounded-lg transition-all ${ee===r.id?"bg-neutral-500/20 text-neutral-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=me.current,k=r==null?void 0:r.getActiveObject();k&&(r==null||r.remove(k),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(Hr,{size:16})}),e.jsx("button",{onClick:()=>{const r=me.current,k=r==null?void 0:r.getActiveObject();k&&(r==null||r.bringObjectToFront(k),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Va,{size:16})}),e.jsx("button",{onClick:()=>{const r=me.current,k=r==null?void 0:r.getActiveObject();if(k){r==null||r.sendObjectToBack(k);const p=r==null?void 0:r.getObjects().find(a=>a.name==="__background__");p&&(r==null||r.sendObjectToBack(p)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Ga,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ie,onChange:r=>we(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:ee==="brush"?80:10,max:ee==="brush"?400:30,value:ce,onChange:r=>{const k=parseInt(r.target.value);be(k)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:ce})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:ee==="crop",onClick:async()=>{var Te,se,Ve,et;const r=me.current;if(!r)return;r.discardActiveObject();const k=[...r.viewportTransform],p=r.getWidth(),a=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(_),r.setHeight(_);const v=r.clipPath;r.clipPath=void 0;const u=x.current;let w="",m=C,N=W;u?(m=u.width,N=u.height,w=r.toDataURL({format:"png",quality:1,left:u.left,top:u.top,width:u.width,height:u.height,multiplier:1})):w=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:C,height:W}),r.clipPath=v,r.setViewportTransform(k),r.setWidth(p),r.setHeight(a),r.requestRenderAll();const I=`${m}:${N}`,U=ge(S);if(!U)return;const y=w.split(",")[1],c=atob(y),i=new Array(c.length);for(let kt=0;kt<c.length;kt++)i[kt]=c.charCodeAt(kt);const n=new Uint8Array(i),V=new Blob([n],{type:"image/png"}),M=`canvas-export-${Date.now()}.png`;let G=null;try{const kt=await _e.post("/assets/presigned-url",{fileName:M,contentType:"image/png"});if(kt.success&&kt.data){const{uploadUrl:vt,publicUrl:Nt}=kt.data;await(await us(async()=>{const{default:ut}=await import("./utils-BcyDR7Vi.js");return{default:ut}},[])).default.put(vt,V,{headers:{"Content-Type":"image/png"},timeout:3e5}),G=Nt}}catch{}if(!G)try{const kt=new FormData;kt.append("file",V,M);const vt=await _e.post("/assets/upload",kt,{headers:{"Content-Type":"multipart/form-data"}});vt.success&&((Te=vt.data)!=null&&Te.url)&&(G=vt.data.url)}catch{}if(!G)return;const O=Ae&&((se=Ae())==null?void 0:se.zoom)||1,ne=document.querySelector(`.react-flow__node[data-id="${S}"]`),ue=(ne==null?void 0:ne.getBoundingClientRect().width)||400,oe=Math.round(ue/O),h=400,d=(kt,vt=300)=>{if(!kt||!/^[0-9]+\s*:\s*[0-9]+$/.test(kt))return vt;const[Nt,ct]=kt.split(":").map(ut=>parseFloat(ut));return!Nt||!ct?vt:Math.round(h*(ct/Nt))},j=200,b=100,J=d(I,300),de=xe(),B=Y(),Ce=de.filter(kt=>kt.type==="imagePreview"&&B.some(vt=>vt.source===S&&vt.target===kt.id)).length,Ne=U.position.x+oe+j,Oe=U.position.y+Ce*(J+b),Ue={id:`preview-${S}-${Date.now()}`,type:"imagePreview",position:{x:Ne,y:Oe},data:{imageUrl:G,width:h,ratio:I,workflowContext:(Ve=U.data)==null?void 0:Ve.workflowContext,createdBy:(et=U.data)==null?void 0:et.createdBy}};ae(kt=>[...kt,Ue]);const Re={id:`edge-${S}-${Ue.id}`,source:S,target:Ue.id,targetHandle:`${Ue.id}-target`,type:"aurora"};Z(kt=>kt.find(Nt=>Nt.source===S&&Nt.target===Ue.id)?kt:[...kt,Re])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:cursor-not-allowed disabled:hover:shadow-md",title:ee==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(Ut,{type:"target",position:pt.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(Ut,{type:"source",position:pt.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},zo=t.memo(Fo),Bo=({data:s,selected:S,id:l})=>{const[F,me]=t.useState(s.config.upscaleResolution||"1080p"),[T,xe]=t.useState(!1),[Y,ae]=t.useState(s.config.inputVideoUrl||""),[,Z]=t.useState(s.config.taskId||""),{setNodes:ge,setEdges:Ae}=Zt(),fe=Os(),Q=Js(),ee=ce=>{ge(be=>be.map(Ee=>Ee.id===l?{...Ee,data:{...Ee.data,config:{...Ee.data.config,...ce}}}:Ee))};t.useEffect(()=>{var be,Ee,le;const ce=Q.filter(te=>te.target===l);if(ce.length>0){const te=fe.find(R=>R.id===ce[0].source);if(te){const R=te.data,$=R.videoUrl||((be=R.config)==null?void 0:be.videoUrl)||((Ee=R.config)==null?void 0:Ee.outputVideoUrl)||((le=R.config)==null?void 0:le.resultUrl);$&&$!==Y&&(ae($),ee({inputVideoUrl:$}))}}else Y&&(ae(""),ee({inputVideoUrl:""}))},[Q,fe,l]),t.useEffect(()=>{const ce=s.config.taskId;(async()=>{if(ce)try{const le=(await _e.get(`/tasks/${ce}`)).task;if(le.status==="SUCCESS"){const te=le.resultUrl;ee({outputVideoUrl:te,taskId:""}),Q.filter(g=>g.source===l).map(g=>fe.find(x=>x.id===g.target)).filter(g=>g&&g.type==="videoPreview").find(g=>g.data.videoUrl===te)||ie(te),Ft.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),xe(!1)}else le.status==="PROCESSING"||le.status==="PENDING"?(xe(!0),Se(ce)):le.status==="FAILURE"&&(xe(!1),ee({taskId:""}),Ft.error(le.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${le.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{xe(!1),ee({taskId:""}),Ft.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const Se=async ce=>{let Ee=0;const le=async()=>{try{Ee++;const R=(await _e.get(`/tasks/${ce}`)).task;if(R.status==="SUCCESS"){const $=R.resultUrl;xe(!1),ee({outputVideoUrl:$,taskId:""}),ie($),Ft.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(R.status==="FAILURE"){xe(!1),ee({taskId:""}),Ft.error(R.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(R.status==="PROCESSING"||R.status==="PENDING")&&(Ee<300?setTimeout(le,3e3):(xe(!1),ee({taskId:""}),Ft.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{xe(!1),ee({taskId:""}),Ft.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};le()},ie=ce=>{var Ee;const be=fe.find(le=>le.id===l);if(be){const le=`preview-video-${Date.now()}`,te=F==="1080p"?"HD":F,R={id:le,type:"videoPreview",position:{x:be.position.x+400,y:be.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:ce,ratio:"16:9",resolution:te,createdBy:(Ee=be.data)==null?void 0:Ee.createdBy}},$={id:`edge-${l}-${le}`,source:l,target:le,type:"aurora"};ge(P=>[...P,R]),setTimeout(()=>{Ae(P=>[...P,$])},100)}},we=async()=>{var ce,be;if(!Y){Ft.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}xe(!0);try{const Ee=await _e.get("/ai/models?provider=vidu&isActive=true");if(!Ee||Ee.length===0){Ft.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),xe(!1);return}const le=Ee[0],R=(await _e.post("/ai/video-upscale",{video_url:Y,upscale_resolution:F,apiKey:le.apiKey,apiUrl:le.apiUrl})).taskId;Z(R),ee({taskId:R,upscaleResolution:F}),Ft.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),Se(R)}catch(Ee){const le=((be=(ce=Ee.response)==null?void 0:ce.data)==null?void 0:be.error)||Ee.message||"æœªçŸ¥åŸå› ";Ft.error(`å¯åŠ¨å¤±è´¥ï¼š${le}ï¼Œè¯·ç¨åé‡è¯•`),xe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{type:"target",position:pt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[Y&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:Y,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(ce=>e.jsx("button",{type:"button",onClick:()=>{me(ce),ee({upscaleResolution:ce})},disabled:T,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${F===ce?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${T?"cursor-not-allowed":""}`,children:ce},ce))})]}),e.jsx("button",{type:"button",onClick:ce=>{ce.preventDefault(),ce.stopPropagation(),we()},onMouseDown:ce=>{ce.stopPropagation()},disabled:T||!Y||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${T||!Y||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[T?e.jsx(Ps,{className:"w-4 h-4 animate-spin"}):e.jsx(Ca,{className:"w-4 h-4"}),e.jsx("span",{children:T?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(hs,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ho=t.memo(Bo),Xo=({data:s,selected:S,id:l})=>{const[F,me]=t.useState(s.config.prompt||""),[T,xe]=t.useState(s.config.duration||30),[Y,ae]=t.useState(s.config.ratio||"16:9"),[Z,ge]=t.useState(s.config.language||"zh"),[Ae,fe]=t.useState(!1),[Q,ee]=t.useState(s.config.images||[]),[,Se]=t.useState(s.config.taskId||""),{credits:ie,loading:we}=Ns({nodeType:"ad_composition",duration:T}),{setNodes:ce,setEdges:be}=Zt(),Ee=Os(),le=Js(),te=g=>{ce(x=>x.map(_=>_.id===l?{..._,data:{..._.data,config:{..._.data.config,...g}}}:_))};t.useEffect(()=>{const g=le.filter(_=>_.target===l),x=[];g.forEach(_=>{var D,C,W,r,k,p,a,v,u,w;const z=Ee.find(m=>m.id===_.source);z&&(z.type==="imagePreview"&&((D=z.data)!=null&&D.imageUrl)?x.push(z.data.imageUrl):z.type==="aiImage"&&((W=(C=z.data)==null?void 0:C.config)!=null&&W.generatedImageUrl)?x.push(z.data.config.generatedImageUrl):z.type==="upload"&&((k=(r=z.data)==null?void 0:r.config)!=null&&k.uploadedFiles)?z.data.config.uploadedFiles.filter(N=>N.type==="IMAGE"||(N.mimeType||"").startsWith("image/")).forEach(N=>x.push(N.url)):z.type==="assetSelector"&&((a=(p=z.data)==null?void 0:p.config)!=null&&a.subjects?z.data.config.subjects.forEach(N=>{Array.isArray(N.images)&&N.images.forEach(I=>x.push(I.url))}):((w=(u=(v=z.data)==null?void 0:v.config)==null?void 0:u.selectedAsset)==null?void 0:w.type)==="IMAGE"&&x.push(z.data.config.selectedAsset.url)))}),JSON.stringify(x)!==JSON.stringify(Q)&&(ee(x),te({images:x}))},[le,Ee,l]),t.useEffect(()=>{const g=s.config.taskId;(async()=>{if(g)try{const z=(await _e.get(`/tasks/${g}`)).task;if(z.status==="SUCCESS"){const D=z.resultUrl;te({taskId:""}),fe(!1)}else z.status==="PROCESSING"||z.status==="PENDING"?(fe(!0),R(g)):z.status==="FAILURE"&&(fe(!1),te({taskId:""}),Ft.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${z.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{fe(!1),te({taskId:""})}})()},[]);const R=async g=>{let _=0;const z=async()=>{try{_++;const C=(await _e.get(`/tasks/${g}`)).task;if(C.status==="SUCCESS"){const W=C.resultUrl;fe(!1),te({taskId:""}),$(W),Ft.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(C.status==="FAILURE"){fe(!1),te({taskId:""}),Ft.error(C.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(C.status==="PROCESSING"||C.status==="PENDING")&&(_<120?setTimeout(z,1e4):(fe(!1),te({taskId:""}),Ft.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{fe(!1),te({taskId:""}),Ft.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};z()},$=g=>{var _;const x=Ee.find(z=>z.id===l);if(x){const z=`preview-video-${Date.now()}`,D={id:z,type:"videoPreview",position:{x:x.position.x+400,y:x.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:g,ratio:Y,width:320,createdBy:(_=x.data)==null?void 0:_.createdBy}},C={id:`edge-${l}-${z}`,source:l,target:z,type:"aurora"};ce(W=>[...W,D]),setTimeout(()=>{be(W=>[...W,C])},100)}},P=async()=>{var g,x,_,z,D;if(Q.length===0){Ft.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(Q.length>15){Ft.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!F.trim()){Ft.error("è¯·è¾“å…¥æç¤ºè¯");return}fe(!0);try{const C=await _e.get("/ai/models?provider=vidu&isActive=true");if(!C||C.length===0){Ft.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),fe(!1);return}const W=C[0],r={images:Q,prompt:F,duration:T,ratio:Y,language:Z,apiKey:W.apiKey,apiUrl:W.apiUrl},k=await _e.post("/ai/commercial-video",r),p=k.taskId,a=k.creditsCharged||0;if(Se(p),te({taskId:p,images:Q,prompt:F,duration:T,ratio:Y,language:Z}),a>0)try{const{useAuthStore:v}=await us(async()=>{const{useAuthStore:w}=await import("./index-CiJ2Nd2F.js").then(m=>m.f);return{useAuthStore:w}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:u}=v.getState();await u(),Ft.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${a} ç§¯åˆ†ï¼‰`)}catch{Ft.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Ft.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");R(p)}catch(C){((g=C.response)==null?void 0:g.status)===403?Ft.error(((_=(x=C.response)==null?void 0:x.data)==null?void 0:_.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Ft.error(((D=(z=C.response)==null?void 0:z.data)==null?void 0:D.error)||C.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),fe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(hs,{type:"target",position:pt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",Q.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:F,onChange:g=>{me(g.target.value),te({prompt:g.target.value}),g.target.style.height="auto",g.target.style.height=g.target.scrollHeight+"px"},onFocus:g=>{g.target.style.height="auto",g.target.style.height=g.target.scrollHeight+"px"},ref:g=>{g&&F&&(g.style.height="auto",g.style.height=g.scrollHeight+"px")},disabled:Ae,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(g=>e.jsxs("button",{type:"button",onClick:()=>{xe(g),te({duration:g})},disabled:Ae,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${T===g?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ae?"cursor-not-allowed":""}`,children:[g,"s"]},g))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(g=>e.jsx("button",{type:"button",onClick:()=>{ae(g),te({ratio:g})},disabled:Ae,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Y===g?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ae?"cursor-not-allowed":""}`,children:g},g))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(g=>e.jsx("button",{type:"button",onClick:()=>{ge(g.value),te({language:g.value})},disabled:Ae,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Z===g.value?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ae?"cursor-not-allowed":""}`,children:g.label},g.value))})]}),e.jsx("button",{type:"button",onClick:P,disabled:Ae||Q.length===0||!F.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Ae||Q.length===0||!F.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Ae?e.jsx(Ps,{className:"w-4 h-4 animate-spin"}):e.jsx(Pa,{className:"w-4 h-4"}),e.jsx("span",{children:Ae?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Ae&&!we&&ie!==null&&ie>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ie,"ç§¯åˆ†"]})]})})]}),e.jsx(hs,{type:"source",position:pt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Jo=t.memo(Xo),qo=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],Ko=({data:s,selected:S,id:l})=>{const{setNodes:F}=Zt(),[me,T]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[xe,Y]=t.useState(!1),[ae,Z]=t.useState(!1),[ge,Ae]=t.useState(s.fontSize||36),[fe,Q]=t.useState(s.width||200),[ee,Se]=t.useState(s.bold||!1),ie=t.useRef(null),we=t.useRef(null),ce=t.useCallback(le=>{F(te=>te.map(R=>R.id===l?{...R,data:{...R.data,...le}}:R))},[l,F]);t.useEffect(()=>{const le=setTimeout(()=>{me!==s.text&&ce({text:me})},300);return()=>clearTimeout(le)},[me,s.text,ce]),t.useEffect(()=>{ce({fontSize:ge,width:fe,bold:ee})},[ge,fe,ee,ce]);const be=()=>{Y(!0),setTimeout(()=>{ie.current&&(ie.current.focus(),ie.current.select(),ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},0)},Ee=()=>{Y(!1)};return t.useEffect(()=>{xe&&ie.current&&(ie.current.style.height="auto",ie.current.style.height=`${ie.current.scrollHeight}px`)},[xe,me]),t.useEffect(()=>{const le=te=>{we.current&&!we.current.contains(te.target)&&Z(!1)};return ae&&document.addEventListener("mousedown",le),()=>document.removeEventListener("mousedown",le)},[ae]),e.jsxs("div",{className:`relative group ${S?"ring-2 ring-neutral-400 ring-offset-2":""}`,style:{width:fe},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:le=>{le.stopPropagation(),Z(!ae)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),ae&&e.jsxs("div",{ref:we,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:le=>le.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:ge,onChange:le=>Ae(Number(le.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-neutral-400",children:qo.map(le=>e.jsxs("option",{value:le,children:[le,"px"]},le))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>Se(!ee),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${ee?"bg-neutral-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),xe?e.jsx("textarea",{ref:ie,value:me,onChange:le=>T(le.target.value),onBlur:Ee,onMouseDown:le=>le.stopPropagation(),onKeyDown:le=>{le.key==="Escape"&&Y(!1)},className:"nodrag w-full bg-transparent border-2 border-neutral-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${ge}px`,fontWeight:ee?"bold":"normal"}}):e.jsx("div",{onDoubleClick:be,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${ge}px`,fontWeight:ee?"bold":"normal"},children:me}),!xe&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:le=>{le.stopPropagation(),le.preventDefault();const te=le.clientX,R=fe,$=g=>{g.preventDefault();const x=Math.max(100,R+(g.clientX-te));Q(x)},P=()=>{document.removeEventListener("mousemove",$),document.removeEventListener("mouseup",P)};document.addEventListener("mousemove",$),document.addEventListener("mouseup",P)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Yo=t.memo(Ko),Qo=({data:s,id:S,selected:l})=>{const{getNode:F,setNodes:me,setEdges:T}=Zt(),xe=Xs(t.useCallback(i=>i.edges.filter(n=>n.target===S),[S])),[Y,ae]=t.useState(s.prompt||""),[Z,ge]=t.useState(s.points||[]),[Ae,fe]=t.useState(!1),[Q,ee]=t.useState(!1),[Se,ie]=t.useState(null),[we,ce]=t.useState([]),[,be]=t.useState(s.generatedImageUrl||null),[Ee,le]=t.useState(null),[,te]=t.useState(s.taskId||""),[,R]=t.useState(0),$=t.useRef(null),P=t.useRef(1),{credits:g,loading:x,isFreeUsage:_,freeUsageRemaining:z,refetch:D}=Ns({nodeType:"image_editing",quantity:1}),C=t.useCallback(i=>{me(n=>n.map(V=>V.id===S?{...V,data:{...V.data,...i}}:V))},[S,me]),W=Xs(t.useCallback(i=>i.edges.filter(n=>n.source===S),[S])),r=t.useCallback(i=>{var ne,ue;const n=F(S);if(!n)return;const V=W.find(oe=>{const h=F(oe.target);return(h==null?void 0:h.type)==="imagePreview"});if(V){const oe=V.target;me(h=>h.map(d=>d.id===oe?{...d,data:{...d.data,imageUrl:i}}:d));return}const M=Date.now(),G=`preview-${S}-${M}`,O={id:G,type:"imagePreview",position:{x:(((ne=n==null?void 0:n.position)==null?void 0:ne.x)||0)+450,y:((ue=n==null?void 0:n.position)==null?void 0:ue.y)||0},data:{imageUrl:i,width:400}};setTimeout(()=>{me(h=>[...h,O]);const oe={id:`edge-${S}-${G}`,source:S,target:G,targetHandle:`${G}-target`,type:"aurora"};T(h=>h.find(j=>j.source===S&&j.target===G)?h:[...h,oe])},100)},[S,F,me,T,W]),k=t.useRef({active:!1,timeoutId:null}),p=t.useCallback(async i=>{let V=0;k.current.timeoutId&&clearTimeout(k.current.timeoutId),k.current.active=!0;const M=async()=>{if(k.current.active)try{V++;const O=(await _e.tasks.getTaskStatus(i)).task;if(!k.current.active)return;if(R(O.progress||0),O.status==="SUCCESS"){k.current.active=!1,fe(!1),R(100);const ne=O.resultUrl;C({generatedImageUrl:ne,taskId:""}),be(ne),f.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ne&&r(ne);return}else if(O.status==="FAILURE"){k.current.active=!1,fe(!1),R(0),C({taskId:""}),f.error(O.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(O.status==="PROCESSING"||O.status==="PENDING")&&(V<300&&k.current.active?k.current.timeoutId=setTimeout(M,1e3):(k.current.active=!1,fe(!1),R(0),C({taskId:""}),f.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{k.current.active=!1,fe(!1),R(0),C({taskId:""}),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};M()},[C,r]);t.useEffect(()=>()=>{k.current.active=!1,k.current.timeoutId&&clearTimeout(k.current.timeoutId)},[]),t.useEffect(()=>{const i=s.taskId;if(!i)return;(async()=>{try{const M=(await _e.tasks.getTaskStatus(i)).task;if(M.status==="SUCCESS"){fe(!1),R(100);const G=M.resultUrl;G?(C({generatedImageUrl:G,taskId:""}),be(G),f.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):C({taskId:""})}else M.status==="PROCESSING"||M.status==="PENDING"?(fe(!0),R(M.progress||0),p(i)):M.status==="FAILURE"&&(fe(!1),R(0),C({taskId:""}),f.error(M.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${M.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{fe(!1),R(0),C({taskId:""})}})()},[]);const a=t.useCallback(i=>{const n=new Image;n.onload=()=>{le({width:n.naturalWidth,height:n.naturalHeight})},n.src=i},[]);t.useEffect(()=>{try{const i=[];xe.forEach(n=>{var O,ne,ue,oe;const V=F(n.source);if(!V)return;const M=V.data;let G=null;M!=null&&M.url?G=M.url:M!=null&&M.imageUrl?G=M.imageUrl:M!=null&&M.output?G=M.output:(O=M==null?void 0:M.config)!=null&&O.generatedImageUrl?G=M.config.generatedImageUrl:(oe=(ue=(ne=M==null?void 0:M.config)==null?void 0:ne.uploadedFiles)==null?void 0:ue[0])!=null&&oe.url&&(G=M.config.uploadedFiles[0].url),G&&i.push(G)}),i.length>0?(ie(i[0]),ce(i.slice(1)),a(i[0])):(ie(null),ce([]),le(null))}catch{}},[xe,F,a]),t.useEffect(()=>{const i=setTimeout(()=>{me(n=>n.map(V=>{if(V.id!==S)return V;const M=V.data;return M.prompt===Y&&JSON.stringify(M.points)===JSON.stringify(Z)?V:{...V,data:{...V.data,prompt:Y,points:Z}}}))},300);return()=>clearTimeout(i)},[Y,Z,S,me]);const v=t.useCallback(i=>{if(!i.ctrlKey&&!i.metaKey||!$.current)return;const n=$.current.getBoundingClientRect(),V=(i.clientX-n.left)/n.width,M=(i.clientY-n.top)/n.height,G={id:P.current++,x:Math.max(0,Math.min(1,V)),y:Math.max(0,Math.min(1,M))};ge(O=>[...O,G])},[]),u=t.useCallback(i=>{ge(n=>n.filter(V=>V.id!==i))},[]),w=t.useCallback((i,n)=>{ge(V=>V.map(M=>M.id===i?{...M,name:n}:M))},[]),m=t.useCallback((i,n)=>{i.stopPropagation();const V=n.name?`@${n.name}`:`@ä½ç½®${n.id}`;i.dataTransfer.setData("text/plain",V),i.dataTransfer.effectAllowed="copy"},[]),N=t.useCallback((i,n)=>{i.stopPropagation();const V=`@å‚è€ƒå›¾${n+1}`;i.dataTransfer.setData("text/plain",V),i.dataTransfer.effectAllowed="copy"},[]),I=t.useCallback(i=>{i.preventDefault(),i.stopPropagation(),i.dataTransfer.dropEffect="copy"},[]),U=t.useCallback(i=>{i.preventDefault(),i.stopPropagation();const n=i.dataTransfer.getData("text/plain");if(n){const V=i.target,M=V.selectionStart,G=V.selectionEnd,O=Y.slice(0,M)+n+Y.slice(G);ae(O),setTimeout(()=>{V.selectionStart=V.selectionEnd=M+n.length,V.focus()},0)}},[Y]),y=t.useCallback(async()=>{var i;if(!(!Se||Z.length===0)){ee(!0);try{const n=await _e.ai.imageEditing.identifyPoints({image:Se,points:Z.map(V=>({id:V.id,x:V.x,y:V.y}))});if(n.success&&((i=n.data)!=null&&i.points)){const V=n.data.points;ge(M=>M.map(G=>{const O=V.find(ne=>ne.id===G.id);return O?{...G,name:O.name}:G})),f.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{f.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{ee(!1)}}},[Se,Z]),c=t.useCallback(async()=>{var i,n,V,M,G;if(!Se){f.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!Y.trim()){f.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}fe(!0),R(0);try{const O=await _e.tasks.createImageEditTask({prompt:Y.trim(),mainImage:Se,referenceImages:we.length>0?we:void 0,points:Z.length>0?Z:void 0,sourceImageDimensions:Ee||void 0,sourceNodeId:S}),ne=O.taskId,ue=O.creditsCharged||0,oe=O.isFreeUsage,h=O.freeUsageRemaining??0;if(te(ne),C({prompt:Y.trim(),points:Z,taskId:ne}),oe)f.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${h} æ¬¡æœºä¼š`),D();else if(ue>0){const{useAuthStore:d}=await us(async()=>{const{useAuthStore:b}=await import("./index-CiJ2Nd2F.js").then(J=>J.f);return{useAuthStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:j}=d.getState();await j(),f.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${ue} ç§¯åˆ†`),D()}else f.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");p(ne)}catch(O){if(fe(!1),R(0),((i=O.response)==null?void 0:i.status)===403){const ne=((V=(n=O.response)==null?void 0:n.data)==null?void 0:V.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";f.error(ne)}else{const ne=((G=(M=O.response)==null?void 0:M.data)==null?void 0:G.error)||O.message||"æœªçŸ¥åŸå› ";f.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ne}ï¼Œè¯·ç¨åé‡è¯•`)}}},[Se,Y,we,Z,Ee,S,C,p,D]);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${l?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(Ut,{type:"target",position:pt.Left,id:`${S}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(Ut,{type:"source",position:pt.Right,id:`${S}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xr,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:$,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:v,children:Se?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Se,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),Z.map(i=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-neutral-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${i.x*100}%`,top:`${i.y*100}%`},onClick:n=>{n.stopPropagation(),u(i.id)},title:i.name||`ç‚¹å‡»åˆ é™¤ #${i.id}`,children:i.id},i.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Cr,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),we.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[we.map((i,n)=>e.jsx("img",{src:i,alt:`Ref ${n+1}`,draggable:!0,onDragStart:V=>N(V,n),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},n)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",we.length," å‚è€ƒå›¾"]})]}),Z.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",Z.length,")"]}),e.jsxs("button",{onClick:y,disabled:Q||!Se,className:"text-[10px] text-neutral-500 hover:text-neutral-600 flex items-center gap-1",children:[Q?e.jsx(Ps,{className:"w-3 h-3 animate-spin"}):e.jsx(xr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:Z.map(i=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:n=>m(n,i),className:"w-5 h-5 bg-neutral-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:i.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:i.name||"",onChange:n=>w(i.id,n.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>u(i.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Hr,{className:"w-3 h-3"})})]},i.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:Y,onChange:i=>ae(i.target.value),onDragOver:I,onDrop:U,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:c,onPointerDown:i=>i.stopPropagation(),onMouseDown:i=>i.stopPropagation(),disabled:Ae||!Se||!Y.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Ae||!Se||!Y.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Ae?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!x&&(_?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(z),"æ¬¡"]}):g!==null&&g>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[g,"ç§¯åˆ†"]}):null)]})})]})]})},Zo=t.memo(Qo);async function dr(s){const{resultUrl:S,allImageUrls:l}=s;return{displayUrl:S,allDisplayUrls:l,isLocalStored:!1,originalUrl:S}}const en="gemini-3-pro-image-preview",tn=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],sn=s=>{const[S,l]=s.split(":").map(Number);return S/l},rn=(s,S)=>{const l=s/S;let F="1:1",me=1/0;for(const T of tn){const xe=sn(T),Y=Math.abs(l-xe);Y<me&&(me=Y,F=T)}return F},an=s=>new Promise((S,l)=>{const F=new Image;F.onload=()=>{S({width:F.naturalWidth,height:F.naturalHeight})},F.onerror=l,F.src=s}),on=({data:s,selected:S,id:l})=>{const[F,me]=t.useState(s.config.imageSize||"2K"),[T,xe]=t.useState(s.config.inputImage),[Y,ae]=t.useState(!!s.config.taskId),[Z,ge]=t.useState(null),Ae=t.useMemo(()=>{const P=s.models||[];return P.find(g=>g.modelId===en)||P.find(g=>{var x;return(x=g.modelId)==null?void 0:x.includes("gemini")})||P[0]},[s.models]),{credits:fe,loading:Q,isFreeUsage:ee,freeUsageRemaining:Se}=Ns({nodeType:"hd_upscale",quantity:1,resolution:F});t.useEffect(()=>{Ae&&ge(Ae)},[Ae]);const{setNodes:ie,setEdges:we,getNode:ce,getNodes:be}=Zt(),Ee=Xs(P=>P.edges.filter(g=>g.target===l));t.useEffect(()=>{const P=be();let g;Ee.forEach(x=>{var z,D,C,W,r,k,p,a;const _=P.find(v=>v.id===x.source);if(_){const v=(D=(z=_.data)==null?void 0:z.config)==null?void 0:D.uploadedFiles;if(Array.isArray(v)&&v.length>0){const u=v[0];u!=null&&u.url&&(g=u.url)}if(!g){const u=((C=_.data)==null?void 0:C.imageUrl)||((r=(W=_.data)==null?void 0:W.config)==null?void 0:r.generatedImageUrl)||((p=(k=_.data)==null?void 0:k.config)==null?void 0:p.imageUrl)||((a=_.data)==null?void 0:a.url);u&&(g=u)}}}),g!==T&&(xe(g),le({inputImage:g}))},[Ee,be]),t.useEffect(()=>{const P=s.config.taskId;(async()=>{if(P)try{const _=(await _e.tasks.getTaskStatus(P)).task;if(_.status==="SUCCESS"){ae(!1);const z=_.resultUrl;if(!z){le({taskId:""});return}const C=(await dr({taskId:P,resultUrl:z,type:"IMAGE"})).displayUrl;le({generatedImageUrl:C,taskId:""})}else _.status==="PROCESSING"||_.status==="PENDING"?(ae(!0),R(P)):_.status==="FAILURE"&&(ae(!1),le({taskId:""}),Ds.error(`ç”Ÿæˆå¤±è´¥: ${_.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ae(!1),le({taskId:""}),Ds.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const le=P=>{ie(g=>g.map(x=>x.id===l?{...x,data:{...x.data,config:{...x.data.config,...P}}}:x))},te=async()=>{var P;if(!T){Ds.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}ae(!0);try{const g=await ur(T,{skipCompression:!0});let x="1:1";try{const W=await an(T);x=rn(W.width,W.height)}catch{}let _="";try{const W=await _e.get("/node-prompts/type/hdUpscale");W.success&&((P=W.data)!=null&&P.userPromptTemplate)&&(_=W.data.userPromptTemplate)}catch{}if(_||(_="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),_=`${_}ï¼Œç”Ÿæˆ${x}æ¯”ä¾‹çš„å›¾ç‰‡`,!Z){Ds.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),ae(!1);return}const z=await _e.tasks.createImageTask({modelId:Z.id,prompt:_,ratio:x,referenceImages:[g],sourceNodeId:l,metadata:{imageSize:F,nodeType:"hd_upscale"}});if(!z.success)throw new Error(z.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const D=z.taskId,C=z.creditsCharged||0;if(le({taskId:D}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),C>0){const{useAuthStore:W}=await us(async()=>{const{useAuthStore:k}=await import("./index-CiJ2Nd2F.js").then(p=>p.f);return{useAuthStore:k}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:r}=W.getState();await r(),Ds.success(`âœ¨ é«˜æ¸…æ”¾å¤§å·²å¼€å§‹ï¼Œæ¶ˆè€— ${C} ç§¯åˆ†`)}R(D)}catch(g){Ds.error(g.message||"ç”Ÿæˆå¤±è´¥"),ae(!1)}},R=async P=>{let x=0;const _=async()=>{try{const D=(await _e.tasks.getTaskStatus(P)).task;if(D.status==="SUCCESS"){ae(!1);const C=D.resultUrl;if(!C){Ds.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const r=(await dr({taskId:P,resultUrl:C,type:"IMAGE"})).displayUrl;le({generatedImageUrl:r,taskId:"",imageSize:F}),$(r),Ds.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else D.status==="FAILURE"?(ae(!1),le({taskId:""}),Ds.error(`ç”Ÿæˆå¤±è´¥: ${D.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(D.status==="PROCESSING"||D.status==="PENDING")&&(x++,x<300?setTimeout(_,2e3):(ae(!1),Ds.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ae(!1),Ds.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};_()},$=P=>{const g=ce(l);if(!g)return;const z=be().filter(k=>k.id.startsWith(`${l}-preview`)&&k.type==="imagePreview").length,W={id:`${l}-preview-${Date.now()}`,type:"imagePreview",position:{x:g.position.x+380,y:g.position.y+z*(220+20)},data:{imageUrl:P,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:l,createdBy:g.data.createdBy}},r={id:`edge-${l}-to-${W.id}`,source:l,target:W.id,sourceHandle:`${l}-source`,type:"aurora"};ie(k=>[...k,W]),we(k=>[...k,r])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(hs,{type:"target",position:pt.Left,id:`${l}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(hs,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:T,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{me("2K"),le({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{me("4K"),le({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:te,onPointerDown:P=>P.stopPropagation(),onMouseDown:P=>P.stopPropagation(),disabled:Y||!T,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Y||!T?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Y?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"}),!Q&&(ee?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(Se),"æ¬¡"]}):fe!==null&&fe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[fe,"ç§¯åˆ†"]}):null)]})})]})]})},nn=t.memo(on),ln=async(s,S,l)=>new Promise((F,me)=>{const T=new Image;T.crossOrigin="Anonymous",T.onload=()=>{try{const xe=T.width,Y=T.height,ae=Math.floor(xe/l),Z=Math.floor(Y/S),ge=[],Ae=document.createElement("canvas");Ae.width=ae,Ae.height=Z;const fe=Ae.getContext("2d");if(!fe){me(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let Q=0;Q<S;Q++)for(let ee=0;ee<l;ee++)fe.clearRect(0,0,ae,Z),fe.drawImage(T,ee*ae,Q*Z,ae,Z,0,0,ae,Z),ge.push(Ae.toDataURL("image/png"));F({slices:ge,fullImage:s,rows:S,cols:l})}catch(xe){me(xe)}},T.onerror=()=>{me(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),T.src=s}),Br=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},cn=({data:s,selected:S,id:l})=>{const[F,me]=t.useState(null),T="single",[xe,Y]=t.useState(s.config.aspectRatio||"16:9"),[ae,Z]=t.useState(s.config.imageSize||"4K"),[ge,Ae]=t.useState(s.config.userPrompt||""),[fe,Q]=t.useState(!!s.config.taskId),[ee,Se]=t.useState(s.config.characterImages||[]),[ie,we]=t.useState(s.config.sceneImages||[]),[ce,be]=t.useState(s.config.styleImage),Ee=t.useRef(null),{setNodes:le,setEdges:te,getNode:R,getNodes:$,getEdges:P}=Zt(),g=Xs(y=>y.edges.filter(c=>c.target===l)),x=Xs(y=>y.edges.some(c=>c.target===l&&c.targetHandle===`${l}-scene-input`)),_=Xs(y=>y.edges.some(c=>c.target===l&&c.targetHandle===`${l}-style-input`)),z=t.useRef(""),{credits:D,loading:C,isFreeUsage:W,freeUsageRemaining:r}=Ns({nodeType:"image_fusion",quantity:1,resolution:ae}),k="gemini-3-pro-image-preview",p=t.useMemo(()=>{const y=s.models||[];return y.find(c=>c.modelId===k)||y.find(c=>{var i;return(i=c.modelId)==null?void 0:i.includes("gemini")})||y[0]},[s.models]);t.useEffect(()=>{p&&me(p)},[p]),t.useEffect(()=>{const y=s.config.taskId,c=s.config.generatedImageUrl;(async()=>{if(y)try{const V=(await _e.tasks.getTaskStatus(y)).task;if(V.status==="SUCCESS"){Q(!1);const M=V.resultUrl;if(!M){a({taskId:""}),f.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let G=M;c?G=c:G=(await dr({taskId:y,resultUrl:M,type:"IMAGE"})).displayUrl,a({generatedImageUrl:G,taskId:""});const O=$(),ne=P();if(O.filter(h=>h.type==="imagePreview"&&ne.some(d=>d.source===l&&d.target===h.id)).find(h=>h.data.imageUrl===G||h.data.imageUrl===M)){f.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}f.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),I(G,xe,0)}else V.status==="PROCESSING"||V.status==="PENDING"?(Q(!0),m(y)):V.status==="FAILURE"&&(Q(!1),a({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${V.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{Q(!1),a({taskId:""}),f.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ee.current&&ge){const y=Ee.current;y.style.height="auto",y.style.height=`${y.scrollHeight}px`}},[]);const a=y=>{le(c=>c.map(i=>i.id===l?{...i,data:{...i.data,config:{...i.data.config,...y}}}:i))};t.useEffect(()=>{const y=JSON.stringify(g.map(V=>({source:V.source,sourceHandle:V.sourceHandle,targetHandle:V.targetHandle})));if(y===z.current)return;z.current=y;const c=[],i=[];let n;g.forEach(V=>{const M=R(V.source);if(!M)return;const G=V.targetHandle||"",O=v(M);G.includes("character")?c.push(...O):G.includes("scene")?i.length===0&&O.length>0&&i.push(O[0]):G.includes("style")&&O.length>0&&(n=O[0])}),Se(c),we(i),be(n),a({characterImages:c,sceneImages:i,styleImage:n})},[g,R]);const v=y=>{var n,V,M,G;const c=(y==null?void 0:y.type)||"",i=y==null?void 0:y.data;if(c==="upload"&&((n=i==null?void 0:i.config)!=null&&n.uploadedFiles))return i.config.uploadedFiles.filter(O=>{var ne;return O.type==="IMAGE"||((ne=O.mimeType)==null?void 0:ne.startsWith("image/"))}).map(O=>O.url||O.localUrl);if(c==="assetSelector"&&((V=i==null?void 0:i.config)!=null&&V.selectedAsset)){const O=i.config.selectedAsset;if(O.type==="IMAGE"||(M=O.mimeType)!=null&&M.startsWith("image/"))return[O.url]}return c==="imagePreview"&&(i!=null&&i.imageUrl)?[i.imageUrl]:c==="aiImage"&&((G=i==null?void 0:i.config)!=null&&G.generatedImageUrl)?[i.config.generatedImageUrl]:[]},u=()=>{let y=ge;if(ce){const c=ee.length+ie.length+1;y+=`ï¼Œå‚è€ƒå›¾ç‰‡${c}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${c}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return y+=`ï¼Œç”Ÿæˆ${xe}æ¯”ä¾‹çš„å›¾ç‰‡`,y},w=async()=>{if(!ge.trim()){f.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!F){f.error("è¯·é€‰æ‹©æ¨¡å‹");return}Q(!0);try{const y=u(),c=[...ee,...ie,...ce?[ce]:[]],i=await Promise.all(c.map(async G=>{try{return await ur(G,{skipCompression:!0})}catch{return G}})),n=await _e.tasks.createImageTask({modelId:F.id,prompt:y,ratio:xe,referenceImages:i.filter(Boolean),sourceNodeId:l,metadata:{imageSize:ae,nodeType:"image_fusion"}});if(!n.success)throw new Error(n.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const V=n.taskId,M=n.creditsCharged||0;if(a({taskId:V}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),M>0){const{useAuthStore:G}=await us(async()=>{const{useAuthStore:ne}=await import("./index-CiJ2Nd2F.js").then(ue=>ue.f);return{useAuthStore:ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:O}=G.getState();await O(),f.success(`âœ¨ æ™ºèƒ½æº¶å›¾å·²å¼€å§‹ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†`)}m(V)}catch(y){f.error(y.message||"ç”Ÿæˆå¤±è´¥"),Q(!1)}},m=async y=>{let i=0;const n=async()=>{try{const M=(await _e.tasks.getTaskStatus(y)).task;if(M.status==="SUCCESS"){Q(!1);const G=M.resultUrl;if(!G){f.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ne=(await dr({taskId:y,resultUrl:G,type:"IMAGE"})).displayUrl;a({generatedImageUrl:ne,taskId:"",modelId:F==null?void 0:F.id,mode:T,aspectRatio:xe,imageSize:ae,userPrompt:ge}),T!=="single"||I(ne,xe,0),f.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else M.status==="FAILURE"?(Q(!1),a({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${M.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(M.status==="PROCESSING"||M.status==="PENDING")&&(i++,i<300?setTimeout(n,2e3):(Q(!1),f.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{Q(!1),f.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};n()},N=async y=>{try{const{rows:c,cols:i}=Br(T),n=await ln(y,c,i);a({slicedImages:n.slices}),n.slices.forEach((V,M)=>{I(V,xe,M)})}catch(c){f.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+c.message)}},I=(y,c,i)=>{const n=R(l);if(!n)return;const{rows:V,cols:M}=Br(T),G=V*M,O=280,ne=320,ue=20,oe=i%M,h=Math.floor(i/M),d=n.position.x+400,j=n.position.y-(G-1)*(ne+ue)/2,b={id:`${l}-preview-${i}-${Date.now()}`,type:"imagePreview",position:{x:d+oe*(O+ue),y:j+h*(ne+ue)},data:{imageUrl:y,ratio:c,label:`æº¶å›¾ ${i+1}`,fromStoryboard:!0,sourceNodeId:l}},J={id:`edge-${l}-to-${b.id}`,source:l,target:b.id,sourceHandle:`${l}-source`,type:"aurora"};le(de=>[...de,b]),te(de=>[...de,J])},U=ee.length+ie.length+(ce?1:0);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["è§’è‰² ",ee.length>0&&`(${ee.length})`]}),e.jsx(hs,{type:"target",position:pt.Left,id:`${l}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["åœºæ™¯ ",ie.length>0?"âœ“":""]}),e.jsx(hs,{type:"target",position:pt.Left,id:`${l}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!x})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["é£æ ¼ ",ce?"âœ“":""]}),e.jsx(hs,{type:"target",position:pt.Left,id:`${l}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!_})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(fs,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[U>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",U,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let y=1;const c=[];return ee.forEach(i=>{c.push({url:i,type:"char",index:y++})}),ie.forEach(i=>{c.push({url:i,type:"scene",index:y++})}),ce&&c.push({url:ce,type:"style",index:y++}),c.map(i=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:i.url,alt:`å›¾${i.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:i.index})]},`${i.type}-${i.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{Z("2K"),a({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${ae==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{Z("4K"),a({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${ae==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(y=>e.jsx("button",{onClick:()=>{Y(y),a({aspectRatio:y})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${xe===y?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:y},y))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ee,value:ge,onChange:y=>{Ae(y.target.value),a({userPrompt:y.target.value});const c=y.target;c.style.height="auto",c.style.height=`${c.scrollHeight}px`},onFocus:y=>{const c=y.target;c.style.height="auto",c.style.height=`${c.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:w,onPointerDown:y=>y.stopPropagation(),onMouseDown:y=>y.stopPropagation(),disabled:fe||!ge.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${fe||!ge.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!C&&(W?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(r),"æ¬¡"]}):D!==null&&D>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[D,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(hs,{type:"source",position:pt.Right,id:`${l}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},dn=t.memo(cn),un=["16:9","9:16"],gn="gemini-3-pro-preview",pn="gemini-3-pro-image-preview",Er=5,hn=({data:s,selected:S,id:l})=>{const[F,me]=t.useState(s.config.aspectRatio||"16:9"),[T,xe]=t.useState(s.config.inputImages||[]),[Y,ae]=t.useState(s.config.userPrompt||""),[Z,ge]=t.useState(s.config.imageStyle||""),[Ae,fe]=t.useState(s.config.autoSlice!==!1),[Q,ee]=t.useState(!!s.config.taskId),[Se,ie]=t.useState(null),[we,ce]=t.useState(null),{credits:be,loading:Ee,isFreeUsage:le,freeUsageRemaining:te}=Ns({nodeType:"smart_storyboard",quantity:1}),R=t.useMemo(()=>{const I=s.models||[];return I.find(U=>U.modelId===pn)||I.find(U=>{var y;return(y=U.modelId)==null?void 0:y.includes("gemini")})||I[0]},[s.models]);t.useEffect(()=>{R&&ce(R)},[R]);const{setNodes:$,setEdges:P,getNode:g,getNodes:x}=Zt(),_=t.useRef(null),z=t.useRef(null),D=t.useRef(null),C=t.useRef(null),W=t.useRef(x),r=t.useRef(Ae),k=Xs(I=>I.edges.filter(U=>U.target===l)),p=t.useRef("");t.useEffect(()=>{const I=x(),U=[];k.forEach(c=>{var n,V,M,G,O,ne,ue,oe;if(U.length>=Er)return;const i=I.find(h=>h.id===c.source);if(i){const h=(V=(n=i.data)==null?void 0:n.config)==null?void 0:V.uploadedFiles;Array.isArray(h)&&h.forEach(j=>{U.length>=Er||j!=null&&j.url&&!U.includes(j.url)&&U.push(j.url)});const d=((M=i.data)==null?void 0:M.imageUrl)||((O=(G=i.data)==null?void 0:G.config)==null?void 0:O.generatedImageUrl)||((ue=(ne=i.data)==null?void 0:ne.config)==null?void 0:ue.imageUrl)||((oe=i.data)==null?void 0:oe.url);d&&!U.includes(d)&&U.push(d)}});const y=U.join(",");y!==p.current&&(p.current=y,xe(U),a({inputImages:U}))},[k,x]),t.useEffect(()=>{const I=s.config.taskId,y=setTimeout(async()=>{var c,i,n,V;if(I)try{const G=(await _e.tasks.getTaskStatus(I)).task;if(G.status==="SUCCESS"){ee(!1),ie(null);const O=G.resultUrl;if(!O){(c=D.current)==null||c.call(D,{taskId:""});return}const ue=(await dr({taskId:I,resultUrl:O,type:"IMAGE"})).displayUrl;(i=D.current)==null||i.call(D,{generatedImageUrl:ue,taskId:""}),W.current().some(d=>{var j;return((j=d.data)==null?void 0:j.sourceNodeId)===l&&d.type==="imagePreview"})||(r.current&&_.current?await _.current(ue):z.current&&z.current(ue,s.config.aspectRatio||"16:9")),f.success("åˆ†é•œç”Ÿæˆå·²å®Œæˆï¼")}else G.status==="PROCESSING"||G.status==="PENDING"?(ee(!0),ie("image"),setTimeout(()=>{var O;(O=C.current)==null||O.call(C,I)},100)):G.status==="FAILURE"&&(ee(!1),ie(null),(n=D.current)==null||n.call(D,{taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${G.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ee(!1),ie(null),(V=D.current)==null||V.call(D,{taskId:""}),f.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}},200);return()=>clearTimeout(y)},[]);const a=I=>{$(U=>U.map(y=>y.id===l?{...y,data:{...y.data,config:{...y.data.config,...I}}}:y))};D.current=a,W.current=x,r.current=Ae;const v=async()=>{var I,U;if(T.length===0){f.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!Y.trim()){f.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}ee(!0),ie("text");try{const y=await Promise.all(T.map(h=>ur(h,{skipCompression:!0})));let c="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",i="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚",n=gn;try{const h=await _e.get("/node-prompts/type/smartStoryboard");if(h.success&&h.data){h.data.systemPrompt&&(c=h.data.systemPrompt),h.data.userPromptTemplate&&(i=h.data.userPromptTemplate);const j=(h.data.variables||[]).find(b=>b.name==="__textModel__");j!=null&&j.value&&(n=j.value)}}catch{}const V=h=>h.replace(/\{\{userPrompt\}\}/g,Y).replace(/\{\{imageStyle\}\}/g,Z||"").replace(/\{\{aspectRatio\}\}/g,F);c=V(c),i=V(i);const M=await _e.ai.text.generate({modelId:n,systemPrompt:c,prompt:Y,imageUrls:y,skipBilling:!0});if(!M.success)throw new Error(M.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const G=((I=M.data)==null?void 0:I.text)||((U=M.data)==null?void 0:U.content)||M.content;if(!G||typeof G!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(ie("image"),!we){f.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),ee(!1),ie(null);return}const O=`${i}

åˆ†é•œæè¿°ï¼š
${G}

ç”Ÿæˆ${F}æ¯”ä¾‹çš„å›¾ç‰‡`,ne=await _e.tasks.createImageTask({modelId:we.id,prompt:O,ratio:F,referenceImages:y,sourceNodeId:l,metadata:{imageSize:"4K",nodeType:"smart_storyboard"}});if(!ne.success)throw new Error(ne.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const ue=ne.taskId,oe=ne.creditsCharged||0;if(a({taskId:ue,userPrompt:Y}),oe>0){const{useAuthStore:h}=await us(async()=>{const{useAuthStore:j}=await import("./index-CiJ2Nd2F.js").then(b=>b.f);return{useAuthStore:j}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:d}=h.getState();await d()}setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},500),u(ue)}catch(y){f.error(y.message||"ç”Ÿæˆå¤±è´¥"),ee(!1),ie(null)}},u=async I=>{let y=0;const c=async()=>{try{const n=(await _e.tasks.getTaskStatus(I)).task;if(n.status==="SUCCESS"){ee(!1),ie(null);const V=n.resultUrl;if(!V){f.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const G=(await dr({taskId:I,resultUrl:V,type:"IMAGE"})).displayUrl;a({generatedImageUrl:G,taskId:"",aspectRatio:F}),Ae?await w(G):m(G,F),f.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else n.status==="FAILURE"?(ee(!1),ie(null),a({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${n.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(n.status==="PROCESSING"||n.status==="PENDING")&&(y++,y<300?setTimeout(c,2e3):(ee(!1),ie(null),f.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ee(!1),ie(null),f.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};c()};C.current=u;const w=async I=>{var U;try{f.info("æ­£åœ¨åˆ‡å‰²åˆ†é•œå›¾ç‰‡...");const y=await _e.post("/assets/slice-image",{imageUrl:I,rows:3,cols:3});if(!y.success||!((U=y.data)!=null&&U.urls))throw new Error(y.message||"åˆ‡å‰²å¤±è´¥");const c=y.data.urls;a({slicedImages:c}),f.success(`æˆåŠŸç”Ÿæˆ ${c.length} ä¸ªåˆ†é•œ`),N(c,F)}catch(y){f.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+y.message)}};_.current=w;const m=(I,U)=>{const y=g(l);if(!y)return;const c=Date.now(),i={id:`${l}-preview-${c}`,type:"imagePreview",position:{x:y.position.x+350,y:y.position.y},data:{imageUrl:I,ratio:U,label:"åˆ†é•œç»“æœ",fromStoryboard:!0,sourceNodeId:l,createdBy:y.data.createdBy}},n={id:`edge-${l}-to-preview-${c}`,source:l,target:i.id,sourceHandle:`${l}-source`,type:"aurora"};$(V=>[...V,i]),P(V=>[...V,n]),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},100)};z.current=m;const N=(I,U)=>{const y=g(l);if(!y)return;const c=3,i=20,n=Date.now(),V=.15;let M,G;U==="16:9"?(M=Math.round(1835*V),G=Math.round(1024*V)):(M=Math.round(1024*V),G=Math.round(1835*V));const O=y.position.x+350,ne=3*G+2*i,ue=y.position.y-ne/2+150,oe=[],h=[];I.forEach((d,j)=>{const b=Math.floor(j/c),J=j%c,de={id:`${l}-slice-${n}-${j}`,type:"imagePreview",position:{x:O+J*(M+i),y:ue+b*(G+i)},data:{imageUrl:d,ratio:U,width:M,height:G,label:`åˆ†é•œ ${j+1}`,fromStoryboard:!0,sourceNodeId:l,createdBy:y.data.createdBy}},B={id:`edge-${l}-to-slice-${n}-${j}`,source:l,target:de.id,sourceHandle:`${l}-source`,type:"aurora"};oe.push(de),h.push(B)}),$(d=>[...d,...oe]),P(d=>[...d,...h]),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},100)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${S?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(hs,{type:"target",position:pt.Left,id:`${l}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(hs,{type:"source",position:pt.Right,id:`${l}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[T.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",T.length,"/",Er,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:T.map((I,U)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:I,alt:`å›¾ç‰‡${U+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:U+1})]},U))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:Y,onChange:I=>{ae(I.target.value),a({userPrompt:I.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡é£æ ¼"}),e.jsx("input",{type:"text",value:Z,onChange:I=>{ge(I.target.value),a({imageStyle:I.target.value})},placeholder:"å¦‚ï¼šèµ›åšæœ‹å…‹ã€æ°´å½©ç”»ã€æ—¥ç³»åŠ¨æ¼«...",className:"nodrag w-full px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:un.map(I=>e.jsx("button",{onClick:()=>{me(I),a({aspectRatio:I})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${F===I?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:I},I))})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è‡ªåŠ¨åˆ‡å‰²ä¹å®«æ ¼"}),e.jsx("button",{type:"button",onClick:()=>{const I=!Ae;fe(I),a({autoSlice:I})},className:`nodrag relative w-10 h-5 rounded-full transition-colors ${Ae?"bg-neutral-800 dark:bg-white":"bg-slate-300 dark:bg-white/20"}`,disabled:s._canEdit===!1,children:e.jsx("div",{className:`absolute top-0.5 w-4 h-4 rounded-full shadow transition-transform ${Ae?"translate-x-5 bg-white dark:bg-black":"translate-x-0.5 bg-white"}`})})]}),e.jsx("button",{type:"button",onClick:I=>{I.stopPropagation(),v()},disabled:Q,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Q?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Se==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"}),!Ee&&(le?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(te),"æ¬¡"]}):be!==null&&be>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[be,"ç§¯åˆ†"]}):null)]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},fn=t.memo(hn),mn="https://api.waule.ai",xn=({isOpen:s,onClose:S,onAssetSelect:l})=>{const[F,me]=t.useState([]),[T,xe]=t.useState(""),[Y,ae]=t.useState([]),[Z,ge]=t.useState([]),[Ae,fe]=t.useState(!1),[Q,ee]=t.useState("ALL"),[Se,ie]=t.useState("ALL");t.useEffect(()=>{s&&we()},[s]),t.useEffect(()=>{T&&be(T)},[T]),t.useEffect(()=>{if(!s)return;const te=Se==="ALL"?F:F.filter(R=>(R.category||"OTHER")===Se);xe(te.length>0?te[0].id:"")},[Se,F,s]);const we=async()=>{try{const R=(await _e.assetLibraries.getAll({includeShared:"true"})).data||[];if(me(R),R.length>0&&!T){const $=Se==="ALL"?R:R.filter(P=>(P.category||"OTHER")===Se);xe(($[0]||R[0]).id)}}catch{f.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const te=R=>{var P;const $=((P=R==null?void 0:R.detail)==null?void 0:P.libraryId)||T;we(),$&&be($)};return window.addEventListener("asset-library-updated",te),()=>window.removeEventListener("asset-library-updated",te)},[T]);const ce=te=>(/^https?:\/\//.test(te)?te:`${mn}${te}`).replace(".oss-oss-",".oss-"),be=async te=>{var R,$,P,g,x;fe(!0);try{const _=F.find(D=>D.id===te);if(_&&(_.category||"OTHER")==="ROLE"){const C=(await _e.assetLibraries.roles.list(te)).data||[],W=[];for(const r of C){const k=r.metadata||{},p=[(R=k.images)==null?void 0:R.frontAssetId,($=k.images)==null?void 0:$.sideAssetId,(P=k.images)==null?void 0:P.backAssetId,(g=k.images)==null?void 0:g.faceAssetId].filter(Boolean),a=[];for(const u of p)try{const m=(await _e.assets.getById(u)).data;a.push({id:m.id,url:ce(m.url),name:m.name})}catch{}const v=r.thumbnail?ce(r.thumbnail):((x=a[0])==null?void 0:x.url)||"";W.push({id:r.id,name:r.name,coverUrl:v,images:a})}ge(W),ae([])}else{const C=(await _e.assetLibraries.getAssets(te)).data||[];ae(C),ge([])}}catch{f.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{fe(!1)}},Ee=te=>{xe(te)},le=te=>{l?(l(te),setTimeout(()=>{we(),T&&be(T)},0)):f.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:S}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-neutral-500/20 via-neutral-400/30 to-neutral-500/20"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:S,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:F.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(te=>e.jsx("button",{onClick:()=>ee(te),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${Q===te?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:te==="IMAGE"?"å›¾ç‰‡":te==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},te))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(te=>e.jsx("button",{onClick:()=>ie(te),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${Se===te?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:te==="ROLE"?"è§’è‰²":te==="SCENE"?"åœºæ™¯":te==="PROP"?"é“å…·":te==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},te))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const te=Se==="ALL"?F:F.filter(R=>(R.category||"OTHER")===Se);return e.jsx("select",{value:T,onChange:R=>Ee(R.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-neutral-500",children:te.map(R=>{var $;return e.jsxs("option",{value:R.id,children:[R.isShared?`[å…±äº«] ${R.name}`:R.name," (",R._count.assets,")",R.isShared&&(($=R.owner)!=null&&$.nickname)?` - ${R.owner.nickname}`:""]},R.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Ae?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const te=F.find(P=>P.id===T);if(te&&(te.category||"OTHER")==="ROLE")return Z.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:Z.map(P=>e.jsxs("div",{onClick:()=>l&&l(P),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[P.coverUrl?e.jsx("img",{src:P.coverUrl,alt:P.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:P.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[P.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},P.id))});const $=Y.filter(P=>Q==="ALL"||P.type===Q);return $.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:$.map(P=>e.jsxs("div",{onClick:()=>le(P),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[P.type==="IMAGE"?e.jsx("img",{src:ce(P.url),alt:P.name,className:"w-full h-full object-cover"}):P.type==="VIDEO"?e.jsx("video",{src:ce(P.url),className:"w-full h-full object-cover"}):P.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:P.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:P.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:P.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(P.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:P.type==="IMAGE"?"image":P.type==="VIDEO"?"video_file":P.type==="AUDIO"?"audio_file":"description"})})]},P.id))})})()})]})})]})]}):null},bn={agent:mo,aiImage:qa,aiVideo:gr,soraVideo:Ao,soraCharacter:To,aiVideo_t2v:Qa,aiVideo_i2v_first:eo,aiVideo_i2v_last:so,aiVideo_first_last:ao,aiVideo_reference:no,aiVideo_swap:lo,aiVideo_lipsync:uo,aiVideo_style:ho,upload:bo,assetSelector:yo,imagePreview:vo,videoPreview:jo,textPreview:So,midjourney:Eo,audioVoice:Ro,voiceClone:Mo,audioSynthesize:Lo,audioDesign:Wo,audioPreview:Go,superCanvas:zo,videoUpscale:Ho,commercialVideo:Jo,textAnnotation:Yo,imageEditing:Zo,hdUpscale:nn,imageFusion:dn,smartStoryboard:fn},wn={aurora:Po},yn=()=>{const{id:s,projectId:S,episodeId:l,workflowId:F}=ma(),me=!!F,T=xa(),xe=Ar(),Y=t.useMemo(()=>new URLSearchParams(xe.search),[xe.search]),ae=t.useMemo(()=>{const o=Number(Y.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[Y]),Z=t.useMemo(()=>{const o=Number(Y.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[Y]),ge=t.useMemo(()=>{try{const o=Y.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[Y]),{screenToFlowPosition:Ae,setCenter:fe,getViewport:Q,fitView:ee}=Zt(),{setTitle:Se}=wa(),ie=_r(o=>o.user),[we,ce]=t.useState(null),[be,Ee]=t.useState(null),[le,te]=t.useState(!0),[R,$,P]=va([]),[g,x,_]=Na([]),[z,D]=t.useState(!1),C=t.useRef(!1),[W,r]=t.useState(null),[k,p]=t.useState(null),[a,v]=t.useState(!0),u=t.useRef(null),[w,m]=t.useState(!1),N=t.useRef(null),I=t.useRef(null),[U,y]=t.useState(!1),[c,i]=t.useState(null),[n,V]=t.useState([]),[M,G]=t.useState([]),[O,ne]=t.useState(null),[ue,oe]=t.useState(null),h=t.useRef(null),d=t.useRef(null),j=O==="video",b=O==="edit",J=O==="imageEdit",de=o=>ne(null),B=o=>ne(o?"video":null),pe=o=>ne(o?"edit":null),Ce=o=>ne(o?"imageEdit":null),Ne=h,Oe=ue==="agent",Ue=o=>oe(o?"agent":null),Re=d,Te=d,se=t.useCallback(o=>{const A=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return A?A.includes("æ–‡ç”Ÿ")||A.includes("text to video")||A.includes("t2v")||A.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":A.includes("é¦–å°¾")||A.includes("first last")||A.includes("two frame")||A.includes("frame pair")||A.includes("first-last")?"é¦–å°¾å¸§":A.includes("é¦–å¸§")||A.includes("first frame")||A.includes("start frame")||A.includes("initial frame")||A.includes("keyframe")?"é¦–å¸§":A.includes("å°¾å¸§")||A.includes("last frame")||A.includes("end frame")||A.includes("final frame")?"å°¾å¸§":A.includes("ä¸»ä½“å‚è€ƒ")||A.includes("subject reference")||A.includes("å‚è€ƒ")||A.includes("reference image")||A.includes("image reference")||A.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ve=t.useMemo(()=>{const o=new Set;return(n||[]).filter(L=>(L.type||"")==="VIDEO_GENERATION").forEach(L=>{var K;(Array.isArray((K=L==null?void 0:L.config)==null?void 0:K.supportedGenerationTypes)?L.config.supportedGenerationTypes:[]).forEach(ye=>{const Me=se(ye);Me&&o.add(Me)})}),o},[n,se]),et=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),kt=t.useCallback(o=>{const A=(n||[]).filter(K=>(K.type||"")==="VIDEO_EDITING").filter(K=>{var ye;return Array.isArray((ye=K==null?void 0:K.config)==null?void 0:ye.supportedEditingCapabilities)&&K.config.supportedEditingCapabilities.includes(o)}),L=(n||[]).filter(K=>(K.type||"")==="VIDEO_GENERATION").filter(K=>{var He,We;if(o!=="è§†é¢‘æ¢äºº")return!1;const ye=((He=K==null?void 0:K.config)==null?void 0:He.supportsVideoEditing)===!0,Le=(Array.isArray((We=K==null?void 0:K.config)==null?void 0:We.supportedGenerationTypes)?K.config.supportedGenerationTypes:[]).some(rt=>se(rt)==="è§†é¢‘æ¢äºº");return ye||Le}),X={};return[...A,...L].forEach(K=>{X[K.id]||(X[K.id]=K)}),Object.values(X)},[n,se]),[vt,Nt]=t.useState(!1),[ct,ut]=t.useState(null),St=t.useRef(null),lt=t.useRef(),[Ke,It]=t.useState([]),[ze,wt]=t.useState(null),[ts,ms]=t.useState(null),[Rs,Is]=t.useState(!1),[Ss,Gs]=t.useState(null),[ks,js]=t.useState(null),[qs,nr]=t.useState(null),$t=t.useRef([]),er=t.useRef(null),[bs,Ks]=t.useState(!1),[Es,$s]=t.useState(!1),[sr,rr]=t.useState(0),Vs=t.useRef(null),q=t.useRef(null),re=t.useRef([]),$e=t.useRef([]),Ge=t.useRef(0),qe=!!l,Pe=qe&&!!ae&&!!Z,tt=me?F:Pe?`${l}-${ae}-${Z}`:qe?l:s,bt=Pe,[yt,E]=t.useState(!1),H=t.useRef(new Set),ve=t.useRef(new Set),je=t.useRef(new Set),he=t.useRef(new Set),Ie=t.useRef(new Map),nt=t.useRef(new Set),Ye=t.useCallback((o,A)=>{A!==u.current&&(H.current.add(o.id),$(L=>L.some(X=>X.id===o.id)?L:[...L,{...o,data:{...o.data,models:n}}]))},[n,$]),Mt=t.useCallback((o,A,L)=>{L!==u.current&&(nt.current.add(o),$(X=>X.map(K=>K.id===o?{...K,data:{...K.data,...A}}:K)),setTimeout(()=>nt.current.delete(o),100))},[$]),st=t.useCallback((o,A)=>{A!==u.current&&($(L=>L.filter(X=>X.id!==o)),x(L=>L.filter(X=>X.source!==o&&X.target!==o)))},[$,x]),Be=t.useCallback((o,A,L)=>{L!==u.current&&$(X=>X.map(K=>K.id===o?{...K,position:A}:K))},[$]),Dt=t.useCallback((o,A)=>{A!==u.current&&$(L=>L.map(X=>{const K=o.find(ye=>ye.id===X.id);return K?{...X,position:K.position}:X}))},[$]),Xt=t.useCallback((o,A)=>{A!==u.current&&(ve.current.add(o.id),x(L=>L.some(X=>X.id===o.id)?L:[...L,o]))},[x]),jt=t.useCallback((o,A)=>{A!==u.current&&x(L=>L.filter(X=>X.id!==o))},[x]),Ct=t.useCallback((o,A)=>{A!==u.current&&(It(o),$t.current=o)},[]),{emitNodeAdd:Tt,emitNodeUpdate:Pt,emitNodeDelete:qt,emitNodesMove:Bt,emitEdgeAdd:rs,emitEdgeDelete:gs,emitGroupsUpdate:Ws,onlineUsers:tr}=za({workflowId:N.current,isSharedWorkflow:w,isReadOnly:z,onNodeAdd:Ye,onNodeUpdate:Mt,onNodeDelete:st,onNodeMove:Be,onNodesMove:Dt,onEdgeAdd:Xt,onEdgeDelete:jt,onGroupsUpdate:Ct});t.useEffect(()=>{$t.current=Ke},[Ke]),t.useEffect(()=>{re.current=R,Ge.current=R.length},[R]),t.useEffect(()=>{$e.current=g},[g]),t.useEffect(()=>{if(!yt){je.current=new Set(R.map(K=>K.id));const X=new Map;R.forEach(K=>{var ye;try{X.set(K.id,JSON.stringify(((ye=K.data)==null?void 0:ye.config)||{}))}catch{X.set(K.id,"{}")}}),Ie.current=X;return}if(!w||C.current){je.current=new Set(R.map(X=>X.id));return}const o=new Set(R.map(X=>X.id)),A=je.current;R.forEach(X=>{var K,ye;if(!A.has(X.id))H.current.has(X.id)||Tt(X);else if(!nt.current.has(X.id))try{const Me=JSON.stringify(((K=X.data)==null?void 0:K.config)||{}),Le=Ie.current.get(X.id)||"{}";Me!==Le&&Pt(X.id,{config:(ye=X.data)==null?void 0:ye.config})}catch{}}),je.current=o;const L=new Map;R.forEach(X=>{var K;try{L.set(X.id,JSON.stringify(((K=X.data)==null?void 0:K.config)||{}))}catch{L.set(X.id,"{}")}}),Ie.current=L,H.current=new Set([...H.current].filter(X=>o.has(X)))},[R,w,yt,Tt,Pt]),t.useEffect(()=>{if(!yt){he.current=new Set(g.map(L=>L.id));return}if(!w||C.current){he.current=new Set(g.map(L=>L.id));return}const o=new Set(g.map(L=>L.id)),A=he.current;g.forEach(L=>{A.has(L.id)||ve.current.has(L.id)||rs(L)}),he.current=o,ve.current=new Set([...ve.current].filter(L=>o.has(L)))},[g,w,yt,rs]);const Fs=t.useCallback(o=>{var K;if(C.current)return!1;if(a)return!0;if($t.current.some(ye=>{var Me;return!ye.hidden&&((Me=ye.nodeIds)==null?void 0:Me.includes(o.id))}))return!1;if(Pe)return!0;const L=(K=o.data)==null?void 0:K.createdBy;return(typeof L=="object"?L==null?void 0:L.id:L)===u.current},[a,Pe]),ws=t.useMemo(()=>{const o=new Set(Ke.filter(A=>!A.hidden).flatMap(A=>A.nodeIds||[]));return R.map(A=>{const L=o.has(A.id),X=L?!1:a?!0:Fs(A);return{...A,draggable:A.draggable!==!1,connectable:L?!1:A.connectable!==!1,data:{...A.data,_canEdit:X,_isGrouped:L,_currentUserId:k,_isSharedWorkflow:w}}})},[R,Ke,a,Fs,k,w,z]),zt=t.useRef(null),ls=t.useRef(new Map),os=t.useCallback(o=>{if(C.current){P(o);return}const A=o.filter(X=>{var He;if(X.type!=="position")return!0;if($t.current.find(We=>{var rt;return!We.hidden&&((rt=We.nodeIds)==null?void 0:rt.includes(X.id))}))return a;if(a)return!0;const ye=re.current.find(We=>We.id===X.id);if(!ye)return!0;const Me=(He=ye.data)==null?void 0:He.createdBy;return(typeof Me=="object"?Me==null?void 0:Me.id:Me)===u.current});P(A);const L=A.filter(X=>X.type==="position"&&X.position);L.length>0&&(L.forEach(X=>{ls.current.set(X.id,X.position)}),zt.current&&clearTimeout(zt.current),zt.current=setTimeout(()=>{const X=Array.from(ls.current.entries()).map(([K,ye])=>({id:K,position:ye}));X.length>0&&(Bt(X),ls.current.clear())},100))},[a,P,Bt]);t.useEffect(()=>{er.current=ks},[ks]),t.useEffect(()=>{const o=A=>{A.key==="Escape"&&(bs&&Ks(!1),Es&&$s(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,Es]),t.useEffect(()=>{tt&&(y(!1),E(!1),pr(),zs(),Jr(),Kt().finally(()=>{E(!0)}))},[tt]),t.useEffect(()=>{if(!le&&!U&&R.length>0){const o=setTimeout(()=>{ee({padding:.1,duration:800,maxZoom:1.5}),y(!0)},100);return()=>clearTimeout(o)}},[le,U,R.length,ee]),t.useEffect(()=>{var X;if(!Pe||!be||!we||!yt)return;const o=Ke.find(K=>K.scene===ae&&K.shot===Z),A=`${ae}-${Z}`;if(o){ms(o.id),wt(o.id);try{if(I.current===A)return;if(Array.isArray(ge)&&ge.length>0){I.current=A;const K=R,ye=[],Me=280,Le=320,He=350,We={role:0,scene:0,prop:0,audio:0};K.forEach(De=>{var ft;if(De.type==="assetSelector"){const Vt=((ft=De.data)==null?void 0:ft.label)||"";Vt.startsWith("è§’è‰²")?We.role++:Vt.startsWith("åœºæ™¯")?We.scene++:Vt.startsWith("é“å…·")?We.prop++:Vt.startsWith("éŸ³é¢‘")&&We.audio++}});const rt={...We},Xe=[];ge.forEach((De,ft)=>{const Vt=De.thumbnail||De.url||"";let Lt=null;const Wt=K.some(ot=>{var Gt,Qe;if(ot.type!=="assetSelector")return!1;const Ze=(Gt=ot.data)==null?void 0:Gt.config,ke=Ze==null?void 0:Ze.selectedAsset;if((ke==null?void 0:ke.id)===De.id)return Lt=ot.id,!0;const Je=((Qe=ot.data)==null?void 0:Qe.label)||"",At=De.type==="role"?"è§’è‰²":De.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${At}: ${De.name}`||(ke==null?void 0:ke.name)===De.name?(Lt=ot.id,!0):!1});if(Wt&&Lt&&Vt&&Xe.push({nodeId:Lt,newUrl:Vt}),Wt)return;const ht=De.type,mt=ht==="role"?0:ht==="scene"?1:ht==="prop"?2:3,Et=rt[ht]||0;rt[ht]=(rt[ht]||0)+1;const Ht={x:mt*Me,y:He+Et*Le},dt=De.thumbnail||De.url||"",Fe=`assetSelector-${Date.now()}-${ft}`,it=ht==="role"?"è§’è‰²":ht==="scene"?"åœºæ™¯":ht==="prop"?"é“å…·":"éŸ³é¢‘",gt=De.metadata,at=ht==="role"&&(gt==null?void 0:gt.images);let Jt=[];if(at){const ot=gt.images;ot.frontUrl&&Jt.push({id:"front",url:ot.frontUrl,name:`${De.name}-æ­£é¢`}),ot.sideUrl&&Jt.push({id:"side",url:ot.sideUrl,name:`${De.name}-ä¾§é¢`}),ot.backUrl&&Jt.push({id:"back",url:ot.backUrl,name:`${De.name}-èƒŒé¢`}),ot.faceUrl&&Jt.push({id:"face",url:ot.faceUrl,name:`${De.name}-é¢éƒ¨`})}let Ot;at&&Jt.length>0?Ot={selectedInput:{id:De.id,name:De.name,coverUrl:dt,images:Jt}}:ht==="audio"?Ot={selectedAsset:{id:De.id,name:De.name,originalName:De.name,url:De.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:Ot={selectedAsset:{id:De.id,name:De.name,originalName:De.name,url:dt,type:"IMAGE",mimeType:"image/png",size:0}},ye.push({id:Fe,type:"assetSelector",position:Ht,data:{id:Fe,label:`${it}: ${De.name}`,config:Ot,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:o,nodeGroups:Ke}}})}),Xe.length>0&&$(De=>De.map(ft=>{var Lt;const Vt=Xe.find(Wt=>Wt.nodeId===ft.id);if(Vt&&ft.type==="assetSelector"){const Wt=((Lt=ft.data)==null?void 0:Lt.config)||{},ht=Wt.selectedAsset||{};return{...ft,data:{...ft.data,config:{...Wt,selectedAsset:{...ht,url:Vt.newUrl}}}}}return ft})),ye.length>0&&$(De=>[...De,...ye])}}catch{}return}if(I.current===A)return;const L={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${ae}å¹•-ç¬¬${Z}é•œ`,scene:ae,shot:Z,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};It(K=>[...K,L]),$t.current=[...$t.current,L],ms(L.id),wt(L.id),I.current=A;try{const K=((X=be==null?void 0:be.scriptJson)==null?void 0:X.acts)||[],ye=Array.isArray(K)?K.find(Fe=>Number(Fe.actIndex)===Number(ae)):null,Me=ye?(ye.shots||[]).find(Fe=>Number(Fe.shotIndex)===Number(Z)):null,He=Me?[`ç”»é¢ï¼š${(Me.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(Me["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(Me["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(Me["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(Me.æ—¶é•¿||"").trim()}`].join(`
`):"",We=Me&&(Me.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,De=280,ft=320,Vt=350,Lt={x:0,y:0},Wt={x:rt+Xe,y:0},ht=`textPreview-${Date.now()}-a`,mt=`textPreview-${Date.now()}-b`,Et=[{id:ht,type:"textPreview",position:Lt,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:ht,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:L,nodeGroups:[...Ke,L]}}},{id:mt,type:"textPreview",position:Wt,data:{content:We||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:mt,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:L,nodeGroups:[...Ke,L]}}}],Ht=[];if(Array.isArray(ge)&&ge.length>0){const Fe={role:0,scene:0,prop:0,audio:0};ge.forEach((it,gt)=>{const at=it.type,Jt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,Ot=Fe[at]||0;Fe[at]=(Fe[at]||0)+1;const ot={x:Jt*De,y:Vt+Ot*ft},Ze=`assetSelector-${Date.now()}-${gt}`;Ht.push(Ze);const ke=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=it.thumbnail||it.url||"",At=it.metadata,Gt=at==="role"&&(At==null?void 0:At.images);let Qe=[];if(Gt){const xt=At.images;xt.frontUrl&&Qe.push({id:"front",url:xt.frontUrl,name:`${it.name}-æ­£é¢`}),xt.sideUrl&&Qe.push({id:"side",url:xt.sideUrl,name:`${it.name}-ä¾§é¢`}),xt.backUrl&&Qe.push({id:"back",url:xt.backUrl,name:`${it.name}-èƒŒé¢`}),xt.faceUrl&&Qe.push({id:"face",url:xt.faceUrl,name:`${it.name}-é¢éƒ¨`})}let _t;Gt&&Qe.length>0?_t={selectedInput:{id:it.id,name:it.name,coverUrl:Je,images:Qe}}:at==="audio"?_t={selectedAsset:{id:it.id,name:it.name,originalName:it.name,url:it.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:_t={selectedAsset:{id:it.id,name:it.name,originalName:it.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},Et.push({id:Ze,type:"assetSelector",position:ot,data:{id:Ze,label:`${ke}: ${it.name}`,config:_t,freeDrag:!0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:L,nodeGroups:[...Ke,L]}}})})}$(Fe=>[...Fe,...Et]);const dt=[ht,mt,...Ht];It(Fe=>Fe.map(it=>{if(it.id!==L.id)return it;const gt=Array.from(new Set([...it.nodeIds||[],...dt])),at=it.bounds;return{...it,nodeIds:gt,bounds:at}})),$t.current=$t.current.map(Fe=>{if(Fe.id!==L.id)return Fe;const it=Array.from(new Set([...Fe.nodeIds||[],...dt])),gt=Fe.bounds;return{...Fe,nodeIds:it,bounds:gt}})}catch{}},[qe,ae,Z,be,we,Ke,$,yt,ge]),t.useEffect(()=>{if(we)if(qe&&be){const o=`${we.name} - ${be.name||`ç¬¬${be.episodeNumber}é›†`}`,A=ae&&Z?`ç¬¬${ae}å¹•ç¬¬${Z}é•œ`:"";Se(Pe?o:`${o} ${A}`.trim())}else Se(we.name);return()=>Se("")},[we,be,qe,Pe,ae,Z,Se]),t.useEffect(()=>{if(!(!tt||le||C.current))return lt.current&&clearTimeout(lt.current),lt.current=setTimeout(()=>{ps()},2e3),()=>{lt.current&&clearTimeout(lt.current)}},[R,g,Ke]);const Kt=async()=>{var o,A,L,X,K,ye;try{let Me;if(me&&F)Me=await _e.workflows.getById(F);else if(Pe)Me=await _e.workflows.getOrCreateByShot(S,l,ae,Z);else if(qe)Me=await _e.workflows.getOrCreateByEpisode(S,l);else{if(!s)return;Me=await _e.workflows.getOrCreateByProject(s)}const Le=Me.data;Le.canEdit===!1||Le.canEdit===void 0&&Le.isOwner===!1?(D(!0),C.current=!0,(o=Le.shareInfo)!=null&&o.owner&&r(Le.shareInfo.owner)):(D(!1),C.current=!1,r(null)),Le.currentUserId&&(p(Le.currentUserId),u.current=Le.currentUserId);const We=Le.isOwner!==!1||Pe&&Le.canEdit===!0;v(We);const rt=me||Le.hasCollaborators===!0;if(m(rt),N.current=Le.id,me&&ce({id:Le.projectId||F,name:Le.name||"å…±äº«å·¥ä½œæµ",description:Le.description,type:"QUICK",status:"DRAFT"}),Le.data){const{nodes:Xe,edges:De,nodeGroups:ft}=Le.data;if(ft&&ft.length>0&&(It(ft),$t.current=ft),Xe&&Xe.length>0){let Vt=Xe;if(Pe&&((A=be==null?void 0:be.scriptJson)!=null&&A.acts))try{const Et=be.scriptJson.acts.find(Fe=>Number(Fe.actIndex)===Number(ae)),Ht=(L=Et==null?void 0:Et.shots)==null?void 0:L.find(Fe=>Number(Fe.shotIndex)===Number(Z)),dt=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(Fe=>{Fe.nodeId&&dt.add(Fe.nodeId)}),(X=Ht.media)!=null&&X.nodeId&&dt.add(Ht.media.nodeId)),Vt=Xe.map(Fe=>{var it;return Fe.type==="videoPreview"&&((it=Fe.data)!=null&&it.addedToStoryboard)&&!dt.has(Fe.id)?{...Fe,data:{...Fe.data,addedToStoryboard:!1}}:Fe})}catch{}let Lt;if(Pe&&((K=be==null?void 0:be.scriptJson)!=null&&K.acts))try{const Et=be.scriptJson.acts.find(dt=>Number(dt.actIndex)===Number(ae)),Ht=(ye=Et==null?void 0:Et.shots)==null?void 0:ye.find(dt=>Number(dt.shotIndex)===Number(Z));Lt=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Wt=new Set((ft||[]).filter(mt=>!mt.hidden).flatMap(mt=>mt.nodeIds||[])),ht=Vt.map(mt=>{const Et=ft?ft.find(Fe=>Fe.nodeIds.includes(mt.id)):null,Ht=n.length>0?n:mt.data.models||[],dt=mt.type==="agent"&&Lt?{...mt.data,output:Lt,lastOutput:Lt}:mt.data;return{...mt,data:{...dt,models:Ht,onOpenAssetPanel:mt.type==="assetSelector"?mt.data.onOpenAssetPanel||ar:mt.data.onOpenAssetPanel,workflowContext:{project:we,episode:be,nodeGroup:Et,nodeGroups:ft||[]}},draggable:mt.draggable!==!1,connectable:Wt.has(mt.id)?!1:mt.connectable!==!1,deletable:Wt.has(mt.id)?!1:mt.deletable!==!1}});$(ht)}if(De&&De.length>0){const Vt=new Set(Xe.map(ht=>ht.id)),Lt=new Map(Xe.map(ht=>[ht.id,ht.type])),Wt=De.filter(ht=>{if(!Vt.has(ht.source)||!Vt.has(ht.target))return!1;const mt=Lt.get(ht.target),Et=Lt.get(ht.source);return!(mt==="midjourney"&&ht.targetHandle==="text-input"&&Et!=="agent")}).map(ht=>({...ht,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:ht.targetHandle||void 0}));x(Wt)}}}catch{}};t.useEffect(()=>{n.length>0&&R.length>0&&$(o=>o.map(A=>({...A,data:{...A.data,models:n},draggable:A.draggable!==void 0?A.draggable:!0,deletable:A.deletable!==void 0?A.deletable:!0})))},[n,R.length]),t.useEffect(()=>{if(!we&&!be||R.length===0)return;if(R.some(A=>{var Me,Le;const L=A.data.workflowContext,X=((Me=L==null?void 0:L.project)==null?void 0:Me.id)!==(we==null?void 0:we.id),K=((Le=L==null?void 0:L.episode)==null?void 0:Le.id)!==(be==null?void 0:be.id),ye=(L==null?void 0:L.nodeGroups)!==$t.current;return!L||X||K||ye})){const A=ae&&Z&&$t.current.find(L=>L.scene===ae&&L.shot===Z)||null;$(L=>L.map(X=>{const K=$t.current.find(Me=>Me.nodeIds.includes(X.id))||null,ye=A||K;return{...X,data:{...X.data,workflowContext:{project:we,episode:be,nodeGroup:ye,nodeGroups:$t.current}}}}))}},[we,be,ae,Z,R.length,Ke]);const Yt=async(o,A,L)=>{var X;if(!(!S||!l))try{const K=o.find(We=>We.type==="agent");if(!K)return;const ye=((X=K.data)==null?void 0:X.output)||"",Le=(await _e.episodes.getById(S,l)).scriptJson;if(!Le||!Le.acts)return;const He=Le.acts.map(We=>{var rt;return We.actIndex===A?{...We,shots:(rt=We.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===L&&Xe.æç¤ºè¯!==ye?{...Xe,æç¤ºè¯:ye}:Xe)}:We});await _e.episodes.update(S,l,{scriptJson:{acts:He}})}catch{}},Cs=async()=>{if(!(z||C.current)&&!(re.current.length===0&&$e.current.length===0))try{const o=re.current.map(L=>{const{data:X,...K}=L,{workflowContext:ye,_canEdit:Me,_currentUserId:Le,...He}=X||{};return{...K,data:He}}),A=$e.current.map(L=>({id:L.id,source:L.source,target:L.target,sourceHandle:L.sourceHandle,targetHandle:L.targetHandle,type:L.type}));if(Pe){await _e.workflows.saveShot(S,l,ae,Z,{nodes:o,edges:A,nodeGroups:$t.current,viewport:{x:0,y:0,zoom:1}});try{await Yt(re.current,ae,Z)}catch{}}else qe?await _e.workflows.saveEpisode(S,l,{nodes:o,edges:A,nodeGroups:$t.current,viewport:{x:0,y:0,zoom:1}}):me&&F?await _e.workflows.update(F,{data:{nodes:o,edges:A,nodeGroups:$t.current,viewport:{x:0,y:0,zoom:1}}}):s&&await _e.workflows.save(s,{nodes:o,edges:A,nodeGroups:$t.current,viewport:{x:0,y:0,zoom:1}})}catch{}},ys=t.useRef(null),ps=t.useCallback(()=>{ys.current&&clearTimeout(ys.current),ys.current=setTimeout(()=>{Cs()},2e3)},[]);t.useEffect(()=>{const o=A=>{if(C.current)return;lt.current&&clearTimeout(lt.current);const X=A.detail;X!=null&&X.nodeId&&(X!=null&&X.config)&&(re.current=re.current.map(K=>{var ye;return K.id===X.nodeId?{...K,data:{...K.data,config:{...((ye=K.data)==null?void 0:ye.config)||{},...X.config}}}:K})),setTimeout(()=>{Cs()},100)};return window.addEventListener("workflow:save",o),()=>{window.removeEventListener("workflow:save",o)}},[]),t.useEffect(()=>{if(we||be){let o=$t.current;Pe&&ae&&Z&&(o=$t.current.filter(A=>A.scene===ae&&A.shot===Z)),window.__workflowContext={project:we,episode:be,nodeGroups:o}}},[we,be,Ke,Pe,ae,Z]);const pr=async()=>{try{if(me){window.__workflowContext={project:null,episode:null,nodeGroups:$t.current};return}if(qe){const[o,A]=await Promise.all([_e.episodes.getById(S,l),_e.projects.getById(S)]);Ee(o.data),ce(A.data);let L=$t.current;Pe&&ae&&Z&&(L=$t.current.filter(X=>X.scene===ae&&X.shot===Z)),window.__workflowContext={project:A.data,episode:o.data,nodeGroups:L}}else{const o=await _e.projects.getById(s);ce(o.data);let A=$t.current;Pe&&ae&&Z&&(A=$t.current.filter(L=>L.scene===ae&&L.shot===Z)),window.__workflowContext={project:o.data,episode:null,nodeGroups:A}}}catch{f.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),T("/quick")}finally{te(!1)}},zs=async()=>{try{const o=await _e.get("/ai/models",{params:{isActive:"true"}});V(o||[])}catch{}};t.useEffect(()=>{$(o=>o.map(A=>{const L=String(A.type||"");return!L.startsWith("aiVideo")&&L!=="audioVoice"&&L!=="voiceClone"&&L!=="audioSynthesize"&&L!=="audioDesign"?A:{...A,data:{...A.data,models:n}}}))},[n,$]);const Jr=async()=>{try{const A=(await _e.agents.getAll()).filter(L=>L.isActive&&(!L.usageScene||L.usageScene==="workflow"));G(A)}catch{}};t.useEffect(()=>{$(o=>o.map(A=>{var Le,He,We,rt,Xe;if(A.type!=="agent")return A;const L=(He=(Le=A.data)==null?void 0:Le.config)==null?void 0:He.agentId,X=M.find(De=>De.id===L),K=X==null?void 0:X.aiModelId,ye=n.find(De=>De.id===K);let Me=(We=ye==null?void 0:ye.config)==null?void 0:We.acceptedInputs;if((!Me||Me.length===0)&&ye){const De=(ye.provider||"").toLowerCase(),ft=(ye.name||"").toLowerCase();(De.includes("google")||ft.includes("gemini"))&&(Me=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(Me)&&Me.length>0){const De=(Xe=(rt=A.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,ft=Vt=>Vt.map(Lt=>Lt.toUpperCase()).sort().join(",");if(!De||ft(De)!==ft(Me))return{...A,data:{...A.data,config:{...A.data.config,acceptedInputs:Me}}}}return A}))},[M,n,$]);const qr=t.useCallback(o=>{var Le,He,We,rt,Xe,De,ft,Vt,Lt,Wt,ht,mt,Et,Ht,dt,Fe,it;es.current=!1;const A=$t.current.some(gt=>{var at;return!gt.hidden&&((at=gt.nodeIds)==null?void 0:at.includes(o.source||""))}),L=$t.current.some(gt=>{var at;return!gt.hidden&&((at=gt.nodeIds)==null?void 0:at.includes(o.target||""))});if(A||L){f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),es.current=!1;return}const X=R.find(gt=>gt.id===o.source),K=R.find(gt=>gt.id===o.target);if(X&&K){const gt=Ot=>{var ke,Je,At;const ot=Ot.type,Ze=Ot.data;if(ot==="upload"&&Array.isArray((ke=Ze.config)==null?void 0:ke.uploadedFiles)&&Ze.config.uploadedFiles.length>0){const Gt=Ze.config.uploadedFiles,Qe=Gt.some(Rt=>{const Qt=((Rt==null?void 0:Rt.type)||"").toUpperCase(),vs=((Rt==null?void 0:Rt.mimeType)||"").toLowerCase();return Qt==="VIDEO"||vs.startsWith("video/")}),_t=Gt.some(Rt=>{const Qt=((Rt==null?void 0:Rt.type)||"").toUpperCase(),vs=((Rt==null?void 0:Rt.mimeType)||"").toLowerCase();return Qt==="IMAGE"||vs.startsWith("image/")}),xt=Gt.some(Rt=>{const Qt=((Rt==null?void 0:Rt.type)||"").toUpperCase(),vs=((Rt==null?void 0:Rt.mimeType)||"").toLowerCase();return Qt==="AUDIO"||vs.startsWith("audio/")});return(K==null?void 0:K.type)==="aiVideo_swap"?Qe?"VIDEO":_t?"IMAGE":xt?"AUDIO":null:_t?"IMAGE":Qe?"VIDEO":xt?"AUDIO":null}if(ot==="assetSelector"){if((Je=Ze.config)!=null&&Je.subjects)return"IMAGE";if((At=Ze.config)!=null&&At.selectedAsset){const Gt=Ze.config.selectedAsset,Qe=(Gt.type||"").toUpperCase(),_t=(Gt.mimeType||"").toLowerCase();return Qe==="IMAGE"||_t.startsWith("image/")?"IMAGE":Qe==="VIDEO"||_t.startsWith("video/")?"VIDEO":Qe==="AUDIO"||_t.startsWith("audio/")?"AUDIO":Qe||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=gt(X);let Jt=(Le=K.data.config)==null?void 0:Le.acceptedInputs;if(K.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const Ot={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};f.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${Ot[at]||at}è¾“å…¥`),es.current=!1;return}if((!Jt||Jt.length===0)&&K.data.type==="agent"){const Ot=(He=K.data.config)==null?void 0:He.agentId,ot=M.find(At=>At.id===Ot),Ze=ot==null?void 0:ot.aiModelId,ke=n.find(At=>At.id===Ze),Je=(We=ke==null?void 0:ke.config)==null?void 0:We.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)Jt=Je;else{const At=((rt=ke==null?void 0:ke.provider)==null?void 0:rt.toLowerCase())||"",Gt=((ke==null?void 0:ke.name)||"").toLowerCase();(At.includes("google")||Gt.includes("gemini"))&&(Jt=["TEXT","IMAGE","DOCUMENT"])}}if(K.type!=="agent"){if(!K.type.startsWith("aiVideo")&&Jt&&Jt.length>0&&at){const Ot=Jt.map(Ze=>typeof Ze=="string"?Ze.toUpperCase():Ze),ot=typeof at=="string"?at.toUpperCase():at;if(!Ot.includes(ot)){const Ze={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};f.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${Ze[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${Ot.map(ke=>Ze[ke]||ke).join("ã€")}ï¼‰`),es.current=!1;return}}}if(K.type==="aiVideo_swap"){const Ot=g.filter(At=>At.target===K.id),ot=Ot.filter(At=>{const Gt=R.find(_t=>_t.id===At.source);return gt(Gt)==="VIDEO"}).length,Ze=Ot.filter(At=>{const Gt=R.find(_t=>_t.id===At.source);return gt(Gt)==="IMAGE"}).length,ke=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="IMAGE"?1:0);if(ke>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){f.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),es.current=!1;return}}if(K.type==="aiVideo_lipsync"){const Ot=g.filter(Gt=>Gt.target===K.id),ot=Ot.filter(Gt=>{const Qe=R.find(xt=>xt.id===Gt.source);return gt(Qe)==="VIDEO"}).length,Ze=Ot.filter(Gt=>{const Qe=R.find(xt=>xt.id===Gt.source);return gt(Qe)==="AUDIO"}).length,ke=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="AUDIO"?1:0),At=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ke>1||Je>1||!At){f.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),es.current=!1;return}}if(K.type.startsWith("aiVideo")&&K.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(Ze=>{const ke=(Ze||"").toLowerCase().replace(/[_\-\s]+/g," ");return ke?ke.includes("æ–‡ç”Ÿ")||ke.includes("text to video")||ke.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")||ke.includes("first last")||ke.includes("two frame")||ke.includes("frame pair")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")||ke.includes("first frame")||ke.includes("start frame")||ke.includes("initial frame")||ke.includes("keyframe")?"é¦–å¸§":ke.includes("å°¾å¸§")||ke.includes("last frame")||ke.includes("end frame")||ke.includes("final frame")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")||ke.includes("subject reference")||ke.includes("å‚è€ƒ")||ke.includes("reference image")||ke.includes("image reference")||ke.includes("ref image")?"å‚è€ƒå›¾":Ze||"":""})((De=(Xe=K.data)==null?void 0:Xe.config)==null?void 0:De.generationType);if(K.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){f.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),es.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&X.type==="assetSelector"){const Ze=((ft=X.data)==null?void 0:ft.config)||{};if(Ze.subjects&&Ze.subjects.length>0&&(Ze.subjects[0].images||[]).length>1){f.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),es.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&X.type==="assetSelector"){const Ze=((Vt=X.data)==null?void 0:Vt.config)||{};if(Ze.subjects&&Ze.subjects.length>0){f.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),es.current=!1;return}}}if(K.type==="aiVideo_style"){const Ze=g.filter(ke=>ke.target===K.id).filter(ke=>{const Je=R.find(Gt=>Gt.id===ke.source);return gt(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){f.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),es.current=!1;return}if(Ze>1){f.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),es.current=!1;return}}if(K.type.startsWith("aiVideo")&&at==="TEXT"&&g.filter(Ze=>Ze.target===K.id).find(Ze=>{const ke=R.find(Je=>Je.id===Ze.source);return(ke==null?void 0:ke.type)==="agent"})){f.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),es.current=!1;return}if(K.type==="aiImage"){if(at==="TEXT"){if(g.filter(Ze=>Ze.target===K.id).some(Ze=>{const ke=R.find(Je=>Je.id===Ze.source);return(ke==null?void 0:ke.type)==="agent"})){f.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),es.current=!1;return}}else if(at==="IMAGE"){const ot=g.filter(Qe=>Qe.target===K.id).reduce((Qe,_t)=>{var Qt,vs,ss,Ms,As,Dr,Lr;const xt=R.find(ds=>ds.id===_t.source),Rt=(xt==null?void 0:xt.type)||"";if(Rt==="upload"){const ds=((ss=(vs=(Qt=xt==null?void 0:xt.data)==null?void 0:Qt.config)==null?void 0:vs.uploadedFiles)==null?void 0:ss[0])||null,ha=((ds==null?void 0:ds.type)||"").toUpperCase(),fa=((ds==null?void 0:ds.mimeType)||"").toLowerCase();return Qe+(ha==="IMAGE"||fa.startsWith("image/")?1:0)}if(Rt==="assetSelector"){const ds=((Ms=xt==null?void 0:xt.data)==null?void 0:Ms.config)||{};return ds.selectedAsset&&(Qe+=(ds.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ds.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(ds.subjects)&&ds.subjects.length>0?Qe+((ds.subjects[0].images||[]).length||0):Qe}if(Rt==="aiImage"){const ds=(Dr=(As=xt==null?void 0:xt.data)==null?void 0:As.config)==null?void 0:Dr.generatedImageUrl;return Qe+(ds?1:0)}if(Rt==="imagePreview"){const ds=(Lr=xt==null?void 0:xt.data)==null?void 0:Lr.imageUrl;return Qe+(ds?1:0)}return Qe},0);let Ze=1;if(X.type==="assetSelector"){const Qe=((Lt=X==null?void 0:X.data)==null?void 0:Lt.config)||{};Qe.selectedAsset?Ze=(Qe.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Qe.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Qe.subjects)&&Qe.subjects.length>0&&(Ze=(Qe.subjects[0].images||[]).length||0)}else if(X.type==="upload"){const Qe=((mt=(ht=(Wt=X==null?void 0:X.data)==null?void 0:Wt.config)==null?void 0:ht.uploadedFiles)==null?void 0:mt[0])||null,_t=((Qe==null?void 0:Qe.type)||"").toUpperCase(),xt=((Qe==null?void 0:Qe.mimeType)||"").toLowerCase();Ze=_t==="IMAGE"||xt.startsWith("image/")?1:0}else X.type==="aiImage"?Ze=((Ht=(Et=X==null?void 0:X.data)==null?void 0:Et.config)==null?void 0:Ht.generatedImageUrl)?1:0:X.type==="imagePreview"&&(Ze=((dt=X==null?void 0:X.data)==null?void 0:dt.imageUrl)?1:0);const ke=(it=(Fe=K==null?void 0:K.data)==null?void 0:Fe.config)==null?void 0:it.modelId,Je=n.find(Qe=>Qe.id===ke),At=(Je==null?void 0:Je.config)||{},Gt=At.maxReferenceImages||At.supportedReferenceImagesLimit||At.referenceImagesLimit||10;if(ot+Ze>Gt){f.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Gt}å¼ ï¼‰`),es.current=!1;return}}}}try{const gt=R.find(ot=>ot.id===o.target),at=R.find(ot=>ot.id===o.source),Jt=ot=>{var ke,Je,At,Gt;if(!ot)return null;const Ze=String(ot.type||"").toLowerCase();if(Ze==="upload"){const Qe=(((Je=(ke=ot.data)==null?void 0:ke.config)==null?void 0:Je.uploadedFiles)||[]).find(_t=>{const xt=((_t==null?void 0:_t.type)||"").toUpperCase(),Rt=((_t==null?void 0:_t.mimeType)||"").toLowerCase();return xt==="AUDIO"||Rt.startsWith("audio/")});return(Qe==null?void 0:Qe.url)||null}if(Ze==="assetSelector"){const Qe=(Gt=(At=ot.data)==null?void 0:At.config)==null?void 0:Gt.selectedAsset,_t=((Qe==null?void 0:Qe.type)||"").toUpperCase(),xt=((Qe==null?void 0:Qe.mimeType)||"").toLowerCase();if(_t==="AUDIO"||xt.startsWith("audio/"))return(Qe==null?void 0:Qe.url)||null}return null};if(String((gt==null?void 0:gt.type)||"")==="audioVoice"){const ot=Jt(at);ot&&$(Ze=>Ze.map(ke=>ke.id===gt.id?{...ke,data:{...ke.data,config:{...ke.data.config,audioUrl:ot}}}:ke))}}catch{}const Me={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{x(gt=>ja(Me,gt)),rs(Me)},0),xs.current=null,es.current=!0},[x,R,M,n,g,rs]),Kr=t.useCallback((o,A)=>{const L=$t.current.some(K=>{var ye;return!K.hidden&&((ye=K.nodeIds)==null?void 0:ye.includes(A.source))}),X=$t.current.some(K=>{var ye;return!K.hidden&&((ye=K.nodeIds)==null?void 0:ye.includes(A.target))});if(L||X){f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}x(K=>K.filter(ye=>ye.id!==A.id)),gs(A.id),f.success("å·²æ–­å¼€è¿æ¥")},[x,gs]),Nr=t.useCallback(o=>{var X,K,ye,Me,Le,He,We,rt,Xe,De,ft,Vt,Lt,Wt,ht;lt.current&&clearTimeout(lt.current);try{const mt=localStorage.getItem("suppressedPreviewTasks")||"[]",Et=JSON.parse(mt),Ht=Fe=>{Et.push(Fe)};for(const Fe of Array.isArray(o)?o:[])if((Fe==null?void 0:Fe.type)==="imagePreview"){const it=(K=(X=Fe==null?void 0:Fe.data)==null?void 0:X.midjourneyData)==null?void 0:K.sourceNodeId,gt=(Me=(ye=Fe==null?void 0:Fe.data)==null?void 0:ye.midjourneyData)==null?void 0:Me.taskId,at=(He=(Le=Fe==null?void 0:Fe.data)==null?void 0:Le.midjourneyData)==null?void 0:He.messageId;if(it||gt||at)Ht({sourceNodeId:it,taskId:gt,messageId:at});else{const Jt=$e.current.find(Ot=>Ot.target===Fe.id);if(Jt){const Ot=re.current.find(Ze=>Ze.id===Jt.source),ot=(rt=(We=Ot==null?void 0:Ot.data)==null?void 0:We.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((Fe==null?void 0:Fe.type)==="videoPreview"){const it=$e.current.find(gt=>gt.target===Fe.id);if(it){const gt=re.current.find(Jt=>Jt.id===it.source),at=(De=(Xe=gt==null?void 0:gt.data)==null?void 0:Xe.config)==null?void 0:De.taskId;at&&Ht({taskId:at})}}const dt=Et.slice(Math.max(0,Et.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(dt))}catch{}try{const mt=[];for(const Et of Array.isArray(o)?o:[]){const Ht=(Lt=(Vt=(ft=Et==null?void 0:Et.data)==null?void 0:ft.workflowContext)==null?void 0:Vt.project)==null?void 0:Lt.name;(Et==null?void 0:Et.type)==="imagePreview"&&((Wt=Et==null?void 0:Et.data)!=null&&Wt.imageUrl)?mt.push(_e.post("/assets/recycle/record",{url:Et.data.imageUrl,type:"IMAGE",projectName:Ht})):(Et==null?void 0:Et.type)==="videoPreview"&&((ht=Et==null?void 0:Et.data)!=null&&ht.videoUrl)&&mt.push(_e.post("/assets/recycle/record",{url:Et.data.videoUrl,type:"VIDEO",projectName:Ht}))}mt.length>0&&Promise.allSettled(mt).then(()=>{})}catch{}const A=Array.isArray(o)?o.length:0,L=Ge.current;setTimeout(()=>{const mt=re.current.length,Et=Math.max(L-A,0);mt===Et&&Cs()},100)},[]),Yr=t.useCallback(o=>{const A=o.filter(X=>$t.current.some(ye=>{var Me;return!ye.hidden&&((Me=ye.nodeIds)==null?void 0:Me.includes(X.id))})?(f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(A.length===0)return;if(a){Nr(A),A.forEach(X=>qt(X.id));return}const L=A.filter(X=>{var Me;const K=(Me=X.data)==null?void 0:Me.createdBy;return(typeof K=="object"?K==null?void 0:K.id:K)===u.current});L.length>0&&(Nr(L),L.forEach(X=>qt(X.id)))},[a,Nr,qt]),Tr=t.useCallback(o=>{lt.current&&clearTimeout(lt.current),setTimeout(()=>{ps()},250)},[]),Qr=t.useCallback(o=>{const A=o.filter(L=>{if(L.type!=="remove")return!0;const X=$e.current.find(Me=>Me.id===L.id);if(!X)return!0;const K=$t.current.some(Me=>{var Le;return!Me.hidden&&((Le=Me.nodeIds)==null?void 0:Le.includes(X.source))}),ye=$t.current.some(Me=>{var Le;return!Me.hidden&&((Le=Me.nodeIds)==null?void 0:Le.includes(X.target))});return K||ye?(f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});_(A)},[_]),Zr=t.useCallback(o=>{const A=o.filter(L=>{const X=$t.current.some(ye=>{var Me;return!ye.hidden&&((Me=ye.nodeIds)==null?void 0:Me.includes(L.source))}),K=$t.current.some(ye=>{var Me;return!ye.hidden&&((Me=ye.nodeIds)==null?void 0:Me.includes(L.target))});return X||K?(f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});A.length>0&&(Tr(A),A.forEach(L=>gs(L.id)))},[Tr,gs]),ea=t.useCallback(o=>{if(o.preventDefault(),z)return;const A=200,L=400,X=10;let K=o.clientX,ye=o.clientY;K+A+X>window.innerWidth&&(K=window.innerWidth-A-X),ye+L+X>window.innerHeight&&(ye=window.innerHeight-L-X),K=Math.max(X,K),ye=Math.max(X,ye),i({x:K,y:ye})},[z]),hr=t.useCallback(()=>{i(null),de(),B(!1)},[]),ar=t.useCallback(o=>{ut(o),Nt(!0)},[]);t.useEffect(()=>{R.length>0&&R.some(A=>A.type==="assetSelector"&&!A.data.onOpenAssetPanel)&&$(A=>A.map(L=>L.type==="assetSelector"&&!L.data.onOpenAssetPanel?{...L,data:{...L.data,onOpenAssetPanel:ar,models:L.data.models||n}}:L))},[R.length,ar,n]);const ta=t.useCallback(o=>{ct&&($(A=>A.map(X=>X.id===ct?{...X,data:{...X.data,config:{...X.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(K=>K.url)}],referenceImages:o.images.map(K=>({id:K.id,url:K.url,name:K.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:X)),Nt(!1),ut(null),f.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[ct,$]),Ur=o=>{const L={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",X=L==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:L==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:L==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:L==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],K=n.filter(He=>He.type==="VIDEO_GENERATION"),ye=n.filter(He=>He.type==="VIDEO_EDITING"),Me=He=>{const We=(He||"").toLowerCase();return We.includes("text")||We.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":We.includes("first-last")||We.includes("é¦–å°¾")?"é¦–å°¾å¸§":We.includes("first")||We.includes("é¦–å¸§")?"é¦–å¸§":We.includes("last")||We.includes("å°¾å¸§")?"å°¾å¸§":We.includes("å‚è€ƒ")?"å‚è€ƒå›¾":We.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Le=null;return L==="è§†é¢‘æ¢äºº"?Le=ye.find(He=>{var We;return Array.isArray((We=He==null?void 0:He.config)==null?void 0:We.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||K.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(De=>Me(De)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):L==="å¯¹å£å‹"?Le=ye.find(He=>{var We;return Array.isArray((We=He==null?void 0:He.config)==null?void 0:We.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:L==="é£æ ¼è½¬æ¢"?Le=ye.find(He=>{var We;return Array.isArray((We=He==null?void 0:He.config)==null?void 0:We.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Le=K.find(He=>{var rt;const We=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>Me(Xe)):[];return L==="é¦–å¸§"||L==="å°¾å¸§"?We.includes("é¦–å¸§")||We.includes("å°¾å¸§"):We.includes(L)}),{modelId:Le==null?void 0:Le.id,modelName:Le==null?void 0:Le.name,generationType:L,lockedGenerationType:L,hideGenerationTypeSelector:!0,acceptedInputs:X}},ns=(o,A,L,X,K,ye,Me,Le)=>{if(!c)return;const He=Ae({x:c.x,y:c.y}),We=`${o}-${Date.now()}`,rt=ts?Ke.find(Lt=>Lt.id===ts)||null:Ke.find(Lt=>Lt.nodeIds.includes(We))||null,Xe=L==="aiImage"||L.startsWith("aiVideo")||L==="midjourney",De=L.startsWith("aiVideo")?Ur(L):{},ft=X?{agentId:X}:De;L.startsWith("aiVideo"),L.startsWith("aiVideo")&&Le&&Object.assign(ft,Le);const Vt={id:We,type:L,position:He,data:{label:K||A,type:o,config:ft,models:n,isExpanded:Xe,onOpenAssetPanel:L==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:rt,nodeGroups:Ke}}};$(Lt=>[...Lt,Vt]),Tt(Vt),ts&&(It(Lt=>Lt.map(Wt=>{if(Wt.id!==ts)return Wt;const ht=Array.from(new Set([...Wt.nodeIds||[],We])),mt=br(ht)||Wt.bounds;return{...Wt,nodeIds:ht,bounds:mt}})),$t.current=$t.current.map(Lt=>{if(Lt.id!==ts)return Lt;const Wt=Array.from(new Set([...Lt.nodeIds||[],We])),ht=br(Wt)||Lt.bounds;return{...Lt,nodeIds:Wt,bounds:ht}})),hr(),f.success(`å·²æ·»åŠ ${K||A}èŠ‚ç‚¹`),L==="assetSelector"&&setTimeout(()=>{ar(Vt.id)},100)},[is,Ys]=t.useState(null),es=t.useRef(!1),xs=t.useRef(null),Qs=t.useMemo(()=>{var Le,He,We,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const A=is.handleType==="target",L=Xe=>{const De=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return De?De.includes("æ–‡ç”Ÿ")||De.includes("text to video")||De.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":De.includes("é¦–å°¾")||De.includes("first last")||De.includes("two frame")||De.includes("frame pair")?"é¦–å°¾å¸§":De.includes("é¦–å¸§")||De.includes("first frame")||De.includes("start frame")||De.includes("initial frame")||De.includes("keyframe")?"é¦–å¸§":De.includes("å°¾å¸§")||De.includes("last frame")||De.includes("end frame")||De.includes("final frame")?"å°¾å¸§":De.includes("ä¸»ä½“å‚è€ƒ")||De.includes("subject reference")||De.includes("å‚è€ƒ")||De.includes("reference image")||De.includes("image reference")||De.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(A){const Xe=R.find(Wt=>Wt.id===is.sourceNodeId),De=(Xe==null?void 0:Xe.type)||"",ft=De.startsWith("aiVideo"),Vt=L((He=(Le=Xe==null?void 0:Xe.data)==null?void 0:Le.config)==null?void 0:He.generationType),Lt=De==="aiVideo_t2v"||Vt==="æ–‡ç”Ÿè§†é¢‘";if(De==="aiImage"){const Wt=g.filter(it=>it.target===(Xe==null?void 0:Xe.id)),ht=Wt.some(it=>{const gt=R.find(at=>at.id===it.source);return((gt==null?void 0:gt.type)||"")==="agent"}),mt=Wt.reduce((it,gt)=>{var Ot,ot,Ze,ke;const at=R.find(Je=>Je.id===gt.source),Jt=(at==null?void 0:at.type)||"";if(Jt==="upload"){const Je=((Ze=(ot=(Ot=at==null?void 0:at.data)==null?void 0:Ot.config)==null?void 0:ot.uploadedFiles)==null?void 0:Ze[0])||null,At=((Je==null?void 0:Je.type)||"").toUpperCase(),Gt=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return it+(At==="IMAGE"||Gt.startsWith("image/")?1:0)}if(Jt==="assetSelector"){const Je=((ke=at==null?void 0:at.data)==null?void 0:ke.config)||{};if(Je.selectedAsset)return it+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return it+((Je.subjects[0].images||[]).length||0)}return it},0),Et=(rt=(We=Xe==null?void 0:Xe.data)==null?void 0:We.config)==null?void 0:rt.modelId,Ht=n.find(it=>it.id===Et),dt=(Ht==null?void 0:Ht.config)||{},Fe=dt.maxReferenceImages||dt.supportedReferenceImagesLimit||dt.referenceImagesLimit||10;return ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=Fe?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(ft){const Wt=g.filter(Fe=>Fe.target===(Xe==null?void 0:Xe.id)),ht=Wt.some(Fe=>{const it=R.find(gt=>gt.id===Fe.source);return((it==null?void 0:it.type)||"")==="agent"}),mt=Wt.reduce((Fe,it)=>{var Jt,Ot,ot,Ze;const gt=R.find(ke=>ke.id===it.source),at=(gt==null?void 0:gt.type)||"";if(at==="aiImage"||at==="imagePreview")return Fe+1;if(at==="upload"){const ke=((ot=(Ot=(Jt=gt==null?void 0:gt.data)==null?void 0:Jt.config)==null?void 0:Ot.uploadedFiles)==null?void 0:ot[0])||null,Je=((ke==null?void 0:ke.type)||"").toUpperCase(),At=((ke==null?void 0:ke.mimeType)||"").toLowerCase();return Fe+(Je==="IMAGE"||At.startsWith("image/")?1:0)}if(at==="assetSelector"){const ke=((Ze=gt==null?void 0:gt.data)==null?void 0:Ze.config)||{};if(ke.selectedAsset)return Fe+((ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ke.subjects&&ke.subjects.length>0)return Fe+((ke.subjects[0].images||[]).length||0)}return Fe},0);return Lt?ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:De==="aiVideo_i2v_first"||De==="aiVideo_i2v_last"||Vt==="é¦–å¸§"||Vt==="å°¾å¸§"?ht&&mt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:De==="aiVideo_first_last"||Vt==="é¦–å°¾å¸§"?ht&&mt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:De==="aiVideo_reference"||Vt==="å‚è€ƒå›¾"?ht&&mt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:ht?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const X=R.find(Xe=>Xe.id===is.sourceNodeId),ye=(Xe=>{var Vt,Lt,Wt;if(!Xe)return null;const De=Xe.type,ft=Xe.data;if(De==="upload"&&Array.isArray((Vt=ft.config)==null?void 0:Vt.uploadedFiles)&&ft.config.uploadedFiles.length>0){const ht=ft.config.uploadedFiles;return ht.some(dt=>{const Fe=((dt==null?void 0:dt.type)||"").toUpperCase(),it=((dt==null?void 0:dt.mimeType)||"").toLowerCase();return Fe==="IMAGE"||it.startsWith("image/")})?"IMAGE":ht.some(dt=>{const Fe=((dt==null?void 0:dt.type)||"").toUpperCase(),it=((dt==null?void 0:dt.mimeType)||"").toLowerCase();return Fe==="VIDEO"||it.startsWith("video/")})?"VIDEO":ht.some(dt=>{const Fe=((dt==null?void 0:dt.type)||"").toUpperCase(),it=((dt==null?void 0:dt.mimeType)||"").toLowerCase();return Fe==="AUDIO"||it.startsWith("audio/")})?"AUDIO":null}if(De==="assetSelector"){if((Lt=ft.config)!=null&&Lt.subjects)return"IMAGE";if((Wt=ft.config)!=null&&Wt.selectedAsset){const ht=ft.config.selectedAsset,mt=(ht.type||"").toUpperCase(),Et=(ht.mimeType||"").toLowerCase();return mt==="IMAGE"||Et.startsWith("image/")?"IMAGE":mt==="VIDEO"||Et.startsWith("video/")?"VIDEO":mt==="AUDIO"||Et.startsWith("audio/")?"AUDIO":mt||null}}return De==="aiImage"||De==="imagePreview"||De==="midjourney"?"IMAGE":(De||"").startsWith("aiVideo")||De==="videoPreview"?"VIDEO":De==="agent"||De==="textPreview"?"TEXT":null})(X),Me=X==null?void 0:X.type;return Me==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:Me==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ye==="TEXT",showAiImage:ye==="IMAGE"||ye==="TEXT",showAudio:ye==="AUDIO",showVideo:ye==="VIDEO"||ye==="IMAGE"||ye==="TEXT",showEdit:ye==="VIDEO",showImageEditing:ye==="IMAGE",showMidjourney:ye==="IMAGE"||ye==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ye==="IMAGE"}},[is,R,g,n]),sa=t.useCallback((o,{nodeId:A,handleType:L})=>{if(!A){xs.current=null;return}if(L==="target"){const X=R.find(ye=>ye.id===A),K=(X==null?void 0:X.type)||"";if(K==="agent"||K==="aiImage"||K==="midjourney"||K.startsWith("aiVideo")){f.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),xs.current=null;return}}if(L==="source"){const X=R.find(K=>K.id===A);if(X&&(X.type==="aiImage"||X.type.startsWith("aiVideo"))){xs.current=null;return}}es.current=!1,xs.current={nodeId:A,handleType:L==="target"?"target":"source"},hr(),Ys(null)},[hr,R]),ra=t.useCallback(o=>{const A=xs.current;if(!A)return;let L=0,X=0;"changedTouches"in o&&o.changedTouches.length>0?(L=o.changedTouches[0].clientX,X=o.changedTouches[0].clientY):"clientX"in o&&(L=o.clientX,X=o.clientY),setTimeout(()=>{if(es.current){es.current=!1,xs.current=null;return}const K=o.target,ye=!!K&&!!K.closest(".react-flow__pane"),Me=!!K&&(K.closest(".react-flow__node")||K.closest(".react-flow__handle"));if(!ye||Me){es.current=!1,xs.current=null;return}Ys({x:L,y:X,sourceNodeId:A.nodeId,handleType:A.handleType}),es.current=!1},100),xs.current=null},[]),cs=(o,A,L,X,K,ye)=>{var Vt,Lt,Wt,ht,mt,Et,Ht;if(!is)return;const Me=Ae({x:is.x,y:is.y}),Le=`${L}-${Date.now()}`,He=R.find(dt=>dt.id===is.sourceNodeId),We=He?Ke.find(dt=>dt.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?Ur(o):{};let De={};X?De={agentId:X}:o.startsWith("aiVideo")?De=Xe:o==="smartStoryboard"?De={taskId:"",aspectRatio:"1:1",inputImages:[],userPrompt:""}:o==="hdUpscale"?De={taskId:"",imageSize:"4K"}:o==="imageFusion"&&(De={taskId:"",imageSize:"4K"}),o.startsWith("aiVideo")&&ye&&Object.assign(De,ye);const ft={id:Le,type:o,position:Me,data:{label:K||A,type:L,config:De,models:n,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0,workflowContext:{project:we,episode:be,nodeGroup:We,nodeGroups:Ke}}};if($(dt=>[...dt,ft]),We&&(It(dt=>dt.map(Fe=>{if(Fe.id!==We.id)return Fe;const it=Array.from(new Set([...Fe.nodeIds,Le]));return{...Fe,nodeIds:it}})),$t.current=$t.current.map(dt=>{if(dt.id!==We.id)return dt;const Fe=Array.from(new Set([...dt.nodeIds,Le]));return{...dt,nodeIds:Fe}})),is.handleType==="source"){const dt=R.find(ke=>ke.id===is.sourceNodeId),Fe=ft,it=ke=>{const Je=(ke||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ke||"":""},gt=ke=>{var Gt,Qe,_t;const Je=ke.type,At=ke.data;if(Je==="upload"&&Array.isArray((Gt=At.config)==null?void 0:Gt.uploadedFiles)&&At.config.uploadedFiles.length>0){const xt=At.config.uploadedFiles,Rt=xt.some(ss=>{const Ms=((ss==null?void 0:ss.type)||"").toUpperCase(),As=((ss==null?void 0:ss.mimeType)||"").toLowerCase();return Ms==="VIDEO"||As.startsWith("video/")}),Qt=xt.some(ss=>{const Ms=((ss==null?void 0:ss.type)||"").toUpperCase(),As=((ss==null?void 0:ss.mimeType)||"").toLowerCase();return Ms==="IMAGE"||As.startsWith("image/")}),vs=xt.some(ss=>{const Ms=((ss==null?void 0:ss.type)||"").toUpperCase(),As=((ss==null?void 0:ss.mimeType)||"").toLowerCase();return Ms==="AUDIO"||As.startsWith("audio/")});return(Fe==null?void 0:Fe.type)==="aiVideo_swap"?Rt?"VIDEO":Qt?"IMAGE":vs?"AUDIO":null:Qt?"IMAGE":Rt?"VIDEO":vs?"AUDIO":null}if(Je==="assetSelector"){if((Qe=At.config)!=null&&Qe.subjects)return"IMAGE";if((_t=At.config)!=null&&_t.selectedAsset){const xt=At.config.selectedAsset,Rt=(xt.type||"").toUpperCase(),Qt=(xt.mimeType||"").toLowerCase();return Rt==="IMAGE"||Qt.startsWith("image/")?"IMAGE":Rt==="VIDEO"||Qt.startsWith("video/")?"VIDEO":Rt==="AUDIO"||Qt.startsWith("audio/")?"AUDIO":Rt||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ke=>{var At,Gt,Qe;if(gt(ke)!=="IMAGE")return 0;if(ke.type==="upload")return(((Gt=(At=ke.data)==null?void 0:At.config)==null?void 0:Gt.uploadedFiles)||[]).filter(xt=>xt.type==="IMAGE"||(xt.mimeType||"").startsWith("image/")).length;if(ke.type==="assetSelector"){const _t=((Qe=ke.data)==null?void 0:Qe.config)||{};return _t.subjects&&_t.subjects.length>0?(_t.subjects[0].images||[]).length:_t.selectedAsset&&_t.selectedAsset.type==="IMAGE"?1:0}return ke.type==="imagePreview"||ke.type==="aiImage",1},Jt=ke=>{var xt,Rt,Qt,vs,ss,Ms;const Je=it((Rt=(xt=ke.data)==null?void 0:xt.config)==null?void 0:Rt.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const At=(vs=(Qt=ke.data)==null?void 0:Qt.config)==null?void 0:vs.modelId,Qe=(((ss=ke.data)==null?void 0:ss.models)||n).find(As=>As.id===At),_t=Array.isArray((Ms=Qe==null?void 0:Qe.config)==null?void 0:Ms.supportedGenerationTypes)?Qe.config.supportedGenerationTypes.map(As=>it(As)):[];return _t.includes("å‚è€ƒå›¾")||_t.includes("ä¸»ä½“å‚è€ƒ")?7:_t.includes("é¦–å°¾å¸§")?2:_t.includes("é¦–å¸§")||_t.includes("å°¾å¸§")?1:(_t.includes("æ–‡ç”Ÿè§†é¢‘"),0)},Ot=dt?gt(dt):null;if(Fe.type.startsWith("aiVideo")&&Ot==="IMAGE"){if(it((Lt=(Vt=Fe.data)==null?void 0:Vt.config)==null?void 0:Lt.generationType)==="é¦–å°¾å¸§"&&dt&&dt.type==="assetSelector"){const xt=((Wt=dt.data)==null?void 0:Wt.config)||{};if(xt.subjects&&(((ht=xt.subjects[0])==null?void 0:ht.images)||[]).length>0){f.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),xs.current=null,es.current=!1;return}}const Je=g.filter(xt=>xt.target===Fe.id);let At=0;Je.forEach(xt=>{const Rt=R.find(Qt=>Qt.id===xt.source);Rt&&(At+=at(Rt))});const Gt=dt?at(dt):0,Qe=Jt(Fe),_t=At+Gt;if(Qe===0){f.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ys(null),xs.current=null,es.current=!1;return}if(_t>Qe){f.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Qe}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${_t}å¼ ï¼‰`),Ys(null),xs.current=null,es.current=!1;return}}let ot;ft.type==="superCanvas"?ot="input-image":ft.type==="midjourney"&&(Ot==="IMAGE"?ot="omni-ref":Ot==="TEXT"&&(ot="text-input"));const Ze={id:`edge-${is.sourceNodeId}-${ft.id}`,source:is.sourceNodeId,target:ft.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(ke=>[...ke,Ze])}else if(is.handleType==="target"){const dt=R.find(Ze=>Ze.id===is.sourceNodeId),Fe=(dt==null?void 0:dt.type)||"";if(Fe==="agent"||Fe==="aiImage"||Fe==="midjourney"||Fe.startsWith("aiVideo")){f.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ys(null),xs.current=null,es.current=!1;return}const it=ft,gt=R.find(Ze=>Ze.id===is.sourceNodeId),at=Ze=>{const ke=(Ze||"").toLowerCase();return ke?ke.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")?"é¦–å¸§":ke.includes("å°¾å¸§")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ke.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ke.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("first-last")?"é¦–å°¾å¸§":ke.includes("first")?"é¦–å¸§":ke.includes("last")?"å°¾å¸§":ke.includes("subject")?"ä¸»ä½“å‚è€ƒ":ke.includes("reference")?"å‚è€ƒå›¾":Ze||"":""},Ot=(Ze=>{var At,Gt,Qe,_t;const ke=Ze.type,Je=Ze.data;if(ke==="upload"&&((Gt=(At=Je.config)==null?void 0:At.uploadedFiles)==null?void 0:Gt.length)>0){const xt=Je.config.uploadedFiles[0],Rt=(xt.type||"").toUpperCase(),Qt=(xt.mimeType||"").toLowerCase();return Rt==="IMAGE"||Qt.startsWith("image/")?"IMAGE":Rt==="VIDEO"||Qt.startsWith("video/")?"VIDEO":Rt==="AUDIO"||Qt.startsWith("audio/")?"AUDIO":Rt||null}if(ke==="assetSelector"){if((Qe=Je.config)!=null&&Qe.subjects)return"IMAGE";if((_t=Je.config)!=null&&_t.selectedAsset){const xt=Je.config.selectedAsset,Rt=(xt.type||"").toUpperCase(),Qt=(xt.mimeType||"").toLowerCase();return Rt==="IMAGE"||Qt.startsWith("image/")?"IMAGE":Rt==="VIDEO"||Qt.startsWith("video/")?"VIDEO":Rt==="AUDIO"||Qt.startsWith("audio/")?"AUDIO":Rt||null}}return ke==="aiImage"||ke==="imagePreview"?"IMAGE":ke==="aiVideo"||ke==="videoPreview"?"VIDEO":ke==="agent"?"TEXT":null})(it);if(gt&&gt.type==="aiVideo"&&Ot==="IMAGE"&&at((Et=(mt=gt.data)==null?void 0:mt.config)==null?void 0:Et.generationType)==="é¦–å°¾å¸§"&&it&&it.type==="assetSelector"){const ke=((Ht=it.data)==null?void 0:Ht.config)||{};if(ke.subjects&&ke.subjects.length>0){f.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),xs.current=null,es.current=!1;return}}const ot={id:`edge-${ft.id}-${is.sourceNodeId}`,source:ft.id,sourceHandle:ft.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(Ze=>[...Ze,ot])}Ys(null),xs.current=null,es.current=!1,f.success(`å·²æ·»åŠ ${A}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(ft.id)},100)},br=t.useCallback(o=>{const A=R.filter(Le=>o.includes(Le.id));if(A.length===0)return null;const L=50;let X=1/0,K=1/0,ye=-1/0,Me=-1/0;return A.forEach(Le=>{const He=Le.position.x,We=Le.position.y,rt=Le.width||320,Xe=Le.height||200;X=Math.min(X,He),K=Math.min(K,We),ye=Math.max(ye,He+rt),Me=Math.max(Me,We+Xe)}),{x:X-L,y:K-L,width:ye-X+L*2,height:Me-K+L*2}},[R]),aa=t.useCallback(()=>{$s(o=>!o),Ks(!1)},[]),Rr=t.useCallback((o,A)=>{const L={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:A-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:ie?{id:ie.id,nickname:ie.nickname,avatar:ie.avatar}:void 0}};$(X=>[...X,L]),$s(!1)},[$,ie]),oa=t.useCallback(()=>{if(!a){f.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=R.filter(ye=>ye.selected);if(o.length===0){f.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){f.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const A=o.map(ye=>ye.id);if(Ke.some(ye=>ye.nodeIds.some(Me=>A.includes(Me)))){f.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const X=br(A);if(!X){f.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const K={id:`group-${Date.now()}`,nodeIds:A,bounds:X};It(ye=>{const Me=[...ye,K];return Ws(Me),setTimeout(()=>{ps()},100),Me}),wt(K.id),$(ye=>{const Me=new Set;return g.forEach(Le=>{if(A.includes(Le.source)){const He=ye.find(We=>We.id===Le.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&Me.add(Le.target)}}),ye.map(Le=>A.includes(Le.id)?{...Le,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Le.data,workflowContext:{...Le.data.workflowContext,nodeGroup:K,nodeGroups:[...Ke,K]}}}:Me.has(Le.id)?{...Le,data:{...Le.data,workflowContext:{...Le.data.workflowContext,nodeGroup:K,nodeGroups:[...Ke,K]}}}:Le)}),f.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${A.length} ä¸ªèŠ‚ç‚¹`)},[R,br,Ke,$]),na=t.useCallback(()=>{if(!a){f.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!ze){f.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ke.find(A=>A.id===ze);o&&($(A=>A.map(L=>o.nodeIds.includes(L.id)?{...L,draggable:!0,connectable:!0,deletable:!0,data:{...L.data,workflowContext:{...L.data.workflowContext,nodeGroup:null,nodeGroups:Ke.filter(X=>X.id!==ze)}}}:L)),It(A=>{const L=A.filter(X=>X.id!==ze);return Ws(L),setTimeout(()=>{ps()},100),L}),wt(null),f.success("å·²è§£é™¤ç¼–ç»„"))},[ze,Ke,$,Ws]),ia=t.useCallback(()=>{if(!ze){f.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Gs(ze),Is(!0)},[ze]),$r=t.useCallback((o,A)=>{o.stopPropagation(),o.preventDefault(),js(null),wt(A),nr(null)},[]);t.useEffect(()=>{if(!ks||!qs)return;let o=qs.x,A=qs.y;const L=K=>{const ye=er.current;if(!ye)return;const Me=Q(),Le=(K.clientX-o)/Me.zoom,He=(K.clientY-A)/Me.zoom;if(Math.abs(Le)<.01&&Math.abs(He)<.01)return;const We=$t.current.find(rt=>rt.id===ye);We&&(It(rt=>rt.map(Xe=>Xe.id===ye?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Le,y:Xe.bounds.y+He}}:Xe)),$(rt=>rt.map(Xe=>We.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Le,y:Xe.position.y+He}}:Xe)),o=K.clientX,A=K.clientY)},X=()=>{js(null),nr(null)};return document.addEventListener("mousemove",L),document.addEventListener("mouseup",X),()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",X)}},[ks,qs]);const la=t.useCallback(o=>{if(Es){const A=Ae({x:o.clientX,y:o.clientY});Rr(A.x,A.y);return}hr(),Ys(null),xs.current=null,wt(null),es.current=!1},[hr,Es,Ae,Rr]),jr=t.useRef(null),ca=t.useCallback(()=>{Ke.length>0&&!jr.current&&(jr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),jr.current=null}))},[Ke.length]),ir=t.useCallback(o=>Ke.find(A=>A.nodeIds.includes(o))||null,[Ke]),da=t.useCallback((o,A)=>{var X;if(bt||(X=A==null?void 0:A.data)!=null&&X.freeDrag)return;const L=ir(A.id);if(L){if(!L.hidden&&!a)return;Vs.current=A.id,q.current={x:A.position.x,y:A.position.y}}},[ir,a]),ua=t.useCallback((o,A)=>{var K;if(bt||(K=A==null?void 0:A.data)!=null&&K.freeDrag||!q.current||Vs.current!==A.id)return;const L=ir(A.id);if(!L)return;const X=!L.hidden;if(!(X&&!a))if(X){const ye=A.position.x-q.current.x,Me=A.position.y-q.current.y,Le=[],He=L.nodeIds||[];re.current.forEach(We=>{if(He.includes(We.id)){const rt={x:We.id===A.id?A.position.x:We.position.x+ye,y:We.id===A.id?A.position.y:We.position.y+Me};Le.push({id:We.id,position:rt})}}),$(We=>We.map(rt=>{const Xe=Le.find(De=>De.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Le.length>0&&Bt(Le),It(We=>{const rt=We.map(Xe=>Xe.id===L.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ye,y:Xe.bounds.y+Me}}:Xe);return $t.current=rt,rt}),q.current={x:A.position.x,y:A.position.y}}else{const ye=L.bounds.x,Me=L.bounds.y,Le=L.bounds.width,He=L.bounds.height,We=(De,ft,Vt)=>Math.max(ft,Math.min(De,Vt)),rt=We(A.position.x,ye+10,ye+Le-10),Xe=We(A.position.y,Me+10,Me+He-10);$(De=>De.map(ft=>ft.id===A.id?{...ft,position:{x:rt,y:Xe}}:ft)),q.current={x:rt,y:Xe}}},[$,It,ir,a,Bt]),ga=t.useCallback(()=>{Vs.current=null,q.current=null,er.current=null,Vs.current=null,q.current=null,er.current=null,js(null),$t.current.length>0&&Ws($t.current)},[Ws]),pa=t.useCallback((o,A)=>{const L=ir(A.id);L&&wt(L.id)},[ir]);if(t.useEffect(()=>{if(g.length===0||R.length===0)return;const o=g.filter(A=>{const L=R.find(K=>K.id===A.source),X=R.find(K=>K.id===A.target);return(X==null?void 0:X.type)==="midjourney"&&A.targetHandle==="text-input"&&(L==null?void 0:L.type)!=="agent"});o.length>0&&(x(A=>A.filter(L=>!o.some(X=>X.id===L.id))),f.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[g,R,x]),le)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!we)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Mr=R.filter(o=>o.selected).length>=2,wr=!!ze;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:St,className:"flex-1 relative overflow-hidden",children:[z&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:W?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${W.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),we&&e.jsx("div",{className:`absolute left-1/2 -translate-x-1/2 ${z?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&be?`${we.name} ç¬¬${be.episodeNumber}é›†${!Pe&&ae&&Z?` ç¬¬${ae}å¹•ç¬¬${Z}é•œ`:""}`:we.name})}),!Pe&&Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-[100px] top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ke.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,A)=>o.scene!==A.scene?(o.scene||0)-(A.scene||0):(o.shot||0)-(A.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const A=o.bounds.x+o.bounds.width/2,L=o.bounds.y+o.bounds.height/2,X=St.current;if(X){const K=X.clientWidth,ye=X.clientHeight,Me=.2,Le=K*(1-Me),He=ye*(1-Me),We=Le/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(We,rt,1.5),De=Math.max(Xe,.3);fe(A,L,{zoom:De,duration:800})}else fe(A,L,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${ze===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-[#deeaef]/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-[#deeaef] dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:"fixed right-[24px] top-1/2 -translate-y-1/2 z-[100] flex flex-col gap-1 p-2 rounded-2xl bg-[#deeaef] dark:bg-[#18181b] shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{onClick:()=>{if(qe&&S&&l){const o=Pe&&ae&&Z?`?shot=${Z}`:"";T(`/projects/${S}/episodes/${l}${o}`)}else T("/quick")},className:"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"arrow_back"})}),e.jsx("div",{className:"h-px bg-neutral-200 dark:bg-neutral-700 my-1"}),!z&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!bt&&a&&Ks(!bs)},disabled:bt||!a,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":bs?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!bt&&a&&oa()},disabled:bt||!a||!Mr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!Mr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_work"})}),e.jsx("button",{onClick:()=>{!bt&&a&&na()},disabled:bt||!a||!wr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!wr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_off"})}),e.jsx("button",{onClick:()=>{!bt&&a&&ia()},disabled:bt||!a||!wr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!wr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"edit"})}),e.jsx("button",{onClick:()=>aa(),className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${Es?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:Es?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"text_fields"})})]})]}),w&&tr.length>0&&e.jsxs("div",{className:`absolute ${z?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:tr.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.ai${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-neutral-600 dark:text-neutral-300",children:"person"})},o.id))}),tr.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",tr.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${Es?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Ia,{nodes:ws,edges:g,onNodesChange:z?void 0:os,onEdgesChange:z?void 0:Qr,onNodesDelete:z?void 0:Yr,onEdgesDelete:z?void 0:Zr,onConnect:z?void 0:qr,onConnectStart:z?void 0:sa,onConnectEnd:z?void 0:ra,onEdgeDoubleClick:z?void 0:Kr,onPaneContextMenu:z?void 0:ea,onPaneClick:z?void 0:la,onMove:ca,onNodeClick:z?void 0:pa,onNodeDragStart:z?void 0:da,onNodeDrag:z?void 0:ua,onNodeDragStop:z?void 0:ga,nodeTypes:bn,edgeTypes:wn,nodesDraggable:!z,nodesConnectable:!z,elementsSelectable:!z,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${z?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#525252",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:z?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Sa,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#525252"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#404040"})]})}),Ke.filter(o=>!o.hidden).map(o=>{const A=Q(),L=o.bounds.x*A.zoom+A.x,X=o.bounds.y*A.zoom+A.y,K=o.bounds.width*A.zoom,ye=o.bounds.height*A.zoom,Me=12*A.zoom,Le=Math.max(1.25,1.25*A.zoom),He=document.documentElement.classList.contains("dark"),We=ze===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:L,y:X,width:K,height:ye,rx:Me,ry:Me,fill:"none",stroke:We?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Le,style:{filter:We?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:L,y:X,width:K,height:ye,rx:Me,ry:Me,fill:"transparent",stroke:"transparent",strokeWidth:Le*3,style:{pointerEvents:"stroke",cursor:ks===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),$r(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ke.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const A=Q(),L=o.bounds.x*A.zoom+A.x,X=o.bounds.y*A.zoom+A.y,K=40*A.zoom,ye=10*A.zoom,Me=15*A.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Le=>{Le.stopPropagation(),$r(Le,o.id)},onClick:Le=>{Le.stopPropagation(),wt(o.id)},style:{left:L+ye,top:X-K-ye-Me,fontSize:`${K}px`,cursor:ks===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),c&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:c.x,top:c.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),ne("agent")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ne("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),O==="agent"&&e.jsx("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),ne("agent")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(h.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),Ce(!0)},onMouseLeave:()=>{h.current=window.setTimeout(()=>{Ce(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),J&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),Ce(!0)},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(h.current=window.setTimeout(()=>{Ce(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),B(!0)},onMouseLeave:()=>{Ne.current=window.setTimeout(()=>{B(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),j&&e.jsxs("div",{onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),B(!0)},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(Ne.current=window.setTimeout(()=>{B(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),ne("edit")},onMouseLeave:()=>{h.current=window.setTimeout(()=>{ne(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ne("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ne("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),O==="edit"&&e.jsxs("div",{onMouseEnter:()=>{h.current&&(clearTimeout(h.current),h.current=null),ne("edit")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(h.current=window.setTimeout(()=>{ne(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[et.filter(o=>kt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),pe(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),et.every(o=>kt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Qs.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),Re.current&&(clearTimeout(Re.current),Re.current=null),Ue(!0)},onMouseLeave:()=>{Re.current=window.setTimeout(()=>{Ue(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Ue(!0),onMouseLeave:()=>Ue(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Ue(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Ue(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),Oe&&e.jsx("div",{onMouseEnter:()=>{Re.current&&(clearTimeout(Re.current),Re.current=null),Ue(!0)},onMouseLeave:()=>{Re.current=window.setTimeout(()=>{Ue(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),cs("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Qs.showAiImage&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>cs("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Qs.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),oe("imageEdit")},onMouseLeave:()=>{d.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),ue==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),oe("imageEdit")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(d.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),cs("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Qs.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),oe("video")},onMouseLeave:()=>{d.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),ue==="video"&&e.jsxs("div",{onMouseEnter:()=>{d.current&&(clearTimeout(d.current),d.current=null),oe("video")},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(d.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>cs("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ve.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>cs("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ve.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>cs("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ve.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>cs("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ve.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>cs("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ve.has("å‚è€ƒå›¾")||Ve.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>cs("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ve.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>cs("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Qs.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),Te.current&&(clearTimeout(Te.current),Te.current=null),pe(!0)},onMouseLeave:()=>{Te.current=window.setTimeout(()=>{pe(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>pe(!0),onMouseLeave:()=>pe(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),pe(!0)},onMouseOver:()=>oe(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),b&&e.jsxs("div",{onMouseEnter:()=>{Te.current&&(clearTimeout(Te.current),Te.current=null),pe(!0)},onMouseLeave:o=>{const A=o.currentTarget.parentElement,L=o.relatedTarget;(!A||!A.contains(L))&&(Te.current=window.setTimeout(()=>{pe(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[et.filter(o=>kt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:A=>{A.preventDefault(),A.stopPropagation(),o==="å¯¹å£å‹"?cs("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?cs("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):cs("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),pe(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),et.every(o=>kt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Qs.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>cs("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Qs.showUpload&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>cs("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Qs.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>cs("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Qs.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>cs("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(xn,{isOpen:vt,onClose:()=>{Nt(!1),ut(null)},onAssetSelect:ta}),Rs&&Ss&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Is(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Is(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),A=document.getElementById("shot-input"),L=parseInt((o==null?void 0:o.value)||"0"),X=parseInt((A==null?void 0:A.value)||"0");if(L>0&&X>0){if(Ke.find(ye=>ye.id!==Ss&&ye.scene===L&&ye.shot===X)){f.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${L}å¹•-ç¬¬${X}é•œ`);return}It(ye=>{const Me=ye.map(He=>He.id===Ss?{...He,scene:L,shot:X,name:`ç¬¬${L}å¹•-ç¬¬${X}é•œ`}:He),Le=Me.find(He=>He.id===Ss);return Le&&$(He=>{const We=new Set;return g.forEach(rt=>{if(Le.nodeIds.includes(rt.source)){const Xe=He.find(De=>De.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&We.add(rt.target)}}),He.map(rt=>Le.nodeIds.includes(rt.id)||We.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Le,nodeGroups:Me}}}:rt)}),setTimeout(()=>{ps()},100),Me}),Is(!1),Gs(null),f.success(`å·²å‘½åä¸ºï¼šç¬¬${L}å¹•-ç¬¬${X}é•œ`)}else f.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},Cn=()=>e.jsx(ka,{children:e.jsx(yn,{})});export{Cn as default};
