const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DRJ_08Rm.js","assets/react-vendor-BvY2dB7B.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-D8v6_Qvs.js","assets/utils-BcyDR7Vi.js","assets/index-BjieCjvq.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Gt,u as Sr,z as Gs,e as xa,d as ba}from"./react-vendor-BvY2dB7B.js";import{u as Er,l as wa,b as Ce,_ as xs,c as f,e as ya}from"./index-DRJ_08Rm.js";import{P as ut,H as us,a as Zt,b as Ds,d as Fs,e as zs,g as ka,R as va,f as Na,h as ja,i as Ia,j as Sa,C as Ea}from"./reactflow-D8v6_Qvs.js";import{C as Ca,L as Ms,S as fr,I as Dr,T as zr,V as Aa}from"./video-CPXLMxBS.js";import{c as Ts}from"./createLucideIcon-CK1cQnin.js";import{X as _a,j as Zs,L as Vs,o as Lr,a as Ta,v as or,U as Pr,b as Ua,N as Ra}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=Ts("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Ts("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Ts("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=Ts("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=Ts("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=Ts("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=Ts("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ir=Ts("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Va=Ts("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Ts("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Br=Ts("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=Ts("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),za="https://api.waule.com";function Ba(s){const{workflowId:j,isSharedWorkflow:n,isReadOnly:F,onNodeAdd:ye,onNodeUpdate:U,onNodeDelete:fe,onNodeMove:Q,onNodesMove:re,onEdgeAdd:K,onEdgeDelete:ce,onGroupsUpdate:Ue,onUserJoin:he}=s,te=t.useRef(null),ae=t.useRef(!1),{token:je}=Er(),[ne,pe]=t.useState([]);t.useEffect(()=>{if(!n||!j||!je)return;const m=wa(za,{auth:{token:je},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return te.current=m,m.on("connect",()=>{ae.current=!0,m.emit("join-workflow",j),m.emit("user:join",{workflowId:j})}),m.on("disconnect",c=>{ae.current=!1}),m.on("connect_error",c=>{}),m.on("node:add",c=>{ye==null||ye(c.node,c.userId)}),m.on("node:update",c=>{U==null||U(c.nodeId,c.changes,c.userId)}),m.on("node:delete",c=>{fe==null||fe(c.nodeId,c.userId)}),m.on("node:move",c=>{Q==null||Q(c.nodeId,c.position,c.userId)}),m.on("nodes:move",c=>{re==null||re(c.nodes,c.userId)}),m.on("edge:add",c=>{K==null||K(c.edge,c.userId)}),m.on("edge:delete",c=>{ce==null||ce(c.edgeId,c.userId)}),m.on("groups:update",c=>{Ue==null||Ue(c.groups,c.userId)}),m.on("user:join",c=>{he==null||he(c.user)}),m.on("users:online",c=>{pe(c.users)}),()=>{te.current&&(te.current.emit("leave-workflow",j),te.current.disconnect(),te.current=null),ae.current=!1,pe([])}},[j,n,je]);const de=t.useCallback(m=>{te.current&&ae.current&&j&&!F&&te.current.emit("node:add",{workflowId:j,node:m})},[j,F]),me=t.useCallback((m,c)=>{te.current&&ae.current&&j&&!F&&te.current.emit("node:update",{workflowId:j,nodeId:m,changes:c})},[j,F]),Ee=t.useCallback(m=>{te.current&&ae.current&&j&&!F&&te.current.emit("node:delete",{workflowId:j,nodeId:m})},[j,F]),Z=t.useCallback((m,c)=>{te.current&&ae.current&&j&&!F&&te.current.emit("node:move",{workflowId:j,nodeId:m,position:c})},[j,F]),z=t.useCallback(m=>{te.current&&ae.current&&j&&!F&&te.current.emit("nodes:move",{workflowId:j,nodes:m})},[j,F]),A=t.useCallback(m=>{te.current&&ae.current&&j&&!F&&te.current.emit("edge:add",{workflowId:j,edge:m})},[j,F]),I=t.useCallback(m=>{te.current&&ae.current&&j&&!F&&te.current.emit("edge:delete",{workflowId:j,edgeId:m})},[j,F]),G=t.useCallback(m=>{te.current&&ae.current&&j&&!F&&te.current.emit("groups:update",{workflowId:j,groups:m})},[j,F]);return{isConnected:ae.current,onlineUsers:ne,emitNodeAdd:de,emitNodeUpdate:me,emitNodeDelete:Ee,emitNodeMove:Z,emitNodesMove:z,emitEdgeAdd:A,emitEdgeDelete:I,emitGroupsUpdate:G}}const Cr=1920,Hr=(s,j=Cr,n=.9)=>new Promise((F,ye)=>{const U=new Image,fe=URL.createObjectURL(s);U.onload=()=>{URL.revokeObjectURL(fe);let{width:Q,height:re}=U;if(Q>j||re>j){const he=j/Math.max(Q,re);Q=Math.round(Q*he),re=Math.round(re*he)}const K=document.createElement("canvas");K.width=Q,K.height=re;const ce=K.getContext("2d");if(!ce){ye(new Error("Failed to get canvas context"));return}ce.drawImage(U,0,0,Q,re);const Ue=K.toDataURL("image/jpeg",n);F(Ue)},U.onerror=()=>{URL.revokeObjectURL(fe),ye(new Error("Failed to load image for compression"))},U.src=fe}),Or=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(n=>n.test(s)):!1,Ha=async s=>{try{const j=s.startsWith("/uploads/")?`https://api.waule.com${s}`:s,F=await(await fetch(j)).blob();return await Hr(F,Cr,.9)}catch(j){throw j}},dr=async s=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(s.length>500*1024)try{const n=await(await fetch(s)).blob();return await Hr(n,Cr,.9)}catch{return s}return s}return s.includes("aliyuncs.com")||s.includes("oss-cn-")||s.startsWith("https://")&&!Or(s)?s:Or(s)?await Ha(s):s},St=({type:s,position:j,id:n,className:F="",label:ye,isConnectable:U,disabled:fe,style:Q,...re})=>{const K=j===ut.Left,ce=U===!1||fe?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-neutral-400 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${F}`;return e.jsxs("div",{className:`absolute ${K?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...Q||{}},children:[K&&ye&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:ye}),e.jsx(us,{type:s,position:j,id:n,isConnectable:fe?!1:U,style:{position:"relative",[K?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${ce} !z-[10001]`,...re}),!K&&ye&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:ye})]})},os=({value:s,onChange:j,options:n,className:F=""})=>{const[ye,U]=t.useState(!1),fe=t.useRef(null);t.useEffect(()=>{if(!ye)return;const K=ce=>{fe.current&&!fe.current.contains(ce.target)&&U(!1)};return document.addEventListener("mousedown",K,!0),()=>document.removeEventListener("mousedown",K,!0)},[ye]);const Q=n.find(K=>K.value===s),re=K=>{K.stopPropagation(),U(!ye)};return e.jsxs("div",{className:`relative ${F}`,ref:fe,children:[e.jsxs("div",{onClick:re,onMouseDown:K=>K.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(Q==null?void 0:Q.label)||s}),e.jsx(Ca,{size:12,className:`transition-transform ${ye?"rotate-90":""}`})]}),ye&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white dark:bg-[#18181b] backdrop-blur-xl border-slate-200 dark:border-white/10",children:n.map(K=>e.jsxs("div",{onClick:ce=>{ce.stopPropagation(),j(K.value),U(!1)},onMouseDown:ce=>ce.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[K.label,s===K.value&&e.jsx(Da,{size:10,className:"text-neutral-500"})]},K.value))})]})},Us=s=>{const[j,n]=t.useState(null),[F,ye]=t.useState(!1),[U,fe]=t.useState(!1),[Q,re]=t.useState(0),[K,ce]=t.useState(0),Ue=t.useCallback(()=>{ce(he=>he+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){n(null),fe(!1),re(0);return}try{ye(!0);const ae=(await Ce.post("/billing/estimate",s)).data,je=(ae==null?void 0:ae.data)??ae,ne=(je==null?void 0:je.originalCredits)??(je==null?void 0:je.credits)??0;n(ne),fe((je==null?void 0:je.isFreeUsage)??!1),re((je==null?void 0:je.freeUsageRemaining)??0)}catch{n(null),fe(!1),re(0)}finally{ye(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,K]),{credits:j,loading:F,isFreeUsage:U,freeUsageRemaining:Q,refetch:Ue}},gs=({createdBy:s,isSharedWorkflow:j})=>{if(!j||!s||typeof s=="string")return null;const{nickname:n,avatar:F}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:n||"æœªçŸ¥ç”¨æˆ·",children:F?e.jsx("img",{src:F,alt:n||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-neutral-800 to-neutral-700 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(n||"?")[0].toUpperCase()})})},Xa=({data:s,selected:j,id:n})=>{var oe;const[F,ye]=t.useState(s.isExpanded!==!1),[U,fe]=t.useState(null),[Q,re]=t.useState(s.config.prompt||""),[K,ce]=t.useState(s.config.ratio||""),[Ue,he]=t.useState(s.config.imageSize||"2K"),[te,ae]=t.useState(s.config.maxImages||1),[je,ne]=t.useState(!1),[,pe]=t.useState(0),[,de]=t.useState(s.config.taskId||""),[me,Ee]=t.useState(s.config.referenceImages||[]),[Z,z]=t.useState(null),A=t.useRef(null),I=t.useRef(!1),{setNodes:G,setEdges:m,getNode:c,getEdges:S,getNodes:P}=Zt(),$=Ds(),N=Fs(k=>k.edges.filter(u=>u.target===n)),O=t.useRef(""),r=t.useRef(""),{credits:v,loading:g,isFreeUsage:a,freeUsageRemaining:y,refetch:d}=Us({aiModelId:U==null?void 0:U.id,quantity:1,resolution:Ue}),x=t.useMemo(()=>(s.models||[]).filter(k=>k.type==="IMAGE_GENERATION"&&k.isActive&&!k.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const k=x.find(u=>u.id===s.config.modelId);if(k){fe(k);const u=k.config;u!=null&&u.supportedRatios&&u.supportedRatios.length>0&&!K&&ce(u.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(u==null?void 0:u.acceptedInputs)||["TEXT","IMAGE"]})}}else if(x.length>0){fe(x[0]);const k=x[0].config;k!=null&&k.supportedRatios&&k.supportedRatios.length>0&&!K&&ce(k.supportedRatios[0]),s.config.acceptedInputs||l({acceptedInputs:(k==null?void 0:k.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,x]),t.useEffect(()=>{const k=s.config.taskId;(async()=>{if(k)try{const b=(await Ce.tasks.getTaskStatus(k)).task;if(b.status==="SUCCESS"){ne(!1),pe(100);const q=b.resultUrl;if(!q){ne(!1),pe(0),l({taskId:""}),Gt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ue=s.config.ratio||"1:1";l({prompt:s.config.prompt||Q,ratio:ue,modelId:s.config.modelId||(U==null?void 0:U.id),generatedImageUrl:q,taskId:""});const H=P(),ge=S();if(H.filter(Re=>Re.type==="imagePreview"&&ge.some(Ae=>Ae.source===n&&Ae.target===Re.id)).find(Re=>Re.data.imageUrl===q)){l({taskId:""}),Gt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Gt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const Re=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Re).some($e=>$e.taskId&&$e.taskId===k||$e.sourceNodeId&&$e.sourceNodeId===n)||xe(q,ue)}catch{xe(q,ue)}}else b.status==="PROCESSING"||b.status==="PENDING"?(ne(!0),pe(b.progress||0),X(k)):b.status==="FAILURE"&&(ne(!1),pe(0),l({taskId:""}),Gt.error(b.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${b.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ne(!1),pe(0),l({taskId:""}),Gt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const p=()=>{if(!U)return[];const k=U.config;return(k==null?void 0:k.supportedRatios)||[]},w=()=>{var b;const k=(b=s==null?void 0:s.config)==null?void 0:b.modelId,u=x.find(q=>q.id===k)||x[0],E=(u==null?void 0:u.config)||{};return E.maxReferenceImages||E.supportedReferenceImagesLimit||E.referenceImagesLimit||10};function R(k){var E,b,q,ue,H,ge,Ie;const u=(k==null?void 0:k.type)||"";if(u==="upload")return(((b=(E=k==null?void 0:k.data)==null?void 0:E.config)==null?void 0:b.uploadedFiles)||[]).reduce((Re,Ae)=>{const _e=((Ae==null?void 0:Ae.type)||"").toUpperCase(),$e=((Ae==null?void 0:Ae.mimeType)||"").toLowerCase();return Re+(_e==="IMAGE"||$e.startsWith("image/")?1:0)},0);if(u==="assetSelector"){const Ne=((q=k==null?void 0:k.data)==null?void 0:q.config)||{};if(Ne.selectedAsset){const Re=(Ne.selectedAsset.type||"").toUpperCase(),Ae=(Ne.selectedAsset.mimeType||"").toLowerCase();return Re==="IMAGE"||Ae.startsWith("image/")?1:0}return Array.isArray(Ne.subjects)&&Ne.subjects.length>0&&(((ue=Ne.subjects[0])==null?void 0:ue.images)||[]).length>0?1:0}return u==="aiImage"?((ge=(H=k==null?void 0:k.data)==null?void 0:H.config)==null?void 0:ge.generatedImageUrl)?1:0:u==="imagePreview"&&((Ie=k==null?void 0:k.data)==null?void 0:Ie.imageUrl)?1:0}function W(k){var b,q,ue,H;const u=(k==null?void 0:k.type)||"",E=k==null?void 0:k.data;if(u==="upload"&&((q=(b=E==null?void 0:E.config)==null?void 0:b.uploadedFiles)==null?void 0:q.length)>0){const ge=E.config.uploadedFiles[0],Ie=(ge.type||"").toUpperCase(),Ne=(ge.mimeType||"").toLowerCase();return Ie==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ie==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ie==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ie||null}if(u==="assetSelector"){if((ue=E==null?void 0:E.config)!=null&&ue.subjects)return"IMAGE";if((H=E==null?void 0:E.config)!=null&&H.selectedAsset){const ge=E.config.selectedAsset,Ie=(ge.type||"").toUpperCase(),Ne=(ge.mimeType||"").toLowerCase();return Ie==="IMAGE"||Ne.startsWith("image/")?"IMAGE":Ie==="VIDEO"||Ne.startsWith("video/")?"VIDEO":Ie==="AUDIO"||Ne.startsWith("audio/")?"AUDIO":Ie||null}}return u==="aiImage"||u==="imagePreview"?"IMAGE":(u||"").startsWith("aiVideo")||u==="videoPreview"?"VIDEO":u==="agent"?"TEXT":null}const _=t.useMemo(()=>{const k=N,u=k.some(q=>{const ue=c(q.source);return((ue==null?void 0:ue.type)||"")==="agent"}),E=w(),b=k.reduce((q,ue)=>q+R(c(ue.source)),0);return u&&b>=E},[N,c]),h=k=>{const u=c(k.source);if(!u)return!1;const E=u.type||"",b=S().filter(Ne=>Ne.target===n),q=W(u);if(q==="VIDEO"||q==="AUDIO"||q==="DOCUMENT")return!1;const ue=b.some(Ne=>{const Re=c(Ne.source);return((Re==null?void 0:Re.type)||"")==="agent"});if(E==="agent"||E==="textPreview")return!ue;const H=b.reduce((Ne,Re)=>Ne+R(c(Re.source)),0),ge=R(u),Ie=w();return H+ge<=Ie};t.useEffect(()=>{const k=N;let E=w();const b=[];k.forEach(q=>{const ue=c(q.source),H=R(ue);H<=0||(E-H>=0?E-=H:b.push(q.id))}),b.length>0&&(m(q=>q.filter(ue=>!b.includes(ue.id))),Gt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[N,c,m]),t.useEffect(()=>{const k=N,u=[];k.forEach(E=>{const b=c(E.source),q=W(b);(q==="VIDEO"||q==="AUDIO"||q==="DOCUMENT")&&u.push(E.id)}),u.length>0&&(m(E=>E.filter(b=>!u.includes(b.id))),Gt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[N,c,m]),t.useEffect(()=>{const k=N.map(ue=>{var Ne,Re,Ae,_e,$e;const H=c(ue.source);if(!H)return`${ue.id}-${ue.source}`;const ge=H.data||{};let Ie=[];if(H.type==="assetSelector"){const le=(Ne=ge.config)==null?void 0:Ne.subjects;if(le&&le.length>0){const Ge=(Re=le[0].images)==null?void 0:Re[0];Ie=Ge?[Ge]:[]}else(Ae=ge.config)!=null&&Ae.selectedAsset&&ge.config.selectedAsset.type==="IMAGE"&&(Ie=[ge.config.selectedAsset.url])}else if(H.type==="upload")Ie=(((_e=ge.config)==null?void 0:_e.uploadedFiles)||[]).filter(Ge=>Ge.type==="IMAGE").map(Ge=>Ge.url);else if(H.type==="aiImage"||H.type==="imagePreview"){const le=(($e=ge.config)==null?void 0:$e.generatedImageUrl)||ge.imageUrl;le&&(Ie=[le])}return`${ue.id}-${ue.source}-${Ie.join("|")}`}).sort().join(",");if(k===O.current)return;O.current=k;const u=[];let E="";N.forEach(ue=>{var ge,Ie,Ne,Re,Ae,_e;const H=c(ue.source);if(H){const $e=H.data;if(H.type==="agent"&&((ge=$e.config)!=null&&ge.generatedText)?E||(E=$e.config.generatedText):H.type==="textPreview"&&$e.content&&(E||(E=$e.content)),H.type==="assetSelector"&&((Ie=$e.config)!=null&&Ie.subjects)&&$e.config.subjects.length>0){const Ge=(Ne=$e.config.subjects[0].images)==null?void 0:Ne[0];Ge&&!u.includes(Ge)&&u.push(Ge)}let le=((Re=$e.config)==null?void 0:Re.generatedImageUrl)||$e.imageUrl||"";if(!le&&((Ae=$e.config)!=null&&Ae.selectedAsset)){const Ge=$e.config.selectedAsset;Ge.type==="IMAGE"&&(le=Ge.url)}if(!le&&((_e=$e.config)!=null&&_e.uploadedFiles)&&$e.config.uploadedFiles.length>0){const Ge=$e.config.uploadedFiles[0];Ge.type==="IMAGE"&&(le=Ge.url)}le&&!u.includes(le)&&u.push(le)}});const b=w(),q=u.slice(0,Math.max(0,b));Ee(q),l({referenceImages:q}),E&&E!==Q&&(re(E),l({prompt:E}))},[N,c,n,Q,$]),t.useEffect(()=>{if(N.length===0)return;let k="",u="";N.forEach(E=>{var q;const b=$.find(ue=>ue.id===E.source);if(b&&b.type==="agent"){const ue=b.data;(q=ue.config)!=null&&q.generatedText&&(k=ue.config.generatedText,u=`${b.id}-${ue.config.generatedText.substring(0,50)}`)}}),k&&u!==r.current&&(r.current=u,re(k),l({prompt:k}))},[$,N,n]),t.useEffect(()=>{const k=A.current;k&&F&&requestAnimationFrame(()=>{k.style.height="auto";const u=Math.max(60,Math.min(k.scrollHeight,600));k.style.height=`${u}px`})},[Q,F]),t.useEffect(()=>{const k=setTimeout(()=>{Q!==s.config.prompt&&l({prompt:Q})},300);return()=>clearTimeout(k)},[Q]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==Q&&re(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{K&&K!==s.config.ratio&&l({ratio:K})},[K]),t.useEffect(()=>{Ue&&Ue!==s.config.imageSize&&l({imageSize:Ue})},[Ue]),t.useEffect(()=>{var k;if((U==null?void 0:U.modelId)==="gemini-3-pro-image-preview"){const u=((k=U==null?void 0:U.config)==null?void 0:k.supportedResolutions)||[];(u.length>0&&!u.includes(Ue)||u.length===1)&&he(u[0])}},[U]),t.useEffect(()=>{te!==s.config.maxImages&&l({maxImages:te})},[te]);const l=k=>{c(n)&&G(E=>E.map(b=>b.id===n?{...b,data:{...b.data,config:{...b.data.config,...k}}}:b))},i=k=>{z(k)},B=(k,u)=>{if(k.preventDefault(),Z===null||Z===u)return;const E=[...me],b=E[Z];E.splice(Z,1),E.splice(u,0,b),Ee(E),z(u)},M=()=>{z(null),l({referenceImages:me})},X=async k=>{let E=0;const b=async()=>{var q;try{E++;const H=(await Ce.tasks.getTaskStatus(k)).task;if(pe(H.progress||0),H.status==="SUCCESS"){ne(!1),pe(100);const ge=H.resultUrl,Ie=(q=H.metadata)==null?void 0:q.allImageUrls;l({prompt:Q,ratio:K,modelId:U==null?void 0:U.id,generatedImageUrl:ge,taskId:""}),Ie&&Ie.length>1?(ie(Ie,K),Gt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Ie.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(xe(ge,K),Gt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(H.status==="FAILURE"){ne(!1),pe(0),l({taskId:""});const{useAuthStore:ge}=await xs(async()=>{const{useAuthStore:Ne}=await import("./index-DRJ_08Rm.js").then(Re=>Re.f);return{useAuthStore:Ne}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ie}=ge.getState();await Ie(),Gt.error(H.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(H.status==="PROCESSING"||H.status==="PENDING")&&(E<600?setTimeout(b,1e3):(ne(!1),pe(0),l({taskId:""}),Gt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ne(!1),pe(0),l({taskId:""}),Gt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};b()},V=async()=>{var k,u,E,b,q;if(!(!Q.trim()||!U)){ne(!0),pe(0);try{let ge=[];if(me.length>0)try{for(const Ge of me){if(Ge.startsWith("http")||Ge.startsWith("/"))try{const Ct=(await fetch(Ge,{method:"HEAD"})).headers.get("content-length");if(Ct&&parseInt(Ct)>10485760){Gt.error("å‚è€ƒå›¾ç‰‡è¶…è¿‡ 10MB é™åˆ¶ï¼Œè¯·å‹ç¼©åé‡è¯•"),ne(!1);return}}catch{}const Qe=await dr(Ge);ge.push(Qe)}}catch{}let Ie=Q.trim();U.modelId==="doubao-seedream-4-5-251128"&&te>1&&(Ie=`ç”Ÿæˆä¸€ç»„å…±${te}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${Ie}`),U.modelId==="gemini-3-pro-image-preview"&&K&&(Ie=`${Ie}ï¼Œç”Ÿæˆ${K}çš„æ¯”ä¾‹`);const Ne={modelId:U.id,prompt:Ie,ratio:K||"1:1",referenceImages:ge.length>0?ge:void 0};U.modelId==="gemini-3-pro-image-preview"&&(Ne.imageSize=Ue),U.modelId==="doubao-seedream-4-5-251128"&&te>1&&(Ne.maxImages=te);const Re=await Ce.tasks.createImageTask(Ne),Ae=Re.taskId,_e=Re.creditsCharged||0,$e=Re.isFreeUsage,le=Re.freeUsageRemaining??0;if(de(Ae),l({prompt:Q,ratio:K,modelId:U.id,taskId:Ae}),$e)Gt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${le} æ¬¡æœºä¼š`),d();else if(_e>0){const{useAuthStore:Ge}=await xs(async()=>{const{useAuthStore:Wt}=await import("./index-DRJ_08Rm.js").then(Ct=>Ct.f);return{useAuthStore:Wt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Qe}=Ge.getState();await Qe(),Gt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${_e} ç§¯åˆ†`),d()}else Gt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");X(Ae)}catch(ue){if(ne(!1),pe(0),((k=ue.response)==null?void 0:k.status)===403){const H=((E=(u=ue.response)==null?void 0:u.data)==null?void 0:E.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Gt.error(H)}else{const H=((q=(b=ue.response)==null?void 0:b.data)==null?void 0:q.error)||ue.message||"æœªçŸ¥åŸå› ";Gt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${H}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ie=(k,u)=>{!k||k.length===0||k.forEach((E,b)=>{setTimeout(()=>{xe(E,u,b)},b*100)})},xe=(k,u,E)=>{const b=c(n);if(!b)return;const q=1,ue=P(),H=S(),ge=ue.filter(yt=>yt.type==="imagePreview"&&H.some(Be=>Be.source===n&&Be.target===yt.id));if(ge.find(yt=>yt.data.imageUrl===k))return;const Ne=400,Re=(yt,Be=300)=>{if(!yt||!/^[0-9]+\s*:\s*[0-9]+$/.test(yt))return Be;const[wt,Yt]=yt.split(":").map(vs=>parseFloat(vs));return!wt||!Yt?Be:Math.round(Ne*(Yt/wt))},Ae=document.querySelector(`.react-flow__node[data-id="${n}"]`),_e=(Ae==null?void 0:Ae.getBoundingClientRect().width)||400,$e=Math.round(_e/q),le=200,Ge=100,Qe=Re(u,300),Wt=b.position.x+$e+le,Ct=b.position.y,_t=E!==void 0?ge.length+E:ge.length,ct=Wt,gt=Ct+_t*(Qe+Ge),vt=Date.now(),it={id:`preview-${n}-${vt}`,type:"imagePreview",position:{x:ct,y:gt},data:{imageUrl:k,width:Ne,ratio:u,workflowContext:b.data.workflowContext,createdBy:b.data.createdBy}};G(yt=>[...yt,it]);const Ye={id:`edge-${n}-${it.id}`,source:n,target:it.id,targetHandle:`${it.id}-target`,type:"aurora"};m(yt=>yt.find(wt=>wt.source===n&&wt.target===it.id)?yt:[...yt,Ye])};if(t.useEffect(()=>{s.isExpanded!==void 0&&ye(s.isExpanded)},[s.isExpanded]),!F&&s.config.generatedImageUrl){const[k,u]=(s.config.ratio||"1:1").split(":").map(Number),E=k/u,b=320,q=b/E;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:b,height:q},onDoubleClick:()=>{ye(!0),c(n)&&G(H=>H.map(ge=>ge.id===n?{...ge,data:{...ge.data,isExpanded:!0}}:ge))},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:_,isValidConnection:h}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),Q&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:Q,children:Q})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!F&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{ye(!0),c(n)&&G(u=>u.map(E=>E.id===n?{...E,data:{...E.data,isExpanded:!0}}:E))},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:_,isValidConnection:h}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:Q})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:_,isValidConnection:h}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:(U==null?void 0:U.id)||"",onChange:k=>{const u=x.find(E=>E.id===k);if(fe(u||null),u){const E=u.config;E!=null&&E.supportedRatios&&E.supportedRatios.length>0&&ce(E.supportedRatios[0]),l({modelId:u.id,acceptedInputs:(E==null?void 0:E.acceptedInputs)||["TEXT","IMAGE"]})}},options:x.map(k=>({value:k.id,label:k.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:A,value:Q,onChange:k=>{I.current=!0,re(k.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),me.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",me.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:me.map((k,u)=>e.jsxs("div",{draggable:!0,onDragStart:E=>{E.stopPropagation(),i(u)},onDragEnd:E=>{E.stopPropagation(),M()},onDragOver:E=>{E.stopPropagation(),B(E,u)},className:`nodrag relative group cursor-move aspect-square ${Z===u?"opacity-50":""}`,children:[e.jsx("img",{src:k,alt:`å›¾ç‰‡${u+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:u+1})]},u))})]}),(U==null?void 0:U.modelId)==="gemini-3-pro-image-preview"&&(()=>{var u;const k=((u=U==null?void 0:U.config)==null?void 0:u.supportedResolutions)||[];return k.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${k.length} gap-2`,children:k.map(E=>e.jsx("button",{onClick:()=>he(E),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Ue===E?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:E==="4K"?"4k":"hd"}),e.jsx("span",{children:E})]})},E))})]})})(),(U==null?void 0:U.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-neutral-500 dark:text-neutral-400",children:[te," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:te,onChange:k=>ae(Number(k.target.value)),className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(te-1)/14*50}%, #06b6d4 ${(te-1)/14*100}%, var(--range-bg-color) ${(te-1)/14*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),te>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),p().length>0&&e.jsx("div",{className:"space-y-1",children:((oe=U==null?void 0:U.provider)==null?void 0:oe.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>ce("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${K==="16:9"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>ce("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${K==="9:16"?"bg-neutral-600 text-white border-neutral-500":"bg-neutral-950/50 text-neutral-300 border-neutral-700/30 hover:bg-neutral-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(os,{value:K,onChange:k=>ce(k),options:p().map(k=>{const[u,E]=k.split(":");return{value:k,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[k]||`${u}:${E}`}})})]})}),e.jsx("button",{onClick:V,onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),disabled:je||!Q.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${je||!Q.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:je?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(fr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!g&&(a?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(y),"æ¬¡"]}):v!==null&&v>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[v,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ja=t.memo(Xa),hr="https://api.waule.com",qa=({data:s,selected:j,id:n})=>{var sr,rr,Ls,Y,se,Me,Ve,qe,Oe,tt,bt;const[F,ye]=t.useState(!0),[,U]=t.useState(0),[fe,Q]=t.useState(s.config.taskId||""),re=s.config.modelId,K=s.config.duration||5,ce=s.config.resolution||"720p",{credits:Ue,loading:he,isFreeUsage:te,freeUsageRemaining:ae,refetch:je}=Us({aiModelId:re,duration:K,resolution:ce});t.useEffect(()=>{},[fe]);const{setNodes:ne,setEdges:pe,getNode:de,getNodes:me,getEdges:Ee}=Zt(),Z=zs(),z=Ds(),A=t.useRef(""),I=(sr=s.config)==null?void 0:sr.selectedEditingCapability,G=t.useMemo(()=>{const T=(s.models||[]).filter(L=>{var be;return((be=L.provider)==null?void 0:be.toLowerCase())!=="sora"&&L.id!=="sora-video"});if(I){const L=T.filter(Se=>Se.type==="VIDEO_EDITING").filter(Se=>{var we;return Array.isArray((we=Se==null?void 0:Se.config)==null?void 0:we.supportedEditingCapabilities)&&Se.config.supportedEditingCapabilities.includes(I)}),be=T.filter(Se=>Se.type==="VIDEO_GENERATION").filter(Se=>{var kt,ht;if(I!=="è§†é¢‘æ¢äºº")return!1;const we=((kt=Se==null?void 0:Se.config)==null?void 0:kt.supportsVideoEditing)===!0,st=(Array.isArray((ht=Se==null?void 0:Se.config)==null?void 0:ht.supportedGenerationTypes)?Se.config.supportedGenerationTypes:[]).some(We=>(We||"").toLowerCase().includes("æ¢äºº")||(We||"").includes("è§†é¢‘æ¢äºº"));return we||st}),Te={};return[...L,...be].forEach(Se=>{Te[Se.id]||(Te[Se.id]=Se)}),Object.values(Te)}return T.filter(L=>L.type==="VIDEO_GENERATION")},[s.models,I]),[m,c]=t.useState(s.config.prompt||""),S=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==m&&c(s.config.prompt)},[s.config.prompt]);const[P,$]=t.useState(s.config.modelId||((rr=G[0])==null?void 0:rr.id)||""),[N,O]=t.useState(s.config.ratio||"16:9"),[r,v]=t.useState(s.config.resolution||""),g=t.useCallback(T=>{const L=(T||"").toLowerCase();return L?L.includes("æ–‡ç”Ÿ")||L.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":L.includes("é¦–å°¾")?"é¦–å°¾å¸§":L.includes("é¦–å¸§")||L.includes("first frame")||L.includes("start frame")||L.includes("initial frame")||L.includes("keyframe")?"é¦–å¸§":L.includes("å°¾å¸§")||L.includes("last frame")||L.includes("end frame")||L.includes("final frame")?"å°¾å¸§":L.includes("ä¸»ä½“å‚è€ƒ")||L.includes("å‚è€ƒ")||L.includes("reference image")||L.includes("image reference")||L.includes("ref image")?"å‚è€ƒå›¾":L.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":L.includes("first-last")||L.includes("two-frame")||L.includes("frame pair")?"é¦–å°¾å¸§":L.includes("first")?"é¦–å¸§":L.includes("last")?"å°¾å¸§":L.includes("subject")||L.includes("reference")?"å‚è€ƒå›¾":T||"":""},[]),[a,y]=t.useState((s.config.lockedGenerationType?g(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[d,x]=t.useState(s.config.duration||5),[p,w]=t.useState(s.config.audio||!1),[R,W]=t.useState(s.config.movementAmplitude||"auto"),[_,h]=t.useState(!1),[l,i]=t.useState([]),[B,M]=t.useState(null),[X,V]=t.useState(!1),[ie]=t.useState(""),[xe]=t.useState("confirm"),[oe]=t.useState(null),[k,u]=t.useState(!1),[E,b]=t.useState([]),[q,ue]=t.useState(""),[H,ge]=t.useState(0),[Ie,Ne]=t.useState(0),[Re,Ae]=t.useState({}),[_e,$e]=t.useState([]),le=G.find(T=>T.id===P);t.useEffect(()=>{var T,L;if(!G.find(be=>be.id===P)){const be=((T=G[0])==null?void 0:T.id)||"";$(be),ct({modelId:be,modelName:(L=G[0])==null?void 0:L.name})}},[G]),t.useEffect(()=>{var T;if((T=le==null?void 0:le.config.supportedResolutions)!=null&&T.length){const L=le.config.supportedResolutions;if(!r||!L.includes(r)){const be=L[0];v(be),ct({resolution:be})}}},[le==null?void 0:le.id]),t.useEffect(()=>{var be;const T=(be=le==null?void 0:le.modelId)==null?void 0:be.includes("viduq2"),L=g(a)==="é¦–å°¾å¸§";T&&L&&d>8&&(x(8),ct({duration:8}))},[a,le==null?void 0:le.modelId]);const Ge=((Ls=le==null?void 0:le.provider)==null?void 0:Ls.toLowerCase())==="sora",Qe=t.useMemo(()=>{var T,L,be,Te;if((T=le==null?void 0:le.config.supportedDurations)!=null&&T.length){let Se=le.config.supportedDurations;const we=(L=le.modelId)==null?void 0:L.includes("viduq2"),et=g(a)==="é¦–å°¾å¸§";return we&&et&&(Se=Se.filter(kt=>kt<=8)),(((be=le.provider)==null?void 0:be.toLowerCase())==="minimax"||((Te=le.modelId)==null?void 0:Te.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(Se=Se.filter(kt=>kt===6)),Se}return[d||5]},[le,d,a,g,r]),Wt=t.useMemo(()=>{var T;return(T=le==null?void 0:le.config.supportedResolutions)!=null&&T.length?le.config.supportedResolutions:[]},[le]),Ct=!le||!((Y=le.config.supportedDurations)!=null&&Y.length),_t=!le||!((se=le.config.supportedResolutions)!=null&&se.length),ct=t.useCallback(T=>{de(n)&&ne(be=>be.map(Te=>Te.id===n?{...Te,data:{...Te.data,config:{...Te.data.config,...T}}}:Te))},[de,n,ne]);t.useEffect(()=>{if(Qe.length>0&&!Qe.includes(d)){const T=Qe[0];x(T),ct({duration:T})}},[Qe,d,ct]);const gt=(T,L)=>{const be=(kt,ht)=>ht===0?kt:be(ht,kt%ht),Te=be(T,L),Se=T/Te,we=L/Te,et={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},st=`${Se}:${we}`;return et[st]||st},vt=()=>{const T=Z.filter(et=>et.target===n),L=[];T.forEach(et=>{var kt;const st=de(et.source);if(st&&st.type==="upload"&&(((kt=st.data.config)==null?void 0:kt.uploadedFiles)||[]).forEach(We=>{const Dt=We.type||We.mimeType||"";(Dt==="IMAGE"||Dt.startsWith("image/"))&&L.push({id:We.id||We.name,url:We.url,name:We.name||We.originalName,width:We.width,height:We.height,aspectRatio:We.width&&We.height?gt(We.width,We.height):"16:9"})}),st&&st.type==="assetSelector"){const ht=st.data.config||{},We=ht.subjects,Dt=ht.selectedAsset,Xt=g(a);We&&We.length>0?Xt==="é¦–å°¾å¸§"||(We[0].images||[]).forEach((zt,At)=>{L.push({id:`${st.id}-subject-${At}`,url:zt,name:We[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Dt&&Dt.type==="IMAGE"&&L.push({id:Dt.id,url:Dt.url,name:Dt.name||Dt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(st&&st.type==="imagePreview"){const ht=st.data.imageUrl,We=st.data.width,Dt=st.data.height;ht&&L.push({id:st.id,url:ht,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:We,height:Dt,aspectRatio:We&&Dt?gt(We,Dt):"16:9"})}});const be=new Set,Te=[];L.forEach(et=>{const st=et.url;be.has(st)||(be.add(st),Te.push(et))});const Se=g(a);let we=[];return Se==="æ–‡ç”Ÿè§†é¢‘"?we=[]:Se==="é¦–å¸§"||Se==="å°¾å¸§"?we=Te.slice(0,1):Se==="é¦–å°¾å¸§"?we=Te.slice(0,2):Se==="å‚è€ƒå›¾"?we=Te.slice(0,7):we=Te,we},it=t.useMemo(()=>vt(),[Z,z,a,n]),Ye=T=>{if(!S.current)return;const L=S.current,be=L.selectionStart||m.length,Te=m.slice(0,be),Se=m.slice(be),we=`@${T} `,et=Te+we+Se;c(et),Ae(st=>({...st,[T]:`image-${T}`})),setTimeout(()=>{const st=be+we.length;L.setSelectionRange(st,st),L.focus()},0)},yt=t.useCallback(async()=>{var T;if(!(_e.length>0))try{const L=await Ce.assetLibraries.getAll({includeShared:"true"}),be=L.data||L||[],Te=[];for(const Se of be)if(Se.category==="ROLE")try{const we=await Ce.assetLibraries.roles.list(Se.id),et=we.data||we||[];for(const st of et)Te.push({id:st.id,name:((T=st.metadata)==null?void 0:T.name)||st.name||"",thumbnail:st.thumbnail})}catch{}$e(Te)}catch{}},[_e.length]),Be=t.useCallback(T=>{if(!T){b(_e.slice(0,5));return}const L=_e.filter(be=>be.name.toLowerCase().includes(T.toLowerCase())).slice(0,5);b(L),Ne(0)},[_e]),wt=t.useCallback(T=>{const L=T.target.value,be=T.target.selectionStart||0;c(L);const Se=L.substring(0,be).match(/@([^@\s]*)$/);if(Se){const we=Se[1];ue(we),ge(be-we.length-1),u(!0),yt().then(()=>Be(we))}else u(!1),b([])},[yt,Be]),Yt=t.useCallback(T=>{const L=m.substring(0,H),be=m.substring(H+q.length+1),Te=`@${T.name} `,Se=L+Te+be;c(Se),Ae(we=>({...we,[T.name]:T.id})),u(!1),b([]),ue(""),setTimeout(()=>{if(S.current){S.current.focus();const we=L.length+Te.length;S.current.setSelectionRange(we,we)}},0)},[m,H,q]),vs=t.useCallback(T=>{!k||E.length===0||(T.key==="ArrowDown"?(T.preventDefault(),Ne(L=>L<E.length-1?L+1:L)):T.key==="ArrowUp"?(T.preventDefault(),Ne(L=>L>0?L-1:L)):T.key==="Enter"&&E[Ie]?(T.preventDefault(),Yt(E[Ie])):T.key==="Escape"&&u(!1))},[k,E,Ie,Yt]);t.useEffect(()=>{const T=s.config.taskId;(async()=>{if(T){try{const Te=(await Ce.tasks.getTaskStatus(T)).task;if(Te.status==="SUCCESS"){h(!1),U(100);const Se=Te.resultUrl;if(!Se){h(!1),U(0),ct({taskId:""}),Q(""),f.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const we=s.config.ratio||"16:9";ct({prompt:s.config.prompt||m,ratio:we,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:Se,taskId:""}),Q("");const et=me(),st=Ee();if(et.filter(We=>We.type==="videoPreview"&&st.some(Dt=>Dt.source===n&&Dt.target===We.id)).find(We=>We.data.videoUrl===Se)){setTimeout(()=>U(0),1e3);return}f.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const We=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(We).some(Pt=>Pt.taskId&&Pt.taskId===T||Pt.sourceNodeId&&Pt.sourceNodeId===n)||ws(Se,we)}catch{ws(Se,we)}setTimeout(()=>U(0),1e3)}else if(Te.status==="PROCESSING"||Te.status==="PENDING"){h(!0),U(Te.progress||0),Xs(T);return}else Te.status==="FAILURE"&&(h(!1),U(0),ct({taskId:""}),Q(""),f.error(`ç”Ÿæˆå¤±è´¥: ${Te.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{h(!1),U(0),ct({taskId:""}),Q(""),f.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const T=Z.filter(be=>be.target===n);let L="";T.forEach(be=>{var Se;const Te=de(be.source);if(Te){const we=Te.data;Te.type==="agent"&&((Se=we.config)!=null&&Se.generatedText)?L||(L=we.config.generatedText):Te.type==="textPreview"&&we.content&&(L||(L=we.content))}}),L&&L!==m&&(c(L),ct({prompt:L}))},[Z,n,de,m,ct]),t.useEffect(()=>{const T=Z.filter(Te=>Te.target===n);if(T.length===0)return;let L="",be="";T.forEach(Te=>{var we;const Se=z.find(et=>et.id===Te.source);if(Se&&Se.type==="agent"){const et=Se.data;(we=et.config)!=null&&we.generatedText&&(L=et.config.generatedText,be=`${Se.id}-${et.config.generatedText.substring(0,50)}`)}}),L&&be!==A.current&&(A.current=be,c(L),ct({prompt:L}))},[z,Z,n,ct]),t.useEffect(()=>{const T=JSON.stringify(it),L=JSON.stringify(l);T!==L&&i(it)},[it]);const Is=t.useMemo(()=>{const T=l.length,L=g(a);return T===0?!0:T===1?L==="å‚è€ƒå›¾":T===2?L==="é¦–å°¾å¸§"?!1:L==="å‚è€ƒå›¾":T>2?L==="å‚è€ƒå›¾":!1},[l.length,a,g]),Ss=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Ns=t.useMemo(()=>{const T=g(a);return I?G:G.filter(L=>{var Te;const be=(((Te=L.config)==null?void 0:Te.supportedGenerationTypes)||[]).map(Se=>g(Se));return T==="é¦–å¸§"||T==="å°¾å¸§"?be.includes("é¦–å¸§")||be.includes("å°¾å¸§"):be.includes(T)})},[G,a,g,I]),Bs=t.useMemo(()=>{const T=I?G:Ns;return T.length>0?T:I?(s.models||[]).filter(be=>(be.type||"")==="VIDEO_EDITING"):T},[I,G,Ns,s.models]);t.useEffect(()=>{var L,be;if(!Bs.find(Te=>Te.id===P)){const Te=((L=Bs[0])==null?void 0:L.id)||"";$(Te),ct({modelId:Te||void 0,modelName:Te?(be=Bs[0])==null?void 0:be.name:void 0})}},[Bs]);const hs=t.useCallback(T=>{const L=g(T);return I?["IMAGE","VIDEO"]:L==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[g,I]);t.useEffect(()=>{if(!Is&&l.length>0){const T=l[0].aspectRatio;T&&N!==T&&(O(T),setTimeout(()=>{ct({ratio:T})},0))}},[Is,l,N]),t.useEffect(()=>{if(!I&&Ss.length>0&&!Ss.includes(a)){const T="æ–‡ç”Ÿè§†é¢‘";y(T),setTimeout(()=>{ct({generationType:T,acceptedInputs:hs(T)})},0)}},[Ss,a,hs,I]),t.useEffect(()=>{g(a)==="é¦–å°¾å¸§"&&p&&(w(!1),ct({audio:!1}))},[a,g]),t.useEffect(()=>{const T=g(a);if(T==="æ–‡ç”Ÿè§†é¢‘")return;const L=Z.filter(we=>we.target===n),be=[],Te=[];L.forEach(we=>{var kt,ht,We,Dt,Xt;const et=de(we.source);if(!et)return;const st=et.type;if((st||"").startsWith("aiVideo")||st==="videoPreview"){Te.push(we.id);return}if(st==="upload"){const Pt=(We=(ht=(kt=et.data)==null?void 0:kt.config)==null?void 0:ht.uploadedFiles)==null?void 0:We[0],zt=((Pt==null?void 0:Pt.type)||"").toUpperCase(),At=((Pt==null?void 0:Pt.mimeType)||"").toLowerCase();if(zt==="VIDEO"||At.startsWith("video/")){Te.push(we.id);return}(zt==="IMAGE"||At.startsWith("image/"))&&be.push(we.id);return}if(st==="assetSelector"){const Pt=((Dt=et.data)==null?void 0:Dt.config)||{};if(Pt.selectedAsset){const zt=(Pt.selectedAsset.type||"").toUpperCase(),At=(Pt.selectedAsset.mimeType||"").toLowerCase();zt==="VIDEO"||At.startsWith("video/")?Te.push(we.id):(zt==="IMAGE"||At.startsWith("image/"))&&be.push(we.id)}else if(Pt.subjects&&Pt.subjects.length>0){const zt=(((Xt=Pt.subjects[0])==null?void 0:Xt.images)||[]).length;T==="å‚è€ƒå›¾"||T==="é¦–å°¾å¸§"?be.push(we.id):(T==="é¦–å¸§"||T==="å°¾å¸§")&&(zt>1?Te.push(we.id):be.push(we.id))}return}(st==="aiImage"||st==="imagePreview")&&be.push(we.id)});let Se=new Set([...Te]);T==="é¦–å¸§"||T==="å°¾å¸§"?be.slice(1).forEach(we=>Se.add(we)):T==="é¦–å°¾å¸§"&&be.slice(2).forEach(we=>Se.add(we)),Se.size>0&&pe(we=>we.filter(et=>!Se.has(et.id)))},[a,Z,n,de,pe,g]),t.useEffect(()=>{const T=s.config.generationType;if(!T||g(T)!==g(a)){const L=g(a)||"æ–‡ç”Ÿè§†é¢‘";ct({generationType:L,acceptedInputs:hs(L)})}},[]),t.useEffect(()=>{const T=hs(a);ct({acceptedInputs:T})},[a,hs]);const Qs=T=>{M(T)},Hs=T=>{T.preventDefault()},nr=T=>{if(B===null)return;const L=[...l],[be]=L.splice(B,1);L.splice(T,0,be),i(L),M(null),ct({referenceImages:L})};t.useEffect(()=>{const T=S.current;T&&F&&requestAnimationFrame(()=>{T.style.height="auto";const L=Math.max(60,Math.min(T.scrollHeight,600));T.style.height=`${L}px`})},[m,F]),t.useEffect(()=>{if(m===s.config.prompt)return;const T=setTimeout(()=>{ct({prompt:m})},500);return()=>clearTimeout(T)},[m]);const Tt=T=>{var be,Te,Se;$(T);const L=Ns.find(we=>we.id===T);if(L){const we=(be=L.config.supportedRatios)!=null&&be.length?L.config.supportedRatios:["16:9"],et=L.config.supportedResolutions||[],st=(Te=L.config.supportedGenerationTypes)!=null&&Te.length?L.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],kt=(Se=L.config.supportedDurations)!=null&&Se.length?L.config.supportedDurations:[5],ht=we[0],We=et.length>0?et[0]:r,Dt=g(a||st[0]),Xt=kt[0],Pt=L.config.supportsAudioOutput?p:!1;O(ht),v(We),y(Dt),x(Xt),L.config.supportsAudioOutput||w(!1),ct({modelId:T,modelName:L.name,ratio:ht,resolution:We,generationType:Dt,duration:Xt,audio:Pt,acceptedInputs:hs(Dt)})}};t.useEffect(()=>{var L;const T=(L=s==null?void 0:s.config)==null?void 0:L.generatedVideoUrl;T&&ws(T,s.config.ratio||"16:9")},[(Me=s==null?void 0:s.config)==null?void 0:Me.generatedVideoUrl]);const Xs=async T=>{let be=0;const Te=async()=>{try{be++;const we=(await Ce.tasks.getTaskStatus(T)).task;if(U(we.progress||0),we.status==="SUCCESS"||we.status==="COMPLETED"||we.status==="DONE"){h(!1),U(100);const et=we.resultUrl;ws(et,s.config.ratio||"16:9"),ct({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:et}),Q(""),f.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>U(0),1e3);return}else if(we.status==="FAILURE"){h(!1),U(0),ct({taskId:""});const{useAuthStore:et}=await xs(async()=>{const{useAuthStore:kt}=await import("./index-DRJ_08Rm.js").then(ht=>ht.f);return{useAuthStore:kt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:st}=et.getState();await st(),f.error(we.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(we.status==="PROCESSING"||we.status==="PENDING")&&(be<600?setTimeout(Te,1e3):(h(!1),U(0),ct({taskId:""}),f.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{h(!1),U(0),ct({taskId:""}),f.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Te()},bs=async()=>{var be,Te,Se,we,et,st,kt;if(g(a)==="æ–‡ç”Ÿè§†é¢‘"&&!m.trim()){f.error("è¯·è¾“å…¥æç¤ºè¯");return}h(!0);const L=vt();ct({referenceImages:L}),U(0);try{let ht=[],We;const Dt=l.length;if(l.length>0)try{for(const ps of l){let Bt=ps.url;!Bt.startsWith("data:")&&!Bt.startsWith("http")&&(Bt=`${hr}${Bt}`),Bt=Bt.replace(/^https?:\/\/localhost(?::\d+)?/i,hr);const Jt=await dr(Bt);ht.push(Jt)}}catch{f.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Xt=Z.filter(ps=>ps.target===n);let Pt=[];if(g(a)==="å‚è€ƒå›¾"){const ps=/@(\S+)/g,Jt=[...m.matchAll(ps)].map(ds=>ds[1]);for(const ds of Jt){const ss=Re[ds];ss&&Pt.push(ss)}const as=new Map;for(const ds of Xt){const ss=de(ds.source);if((ss==null?void 0:ss.type)==="assetSelector"){const Ps=(be=ss.data.config)==null?void 0:be.roleIds;if(Ps&&Ps.length>0)for(const fs of Ps)Pt.includes(fs)||Pt.push(fs);const ks=(Te=ss.data.config)==null?void 0:Te.subjects;if(ks&&ks.length>0){for(const fs of ks)if(!as.has(fs.name)){const qs=(fs.images||[]).map(Os=>Os.startsWith("http")||Os.startsWith("data:")?Os:`${hr}${Os}`);as.set(fs.name,qs)}}}}if(as.size>0){const ds=Array.from(as.entries());let ss=0;const Ps=[];for(const[ks,fs]of ds){if(ss>=7)break;const qs=7-ss,Os=fs.slice(0,Math.max(0,qs));Os.length>0&&(Ps.push({name:ks,images:Os}),ss+=Os.length)}We=Ps,ds.some(([,ks])=>ks.length>0)&&ss<ds.reduce((ks,[,fs])=>ks+fs.length,0)&&f.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(ht.length>0){const ds=it.filter(ss=>!ss.id.includes("subject"));ds.length>0&&(We||(We=[]),ds.forEach((ss,Ps)=>{const ks=`å›¾${Ps+1}`,fs=ss.url.startsWith("http")||ss.url.startsWith("data:")?ss.url:`${hr}${ss.url}`;We.push({name:ks,images:[fs]})}))}}const zt=We&&We.length>0?We.reduce((ps,Bt)=>{var Jt;return ps+(((Jt=Bt.images)==null?void 0:Jt.length)||0)},0):Dt,At=Pt.length>0;let Ut=a;if(Ut==="é¦–å¸§"||Ut==="å°¾å¸§"){if(zt!==1&&!At){f.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),h(!1),U(0);return}}else if(Ut==="é¦–å°¾å¸§"){if(zt===1)Ut="é¦–å¸§";else if(zt!==2&&!At){f.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),h(!1),U(0);return}We&&We.length>0?We=[{...We[0],images:We[0].images.slice(0,2)}]:ht=ht.slice(0,2)}else if(Ut==="å‚è€ƒå›¾"||Ut==="ä¸»ä½“å‚è€ƒ"){if(zt<1&&!At){f.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),h(!1),U(0);return}if(We&&We.length>0){if(We.reduce((Bt,Jt)=>{var as;return Bt+(((as=Jt.images)==null?void 0:as.length)||0)},0)>7){let Bt=7;We=We.map(Jt=>({...Jt,images:Jt.images.slice(0,Math.max(0,Bt-=Jt.images.length,Jt.images.length))})),Bt=7,We=We.map(Jt=>{const as=Jt.images.slice(0,Math.min(Jt.images.length,Bt));return Bt-=as.length,{...Jt,images:as}}).filter(Jt=>Jt.images.length>0),f.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else ht.length>7&&(ht=ht.slice(0,7),f.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}oe==="dropImages"&&(ht=[],We=void 0),(g(a)==="é¦–å¸§"||g(a)==="å°¾å¸§")&&oe==="useFirstImage"&&ht.length>=2&&(ht=[ht[0]]),g(a)==="é¦–å°¾å¸§"&&oe==="useFirstTwoImages"&&ht.length>=3&&(ht=ht.slice(0,2));const Vt={modelId:P,ratio:N,referenceImages:We&&We.length>0?void 0:ht.length>0?ht:void 0,roleIds:Pt.length>0?Pt:void 0,generationType:Ut,sourceNodeId:n,metadata:{duration:d,resolution:r,audio:p,movementAmplitude:R,roleIds:Pt.length>0?Pt:void 0},...We?{subjects:We}:{}};We&&We.length>0;const Ft=g(Ut);if(Ft==="æ–‡ç”Ÿè§†é¢‘"){if(!m.trim()){f.error("è¯·è¾“å…¥æç¤ºè¯"),h(!1),U(0);return}Vt.prompt=m.trim()}else if(Ft==="å‚è€ƒå›¾"){if(!m.trim()){f.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),h(!1),U(0);return}Vt.prompt=m.trim()}else m.trim()&&(Vt.prompt=m.trim());const ts=await Ce.tasks.createVideoTask(Vt),rs=ts.taskId,ys=ts.creditsCharged||0,Js=ts.isFreeUsage,Es=ts.freeUsageRemaining??0;if(Q(rs),ct({prompt:m,ratio:N,resolution:r,generationType:a,duration:d,modelId:P,taskId:rs}),Js)f.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Es} æ¬¡`),je();else if(ys>0){const{useAuthStore:ps}=await xs(async()=>{const{useAuthStore:Jt}=await import("./index-DRJ_08Rm.js").then(as=>as.f);return{useAuthStore:Jt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Bt}=ps.getState();await Bt(),f.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${ys} ç§¯åˆ†ï¼‰`),je()}else f.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Xs(rs)}catch(ht){if(h(!1),U(0),((Se=ht.response)==null?void 0:Se.status)===403){const We=((et=(we=ht.response)==null?void 0:we.data)==null?void 0:et.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";f.error(We)}else f.error(`æäº¤å¤±è´¥: ${((kt=(st=ht.response)==null?void 0:st.data)==null?void 0:kt.error)||ht.message}`)}},er=async()=>{const T=g(a),L=vt(),be=L.length,Te=(()=>{var et;const we=Z.filter(st=>st.target===n);for(const st of we){const kt=de(st.source);if((kt==null?void 0:kt.type)==="assetSelector"){const ht=(et=kt.data.config)==null?void 0:et.subjects;if(ht&&ht.length>0)return!0}}return!1})(),Se=Object.keys(Re).length>0;if((Te||Se)&&(T==="é¦–å¸§"||T==="å°¾å¸§"||T==="é¦–å°¾å¸§")){f.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((T==="é¦–å¸§"||T==="å°¾å¸§")&&be===0&&!Se){f.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(T==="é¦–å°¾å¸§"&&be===0&&!Se){f.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(T==="å‚è€ƒå›¾"&&be===0&&!Se){f.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(T==="æ–‡ç”Ÿè§†é¢‘"&&be>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((T==="é¦–å¸§"||T==="å°¾å¸§")&&be>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(T==="é¦–å°¾å¸§"&&be>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(T==="æ–‡ç”Ÿè§†é¢‘"&&!m.trim()){f.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!P){f.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}i(L),ct({referenceImages:L}),h(!0),U(0),await bs()},ws=(T,L)=>{const be=de(n);if(!be||!T)return;const Te=L||N||"16:9",Se=me(),we=Ee(),et=Se.filter(Bt=>Bt.type==="videoPreview"&&we.some(Jt=>Jt.source===n&&Jt.target===Bt.id));if(et.find(Bt=>Bt.data.videoUrl===T))return;const kt=1,ht=400,We=(Bt,Jt=300)=>{if(!Bt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Bt))return Jt;const[as,ds]=Bt.split(":").map(ss=>parseFloat(ss));return!as||!ds?Jt:Math.round(ht*(ds/as))},Dt=document.querySelector(`.react-flow__node[data-id="${n}"]`),Xt=Dt==null?void 0:Dt.getBoundingClientRect(),Pt=Math.round(((Xt==null?void 0:Xt.width)||400)/kt),zt=100,At=200,Ut=We(Te,300),Vt=et.length,Ft=be.position.x+Pt+At,ts=be.position.y,rs=Ft,ys=ts+Vt*(Ut+zt),Js=Date.now(),Es={id:`preview-${n}-${Js}`,type:"videoPreview",position:{x:rs,y:ys},data:{videoUrl:T,width:ht,ratio:Te,workflowContext:be.data.workflowContext,createdBy:be.data.createdBy}};ne(Bt=>[...Bt,Es]);const ps={id:`edge-${n}-${Es.id}`,source:n,target:Es.id,targetHandle:`${Es.id}-target`,type:"aurora"};pe(Bt=>Bt.find(as=>as.source===n&&as.target===Es.id)?Bt:[...Bt,ps])},tr=T=>{const L=T.target;if(L.tagName==="INPUT"||L.tagName==="TEXTAREA"||L.tagName==="SELECT"||L.tagName==="BUTTON"||L.closest("button")||L.closest("input")||L.closest("textarea")||L.closest("select"))return;const be=!F;ye(be),ne(Te=>Te.map(Se=>Se.id===n?{...Se,data:{...Se.data,isExpanded:be}}:Se))};return e.jsxs("div",{onDoubleClick:tr,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var ht;const T=((ht=de(n))==null?void 0:ht.type)||"",L=g(a),be=L==="æ–‡ç”Ÿè§†é¢‘"||T==="aiVideo_t2v",Te=T==="aiVideo_i2v_first"||T==="aiVideo_i2v_last"||L==="é¦–å¸§"||L==="å°¾å¸§",Se=T==="aiVideo_first_last"||L==="é¦–å°¾å¸§",we=T==="aiVideo_reference"||L==="å‚è€ƒå›¾",et=Z.filter(We=>We.target===n),st=et.some(We=>{const Dt=de(We.source);return(Dt==null?void 0:Dt.type)==="agent"}),kt=et.reduce((We,Dt)=>{var zt,At,Ut,Vt;const Xt=de(Dt.source),Pt=(Xt==null?void 0:Xt.type)||"";if(Pt==="aiImage"||Pt==="imagePreview")return We+1;if(Pt==="upload"){const Ft=(Ut=(At=(zt=Xt==null?void 0:Xt.data)==null?void 0:zt.config)==null?void 0:At.uploadedFiles)==null?void 0:Ut[0],ts=((Ft==null?void 0:Ft.type)||"").toUpperCase(),rs=((Ft==null?void 0:Ft.mimeType)||"").toLowerCase();return We+(ts==="IMAGE"||rs.startsWith("image/")?1:0)}if(Pt==="assetSelector"){const Ft=((Vt=Xt==null?void 0:Xt.data)==null?void 0:Vt.config)||{};if(Ft.selectedAsset)return We+((Ft.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ft.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Ft.subjects&&Ft.subjects.length>0)return We+((Ft.subjects[0].images||[]).length||0)}return We},0);return be?!st:Te?!(st&&kt>=1):Se?!(st&&kt>=2):we?!(st&&kt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),X&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ie}),xe==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{V(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{V(!1),f.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{V(!1),await bs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:P,onChange:T=>Tt(T),options:Ns.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Ns.map(T=>({value:T.id,label:T.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Ge?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:S,value:m,onChange:T=>{var Se;const L=(Se=le==null?void 0:le.modelId)==null?void 0:Se.includes("viduq2"),be=g(a)==="å‚è€ƒå›¾";L&&be?wt(T):(c(T.target.value),u(!1))},onKeyDown:T=>{var Te;const L=(Te=le==null?void 0:le.modelId)==null?void 0:Te.includes("viduq2"),be=g(a)==="å‚è€ƒå›¾";L&&be&&vs(T)},placeholder:(Ve=le==null?void 0:le.modelId)!=null&&Ve.includes("viduq2")&&g(a)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),k&&E.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:E.map((T,L)=>e.jsxs("button",{type:"button",onClick:()=>Yt(T),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${L===Ie?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[T.thumbnail?e.jsx("img",{src:T.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",T.name]})})]},T.id))})]})]}),Object.keys(Re).length>0&&((qe=le==null?void 0:le.modelId)==null?void 0:qe.includes("viduq2"))&&g(a)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys(Re).map(T=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-neutral-500/10 dark:bg-neutral-500/20 border border-neutral-400/50 dark:border-neutral-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-neutral-700 dark:text-neutral-300",children:T}),e.jsx("button",{type:"button",onClick:()=>{Ae(Te=>{const Se={...Te};return delete Se[T],Se});const L=new RegExp(`@${T}\\s*`,"g"),be=m.replace(L,"");c(be)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-neutral-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},T))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Ge&&l.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(Oe=l[0])!=null&&Oe.name&&l[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",a==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",g(a)==="å‚è€ƒå›¾"&&l.some(T=>!T.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:l.map((T,L)=>{const be=l.slice(0,L+1).filter(we=>!we.id.includes("subject")).length,Te=!T.id.includes("subject"),Se=Te?`å›¾${be}`:T.name;return e.jsxs("div",{draggable:a==="é¦–å°¾å¸§",onDragStart:()=>Qs(L),onDragOver:Hs,onDrop:()=>nr(L),onClick:()=>{Te&&g(a)==="å‚è€ƒå›¾"&&Ye(Se)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${a==="é¦–å°¾å¸§"?"cursor-move":Te&&g(a)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${B===L?"opacity-50":""} ${T.id.includes("subject")?"border-neutral-400 dark:border-neutral-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-neutral-400 dark:hover:border-neutral-400/50 ${Te&&g(a)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Te&&g(a)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${Se}`:T.name,children:[e.jsx("img",{src:`${T.url.startsWith("http")||T.url.startsWith("data:")?T.url:hr+T.url}`,alt:T.name,className:"w-full h-full object-cover"}),T.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),T.name]}),Te&&a!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),Se]}),a==="é¦–å°¾å¸§"&&!T.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:L===0?"é¦–":L===1?"å°¾":L+1})]},T.id)})})]}),le&&!Ge&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",Ct?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Qe.map(T=>e.jsxs("button",{type:"button",onClick:()=>{x(T),ct({duration:T})},disabled:Ct,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${d===T?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:[T,"ç§’"]},T))})]}),Is&&(((tt=le==null?void 0:le.config.supportedRatios)==null?void 0:tt.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Ge?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{O("16:9"),ct({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${N==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{O("9:16"),ct({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${N==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:N,onChange:T=>{O(T),ct({ratio:T})},options:((le==null?void 0:le.config.supportedRatios)||[]).map(T=>{const[L,be]=T.split(":");return{value:T,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[T]||`${L}:${be}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",_t?"(æœªé…ç½®)":""]}),e.jsx(os,{value:r,onChange:T=>{v(T),ct({resolution:T})},options:Wt.map(T=>({value:T,label:T})),className:_t?"opacity-50 pointer-events-none":""})]}),((bt=le==null?void 0:le.provider)==null?void 0:bt.toLowerCase())==="vidu"&&(le==null?void 0:le.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(T=>e.jsx("button",{type:"button",onClick:()=>{W(T),ct({movementAmplitude:T})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${R===T?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:T==="auto"?"è‡ªåŠ¨":T==="small"?"å°":T==="medium"?"ä¸­":"å¤§"},T))})]}),(le==null?void 0:le.config.supportsAudioOutput)&&g(a)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const T=!p;w(T),ct({audio:T})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${p?"bg-neutral-800 dark:bg-white text-white dark:text-black":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${p?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:er,disabled:_||s._canEdit===!1||g(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(m!=null&&m.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${_||g(a)==="æ–‡ç”Ÿè§†é¢‘"&&!(m!=null&&m.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:_?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!he&&(te?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ae),"æ¬¡"]}):Ue!==null&&Ue>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[Ue,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:m?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:m})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ur=t.memo(qa),Ya=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Ka=t.memo(Ya),Za=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},Qa=t.memo(Za),eo=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},to=t.memo(eo),so=s=>{const{data:j}=s;return e.jsx(ur,{...s,data:{...j,config:{...j==null?void 0:j.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},ro=t.memo(so),ao=s=>{const j=(s==null?void 0:s.data)||{},n=j.config||{};return e.jsx(ur,{...s,data:{...j,config:{...n,generationType:(n==null?void 0:n.lockedGenerationType)||(n==null?void 0:n.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(n==null?void 0:n.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(n==null?void 0:n.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(n==null?void 0:n.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},oo=t.memo(ao),lr="https://api.waule.com",no=({data:s,selected:j,id:n})=>{var $,N,O,r,v,g;const[F]=t.useState(!0),[ye,U]=t.useState(!1),[fe]=t.useState(""),[Q,re]=t.useState("wan-std"),[K,ce]=t.useState(0),Ue=t.useRef(null),{setNodes:he,setEdges:te,getNode:ae,getNodes:je,getEdges:ne}=Zt(),pe=zs(),de=s.config.modelId,{credits:me,loading:Ee}=Us({aiModelId:de,duration:K,mode:Q==="wan-pro"?"pro":"standard"}),Z=t.useMemo(()=>{var d;const a=s.models||[],y=(d=s==null?void 0:s.config)==null?void 0:d.selectedEditingCapability;return a.filter(x=>{var p;return(x.type||"")==="VIDEO_EDITING"&&Array.isArray((p=x.config)==null?void 0:p.supportedEditingCapabilities)&&(y?x.config.supportedEditingCapabilities.includes(y):x.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||x.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,($=s==null?void 0:s.config)==null?void 0:$.selectedEditingCapability]),[z,A]=t.useState(s.config.modelId||((N=Z[0])==null?void 0:N.id)||""),I=t.useMemo(()=>Z.find(a=>a.id===z),[Z,z]);t.useEffect(()=>{var a;if(!Z.find(y=>y.id===z)){const y=((a=Z[0])==null?void 0:a.id)||"";A(y),he(d=>d.map(x=>{var p;return x.id===n?{...x,data:{...x.data,config:{...x.data.config,modelId:y||void 0,modelName:y?(p=Z[0])==null?void 0:p.name:void 0}}}:x}))}},[Z]),t.useEffect(()=>{},[I]);const G=t.useMemo(()=>{var R,W,_,h,l,i,B,M,X,V,ie,xe,oe,k,u,E;const a=pe.filter(b=>b.target===n);let y=null,d=0,x=null,p=null,w=null;for(const b of a){const q=ae(b.source);if(!q)continue;const ue=String(q.type||"");if(ue==="upload"){const H=(_=(W=(R=q.data)==null?void 0:R.config)==null?void 0:W.uploadedFiles)==null?void 0:_[0];if(!H)continue;const ge=String(H.mimeType||"").toLowerCase(),Ie=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${lr}${H.url}`;!x&&(Ie==="VIDEO"||ge.startsWith("video/"))&&(x=Ne,w=b.id),!y&&(Ie==="IMAGE"||ge.startsWith("image/"))&&(y=Ne,d=H.size||0,p=b.id)}else if(ue==="assetSelector"){const H=(l=(h=q.data)==null?void 0:h.config)==null?void 0:l.selectedAsset;if(H){const Ie=String(H.mimeType||"").toLowerCase(),Ne=String(H.type||"").toUpperCase(),Re=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${lr}${H.url}`;!x&&(Ne==="VIDEO"||Ie.startsWith("video/"))&&(x=Re,w=b.id),!y&&(Ne==="IMAGE"||Ie.startsWith("image/"))&&(y=Re,d=H.size||0,p=b.id)}const ge=((B=(i=q.data)==null?void 0:i.config)==null?void 0:B.subjects)||[];if(!y&&Array.isArray(ge)&&ge.length>0){const Ne=(((M=ge[0])==null?void 0:M.images)||[])[0];Ne&&(y=Ne.startsWith("http")||Ne.startsWith("data:")?Ne:`${lr}${Ne}`,p=b.id)}}else if(ue==="aiImage"){const H=(V=(X=q.data)==null?void 0:X.config)==null?void 0:V.generatedImageUrl;!y&&H&&(y=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,p=b.id)}else if(ue==="imagePreview"){const H=((ie=q.data)==null?void 0:ie.imageUrl)||((xe=q.data)==null?void 0:xe.url);!y&&H&&(y=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,p=b.id)}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const H=((oe=q.data)==null?void 0:oe.videoUrl)||((k=q.data)==null?void 0:k.url)||((E=(u=q.data)==null?void 0:u.config)==null?void 0:E.generatedVideoUrl);!x&&H&&(x=H.startsWith("http")||H.startsWith("data:")?H:`${lr}${H}`,w=b.id)}if(y&&x)break}return{imageUrl:y,videoUrl:x,imageSize:d,imageEdgeId:p,videoEdgeId:w}},[pe,n,ae]);t.useEffect(()=>{if(G.imageSize>5*1024*1024){const y=(G.imageSize/1024/1024).toFixed(2);f.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${y}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),G.imageEdgeId&&te(d=>d.filter(x=>x.id!==G.imageEdgeId))}if(!G.videoUrl){ce(0);return}const a=document.createElement("video");a.src=G.videoUrl,a.onloadedmetadata=()=>{const y=a.duration||0,d=a.videoWidth,x=a.videoHeight;ce(y);let p="";y<2||y>30?p=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${y.toFixed(1)}ç§’ï¼‰`:(d>2048||x>2048)&&(p=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${d}x${x}ï¼‰`),p&&(f.error(p+"ï¼Œè¿æ¥å·²æ–­å¼€"),G.videoEdgeId&&te(w=>w.filter(R=>R.id!==G.videoEdgeId)))},a.onerror=()=>ce(0),a.load()},[G.videoUrl,G.imageSize,G.videoEdgeId,G.imageEdgeId,te]);const m=t.useMemo(()=>!!z&&!!G.videoUrl&&!!G.imageUrl,[z,G.videoUrl,G.imageUrl]),c=t.useCallback(a=>{var k,u,E;const y=ae(n);if(!y||!a)return;const d=je(),x=ne(),p=d.filter(b=>b.type==="videoPreview"&&x.some(q=>q.source===n&&q.target===b.id));if(p.find(b=>{var q;return((q=b.data)==null?void 0:q.videoUrl)===a}))return;const R=400,W=(b,q=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(b))return q;const[ue,H]=b.split(":").map(ge=>parseFloat(ge));return!ue||!H?q:Math.round(R*(H/ue))},_=200,h=100,l=W("16:9",300),i=document.querySelector(`.react-flow__node[data-id="${n}"]`),B=Math.round((i==null?void 0:i.getBoundingClientRect().width)||400),M=(((k=y.position)==null?void 0:k.x)||0)+B+_,X=((u=y.position)==null?void 0:u.y)||0,V=p.length,ie=M,xe=X+V*(l+h),oe={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:ie,y:xe},data:{videoUrl:a,width:R,ratio:"16:9",workflowContext:y.data.workflowContext,createdBy:(E=y.data)==null?void 0:E.createdBy}};he(b=>[...b,oe]),te(b=>[...b,{id:`edge-${n}-${oe.id}`,source:n,target:oe.id,type:"aurora"}])},[n,ae,je,ne,he,te]);t.useEffect(()=>{var y;const a=(y=s==null?void 0:s.config)==null?void 0:y.generatedVideoUrl;a&&c(a)},[(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl]),t.useEffect(()=>{const a=s.config.taskId;(async()=>{var x,p;let d=!1;if(a)try{const R=(await Ce.tasks.getTaskStatus(a)).task;if(R.status==="SUCCESS"){const W=R.resultUrl||((x=R.previewNodeData)==null?void 0:x.url);if(W){let _=!1;try{const h=localStorage.getItem("suppressedPreviewTasks")||"[]";_=JSON.parse(h).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}_||c(W),he(h=>h.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:W,taskId:a}}}:l))}U(!1),d=!0}else if(R.status==="PROCESSING"||R.status==="PENDING"){U(!0),await S(a);return}else R.status==="FAILURE"&&(U(!1),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_)))}catch{U(!1)}if(!d)try{const w=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(w.tasks)&&w.tasks.length>0)for(const R of w.tasks){const W=(p=R.previewNodeData)==null?void 0:p.url;if(W){let _=!1;try{const h=localStorage.getItem("suppressedPreviewTasks")||"[]";_=JSON.parse(h).some(i=>i.taskId&&i.taskId===R.id||i.sourceNodeId&&i.sourceNodeId===n)}catch{}_||c(W),await Ce.tasks.markPreviewNodeCreated(R.id)}}}catch{}})()},[]);const S=async a=>{let y=0;const d=600,x=async()=>{var p;try{y++;const R=(await Ce.tasks.getTaskStatus(a)).task;if(R.status==="SUCCESS"){const W=R.resultUrl||((p=R.previewNodeData)==null?void 0:p.url);if(W){let _=!1;try{const h=localStorage.getItem("suppressedPreviewTasks")||"[]";_=JSON.parse(h).some(i=>i.taskId&&i.taskId===a||i.sourceNodeId&&i.sourceNodeId===n)}catch{}_||c(W),he(h=>h.map(l=>l.id!==n?l:{...l,data:{...l.data,config:{...l.data.config,generatedVideoUrl:W,taskId:a}}}))}U(!1),f.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(R.status==="PROCESSING"||R.status==="PENDING")if(y<d)setTimeout(x,5e3);else{U(!1),f.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_));return}else if(R.status==="FAILURE"){U(!1);try{const{useAuthStore:W}=await xs(async()=>{const{useAuthStore:h}=await import("./index-DRJ_08Rm.js").then(l=>l.f);return{useAuthStore:h}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_}=W.getState();await _()}catch{}f.error(R.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_));return}else{U(!1),f.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),he(W=>W.map(_=>_.id===n?{..._,data:{..._.data,config:{..._.data.config,taskId:""}}}:_));return}}catch{U(!1),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),he(R=>R.map(W=>W.id===n?{...W,data:{...W.data,config:{...W.data.config,taskId:""}}}:W));return}};x()},P=async()=>{var a,y;if(!m){f.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}U(!0);try{const d=await Ce.post("/tasks/video-edit",{modelId:z,prompt:fe||"",referenceImages:G.imageUrl?[G.imageUrl]:[],sourceNodeId:n,duration:K,metadata:{videoUrl:G.videoUrl,wanMode:Q,duration:K}}),x=d.taskId,p=d.creditsCharged||0;if(p>0)try{const{useAuthStore:w}=await xs(async()=>{const{useAuthStore:W}=await import("./index-DRJ_08Rm.js").then(_=>_.f);return{useAuthStore:W}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:R}=w.getState();await R(),f.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${p} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{f.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else f.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");he(w=>w.map(R=>R.id===n?{...R,data:{...R.data,config:{...R.data.config,taskId:x}}}:R)),await S(x)}catch(d){U(!1);const x=((y=(a=d==null?void 0:d.response)==null?void 0:a.data)==null?void 0:y.error)||d.message||"æœªçŸ¥åŸå› ";f.error(`å¯åŠ¨å¤±è´¥ï¼š${x}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:z,onChange:a=>{A(a),he(y=>y.map(d=>{var x;return d.id===n?{...d,data:{...d.data,config:{...d.data.config,modelId:a,modelName:(x=Z.find(p=>p.id===a))==null?void 0:x.name}}}:d}))},options:Z.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Z.map(a=>({value:a.id,label:a.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>re("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Q==="wan-std"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>re("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${Q==="wan-pro"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((v=s==null?void 0:s.config)==null?void 0:v.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),G.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Ue,src:G.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:a=>{const y=a.currentTarget;y.duration&&y.duration!==1/0&&ce(y.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((g=s==null?void 0:s.config)==null?void 0:g.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),G.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:G.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:P,disabled:ye||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ye?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ye?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!Ee&&(me!==null&&me>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[me,"ç§¯åˆ†"]}):K===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},io=t.memo(no),br="https://api.waule.com",lo=({data:s,selected:j,id:n})=>{var W,_;const[F]=t.useState(!0),[ye,U]=t.useState(!1),[fe,Q]=t.useState(!1),re=t.useRef(null),K=t.useRef(null),ce=t.useRef(null),[Ue,he]=t.useState(!1),[te,ae]=t.useState(0),[je,ne]=t.useState(0),[pe,de]=t.useState(0),[me,Ee]=t.useState(null),{setNodes:Z,setEdges:z,getNode:A,getNodes:I,getEdges:G}=Zt(),m=zs(),c=Ds(),S=t.useMemo(()=>`lipSyncTask:${n}`,[n]),P=t.useMemo(()=>(s.models||[]).filter(l=>{var i;return(l.type||"")==="VIDEO_EDITING"&&Array.isArray((i=l.config)==null?void 0:i.supportedEditingCapabilities)&&l.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[$,N]=t.useState(s.config.modelId||((W=P[0])==null?void 0:W.id)||"");t.useEffect(()=>{var h;if(!P.find(l=>l.id===$)){const l=((h=P[0])==null?void 0:h.id)||"";N(l),Z(i=>i.map(B=>{var M;return B.id===n?{...B,data:{...B.data,config:{...B.data.config,modelId:l||void 0,modelName:l?(M=P[0])==null?void 0:M.name:void 0}}}:B}))}},[P]);const O=t.useMemo(()=>!je||!te?0:je>=te||fe?te:je,[je,te,fe]),{credits:r,loading:v}=Us({aiModelId:$,duration:O,mode:"standard",operationType:"video_retalk"}),g=t.useMemo(()=>{var M,X,V,ie,xe,oe,k,u,E;const h=m.filter(b=>b.target===n);let l=null,i=null,B=null;for(const b of h){const q=c.find(H=>H.id===b.source);if(!q)continue;const ue=String(q.type||"");if(ue==="upload"){const H=(V=(X=(M=q.data)==null?void 0:M.config)==null?void 0:X.uploadedFiles)==null?void 0:V[0];if(!H)continue;const ge=String(H.mimeType||"").toLowerCase(),Ie=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${br}${H.url}`;!l&&(Ie==="VIDEO"||ge.startsWith("video/"))&&(l=Ne),!i&&(Ie==="AUDIO"||ge.startsWith("audio/"))&&(i=Ne),!B&&(Ie==="IMAGE"||ge.startsWith("image/"))&&(B=Ne)}else if(ue==="assetSelector"){const H=(xe=(ie=q.data)==null?void 0:ie.config)==null?void 0:xe.selectedAsset;if(H){const ge=String(H.mimeType||"").toLowerCase(),Ie=String(H.type||"").toUpperCase(),Ne=H.url.startsWith("http")||H.url.startsWith("data:")?H.url:`${br}${H.url}`;!l&&(Ie==="VIDEO"||ge.startsWith("video/"))&&(l=Ne),!i&&(Ie==="AUDIO"||ge.startsWith("audio/"))&&(i=Ne),!B&&(Ie==="IMAGE"||ge.startsWith("image/"))&&(B=Ne)}}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const H=((oe=q.data)==null?void 0:oe.videoUrl)||((k=q.data)==null?void 0:k.url)||((E=(u=q.data)==null?void 0:u.config)==null?void 0:E.generatedVideoUrl);!l&&H&&(l=H.startsWith("http")||H.startsWith("data:")?H:`${br}${H}`)}if(l&&i&&B)break}return{videoUrl:l,audioUrl:i,imageUrl:B}},[m,n,c]),a=t.useMemo(()=>{var l;const h=P.find(i=>i.id===$);return((l=h==null?void 0:h.modelId)==null?void 0:l.toLowerCase().includes("videoretalk"))||!1},[$,P]),y=t.useMemo(()=>!!$&&!!g.videoUrl&&!!g.audioUrl&&!me,[$,g.videoUrl,g.audioUrl,me]);t.useEffect(()=>{const h=re.current;if(!h||!g.audioUrl)return;h.src=g.audioUrl,h.load();const l=()=>{ae(h.duration||0)},i=()=>de(h.duration?h.currentTime/h.duration:0),B=()=>he(!1);return h.addEventListener("loadedmetadata",l),h.addEventListener("timeupdate",i),h.addEventListener("ended",B),()=>{h.removeEventListener("loadedmetadata",l),h.removeEventListener("timeupdate",i),h.removeEventListener("ended",B)}},[g.audioUrl]),t.useEffect(()=>{if(!g.videoUrl){ne(0);return}const h=document.createElement("video");h.src=g.videoUrl,h.onloadedmetadata=()=>{if(ne(h.duration||0),a){const l=h.videoWidth,i=h.videoHeight;l>2048||i>2048?(Ee(`è§†é¢‘åˆ†è¾¨ç‡ ${l}x${i} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),f.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${l}x${i}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),z(B=>B.filter(M=>{var ie,xe,oe,k,u,E,b,q;if(M.target!==n)return!0;const X=c.find(ue=>ue.id===M.source);return X?!(X.type==="upload"&&((k=(oe=(xe=(ie=X.data)==null?void 0:ie.config)==null?void 0:xe.uploadedFiles)==null?void 0:oe[0])==null?void 0:k.type)==="VIDEO"||X.type==="assetSelector"&&((b=(E=(u=X.data)==null?void 0:u.config)==null?void 0:E.selectedAsset)==null?void 0:b.type)==="VIDEO"||X.type==="videoPreview"||((q=X.type)==null?void 0:q.startsWith("aiVideo"))):!0}))):me!=null&&me.includes("è§†é¢‘åˆ†è¾¨ç‡")&&Ee(null)}},h.onerror=()=>ne(0),h.load()},[g.videoUrl,a,n,c,z]),t.useEffect(()=>{const h=g.audioUrl,l=ce.current;if(!h||!l)return;const i=M=>{const X=l.getContext("2d");if(!X)return;const V=l.width,ie=l.height;X.clearRect(0,0,V,ie);const xe="#1a1033",oe="#7a0fe8";X.fillStyle=xe,X.fillRect(0,0,V,ie);const k=M.length,u=2,E=Math.max(1,Math.floor((V-(k-1)*u)/k));for(let b=0;b<k;b++){const q=Math.min(1,Math.max(0,M[b])),ue=Math.max(2,Math.floor(q*ie)),H=b*(E+u),ge=Math.floor((ie-ue)/2);X.fillStyle=oe,X.fillRect(H,ge,E,ue)}if(pe>0){const b=Math.floor(V*pe);X.fillStyle="#ffffff88",X.fillRect(b,0,2,ie)}};(async()=>{try{let M=h;h.includes("aliyuncs.com")&&(M=`https://api.waule.com/proxy/audio?url=${encodeURIComponent(h)}`);const V=await(await fetch(M,{mode:(h.includes("aliyuncs.com"),"cors"),credentials:h.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ie=window.AudioContext||window.webkitAudioContext,k=(await new ie().decodeAudioData(V)).getChannelData(0),u=120,E=Math.max(1,Math.floor(k.length/u)),b=new Float32Array(u);for(let q=0;q<u;q++){let ue=0,H=0;const ge=q*E,Ie=Math.min(k.length,ge+E);for(let Ne=ge;Ne<Ie;Ne++)ue+=Math.abs(k[Ne]),H++;b[q]=H?ue/H:0}i(b)}catch{const X=new Float32Array(120);for(let V=0;V<120;V++)X[V]=(Math.sin(V/5)+1)/2;i(X)}})()},[g.audioUrl,pe]);const d=()=>{const h=re.current;h&&(Ue?(h.pause(),he(!1)):(h.play(),he(!0)))},x=h=>{if(!h||!isFinite(h))return"0:00";const l=Math.floor(h/60),i=Math.floor(h%60);return`${l}:${i.toString().padStart(2,"0")}`},p=t.useCallback(h=>{var Re,Ae,_e;const l=A(n);if(!l||!h)return;const i=h.startsWith("http")||h.startsWith("data:")?h:`${br}${h}`,B=I(),M=G(),X=B.filter($e=>$e.type==="videoPreview"&&M.some(le=>le.source===n&&le.target===$e.id));if(X.find($e=>{var le;return((le=$e.data)==null?void 0:le.videoUrl)===i}))return;const ie=400,xe=($e,le=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test($e))return le;const[Ge,Qe]=$e.split(":").map(Wt=>parseFloat(Wt));return!Ge||!Qe?le:Math.round(ie*(Qe/Ge))},oe=200,k=100,u=xe("16:9",300),E=document.querySelector(`.react-flow__node[data-id="${n}"]`),b=Math.round((E==null?void 0:E.getBoundingClientRect().width)||400),q=(((Re=l.position)==null?void 0:Re.x)||0)+b+oe,ue=((Ae=l.position)==null?void 0:Ae.y)||0,H=X.length,ge=q,Ie=ue+H*(u+k),Ne={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:ge,y:Ie},data:{videoUrl:i,ratio:"16:9",workflowContext:l.data.workflowContext,createdBy:(_e=l.data)==null?void 0:_e.createdBy}};Z($e=>[...$e,Ne]),z($e=>[...$e,{id:`edge-${n}-${Ne.id}`,source:n,target:Ne.id,type:"aurora"}])},[n,A,I,G,Z,z]);t.useEffect(()=>{var l;const h=(l=s==null?void 0:s.config)==null?void 0:l.generatedVideoUrl;h&&p(h)},[(_=s==null?void 0:s.config)==null?void 0:_.generatedVideoUrl]),t.useEffect(()=>{const h=s.config.taskId||(()=>{try{return localStorage.getItem(S)||""}catch{return""}})();(async()=>{var B,M;let i=!1;if(h)try{const V=(await Ce.tasks.getTaskStatus(h)).task;if(V.status==="PROCESSING"||V.status==="PENDING"){const ie=new Date(V.createdAt);if((new Date().getTime()-ie.getTime())/(1e3*60*60)>1){U(!1),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(S)}catch{}return}}if(V.status==="SUCCESS"||V.status==="COMPLETED"||V.status==="DONE"){const ie=V.resultUrl||((B=V.previewNodeData)==null?void 0:B.url);if(ie){let xe=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";xe=JSON.parse(oe).some(u=>u.taskId&&u.taskId===h||u.sourceNodeId&&u.sourceNodeId===n)}catch{}xe||p(ie),Z(oe=>oe.map(k=>k.id===n?{...k,data:{...k.data,config:{...k.data.config,generatedVideoUrl:ie,taskId:h}}}:k))}U(!1);try{localStorage.removeItem(S)}catch{}i=!0}else if(V.status==="PROCESSING"||V.status==="PENDING"){U(!0),await w(h);return}else if(V.status==="FAILURE"||V.status==="FAILED"){U(!1),Z(ie=>ie.map(xe=>xe.id===n?{...xe,data:{...xe.data,config:{...xe.data.config,taskId:""}}}:xe));try{localStorage.removeItem(S)}catch{}}}catch{U(!1);try{localStorage.removeItem(S)}catch{}}if(!i)try{const X=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(X.tasks)&&X.tasks.length>0)for(const V of X.tasks){const ie=(M=V.previewNodeData)==null?void 0:M.url;if(ie){let xe=!1;try{const oe=localStorage.getItem("suppressedPreviewTasks")||"[]";xe=JSON.parse(oe).some(u=>u.taskId&&u.taskId===V.id||u.sourceNodeId&&u.sourceNodeId===n)}catch{}xe||p(ie),await Ce.tasks.markPreviewNodeCreated(V.id)}}}catch{}})()},[S,n,p]);const w=async h=>{let l=0;const i=600;let B=-1,M=0;const X=60,V=async()=>{var ie;try{l++;const oe=(await Ce.tasks.getTaskStatus(h)).task;if(oe.status==="PROCESSING"||oe.status==="PENDING"){const k=oe.progress||0;if(k===B){if(M++,M>=X){U(!1),f.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),Z(u=>u.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,taskId:""}}}:E));try{localStorage.removeItem(S)}catch{}return}}else B=k,M=0}if(oe.status==="SUCCESS"||oe.status==="COMPLETED"||oe.status==="DONE"){const k=oe.resultUrl||((ie=oe.previewNodeData)==null?void 0:ie.url);k&&(p(k),Z(u=>u.map(E=>E.id===n?{...E,data:{...E.data,config:{...E.data.config,generatedVideoUrl:k,taskId:h}}}:E))),U(!1),f.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(S)}catch{}return}else if(oe.status==="PROCESSING"||oe.status==="PENDING")if(l<i)setTimeout(V,5e3);else{U(!1),f.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(S)}catch{}return}else if(oe.status==="FAILURE"||oe.status==="FAILED"){U(!1);try{const{useAuthStore:k}=await xs(async()=>{const{useAuthStore:E}=await import("./index-DRJ_08Rm.js").then(b=>b.f);return{useAuthStore:E}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:u}=k.getState();await u()}catch{}f.error(oe.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(S)}catch{}return}else{U(!1),f.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),Z(k=>k.map(u=>u.id===n?{...u,data:{...u.data,config:{...u.data.config,taskId:""}}}:u));try{localStorage.removeItem(S)}catch{}return}}catch{U(!1),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),Z(oe=>oe.map(k=>k.id===n?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));try{localStorage.removeItem(S)}catch{}return}};V()},R=async()=>{var h,l;if(!y){f.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}U(!0);try{const i=await Ce.post("/tasks/video-edit",{modelId:$,prompt:"",referenceImages:g.imageUrl?[g.imageUrl]:[],sourceNodeId:n,generationType:"å¯¹å£å‹",duration:O,metadata:{videoUrl:g.videoUrl,audioUrl:g.audioUrl,videoExtension:fe,duration:O}}),B=i.taskId,M=i.creditsCharged||0;if(M>0)try{const{useAuthStore:X}=await xs(async()=>{const{useAuthStore:ie}=await import("./index-DRJ_08Rm.js").then(xe=>xe.f);return{useAuthStore:ie}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:V}=X.getState();await V(),f.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${M} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{f.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else f.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");Z(X=>X.map(V=>V.id===n?{...V,data:{...V.data,config:{...V.data.config,taskId:B}}}:V));try{localStorage.setItem(S,B)}catch{}await w(B)}catch(i){U(!1);const B=((l=(h=i==null?void 0:i.response)==null?void 0:h.data)==null?void 0:l.error)||i.message||"æœªçŸ¥åŸå› ";f.error(`å¯åŠ¨å¤±è´¥ï¼š${B}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(S)}catch{}}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(os,{value:$,onChange:h=>{N(h),Z(l=>l.map(i=>{var B;return i.id===n?{...i,data:{...i.data,config:{...i.data.config,modelId:h,modelName:(B=P.find(M=>M.id===h))==null?void 0:B.name}}}:i}))},options:P.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:P.map(h=>({value:h.id,label:h.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:g.videoUrl?e.jsx("video",{src:g.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},g.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:g.imageUrl?e.jsx("img",{src:g.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},g.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),g.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:d,className:"nodrag w-7 h-7 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Ue?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:x(te)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:ce,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:re,src:g.audioUrl,className:"hidden"}),e.jsx("video",{ref:K,className:"hidden",muted:!0,onLoadedMetadata:h=>{const l=h.currentTarget;l.duration&&l.duration!==1/0&&ne(l.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:fe,onChange:h=>Q(h.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:R,disabled:ye||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ye?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ye?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!v&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[r,"ç§¯åˆ†"]}):O===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},co=t.memo(lo),vr="https://api.waule.com",uo=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],go=({data:s,selected:j,id:n})=>{var P,$;const[F]=t.useState(!0),[ye,U]=t.useState(!1),[fe,Q]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[re,K]=t.useState(s.config.videoFps||15),[ce,Ue]=t.useState(0),he=t.useRef(null),{setNodes:te,setEdges:ae,getNode:je,getNodes:ne,getEdges:pe}=Zt(),de=zs(),me=t.useMemo(()=>(s.models||[]).filter(O=>{var r;return(O.type||"")==="VIDEO_EDITING"&&Array.isArray((r=O.config)==null?void 0:r.supportedEditingCapabilities)&&O.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[Ee,Z]=t.useState(s.config.modelId||((P=me[0])==null?void 0:P.id)||""),{credits:z,loading:A}=Us({aiModelId:Ee,duration:ce});t.useMemo(()=>me.find(N=>N.id===Ee),[me,Ee]),t.useEffect(()=>{var N;if(!me.find(O=>O.id===Ee)){const O=((N=me[0])==null?void 0:N.id)||"";Z(O),te(r=>r.map(v=>{var g;return v.id===n?{...v,data:{...v.data,config:{...v.data.config,modelId:O||void 0,modelName:O?(g=me[0])==null?void 0:g.name:void 0}}}:v}))}},[me]);const I=t.useMemo(()=>{var r,v,g,a,y,d,x,p,w;const N=de.filter(R=>R.target===n);let O=null;for(const R of N){const W=je(R.source);if(!W)continue;const _=String(W.type||"");if(_==="upload"){const h=(g=(v=(r=W.data)==null?void 0:r.config)==null?void 0:v.uploadedFiles)==null?void 0:g[0];if(!h)continue;const l=String(h.mimeType||"").toLowerCase(),i=String(h.type||"").toUpperCase(),B=h.url.startsWith("http")||h.url.startsWith("data:")?h.url:`${vr}${h.url}`;!O&&(i==="VIDEO"||l.startsWith("video/"))&&(O=B)}else if(_==="assetSelector"){const h=(y=(a=W.data)==null?void 0:a.config)==null?void 0:y.selectedAsset;if(h){const l=String(h.mimeType||"").toLowerCase(),i=String(h.type||"").toUpperCase(),B=h.url.startsWith("http")||h.url.startsWith("data:")?h.url:`${vr}${h.url}`;!O&&(i==="VIDEO"||l.startsWith("video/"))&&(O=B)}}else if(_==="videoPreview"||_.startsWith("aiVideo")){const h=((d=W.data)==null?void 0:d.videoUrl)||((x=W.data)==null?void 0:x.url)||((w=(p=W.data)==null?void 0:p.config)==null?void 0:w.generatedVideoUrl);!O&&h&&(O=h.startsWith("http")||h.startsWith("data:")?h:`${vr}${h}`)}if(O)break}return{videoUrl:O}},[de,n,je]);t.useEffect(()=>{if(!I.videoUrl){Ue(0);return}const N=document.createElement("video");N.preload="metadata",N.onloadedmetadata=()=>{N.duration&&N.duration!==1/0&&Ue(N.duration)},N.onerror=()=>Ue(0),N.src=I.videoUrl},[I.videoUrl]);const G=t.useMemo(()=>!!Ee&&!!I.videoUrl,[Ee,I.videoUrl]),m=t.useCallback(N=>{var X,V,ie;const O=je(n);if(!O||!N)return;const r=ne(),v=pe(),g=r.filter(xe=>xe.type==="videoPreview"&&v.some(oe=>oe.source===n&&oe.target===xe.id));if(g.find(xe=>{var oe;return((oe=xe.data)==null?void 0:oe.videoUrl)===N}))return;const y=400,d=(xe,oe=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(xe))return oe;const[k,u]=xe.split(":").map(E=>parseFloat(E));return!k||!u?oe:Math.round(y*(u/k))},x=200,p=100,w=d("16:9",300),R=document.querySelector(`.react-flow__node[data-id="${n}"]`),W=Math.round((R==null?void 0:R.getBoundingClientRect().width)||400),_=(((X=O.position)==null?void 0:X.x)||0)+W+x,h=((V=O.position)==null?void 0:V.y)||0,l=g.length,i=_,B=h+l*(w+p),M={id:`preview-${n}-${Date.now()}`,type:"videoPreview",position:{x:i,y:B},data:{videoUrl:N,width:y,ratio:"16:9",workflowContext:O.data.workflowContext,createdBy:(ie=O.data)==null?void 0:ie.createdBy}};te(xe=>[...xe,M]),ae(xe=>[...xe,{id:`edge-${n}-${M.id}`,source:n,target:M.id,type:"aurora"}])},[n,je,ne,pe,te,ae]);t.useEffect(()=>{var O;const N=(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl;N&&m(N)},[($=s==null?void 0:s.config)==null?void 0:$.generatedVideoUrl]),t.useEffect(()=>{const N=s.config.taskId;(async()=>{var v,g;let r=!1;if(N)try{const y=(await Ce.tasks.getTaskStatus(N)).task;if(y.status==="SUCCESS"){const d=y.resultUrl||((v=y.previewNodeData)==null?void 0:v.url);if(d){let x=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";x=JSON.parse(p).some(R=>R.taskId&&R.taskId===N||R.sourceNodeId&&R.sourceNodeId===n)}catch{}x||m(d),te(p=>p.map(w=>w.id===n?{...w,data:{...w.data,config:{...w.data.config,generatedVideoUrl:d,taskId:N}}}:w))}U(!1),r=!0}else if(y.status==="PROCESSING"||y.status==="PENDING"){U(!0),await c(N);return}else y.status==="FAILURE"&&(U(!1),te(d=>d.map(x=>x.id===n?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x)))}catch{U(!1)}if(!r)try{const a=await Ce.tasks.getPendingPreviewNodes(n);if(Array.isArray(a.tasks)&&a.tasks.length>0)for(const y of a.tasks){const d=(g=y.previewNodeData)==null?void 0:g.url;if(d){let x=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";x=JSON.parse(p).some(R=>R.taskId&&R.taskId===y.id||R.sourceNodeId&&R.sourceNodeId===n)}catch{}x||m(d),await Ce.tasks.markPreviewNodeCreated(y.id)}}}catch{}})()},[]);const c=async N=>{let O=0;const r=600,v=async()=>{var g;try{O++;const y=(await Ce.tasks.getTaskStatus(N)).task;if(y.status==="SUCCESS"){const d=y.resultUrl||((g=y.previewNodeData)==null?void 0:g.url);d&&(m(d),te(x=>x.map(p=>p.id!==n?p:{...p,data:{...p.data,config:{...p.data.config,generatedVideoUrl:d,taskId:N}}}))),U(!1),f.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else y.status==="PROCESSING"||y.status==="PENDING"?O<r?setTimeout(v,5e3):(U(!1),f.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),te(d=>d.map(x=>x.id===n?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x))):y.status==="FAILURE"&&(U(!1),f.error(y.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),te(d=>d.map(x=>x.id===n?{...x,data:{...x.data,config:{...x.data.config,taskId:""}}}:x)))}catch{U(!1),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),te(y=>y.map(d=>d.id===n?{...d,data:{...d.data,config:{...d.data.config,taskId:""}}}:d))}};v()},S=async()=>{var N,O;if(!G){f.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}U(!0);try{const r=await Ce.post("/tasks/video-edit",{modelId:Ee,prompt:"",referenceImages:[],sourceNodeId:n,generationType:"é£æ ¼è½¬æ¢",duration:ce,metadata:{videoUrl:I.videoUrl,styleId:fe,videoFps:re,duration:ce}}),v=r.taskId,g=r.creditsCharged||0;if(g>0)try{const{useAuthStore:a}=await xs(async()=>{const{useAuthStore:d}=await import("./index-DRJ_08Rm.js").then(x=>x.f);return{useAuthStore:d}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:y}=a.getState();await y(),f.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${g} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{f.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else f.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");te(a=>a.map(y=>y.id===n?{...y,data:{...y.data,config:{...y.data.config,taskId:v,styleId:fe,videoFps:re}}}:y)),await c(v)}catch(r){U(!1);const v=((O=(N=r==null?void 0:r.response)==null?void 0:N.data)==null?void 0:O.error)||r.message||"æœªçŸ¥åŸå› ";f.error(`å¯åŠ¨å¤±è´¥ï¼š${v}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(os,{value:Ee,onChange:N=>{Z(N),te(O=>O.map(r=>{var v;return r.id===n?{...r,data:{...r.data,config:{...r.data.config,modelId:N,modelName:(v=me.find(g=>g.id===N))==null?void 0:v.name}}}:r}))},options:me.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:me.map(N=>({value:N.id,label:N.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(os,{value:String(fe),onChange:N=>{const O=parseInt(N,10);Q(O),te(r=>r.map(v=>v.id===n?{...v,data:{...v.data,config:{...v.data.config,styleId:O}}}:v))},options:uo.map(N=>({value:String(N.id),label:N.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:re,min:15,max:25,onChange:N=>{let O=parseInt(N.target.value,10)||15;O<15&&(O=15),O>25&&(O=25),K(O),te(r=>r.map(v=>v.id===n?{...v,data:{...v.data,config:{...v.data.config,videoFps:O}}}:v))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),I.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:he,src:I.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:N=>{const O=N.currentTarget;O.duration&&O.duration!==1/0&&Ue(O.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:S,disabled:ye||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ye?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ye?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!A&&(z!==null&&z>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[z,"ç§¯åˆ†"]}):ce===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ho=t.memo(go),po=({data:s,selected:j,id:n})=>{const[F,ye]=t.useState(null),[U,fe]=t.useState(!1),[Q,re]=t.useState(s.config.prompt||""),[K,ce]=t.useState(""),Ue=t.useRef(null),he=t.useRef(!1),[te,ae]=t.useState(!1),{setNodes:je,setEdges:ne,getNode:pe,getNodes:de,getEdges:me}=Zt(),Ee=Fs(a=>a.edges.filter(y=>y.target===n)),Z=Ds(),[z,A]=t.useState([]),[I,G]=t.useState([]),m=t.useRef(""),c=t.useMemo(()=>((F==null?void 0:F.roles)||[]).find(a=>a.id===K),[F,K]),{credits:S,loading:P,isFreeUsage:$,freeUsageRemaining:N}=Us({aiModelId:c==null?void 0:c.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&O(s.config.agentId)},[s.config.agentId]);const O=async a=>{var y,d,x,p,w;try{fe(!0);const R=await Ce.agents.getById(a);let W=[];try{W=await Ce.agents.roles.listByAgent(a)||[],ye({...R,roles:W});const h=((y=s==null?void 0:s.config)==null?void 0:y.roleId)||"";ce(h||((d=W[0])==null?void 0:d.id)||"")}catch{ye(R)}try{const _=await Ce.agents.getAvailableModels(),h=(W||[]).find(l=>{var i;return l.id===((i=s==null?void 0:s.config)==null?void 0:i.roleId)});if(h){const l=(_||[]).find(B=>B.id===h.aiModelId),i=((x=l==null?void 0:l.config)==null?void 0:x.acceptedInputs)||((l==null?void 0:l.type)==="TEXT_GENERATION"&&((w=(p=l==null?void 0:l.provider)==null?void 0:p.toLowerCase())!=null&&w.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:i})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{f.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{fe(!1)}};t.useEffect(()=>{r({roleId:K}),(async()=>{var a,y,d;if(F)try{const x=await Ce.agents.getAvailableModels(),p=(F.roles||[]).find(w=>w.id===K);if(p){const w=(x||[]).find(W=>W.id===p.aiModelId),R=((a=w==null?void 0:w.config)==null?void 0:a.acceptedInputs)||((w==null?void 0:w.type)==="TEXT_GENERATION"&&((d=(y=w==null?void 0:w.provider)==null?void 0:y.toLowerCase())!=null&&d.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:R})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[K,F]);const r=a=>{pe(n)&&je(d=>d.map(x=>x.id===n?{...x,data:{...x.data,config:{...x.data.config,...a}}}:x))};t.useEffect(()=>{const a=Ue.current;a&&requestAnimationFrame(()=>{a.style.height="auto";const y=Math.max(60,Math.min(a.scrollHeight,600));a.style.height=`${y}px`})},[Q]),t.useEffect(()=>{const a=setTimeout(()=>{Q!==s.config.prompt&&r({prompt:Q})},500);return()=>clearTimeout(a)},[Q,s.config.prompt]),t.useEffect(()=>{const a=Ee;if(!a||a.length===0)return;let y="";a.some(d=>{const x=Z.find(w=>w.id===d.source);if(!x)return!1;const p=x.data||{};return x.type==="textPreview"&&typeof p.content=="string"&&p.content.trim()?(y=p.content.trim(),!0):!1}),y&&!he.current&&(re(y),r({prompt:y}))},[Ee,Z]),t.useEffect(()=>{const a=Ee.map(x=>`${x.id}-${x.source}`).sort().join(",");if(a===m.current)return;m.current=a;const y=[],d=[];Ee.forEach(x=>{var R,W,_;const p=pe(x.source);if(!p)return;const w=p.data||{};if(p.type==="upload")(((R=w.config)==null?void 0:R.uploadedFiles)||[]).forEach(l=>{l.type==="IMAGE"&&y.push(l.url),l.type==="DOCUMENT"&&d.push({name:l.originalName,url:l.url})});else if(p.type==="assetSelector"){const h=(W=w.config)==null?void 0:W.subjects;if(h&&h.length>0)(h[0].images||[]).map(i=>{const B="https://api.waule.com";return i.startsWith("data:")?i:i.startsWith("http")?i.replace(/^https?:\/\/localhost(?::\d+)?/i,B):`${B}${i}`}).forEach(i=>y.push(i));else{const l=(_=w.config)==null?void 0:_.selectedAsset;if(l){const i="https://api.waule.com",B=M=>M.startsWith("http")?M.replace(/^https?:\/\/localhost(?::\d+)?/i,i):`${i}${M}`;l.type==="IMAGE"&&y.push(B(l.url)),l.type==="DOCUMENT"&&d.push({name:l.originalName,url:B(l.url)})}}}else p.type==="imagePreview"&&w.imageUrl&&y.push(w.imageUrl)}),A(y),G(d)},[Ee,pe,Z]);const v=()=>{if(!F)return null;const a=(F.roles||[]).find(y=>y.id===K);return a?{systemPrompt:a.systemPrompt,aiModelId:a.aiModelId,temperature:a.temperature,maxTokens:a.maxTokens}:null},g=async()=>{var y,d,x,p,w,R,W,_,h,l,i,B,M,X;if(!F){f.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!Q.trim()){f.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let a=(F.roles||[]).find(V=>V.id===K)||(F.roles||[])[0];if(!a){f.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!K||K!==a.id)&&(ce(a.id),r({roleId:a.id}));try{ae(!0);const ie=me().filter(Ae=>Ae.target===n);let xe="";const oe="https://api.waule.com",k=[],u=[],E=[];for(const Ae of ie){const _e=pe(Ae.source);if(_e)if(_e.type==="upload"){const $e=((d=(y=_e.data)==null?void 0:y.config)==null?void 0:d.uploadedFiles)||[];for(const le of $e)if(le.type==="DOCUMENT")k.push({filePath:le.url,mimeType:le.mimeType}),xe+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){const Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;u.push(Ge),xe+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){const Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;E.push(Ge),xe+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}else le.type==="AUDIO"&&(xe+=`[éŸ³é¢‘æ–‡ä»¶: ${le.originalName}]
`)}else if(_e.type==="assetSelector"){const $e=(p=(x=_e.data)==null?void 0:x.config)==null?void 0:p.subjects;if($e&&$e.length>0){const le=($e[0].images||[]).map(Ge=>Ge.startsWith("http")?Ge:`${oe}${Ge}`).map(Ge=>Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe));le.forEach(Ge=>u.push(Ge)),xe+=`[å‚è€ƒå›¾ç‰‡ç»„: ${le.length} å¼ ]
`}else{const le=(R=(w=_e.data)==null?void 0:w.config)==null?void 0:R.selectedAsset;if(le){if(le.type==="DOCUMENT")k.push({filePath:le.url,mimeType:le.mimeType}),xe+=`[æ–‡æ¡£æ–‡ä»¶: ${le.originalName}]
`;else if(le.type==="IMAGE"){let Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ge=Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),u.push(Ge),xe+=`[å›¾ç‰‡æ–‡ä»¶: ${le.originalName}]
`}else if(le.type==="VIDEO"){let Ge=le.url.startsWith("http")?le.url:`${oe}${le.url}`;Ge=Ge.replace(/^https?:\/\/localhost(?::\d+)?/i,oe),E.push(Ge),xe+=`[è§†é¢‘æ–‡ä»¶: ${le.originalName}]
`}}}}else if(_e.type==="aiImage"){const $e=(_=(W=_e.data)==null?void 0:W.config)==null?void 0:_.generatedImageUrl;if($e){const le=$e.startsWith("http")?$e:`${oe}${$e}`;u.push(le),xe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(_e.type==="imagePreview"){const $e=_e.data.imageUrl;$e&&(u.push($e),xe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(_e.type==="videoPreview"){const $e=_e.data.videoUrl;if($e){const le=$e.startsWith("http")?$e:`${oe}${$e}`;E.push(le),xe+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else _e.type==="textPreview"&&_e.data.content&&(xe+=_e.data.content+`

`)}const b=v();if(!b)return;let q=b.systemPrompt;xe&&(q+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${xe}`),q+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${Q}`;const ue=await Ce.ai.text.generate({modelId:a.aiModel.id||b.aiModelId,prompt:q,systemPrompt:a.systemPrompt||b.systemPrompt,temperature:a.temperature??b.temperature,maxTokens:a.maxTokens??b.maxTokens,documentFiles:k.length>0?k:void 0,imageUrls:u.length>0?u:void 0,videoUrls:E.length>0?E:void 0}),H=ue&&(((h=ue.data)==null?void 0:h.text)||(ue==null?void 0:ue.text))||"";if(!H||H.trim()===""){f.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:H});const ge=me().filter(Ae=>Ae.source===n),Ie=de(),Ne=ge.filter(Ae=>{const _e=Ie.find($e=>$e.id===Ae.target);return _e&&_e.type!=="textPreview"});if(Ne.length>0)je(Ae=>{const _e=new Set(Ne.map($e=>$e.target));return Ae.map($e=>{var Ge;if(!_e.has($e.id))return $e;const le=((Ge=$e.data)==null?void 0:Ge.config)||{};return $e.type==="midjourney"?{...$e,data:{...$e.data,prompt:H}}:{...$e,data:{...$e.data,config:{...le,prompt:H}}}})});else{const Ae=pe(n);if(Ae){const _e=Date.now(),$e=`text-preview-${n}-${_e}`,le=ge.filter(gt=>{const vt=Ie.find(it=>it.id===gt.target);return vt&&vt.type==="textPreview"}),Ge=document.querySelector(`.react-flow__node[data-id="${n}"]`),Qe=(Ge==null?void 0:Ge.getBoundingClientRect().width)||300,Wt=Ae.position.x+Qe+100,Ct=Ae.position.y+le.length*700,_t={id:$e,type:"textPreview",position:{x:Wt,y:Ct},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:H,createdBy:(l=Ae.data)==null?void 0:l.createdBy}},ct={id:`edge-${n}-${$e}`,source:n,target:$e,type:"aurora"};je(gt=>[...gt,_t]),setTimeout(()=>{ne(gt=>[...gt,ct])},50)}}const Re=(ue==null?void 0:ue.creditsCharged)||0;if(Re>0){const{useAuthStore:Ae}=await xs(async()=>{const{useAuthStore:$e}=await import("./index-DRJ_08Rm.js").then(le=>le.f);return{useAuthStore:$e}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:_e}=Ae.getState();await _e(),f.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${Re} ç§¯åˆ†ï¼‰`)}else f.success("æ‰§è¡ŒæˆåŠŸ")}catch(V){const ie=((B=(i=V==null?void 0:V.response)==null?void 0:i.data)==null?void 0:B.message)||((X=(M=V==null?void 0:V.response)==null?void 0:M.data)==null?void 0:X.error)||(V==null?void 0:V.message)||"æœªçŸ¥é”™è¯¯";f.error("æ‰§è¡Œå¤±è´¥ï¼š"+ie)}finally{ae(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:U?"LOADING...":((F==null?void 0:F.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[F&&(F.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(os,{value:K,onChange:a=>ce(a),options:[...F.roles||[]].sort((a,y)=>(a.order??0)-(y.order??0)).map(a=>({value:a.id,label:a.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Ue,value:Q,onChange:a=>{he.current=!0,re(a.target.value)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:g,disabled:te||U||!F||!Q.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:cursor-not-allowed bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg  border-transparent dark:border-white/10",children:te?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!P&&($?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(N),"æ¬¡"]}):S!==null&&S>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[S,"ç§¯åˆ†"]}):null)]})}),z.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",z.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:z.map((a,y)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:a,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"})},y))})]}),I.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",I.length,")"]}),e.jsx("div",{className:"space-y-1",children:I.map((a,y)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:a.name,children:a.name})]},y))})]})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},fo=t.memo(po),Nr="https://api.waule.com",As=400,mo=({data:s,id:j,selected:n})=>{const[F,ye]=t.useState(!1),[U,fe]=t.useState(0),[Q,re]=t.useState(s.config.uploadedFiles||[]),[K,ce]=t.useState(null),[Ue,he]=t.useState(null);t.useEffect(()=>()=>{},[j]),t.useEffect(()=>{},[K]),t.useEffect(()=>{},[Ue]);const[te,ae]=t.useState(null),je=t.useRef(null),ne=t.useRef(null),pe=t.useRef(null),[de,me]=t.useState(!1),[Ee,Z]=t.useState(0),[z,A]=t.useState(0),[I,G]=t.useState(!1),m=t.useRef(null),{setNodes:c,getNode:S,setEdges:P,getEdges:$}=Zt(),N=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const i=s.createdBy;if(typeof i=="object"&&(i==null||i.id),N.current)return;const B=s.config.uploadedFiles||[];!F&&JSON.stringify(B)!==JSON.stringify(Q)&&(re(B),ce(null),he(null))},[s.config.uploadedFiles,F,s._currentUserId,s.createdBy]);const O=()=>{m.current&&(m.current.paused?(m.current.play(),G(!0)):(m.current.pause(),G(!1)))},r=i=>{S(j)&&(N.current=!0,c(M=>M.map(X=>X.id===j?{...X,data:{...X.data,config:{...X.data.config,uploadedFiles:i}}}:X)))},v=async i=>{var M,X;if(!i||i.length===0)return;ye(!0);const B=[];try{for(let V=0;V<i.length;V++){const ie=i[V];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(ie.type)){f.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ie.name}`);continue}const oe=await Ce.assets.upload(ie,void 0,{onUploadProgress:k=>{const u=(k==null?void 0:k.total)||0,E=(k==null?void 0:k.loaded)||0;if(u>0){const b=Math.round(E/u*100);fe(b)}}});if(oe.data){const k=(oe.data.type||"").toUpperCase(),u=(oe.data.mimeType||"").toLowerCase(),E=k==="IMAGE"||k==="VIDEO"||k==="AUDIO"?k:u.startsWith("image/")?"IMAGE":u.startsWith("video/")?"VIDEO":u.startsWith("audio/")?"AUDIO":k||"",b=oe.data.url;B.push({id:oe.data.id,name:oe.data.name,originalName:oe.data.originalName,type:E,mimeType:oe.data.mimeType,size:oe.data.size,url:b})}}if(B.length>0){let V=[];const ie=B[0].type;if(te!==null)V=[...Q],V[te]=B[0];else{const oe={};for(const k of Q)oe[k.id]=k;for(const k of B)oe[k.id]=k;V=Object.values(oe)}if(S(j)){const oe=$().filter(u=>u.source===j),k=[];if(oe.forEach(u=>{var q;const E=S(u.target);if(!E||E.type.startsWith("aiVideo"))return;const b=(q=E.data.config)==null?void 0:q.acceptedInputs;if(b&&b.length>0){const ue=ie.toUpperCase();b.map(ge=>typeof ge=="string"?ge.toUpperCase():ge).includes(ue)||k.push(u.id)}}),k.length>0){P(E=>E.filter(b=>!k.includes(b.id)));const u={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};f.warning(`å·²æ–­å¼€ ${k.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${u[ie]||ie}ç±»å‹ï¼‰`)}}ce(null),he(null),re(V),r(V);try{const oe=$().filter(u=>u.source===j);if(oe.some(u=>{const E=S(u.target);return(E==null?void 0:E.type)==="aiVideo"})){const u=localStorage.getItem("workflow:nodes"),E=u?JSON.parse(u):[],b=oe.filter(ue=>{var H;return((H=S(ue.target))==null?void 0:H.type)==="aiVideo"}).map(ue=>ue.target),q=E.filter(ue=>b.includes(ue.id));q.length>0&&c(ue=>ue.map(H=>q.find(ge=>ge.id===H.id)?{...H,data:{...H.data,config:{...H.data.config,_updatedAt:Date.now()}}}:H))}}catch{}f.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(V){f.error(`ä¸Šä¼ å¤±è´¥: ${((X=(M=V.response)==null?void 0:M.data)==null?void 0:X.message)||V.message}`)}finally{ye(!1),fe(0),je.current&&(je.current.value=""),ae(null)}},g=()=>{c(i=>i.filter(B=>B.id!==j)),P(i=>i.filter(B=>B.source!==j&&B.target!==j)),f.success("èŠ‚ç‚¹å·²åˆ é™¤")},a=()=>{var i;ae(0),(i=je.current)==null||i.click()},y=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(2)+" KB":(i/(1024*1024)).toFixed(2)+" MB",d=i=>i.startsWith("image/")?{icon:"image",color:"text-neutral-500 dark:text-neutral-400"}:i.startsWith("video/")?{icon:"movie",color:"text-neutral-500 dark:text-neutral-400"}:i.startsWith("audio/")?{icon:"audio_file",color:"text-neutral-500 dark:text-neutral-400"}:{icon:"description",color:"text-neutral-500 dark:text-neutral-400"};t.useEffect(()=>{if(Q.length>0){const i=Q[0],B=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Nr}${i.url}`).replace(".oss-oss-",".oss-");if(i.type==="IMAGE"){const M=new Image;M.onload=()=>{const X=M.width/M.height,V=As/X;ce({width:As,height:V})},M.onerror=X=>{ce({width:As,height:As*.75})},M.src=B}else if(i.type==="VIDEO"){const M=document.createElement("video");M.onloadedmetadata=()=>{const X=M.videoWidth/M.videoHeight,V=As/X;he({width:As,height:V})},M.onerror=X=>{he({width:As,height:As*.5625})},M.src=B}}},[Q]);const x=()=>{const i=ne.current;i&&(de?(i.pause(),me(!1)):(i.play(),me(!0)))};t.useEffect(()=>{const i=ne.current;if(!i)return;const B=()=>Z(i.duration||0),M=()=>A(i.duration?i.currentTime/i.duration:0),X=()=>me(!1);return i.addEventListener("loadedmetadata",B),i.addEventListener("timeupdate",M),i.addEventListener("ended",X),()=>{i.removeEventListener("loadedmetadata",B),i.removeEventListener("timeupdate",M),i.removeEventListener("ended",X)}},[Q]);const p=t.useRef(null),[w,R]=t.useState(0);t.useEffect(()=>{const i=Q[0];if(!i||i.type!=="AUDIO"){p.current=null;return}const M=(i.url.startsWith("http")||i.url.startsWith("data:")?i.url:`${Nr}${i.url}`).replace(".oss-oss-",".oss-");(async()=>{try{let V;/https:\/\/.*aliyuncs\.com\//.test(M)?V=await Ce.assets.proxyDownload(M):V=await(await fetch(M,{mode:"cors"})).arrayBuffer();const ie=window.AudioContext||window.webkitAudioContext,k=(await new ie().decodeAudioData(V)).getChannelData(0),u=120,E=Math.max(1,Math.floor(k.length/u)),b=new Float32Array(u);for(let q=0;q<u;q++){let ue=0,H=0;const ge=q*E,Ie=Math.min(k.length,ge+E);for(let Ne=ge;Ne<Ie;Ne++)ue+=Math.abs(k[Ne]),H++;b[q]=H?ue/H:0}p.current=b,R(q=>q+1)}catch{const ie=new Float32Array(120);for(let xe=0;xe<120;xe++)ie[xe]=(Math.sin(xe/5)+1)/2;p.current=ie,R(xe=>xe+1)}})()},[Q]),t.useEffect(()=>{const i=pe.current;if(!i)return;const B=p.current;if(!B)return;const M=i.getContext("2d");if(!M)return;const X=i.width,V=i.height;M.clearRect(0,0,X,V);const ie=B.length,xe=2,oe=Math.max(1,Math.floor((X-(ie-1)*xe)/ie)),k=M.createLinearGradient(0,0,X,0);k.addColorStop(0,"#525252"),k.addColorStop(.5,"#d946ef"),k.addColorStop(1,"#404040");for(let u=0;u<ie;u++){const E=Math.min(1,Math.max(0,B[u])),b=Math.max(2,Math.floor(E*V)),q=u*(oe+xe),ue=Math.floor((V-b)/2);M.fillStyle=k,M.fillRect(q,ue,oe,b)}if(z>0){const u=Math.floor(X*z);M.fillStyle="#ffffff88",M.fillRect(u,0,2,V)}},[z,w]);const W=i=>{if(!i||!isFinite(i))return"0:00";const B=Math.floor(i/60),M=Math.floor(i%60);return`${B}:${M.toString().padStart(2,"0")}`},_=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"neutral"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"neutral"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"neutral"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"neutral"}],h=Q[0],l=h?(h.url.startsWith("http")||h.url.startsWith("data:")?h.url:`${Nr}${h.url}`).replace(".oss-oss-",".oss-"):"";return h&&h.type==="IMAGE"&&K?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:As},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:l,alt:"",className:"w-full object-cover",draggable:!1,style:{width:As,height:K.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):h&&h.type==="VIDEO"&&Ue?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:As},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${I?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:i=>{i.stopPropagation(),O()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:I?"pause":"play_arrow"})})}),e.jsx("video",{ref:m,src:l,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:As,height:Ue.height},onEnded:()=>G(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):h&&h.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:x,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:de?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:W(Ee)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:pe,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ne,src:l,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):h&&h.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:h.originalName,children:h.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:y(h.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:a,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-neutral-800 to-neutral-700 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:je,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:je,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:i=>v(i.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var i;s._canEdit!==!1&&((i=je.current)==null||i.click())},onDragOver:i=>{i.preventDefault(),i.stopPropagation()},onDrop:i=>{i.preventDefault(),i.stopPropagation(),s._canEdit!==!1&&v(i.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-neutral-400 dark:hover:border-neutral-400/50 transition-colors ${F||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:F?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:F?`ä¸Šä¼ ä¸­... ${U}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),F&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all",style:{width:`${U}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:_.map(i=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${i.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:i.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:i.formats.join(", ")})]},i.type))})]}),Q.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",Q.length,")"]}),Q.map(i=>{const{icon:B,color:M}=d(i.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${M} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:B}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:i.originalName,children:i.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:y(i.size)})]}),e.jsx("button",{onClick:g,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},i.id)})]})]})}),e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},xo=t.memo(mo),Gr="https://api.waule.com",$s=320,bo=({data:s,id:j,selected:n})=>{const[F,ye]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[U,fe]=t.useState([]),{setNodes:Q,getNode:re}=Zt(),[K,ce]=t.useState(null),[Ue,he]=t.useState(null),te=t.useRef(null),ae=t.useRef(null),[je,ne]=t.useState(!1),[pe,de]=t.useState(0),[me,Ee]=t.useState(0),Z=t.useRef(null),[z,A]=t.useState(!1),[I,G]=t.useState(!1),m=t.useRef(null),c=()=>{m.current&&(m.current.paused?(m.current.play(),G(!0)):(m.current.pause(),G(!1)))},S=t.useRef(!1);t.useEffect(()=>{const g=s._currentUserId,a=s.createdBy,y=typeof a=="object"?a==null?void 0:a.id:a;if(g&&y&&g===y&&S.current)return;const d=s.config.selectedInput||s.config.selectedAsset||null;if(!d)return;const x=F;(()=>{if(!x)return!1;const w=x.images&&!x.type,R=d.images&&!d.type;if(w&&R){const W=x.images||[],_=d.images||[];if(W.length!==_.length)return!1;for(let h=0;h<W.length;h++)if(W[h].id!==_[h].id||W[h].url!==_[h].url)return!1;return!0}if(x.id&&d.id)return x.id===d.id&&x.url===d.url&&x.type===d.type;try{return JSON.stringify(x)===JSON.stringify(d)}catch{return!1}})()||ye(d)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var a,y,d;if(F&&F.images&&!F.type){const x=F,p=(d=(y=(a=re(j))==null?void 0:a.data)==null?void 0:y.config)==null?void 0:d.referenceImages;Array.isArray(p)&&p.length>0?fe(p.map(w=>({id:w.id,url:w.url,name:w.name}))):fe(x.images||[])}else fe([])},[F,re,j]);const P=g=>{const a=re(j);a&&(S.current=!0,Q(y=>y.map(d=>d.id===j?{...d,data:{...d.data,config:{...d.data.config,...g}}}:d)),ye((g==null?void 0:g.selectedInput)??(g==null?void 0:g.selectedAsset)??a.data.config.selectedInput??a.data.config.selectedAsset))},$=g=>/^https?:\/\//.test(g)||g.startsWith("data:"),N=g=>!g||g.startsWith("data:")?g:/^https?:\/\/localhost(?::\d+)?\//i.test(g)?g.replace(/^https?:\/\/localhost(?::\d+)?/i,Gr):$(g)?g:`${Gr}${g}`;t.useEffect(()=>{var _,h,l,i,B,M,X,V,ie;if(!(F&&F.images&&!F.type))return;const a=F,y=U.length?U:a.images||[];if(y.length===1){const xe=y[0],oe={id:xe.id,name:xe.name,originalName:xe.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:xe.url};P({selectedInput:oe,selectedAsset:oe,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const d=[{name:a.name,images:y.map(xe=>N(xe.url))}],x=y.map(xe=>({id:xe.id,url:xe.url,name:xe.name})),p=[a.id],w=(l=(h=(_=re(j))==null?void 0:_.data)==null?void 0:h.config)==null?void 0:l.subjects,R=(M=(B=(i=re(j))==null?void 0:i.data)==null?void 0:B.config)==null?void 0:M.referenceImages,W=(ie=(V=(X=re(j))==null?void 0:X.data)==null?void 0:V.config)==null?void 0:ie.roleIds;(JSON.stringify(w)!==JSON.stringify(d)||JSON.stringify(R)!==JSON.stringify(x)||JSON.stringify(W)!==JSON.stringify(p))&&P({subjects:d,referenceImages:x,roleIds:p})},[U]);const O=g=>{if(!(F&&F.images&&!F.type))return;const y=F,d=[...U];if(g<0||g>=d.length)return;if(d.splice(g,1),fe(d),f.success("å·²åˆ é™¤å‚è€ƒå›¾"),d.length===0){ye(null),P({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),f.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(d.length===1){const W=d[0],_={id:W.id,name:W.name,originalName:W.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:W.url};ye(_),P({selectedInput:_,selectedAsset:_,subjects:void 0,referenceImages:void 0,roleIds:void 0}),f.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const x={id:y.id,name:y.name,coverUrl:N(d[0].url),images:d};ye(x);const p=[{name:x.name,images:d.map(W=>N(W.url))}],w=d.map(W=>({id:W.id,url:W.url,name:W.name})),R=[x.id];P({selectedInput:x,subjects:p,referenceImages:w,roleIds:R}),f.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(j)};t.useEffect(()=>{if(F&&F.type){const g=F;if(g.type==="IMAGE"){const a=new Image;a.onload=()=>{const y=a.width/a.height,d=$s/y;ce({width:$s,height:d})},a.src=N(g.url)}else if(g.type==="VIDEO"){const a=document.createElement("video");a.onloadedmetadata=()=>{const y=a.videoWidth/a.videoHeight,d=$s/y;he({width:$s,height:d})},a.src=N(g.url)}}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")){A(!1);return}const y=N(F.url),d=te.current,x=ae.current;if(!d||!x)return;d.src=y,Ee(0),A(!1);const p=()=>de(d.duration||0),w=()=>Ee(d.duration?d.currentTime/d.duration:0),R=()=>ne(!1);return d.addEventListener("loadedmetadata",p),d.addEventListener("timeupdate",w),d.addEventListener("ended",R),(async()=>{try{const h=await(await fetch(y,{mode:"cors"})).arrayBuffer(),l=window.AudioContext||window.webkitAudioContext,M=(await new l().decodeAudioData(h)).getChannelData(0),X=120,V=Math.max(1,Math.floor(M.length/X)),ie=new Float32Array(X);for(let xe=0;xe<X;xe++){let oe=0,k=0;const u=xe*V,E=Math.min(M.length,u+V);for(let b=u;b<E;b++)oe+=Math.abs(M[b]),k++;ie[xe]=k?oe/k:0}Z.current=ie,A(!0)}catch{const h=new Float32Array(120);for(let l=0;l<120;l++)h[l]=(Math.sin(l/5)+1)/2;Z.current=h,A(!0)}})(),()=>{d.removeEventListener("loadedmetadata",p),d.removeEventListener("timeupdate",w),d.removeEventListener("ended",R)}},[F]),t.useEffect(()=>{if(!(F&&F.type==="AUDIO")||!z)return;const a=ae.current,y=Z.current;if(!a||!y)return;const d=a.getContext("2d");if(!d)return;const x=a.width,p=a.height;d.clearRect(0,0,x,p);const w=y.length,R=2,W=Math.max(1,Math.floor((x-(w-1)*R)/w)),_=d.createLinearGradient(0,0,x,0);_.addColorStop(0,"#525252"),_.addColorStop(.5,"#d946ef"),_.addColorStop(1,"#404040");for(let h=0;h<w;h++){const l=Math.min(1,Math.max(0,y[h])),i=Math.max(2,Math.floor(l*p)),B=h*(W+R),M=Math.floor((p-i)/2);d.fillStyle=_,d.fillRect(B,M,W,i)}if(me>0){const h=Math.floor(x*me);d.fillStyle="#ffffff88",d.fillRect(h,0,2,p)}},[F,me,z]);const v=g=>g<1024?g+" B":g<1024*1024?(g/1024).toFixed(2)+" KB":(g/(1024*1024)).toFixed(2)+" MB";if(F){if(F.images&&!F.type){const d=F;return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:$s*.5625},children:U[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:x=>x.preventDefault(),src:N(U[0].url),alt:d.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:x=>{x.preventDefault(),x.stopPropagation(),x.nativeEvent&&typeof x.nativeEvent.stopImmediatePropagation=="function"&&x.nativeEvent.stopImmediatePropagation(),O(0)},onClick:x=>{x.preventDefault(),x.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:d.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:U.slice(1).map((x,p)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:w=>w.preventDefault(),src:N(x.url),alt:x.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:w=>{w.preventDefault(),w.stopPropagation(),w.nativeEvent&&typeof w.nativeEvent.stopImmediatePropagation=="function"&&w.nativeEvent.stopImmediatePropagation(),O(p+1)},onClick:w=>{w.preventDefault(),w.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},x.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const a=F,y=N(a.url);if(a.type==="IMAGE"&&K)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:y,alt:a.name,className:"w-full object-cover",style:{width:$s,height:K.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="VIDEO"&&Ue)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${I?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:d=>{d.stopPropagation(),c()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:I?"pause":"play_arrow"})})}),e.jsx("video",{ref:m,src:y,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:$s,height:Ue.height},onEnded:()=>G(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(a.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const d=te.current;d&&(je?(d.pause(),ne(!1)):(d.play(),ne(!0)))},className:"nodrag w-8 h-8 rounded-full bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:je?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const d=pe;if(!d||!isFinite(d))return"0:00";const x=Math.floor(d/60),p=Math.floor(d%60);return`${x}:${p.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:ae,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:te,src:y,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(a.type==="DOCUMENT"){const d=w=>w.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:w.includes("word")?{icon:"description",color:"text-blue-400"}:w.includes("excel")||w.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:x,color:p}=d(a.mimeType);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${p} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:x}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:a.originalName,children:a.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:v(a.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:$s},children:[e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},wo=t.memo(bo),pr={};function _s(s){const{project:j,episode:n,nodeGroup:F,assetType:ye,preview:U=!0}=s;if(!F||!F.scene||!F.shot)return null;const fe=`${F.id}-${ye}`;pr[fe]||(pr[fe]=0);let Q;U?Q=pr[fe]+1:(pr[fe]++,Q=pr[fe]);let re=j.name;if(j.type==="DRAMA"&&n){const K=`S${String(n.episodeNumber).padStart(3,"0")}`;re+=`_${K}`}return re+=`_Sc${F.scene}_Sh${F.shot}`,re+=`_${Q}`,re}function Ws(s,j){return j.find(n=>n.nodeIds.includes(s))||null}const yo=({data:s,id:j})=>{var d,x;const{setNodes:n,setEdges:F,getNodes:ye}=Zt(),U=Er(p=>p.refreshUser),fe=Sr(),Q=!!((d=s==null?void 0:s.workflowContext)!=null&&d.episode)||fe.pathname.includes("/episodes/");t.useEffect(()=>{(async()=>{var w,R,W;if(Q)try{const _=(s==null?void 0:s.workflowContext)||{},h=_.episode,l=new URLSearchParams(window.location.search),i=Number(l.get("shot"))||1,B=fe.pathname.split("/").filter(Boolean),M=B.indexOf("projects"),X=B.indexOf("episodes"),V=((w=_.project)==null?void 0:w.id)||(h==null?void 0:h.projectId)||(M>=0?B[M+1]:void 0),ie=(h==null?void 0:h.id)||(X>=0?B[X+1]:void 0);if(!V||!ie)return;const xe=await Ce.episodes.getById(V,ie),oe=(xe==null?void 0:xe.data)??xe,k=(oe==null?void 0:oe.data)??oe,E=(Array.isArray((R=k==null?void 0:k.scriptJson)==null?void 0:R.acts)?k.scriptJson.acts:[]).find(H=>H.actIndex===1),b=(W=E==null?void 0:E.shots)==null?void 0:W.find(H=>Number(H.shotIndex)===i),ue=(Array.isArray(b==null?void 0:b.mediaList)?b.mediaList:[]).some(H=>(H==null?void 0:H.nodeId)===j);n(H=>H.map(ge=>ge.id===j?{...ge,data:{...ge.data,addedToStoryboard:ue}}:ge))}catch{}})()},[j,Q,fe.pathname]);const[re,K]=t.useState(!1),[ce,Ue]=t.useState([]),[he,te]=t.useState(""),[ae,je]=t.useState("ALL"),[ne,pe]=t.useState(""),[de,me]=t.useState(!1),Ee=s.width||400,[Z,z]=t.useState(null);t.useEffect(()=>{re&&(v(),setTimeout(()=>{g()},100))},[re]);const A=t.useRef(null),I=t.useRef(!1);t.useEffect(()=>{const p=s.pendingButtonAction;if(p){try{const W=localStorage.getItem("suppressedPreviewTasks")||"[]",_=JSON.parse(W),h=localStorage.getItem("createdPreviewTasks")||"[]",l=JSON.parse(h),i=_.some(V=>V.taskId&&V.taskId===p.newTaskId||V.sourceNodeId&&V.sourceNodeId===p.sourceNodeId),M=ye().some(V=>{var ie,xe,oe,k;return V.type==="imagePreview"&&((xe=(ie=V.data)==null?void 0:ie.midjourneyData)==null?void 0:xe.sourceNodeId)===p.sourceNodeId&&((k=(oe=V.data)==null?void 0:oe.midjourneyData)==null?void 0:k.taskId)===p.newTaskId}),X=l.some(V=>V.taskId&&V.taskId===p.newTaskId);if(i||X&&M){z(null),n(V=>V.map(ie=>ie.id===p.sourceNodeId?{...ie,data:{...ie.data,pendingButtonAction:void 0}}:ie));return}}catch{}if(I.current)return;if(I.current=!0,ye().some(W=>{var _,h,l,i;return W.type==="imagePreview"&&((h=(_=W.data)==null?void 0:_.midjourneyData)==null?void 0:h.sourceNodeId)===p.sourceNodeId&&((i=(l=W.data)==null?void 0:l.midjourneyData)==null?void 0:i.taskId)===p.newTaskId})){z(null),n(W=>W.map(_=>_.id===p.sourceNodeId?{..._,data:{..._.data,pendingButtonAction:void 0}}:_)),I.current=!1;return}z(p.buttonCustomId),G(p.newTaskId,p.buttonLabel,p.sourceNodeId)}return()=>{I.current=!1,A.current&&(clearTimeout(A.current),A.current=null)}},[]);const G=async(p,w,R)=>{const W=R||j;let _=0;const h=150,l=2e3;I.current=!0;const i=/^[UV]\d$/.test(w)||w.includes("Vary")||w.includes("Upscale")&&w!=="Upscale"||w.includes("Zoom")||w.includes("Pan")||w.includes("Make")||w.includes("Remaster"),B=async()=>{var M,X,V,ie,xe,oe,k,u;if(I.current)try{const E=await Ce.midjourney.fetchTask(p);if(!I.current)return;const b=E.task;if(b.status==="SUCCESS"){if(i&&s.imageUrl&&((M=s.midjourneyData)!=null&&M.messageId)){const gt=b.imageUrl===s.imageUrl,vt=((X=b.properties)==null?void 0:X.messageId)===((V=s.midjourneyData)==null?void 0:V.messageId);if(gt&&vt){_++;try{const it=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(it).some(Be=>{var wt;return Be.taskId&&Be.taskId===p||Be.messageId&&Be.messageId===((wt=b.properties)==null?void 0:wt.messageId)})){z(null),n(Be=>Be.map(wt=>wt.id===W?{...wt,data:{...wt.data,pendingButtonAction:void 0}}:wt));return}}catch{}_<h?A.current=setTimeout(B,l):(f.error(`${w} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),z(null),n(it=>it.map(Ye=>Ye.id===W?{...Ye,data:{...Ye.data,pendingButtonAction:void 0}}:Ye)));return}}if(f.success(`${w} å®Œæˆï¼`),z(null),n(gt=>gt.map(vt=>vt.id===W?{...vt,data:{...vt.data,pendingButtonAction:void 0}}:vt)),ye().find(gt=>{var vt,it,Ye,yt,Be;return gt.type==="imagePreview"&&((vt=gt.data.midjourneyData)==null?void 0:vt.sourceNodeId)===W&&(((it=gt.data.midjourneyData)==null?void 0:it.taskId)===p||((Ye=b.properties)==null?void 0:Ye.messageId)&&((yt=gt.data.midjourneyData)==null?void 0:yt.messageId)===((Be=b.properties)==null?void 0:Be.messageId))})){f.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const H=ye().find(gt=>gt.id===W);if(!H)return;if(!b.imageUrl){f.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const ge=200,Ie=100,Ne=s.width||400,Ae=((gt,vt=300)=>{if(!gt||!/^[0-9]+\s*:\s*[0-9]+$/.test(gt))return vt;const[it,Ye]=gt.split(":").map(yt=>parseFloat(yt));return!it||!Ye?vt:Math.round(Ne*(Ye/it))})(s.ratio,300),_e=document.querySelector(`.react-flow__node[data-id="${H.id}"]`),$e=Math.round((_e==null?void 0:_e.getBoundingClientRect().width)||((ie=H.data)==null?void 0:ie.width)||400),le=ye().filter(gt=>{var vt,it;return gt.type==="imagePreview"&&((it=(vt=gt.data)==null?void 0:vt.midjourneyData)==null?void 0:it.sourceNodeId)===W}),Ge=H.position.x+$e+ge,Qe=H.position.y,Wt=Ge,Ct=Qe+le.length*(Ae+Ie),_t=`preview-${Date.now()}`,ct={id:_t,type:"imagePreview",position:{x:Wt,y:Ct},data:{imageUrl:b.imageUrl,width:Ne,height:Ae,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(xe=H.data)==null?void 0:xe.createdBy,midjourneyData:{taskId:p,messageId:(oe=b.properties)==null?void 0:oe.messageId,messageHash:(k=b.properties)==null?void 0:k.messageHash,sourceNodeId:W,buttons:b.buttons,action:b.action}}};n(gt=>[...gt,ct]),F(gt=>{const vt={id:`${W}-${_t}`,source:W,target:_t,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...gt,vt]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const vt=ye().find(it=>it.id===_t)})});try{const gt=localStorage.getItem("createdPreviewTasks")||"[]",it=[...JSON.parse(gt),{taskId:p,messageId:(u=b.properties)==null?void 0:u.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(it))}catch{}f.success(`å·²åˆ›å»º${w}é¢„è§ˆèŠ‚ç‚¹`);return}if(b.status==="FAILURE"){f.error(`${w} å¤±è´¥: ${b.failReason||"æœªçŸ¥é”™è¯¯"}`),z(null),n(q=>q.map(ue=>ue.id===W?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue));return}if(b.status==="NOT_FOUND"){if(ye().some(H=>{var ge,Ie,Ne,Re;return H.type==="imagePreview"&&((Ie=(ge=H.data)==null?void 0:ge.midjourneyData)==null?void 0:Ie.sourceNodeId)===W&&((Re=(Ne=H.data)==null?void 0:Ne.midjourneyData)==null?void 0:Re.taskId)===p})){z(null),n(H=>H.map(ge=>ge.id===W?{...ge,data:{...ge.data,pendingButtonAction:void 0}}:ge));return}f.error(`${w} ä»»åŠ¡ä¸å­˜åœ¨`),z(null),n(H=>H.map(ge=>ge.id===W?{...ge,data:{...ge.data,pendingButtonAction:void 0}}:ge));return}_++,_<h?A.current=setTimeout(B,l):(f.error(`${w} è¶…æ—¶`),z(null),n(q=>q.map(ue=>ue.id===j?{...ue,data:{...ue.data,pendingButtonAction:void 0}}:ue)))}catch(E){f.error(`${w} å¤±è´¥: ${E.message}`),z(null),n(b=>b.map(q=>q.id===j?{...q,data:{...q.data,pendingButtonAction:void 0}}:q))}};B()},m=()=>{try{const p=localStorage.getItem("midjourneyButtonConfig");if(p)return JSON.parse(p)}catch{}return{}},c=p=>{const w=m();if(Object.keys(w).length===0)return!0;const R=p.label.replace(/\s+/g,"_");return w.hasOwnProperty(R)?w[R]===!0:!0},S=p=>{if(!p)return"";let w=p.trim();return/^upscale_\d+\s/i.test(w)&&(w=w.replace(/^upscale_\d+\s+/i,"")),w},P=(((x=s.midjourneyData)==null?void 0:x.buttons)||[]).map(p=>String(p.label||"").toLowerCase()),$=P.some(p=>/^[uv][1-4]$/i.test(p)),N=P.some(p=>p.includes("redo")),O=!$&&!N&&P.some(p=>p.includes("upscale")),r=p=>{const w=String(p.label||""),R=w.toLowerCase(),W=String(p.customId||"").toLowerCase(),_=/ğŸ‘|â¤ï¸|â¤/.test(w);return R.includes("animate")||R.includes("web")||W.includes("web")||R.includes("browser")||R.includes("open in web")||R.includes("open web")||R.includes("like")||W.includes("like")||_?!1:$?/^U[1-4]$/i.test(w):O?R.includes("upscale"):!1};t.useEffect(()=>{re&&(v(),g())},[re]);const v=async()=>{try{const p=ae==="ALL"?void 0:{category:ae},R=(await Ce.assetLibraries.getAll(p)).data||[];if(Ue(R),R.length>0){const W=R.find(_=>_.id===he);te(W?W.id:R[0].id)}else te("")}catch{f.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},g=()=>{const p=window.__workflowContext;if(!p||!p.project||!p.nodeGroups){f.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const w=Ws(j,p.nodeGroups);if(!w&&p.nodeGroups.length>0){const W=p.nodeGroups[0],_=_s({project:p.project,episode:p.episode,nodeGroup:W,assetType:"image"});_?(pe(_),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${_}`)):f.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const R=_s({project:p.project,episode:p.episode,nodeGroup:w,assetType:"image"});R?(pe(R),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${R}`)):f.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},a=async()=>{var p,w;if(!he){f.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ne.trim()){f.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{me(!0),await Ce.assetLibraries.addFromUrl(he,s.imageUrl,ne.trim());const R=window.__workflowContext;if(R&&R.project&&R.nodeGroups){const W=Ws(j,R.nodeGroups)||R.nodeGroups[0];W&&_s({project:R.project,episode:R.episode,nodeGroup:W,nodeId:j,assetType:"image",preview:!1})}f.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),K(!1),pe("");try{n(W=>W.map(_=>_.id===j?{..._,data:{..._.data,addedToLibrary:!0}}:_))}catch{}try{const W=new CustomEvent("asset-library-updated",{detail:{libraryId:he}});window.dispatchEvent(W)}catch{}}catch(R){f.error(((w=(p=R.response)==null?void 0:p.data)==null?void 0:w.message)||"æ·»åŠ å¤±è´¥")}finally{me(!1)}},y=async()=>{var p;try{const w=s.imageUrl;let R=`image-${Date.now()}.jpg`;const W=window.__workflowContext;if(W&&W.project&&W.nodeGroups){const M=Ws(j,W.nodeGroups)||W.nodeGroups[0];if(M){const X=_s({project:W.project,episode:W.episode,nodeGroup:M,nodeId:j,assetType:"image",preview:!0});if(X&&(R=X,!R.includes("."))){const V=((p=w.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:p[0])||".jpg";R+=V}}}f.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const _=`/assets/proxy-download-with-name?url=${encodeURIComponent(w)}&filename=${encodeURIComponent(R)}`,h=await Ce.get(_,{responseType:"blob"}),l=h instanceof Blob?h:h==null?void 0:h.data;if(!l||!(l instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const i=window.URL.createObjectURL(l),B=document.createElement("a");B.href=i,B.download=R,document.body.appendChild(B),B.click(),document.body.removeChild(B),setTimeout(()=>{window.URL.revokeObjectURL(i)},100),f.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${R}`)}catch(w){f.error(`æ“ä½œå¤±è´¥: ${w instanceof Error?w.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const w=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(R=>c(R)&&r(R)):[]).length>0;return e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:Ee,borderRadius:w?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[Q&&e.jsxs("button",{onClick:async()=>{var R,W;try{const _=s.imageUrl,h=s.workflowContext||{},l=h.episode,i=new URLSearchParams(window.location.search),B=Number(i.get("shot"))||1,M=fe.pathname.split("/").filter(Boolean),X=M.indexOf("projects"),V=M.indexOf("episodes"),ie=((R=h.project)==null?void 0:R.id)||(l==null?void 0:l.projectId)||(X>=0?M[X+1]:void 0),xe=(l==null?void 0:l.id)||(V>=0?M[V+1]:void 0);if(!ie||!xe){f.error("ç¼ºå°‘å‰§é›†ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const oe=await Ce.episodes.getById(ie,xe),k=(oe==null?void 0:oe.data)??oe,u=(k==null?void 0:k.data)??k;let E=Array.isArray((W=u==null?void 0:u.scriptJson)==null?void 0:W.acts)?[...u.scriptJson.acts]:[],b=E.find(ge=>ge.actIndex===1);b||(b={actIndex:1,shots:[]},E.push(b)),b.shots=Array.isArray(b.shots)?[...b.shots]:[];let q=b.shots.find(ge=>Number(ge.shotIndex)===B);q||(q={shotIndex:B,mediaList:[]},b.shots.push(q));const ue=Array.isArray(q.mediaList)?q.mediaList.slice():[];ue.push({type:"image",url:_,nodeId:j,duration:5}),q.mediaList=ue;const H={...u.scriptJson||{},acts:E};await Ce.episodes.update(ie,xe,{scriptJson:H});try{n(ge=>ge.map(Ie=>Ie.id===j?{...Ie,data:{...Ie.data,addedToStoryboard:!0}}:Ie))}catch{}f.success("å·²æ·»åŠ åˆ°åˆ†é•œç´ æ")}catch(_){f.error((_==null?void 0:_.message)||"æ·»åŠ åˆ°åˆ†é•œç´ æå¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œç´ æ":"æ·»åŠ åˆ°åˆ†é•œç´ æ",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{K(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:y,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const p=(s.midjourneyData.buttons||[]).filter(w=>c(w)&&r(w));return p.length===0?null:e.jsxs("div",{className:"nodrag bg-white dark:bg-[#18181b] backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:Ee},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:p.map((w,R)=>{var B;const W=S(w.label),_=((B=s.clickedButtons)==null?void 0:B.includes(w.label))||!1,h=Z===w.customId,l=s._canEdit===!1,i=Z!==null&&Z!==w.customId||_||l;return e.jsx("button",{onClick:async()=>{var M,X,V,ie,xe,oe;if(!((M=s.midjourneyData)!=null&&M.taskId)){f.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(_){f.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}z(w.customId);try{f.info(`æ­£åœ¨æ‰§è¡Œ ${w.label}...`);const k=await Ce.midjourney.action({taskId:s.midjourneyData.taskId,customId:w.customId,messageId:s.midjourneyData.messageId,nodeId:j,mode:s.midjourneyData.mode||"relax"});if(!k.success){f.error(k.description||"æ“ä½œå¤±è´¥"),z(null);return}const u=k.taskId;if(k.creditsCharged&&k.creditsCharged>0&&U(),!u){f.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),z(null);return}n(E=>E.map(b=>b.id===j?{...b,data:{...b.data,pendingButtonAction:{buttonLabel:w.label,buttonCustomId:w.customId,newTaskId:u,sourceNodeId:j},clickedButtons:[...b.data.clickedButtons||[],w.label]}}:b)),f.info(`${W} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),G(u,W)}catch(k){if(((X=k.response)==null?void 0:X.status)===429)f.warning(((ie=(V=k.response)==null?void 0:V.data)==null?void 0:ie.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const u=((oe=(xe=k.response)==null?void 0:xe.data)==null?void 0:oe.error)||k.message;f.error(u)}z(null)}},disabled:i,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${_?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":h?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-wait text-white border-transparent shadow-md":Z!==null?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:_?`${W} (å·²ç‚¹å‡»)`:W,children:e.jsxs("span",{className:"flex items-center gap-1",children:[h&&e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),w.emoji&&!/^upscale_\d+$/i.test(w.emoji)&&e.jsx("span",{children:w.emoji}),W,_&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},R)})})]})})(),re&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>K(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ne,onChange:p=>pe(p.target.value),onMouseDown:p=>p.stopPropagation(),onTouchStart:p=>p.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const p=ae==="ALL"?ce:ce.filter(w=>(w.category||"OTHER")===ae);return p.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:ae==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:he,onChange:w=>te(w.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:p.map(w=>e.jsxs("option",{value:w.id,children:[w.name," (",w._count.assets," ä¸ªèµ„äº§)"]},w.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(p=>e.jsx("button",{type:"button",onClick:()=>{je(p);const w=ce.filter(R=>(R.category||"OTHER")===p);te(w.length>0?w[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${ae===p?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:p==="ROLE"?"person":p==="SCENE"?"landscape":p==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:p==="ROLE"?"è§’è‰²åº“":p==="SCENE"?"åœºæ™¯åº“":p==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},p))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>K(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:a,disabled:de||ce.length===0||!ne.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:de?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ko=t.memo(yo),vo=({data:s,id:j})=>{var P;const n="https://api.waule.com",[F,ye]=t.useState(!1),[U,fe]=t.useState([]),[Q,re]=t.useState(""),[K,ce]=t.useState("ALL"),[Ue,he]=t.useState(""),[te,ae]=t.useState(!1),{setNodes:je}=Zt(),[ne]=t.useState(s.width||400),[pe,de]=t.useState(null),[me,Ee]=t.useState(!1),Z=t.useRef(null),z=Sr(),A=!!((P=s==null?void 0:s.workflowContext)!=null&&P.episode)||z.pathname.includes("/episodes/");t.useEffect(()=>{F&&(G(),setTimeout(()=>{m()},100))},[F]),t.useEffect(()=>{const $=Z.current;if(!$)return;const N=()=>{const g=$.videoWidth||0,a=$.videoHeight||0;if(g>0&&a>0){const y=g/a;de(Math.round(ne/y))}},O=()=>Ee(!0),r=()=>Ee(!1),v=()=>Ee(!1);return $.addEventListener("loadedmetadata",N),$.addEventListener("play",O),$.addEventListener("pause",r),$.addEventListener("ended",v),()=>{$.removeEventListener("loadedmetadata",N),$.removeEventListener("play",O),$.removeEventListener("pause",r),$.removeEventListener("ended",v)}},[ne,s.videoUrl]);const I=$=>{$.stopPropagation();const N=Z.current;N&&(N.paused?N.play():N.pause())};t.useEffect(()=>{try{const $=localStorage.getItem("suppressedPreviewTasks")||"[]",N=JSON.parse($),O=s==null?void 0:s.pendingButtonAction;if(O&&N.some(v=>v.taskId&&v.taskId===O.newTaskId||v.sourceNodeId&&v.sourceNodeId===O.sourceNodeId)){ye(!1);return}}catch{}},[]);const G=async()=>{try{const $=await Ce.assetLibraries.getAll();fe($.data),$.data.length>0&&re($.data[0].id)}catch{f.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},m=()=>{const $=window.__workflowContext;if(!$||!$.project||!$.nodeGroups){f.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const N=Ws(j,$.nodeGroups);if(!N&&$.nodeGroups.length>0){const r=$.nodeGroups[0],v=_s({project:$.project,episode:$.episode,nodeGroup:r,assetType:"video"});v?(he(v),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${v}`)):f.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const O=_s({project:$.project,episode:$.episode,nodeGroup:N,assetType:"video"});O?(he(O),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${O}`)):f.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},c=async()=>{var $,N;if(!Q){f.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Ue.trim()){f.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ae(!0),await Ce.assetLibraries.addFromUrl(Q,s.videoUrl,Ue.trim());const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const r=Ws(j,O.nodeGroups)||O.nodeGroups[0];r&&_s({project:O.project,episode:O.episode,nodeGroup:r,nodeId:j,assetType:"video",preview:!1})}f.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ye(!1),he("");try{je(r=>r.map(v=>v.id===j?{...v,data:{...v.data,addedToLibrary:!0}}:v))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:Q}});window.dispatchEvent(r)}catch{}}catch(O){f.error(((N=($=O.response)==null?void 0:$.data)==null?void 0:N.message)||"æ·»åŠ å¤±è´¥")}finally{ae(!1)}},S=async()=>{var $;try{const N=s.videoUrl;let O=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const x=Ws(j,r.nodeGroups)||r.nodeGroups[0];if(x){const p=_s({project:r.project,episode:r.episode,nodeGroup:x,nodeId:j,assetType:"video",preview:!0});if(p&&(O=p,!O.includes("."))){const w=(($=N.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:$[0])||".mp4";O+=w}}}f.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");const v=`/assets/proxy-download-with-name?url=${encodeURIComponent(N)}&filename=${encodeURIComponent(O)}`,g=await Ce.get(v,{responseType:"blob"}),a=g instanceof Blob?g:g==null?void 0:g.data;if(!a||!(a instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const y=window.URL.createObjectURL(a),d=document.createElement("a");d.href=y,d.download=O,document.body.appendChild(d),d.click(),document.body.removeChild(d),setTimeout(()=>{window.URL.revokeObjectURL(y)},100),f.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${O}`)}catch(N){f.error(`æ“ä½œå¤±è´¥: ${N instanceof Error?N.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ne},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${me?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:I,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:me?"pause":"play_arrow"})})}),e.jsx("video",{ref:Z,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${n}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:pe?`${pe}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[A&&e.jsxs("button",{onClick:async()=>{var $,N;try{const O=s.videoUrl,r=s.workflowContext||{},v=r.episode,g=(()=>{try{const X=new URLSearchParams(window.location.search);return{scene:Number(X.get("scene")),shot:Number(X.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),a=r.nodeGroup||Ws(j,r.nodeGroups||[]),y=(a==null?void 0:a.scene)??g.scene,d=(a==null?void 0:a.shot)??g.shot,x=(()=>{try{const X=z.pathname.split("/").filter(Boolean),V=X.indexOf("projects"),ie=X.indexOf("episodes"),xe=V>=0?X[V+1]:void 0,oe=ie>=0?X[ie+1]:void 0;return{pid:xe,eid:oe}}catch{return{pid:void 0,eid:void 0}}})(),p=(($=r.project)==null?void 0:$.id)||(v==null?void 0:v.projectId)||x.pid,w=(v==null?void 0:v.id)||x.eid;if(!p||!w||!y||!d){f.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const R=await Ce.episodes.getById(p,w),W=(R==null?void 0:R.data)??R,_=(W==null?void 0:W.data)??W,h=Array.isArray((N=_==null?void 0:_.scriptJson)==null?void 0:N.acts)?[..._.scriptJson.acts]:[];let l=h.find(X=>Number(X.actIndex)===Number(y));l||(l={actIndex:Number(y),shots:[]},h.push(l)),l.shots=Array.isArray(l.shots)?[...l.shots]:[];let i=l.shots.find(X=>Number(X.shotIndex)===Number(d));i||(i={shotIndex:Number(d),mediaList:[]},l.shots.push(i));const B=Array.isArray(i.mediaList)?i.mediaList.slice():[];if(B.length>=4){f.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}B.push({type:"video",url:O,nodeId:j}),i.mediaList=B;const M={..._.scriptJson||{},acts:h};await Ce.episodes.update(p,w,{scriptJson:M});try{je(X=>X.map(V=>V.id===j?{...V,data:{...V.data,addedToStoryboard:!0}}:V))}catch{}f.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(O){f.error((O==null?void 0:O.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{ye(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:S,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),F&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ye(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Ue,onChange:$=>he($.target.value),onMouseDown:$=>$.stopPropagation(),onTouchStart:$=>$.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const $=K==="ALL"?U:U.filter(N=>(N.category||"OTHER")===K);return $.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:K==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Q,onChange:N=>re(N.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:$.map(N=>e.jsxs("option",{value:N.id,children:[N.name," (",N._count.assets," ä¸ªèµ„äº§)"]},N.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map($=>e.jsx("button",{type:"button",onClick:()=>{ce($);const N=U.filter(O=>(O.category||"OTHER")===$);re(N.length>0?N[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${K===$?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:$==="ROLE"?"person":$==="SCENE"?"landscape":$==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:$==="ROLE"?"è§’è‰²åº“":$==="SCENE"?"åœºæ™¯åº“":$==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},$))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ye(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:c,disabled:te||U.length===0||!Ue.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:te?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`})]})},No=t.memo(vo),jo=({data:s,id:j,selected:n})=>{const{getNodes:F,getEdges:ye,setEdges:U,setNodes:fe,getNode:Q}=Zt(),[re,K]=t.useState(s.content||""),ce=t.useRef(null),Ue=t.useRef(null),he=t.useRef(null),te=t.useRef(null);t.useEffect(()=>{const I=S=>{S.stopPropagation()},G=Ue.current,m=he.current;G&&G.addEventListener("wheel",I,{passive:!0}),m&&m.addEventListener("wheel",I,{passive:!0});const c=te.current;return c&&c.addEventListener("wheel",I,{passive:!0}),()=>{G&&G.removeEventListener("wheel",I),m&&m.removeEventListener("wheel",I),c&&c.removeEventListener("wheel",I)}},[]);const ae=t.useRef(null),je=async I=>{var G,m;try{const c=(s==null?void 0:s.workflowContext)||{},S=c.episode,P=c.nodeGroup||Array.isArray(c.nodeGroups)&&c.nodeGroups.find(w=>(w.nodeIds||[]).includes(j))||null;let $=P==null?void 0:P.scene,N=P==null?void 0:P.shot;try{const w=new URLSearchParams(window.location.search),R=Number(w.get("scene")),W=Number(w.get("shot"));Number.isFinite(R)&&R>0&&($=$??R),Number.isFinite(W)&&W>0&&(N=N??W)}catch{}const O=((G=c.project)==null?void 0:G.id)||(S==null?void 0:S.projectId),r=S==null?void 0:S.id;if(!O||!r||!$||!N)return;const v=await Ce.episodes.getById(O,r),g=(v==null?void 0:v.data)??v,a=(g==null?void 0:g.data)??g,y=Array.isArray((m=a==null?void 0:a.scriptJson)==null?void 0:m.acts)?[...a.scriptJson.acts]:[];let d=y.find(w=>Number(w.actIndex)===Number($));d||(d={actIndex:Number($),shots:[]},y.push(d)),d.shots=Array.isArray(d.shots)?[...d.shots]:[];let x=d.shots.find(w=>Number(w.shotIndex)===Number(N));x||(x={shotIndex:Number(N)},d.shots.push(x)),Object.keys(I).forEach(w=>{x[w]=I[w]||""});const p={...a.scriptJson||{},acts:y};await Ce.episodes.update(O,r,{scriptJson:p})}catch(c){f.error((c==null?void 0:c.message)||"ä¿å­˜å¤±è´¥")}},ne=()=>{var I,G,m;try{const c=F(),S=ye(),P=c.find(g=>g.id===j),$=S.filter(g=>g.source===j).map(g=>g.target),N=c.filter(g=>g.type==="agent");let O="";const r=N.find(g=>$.includes(g.id));if(r)O=r.id;else if(P&&N.length>0)O=((G=(I=N.map(a=>{var y,d,x,p;return{a,dx:(((y=a.position)==null?void 0:y.x)??0)-(((d=P.position)==null?void 0:d.x)??0),dy:Math.abs((((x=a.position)==null?void 0:x.y)??0)-(((p=P.position)==null?void 0:p.y)??0))}}).sort((a,y)=>(a.dx>=0&&y.dx>=0,a.dx-y.dx||a.dy-y.dy))[0])==null?void 0:I.a)==null?void 0:G.id)||N[0].id;else{const g=c.findIndex(a=>a.id===j);O=((m=c[g+1])==null?void 0:m.id)||""}if(!O)return;U(g=>g.some(y=>y.source===j&&y.target===O)?g:[...g,{id:`e-${Date.now()}`,source:j,target:O}]);const v=re||String((s==null?void 0:s.content)||"");fe(g=>g.map(a=>{if(a.id!==O)return a;const y=a.data||{};return a.type==="agent"?{...a,data:{...y,config:{...y.config||{},prompt:v}}}:a.type==="midjourney"?{...a,data:{...y,prompt:v}}:a.type==="aiImage"?{...a,data:{...y,config:{...y.config||{},prompt:v}}}:a.type==="textPreview"?{...a,data:{...y,content:v}}:{...a,data:{...y,config:{...y.config||{},prompt:v}}}}))}catch{}},pe=(s.title||"")==="åˆ†é•œè®¾è®¡",de=(s.title||"")==="æç¤ºè¯",me=(()=>{if(!pe)return[];const I=String(s.content||""),G=I.split(/\r?\n/).map(N=>N.trim()),m=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),c=[];let S=null;for(const N of G){if(!N)continue;const O=N.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(O&&m.has(O[1])){S&&c.push(S),S={label:O[1],content:O[2]||""};continue}if(m.has(N)){S&&c.push(S),S={label:N,content:""};continue}S?S.content=S.content?`${S.content}
${N}`:N:S={label:"æ–‡æœ¬",content:N}}if(S&&c.push(S),c.length===0)return[{label:"æ–‡æœ¬",content:I}];const P=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],$=new Map(P.map((N,O)=>[N,O]));return c.filter(N=>N.content&&N.content.trim().length>0).sort((N,O)=>($.get(N.label)??999)-($.get(O.label)??999))})(),[Ee,Z]=t.useState(me),z=t.useRef(null),A=t.useRef([]);return t.useEffect(()=>{Z(me)},[s.content,pe]),t.useEffect(()=>{requestAnimationFrame(()=>{A.current.forEach(I=>{I&&(I.style.height="auto",I.style.height=`${I.scrollHeight}px`)})})},[Ee]),t.useEffect(()=>{de&&K(s.content||"")},[s.content,de]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:pe?e.jsx("div",{ref:he,className:"space-y-2 nowheel",children:Ee.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):Ee.map((I,G)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:I.label}),e.jsx("textarea",{value:I.content,onChange:m=>{const c=m.target.value;m.target.style.height="auto",m.target.style.height=`${m.target.scrollHeight}px`,Z(S=>{const P=S.map((O,r)=>r===G?{...O,content:c}:O),$=P.map(O=>`${O.label}ï¼š${O.content}`).join(`
`);return Q(j)&&fe(O=>O.map(r=>r.id===j?{...r,data:{...r.data,content:$}}:r)),z.current&&(clearTimeout(z.current),z.current=null),z.current=window.setTimeout(async()=>{const O=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};P.forEach(v=>{O.has(v.label)&&(r[v.label]=v.content)}),await je(r)},600),P})},onBlur:async m=>{const c=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),S={};S[I.label]=m.currentTarget.value,c.has(I.label)&&await je(S)},onMouseDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),ref:m=>{A.current[G]=m,m&&(m.style.height="auto",m.style.height=`${m.scrollHeight}px`,m.style.overflow="hidden",m.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",placeholder:`å¡«å†™${I.label}...`})]},`sec-${G}`))}):de?e.jsxs("div",{ref:Ue,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:re,onChange:I=>{const G=I.target.value;K(G);const m=440;I.target.style.height="auto";const c=Math.min(I.target.scrollHeight,m);I.target.style.height=`${c}px`,I.target.style.overflowY=I.target.scrollHeight>m?"auto":"hidden",Q(j)&&fe(P=>P.map($=>$.id===j?{...$,data:{...$.data,content:G}}:$)),ae.current&&(clearTimeout(ae.current),ae.current=null),ae.current=window.setTimeout(async()=>{await je({æç¤ºè¯:G})},600)},onBlur:async I=>{const G=I.currentTarget.value;await je({æç¤ºè¯:G})},onMouseDown:I=>I.stopPropagation(),onTouchStart:I=>I.stopPropagation(),ref:I=>{if(ce.current=I,I){I.style.wordBreak="break-word",I.style.height="auto";const m=Math.min(I.scrollHeight,440);I.style.height=`${m}px`,I.style.overflowY=I.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ne,onPointerDown:I=>I.stopPropagation(),onMouseDown:I=>I.stopPropagation(),disabled:!re.trim(),className:"nodrag relative w-full mt-2 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:te,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(St,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(St,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Io=t.memo(jo),So=({data:s,selected:j,id:n})=>{const{setNodes:F,setEdges:ye,getNode:U,getNodes:fe,getEdges:Q,getViewport:re}=Zt(),K=zs(),ce=Ds(),[Ue]=t.useState(s.isExpanded??!0),[he,te]=t.useState(s.prompt||""),[ae,je]=t.useState(s.ratio||"16:9"),[ne,pe]=t.useState(s.mode||"relax"),[de,me]=t.useState(s.chaos??0),[Ee,Z]=t.useState(s.stylize??100),[z,A]=t.useState(s.weird??0),[I,G]=t.useState(s.quality??1),[m,c]=t.useState(s.styleRaw??!1),[S,P]=t.useState(s.omniWeight??100),[$,N]=t.useState(s.styleWeight??100),[,O]=t.useState(s.taskId||""),[r,v]=t.useState(s.status||"idle"),[g,a]=t.useState(s.progress||""),[y,d]=t.useState(s.omniReferenceImages||[]),[x,p]=t.useState(s.styleReferenceImages||[]),[w,R]=t.useState(!0);t.useEffect(()=>{(async()=>{var b;try{const q=await Ce.midjourney.getSettings();R(((b=q.settings)==null?void 0:b.fastEnabled)??!0)}catch{}})()},[]);const{credits:W,isFreeUsage:_,freeUsageRemaining:h,refetch:l}=Us({moduleType:"midjourney",operationType:"imagine",mode:ne}),i=t.useRef(null),B=t.useRef(!1),M=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==he&&te(s.prompt)},[s.prompt]);const X=E=>{F(b=>b.map(q=>q.id===n?{...q,data:{...q.data,...E}}:q))};t.useEffect(()=>{const E=s.taskId,b=s.status;(async()=>{var ue,H;if(E&&(b==="processing"||b==="submitting"))try{const Ie=(await Ce.midjourney.fetchTask(E)).task;if(Ie.status==="SUCCESS"){const Ne=Ie.imageUrl||"",Re=((ue=Ie.properties)==null?void 0:ue.messageId)||"",Ae=((H=Ie.properties)==null?void 0:H.messageHash)||"",_e=s.ratio||"16:9";if(v("idle"),a(""),X({status:"idle",progress:"",taskId:""}),fe().find(Ge=>{var Qe,Wt,Ct;return Ge.type==="imagePreview"&&((Qe=Ge.data.midjourneyData)==null?void 0:Qe.sourceNodeId)===n&&(((Wt=Ge.data.midjourneyData)==null?void 0:Wt.taskId)===E||Re&&((Ct=Ge.data.midjourneyData)==null?void 0:Ct.messageId)===Re)})){f.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}f.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(Ne,"4å®«æ ¼",_e,{taskId:E,messageId:Re,messageHash:Ae,mode:s.mode||"relax",buttons:Ie.buttons,action:Ie.action})}else Ie.status==="IN_PROGRESS"||Ie.status==="SUBMITTED"?(v("processing"),setTimeout(()=>{M.current(E)},100)):Ie.status==="FAILURE"?(v("error"),a(""),X({status:"error",progress:"",taskId:""}),f.error(Ie.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Ie.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Ie.status==="NOT_FOUND"&&(v("idle"),a(""),X({status:"idle",progress:"",taskId:""}))}catch{v("idle"),a(""),X({status:"idle",progress:"",taskId:""}),f.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const V=t.useCallback(()=>{const E=K.filter(Ne=>Ne.target===n),b=[],q=[];let ue="";E.forEach(Ne=>{var Ae,_e,$e,le,Ge,Qe,Wt,Ct;const Re=U(Ne.source);if(Re){const _t=Re.data,ct=Ne.targetHandle||"omni-ref";if(ct==="text-input"){if(Re.type==="agent"){const gt=((Ae=_t.config)==null?void 0:Ae.generatedText)||"";gt&&typeof gt=="string"&&(ue=gt)}}else{let gt=_t.imageUrl||"";if(!gt&&((_e=_t.config)!=null&&_e.selectedAsset)){const vt=_t.config.selectedAsset;vt.type==="IMAGE"&&(gt=`https://api.waule.com${vt.url}`.replace(".oss-oss-",".oss-"))}if(!gt&&(($e=_t.config)!=null&&$e.generatedImageUrl)&&(gt=_t.config.generatedImageUrl),Re.type==="assetSelector"){const vt="https://api.waule.com",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},Ye=(le=_t.config)==null?void 0:le.subjects,yt=(Ge=_t.config)==null?void 0:Ge.referenceImages;if(ct==="omni-ref"){let Be="";Ye&&Ye.length>0&&Ye[0].images&&Ye[0].images.length>0?Be=it(Ye[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Qe=_t.config)!=null&&Qe.selectedAsset&&_t.config.selectedAsset.type==="IMAGE"&&(Be=it(_t.config.selectedAsset.url)),Be&&!b.includes(Be)&&b.length<1&&b.push(Be)}else if(ct==="style-ref"){let Be="";Ye&&Ye.length>0&&Ye[0].images&&Ye[0].images.length>0?Be=it(Ye[0].images[0]):yt&&yt.length>0?Be=it(yt[0].url):(Wt=_t.config)!=null&&Wt.selectedAsset&&_t.config.selectedAsset.type==="IMAGE"&&(Be=it(_t.config.selectedAsset.url)),Be&&!q.includes(Be)&&q.length<1&&q.push(Be)}}if(Re.type==="upload"){const vt="https://api.waule.com",it=Be=>{let wt=Be||"";return wt&&(!wt.startsWith("http")&&!wt.startsWith("data:")&&(wt=`${vt}${wt}`),wt=wt.replace(".oss-oss-",".oss-"),wt.replace(/^https?:\/\/localhost(?::\d+)?/i,vt))},yt=(((Ct=_t.config)==null?void 0:Ct.uploadedFiles)||[]).find(Be=>Be.type==="IMAGE"||(Be.mimeType||"").startsWith("image/"));if(yt){const Be=it(yt.url);ct==="omni-ref"?Be&&!b.includes(Be)&&b.length<1&&b.push(Be):ct==="style-ref"&&Be&&!q.includes(Be)&&q.length<1&&q.push(Be)}}gt&&(ct==="omni-ref"&&!b.includes(gt)?b.push(gt):ct==="style-ref"&&!q.includes(gt)&&q.push(gt))}}}),ue&&ue!==he&&!B.current&&(te(ue),X({prompt:ue}));const H=Ne=>{if(!Ne||typeof Ne!="string")return!1;const Re=Ne.trim();return Re?!!(Re.startsWith("data:image/")||/^https?:\/\//.test(Re)||Re.startsWith("/")):!1},ge=b.filter(H).slice(0,1),Ie=q.filter(H).slice(0,1);JSON.stringify(ge)!==JSON.stringify(y)&&(d(ge),X({omniReferenceImages:ge})),JSON.stringify(Ie)!==JSON.stringify(x)&&(p(Ie),X({styleReferenceImages:Ie}))},[K,n,U,ce,he,B.current]);t.useEffect(()=>{V()},[V]),t.useEffect(()=>{const E=i.current;E&&Ue&&requestAnimationFrame(()=>{E.style.height="auto";const b=Math.max(60,Math.min(E.scrollHeight,600));E.style.height=`${b}px`})},[he,Ue]);const ie=E=>{try{const b=new URL(E),q=new URLSearchParams(b.search);return q.has("width")||q.has("height")?(q.delete("width"),q.delete("height"),b.search=q.toString(),b.toString()):E}catch{return E}},xe=E=>{const[q,ue]=E.split(":").map(Number);if(!q||!ue)return{width:512,height:512};const H=q/ue;return H>=1?{width:512,height:Math.round(512/H)}:{width:Math.round(512*H),height:512}},oe=t.useCallback((E,b,q,ue)=>{const H=U(n);if(!H)return;const ge=b.startsWith("U")?ie(E):E,Ie=fe(),Ne=Q();if(Ie.filter(Be=>Be.type==="imagePreview"&&Ne.some(wt=>wt.source===n&&wt.target===Be.id)).find(Be=>Be.data.imageUrl===ge))return;const _e=400,$e=200,le=100,Ge=Be=>{const wt=re().zoom||1,Yt=document.querySelector(`.react-flow__node[data-id="${Be.id}"]`),vs=(Yt==null?void 0:Yt.getBoundingClientRect().width)||Be.data&&Be.data.width||400,Is=(Yt==null?void 0:Yt.getBoundingClientRect().height)||Be.data&&Be.data.height||300,Ss=Math.round(vs/wt),Ns=Math.round(Is/wt);return{w:Ss,h:Ns}},Qe=(Be,wt=300)=>{if(!Be||!/^[0-9]+\s*:\s*[0-9]+$/.test(Be))return wt;const[Yt,vs]=Be.split(":").map(Is=>parseFloat(Is));return!Yt||!vs?wt:Math.round(_e*(vs/Yt))},Wt=Ge(H),Ct=Qe(q,300),_t=H.position.x+Wt.w+$e,ct=H.position.y,gt=fe().filter(Be=>{var wt,Yt;return Be.type==="imagePreview"&&((Yt=(wt=Be.data)==null?void 0:wt.midjourneyData)==null?void 0:Yt.sourceNodeId)===n}).length,vt=_t,it=ct+gt*(Ct+le),Ye=`preview-${Date.now()}`,yt={id:Ye,type:"imagePreview",position:{x:vt,y:it},data:{imageUrl:ge,width:_e,ratio:q,workflowContext:H.data.workflowContext,createdBy:H.data.createdBy,midjourneyData:ue?{taskId:ue.taskId,messageId:ue.messageId,messageHash:ue.messageHash,sourceNodeId:n,mode:ue.mode,buttons:ue.buttons,action:ue.action}:void 0}};F(Be=>[...Be,yt]),ye(Be=>[...Be,{id:`${n}-${Ye}`,source:n,target:Ye,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),f.success(`âœ¨ å·²åˆ›å»º${b}é¢„è§ˆèŠ‚ç‚¹`)},[n,U,fe,Q,F,ye,ie,xe]),k=t.useCallback(async()=>{var E,b,q,ue,H,ge,Ie,Ne,Re,Ae,_e,$e;if(!he.trim()){f.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}v("submitting"),a(""),X({status:"submitting",progress:""});try{const le=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Ge=he.toLowerCase(),Qe=le.find(it=>Ge.includes(it));if(Qe){f.error(`æ£€æµ‹åˆ°å‚æ•° "${Qe}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),v("idle"),X({status:"idle",progress:"",taskId:""});return}v("submitting");let Wt=he;try{f.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const it=await Ce.translation.smartTranslate({text:he});it.success&&(Wt=it.translatedText,it.needsTranslation&&f.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{f.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}f.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let Ct=Wt.trim();if(ae&&ae!=="1:1"&&!Ct.includes("--ar")&&(Ct+=` --ar ${ae}`),!Ct.includes("--v")&&!Ct.includes("--version")&&(Ct+=" --v 7.0"),ne==="fast"&&!Ct.includes("--fast")?Ct+=" --fast":ne==="relax"&&!Ct.includes("--relax")&&(Ct+=" --relax"),de>0&&(Ct+=` --chaos ${de}`),Ee!==100&&(Ct+=` --stylize ${Ee}`),z>0&&(Ct+=` --weird ${z}`),I!==1&&(Ct+=` --quality ${I}`),m&&(Ct+=" --style raw"),y.length>0){f.info(`æ­£åœ¨ä¸Šä¼  ${y.length} å¼ å‚è€ƒå›¾...`);const it=[];for(let Ye=0;Ye<y.length;Ye++){const yt=y[Ye];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{f.error(`å‚è€ƒå›¾ ${Ye+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),v("idle");return}}Ct+=` --oref ${it.join(" ")}`,S!==100&&(Ct+=` --ow ${S}`),f.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(x.length>0){f.info(`æ­£åœ¨ä¸Šä¼  ${x.length} å¼ é£æ ¼å›¾...`);const it=[];for(let Ye=0;Ye<x.length;Ye++){const yt=x[Ye];try{const Be=await Ce.midjourney.uploadReferenceImage({imageUrl:yt});if(Be.success&&Be.discordUrl)it.push(Be.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{f.error(`é£æ ¼å›¾ ${Ye+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),v("idle");return}}Ct+=` --sref ${it.join(" ")}`,$!==100&&(Ct+=` --sw ${$}`),f.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const _t=await Ce.midjourney.imagine({prompt:Ct,nodeId:n,mode:ne});if(!_t.success)throw new Error(_t.description||"ä»»åŠ¡æäº¤å¤±è´¥");const ct=_t.taskId;O(ct),v("processing"),X({taskId:ct,status:"processing",progress:"",prompt:he,ratio:ae,mode:ne,chaos:de,stylize:Ee,weird:z,quality:I,styleRaw:m,omniWeight:S,styleWeight:$});const gt=_t.isFreeUsage,vt=_t.creditsCharged||0;if(gt)f.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${h} æ¬¡æœºä¼š`),l();else if(vt>0){const{useAuthStore:it}=await xs(async()=>{const{useAuthStore:yt}=await import("./index-DRJ_08Rm.js").then(Be=>Be.f);return{useAuthStore:yt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ye}=it.getState();await Ye(),f.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${vt} ç§¯åˆ†`),l()}else f.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");M.current(ct)}catch(le){if(v("error"),a(""),X({status:"error",progress:"",taskId:""}),((E=le.response)==null?void 0:E.status)===403){const Wt=((q=(b=le.response)==null?void 0:b.data)==null?void 0:q.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";f.error(Wt);return}if(((ue=le.response)==null?void 0:ue.status)===429){f.warning(((ge=(H=le.response)==null?void 0:H.data)==null?void 0:ge.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Ge=((Ne=(Ie=le.response)==null?void 0:Ie.data)==null?void 0:Ne.description)||((Ae=(Re=le.response)==null?void 0:Re.data)==null?void 0:Ae.error)||le.message,Qe=($e=(_e=le.response)==null?void 0:_e.data)==null?void 0:$e.bannedWord;Qe?f.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${Qe}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):f.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Ge}ï¼Œè¯·ç¨åé‡è¯•`)}},[he,ae,ne,de,Ee,z,I,m,y,S,x,$,X,_,h,l]),u=t.useCallback(async E=>{let b=0;const q=150,ue=2e3,H=async()=>{var ge,Ie,Ne,Re;try{const _e=(await Ce.midjourney.fetchTask(E)).task;if(_e.status==="SUCCESS"){const le=_e.imageUrl||"",Ge=((ge=_e.properties)==null?void 0:ge.messageId)||"",Qe=((Ie=_e.properties)==null?void 0:Ie.messageHash)||"";if(v("idle"),a(""),X({status:"idle",taskId:"",progress:""}),fe().find(_t=>{var ct,gt,vt;return _t.type==="imagePreview"&&((ct=_t.data.midjourneyData)==null?void 0:ct.sourceNodeId)===n&&(((gt=_t.data.midjourneyData)==null?void 0:gt.taskId)===E||Ge&&((vt=_t.data.midjourneyData)==null?void 0:vt.messageId)===Ge)})){f.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}f.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),oe(le,"4å®«æ ¼",ae,{taskId:E,messageId:Ge,messageHash:Qe,mode:ne,buttons:_e.buttons,action:_e.action});return}const $e=_e.progress||"";if(a($e),(_e.status==="IN_PROGRESS"||_e.status==="SUBMITTED")&&(v("processing"),X({status:"processing",progress:$e})),_e.status==="FAILURE"){v("error"),a(""),X({status:"error",progress:"",taskId:""}),f.error(_e.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${_e.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(_e.status==="NOT_FOUND"){v("error"),a(""),X({status:"error",progress:"",taskId:""}),f.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}b++,b<q?setTimeout(H,ue):(v("error"),a(""),X({status:"error",progress:"",taskId:""}),f.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(Ae){if((Ae.code==="ECONNABORTED"||Ae.code==="ERR_NETWORK"||((Ne=Ae.message)==null?void 0:Ne.includes("aborted"))||((Re=Ae.message)==null?void 0:Re.includes("Network Error")))&&b<q-1){b++,setTimeout(H,ue*2);return}v("error"),a(""),X({status:"error",progress:"",taskId:""}),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};H()},[n,ae,oe,X,fe]);return M.current=u,e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Ue&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:i,value:he,onChange:E=>{B.current=!0,te(E.target.value)},onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>pe("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ne==="relax"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"} disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!w){f.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}pe("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${w?ne==="fast"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50":"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:cursor-not-allowed`,title:w?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!w&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(os,{value:ae,onChange:E=>je(E),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:de})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:de,onChange:E=>me(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${de/2}%, #06b6d4 ${de}%, var(--range-bg-color) ${de}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:Ee})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:Ee,onChange:E=>Z(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${Ee/1e3*50}%, #06b6d4 ${Ee/1e3*100}%, var(--range-bg-color) ${Ee/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:z})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:z,onChange:E=>A(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${z/3e3*50}%, #06b6d4 ${z/3e3*100}%, var(--range-bg-color) ${z/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:I})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:I===.25?0:I===.5?1:I===1?2:3,onChange:E=>{const b=Number(E.target.value);G(b===0?.25:b===1?.5:b===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${(I===.25?0:I===.5?1:I===1?2:3)/3*50}%, #06b6d4 ${(I===.25?0:I===.5?1:I===1?2:3)/3*100}%, var(--range-bg-color) ${(I===.25?0:I===.5?1:I===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>c(!m),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:cursor-not-allowed ${m?"bg-neutral-800 dark:bg-white text-white dark:text-black border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-neutral-500 dark:border-neutral-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${m?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-neutral-800 dark:bg-white text-white dark:text-black"}`})})]})})]}),y.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Dr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",y.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:y.map((E,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Reference ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:S})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:S,onChange:E=>P(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${S/1e3*50}%, #06b6d4 ${S/1e3*100}%, var(--range-bg-color) ${S/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),x.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Dr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",x.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:x.map((E,b)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:E,alt:`Style ${b+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",b+1]})})]},b))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:$})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:$,onChange:E=>N(Number(E.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #404040 0%, #525252 ${$/1e3*50}%, #06b6d4 ${$/1e3*100}%, var(--range-bg-color) ${$/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:k,onPointerDown:E=>E.stopPropagation(),onMouseDown:E=>E.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1||!(he!=null&&he.trim()),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 relative overflow-hidden ${r==="processing"||r==="submitting"||!(he!=null&&he.trim())?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:[r==="processing"&&g&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-neutral-400/30 to-accent-400/30 transition-all duration-300",style:{width:g}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!g||g===""||g==="0%"?ne==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${g}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(fr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),_?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(h),"æ¬¡"]}):W!==null&&W>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:[W,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(us,{type:"target",position:ut.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>{const b=U(E.source||"");return!!b&&b.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(us,{type:"target",position:ut.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!K.some(q=>q.target===n&&q.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(us,{type:"target",position:ut.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:E=>!K.some(q=>q.target===n&&q.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(us,{type:"source",position:ut.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},wr="https://api.waule.com",Eo=({data:s,selected:j,id:n})=>{var bs,er,ws,tr,sr,rr,Ls;const[F,ye]=t.useState(!0),[,U]=t.useState(0),[fe,Q]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[fe]);const{setNodes:re,setEdges:K,getNode:ce,getNodes:Ue,getEdges:he}=Zt(),te=zs(),ae=Ds(),je=t.useRef(""),ne=(bs=s.config)==null?void 0:bs.selectedEditingCapability,pe=t.useMemo(()=>(s.models||[]).filter(se=>{var Me;return se.type==="VIDEO_GENERATION"&&((Me=se.provider)==null?void 0:Me.toLowerCase())==="sora"}),[s.models]),[de,me]=t.useState(s.config.prompt||""),Ee=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==de&&me(s.config.prompt)},[s.config.prompt]);const[Z,z]=t.useState(s.config.modelId||((er=pe[0])==null?void 0:er.id)||""),[A,I]=t.useState(s.config.ratio||"16:9"),[G,m]=t.useState(s.config.resolution||"1080P"),c=t.useCallback(Y=>{const se=(Y||"").toLowerCase();return se?se.includes("æ–‡ç”Ÿ")||se.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":se.includes("é¦–å°¾")?"é¦–å°¾å¸§":se.includes("é¦–å¸§")||se.includes("first frame")||se.includes("start frame")||se.includes("initial frame")||se.includes("keyframe")?"é¦–å¸§":se.includes("å°¾å¸§")||se.includes("last frame")||se.includes("end frame")||se.includes("final frame")?"å°¾å¸§":se.includes("ä¸»ä½“å‚è€ƒ")||se.includes("å‚è€ƒ")||se.includes("reference image")||se.includes("image reference")||se.includes("ref image")?"å‚è€ƒå›¾":se.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":se.includes("first-last")||se.includes("two-frame")||se.includes("frame pair")?"é¦–å°¾å¸§":se.includes("first")?"é¦–å¸§":se.includes("last")?"å°¾å¸§":se.includes("subject")||se.includes("reference")?"å‚è€ƒå›¾":Y||"":""},[]),[S,P]=t.useState((s.config.lockedGenerationType?c(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[$,N]=t.useState(s.config.duration||10),[O,r]=t.useState(s.config.isGenerating||!1),[v,g]=t.useState([]),[a,y]=t.useState(null),[d,x]=t.useState(!1),[p]=t.useState(""),[w]=t.useState("confirm"),[R]=t.useState(null),[W,_]=t.useState(!1),[h,l]=t.useState([]),[i,B]=t.useState(""),[M,X]=t.useState(0),[V,ie]=t.useState(0),xe=t.useRef(!1),[oe,k]=t.useState(!1),u=pe.find(Y=>Y.id===Z)||pe[0],{credits:E,loading:b,isFreeUsage:q,freeUsageRemaining:ue,refetch:H}=Us({aiModelId:u==null?void 0:u.id,duration:$,resolution:G});t.useEffect(()=>{var Y,se;if(!pe.find(Me=>Me.id===Z)){const Me=((Y=pe[0])==null?void 0:Y.id)||"";z(Me),Qe({modelId:Me,modelName:(se=pe[0])==null?void 0:se.name})}},[pe]);const ge=((ws=u==null?void 0:u.provider)==null?void 0:ws.toLowerCase())==="sora",Ie=t.useMemo(()=>{var se;if((se=u==null?void 0:u.config.supportedDurations)!=null&&se.length)return u.config.supportedDurations;const Y=((u==null?void 0:u.provider)||"").toLowerCase();return Y==="sora"?[10,15]:Y==="minimaxi"?[6,10]:[$||10]},[u,$]),Ne=t.useMemo(()=>{var se;return(se=u==null?void 0:u.config.supportedResolutions)!=null&&se.length?u.config.supportedResolutions:((u==null?void 0:u.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[u]),Re=t.useMemo(()=>Math.min(...Ie),[Ie]),Ae=t.useMemo(()=>Math.max(...Ie),[Ie]),_e=t.useMemo(()=>Math.max(1,Ae-Re),[Ae,Re]),$e=t.useMemo(()=>{const Y=($-Re)/_e*100;return Number.isNaN(Y)?0:Math.min(100,Math.max(0,Y))},[$,Re,_e]),le=!u||!((tr=u.config.supportedDurations)!=null&&tr.length),Ge=!u||!((sr=u.config.supportedResolutions)!=null&&sr.length),Qe=t.useCallback(Y=>{ce(n)&&re(Me=>Me.map(Ve=>Ve.id===n?{...Ve,data:{...Ve.data,config:{...Ve.data.config,...Y}}}:Ve))},[ce,n,re]),Wt=(Y,se)=>{const Me=(T,L)=>L===0?T:Me(L,T%L),Ve=Me(Y,se),qe=Y/Ve,Oe=se/Ve,tt={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},bt=`${qe}:${Oe}`;return tt[bt]||bt},Ct=()=>{const Y=te.filter(Oe=>Oe.target===n),se=[];Y.forEach(Oe=>{var bt;const tt=ce(Oe.source);if(tt&&tt.type==="upload"&&(((bt=tt.data.config)==null?void 0:bt.uploadedFiles)||[]).forEach(L=>{const be=L.type||L.mimeType||"";(be==="IMAGE"||be.startsWith("image/"))&&se.push({id:L.id||L.name,url:L.url,name:L.name||L.originalName,width:L.width,height:L.height,aspectRatio:L.width&&L.height?Wt(L.width,L.height):"16:9"})}),tt&&tt.type==="assetSelector"){const T=tt.data.config||{},L=T.subjects,be=T.selectedAsset,Te=c(S);L&&L.length>0?Te==="é¦–å°¾å¸§"||(L[0].images||[]).forEach((we,et)=>{se.push({id:`${tt.id}-subject-${et}`,url:we,name:L[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):be&&be.type==="IMAGE"&&se.push({id:be.id,url:be.url,name:be.name||be.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(tt&&tt.type==="imagePreview"){const T=tt.data.imageUrl,L=tt.data.width,be=tt.data.height;T&&se.push({id:tt.id,url:T,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:L,height:be,aspectRatio:L&&be?Wt(L,be):"16:9"})}});const Me=new Set,Ve=[];se.forEach(Oe=>{const tt=Oe.url;Me.has(tt)||(Me.add(tt),Ve.push(Oe))});const qe=c(S);return qe==="æ–‡ç”Ÿè§†é¢‘"?ge?Ve:[]:qe==="é¦–å¸§"||qe==="å°¾å¸§"?Ve.slice(0,1):qe==="é¦–å°¾å¸§"?Ve.slice(0,2):qe==="å‚è€ƒå›¾"?Ve.slice(0,7):Ve},_t=t.useMemo(()=>Ct(),[te,ae,S,n,ge]);t.useEffect(()=>{const Y=s.config.taskId;(async()=>{if(Y){try{const Ve=(await Ce.tasks.getTaskStatus(Y)).task;if(Ve.status==="SUCCESS"){r(!1),U(100);const qe=Ve.resultUrl;if(!qe){r(!1),U(0),Qe({taskId:"",isGenerating:!1}),Q(""),f.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const Oe=s.config.ratio||"16:9";Qe({taskId:"",isGenerating:!1}),Q("");const tt=Ue(),bt=he();if(tt.filter(be=>be.type==="videoPreview"&&bt.some(Te=>Te.source===n&&Te.target===be.id)).find(be=>be.data.videoUrl===qe)){setTimeout(()=>U(0),1e3);return}f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼");try{const be=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(be).some(we=>we.taskId&&we.taskId===Y||we.sourceNodeId&&we.sourceNodeId===n)||Tt(qe,Oe)}catch{Tt(qe,Oe)}setTimeout(()=>U(0),1e3)}else if(Ve.status==="PROCESSING"||Ve.status==="PENDING"){r(!0),U(Ve.progress||0),Qs(Y);return}else Ve.status==="FAILURE"&&(r(!1),U(0),Qe({taskId:"",isGenerating:!1}),Q(""),f.error(`ç”Ÿæˆå¤±è´¥: ${Ve.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{r(!1),U(0),Qe({taskId:"",isGenerating:!1}),Q("")}return}try{const Me=await Ce.tasks.getPendingPreviewNodes(n);if(Me.tasks&&Me.tasks.length>0)for(const Ve of Me.tasks){const{previewNodeData:qe}=Ve;if(qe&&qe.url){const Oe=qe.ratio||s.config.ratio||"16:9";let tt=!1;try{const bt=localStorage.getItem("suppressedPreviewTasks")||"[]";tt=JSON.parse(bt).some(L=>L.taskId&&L.taskId===Ve.id||L.sourceNodeId&&L.sourceNodeId===n)}catch{}tt||(Tt(qe.url,Oe),f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")),await Ce.tasks.markPreviewNodeCreated(Ve.id)}}}catch{}})()},[]),t.useEffect(()=>{const Y=te.filter(Me=>Me.target===n);let se="";Y.forEach(Me=>{var qe;const Ve=ce(Me.source);if(Ve){const Oe=Ve.data;Ve.type==="agent"&&((qe=Oe.config)!=null&&qe.generatedText)?se||(se=Oe.config.generatedText):Ve.type==="textPreview"&&Oe.content&&(se||(se=Oe.content))}}),se&&se!==de&&(me(se),Qe({prompt:se}))},[te,n,ce,de,Qe]),t.useEffect(()=>{const Y=te.filter(Ve=>Ve.target===n);if(Y.length===0)return;let se="",Me="";Y.forEach(Ve=>{var Oe;const qe=ae.find(tt=>tt.id===Ve.source);if(qe&&qe.type==="agent"){const tt=qe.data;(Oe=tt.config)!=null&&Oe.generatedText&&(se=tt.config.generatedText,Me=`${qe.id}-${tt.config.generatedText.substring(0,50)}`)}}),se&&Me!==je.current&&(je.current=Me,me(se),Qe({prompt:se}))},[ae,te,n,Qe]),t.useEffect(()=>{const Y=JSON.stringify(_t),se=JSON.stringify(v);Y!==se&&g(_t)},[_t]);const ct=t.useMemo(()=>{if(ge)return!0;const Y=v.length,se=c(S);return Y===0?!0:Y===1?se==="å‚è€ƒå›¾":Y===2?se==="é¦–å°¾å¸§"?!1:se==="å‚è€ƒå›¾":Y>2?se==="å‚è€ƒå›¾":!1},[v.length,S,c,ge]),gt=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),vt=t.useMemo(()=>{const Y=c(S);return ne?pe:pe.filter(se=>{var Ve;const Me=(((Ve=se.config)==null?void 0:Ve.supportedGenerationTypes)||[]).map(qe=>c(qe));return Y==="é¦–å¸§"||Y==="å°¾å¸§"?Me.includes("é¦–å¸§")||Me.includes("å°¾å¸§"):Me.includes(Y)})},[pe,S,c,ne]),it=t.useMemo(()=>{const Y=ne?pe:vt;return Y.length>0?Y:ne?(s.models||[]).filter(Me=>(Me.type||"")==="VIDEO_EDITING"):Y},[ne,pe,vt,s.models]);t.useEffect(()=>{var se,Me;if(!it.find(Ve=>Ve.id===Z)){const Ve=((se=it[0])==null?void 0:se.id)||"";z(Ve),Qe({modelId:Ve||void 0,modelName:Ve?(Me=it[0])==null?void 0:Me.name:void 0})}},[it]);const Ye=t.useCallback(Y=>{const se=c(Y);return ne?["IMAGE","VIDEO"]:se==="æ–‡ç”Ÿè§†é¢‘"?ge?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[c,ne,ge]);t.useEffect(()=>{if(!ct&&v.length>0){const Y=v[0].aspectRatio;Y&&A!==Y&&(I(Y),setTimeout(()=>{Qe({ratio:Y})},0))}},[ct,v,A]),t.useEffect(()=>{if(!ne&&gt.length>0&&!gt.includes(S)){const Y="æ–‡ç”Ÿè§†é¢‘";P(Y),setTimeout(()=>{Qe({generationType:Y,acceptedInputs:Ye(Y)})},0)}},[gt,S,Ye,ne]),t.useEffect(()=>{const Y=c(S);if(Y==="æ–‡ç”Ÿè§†é¢‘")return;const se=te.filter(Oe=>Oe.target===n),Me=[],Ve=[];se.forEach(Oe=>{var T,L,be,Te,Se;const tt=ce(Oe.source);if(!tt)return;const bt=tt.type;if((bt||"").startsWith("aiVideo")||bt==="videoPreview"){Ve.push(Oe.id);return}if(bt==="upload"){const we=(be=(L=(T=tt.data)==null?void 0:T.config)==null?void 0:L.uploadedFiles)==null?void 0:be[0],et=((we==null?void 0:we.type)||"").toUpperCase(),st=((we==null?void 0:we.mimeType)||"").toLowerCase();if(et==="VIDEO"||st.startsWith("video/")){Ve.push(Oe.id);return}(et==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id);return}if(bt==="assetSelector"){const we=((Te=tt.data)==null?void 0:Te.config)||{};if(we.selectedAsset){const et=(we.selectedAsset.type||"").toUpperCase(),st=(we.selectedAsset.mimeType||"").toLowerCase();et==="VIDEO"||st.startsWith("video/")?Ve.push(Oe.id):(et==="IMAGE"||st.startsWith("image/"))&&Me.push(Oe.id)}else if(we.subjects&&we.subjects.length>0){const et=(((Se=we.subjects[0])==null?void 0:Se.images)||[]).length;Y==="å‚è€ƒå›¾"||Y==="é¦–å°¾å¸§"?Me.push(Oe.id):(Y==="é¦–å¸§"||Y==="å°¾å¸§")&&(et>1?Ve.push(Oe.id):Me.push(Oe.id))}return}(bt==="aiImage"||bt==="imagePreview")&&Me.push(Oe.id)});let qe=new Set([...Ve]);Y==="é¦–å¸§"||Y==="å°¾å¸§"?Me.slice(1).forEach(Oe=>qe.add(Oe)):Y==="é¦–å°¾å¸§"&&Me.slice(2).forEach(Oe=>qe.add(Oe)),qe.size>0&&K(Oe=>Oe.filter(tt=>!qe.has(tt.id)))},[S,te,n,ce,K,c]),t.useEffect(()=>{const Y=s.config.generationType;if(!Y||c(Y)!==c(S)){const se=c(S)||"æ–‡ç”Ÿè§†é¢‘";Qe({generationType:se,acceptedInputs:Ye(se)})}},[]),t.useEffect(()=>{const Y=Ye(S);Qe({acceptedInputs:Y})},[S,Ye]);const yt=Y=>{y(Y)},Be=Y=>{Y.preventDefault()},wt=Y=>{if(a===null)return;const se=[...v],[Me]=se.splice(a,1);se.splice(Y,0,Me),g(se),y(null),Qe({referenceImages:se})};t.useEffect(()=>{const Y=Ee.current;Y&&F&&requestAnimationFrame(()=>{Y.style.height="auto";const se=Math.max(60,Math.min(Y.scrollHeight,600));Y.style.height=`${se}px`})},[de,F]),t.useEffect(()=>{if(de===s.config.prompt)return;const Y=setTimeout(()=>{Qe({prompt:de})},500);return()=>clearTimeout(Y)},[de]);const Yt=t.useCallback(async Y=>{if(!Y){l([]);return}try{const se=await Ce.soraCharacters.search(Y,5);l(se.characters||[]),ie(0)}catch{l([])}},[]),vs=t.useCallback(Y=>{const se=Y.target.value,Me=Y.target.selectionStart||0;if(me(se),xe.current)return;const qe=se.substring(0,Me).match(/@([^@\s#]*)$/);if(qe){const Oe=qe[1];B(Oe),X(Me-Oe.length-1),_(!0),Yt(Oe)}else _(!1),l([])},[Yt]),Is=t.useCallback(Y=>{const se=de.substring(0,M),Me=de.substring(M+i.length+1),Ve=`@#${Y.customName}#`,qe=se+Ve+Me;me(qe),_(!1),l([]),B(""),setTimeout(()=>{if(Ee.current){Ee.current.focus();const Oe=se.length+Ve.length;Ee.current.setSelectionRange(Oe,Oe)}},0)},[de,M,i]),Ss=t.useCallback(Y=>{!W||h.length===0||(Y.key==="ArrowDown"?(Y.preventDefault(),ie(se=>se<h.length-1?se+1:se)):Y.key==="ArrowUp"?(Y.preventDefault(),ie(se=>se>0?se-1:se)):Y.key==="Enter"&&h[V]?(Y.preventDefault(),Is(h[V])):Y.key==="Escape"&&_(!1))},[W,h,V,Is]),Ns=t.useCallback(async Y=>{var qe;const se=/@#([^#]+)#/g,Me=[...Y.matchAll(se)];if(Me.length===0)return Y;let Ve=Y;for(const Oe of Me){const tt=Oe[1];try{const bt=await Ce.soraCharacters.getByCustomName(tt);(qe=bt.character)!=null&&qe.characterName&&(Ve=Ve.replace(Oe[0],` ${bt.character.characterName} `))}catch{}}return Ve},[]),Bs=Y=>{var Me,Ve,qe,Oe;z(Y);const se=vt.find(tt=>tt.id===Y);if(se){const tt=(Me=se.config.supportedRatios)!=null&&Me.length?se.config.supportedRatios:["16:9"],bt=(Ve=se.config.supportedResolutions)!=null&&Ve.length?se.config.supportedResolutions:["1080P"],T=(qe=se.config.supportedGenerationTypes)!=null&&qe.length?se.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],L=(se.provider||"").toLowerCase(),be=(Oe=se.config.supportedDurations)!=null&&Oe.length?se.config.supportedDurations:L==="sora"?[10,15]:L==="minimaxi"?[6,10]:[10],Te=tt[0],Se=bt[0],we=c(S||T[0]),et=be[0];I(Te),m(Se),P(we),N(et),Qe({modelId:Y,modelName:se.name,ratio:Te,resolution:Se,generationType:we,duration:et,acceptedInputs:Ye(we)})}},hs=t.useMemo(()=>{const Y=c(S),se=v.length,qe=te.filter(Oe=>Oe.target===n).filter(Oe=>{var T,L,be,Te,Se;const tt=ce(Oe.source),bt=tt==null?void 0:tt.type;if(!tt)return!1;if(bt==="upload"){const we=(be=(L=(T=tt.data)==null?void 0:T.config)==null?void 0:L.uploadedFiles)==null?void 0:be[0],et=((we==null?void 0:we.mimeType)||"").toLowerCase();return((we==null?void 0:we.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}if(bt==="assetSelector"){const we=(Se=(Te=tt.data)==null?void 0:Te.config)==null?void 0:Se.selectedAsset,et=((we==null?void 0:we.mimeType)||"").toLowerCase();return((we==null?void 0:we.type)||"").toUpperCase()==="VIDEO"||et.startsWith("video/")}return!!((bt||"").startsWith("aiVideo")||bt==="videoPreview")}).length;return Z?Y==="æ–‡ç”Ÿè§†é¢‘"?ge?!0:!!de.trim():Y==="é¦–å¸§"||Y==="å°¾å¸§"?se>=1:Y==="é¦–å°¾å¸§"?se>=2:Y==="å‚è€ƒå›¾"?se>=1:Y==="è§†é¢‘æ¢äºº"?qe>=1&&se>=1:Y==="å¯¹å£å‹"||Y==="é£æ ¼è½¬æ¢"?qe>=1:!1:!1},[S,v.length,de,O,te,n,ce,c,ge]);t.useEffect(()=>{var se;const Y=(se=s==null?void 0:s.config)==null?void 0:se.generatedVideoUrl;Y&&Tt(Y,s.config.ratio||"16:9")},[(rr=s==null?void 0:s.config)==null?void 0:rr.generatedVideoUrl]);const Qs=async Y=>{let Me=0;const Ve=async()=>{try{Me++;const Oe=(await Ce.tasks.getTaskStatus(Y)).task;if(U(Oe.progress||0),Oe.status==="SUCCESS"||Oe.status==="COMPLETED"||Oe.status==="DONE"){U(100);const tt=Oe.resultUrl;r(!1),Tt(tt,s.config.ratio||"16:9");try{await Ce.tasks.markPreviewNodeCreated(Y)}catch{}Qe({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:tt,taskId:"",isGenerating:!1}),Q(""),f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>U(0),1e3);return}else if(Oe.status==="FAILURE"){r(!1),U(0),Qe({taskId:"",isGenerating:!1}),f.error(Oe.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(Oe.status==="PROCESSING"||Oe.status==="PENDING")&&(Me<600?setTimeout(Ve,1e3):(r(!1),U(0),Qe({taskId:"",isGenerating:!1}),f.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),U(0),Qe({taskId:"",isGenerating:!1}),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ve()},Hs=async()=>{var Me,Ve,qe,Oe,tt,bt;if(c(S)==="æ–‡ç”Ÿè§†é¢‘"&&!de.trim()){f.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const se=Ct();Qe({referenceImages:se}),U(0);try{let T=[],L;const be=se.length;if(se.length>0)try{for(const zt of se){let At=zt.url;!At.startsWith("data:")&&!At.startsWith("http")&&(At=`${wr}${At}`),At=At.replace(/^https?:\/\/localhost(?::\d+)?/i,wr);const Ut=await dr(At);T.push(Ut)}}catch{f.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Te=te.filter(zt=>zt.target===n);if(c(S)==="å‚è€ƒå›¾"){const zt=new Map;for(const At of Te){const Ut=ce(At.source);if((Ut==null?void 0:Ut.type)==="assetSelector"){const Vt=(Me=Ut.data.config)==null?void 0:Me.subjects;if(Vt&&Vt.length>0){for(const Ft of Vt)if(!zt.has(Ft.name)){const ts=(Ft.images||[]).map(rs=>rs.startsWith("http")||rs.startsWith("data:")?rs:`${wr}${rs}`);zt.set(Ft.name,ts)}}}}if(zt.size>0){const At=Array.from(zt.entries());let Ut=0;const Vt=[];for(const[Ft,ts]of At){if(Ut>=7)break;const rs=7-Ut,ys=ts.slice(0,Math.max(0,rs));ys.length>0&&(Vt.push({name:Ft,images:ys}),Ut+=ys.length)}L=Vt,At.some(([,Ft])=>Ft.length>0)&&Ut<At.reduce((Ft,[,ts])=>Ft+ts.length,0)&&f.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const Se=L&&L.length>0?L.reduce((zt,At)=>{var Ut;return zt+(((Ut=At.images)==null?void 0:Ut.length)||0)},0):be;let we=S;if(we==="é¦–å¸§"||we==="å°¾å¸§"){if(Se!==1){f.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),U(0);return}}else if(we==="é¦–å°¾å¸§"){if(Se===1)we="é¦–å¸§";else if(Se!==2){f.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),U(0);return}L&&L.length>0?L=[{...L[0],images:L[0].images.slice(0,2)}]:T=T.slice(0,2)}else if(we==="å‚è€ƒå›¾"||we==="ä¸»ä½“å‚è€ƒ"){if(Se<1){f.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),U(0);return}if(L&&L.length>0){if(L.reduce((At,Ut)=>{var Vt;return At+(((Vt=Ut.images)==null?void 0:Vt.length)||0)},0)>7){let At=7;L=L.map(Ut=>({...Ut,images:Ut.images.slice(0,Math.max(0,At-=Ut.images.length,Ut.images.length))})),At=7,L=L.map(Ut=>{const Vt=Ut.images.slice(0,Math.min(Ut.images.length,At));return At-=Vt.length,{...Ut,images:Vt}}).filter(Ut=>Ut.images.length>0),f.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else T.length>7&&(T=T.slice(0,7),f.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}R==="dropImages"&&(T=[],L=void 0),(c(S)==="é¦–å¸§"||c(S)==="å°¾å¸§")&&R==="useFirstImage"&&T.length>=2&&(T=[T[0]]),c(S)==="é¦–å°¾å¸§"&&R==="useFirstTwoImages"&&T.length>=3&&(T=T.slice(0,2));const et={modelId:Z,ratio:A,duration:$,referenceImages:T.length>0&&!L?T:void 0,generationType:we,sourceNodeId:n,...L?{subjects:L}:{}},st=c(we);let kt=de.trim();if(kt&&kt.includes("@#")&&(kt=await Ns(kt)),!oe&&kt&&(kt="No BGM. "+kt),st==="æ–‡ç”Ÿè§†é¢‘"){if(!kt){f.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),U(0);return}et.prompt=kt}else if(st==="å‚è€ƒå›¾"){if(!kt){f.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),U(0);return}et.prompt=kt}else kt&&(et.prompt=kt);const ht=await Ce.tasks.createVideoTask(et),We=ht.taskId,Dt=ht.creditsCharged||0,Xt=ht.isFreeUsage,Pt=ht.freeUsageRemaining??0;if(Q(We),Qe({prompt:de,ratio:A,resolution:G,generationType:S,duration:$,modelId:Z,taskId:We,isGenerating:!0}),setTimeout(()=>{window.dispatchEvent(new CustomEvent("workflow:save"))},200),Xt)f.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Pt} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),H();else if(Dt>0){const{useAuthStore:zt}=await xs(async()=>{const{useAuthStore:Ut}=await import("./index-DRJ_08Rm.js").then(Vt=>Vt.f);return{useAuthStore:Ut}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:At}=zt.getState();await At(),f.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Dt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),H()}else f.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Qs(We)}catch(T){if(r(!1),U(0),((Ve=T.response)==null?void 0:Ve.status)===403){const L=((Oe=(qe=T.response)==null?void 0:qe.data)==null?void 0:Oe.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";f.error(L)}else{const L=((bt=(tt=T.response)==null?void 0:tt.data)==null?void 0:bt.error)||T.message||"æœªçŸ¥åŸå› ";f.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${L}ï¼Œè¯·ç¨åé‡è¯•`)}}},nr=async()=>{const Y=c(S),se=Ct(),Me=se.length;if((()=>{var Oe;const qe=te.filter(tt=>tt.target===n);for(const tt of qe){const bt=ce(tt.source);if((bt==null?void 0:bt.type)==="assetSelector"){const T=(Oe=bt.data.config)==null?void 0:Oe.subjects;if(T&&T.length>0)return!0}}return!1})()&&(Y==="é¦–å¸§"||Y==="å°¾å¸§"||Y==="é¦–å°¾å¸§")){f.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((Y==="é¦–å¸§"||Y==="å°¾å¸§")&&Me===0){f.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(Y==="é¦–å°¾å¸§"&&Me===0){f.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(Y==="å‚è€ƒå›¾"&&Me===0){f.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(Y==="æ–‡ç”Ÿè§†é¢‘"&&Me>0&&!ge&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((Y==="é¦–å¸§"||Y==="å°¾å¸§")&&Me>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(Y==="é¦–å°¾å¸§"&&Me>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(Y==="æ–‡ç”Ÿè§†é¢‘"&&!de.trim()){f.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!Z){f.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}g(se),Qe({referenceImages:se}),r(!0),U(0),await Hs()},Tt=(Y,se)=>{const Me=ce(n);if(!Me||!Y)return null;const Ve=se||A||"16:9",qe=Ue(),Oe=he(),tt=qe.filter(Vt=>Vt.type==="videoPreview"&&Oe.some(Ft=>Ft.source===n&&Ft.target===Vt.id)),bt=tt.find(Vt=>Vt.data.videoUrl===Y);if(bt)return bt.id;const T=1,L=400,be=(Vt,Ft=300)=>{if(!Vt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Vt))return Ft;const[ts,rs]=Vt.split(":").map(ys=>parseFloat(ys));return!ts||!rs?Ft:Math.round(L*(rs/ts))},Te=document.querySelector(`.react-flow__node[data-id="${n}"]`),Se=Te==null?void 0:Te.getBoundingClientRect(),we=Math.round(((Se==null?void 0:Se.width)||400)/T),et=100,st=200,kt=be(Ve,300),ht=tt.length,We=Me.position.x+we+st,Dt=Me.position.y,Xt=We,Pt=Dt+ht*(kt+et),zt=Date.now(),At={id:`preview-${n}-${zt}`,type:"videoPreview",position:{x:Xt,y:Pt},data:{videoUrl:Y,width:L,ratio:Ve,workflowContext:Me.data.workflowContext,createdBy:Me.data.createdBy}};re(Vt=>[...Vt,At]);const Ut={id:`edge-${n}-${At.id}`,source:n,target:At.id,targetHandle:`${At.id}-target`,type:"aurora"};return K(Vt=>Vt.find(ts=>ts.source===n&&ts.target===At.id)?Vt:[...Vt,Ut]),At.id},Xs=Y=>{const se=Y.target;if(se.tagName==="INPUT"||se.tagName==="TEXTAREA"||se.tagName==="SELECT"||se.tagName==="BUTTON"||se.closest("button")||se.closest("input")||se.closest("textarea")||se.closest("select"))return;const Me=!F;ye(Me),re(Ve=>Ve.map(qe=>qe.id===n?{...qe,data:{...qe.data,isExpanded:Me}}:qe))};return e.jsxs("div",{onDoubleClick:Xs,className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${n}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var L;const Y=((L=ce(n))==null?void 0:L.type)||"",se=c(S),Me=se==="æ–‡ç”Ÿè§†é¢‘"||Y==="aiVideo_t2v",Ve=Y==="aiVideo_i2v_first"||Y==="aiVideo_i2v_last"||se==="é¦–å¸§"||se==="å°¾å¸§",qe=Y==="aiVideo_first_last"||se==="é¦–å°¾å¸§",Oe=Y==="aiVideo_reference"||se==="å‚è€ƒå›¾",tt=te.filter(be=>be.target===n),bt=tt.some(be=>{const Te=ce(be.source);return(Te==null?void 0:Te.type)==="agent"}),T=tt.reduce((be,Te)=>{var et,st,kt,ht;const Se=ce(Te.source),we=(Se==null?void 0:Se.type)||"";if(we==="aiImage"||we==="imagePreview")return be+1;if(we==="upload"){const We=(kt=(st=(et=Se==null?void 0:Se.data)==null?void 0:et.config)==null?void 0:st.uploadedFiles)==null?void 0:kt[0],Dt=((We==null?void 0:We.type)||"").toUpperCase(),Xt=((We==null?void 0:We.mimeType)||"").toLowerCase();return be+(Dt==="IMAGE"||Xt.startsWith("image/")?1:0)}if(we==="assetSelector"){const We=((ht=Se==null?void 0:Se.data)==null?void 0:ht.config)||{};if(We.selectedAsset)return be+((We.selectedAsset.type||"").toUpperCase()==="IMAGE"||(We.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(We.subjects&&We.subjects.length>0)return be+((We.subjects[0].images||[]).length||0)}return be},0);return Me?ge||!bt:Ve?!(bt&&T>=1):qe?!(bt&&T>=2):Oe?!(bt&&T>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:p}),w==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{x(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{x(!1),f.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{x(!1),await Hs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:F?e.jsxs("div",{className:"space-y-3",children:[!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(os,{value:Z,onChange:Y=>Bs(Y),options:vt.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:vt.map(Y=>({value:Y.id,label:Y.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-neutral-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ee,value:de,onChange:vs,onKeyDown:Ss,onCompositionStart:()=>{xe.current=!0},onCompositionEnd:Y=>{xe.current=!1,vs(Y)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),W&&h.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:h.map((Y,se)=>e.jsxs("button",{type:"button",onMouseDown:Me=>{Me.preventDefault(),Me.stopPropagation(),Is(Y)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${se===V?"bg-neutral-100 dark:bg-neutral-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[Y.avatarUrl?e.jsx("img",{src:Y.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-neutral-600 dark:text-neutral-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:Y.customName}),e.jsx("div",{className:"text-[10px] text-neutral-500 dark:text-neutral-400 font-mono truncate",children:Y.characterName})]})]},Y.id))})]})]}),v.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",S==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:v.map((Y,se)=>e.jsxs("div",{draggable:S==="é¦–å°¾å¸§",onDragStart:()=>yt(se),onDragOver:Be,onDrop:()=>wt(se),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${S==="é¦–å°¾å¸§"?"cursor-move":""} ${a===se?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50`,children:[e.jsx("img",{src:`${Y.url.startsWith("http")||Y.url.startsWith("data:")?Y.url:wr+Y.url}`,alt:Y.name,className:"w-full h-full object-cover"}),S==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:se===0?"é¦–":se===1?"å°¾":se+1})]},Y.id))})]}),u&&!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",le?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[$,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:Re,max:Ae,step:"1",value:$,onChange:Y=>{const se=parseInt(Y.target.value,10);N(se),Qe({duration:se})},disabled:le,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-neutral-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-neutral-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #525252 ${$e}%, #3b0764 ${$e}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),u&&ct&&(ge||(((Ls=u==null?void 0:u.config.supportedRatios)==null?void 0:Ls.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),ge?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const Y="landscape",se=$===15?15:10,Me=`sora-video-${Y}-${se}s`,Ve=pe.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||pe[0],qe=(Ve==null?void 0:Ve.id)||"";z(qe),I("16:9"),Qe({modelId:qe,ratio:"16:9",modelName:(Ve==null?void 0:Ve.name)||`Sora Video (Landscape ${se}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${A==="16:9"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const Y="portrait",se=$===15?15:10,Me=`sora-video-${Y}-${se}s`,Ve=pe.find(Oe=>{var tt;return((tt=Oe.modelId)==null?void 0:tt.toLowerCase())===Me})||pe[0],qe=(Ve==null?void 0:Ve.id)||"";z(qe),I("9:16"),Qe({modelId:qe,ratio:"9:16",modelName:(Ve==null?void 0:Ve.name)||`Sora Video (Portrait ${se}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${A==="9:16"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(os,{value:A,onChange:Y=>{I(Y),Qe({ratio:Y})},options:((u==null?void 0:u.config.supportedRatios)||[]).map(Y=>{const[se,Me]=Y.split(":");return{value:Y,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[Y]||`${se}:${Me}`}})})]}),u&&ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const Y=A==="9:16"?"portrait":"landscape",se=`sora-video-${Y}-10s`,Me=pe.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===se})||pe[0],Ve=(Me==null?void 0:Me.id)||"";N(10),z(Ve),Qe({duration:10,modelId:Ve,modelName:(Me==null?void 0:Me.name)||`Sora Video (${Y==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${$===10?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const Y=A==="9:16"?"portrait":"landscape",se=`sora-video-${Y}-15s`,Me=pe.find(qe=>{var Oe;return((Oe=qe.modelId)==null?void 0:Oe.toLowerCase())===se})||pe[0],Ve=(Me==null?void 0:Me.id)||"";N(15),z(Ve),Qe({duration:15,modelId:Ve,modelName:(Me==null?void 0:Me.name)||`Sora Video (${Y==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${$===15?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),u&&ge&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>k(!oe),className:`nodrag relative w-10 h-5 rounded-full transition-all ${oe?"bg-gradient-to-r from-neutral-800 to-neutral-700":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${oe?"left-5":"left-0.5"}`})})]}),u&&!ge&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Ge?"(æœªé…ç½®)":""]}),e.jsx(os,{value:G,onChange:Y=>{m(Y),Qe({resolution:Y})},options:Ne.map(Y=>({value:Y,label:Y})),className:Ge?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:nr,disabled:O||!hs||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${O||!hs?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:O?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!b&&(q?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(ue),"æ¬¡"]}):E!==null&&E>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[E,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:de?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-neutral-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-neutral-300 line-clamp-6 whitespace-pre-wrap break-words",children:de})]}):e.jsx("p",{className:"text-xs text-neutral-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(St,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Co=t.memo(Eo),Vr="https://api.waule.com",Ao=({data:s,selected:j,id:n})=>{var N,O;const[F,ye]=t.useState(!0),[U,fe]=t.useState(s.config.customName||""),[Q,re]=t.useState(!1),[K,ce]=t.useState(0),[Ue,he]=t.useState(s.config.taskId||""),[te,ae]=t.useState(null),{credits:je,loading:ne}=Us({nodeType:"sora_character"}),{setNodes:pe,getNode:de,setEdges:me}=Zt(),Ee=zs(),Z=Ds(),z=t.useCallback(r=>{var a;if(!r)return!1;const v=r.type||"",g=((a=r.data)==null?void 0:a.config)||{};if(v==="upload")return(g.uploadedFiles||g.files||[]).some(d=>(d.mimeType||d.type||"").toLowerCase().startsWith("video/"));if(v==="videoPreview")return!!g.url;if(v==="assetSelector"){const y=g.selectedAsset;return((y==null?void 0:y.mimeType)||"").toLowerCase().startsWith("video/")&&!!(y!=null&&y.url)}return v.startsWith("aiVideo")||v==="soraVideo"?!!g.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=Ee.filter(a=>a.target===n);if(r.length===0)return;const v=[],g=[];for(const a of r){const y=Z.find(d=>d.id===a.source)||de(a.source);z(y)?v.push(a.id):g.push(a.id)}v.length>1&&(g.push(...v.slice(1)),f.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),g.length>0&&(me(a=>a.filter(y=>!g.includes(y.id))),g.length>0&&v.length<=1&&r.some(y=>{const d=Z.find(x=>x.id===y.source)||de(y.source);return!z(d)})&&f.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[Ee,n,Z,de,me,z]);const A=t.useMemo(()=>Ee.filter(v=>v.target===n).map(v=>{var a;const g=Z.find(y=>y.id===v.source);return(a=g==null?void 0:g.data)==null?void 0:a.config}),[Ee,n,Z]),I=t.useMemo(()=>(s.models||[]).filter(v=>{var g;return v.type==="VIDEO_GENERATION"&&((g=v.provider)==null?void 0:g.toLowerCase())==="sora"}),[s.models]),G=((N=I.find(r=>{var v;return(v=r.modelId)==null?void 0:v.includes("landscape-10s")}))==null?void 0:N.id)||((O=I[0])==null?void 0:O.id)||"",m=t.useCallback(r=>{pe(v=>v.map(g=>g.id===n?{...g,data:{...g.data,config:{...g.data.config,...r}}}:g))},[n,pe]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!Q&&(ae({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),fe(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,Q]);const c=t.useMemo(()=>{var v;const r=Ee.filter(g=>g.target===n);for(const g of r){const a=Z.find(x=>x.id===g.source)||de(g.source);if(!a)continue;const y=a.type||"",d=((v=a.data)==null?void 0:v.config)||{};if(y==="upload"){const p=(d.uploadedFiles||d.files||[]).find(w=>(w.mimeType||w.type||"").toLowerCase().startsWith("video/"));if(p!=null&&p.url)return{url:p.url,thumbnail:p.thumbnail||p.url,name:p.name||p.originalName||"è§†é¢‘"}}if(y==="videoPreview"&&d.url)return{url:d.url,thumbnail:d.thumbnail||d.url,name:d.name||"è§†é¢‘"};if(y==="assetSelector"){const x=d.selectedAsset;if(((x==null?void 0:x.mimeType)||"").toLowerCase().startsWith("video/")&&(x!=null&&x.url))return{url:x.url,thumbnail:x.thumbnail||x.url,name:x.name||"è§†é¢‘"}}if((y.startsWith("aiVideo")||y==="soraVideo")&&d.generatedVideoUrl)return{url:d.generatedVideoUrl,thumbnail:d.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[Ee,n,Z,A,de]),S=!!c,P=async r=>{let g=0;const a=async()=>{try{g++;const d=(await Ce.tasks.getTaskStatus(r)).task;if(ce(d.progress||0),d.status==="SUCCESS"||d.status==="COMPLETED"||d.status==="DONE"){re(!1),ce(100);const x=d.metadata||{},p=x.characterName||"",w=x.avatarUrl||d.resultUrl||"";if(!p){f.error("æœªèƒ½è·å–è§’è‰²åç§°"),m({taskId:""}),he("");return}try{const W=(await Ce.soraCharacters.create({customName:U||p,characterName:p,avatarUrl:w,sourceVideoUrl:(c==null?void 0:c.url)||void 0})).character;ae({id:W.id,customName:W.customName,characterName:W.characterName,avatarUrl:W.avatarUrl}),m({customName:W.customName,characterName:W.characterName,avatarUrl:W.avatarUrl,taskId:""}),f.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${W.customName}`)}catch(R){ae({id:"",customName:U||p,characterName:p,avatarUrl:w}),f.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${R.message}`)}he(""),setTimeout(()=>ce(0),1e3);return}else if(d.status==="FAILURE"){re(!1),ce(0),m({taskId:""}),f.error(d.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(d.status==="PROCESSING"||d.status==="PENDING")&&(g<600?setTimeout(a,1e3):(re(!1),ce(0),m({taskId:""}),f.error("åˆ›å»ºè¶…æ—¶")))}catch{re(!1),ce(0),m({taskId:""}),f.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};a()},$=async()=>{var v,g,a,y,d;if(!c){f.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!U.trim()){f.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!G){f.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=c.url;if(!r){f.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const x=await Ce.soraCharacters.getByCustomName(U.trim());if(x!=null&&x.character){f.error(`è‡ªå®šä¹‰åç§°"${U.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}re(!0),ce(5),ae(null);try{const x=await Ce.tasks.createVideoTask({modelId:G,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:n,metadata:{isCharacterCreation:!0,customName:U.trim(),referenceType:"video",nodeType:"sora_character"}}),p=x.taskId,w=x.creditsCharged||0;if(he(p),m({customName:U.trim(),taskId:p}),w>0)try{const{useAuthStore:R}=await xs(async()=>{const{useAuthStore:_}=await import("./index-DRJ_08Rm.js").then(h=>h.f);return{useAuthStore:_}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:W}=R.getState();await W(),f.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${w} ç§¯åˆ†ï¼‰`)}catch{f.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else f.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");P(p)}catch(x){if(re(!1),ce(0),((v=x.response)==null?void 0:v.status)===403){const p=((a=(g=x.response)==null?void 0:g.data)==null?void 0:a.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";f.error(p)}else f.error(`æäº¤å¤±è´¥: ${((d=(y=x.response)==null?void 0:y.data)==null?void 0:d.error)||x.message}`)}};return t.useEffect(()=>{Ue&&!Q&&(re(!0),P(Ue))},[]),e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl rounded-t-2xl",onClick:()=>ye(!F),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${F?"rotate-180":""}`,children:"expand_more"})]})]}),F&&e.jsxs("div",{className:"p-4 space-y-3",children:[c&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${c.url.startsWith("http")||c.url.startsWith("data:")?c.url:Vr+c.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:c.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:U,onChange:r=>fe(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-400/50 transition-colors",disabled:Q})]}),te&&!Q&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[te.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("img",{src:te.avatarUrl.startsWith("http")?te.avatarUrl:`${Vr}${te.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-neutral-400 dark:border-neutral-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:te.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:te.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),Q&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[K,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-neutral-800 to-neutral-700 transition-all duration-300",style:{width:`${K}%`}})})]}),e.jsx("button",{onClick:$,disabled:Q||!S||!U.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${Q||!S||!U.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ne&&je!==null&&je>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[je,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},_o=t.memo(Ao),To=({data:s,id:j,selected:n})=>{const{setNodes:F,getNode:ye}=Zt(),[U,fe]=t.useState(s.config.modelId||""),[Q,re]=t.useState(s.config.voiceId||""),[K,ce]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Ue,he]=t.useState(s.config.status||""),[te,ae]=t.useState(!1),[je,ne]=t.useState([]),[pe]=t.useState(void 0),[de]=t.useState("mp3"),[me]=t.useState(void 0),[Ee]=t.useState(void 0),[Z]=t.useState(void 0),[z]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!U&&fe(s.config.modelId)},[s.config.modelId,U]),t.useEffect(()=>{!Q&&s.config.voiceId&&re(String(s.config.voiceId))},[s.config.voiceId,Q]),t.useEffect(()=>{if(!U){const c=(s.models||[]).filter(S=>S.type==="AUDIO_SYNTHESIS"&&S.isActive)[0];c&&(fe(c.id),I({modelId:c.id}))}},[s.models,U]),t.useEffect(()=>{A()},[]);const A=async()=>{try{const m=await Ce.get("/ai/audio/voices"),c=(m==null?void 0:m.data)??m;ne(Array.isArray(c)?c:[])}catch{}},I=m=>{ye(j)&&F(S=>S.map(P=>P.id===j?{...P,data:{...P.data,config:{...P.data.config,...m}}}:P))},G=async()=>{var P,$,N,O;const m=(Q||s.config.voiceId||"").trim(),c=(K||"").trim();if(!m||!c){f.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let S=U;if(!S){const r=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive);if(r[0])S=r[0].id,fe(S),I({modelId:S});else{f.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}ae(!0);try{if(Ue!=="OK"){let a=0,y=!1;for(;a<12;){a++;try{const d=await Ce.ai.audio.queryVoice({voiceId:m,modelId:S}),x=((P=d.data)==null?void 0:P.status)||d.status;if(he(x),I({status:x}),x==="OK"){y=!0;break}if(x==="UNDEPLOYED")break}catch{}await new Promise(d=>setTimeout(d,2500))}if(!y){f.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),ae(!1);return}}const r=await Ce.ai.audio.synthesize({modelId:S,voiceId:m,text:c,format:de,sampleRate:pe,volume:Ee,rate:me,pitch:Z,output_format:z}),v=(($=r.data)==null?void 0:$.url)||r.url;try{const g=v&&v.startsWith("http")?v:`https://api.waule.com${v}`;let a;g?a=await Ce.assets.proxyDownload(g):a=await(await fetch(v,{mode:"cors"})).arrayBuffer();const y=URL.createObjectURL(new Blob([a],{type:de==="wav"?"audio/wav":"audio/mpeg"}));I({outputUrl:y})}catch{I({outputUrl:v})}f.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const v=((O=(N=r==null?void 0:r.response)==null?void 0:N.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(v)?f.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(v)?f.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):f.error(v)}ae(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:U,onChange:m=>{fe(m),I({modelId:m})},options:(s.models||[]).filter(m=>m.type==="AUDIO_SYNTHESIS"&&m.isActive).map(m=>({value:m.id,label:m.name}))})]}),je.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",je.length,")"]}),e.jsx(os,{value:Q||"",onChange:m=>{re(m),I({voiceId:m})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...je.map(m=>({value:m.voiceId,label:m.prefix||m.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:Q,onChange:m=>{const c=m.target.value;re(c),I({voiceId:c})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:K,onChange:m=>{ce(m.target.value),I({text:m.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:G,disabled:te||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${te?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:te?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Uo=t.memo(To),Ro=({data:s,id:j,selected:n})=>{const{setNodes:F,setEdges:ye,getNode:U}=Zt(),[fe,Q]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.voiceId||""),[ce,Ue]=t.useState(s.config.voiceName||""),[he,te]=t.useState(s.config.cloneAudioUrl||""),[ae,je]=t.useState(s.config.promptAudioUrl||""),[ne,pe]=t.useState(s.config.promptText||""),[de,me]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[Ee,Z]=t.useState(!1);t.useEffect(()=>{const S=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!re||!re.startsWith("Waule")&&!re.startsWith("Aivider")||re.startsWith("minimax-")){const P=S();K(P),G({voiceId:P})}},[re]);const z=Fs(S=>S.edges.filter(P=>P.target===j)),A=Ds(),I=t.useRef("");t.useEffect(()=>{if(!fe){const P=(s.models||[]).filter($=>{if($.type!=="AUDIO_SYNTHESIS"||!$.isActive)return!1;const N=String($.provider||"").toLowerCase();return N.includes("minimaxi")||N.includes("hailuo")||N.includes("æµ·èº")})[0];P&&(Q(P.id),G({modelId:P.id}))}},[s.models,fe]),t.useEffect(()=>{try{const S=z.map(N=>`${N.id}-${N.source}-${N.targetHandle||""}`).sort().join(",");if(S===I.current)return;I.current=S;let P="",$="";for(const N of z){const O=U(N.source);if(!O)continue;const r=O.data||{},v=String(O.type||"").toLowerCase(),a=(()=>{var y,d;if(v==="upload"){const x=(((y=r.config)==null?void 0:y.uploadedFiles)||[]).find(p=>{const w=((p==null?void 0:p.type)||"").toUpperCase(),R=((p==null?void 0:p.mimeType)||"").toLowerCase();return w==="AUDIO"||R.startsWith("audio/")});return x==null?void 0:x.url}if(v==="assetSelector"){const x=(d=r.config)==null?void 0:d.selectedAsset,p=((x==null?void 0:x.type)||"").toUpperCase(),w=((x==null?void 0:x.mimeType)||"").toLowerCase();if(p==="AUDIO"||w.startsWith("audio/"))return x==null?void 0:x.url}return null})();a&&(N.targetHandle===`${j}-target-clone`&&(P=a),N.targetHandle===`${j}-target-prompt`&&($=a))}P!==he&&(te(P),G({cloneAudioUrl:P})),$!==ae&&(je($),G({promptAudioUrl:$}))}catch{}},[z,A,U,j,he,ae]);const G=S=>{F(P=>P.map($=>$.id===j?{...$,data:{...$.data,config:{...$.data.config,...S}}}:$))},m=async()=>{var S,P;if(!re||!ce){f.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await Ce.ai.audio.voices.add({voiceId:re,prefix:ce}),f.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch($){const N=((P=(S=$==null?void 0:$.response)==null?void 0:S.data)==null?void 0:P.message)||($==null?void 0:$.message)||"ä¿å­˜å¤±è´¥";f.error(N)}},c=async()=>{var S,P,$;if(!fe||!ce||!he){f.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}Z(!0),f.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const O=(s.models||[]).find(x=>x.id===fe),r=(O==null?void 0:O.modelId)||"speech-2.6-hd";let v=he;v.startsWith("http");const g=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;K(g),G({voiceId:g});const a=await Ce.ai.audio.createVoice({modelId:fe,targetModel:r,prefix:ce,url:v,promptUrl:ae||void 0,promptText:ne||void 0,voiceId:g,previewText:de||void 0}),y=(a==null?void 0:a.data)||a,d=y==null?void 0:y.sampleUrl;if(d){G({sampleUrl:d,status:"OK",voiceName:ce}),f.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const x=U(j);if(x){const p=`audioPreview-${Date.now()}`,w={id:p,type:"audioPreview",position:{x:x.position.x+450,y:x.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:d,config:{audioUrl:d,title:`${ce} - è¯•å¬`},models:s.models,createdBy:(S=x.data)==null?void 0:S.createdBy}};F(W=>[...W,w]);const R={id:`e-${j}-source-${p}-target`,source:j,sourceHandle:`${j}-source`,target:p,targetHandle:`${p}-target`,type:"aurora"};ye(W=>[...W,R])}}else G({status:"OK",voiceName:ce}),f.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(N){const O=(($=(P=N==null?void 0:N.response)==null?void 0:P.data)==null?void 0:$.message)||(N==null?void 0:N.message)||"åˆ›å»ºå¤±è´¥";f.error(O)}Z(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:S=>{Q(S),G({modelId:S})},options:(s.models||[]).filter(S=>{if(S.type!=="AUDIO_SYNTHESIS"||!S.isActive)return!1;if(Array.isArray(S.capabilities))return S.capabilities.some($=>$.capability==="éŸ³è‰²å…‹éš†"&&$.supported);const P=String(S.provider||"").toLowerCase();return P.includes("minimaxi")||P.includes("hailuo")||P.includes("æµ·èº")}).map(S=>({value:S.id,label:S.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:ce,onChange:S=>{Ue(S.target.value),G({voiceName:S.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:S=>S.stopPropagation()}),e.jsx("button",{onClick:m,disabled:!re||!ce,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!re||!ce?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:he?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:he?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:ae?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:ae?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ne,onChange:S=>{pe(S.target.value),G({promptText:S.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:S=>S.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:de,onChange:S=>{me(S.target.value),G({previewText:S.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:S=>S.stopPropagation()})]}),e.jsx("button",{onClick:c,disabled:Ee||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ee||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ee?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},$o=t.memo(Ro),Wr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Mo=({data:s,id:j,selected:n})=>{const{setNodes:F,getNode:ye,setEdges:U}=Zt(),[fe,Q]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.voiceId||""),[ce,Ue]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),he=t.useRef(null),[te,ae]=t.useState("zh"),je=t.useRef(null),ne=t.useRef(null),pe=t.useRef(null),de=t.useRef(null),me=t.useRef(null),[Ee,Z]=t.useState([]),z=async()=>{try{const g=await Ce.ai.audio.voices.list(),a=(g==null?void 0:g.data)??g;Z(Array.isArray(a)?a:[])}catch{}},A=async()=>{try{const g=window.AudioContext||window.webkitAudioContext;de.current||(de.current=new g);const a=de.current;a.state==="suspended"&&await a.resume()}catch{}},[I,G]=t.useState(!1),[m]=t.useState(""),[c]=t.useState(void 0),[S]=t.useState("mp3"),[P]=t.useState(void 0),[$]=t.useState(void 0),[N]=t.useState(void 0),[O]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!fe&&Q(s.config.modelId)},[s.config.modelId,fe]),t.useEffect(()=>{!re&&s.config.voiceId&&K(String(s.config.voiceId))},[s.config.voiceId,re]),t.useEffect(()=>{if(!fe){const a=(s.models||[]).filter(y=>y.type==="AUDIO_SYNTHESIS"&&y.isActive)[0];a&&(Q(a.id),r({modelId:a.id}))}},[s.models,fe]),t.useEffect(()=>{z()},[]),t.useEffect(()=>{te==="custom"&&z()},[te]),t.useEffect(()=>{const g=he.current;g&&(g.style.height="auto",g.style.height=`${g.scrollHeight}px`)},[ce]);const r=g=>{ye(j)&&F(y=>y.map(d=>d.id===j?{...d,data:{...d.data,config:{...d.data.config,...g}}}:d))},v=async(g=!1)=>{var x,p,w,R,W;let a=(re||s.config.voiceId||"").trim();if(g&&!a)if(te==="custom"){const _=Ee[0];_&&(a=String(_.voiceId),K(a),r({voiceId:a}))}else{const _=Wr.find(h=>{const l=h.label;return te==="zh"?l.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):te==="yue"?l.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):te==="en"?l.startsWith("è‹±æ–‡ "):te==="ja"?l.startsWith("æ—¥æ–‡ "):te==="ko"?l.startsWith("éŸ©æ–‡ "):!0});_&&(a=_.id,K(a),r({voiceId:a}))}const y=g?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(ce||"").trim();if(!a||!y){f.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let d=fe;if(!d){const _=(s.models||[]).filter(h=>h.type==="AUDIO_SYNTHESIS"&&h.isActive);if(_[0])d=_[0].id,Q(d),r({modelId:d});else{f.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}G(!0);try{g&&await A();const _={};if(m)try{_.voice_modify={emotion:m}}catch{}const h=await Ce.ai.audio.synthesize({modelId:d,voiceId:a,text:y,format:S,sampleRate:c,volume:$,rate:P,pitch:N,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},..._}),l=((x=h==null?void 0:h.data)==null?void 0:x.url)||(h==null?void 0:h.url),i=window.location.origin,M=(b=>{if(!b)return"";try{if(b.startsWith("http://localhost:3000")||b.startsWith("http://127.0.0.1:3000")){const q=new URL(b).pathname;return`${i}${q}`}return b.startsWith("http")?b:b.startsWith("/")?`${i}${b}`:`${i}/${b}`}catch{return b}})(l);let X;const V=b=>{if(b.length>=12){if(b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69)return"audio/wav";if(b[0]===73&&b[1]===68&&b[2]===51||b[0]===255&&(b[1]&224)===224)return"audio/mpeg"}return S==="wav"?"audio/wav":"audio/mpeg"},ie=b=>b.length>=12&&b[4]===102&&b[5]===116&&b[6]===121&&b[7]===112,xe=b=>b.length>=4&&b[0]===79&&b[1]===103&&b[2]===103&&b[3]===83,oe=b=>b.length>=4&&b[0]===102&&b[1]===76&&b[2]===97&&b[3]===67,k=new Uint8Array(X||new ArrayBuffer(0));let u=V(k);(!u||u==="application/octet-stream")&&(ie(k)?u="audio/mp4":xe(k)?u="audio/ogg":oe(k)&&(u="audio/flac"));let E;if(g){if(me.current){try{me.current.stop()}catch{}me.current.disconnect(),me.current=null}const b=ne.current||new Audio;b.preload="auto",b.autoplay=!0,b.playsInline=!0,b.crossOrigin="anonymous",ne.current=b;let q=!1;const ue=(H,ge,Ie=1500)=>new Promise(Ne=>{let Re=!1;const Ae=()=>{Re||(Re=!0,$e(),Ne(!0))},_e=()=>{Re||(Re=!0,$e(),Ne(!1))},$e=()=>{H.removeEventListener(ge,Ae),H.removeEventListener("error",_e)};H.addEventListener(ge,Ae),H.addEventListener("error",_e),setTimeout(()=>{_e()},Ie)});try{const H=Ne=>{const Re=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor(Re.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt(Re.substr(_e*2,2),16);return Ae},ge=((p=h==null?void 0:h.data)==null?void 0:p.hex)||(h==null?void 0:h.hex),Ie=ge?H(String(ge)).buffer:void 0;if(Ie&&Ie.byteLength>0){const Ne=new Uint8Array(Ie),Re=V(Ne),Ae=new Blob([Ie],{type:Re}),_e=URL.createObjectURL(Ae);if(pe.current)try{URL.revokeObjectURL(pe.current)}catch{}if(pe.current=_e,b.src=_e,b.load(),!await ue(b,"canplay"))throw new Error("blob not ready");await b.play(),q=!0}else throw new Error("no hex")}catch{q=!1}if(!q){try{const H=Ne=>{const Re=(Ne||"").replace(/\s+/g,""),Ae=new Uint8Array(Math.floor(Re.length/2));for(let _e=0;_e<Ae.length;_e++)Ae[_e]=parseInt(Re.substr(_e*2,2),16);return Ae},ge=((w=h==null?void 0:h.data)==null?void 0:w.hex)||(h==null?void 0:h.hex),Ie=ge?H(String(ge)).buffer:void 0;if(!Ie||Ie.byteLength===0){const Ne=await Ce.assets.proxyDownload(M);if(!Ne||Ne.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const Re=new Uint8Array(Ne),Ae=V(Re),_e=new Blob([Ne],{type:Ae}),$e=URL.createObjectURL(_e);if(pe.current)try{URL.revokeObjectURL(pe.current)}catch{}if(pe.current=$e,b.src=$e,b.load(),!await ue(b,"canplay"))throw new Error("blob not ready");await b.play(),q=!0}else{const Ne=new Uint8Array(Ie),Re=V(Ne),Ae=new Blob([Ie],{type:Re}),_e=URL.createObjectURL(Ae);if(pe.current)try{URL.revokeObjectURL(pe.current)}catch{}if(pe.current=_e,b.src=_e,b.load(),!await ue(b,"canplay"))throw new Error("blob not ready");await b.play(),q=!0}}catch{}if(!q)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const b=await Ce.assets.proxyDownload(M),q=new Uint8Array(b),ue=V(q);E=URL.createObjectURL(new Blob([b],{type:ue}))}catch{}if(!g&&E){if(je.current)try{URL.revokeObjectURL(je.current)}catch{}je.current=E;const b=M||E;r({outputUrl:b});try{const q=ye(j);if(q){const H=document.querySelector(`.react-flow__node[data-id="${q.id}"]`),ge=Math.round((H==null?void 0:H.getBoundingClientRect().width)||420),Ie=q.position.x+ge+160,Ne=`audio-preview-${Date.now()}`;F(Re=>{var le;const Ae=Re.filter(Ge=>{var Qe;return Ge.type==="audioPreview"&&((Qe=Ge.data)==null?void 0:Qe.sourceNodeId)===j}),_e=q.position.y,$e=Ae.length>0?Math.max(...Ae.map(Ge=>{var Qe;return((Qe=Ge.position)==null?void 0:Qe.y)||_e}))+120:_e;return[...Re,{id:Ne,type:"audioPreview",position:{x:Ie,y:$e},data:{audioUrl:b,sourceNodeId:j,createdBy:(le=q.data)==null?void 0:le.createdBy}}]}),U(Re=>[...Re,{id:`${j}-${Ne}`,source:j,target:Ne}])}}catch{}}g&&ne.current&&!ne.current.paused?f.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!g&&E&&f.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(_){const h=((W=(R=_==null?void 0:_.response)==null?void 0:R.data)==null?void 0:W.message)||(_==null?void 0:_.message)||(g?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");f.error(h)}G(!1)};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:g=>{Q(g),r({modelId:g})},options:(s.models||[]).filter(g=>g.type==="AUDIO_SYNTHESIS"&&g.isActive).map(g=>({value:g.id,label:g.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(os,{value:te,onChange:g=>{ae(g),g==="custom"&&z()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(os,{value:re,onChange:g=>{K(g),r({voiceId:g})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...te==="custom"?Ee.map(g=>({value:g.voiceId,label:g.prefix||g.voiceId})):Wr.filter(g=>{const a=g.label;return te==="zh"?a.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):te==="yue"?a.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):te==="en"?a.startsWith("è‹±æ–‡ "):te==="ja"?a.startsWith("æ—¥æ–‡ "):te==="ko"?a.startsWith("éŸ©æ–‡ "):!0}).map(g=>({value:g.id,label:g.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>v(!0),disabled:I,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${I?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":""}`,style:I?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:he,value:ce,onChange:g=>{Ue(g.target.value),r({text:g.target.value})},onMouseDown:g=>g.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>v(!1),disabled:I||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${I||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"border-transparent dark:border-white/10"}`,style:I||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #525252, #404040)"},children:I?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ne,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Do=t.memo(Mo),Lo=t.memo(({id:s,sourceX:j,sourceY:n,targetX:F,targetY:ye,sourcePosition:U,targetPosition:fe,selected:Q,markerEnd:re})=>{const[K]=ka({sourceX:j,sourceY:n,targetX:F,targetY:ye,sourcePosition:U,targetPosition:fe});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#404040",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#525252",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:K,fill:"none",stroke:Q?"#525252":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:re}),e.jsx("path",{d:K,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:re}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:K,calcMode:"linear"})}),e.jsx("path",{d:K,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Po=({data:s,id:j})=>{const n=t.useRef(null),{getNode:F,setNodes:ye}=Zt(),[U,fe]=t.useState(!1),[Q,re]=t.useState([]),[K,ce]=t.useState(""),[Ue,he]=t.useState("ALL"),[te,ae]=t.useState(""),[je,ne]=t.useState(!1),pe=t.useMemo(()=>window.location.origin,[]),de=t.useMemo(()=>{var I;const A=s.audioUrl||"";if(A.startsWith("blob:")){const G=s.sourceNodeId?F(s.sourceNodeId):null,m=((I=G==null?void 0:G.data)==null?void 0:I.outputUrl)||"";return m.startsWith("http")?m:m.startsWith("/")?`${pe}${m}`:A}return A.startsWith("http")?`${pe}/api/assets/proxy-stream?url=${encodeURIComponent(A)}`:A.startsWith("/")?`${pe}${A}`:A},[s.audioUrl,s.sourceNodeId,pe]);t.useEffect(()=>{const A=n.current;A&&(A.preload="auto",A.playsInline=!0,A.crossOrigin="anonymous",A.load())},[de]),t.useEffect(()=>{U&&(me(),setTimeout(()=>{Ee()},100))},[U]);const me=async()=>{try{const A=Ue==="ALL"?void 0:{category:Ue},G=(await Ce.assetLibraries.getAll(A)).data||[];re(G);const m=Ue==="ALL"?G:G.filter(c=>(c.category||"OTHER")===Ue);if(m.length>0){const c=m.find(S=>S.id===K);ce(c?c.id:m[0].id)}else ce("")}catch{f.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},Ee=()=>{const A=window.__workflowContext;if(!A||!A.project||!A.nodeGroups){f.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const I=Ws(j,A.nodeGroups);if(!I&&A.nodeGroups.length>0){const m=A.nodeGroups[0],c=_s({project:A.project,episode:A.episode,nodeGroup:m,assetType:"audio"});c?(ae(c),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${c}`)):f.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const G=_s({project:A.project,episode:A.episode,nodeGroup:I,assetType:"audio"});G?(ae(G),f.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${G}`)):f.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},Z=async()=>{var A,I;if(!K){f.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!te.trim()){f.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ne(!0),await Ce.assetLibraries.addFromUrl(K,s.audioUrl,te.trim());const G=window.__workflowContext;if(G&&G.project&&G.nodeGroups){const m=Ws(j,G.nodeGroups)||G.nodeGroups[0];m&&_s({project:G.project,episode:G.episode,nodeGroup:m,nodeId:j,assetType:"audio",preview:!1})}f.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),fe(!1),ae("");try{ye(m=>m.map(c=>c.id===j?{...c,data:{...c.data,addedToLibrary:!0}}:c))}catch{}try{const m=new CustomEvent("asset-library-updated",{detail:{libraryId:K}});window.dispatchEvent(m)}catch{}}catch(G){f.error(((I=(A=G.response)==null?void 0:A.data)==null?void 0:I.message)||"æ·»åŠ å¤±è´¥")}finally{ne(!1)}},z=async()=>{var G;let A=`audio-${Date.now()}.mp3`;const I=window.__workflowContext;if(I&&I.project&&I.nodeGroups){const m=Ws(j,I.nodeGroups)||I.nodeGroups[0];if(m){const c=_s({project:I.project,episode:I.episode,nodeGroup:m,assetType:"audio",preview:!0});if(c&&(A=c,!A.includes("."))){const S=((G=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:G[0])||".mp3";A+=S}}}try{f.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const m=`/assets/proxy-download-with-name?url=${encodeURIComponent(s.audioUrl)}&filename=${encodeURIComponent(A)}`,c=await Ce.get(m,{responseType:"blob"}),S=c instanceof Blob?c:c==null?void 0:c.data;if(!S||!(S instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const P=window.URL.createObjectURL(S),$=document.createElement("a");$.href=P,$.download=A,document.body.appendChild($),$.click(),document.body.removeChild($),setTimeout(()=>{window.URL.revokeObjectURL(P)},100),f.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${A}`)}catch(m){f.error(`ä¸‹è½½å¤±è´¥: ${m instanceof Error?m.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white dark:bg-[#18181b] backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:n,controls:!0,src:de,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{fe(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-neutral-800 to-neutral-700 dark:from-neutral-600 dark:to-neutral-500"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:z,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),U&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:A=>A.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>fe(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:te,onChange:A=>ae(A.target.value),onMouseDown:A=>A.stopPropagation(),onTouchStart:A=>A.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-neutral-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const A=Ue==="ALL"?Q:Q.filter(I=>(I.category||"OTHER")===Ue);return A.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Ue==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:K,onChange:I=>ce(I.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500",children:A.map(I=>e.jsxs("option",{value:I.id,children:[I.name," (",I._count.assets," ä¸ªèµ„äº§)"]},I.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(A=>e.jsx("button",{type:"button",onClick:()=>{he(A);const I=Q.filter(G=>(G.category||"OTHER")===A);ce(I.length>0?I[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Ue===A?"border-neutral-500 bg-neutral-500/10 dark:bg-neutral-500/20":"border-slate-200 dark:border-border-dark hover:border-neutral-400 dark:hover:border-neutral-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:A==="ROLE"?"person":A==="SCENE"?"landscape":A==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:A==="ROLE"?"è§’è‰²åº“":A==="SCENE"?"åœºæ™¯åº“":A==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},A))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>fe(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:Z,disabled:je||Q.length===0||!te.trim(),className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg text-white rounded-lg transition-all disabled:cursor-not-allowed",children:je?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Oo=t.memo(Po),Go=({data:s,id:j,selected:n})=>{const{setNodes:F,getNode:ye,setEdges:U}=Zt(),[fe,Q]=t.useState(s.config.modelId||""),[re,K]=t.useState(s.config.prompt||""),[ce,Ue]=t.useState(s.config.previewText||""),[he,te]=t.useState(s.config.voiceId||""),[ae,je]=t.useState(!1),ne=t.useRef(null),pe=t.useRef(null),de=t.useRef(null),me=t.useRef(null),[Ee,Z]=t.useState([]);t.useEffect(()=>{if(!fe){const S=(s.models||[]).filter(P=>P.type==="AUDIO_SYNTHESIS"&&P.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(P.provider||"").toLowerCase())&&(Array.isArray(P.capabilities)?P.capabilities.some($=>$.capability==="éŸ³è‰²è®¾è®¡"&&$.supported):!0))[0];S&&(Q(S.id),z({modelId:S.id}))}},[s.models,fe]);const z=c=>{ye(j)&&F(P=>P.map($=>$.id===j?{...$,data:{...$.data,config:{...$.data.config,...c}}}:$))};t.useEffect(()=>{(async()=>{try{const c=await Ce.ai.audio.voices.list(),S=(c==null?void 0:c.data)??c;Z(Array.isArray(S)?S:[])}catch{}})()},[]);const A=c=>{c&&(c.style.height="auto",c.style.height=`${c.scrollHeight}px`)};t.useEffect(()=>{A(pe.current)},[re]),t.useEffect(()=>{A(de.current)},[ce]);const I=async c=>{if(!c)return!1;try{const S=(c||"").replace(/\s+/g,""),P=new Uint8Array(Math.floor(S.length/2));for(let v=0;v<P.length;v++)P[v]=parseInt(S.substr(v*2,2),16);const $=(()=>{const v=P;return v.length>=12&&v[0]===82&&v[1]===73&&v[2]===70&&v[3]===70&&v[8]===87&&v[9]===65&&v[10]===86&&v[11]===69?"audio/wav":(v.length>=3&&v[0]===73&&v[1]===68&&v[2]===51||v.length>=2&&v[0]===255&&(v[1]&224)===224,"audio/mpeg")})(),N=new Blob([P.buffer],{type:$}),O=URL.createObjectURL(N);if(me.current)try{URL.revokeObjectURL(me.current)}catch{}me.current=O;const r=ne.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=O,ne.current=r,await r.play(),!0}catch{return!1}},G=async()=>{var S,P,$,N,O;if(!re.trim()){f.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let c=fe;if(!c){const r=(s.models||[]).filter(v=>v.type==="AUDIO_SYNTHESIS"&&v.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(v.provider||"").toLowerCase()));if(r[0])c=r[0].id,Q(c),z({modelId:c});else{f.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}je(!0);try{const r=await Ce.ai.audio.design({modelId:c,prompt:re,preview_text:ce,voice_id:he||void 0,aigc_watermark:!1}),v=((S=r==null?void 0:r.data)==null?void 0:S.voice_id)||(r==null?void 0:r.voice_id),g=((P=r==null?void 0:r.data)==null?void 0:P.trial_audio)||(r==null?void 0:r.trial_audio)||(($=r==null?void 0:r.data)==null?void 0:$.hex)||(r==null?void 0:r.hex);v&&(te(String(v)),z({voiceId:String(v)})),g&&typeof g=="string"?(z({trialHex:g}),await I(g),f.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):f.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const a=ye(j);if(a){const d=document.querySelector(`.react-flow__node[data-id="${a.id}"]`),x=Math.round((d==null?void 0:d.getBoundingClientRect().width)||420),p=a.position.x+x+160,w=`audio-preview-${Date.now()}`;F(R=>{var W;return[...R,{id:w,type:"audioPreview",position:{x:p,y:a.position.y},data:{audioUrl:me.current||"",sourceNodeId:j,createdBy:(W=a.data)==null?void 0:W.createdBy}}]}),U(R=>[...R,{id:`${j}-${w}`,source:j,target:w}])}}catch{}}catch(r){const v=((O=(N=r==null?void 0:r.response)==null?void 0:N.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";f.error(v)}je(!1)},m=async()=>{var S,P;const c=(he||"").trim();if(!c){f.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(Ee.some(y=>String(y.voiceId)===String(c))){f.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const O=(s.models||[]).find(y=>y.id===fe),r=(O==null?void 0:O.modelId)||"cosyvoice-v2",v=(re||c).slice(0,40);await Ce.ai.audio.voices.add({voiceId:c,prefix:v,targetModel:r,provider:String((O==null?void 0:O.provider)||"")});const g=await Ce.ai.audio.voices.list(),a=(g==null?void 0:g.data)??g;Z(Array.isArray(a)?a:[]),f.success("å·²ä¿å­˜éŸ³è‰²")}catch($){const N=((P=(S=$==null?void 0:$.response)==null?void 0:S.data)==null?void 0:P.message)||($==null?void 0:$.message)||"ä¿å­˜å¤±è´¥";f.error(N)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(os,{value:fe,onChange:c=>{Q(c),z({modelId:c})},options:(s.models||[]).filter(c=>c.type!=="AUDIO_SYNTHESIS"||!c.isActive?!1:Array.isArray(c.capabilities)?c.capabilities.some(S=>S.capability==="éŸ³è‰²è®¾è®¡"&&S.supported):["minimaxi","hailuo","æµ·èº"].includes(String(c.provider||"").toLowerCase())).map(c=>({value:c.id,label:c.name}))})]}),Ee.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(os,{value:he||"",onChange:c=>{te(c),z({voiceId:c})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...Ee.map(c=>({value:c.voiceId,label:c.prefix||c.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:he,onChange:c=>{const S=c.target.value;te(S),z({voiceId:S})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:pe,value:re,onChange:c=>{K(c.target.value),z({prompt:c.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:de,value:ce,onChange:c=>{Ue(c.target.value),z({previewText:c.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:G,disabled:ae||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ae||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ae?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:m,disabled:ae||!he||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${ae||!he||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ne,className:"hidden"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Vo=t.memo(Go),Wo=({data:s,id:j,selected:n})=>{const F=t.useRef(null),ye=t.useRef(null),U=t.useRef(null),{getNodes:fe,getEdges:Q,setNodes:re,setEdges:K,getNode:ce,getViewport:Ue}=Zt(),he=zs(),te=Ds(),[ae,je]=t.useState(null),[ne,pe]=t.useState("#7c3aed"),[de,me]=t.useState(100),Ee=t.useRef(!1),Z=t.useRef(null),z=t.useRef(null),A=t.useRef(null),I=t.useRef(new Set),G=t.useRef(null),m=t.useRef(null),c=t.useRef(null),S=4096,P=s.width||800,$=s.width||800,N=S,O=S;return t.useEffect(()=>{var h,l,i,B;if(!F.current||ye.current)return;const r=document.createElement("canvas");r.width=N,r.height=O,F.current.appendChild(r);const v=new _a(r,{width:N,height:O,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),g=new Zs({left:0,top:0,width:N,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});v.add(g),v.sendObjectToBack(g),v.perPixelTargetFind=!0,v.targetFindTolerance=8;const a=P/N;v.setDimensions({width:P,height:$}),v.setZoom(a),r.style.width=`${P} px`,r.style.height=`${$} px`,ye.current=v,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const y=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;v.rotationCursor=y;const d=Vs.prototype.controls||{};d.tl&&(d.tl.cursorStyle="nwse-resize",d.tl.cornerStyle="square"),d.br&&(d.br.cursorStyle="nwse-resize",d.br.cornerStyle="square"),d.tr&&(d.tr.cursorStyle="nesw-resize",d.tr.cornerStyle="square"),d.bl&&(d.bl.cursorStyle="nesw-resize",d.bl.cornerStyle="square"),d.mtr&&(d.mtr.cursorStyle=y,d.mtr.cornerStyle="circle");const x=M=>{M&&(M.borderColor="#ff2d55",M.cornerColor="#ff2d55",M.cornerStrokeColor="#ff2d55",M.transparentCorners=!1,M.cornerSize=12,M.hasBorders=!0,M.hasControls=!0)},p=()=>{const M=v.getActiveObject();M&&(M.type==="activeSelection"&&Array.isArray(M._objects)&&M._objects.forEach(x),x(M),v.requestRenderAll())};v.on("selection:created",p),v.on("selection:updated",p),v.freeDrawingBrush=new Lr(v);const w=()=>{const M=ye.current;if(!M)return;const X=M.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(X.objects)&&(X.objects=X.objects.map(oe=>(oe&&oe.type==="image"&&oe.originalUrl&&(oe.src=oe.originalUrl),oe)));const V={canvasJson:X,appliedCrop:c.current},ie=JSON.stringify(V);try{localStorage.setItem(`superCanvas:${j}`,ie)}catch{}ce(j)&&re(oe=>oe.map(k=>k.id===j?{...k,data:{...k.data,canvasState:ie}}:k))},R=()=>{m.current&&(clearTimeout(m.current),m.current=null),m.current=window.setTimeout(()=>{w()},300)};v.on("object:added",R),v.on("object:modified",R),v.on("object:removed",R),v.on("path:created",R);const W=((l=(h=ce(j))==null?void 0:h.data)==null?void 0:l.canvasState)||localStorage.getItem(`superCanvas:${j}`),_=(B=(i=ce(j))==null?void 0:i.data)==null?void 0:B.canvasJson;if(W||_)try{let M,X=null;if(W){const u=JSON.parse(W);u.canvasJson?(M=u.canvasJson,X=u.appliedCrop):M=u}else _&&(M=JSON.parse(_));const V=M,ie=u=>{var E,b,q,ue,H,ge,Ie,Ne,Re;if(!u||typeof u!="object")return u;if(u.type==="image"){if(u.originalUrl)u.src=u.originalUrl;else if(u.sourceNodeId){const Ae=ce(u.sourceNodeId),_e=((E=Ae==null?void 0:Ae.data)==null?void 0:E.imageUrl)||((b=Ae==null?void 0:Ae.data)==null?void 0:b.url)||((q=Ae==null?void 0:Ae.data)==null?void 0:q.output)||((H=(ue=Ae==null?void 0:Ae.data)==null?void 0:ue.config)==null?void 0:H.generatedImageUrl)||((Re=(Ne=(Ie=(ge=Ae==null?void 0:Ae.data)==null?void 0:ge.config)==null?void 0:Ie.uploadedFiles)==null?void 0:Ne[0])==null?void 0:Re.url);_e&&(u.originalUrl=_e,u.src=_e)}return typeof u.src=="string"&&u.src.startsWith("blob:")?null:u}return Array.isArray(u.objects)&&(u.objects=u.objects.map(ie).filter(Boolean),u.type==="group"&&u.objects.length===0)?null:u},xe=u=>u&&(typeof(u==null?void 0:u.src)=="string"&&u.src.startsWith("blob:")?null:u.type==="image"?ie(u):u),oe=u=>u&&(Array.isArray(u)?u.map(oe).filter(Boolean):typeof u=="object"&&(u.type==="image"&&typeof u.src=="string"&&u.src.startsWith("blob:")||(Object.keys(u).forEach(E=>{const b=u[E];if(typeof b=="string"&&b.startsWith("blob:"))u[E]=void 0;else if(b&&typeof b=="object"){const q=oe(b);q===null?delete u[E]:u[E]=q}}),Array.isArray(u.objects)&&(u.objects=u.objects.map(oe).filter(Boolean),u.type==="group"&&u.objects.length===0)))?null:u);Array.isArray(V.objects)&&(V.objects=V.objects.map(ie).filter(Boolean)),V.backgroundImage&&(V.backgroundImage=xe(V.backgroundImage)),V.overlayImage&&(V.overlayImage=xe(V.overlayImage)),V.clipPath&&(V.clipPath=ie(V.clipPath));const k=oe(V);v.loadFromJSON(k).then(()=>{const u=new Zs({left:0,top:0,width:N,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});v.add(u);const E=v.getObjects().find(b=>b.name==="__background__");if(E&&v.sendObjectToBack(E),X){c.current=X;const{left:b,top:q,width:ue,height:H}=X,ge=new Zs({left:b,top:q,width:ue,height:H,absolutePositioned:!0});v.clipPath=ge,E&&E.set({left:b,top:q,width:ue,height:H})}v.requestRenderAll()})}catch{}return F.current&&F.current.classList.add("nodrag"),()=>{v.dispose(),ye.current=null,F.current&&(F.current.innerHTML="")}},[j,N,O,P]),t.useEffect(()=>{ae==="brush"?(de<80||de>400)&&me(100):(ae==="pencil"||ae==="line"||ae==="arrow")&&(de<10||de>30)&&me(15)},[ae,de]),t.useEffect(()=>{const r=ye.current;if(!r)return;const v="https://api.waule.com",g=he.filter(d=>d.target===j&&d.targetHandle==="input-image");g.forEach(async d=>{var _,h;const x=te.find(l=>l.id===d.source);if(!x||I.current.has(x.id))return;let p;const w=x.data;if(x.type==="upload"){const l=(_=w==null?void 0:w.config)==null?void 0:_.uploadedFiles;if(l&&l.length>0){const i=l[0];(i.type==="IMAGE"||(h=i.mimeType)!=null&&h.startsWith("image/"))&&(p=i.url)}}else x.type==="imagePreview"?p=w==null?void 0:w.imageUrl:p=(w==null?void 0:w.imageUrl)||(w==null?void 0:w.output)||(w==null?void 0:w.url);if(!p)return;let R=p;if(!p.startsWith("http")&&!p.startsWith("data:")&&(R=`${v}${p}`),R=R.replace(/^https?:\/\/localhost(?::\d+)?/i,v),r.getObjects().find(l=>l.sourceNodeId===x.id)){I.current.add(x.id);return}I.current.add(x.id);try{const l=await Ce.assets.proxyDownload(R),i=new Uint8Array(l);let B="image/png";i.length>=4&&(i[0]===137&&i[1]===80&&i[2]===78&&i[3]===71?B="image/png":i[0]===255&&i[1]===216&&i[2]===255?B="image/jpeg":i[0]===71&&i[1]===73&&i[2]===70?B="image/gif":i[0]===82&&i[1]===73&&i[2]===70&&i[3]===70&&i.length>=12&&i[8]===87&&i[9]===69&&i[10]===66&&i[11]===80&&(B="image/webp"));const M=new Blob([l],{type:B}),X=URL.createObjectURL(M),V=await Ta.fromURL(X);if(!V){URL.revokeObjectURL(X);return}const ie=g.indexOf(d)*20;V.set({scaleX:1,scaleY:1,left:(N-V.width)/2+ie,top:(O-V.height)/2+ie,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:x.id,originalUrl:R,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),V.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(V);const xe=r.getObjects().find(oe=>oe.name==="__background__");xe?(r.sendObjectToBack(V),r.sendObjectToBack(xe)):r.sendObjectToBack(V),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(X),1e3)}catch{}});const a=new Set(g.map(d=>{var x;return(x=te.find(p=>p.id===d.source))==null?void 0:x.id}).filter(Boolean)),y=[];I.current.forEach(d=>{if(!a.has(d)){y.push(d);const x=r.getObjects().find(p=>p.sourceNodeId===d);x&&(r.remove(x),r.requestRenderAll())}}),y.forEach(d=>I.current.delete(d))},[he,te,j,N,O]),t.useEffect(()=>{const r=ye.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,ae===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(y=>{y.name!=="__background__"&&y.name!=="__crop__"&&(y.selectable=!1,y.evented=!1)}),G.current&&(G.current.style.display="none"),c.current){const{left:y,top:d,width:x,height:p}=c.current,w=new Zs({left:y,top:d,width:x,height:p,absolutePositioned:!0});r.clipPath=w;const R=r.getObjects().find(W=>W.name==="__background__");R&&R.set({left:y,top:d,width:x,height:p})}return}const v=ne.startsWith("#")?`%23${ne.slice(1)}`:encodeURIComponent(ne),g=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${v}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(ae==="pencil"||ae==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Lr(r);const y=(x,p)=>{const w=x.replace("#",""),R=parseInt(w.substring(0,2),16),W=parseInt(w.substring(2,4),16),_=parseInt(w.substring(4,6),16);return`rgba(${R},${W},${_},${p})`};if(r.freeDrawingBrush.color=y(ne,.7),r.freeDrawingBrush.width=de,c.current){const{left:x,top:p,width:w,height:R}=c.current,W=new Zs({left:x,top:p,width:w,height:R,absolutePositioned:!0});r.clipPath=W;const _=r.getObjects().find(h=>h.name==="__background__");_&&_.set({left:x,top:p,width:w,height:R})}const d=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${v}' stroke-width='2.2'/></svg>") 16 16, crosshair`;ae==="pencil"?(r.freeDrawingCursor=g,r.defaultCursor=g,r.hoverCursor=g,r.moveCursor=g,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=g)):(r.freeDrawingCursor=d,r.defaultCursor=d,r.hoverCursor=d,r.moveCursor=d,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=d)),r.selection=!1,r.getObjects().forEach(x=>{x.name!=="__background__"&&x.name!=="__crop__"&&(x.selectable=!0,x.evented=!0)}),ae==="brush"&&G.current&&(G.current.style.display="block"),ae==="pencil"&&G.current&&(G.current.style.display="none")}else if(ae==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const y=r.getObjects().find(R=>R.name==="__background__");y&&y.set({left:0,top:0,width:N,height:O}),r.requestRenderAll();let d=A.current;const x=N*.1,p=N-x*2,w=O-x*2;if(!d||!r.getObjects().includes(d)){const R=c.current||{left:x,top:x,width:p,height:w};d=new Zs({left:R.left,top:R.top,width:R.width,height:R.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),A.current=d,r.add(d)}d&&(d.visible=!0,d.selectable=!0,d.evented=!0,r.setActiveObject(d),r.requestRenderAll())}else if(ae==="line"||ae==="arrow"||ae==="text"||ae==="eraser"){if(r.selection=!1,c.current){const{left:d,top:x,width:p,height:w}=c.current,R=new Zs({left:d,top:x,width:p,height:w,absolutePositioned:!0});r.clipPath=R;const W=r.getObjects().find(_=>_.name==="__background__");W&&W.set({left:d,top:x,width:p,height:w})}const y=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${v}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=ae==="text"?"text":ae==="eraser"?a:y,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),ae==="line"||ae==="arrow"?(r.hoverCursor=y,r.moveCursor=y,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!1,d.evented=!1)}),G.current&&(G.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(d=>{d.name!=="__background__"&&d.name!=="__crop__"&&(d.selectable=!0,d.evented=!0)}),ae==="eraser"&&G.current&&(G.current.style.display="none"),ae==="eraser"&&(r.moveCursor=a,r.hoverCursor=a)),G.current&&(G.current.style.display="none")}else{if(A.current&&(A.current.visible=!1,r.discardActiveObject()),c.current){const{left:y,top:d,width:x,height:p}=c.current,w=new Zs({left:y,top:d,width:x,height:p,absolutePositioned:!0});r.clipPath=w;const R=r.getObjects().find(W=>W.name==="__background__");R&&R.set({left:y,top:d,width:x,height:p})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(y=>{y.name!=="__background__"&&y.name!=="__crop__"&&(y.selectable=!0,y.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),G.current&&(G.current.style.display="none")}},[ae,ne,de,N,O,P,$]),t.useEffect(()=>{const r=v=>{const g=ye.current;if(g){if(v.key==="Escape")je("select");else if(v.key==="Enter"&&ae==="crop"){const a=A.current;if(a){const y=Math.max(0,Math.floor(a.left??0)),d=Math.max(0,Math.floor(a.top??0)),x=Math.max(1,Math.floor((a.width??0)*(a.scaleX??1))),p=Math.max(1,Math.floor((a.height??0)*(a.scaleY??1)));c.current={left:y,top:d,width:x,height:p};const w=new Zs({left:y,top:d,width:x,height:p,absolutePositioned:!0});g.clipPath=w;const R=g.getObjects().find(_=>_.name==="__background__");R&&R.set({left:y,top:d,width:x,height:p}),a.visible=!1,je("select"),g.requestRenderAll();const W=ye.current?()=>{const _=ye.current;if(!_)return;const h=_.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(h.objects)&&(h.objects=h.objects.map(M=>(M&&M.type==="image"&&M.originalUrl&&(M.src=M.originalUrl),M)));const l={canvasJson:h,appliedCrop:c.current},i=JSON.stringify(l);try{localStorage.setItem(`superCanvas:${j}`,i)}catch{}ce(j)&&re(M=>M.map(X=>X.id===j?{...X,data:{...X.data,canvasState:i}}:X))}:null;W&&W()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[ae]),t.useEffect(()=>{const r=ye.current;if(!r)return;const v=p=>{const w=r.getPointer(p.e);if(Ee.current=!0,Z.current={x:w.x,y:w.y},(ae==="line"||ae==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(R=>{R.name!=="__background__"&&R.name!=="__crop__"&&(R.selectable=!1,R.evented=!1)})),ae==="line"){const R=[w.x,w.y,w.x,w.y],W=new or(R,{strokeWidth:de/2,fill:ne,stroke:ne,originX:"center",originY:"center",strokeLineCap:"round"});z.current=W,r.add(W)}else if(ae==="arrow"){const R=[w.x,w.y,w.x,w.y],W=new or(R,{strokeWidth:de/2,fill:ne,stroke:ne,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});z.current=W,r.add(W)}else if(ae==="text"){const R=new Pr("Type here",{left:w.x,top:w.y,fontFamily:"Arial",fill:ne,fontSize:de*10,width:300,splitByGrapheme:!0});R.lockScalingY=!1,R.lockScalingFlip=!0,R.lockUniScaling=!1,R.setControlsVisibility({mt:!1,mb:!1}),r.add(R),r.setActiveObject(R),R.enterEditing(),je("select")}else if(ae==="eraser"){const R=r.getObjects();for(let W=R.length-1;W>=0;W--){const _=R[W];if(!(_.name==="__background__"||_.name==="__crop__"||_.name==="__input_image__"||_.sourceNodeId)&&_.containsPoint(w)){r.remove(_);break}}r.requestRenderAll()}},g=p=>{const w=r.getPointer(p.e);if(ae==="brush"&&G.current){const W=r.getZoom(),_=de*W,h=_/2;G.current.style.width=`${_}px`,G.current.style.height=`${_}px`,G.current.style.left=`${w.x*W-h}px`,G.current.style.top=`${w.y*W-h}px`,G.current.style.borderColor=`rgba(${parseInt(ne.slice(1,3),16)},${parseInt(ne.slice(3,5),16)},${parseInt(ne.slice(5,7),16)},0.7)`,G.current.style.borderWidth="1px",G.current.style.background="transparent"}if(!Ee.current)return;const R=z.current;if(ae==="line"&&R&&R instanceof or)R.set({x2:w.x,y2:w.y}),R.setCoords(),r.requestRenderAll();else if(ae==="arrow"&&R&&R instanceof or)R.set({x2:w.x,y2:w.y}),R.setCoords(),r.requestRenderAll();else if(ae==="eraser"){const W=r.getObjects();for(let _=W.length-1;_>=0;_--){const h=W[_];h.name==="__background__"||h.name==="__crop__"||h.name==="__input_image__"||h.sourceNodeId||h.containsPoint(w)&&r.remove(h)}r.requestRenderAll()}},a=()=>{if(Ee.current=!1,ae==="arrow"&&z.current instanceof or){const p=z.current,w=Math.atan2(p.y2-p.y1,p.x2-p.x1),R=Math.max(de*10,120),W=Math.PI/6,_=-Math.cos(w),h=-Math.sin(w),l=Math.cos(W),i=Math.sin(W),B=p.x2+R*(_*l-h*i),M=p.y2+R*(_*i+h*l),X=p.x2+R*(_*l+h*i),V=p.y2+R*(-_*i+h*l),ie=p.strokeWidth||de/2,xe=new or([p.x2,p.y2,B,M],{stroke:ne,strokeWidth:ie,strokeLineCap:"round"}),oe=new or([p.x2,p.y2,X,V],{stroke:ne,strokeWidth:ie,strokeLineCap:"round"});r.add(xe),r.add(oe);const k=new Ua([p,xe,oe],{selectable:!0,evented:!0});r.remove(p),r.remove(xe),r.remove(oe),r.add(k)}z.current=null,(ae==="line"||ae==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(p=>{p.name!=="__background__"&&p.name!=="__crop__"&&(p.selectable=!1,p.evented=!1)}))},y=p=>{var _;const w=p.target;if(!w)return;const R=w.type==="textbox"||w instanceof Pr,W=w.type==="i-text"||w instanceof Ra;if(R||W){const h=(_=p==null?void 0:p.transform)==null?void 0:_.corner;if(h==="ml"||h==="mr"){const l=Math.max(50,(w.width||50)*(w.scaleX||1));w.set({width:l,scaleX:1,scaleY:1})}else{const l=w.scaleX||1,i=w.fontSize||40,B=Math.max(6,Math.min(512,Math.round(i*l)));w.set({fontSize:B,scaleX:1,scaleY:1})}w.setCoords(),r.requestRenderAll()}},d=()=>{ae==="brush"&&G.current&&(G.current.style.display="block")},x=()=>{G.current&&(G.current.style.display="none")};return r.on("mouse:down",v),r.on("mouse:move",g),r.on("mouse:up",a),r.on("mouse:over",d),r.on("mouse:out",x),r.on("object:scaling",y),()=>{r.off("mouse:down",v),r.off("mouse:move",g),r.off("mouse:up",a),r.off("mouse:over",d),r.off("mouse:out",x),r.off("object:scaling",y)}},[ae,ne,de]),e.jsxs("div",{ref:U,className:`relative flex flex-col w-[800px] h-auto bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ir,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:F,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:G,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:Ir,label:"Select"},{id:"pencil",icon:Br,label:"Pencil"},{id:"brush",icon:Ma,label:"Brush"},{id:"line",icon:Ga,label:"Line"},{id:"arrow",icon:$a,label:"Arrow"},{id:"text",icon:Fa,label:"Text"},{id:"eraser",icon:Pa,label:"Eraser"},{id:"crop",icon:La,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>je(r.id),className:`p-2 rounded-lg transition-all ${ae===r.id?"bg-neutral-500/20 text-neutral-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=ye.current,v=r==null?void 0:r.getActiveObject();v&&(r==null||r.remove(v),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(zr,{size:16})}),e.jsx("button",{onClick:()=>{const r=ye.current,v=r==null?void 0:r.getActiveObject();v&&(r==null||r.bringObjectToFront(v),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Wa,{size:16})}),e.jsx("button",{onClick:()=>{const r=ye.current,v=r==null?void 0:r.getActiveObject();if(v){r==null||r.sendObjectToBack(v);const g=r==null?void 0:r.getObjects().find(a=>a.name==="__background__");g&&(r==null||r.sendObjectToBack(g)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Va,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ne,onChange:r=>pe(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:ae==="brush"?80:10,max:ae==="brush"?400:30,value:de,onChange:r=>{const v=parseInt(r.target.value);me(v)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:de})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:ae==="crop",onClick:async()=>{var ge,Ie,Ne;const r=ye.current;if(!r)return;r.discardActiveObject();const v=[...r.viewportTransform],g=r.getWidth(),a=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(S),r.setHeight(S);const y=r.clipPath;r.clipPath=void 0;const d=c.current;let x="",p=N,w=O;d?(p=d.width,w=d.height,x=r.toDataURL({format:"png",quality:1,left:d.left,top:d.top,width:d.width,height:d.height,multiplier:1})):x=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:N,height:O}),r.clipPath=y,r.setViewportTransform(v),r.setWidth(g),r.setHeight(a),r.requestRenderAll();const R=`${p}:${w}`,W=ce(j);if(!W)return;let _=x;try{const Re=x.split(",")[1],Ae=atob(Re),_e=new Array(Ae.length);for(let Wt=0;Wt<Ae.length;Wt++)_e[Wt]=Ae.charCodeAt(Wt);const $e=new Uint8Array(_e),le=new Blob([$e],{type:"image/png"}),Ge=`canvas-export-${Date.now()}.png`,Qe=await Ce.post("/assets/presigned-url",{fileName:Ge,contentType:"image/png"});if(Qe.success&&Qe.data){const{uploadUrl:Wt,publicUrl:Ct}=Qe.data;await(await xs(async()=>{const{default:ct}=await import("./utils-BcyDR7Vi.js");return{default:ct}},[])).default.put(Wt,le,{headers:{"Content-Type":"image/png"},timeout:3e5}),_=Ct}}catch{}const h=Ue&&((ge=Ue())==null?void 0:ge.zoom)||1,l=document.querySelector(`.react-flow__node[data-id="${j}"]`),i=(l==null?void 0:l.getBoundingClientRect().width)||400,B=Math.round(i/h),M=400,X=(Re,Ae=300)=>{if(!Re||!/^[0-9]+\s*:\s*[0-9]+$/.test(Re))return Ae;const[_e,$e]=Re.split(":").map(le=>parseFloat(le));return!_e||!$e?Ae:Math.round(M*($e/_e))},V=200,ie=100,xe=X(R,300),oe=fe(),k=Q(),E=oe.filter(Re=>Re.type==="imagePreview"&&k.some(Ae=>Ae.source===j&&Ae.target===Re.id)).length,b=W.position.x+B+V,q=W.position.y+E*(xe+ie),ue={id:`preview-${j}-${Date.now()}`,type:"imagePreview",position:{x:b,y:q},data:{imageUrl:_,width:M,ratio:R,workflowContext:(Ie=W.data)==null?void 0:Ie.workflowContext,createdBy:(Ne=W.data)==null?void 0:Ne.createdBy}};re(Re=>[...Re,ue]);const H={id:`edge-${j}-${ue.id}`,source:j,target:ue.id,targetHandle:`${ue.id}-target`,type:"aurora"};K(Re=>Re.find(_e=>_e.source===j&&_e.target===ue.id)?Re:[...Re,H])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:cursor-not-allowed disabled:hover:shadow-md",title:ae==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(St,{type:"target",position:ut.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(St,{type:"source",position:ut.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-neutral-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Fo=t.memo(Wo),zo=({data:s,selected:j,id:n})=>{const[F,ye]=t.useState(s.config.upscaleResolution||"1080p"),[U,fe]=t.useState(!1),[Q,re]=t.useState(s.config.inputVideoUrl||""),[,K]=t.useState(s.config.taskId||""),{setNodes:ce,setEdges:Ue}=Zt(),he=Ds(),te=zs(),ae=de=>{ce(me=>me.map(Ee=>Ee.id===n?{...Ee,data:{...Ee.data,config:{...Ee.data.config,...de}}}:Ee))};t.useEffect(()=>{var me,Ee,Z;const de=te.filter(z=>z.target===n);if(de.length>0){const z=he.find(A=>A.id===de[0].source);if(z){const A=z.data,I=A.videoUrl||((me=A.config)==null?void 0:me.videoUrl)||((Ee=A.config)==null?void 0:Ee.outputVideoUrl)||((Z=A.config)==null?void 0:Z.resultUrl);I&&I!==Q&&(re(I),ae({inputVideoUrl:I}))}}else Q&&(re(""),ae({inputVideoUrl:""}))},[te,he,n]),t.useEffect(()=>{const de=s.config.taskId;(async()=>{if(de)try{const Z=(await Ce.get(`/tasks/${de}`)).task;if(Z.status==="SUCCESS"){const z=Z.resultUrl;ae({outputVideoUrl:z,taskId:""}),te.filter(m=>m.source===n).map(m=>he.find(c=>c.id===m.target)).filter(m=>m&&m.type==="videoPreview").find(m=>m.data.videoUrl===z)||ne(z),Gt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),fe(!1)}else Z.status==="PROCESSING"||Z.status==="PENDING"?(fe(!0),je(de)):Z.status==="FAILURE"&&(fe(!1),ae({taskId:""}),Gt.error(Z.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${Z.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{fe(!1),ae({taskId:""}),Gt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const je=async de=>{let Ee=0;const Z=async()=>{try{Ee++;const A=(await Ce.get(`/tasks/${de}`)).task;if(A.status==="SUCCESS"){const I=A.resultUrl;fe(!1),ae({outputVideoUrl:I,taskId:""}),ne(I),Gt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(A.status==="FAILURE"){fe(!1),ae({taskId:""}),Gt.error(A.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(A.status==="PROCESSING"||A.status==="PENDING")&&(Ee<300?setTimeout(Z,3e3):(fe(!1),ae({taskId:""}),Gt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{fe(!1),ae({taskId:""}),Gt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};Z()},ne=de=>{var Ee;const me=he.find(Z=>Z.id===n);if(me){const Z=`preview-video-${Date.now()}`,z=F==="1080p"?"HD":F,A={id:Z,type:"videoPreview",position:{x:me.position.x+400,y:me.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:de,ratio:"16:9",resolution:z,createdBy:(Ee=me.data)==null?void 0:Ee.createdBy}},I={id:`edge-${n}-${Z}`,source:n,target:Z,type:"aurora"};ce(G=>[...G,A]),setTimeout(()=>{Ue(G=>[...G,I])},100)}},pe=async()=>{var de,me;if(!Q){Gt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}fe(!0);try{const Ee=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!Ee||Ee.length===0){Gt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),fe(!1);return}const Z=Ee[0],A=(await Ce.post("/ai/video-upscale",{video_url:Q,upscale_resolution:F,apiKey:Z.apiKey,apiUrl:Z.apiUrl})).taskId;K(A),ae({taskId:A,upscaleResolution:F}),Gt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),je(A)}catch(Ee){const Z=((me=(de=Ee.response)==null?void 0:de.data)==null?void 0:me.error)||Ee.message||"æœªçŸ¥åŸå› ";Gt.error(`å¯åŠ¨å¤±è´¥ï¼š${Z}ï¼Œè¯·ç¨åé‡è¯•`),fe(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(us,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[Q&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:Q,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(de=>e.jsx("button",{type:"button",onClick:()=>{ye(de),ae({upscaleResolution:de})},disabled:U,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${F===de?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${U?"cursor-not-allowed":""}`,children:de},de))})]}),e.jsx("button",{type:"button",onClick:de=>{de.preventDefault(),de.stopPropagation(),pe()},onMouseDown:de=>{de.stopPropagation()},disabled:U||!Q||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${U||!Q||s._canEdit===!1?"bg-neutral-300 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[U?e.jsx(Ms,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:U?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(us,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Bo=t.memo(zo),Ho=({data:s,selected:j,id:n})=>{const[F,ye]=t.useState(s.config.prompt||""),[U,fe]=t.useState(s.config.duration||30),[Q,re]=t.useState(s.config.ratio||"16:9"),[K,ce]=t.useState(s.config.language||"zh"),[Ue,he]=t.useState(!1),[te,ae]=t.useState(s.config.images||[]),[,je]=t.useState(s.config.taskId||""),{credits:ne,loading:pe}=Us({nodeType:"ad_composition",duration:U}),{setNodes:de,setEdges:me}=Zt(),Ee=Ds(),Z=zs(),z=m=>{de(c=>c.map(S=>S.id===n?{...S,data:{...S.data,config:{...S.data.config,...m}}}:S))};t.useEffect(()=>{const m=Z.filter(S=>S.target===n),c=[];m.forEach(S=>{var $,N,O,r,v,g,a,y,d,x;const P=Ee.find(p=>p.id===S.source);P&&(P.type==="imagePreview"&&(($=P.data)!=null&&$.imageUrl)?c.push(P.data.imageUrl):P.type==="aiImage"&&((O=(N=P.data)==null?void 0:N.config)!=null&&O.generatedImageUrl)?c.push(P.data.config.generatedImageUrl):P.type==="upload"&&((v=(r=P.data)==null?void 0:r.config)!=null&&v.uploadedFiles)?P.data.config.uploadedFiles.filter(w=>w.type==="IMAGE"||(w.mimeType||"").startsWith("image/")).forEach(w=>c.push(w.url)):P.type==="assetSelector"&&((a=(g=P.data)==null?void 0:g.config)!=null&&a.subjects?P.data.config.subjects.forEach(w=>{Array.isArray(w.images)&&w.images.forEach(R=>c.push(R.url))}):((x=(d=(y=P.data)==null?void 0:y.config)==null?void 0:d.selectedAsset)==null?void 0:x.type)==="IMAGE"&&c.push(P.data.config.selectedAsset.url)))}),JSON.stringify(c)!==JSON.stringify(te)&&(ae(c),z({images:c}))},[Z,Ee,n]),t.useEffect(()=>{const m=s.config.taskId;(async()=>{if(m)try{const P=(await Ce.get(`/tasks/${m}`)).task;if(P.status==="SUCCESS"){const $=P.resultUrl;z({taskId:""}),he(!1)}else P.status==="PROCESSING"||P.status==="PENDING"?(he(!0),A(m)):P.status==="FAILURE"&&(he(!1),z({taskId:""}),Gt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${P.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{he(!1),z({taskId:""})}})()},[]);const A=async m=>{let S=0;const P=async()=>{try{S++;const N=(await Ce.get(`/tasks/${m}`)).task;if(N.status==="SUCCESS"){const O=N.resultUrl;he(!1),z({taskId:""}),I(O),Gt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(N.status==="FAILURE"){he(!1),z({taskId:""}),Gt.error(N.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(N.status==="PROCESSING"||N.status==="PENDING")&&(S<120?setTimeout(P,1e4):(he(!1),z({taskId:""}),Gt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{he(!1),z({taskId:""}),Gt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};P()},I=m=>{var S;const c=Ee.find(P=>P.id===n);if(c){const P=`preview-video-${Date.now()}`,$={id:P,type:"videoPreview",position:{x:c.position.x+400,y:c.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:m,ratio:Q,width:320,createdBy:(S=c.data)==null?void 0:S.createdBy}},N={id:`edge-${n}-${P}`,source:n,target:P,type:"aurora"};de(O=>[...O,$]),setTimeout(()=>{me(O=>[...O,N])},100)}},G=async()=>{var m,c,S,P,$;if(te.length===0){Gt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(te.length>15){Gt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!F.trim()){Gt.error("è¯·è¾“å…¥æç¤ºè¯");return}he(!0);try{const N=await Ce.get("/ai/models?provider=vidu&isActive=true");if(!N||N.length===0){Gt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),he(!1);return}const O=N[0],r={images:te,prompt:F,duration:U,ratio:Q,language:K,apiKey:O.apiKey,apiUrl:O.apiUrl},v=await Ce.post("/ai/commercial-video",r),g=v.taskId,a=v.creditsCharged||0;if(je(g),z({taskId:g,images:te,prompt:F,duration:U,ratio:Q,language:K}),a>0)try{const{useAuthStore:y}=await xs(async()=>{const{useAuthStore:x}=await import("./index-DRJ_08Rm.js").then(p=>p.f);return{useAuthStore:x}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:d}=y.getState();await d(),Gt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${a} ç§¯åˆ†ï¼‰`)}catch{Gt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Gt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");A(g)}catch(N){((m=N.response)==null?void 0:m.status)===403?Gt.error(((S=(c=N.response)==null?void 0:c.data)==null?void 0:S.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Gt.error((($=(P=N.response)==null?void 0:P.data)==null?void 0:$.error)||N.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),he(!1)}};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(us,{type:"target",position:ut.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",te.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:F,onChange:m=>{ye(m.target.value),z({prompt:m.target.value}),m.target.style.height="auto",m.target.style.height=m.target.scrollHeight+"px"},onFocus:m=>{m.target.style.height="auto",m.target.style.height=m.target.scrollHeight+"px"},ref:m=>{m&&F&&(m.style.height="auto",m.style.height=m.scrollHeight+"px")},disabled:Ue,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(m=>e.jsxs("button",{type:"button",onClick:()=>{fe(m),z({duration:m})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${U===m?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ue?"cursor-not-allowed":""}`,children:[m,"s"]},m))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(m=>e.jsx("button",{type:"button",onClick:()=>{re(m),z({ratio:m})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Q===m?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ue?"cursor-not-allowed":""}`,children:m},m))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(m=>e.jsx("button",{type:"button",onClick:()=>{ce(m.value),z({language:m.value})},disabled:Ue,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${K===m.value?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white":"bg-neutral-200 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-300 hover:bg-neutral-300 dark:hover:bg-neutral-700"} ${Ue?"cursor-not-allowed":""}`,children:m.label},m.value))})]}),e.jsx("button",{type:"button",onClick:G,disabled:Ue||te.length===0||!F.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Ue||te.length===0||!F.trim()||s._canEdit===!1?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed":"bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Ue?e.jsx(Ms,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),e.jsx("span",{children:Ue?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Ue&&!pe&&ne!==null&&ne>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[ne,"ç§¯åˆ†"]})]})})]}),e.jsx(us,{type:"source",position:ut.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Xo=t.memo(Ho),Jo=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],qo=({data:s,selected:j,id:n})=>{const{setNodes:F}=Zt(),[ye,U]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[fe,Q]=t.useState(!1),[re,K]=t.useState(!1),[ce,Ue]=t.useState(s.fontSize||36),[he,te]=t.useState(s.width||200),[ae,je]=t.useState(s.bold||!1),ne=t.useRef(null),pe=t.useRef(null),de=t.useCallback(Z=>{F(z=>z.map(A=>A.id===n?{...A,data:{...A.data,...Z}}:A))},[n,F]);t.useEffect(()=>{const Z=setTimeout(()=>{ye!==s.text&&de({text:ye})},300);return()=>clearTimeout(Z)},[ye,s.text,de]),t.useEffect(()=>{de({fontSize:ce,width:he,bold:ae})},[ce,he,ae,de]);const me=()=>{Q(!0),setTimeout(()=>{ne.current&&(ne.current.focus(),ne.current.select(),ne.current.style.height="auto",ne.current.style.height=`${ne.current.scrollHeight}px`)},0)},Ee=()=>{Q(!1)};return t.useEffect(()=>{fe&&ne.current&&(ne.current.style.height="auto",ne.current.style.height=`${ne.current.scrollHeight}px`)},[fe,ye]),t.useEffect(()=>{const Z=z=>{pe.current&&!pe.current.contains(z.target)&&K(!1)};return re&&document.addEventListener("mousedown",Z),()=>document.removeEventListener("mousedown",Z)},[re]),e.jsxs("div",{className:`relative group ${j?"ring-2 ring-neutral-400 ring-offset-2":""}`,style:{width:he},children:[e.jsx(gs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:Z=>{Z.stopPropagation(),K(!re)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),re&&e.jsxs("div",{ref:pe,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:Z=>Z.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:ce,onChange:Z=>Ue(Number(Z.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-neutral-400",children:Jo.map(Z=>e.jsxs("option",{value:Z,children:[Z,"px"]},Z))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>je(!ae),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${ae?"bg-neutral-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),fe?e.jsx("textarea",{ref:ne,value:ye,onChange:Z=>U(Z.target.value),onBlur:Ee,onMouseDown:Z=>Z.stopPropagation(),onKeyDown:Z=>{Z.key==="Escape"&&Q(!1)},className:"nodrag w-full bg-transparent border-2 border-neutral-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:ae?"bold":"normal"}}):e.jsx("div",{onDoubleClick:me,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${ce}px`,fontWeight:ae?"bold":"normal"},children:ye}),!fe&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:Z=>{Z.stopPropagation(),Z.preventDefault();const z=Z.clientX,A=he,I=m=>{m.preventDefault();const c=Math.max(100,A+(m.clientX-z));te(c)},G=()=>{document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",G)};document.addEventListener("mousemove",I),document.addEventListener("mouseup",G)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Yo=t.memo(qo),Ko=({data:s,id:j,selected:n})=>{const{getNode:F,setNodes:ye,setEdges:U}=Zt(),fe=Fs(t.useCallback(l=>l.edges.filter(i=>i.target===j),[j])),[Q,re]=t.useState(s.prompt||""),[K,ce]=t.useState(s.points||[]),[Ue,he]=t.useState(!1),[te,ae]=t.useState(!1),[je,ne]=t.useState(null),[pe,de]=t.useState([]),[,me]=t.useState(s.generatedImageUrl||null),[Ee,Z]=t.useState(null),[,z]=t.useState(s.taskId||""),[,A]=t.useState(0),I=t.useRef(null),G=t.useRef(1),{credits:m,loading:c,isFreeUsage:S,freeUsageRemaining:P,refetch:$}=Us({nodeType:"image_editing",quantity:1}),N=t.useCallback(l=>{ye(i=>i.map(B=>B.id===j?{...B,data:{...B.data,...l}}:B))},[j,ye]),O=Fs(t.useCallback(l=>l.edges.filter(i=>i.source===j),[j])),r=t.useCallback(l=>{var ie,xe;const i=F(j);if(!i)return;const B=O.find(oe=>{const k=F(oe.target);return(k==null?void 0:k.type)==="imagePreview"});if(B){const oe=B.target;ye(k=>k.map(u=>u.id===oe?{...u,data:{...u.data,imageUrl:l}}:u));return}const M=Date.now(),X=`preview-${j}-${M}`,V={id:X,type:"imagePreview",position:{x:(((ie=i==null?void 0:i.position)==null?void 0:ie.x)||0)+450,y:((xe=i==null?void 0:i.position)==null?void 0:xe.y)||0},data:{imageUrl:l,width:400}};setTimeout(()=>{ye(k=>[...k,V]);const oe={id:`edge-${j}-${X}`,source:j,target:X,targetHandle:`${X}-target`,type:"aurora"};U(k=>k.find(E=>E.source===j&&E.target===X)?k:[...k,oe])},100)},[j,F,ye,U,O]),v=t.useRef({active:!1,timeoutId:null}),g=t.useCallback(async l=>{let B=0;v.current.timeoutId&&clearTimeout(v.current.timeoutId),v.current.active=!0;const M=async()=>{if(v.current.active)try{B++;const V=(await Ce.tasks.getTaskStatus(l)).task;if(!v.current.active)return;if(A(V.progress||0),V.status==="SUCCESS"){v.current.active=!1,he(!1),A(100);const ie=V.resultUrl;N({generatedImageUrl:ie,taskId:""}),me(ie),f.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ie&&r(ie);return}else if(V.status==="FAILURE"){v.current.active=!1,he(!1),A(0),N({taskId:""}),f.error(V.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(V.status==="PROCESSING"||V.status==="PENDING")&&(B<300&&v.current.active?v.current.timeoutId=setTimeout(M,1e3):(v.current.active=!1,he(!1),A(0),N({taskId:""}),f.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{v.current.active=!1,he(!1),A(0),N({taskId:""}),f.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};M()},[N,r]);t.useEffect(()=>()=>{v.current.active=!1,v.current.timeoutId&&clearTimeout(v.current.timeoutId)},[]),t.useEffect(()=>{const l=s.taskId;if(!l)return;(async()=>{try{const M=(await Ce.tasks.getTaskStatus(l)).task;if(M.status==="SUCCESS"){he(!1),A(100);const X=M.resultUrl;X?(N({generatedImageUrl:X,taskId:""}),me(X),f.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):N({taskId:""})}else M.status==="PROCESSING"||M.status==="PENDING"?(he(!0),A(M.progress||0),g(l)):M.status==="FAILURE"&&(he(!1),A(0),N({taskId:""}),f.error(M.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${M.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{he(!1),A(0),N({taskId:""})}})()},[]);const a=t.useCallback(l=>{const i=new Image;i.onload=()=>{Z({width:i.naturalWidth,height:i.naturalHeight})},i.src=l},[]);t.useEffect(()=>{try{const l=[];fe.forEach(i=>{var V,ie,xe,oe;const B=F(i.source);if(!B)return;const M=B.data;let X=null;M!=null&&M.url?X=M.url:M!=null&&M.imageUrl?X=M.imageUrl:M!=null&&M.output?X=M.output:(V=M==null?void 0:M.config)!=null&&V.generatedImageUrl?X=M.config.generatedImageUrl:(oe=(xe=(ie=M==null?void 0:M.config)==null?void 0:ie.uploadedFiles)==null?void 0:xe[0])!=null&&oe.url&&(X=M.config.uploadedFiles[0].url),X&&l.push(X)}),l.length>0?(ne(l[0]),de(l.slice(1)),a(l[0])):(ne(null),de([]),Z(null))}catch{}},[fe,F,a]),t.useEffect(()=>{const l=setTimeout(()=>{ye(i=>i.map(B=>{if(B.id!==j)return B;const M=B.data;return M.prompt===Q&&JSON.stringify(M.points)===JSON.stringify(K)?B:{...B,data:{...B.data,prompt:Q,points:K}}}))},300);return()=>clearTimeout(l)},[Q,K,j,ye]);const y=t.useCallback(l=>{if(!l.ctrlKey&&!l.metaKey||!I.current)return;const i=I.current.getBoundingClientRect(),B=(l.clientX-i.left)/i.width,M=(l.clientY-i.top)/i.height,X={id:G.current++,x:Math.max(0,Math.min(1,B)),y:Math.max(0,Math.min(1,M))};ce(V=>[...V,X])},[]),d=t.useCallback(l=>{ce(i=>i.filter(B=>B.id!==l))},[]),x=t.useCallback((l,i)=>{ce(B=>B.map(M=>M.id===l?{...M,name:i}:M))},[]),p=t.useCallback((l,i)=>{l.stopPropagation();const B=i.name?`@${i.name}`:`@ä½ç½®${i.id}`;l.dataTransfer.setData("text/plain",B),l.dataTransfer.effectAllowed="copy"},[]),w=t.useCallback((l,i)=>{l.stopPropagation();const B=`@å‚è€ƒå›¾${i+1}`;l.dataTransfer.setData("text/plain",B),l.dataTransfer.effectAllowed="copy"},[]),R=t.useCallback(l=>{l.preventDefault(),l.stopPropagation(),l.dataTransfer.dropEffect="copy"},[]),W=t.useCallback(l=>{l.preventDefault(),l.stopPropagation();const i=l.dataTransfer.getData("text/plain");if(i){const B=l.target,M=B.selectionStart,X=B.selectionEnd,V=Q.slice(0,M)+i+Q.slice(X);re(V),setTimeout(()=>{B.selectionStart=B.selectionEnd=M+i.length,B.focus()},0)}},[Q]),_=t.useCallback(async()=>{var l;if(!(!je||K.length===0)){ae(!0);try{const i=await Ce.ai.imageEditing.identifyPoints({image:je,points:K.map(B=>({id:B.id,x:B.x,y:B.y}))});if(i.success&&((l=i.data)!=null&&l.points)){const B=i.data.points;ce(M=>M.map(X=>{const V=B.find(ie=>ie.id===X.id);return V?{...X,name:V.name}:X})),f.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{f.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{ae(!1)}}},[je,K]),h=t.useCallback(async()=>{var l,i,B,M,X;if(!je){f.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!Q.trim()){f.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}he(!0),A(0);try{const V=await Ce.tasks.createImageEditTask({prompt:Q.trim(),mainImage:je,referenceImages:pe.length>0?pe:void 0,points:K.length>0?K:void 0,sourceImageDimensions:Ee||void 0,sourceNodeId:j}),ie=V.taskId,xe=V.creditsCharged||0,oe=V.isFreeUsage,k=V.freeUsageRemaining??0;if(z(ie),N({prompt:Q.trim(),points:K,taskId:ie}),oe)f.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${k} æ¬¡æœºä¼š`),$();else if(xe>0){const{useAuthStore:u}=await xs(async()=>{const{useAuthStore:b}=await import("./index-DRJ_08Rm.js").then(q=>q.f);return{useAuthStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:E}=u.getState();await E(),f.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${xe} ç§¯åˆ†`),$()}else f.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");g(ie)}catch(V){if(he(!1),A(0),((l=V.response)==null?void 0:l.status)===403){const ie=((B=(i=V.response)==null?void 0:i.data)==null?void 0:B.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";f.error(ie)}else{const ie=((X=(M=V.response)==null?void 0:M.data)==null?void 0:X.error)||V.message||"æœªçŸ¥åŸå› ";f.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ie}ï¼Œè¯·ç¨åé‡è¯•`)}}},[je,Q,pe,K,Ee,j,N,g,$]);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${n?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(St,{type:"target",position:ut.Left,id:`${j}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(St,{type:"source",position:ut.Right,id:`${j}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Br,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:I,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:y,children:je?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:je,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),K.map(l=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-neutral-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${l.x*100}%`,top:`${l.y*100}%`},onClick:i=>{i.stopPropagation(),d(l.id)},title:l.name||`ç‚¹å‡»åˆ é™¤ #${l.id}`,children:l.id},l.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ir,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),pe.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[pe.map((l,i)=>e.jsx("img",{src:l,alt:`Ref ${i+1}`,draggable:!0,onDragStart:B=>w(B,i),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},i)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",pe.length," å‚è€ƒå›¾"]})]}),K.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",K.length,")"]}),e.jsxs("button",{onClick:_,disabled:te||!je,className:"text-[10px] text-neutral-500 hover:text-neutral-600 flex items-center gap-1",children:[te?e.jsx(Ms,{className:"w-3 h-3 animate-spin"}):e.jsx(fr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:K.map(l=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:i=>p(i,l),className:"w-5 h-5 bg-neutral-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:l.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:l.name||"",onChange:i=>x(l.id,i.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>d(l.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(zr,{className:"w-3 h-3"})})]},l.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:Q,onChange:l=>re(l.target.value),onDragOver:R,onDrop:W,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:h,onPointerDown:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),disabled:Ue||!je||!Q.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Ue||!je||!Q.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Ue?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(fr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!c&&(S?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(P),"æ¬¡"]}):m!==null&&m>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[m,"ç§¯åˆ†"]}):null)]})})]})]})},Zo=t.memo(Ko);async function cr(s){const{resultUrl:j,allImageUrls:n}=s;return{displayUrl:j,allDisplayUrls:n,isLocalStored:!1,originalUrl:j}}const Qo="gemini-3-pro-image-preview",en=["21:9","16:9","4:3","3:2","1:1","2:3","3:4","9:16","9:21"],tn=s=>{const[j,n]=s.split(":").map(Number);return j/n},sn=(s,j)=>{const n=s/j;let F="1:1",ye=1/0;for(const U of en){const fe=tn(U),Q=Math.abs(n-fe);Q<ye&&(ye=Q,F=U)}return F},rn=s=>new Promise((j,n)=>{const F=new Image;F.onload=()=>{j({width:F.naturalWidth,height:F.naturalHeight})},F.onerror=n,F.src=s}),an=({data:s,selected:j,id:n})=>{const[F,ye]=t.useState(s.config.imageSize||"2K"),[U,fe]=t.useState(s.config.inputImage),[Q,re]=t.useState(!!s.config.taskId),[K,ce]=t.useState(null),Ue=t.useMemo(()=>{const Z=s.models||[];return Z.find(z=>z.modelId===Qo)||Z.find(z=>{var A;return(A=z.modelId)==null?void 0:A.includes("gemini")})||Z[0]},[s.models]);t.useEffect(()=>{Ue&&ce(Ue)},[Ue]);const{setNodes:he,setEdges:te,getNode:ae,getNodes:je}=Zt(),ne=Fs(Z=>Z.edges.filter(z=>z.target===n));t.useEffect(()=>{const Z=je();let z;ne.forEach(A=>{var G,m,c,S,P,$;const I=Z.find(N=>N.id===A.source);if(I){const N=((G=I.data)==null?void 0:G.imageUrl)||((c=(m=I.data)==null?void 0:m.config)==null?void 0:c.generatedImageUrl)||((P=(S=I.data)==null?void 0:S.config)==null?void 0:P.imageUrl)||(($=I.data)==null?void 0:$.url);N&&(z=N)}}),z!==U&&(fe(z),pe({inputImage:z}))},[ne,je]),t.useEffect(()=>{const Z=s.config.taskId;(async()=>{if(Z)try{const I=(await Ce.tasks.getTaskStatus(Z)).task;if(I.status==="SUCCESS"){re(!1);const G=I.resultUrl;if(!G){pe({taskId:""});return}const c=(await cr({taskId:Z,resultUrl:G,type:"IMAGE"})).displayUrl;pe({generatedImageUrl:c,taskId:""})}else I.status==="PROCESSING"||I.status==="PENDING"?(re(!0),me(Z)):I.status==="FAILURE"&&(re(!1),pe({taskId:""}),Gs.error(`ç”Ÿæˆå¤±è´¥: ${I.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{re(!1),pe({taskId:""}),Gs.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const pe=Z=>{he(z=>z.map(A=>A.id===n?{...A,data:{...A.data,config:{...A.data.config,...Z}}}:A))},de=async()=>{var Z;if(!U){Gs.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡");return}re(!0);try{const z=await dr(U);let A="1:1";try{const c=await rn(U);A=sn(c.width,c.height)}catch{}let I="";try{const c=await Ce.get("/node-prompts/type/hdUpscale");c.success&&((Z=c.data)!=null&&Z.userPromptTemplate)&&(I=c.data.userPromptTemplate)}catch{}if(I||(I="å°†è¿™å¼ å›¾ç‰‡è¿›è¡Œé«˜æ¸…æ”¾å¤§ï¼Œä¿æŒåŸæœ‰çš„ç”»é¢å†…å®¹ã€æ„å›¾å’Œé£æ ¼ä¸å˜ï¼Œæå‡å›¾ç‰‡çš„æ¸…æ™°åº¦å’Œç»†èŠ‚"),I=`${I}ï¼Œç”Ÿæˆ${A}æ¯”ä¾‹çš„å›¾ç‰‡`,!K){Gs.error("æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),re(!1);return}const G=await Ce.tasks.createImageTask({modelId:K.id,prompt:I,ratio:A,referenceImages:[z],sourceNodeId:n,metadata:{imageSize:F}});if(!G.success)throw new Error(G.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const m=G.taskId;pe({taskId:m}),me(m)}catch(z){Gs.error(z.message||"ç”Ÿæˆå¤±è´¥"),re(!1)}},me=async Z=>{let A=0;const I=async()=>{try{const m=(await Ce.tasks.getTaskStatus(Z)).task;if(m.status==="SUCCESS"){re(!1);const c=m.resultUrl;if(!c){Gs.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const P=(await cr({taskId:Z,resultUrl:c,type:"IMAGE"})).displayUrl;pe({generatedImageUrl:P,taskId:"",imageSize:F}),Ee(P),Gs.success("é«˜æ¸…æ”¾å¤§å®Œæˆï¼")}else m.status==="FAILURE"?(re(!1),pe({taskId:""}),Gs.error(`ç”Ÿæˆå¤±è´¥: ${m.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(m.status==="PROCESSING"||m.status==="PENDING")&&(A++,A<300?setTimeout(I,2e3):(re(!1),Gs.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{re(!1),Gs.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};I()},Ee=Z=>{const z=ae(n);if(!z)return;const G=je().filter($=>$.id.startsWith(`${n}-preview`)&&$.type==="imagePreview").length,S={id:`${n}-preview-${Date.now()}`,type:"imagePreview",position:{x:z.position.x+380,y:z.position.y+G*(220+20)},data:{imageUrl:Z,ratio:"1:1",label:"é«˜æ¸…æ”¾å¤§ç»“æœ",sourceNodeId:n,createdBy:z.data.createdBy}},P={id:`edge-${n}-to-${S.id}`,source:n,target:S.id,sourceHandle:`${n}-source`,type:"aurora"};he($=>[...$,S]),te($=>[...$,P])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(us,{type:"target",position:ut.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(us,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[U&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å…¥å›¾ç‰‡"}),e.jsx("div",{className:"w-full h-32 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:e.jsx("img",{src:U,alt:"è¾“å…¥",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¾“å‡ºåˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{ye("2K"),pe({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{ye("4K"),pe({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${F==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsx("button",{onClick:de,onPointerDown:Z=>Z.stopPropagation(),onMouseDown:Z=>Z.stopPropagation(),disabled:Q||!U||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${Q||!U?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"å¤„ç†ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"high_quality"}),e.jsx("span",{children:"é«˜æ¸…æ”¾å¤§"})]})})]})]})},on=t.memo(an),Xr=async(s,j,n)=>new Promise((F,ye)=>{const U=new Image;U.crossOrigin="Anonymous",U.onload=()=>{try{const fe=U.width,Q=U.height,re=Math.floor(fe/n),K=Math.floor(Q/j),ce=[],Ue=document.createElement("canvas");Ue.width=re,Ue.height=K;const he=Ue.getContext("2d");if(!he){ye(new Error("æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"));return}for(let te=0;te<j;te++)for(let ae=0;ae<n;ae++)he.clearRect(0,0,re,K),he.drawImage(U,ae*re,te*K,re,K,0,0,re,K),ce.push(Ue.toDataURL("image/png"));F({slices:ce,fullImage:s,rows:j,cols:n})}catch(fe){ye(fe)}},U.onerror=()=>{ye(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},s.startsWith("data:"),U.src=s}),Fr=s=>{switch(s){case"grid2x2":return{rows:2,cols:2};case"grid3x3":return{rows:3,cols:3};case"single":default:return{rows:1,cols:1}}},nn=(s,j="image/png")=>{const n=s.includes(",")?s.split(",")[1]:s,F=atob(n),ye=new Array(F.length);for(let fe=0;fe<F.length;fe++)ye[fe]=F.charCodeAt(fe);const U=new Uint8Array(ye);return new Blob([U],{type:j})},ln=({data:s,selected:j,id:n})=>{const[F,ye]=t.useState(null),U="single",[fe,Q]=t.useState(s.config.aspectRatio||"16:9"),[re,K]=t.useState(s.config.imageSize||"4K"),[ce,Ue]=t.useState(s.config.userPrompt||""),[he,te]=t.useState(!!s.config.taskId),[ae,je]=t.useState(s.config.characterImages||[]),[ne,pe]=t.useState(s.config.sceneImages||[]),[de,me]=t.useState(s.config.styleImage),Ee=t.useRef(null),{setNodes:Z,setEdges:z,getNode:A,getNodes:I,getEdges:G}=Zt(),m=Fs(_=>_.edges.filter(h=>h.target===n)),c=Fs(_=>_.edges.some(h=>h.target===n&&h.targetHandle===`${n}-scene-input`)),S=Fs(_=>_.edges.some(h=>h.target===n&&h.targetHandle===`${n}-style-input`)),P=t.useRef(""),{credits:$,loading:N,isFreeUsage:O,freeUsageRemaining:r}=Us({aiModelId:F==null?void 0:F.id,quantity:1,resolution:re}),v="gemini-3-pro-image-preview",g=t.useMemo(()=>{const _=s.models||[];return _.find(h=>h.modelId===v)||_.find(h=>{var l;return(l=h.modelId)==null?void 0:l.includes("gemini")})||_[0]},[s.models]);t.useEffect(()=>{g&&ye(g)},[g]),t.useEffect(()=>{const _=s.config.taskId,h=s.config.generatedImageUrl;(async()=>{if(_)try{const B=(await Ce.tasks.getTaskStatus(_)).task;if(B.status==="SUCCESS"){te(!1);const M=B.resultUrl;if(!M){a({taskId:""}),f.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}let X=M;h?X=h:X=(await cr({taskId:_,resultUrl:M,type:"IMAGE"})).displayUrl,a({generatedImageUrl:X,taskId:""});const V=I(),ie=G();if(V.filter(k=>k.type==="imagePreview"&&ie.some(u=>u.source===n&&u.target===k.id)).find(k=>k.data.imageUrl===X||k.data.imageUrl===M)){f.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}f.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼"),R(X,fe,0)}else B.status==="PROCESSING"||B.status==="PENDING"?(te(!0),p(_)):B.status==="FAILURE"&&(te(!1),a({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${B.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{te(!1),a({taskId:""}),f.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]),t.useEffect(()=>{if(Ee.current&&ce){const _=Ee.current;_.style.height="auto",_.style.height=`${_.scrollHeight}px`}},[]);const a=_=>{Z(h=>h.map(l=>l.id===n?{...l,data:{...l.data,config:{...l.data.config,..._}}}:l))};t.useEffect(()=>{const _=JSON.stringify(m.map(B=>({source:B.source,sourceHandle:B.sourceHandle,targetHandle:B.targetHandle})));if(_===P.current)return;P.current=_;const h=[],l=[];let i;m.forEach(B=>{const M=A(B.source);if(!M)return;const X=B.targetHandle||"",V=y(M);X.includes("character")?h.push(...V):X.includes("scene")?l.length===0&&V.length>0&&l.push(V[0]):X.includes("style")&&V.length>0&&(i=V[0])}),je(h),pe(l),me(i),a({characterImages:h,sceneImages:l,styleImage:i})},[m,A]);const y=_=>{var i,B,M,X;const h=(_==null?void 0:_.type)||"",l=_==null?void 0:_.data;if(h==="upload"&&((i=l==null?void 0:l.config)!=null&&i.uploadedFiles))return l.config.uploadedFiles.filter(V=>{var ie;return V.type==="IMAGE"||((ie=V.mimeType)==null?void 0:ie.startsWith("image/"))}).map(V=>V.url||V.localUrl);if(h==="assetSelector"&&((B=l==null?void 0:l.config)!=null&&B.selectedAsset)){const V=l.config.selectedAsset;if(V.type==="IMAGE"||(M=V.mimeType)!=null&&M.startsWith("image/"))return[V.url]}return h==="imagePreview"&&(l!=null&&l.imageUrl)?[l.imageUrl]:h==="aiImage"&&((X=l==null?void 0:l.config)!=null&&X.generatedImageUrl)?[l.config.generatedImageUrl]:[]},d=()=>{let _=ce;if(de){const h=ae.length+ne.length+1;_+=`ï¼Œå‚è€ƒå›¾ç‰‡${h}çš„è‰²è°ƒä¸é£æ ¼ï¼Œä¸å…è®¸ä½¿ç”¨å›¾ç‰‡${h}çš„åœºæ™¯ï¼Œæ‰€æœ‰å…ƒç´ ä¿æŒåˆç†çš„å°ºå¯¸ä¸æ¯”ä¾‹`}return _+=`ï¼Œç”Ÿæˆ${fe}æ¯”ä¾‹çš„å›¾ç‰‡`,_},x=async()=>{if(!ce.trim()){f.error("è¯·è¾“å…¥åœºæ™¯æè¿°");return}if(!F){f.error("è¯·é€‰æ‹©æ¨¡å‹");return}te(!0);try{const _=d(),h=[...ae,...ne,...de?[de]:[]],l=await Promise.all(h.map(async M=>{try{return await dr(M)}catch{return M}})),i=await Ce.tasks.createImageTask({modelId:F.id,prompt:_,ratio:fe,referenceImages:l.filter(Boolean),sourceNodeId:n,metadata:{imageSize:re}});if(!i.success)throw new Error(i.message||"åˆ›å»ºä»»åŠ¡å¤±è´¥");const B=i.taskId;a({taskId:B}),p(B)}catch(_){f.error(_.message||"ç”Ÿæˆå¤±è´¥"),te(!1)}},p=async _=>{let l=0;const i=async()=>{try{const M=(await Ce.tasks.getTaskStatus(_)).task;if(M.status==="SUCCESS"){te(!1);const X=M.resultUrl;if(!X){f.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const ie=(await cr({taskId:_,resultUrl:X,type:"IMAGE"})).displayUrl;a({generatedImageUrl:ie,taskId:"",modelId:F==null?void 0:F.id,mode:U,aspectRatio:fe,imageSize:re,userPrompt:ce}),U!=="single"||R(ie,fe,0),f.success("å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼")}else M.status==="FAILURE"?(te(!1),a({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${M.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(M.status==="PROCESSING"||M.status==="PENDING")&&(l++,l<300?setTimeout(i,2e3):(te(!1),f.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{te(!1),f.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};i()},w=async _=>{try{const{rows:h,cols:l}=Fr(U),i=await Xr(_,h,l);a({slicedImages:i.slices}),i.slices.forEach((B,M)=>{R(B,fe,M)})}catch(h){f.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+h.message)}},R=(_,h,l)=>{const i=A(n);if(!i)return;const{rows:B,cols:M}=Fr(U),X=B*M,V=280,ie=320,xe=20,oe=l%M,k=Math.floor(l/M),u=i.position.x+400,E=i.position.y-(X-1)*(ie+xe)/2,b={id:`${n}-preview-${l}-${Date.now()}`,type:"imagePreview",position:{x:u+oe*(V+xe),y:E+k*(ie+xe)},data:{imageUrl:_,ratio:h,label:`æº¶å›¾ ${l+1}`,fromStoryboard:!0,sourceNodeId:n}},q={id:`edge-${n}-to-${b.id}`,source:n,target:b.id,sourceHandle:`${n}-source`,type:"aurora"};Z(ue=>[...ue,b]),z(ue=>[...ue,q])},W=ae.length+ne.length+(de?1:0);return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsxs("div",{className:"absolute left-0 top-[25%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["è§’è‰² ",ae.length>0&&`(${ae.length})`]}),e.jsx(us,{type:"target",position:ut.Left,id:`${n}-character-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}),e.jsxs("div",{className:"absolute left-0 top-[50%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["åœºæ™¯ ",ne.length>0?"âœ“":""]}),e.jsx(us,{type:"target",position:ut.Left,id:`${n}-scene-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!c})]}),e.jsxs("div",{className:"absolute left-0 top-[75%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsxs("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:["é£æ ¼ ",de?"âœ“":""]}),e.jsx(us,{type:"target",position:ut.Left,id:`${n}-style-input`,style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isValidConnection:()=>!S})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),s._isSharedWorkflow&&s.createdBy&&e.jsx(gs,{createdBy:s.createdBy}),e.jsxs("div",{className:"p-4 space-y-4",children:[W>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",W,")"]}),e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:(()=>{let _=1;const h=[];return ae.forEach(l=>{h.push({url:l,type:"char",index:_++})}),ne.forEach(l=>{h.push({url:l,type:"scene",index:_++})}),de&&h.push({url:de,type:"style",index:_++}),h.map(l=>e.jsxs("div",{className:"relative w-12 h-12 rounded-md overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("img",{src:l.url,alt:`å›¾${l.index}`,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:l.index})]},`${l.type}-${l.index}`))})()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{K("2K"),a({imageSize:"2K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="2K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"hd"}),e.jsx("span",{children:"2K"})]})}),e.jsx("button",{onClick:()=>{K("4K"),a({imageSize:"4K"})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${re==="4K"?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"4k"}),e.jsx("span",{children:"4K"})]})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"].map(_=>e.jsx("button",{onClick:()=>{Q(_),a({aspectRatio:_})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${fe===_?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:_},_))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:Ee,value:ce,onChange:_=>{Ue(_.target.value),a({userPrompt:_.target.value});const h=_.target;h.style.height="auto",h.style.height=`${h.scrollHeight}px`},onFocus:_=>{const h=_.target;h.style.height="auto",h.style.height=`${h.scrollHeight}px`},placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",rows:2,className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-neutral-400 dark:focus:border-neutral-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:x,onPointerDown:_=>_.stopPropagation(),onMouseDown:_=>_.stopPropagation(),disabled:he||!ce.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${he||!ce.trim()?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:he?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(fr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!N&&(O?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",Math.floor(r),"æ¬¡"]}):$!==null&&$>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 text-neutral-400 dark:text-neutral-500 text-[9px]",children:[$,"ç§¯åˆ†"]}):null)]})})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(us,{type:"source",position:ut.Right,id:`${n}-source`,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})})]})},cn=t.memo(ln),dn=["16:9","21:9","1:1","9:16","9:21","4:3","3:4","3:2","2:3"],un="gemini-3-pro-preview",gn="gemini-3-pro-image-preview",jr=5,hn=({data:s,selected:j,id:n})=>{const[F,ye]=t.useState(s.config.aspectRatio||"1:1"),[U,fe]=t.useState(s.config.inputImages||[]),[Q,re]=t.useState(s.config.userPrompt||""),[K,ce]=t.useState(!!s.config.taskId),[Ue,he]=t.useState(null),[te,ae]=t.useState(null),je=t.useMemo(()=>{const c=s.models||[];return c.find(S=>S.modelId===gn)||c.find(S=>{var P;return(P=S.modelId)==null?void 0:P.includes("gemini")})||c[0]},[s.models]);t.useEffect(()=>{je&&ae(je)},[je]);const{setNodes:ne,setEdges:pe,getNode:de,getNodes:me}=Zt(),Ee=Fs(c=>c.edges.filter(S=>S.target===n)),Z=t.useRef("");t.useEffect(()=>{const c=me(),S=[];Ee.forEach($=>{var O,r,v,g,a,y,d,x;if(S.length>=jr)return;const N=c.find(p=>p.id===$.source);if(N){const p=(r=(O=N.data)==null?void 0:O.config)==null?void 0:r.uploadedFiles;Array.isArray(p)&&p.forEach(R=>{S.length>=jr||R!=null&&R.url&&!S.includes(R.url)&&S.push(R.url)});const w=((v=N.data)==null?void 0:v.imageUrl)||((a=(g=N.data)==null?void 0:g.config)==null?void 0:a.generatedImageUrl)||((d=(y=N.data)==null?void 0:y.config)==null?void 0:d.imageUrl)||((x=N.data)==null?void 0:x.url);w&&!S.includes(w)&&S.push(w)}});const P=S.join(",");P!==Z.current&&(Z.current=P,fe(S),z({inputImages:S}))},[Ee,me]),t.useEffect(()=>{const c=s.config.taskId;(async()=>{if(c)try{const $=(await Ce.tasks.getTaskStatus(c)).task;if($.status==="SUCCESS"){ce(!1);const N=$.resultUrl;if(!N){z({taskId:""});return}const r=(await cr({taskId:c,resultUrl:N,type:"IMAGE"})).displayUrl;z({generatedImageUrl:r,taskId:""}),me().some(a=>{var y;return((y=a.data)==null?void 0:y.sourceNodeId)===n&&a.type==="imagePreview"})||await G(r)}else $.status==="PROCESSING"||$.status==="PENDING"?(ce(!0),I(c)):$.status==="FAILURE"&&(ce(!1),z({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${$.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{ce(!1),z({taskId:""}),f.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const z=c=>{ne(S=>S.map(P=>P.id===n?{...P,data:{...P.data,config:{...P.data.config,...c}}}:P))},A=async()=>{var c,S;if(U.length===0){f.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(!Q.trim()){f.error("è¯·è¾“å…¥å‰§æƒ…ç®€è¿°");return}ce(!0),he("text");try{const P=await Promise.all(U.map(y=>dr(y))),$="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆ†é•œå¸ˆï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„å›¾ç‰‡å’Œå‰§æƒ…ç®€è¿°ï¼Œç”Ÿæˆè¯¦ç»†çš„9ä¸ªåˆ†é•œæè¿°ã€‚æ¯ä¸ªåˆ†é•œåº”åŒ…å«åœºæ™¯ã€åŠ¨ä½œã€é•œå¤´è§’åº¦ç­‰ä¿¡æ¯ã€‚",N="æ ¹æ®ä»¥ä¸‹åˆ†é•œæè¿°å’Œå‚è€ƒå›¾ç‰‡ï¼Œç”Ÿæˆ3x3çš„ä¹å®«æ ¼åˆ†é•œå›¾ï¼Œæ¯ä¸ªæ ¼å­å±•ç¤ºä¸€ä¸ªåˆ†é•œåœºæ™¯ï¼Œä¿æŒè§’è‰²å’Œé£æ ¼ä¸€è‡´ï¼Œä½¿ç”¨ç»†é»‘è¾¹æ¡†åˆ†éš”æ¯ä¸ªç”»é¢ã€‚",O=await Ce.ai.text.generate({modelId:un,systemPrompt:$,prompt:Q,imageUrls:P});if(!O.success)throw new Error(O.message||"æ–‡å­—ç”Ÿæˆå¤±è´¥");const r=((c=O.data)==null?void 0:c.text)||((S=O.data)==null?void 0:S.content)||O.content;if(!r||typeof r!="string")throw new Error("æ–‡å­—ç”Ÿæˆè¿”å›ä¸ºç©º");if(he("image"),!te){f.error("å›¾ç‰‡æ¨¡å‹æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•"),ce(!1),he(null);return}const v=`${N}

åˆ†é•œæè¿°ï¼š
${r}

ç”Ÿæˆ${F}æ¯”ä¾‹çš„å›¾ç‰‡`,g=await Ce.tasks.createImageTask({modelId:te.id,prompt:v,ratio:F,referenceImages:P,sourceNodeId:n,metadata:{imageSize:"4K"}});if(!g.success)throw new Error(g.message||"åˆ›å»ºå›¾ç‰‡ä»»åŠ¡å¤±è´¥");const a=g.taskId;z({taskId:a,userPrompt:Q}),I(a)}catch(P){f.error(P.message||"ç”Ÿæˆå¤±è´¥"),ce(!1),he(null)}},I=async c=>{let P=0;const $=async()=>{try{const O=(await Ce.tasks.getTaskStatus(c)).task;if(O.status==="SUCCESS"){ce(!1),he(null);const r=O.resultUrl;if(!r){f.error("ç”Ÿæˆå®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const g=(await cr({taskId:c,resultUrl:r,type:"IMAGE"})).displayUrl;z({generatedImageUrl:g,taskId:"",aspectRatio:F}),await G(g),f.success("åˆ†é•œç”Ÿæˆå®Œæˆï¼")}else O.status==="FAILURE"?(ce(!1),he(null),z({taskId:""}),f.error(`ç”Ÿæˆå¤±è´¥: ${O.errorMessage||"æœªçŸ¥é”™è¯¯"}`)):(O.status==="PROCESSING"||O.status==="PENDING")&&(P++,P<300?setTimeout($,2e3):(ce(!1),he(null),f.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{ce(!1),he(null),f.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};$()},G=async c=>{var S;try{let P=c;if(!c.startsWith("data:"))try{const O=await Ce.assets.proxyDownload(c),r=new Blob([O],{type:"image/png"});P=await new Promise((v,g)=>{const a=new FileReader;a.onloadend=()=>v(a.result),a.onerror=g,a.readAsDataURL(r)})}catch{}const $=await Xr(P,3,3),N=[];for(let O=0;O<$.slices.length;O++)try{const r=$.slices[O],v=nn(r,"image/png"),g=new File([v],`storyboard_${n}_slice_${O+1}_${Date.now()}.png`,{type:"image/png"}),a=await Ce.assets.upload(g);a.success&&((S=a.data)!=null&&S.url)?N.push(a.data.url):N.push(r)}catch{N.push($.slices[O])}z({slicedImages:N}),m(N,F)}catch(P){f.error("å›¾ç‰‡åˆ‡å‰²å¤±è´¥: "+P.message)}},m=(c,S)=>{const P=de(n);if(!P)return;const $=220,N=20,O=Date.now(),r=P.position.x+350,v=c.length*$+(c.length-1)*N,g=P.position.y-v/2+150,a=[],y=[];c.forEach((d,x)=>{const p={id:`${n}-slice-${O}-${x}`,type:"imagePreview",position:{x:r,y:g+x*($+N)},data:{imageUrl:d,ratio:S,label:`åˆ†é•œ ${x+1}`,fromStoryboard:!0,sourceNodeId:n,createdBy:P.data.createdBy}},w={id:`edge-${n}-to-slice-${O}-${x}`,source:n,target:p.id,sourceHandle:`${n}-source`,type:"aurora"};a.push(p),y.push(w)}),ne(d=>[...d,...a]),pe(d=>[...d,...y])};return e.jsxs("div",{className:`relative bg-white dark:bg-[#18181b] backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${j?"border-neutral-400 shadow-neutral-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none",children:e.jsx(us,{type:"target",position:ut.Left,id:`${n}-input`,style:{position:"relative",left:"-6px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair pointer-events-auto !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})}),e.jsx(us,{type:"source",position:ut.Right,id:`${n}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",style:{right:-6,top:"50%"}}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 rounded-t-2xl",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"grid_view"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[U.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",U.length,"/",jr,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:U.map((c,S)=>e.jsxs("div",{className:"nodrag relative group aspect-square",children:[e.jsx("img",{src:c,alt:`å›¾ç‰‡${S+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-neutral-400 dark:group-hover:border-neutral-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-neutral-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:S+1})]},S))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‰§æƒ…ç®€è¿°"}),e.jsx("textarea",{value:Q,onChange:c=>{re(c.target.value),z({userPrompt:c.target.value})},placeholder:"è¯·è¾“å…¥å‰§æƒ…ç®€è¿°ï¼Œæè¿°æ•…äº‹æƒ…èŠ‚ã€è§’è‰²åŠ¨ä½œç­‰...",className:"nodrag w-full h-20 px-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-slate-700 dark:text-white/90 placeholder-slate-400 dark:placeholder-white/30 resize-none focus:outline-none focus:ring-1 focus:ring-neutral-500",disabled:s._canEdit===!1})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:dn.map(c=>e.jsx("button",{onClick:()=>{ye(c),z({aspectRatio:c})},className:`nodrag py-1.5 rounded-lg text-[9px] font-medium transition-colors border ${F===c?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:c},c))})]}),e.jsx("button",{type:"button",onClick:c=>{c.stopPropagation(),A()},disabled:K,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all flex items-center justify-center gap-2 ${K?"bg-neutral-800 dark:bg-white text-white dark:text-black cursor-not-allowed border-transparent":"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-md hover:shadow-lg border-transparent dark:border-white/10 active:scale-95"}`,children:K?e.jsxs(e.Fragment,{children:[e.jsx(Ms,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:Ue==="text"?"åˆ†æå‰§æƒ…ä¸­...":"ç”Ÿæˆåˆ†é•œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"grid_view"}),e.jsx("span",{children:"æ™ºèƒ½åˆ†é•œ"})]})}),s.config.slicedImages&&s.config.slicedImages.length>0&&e.jsx("div",{className:"text-center py-1",children:e.jsxs("span",{className:"text-[10px] text-green-600 dark:text-green-400",children:["âœ“ å·²ç”Ÿæˆ ",s.config.slicedImages.length," ä¸ªåˆ†é•œ"]})})]})]})},pn=t.memo(hn),fn="https://api.waule.com",mn=({isOpen:s,onClose:j,onAssetSelect:n})=>{const[F,ye]=t.useState([]),[U,fe]=t.useState(""),[Q,re]=t.useState([]),[K,ce]=t.useState([]),[Ue,he]=t.useState(!1),[te,ae]=t.useState("ALL"),[je,ne]=t.useState("ALL");t.useEffect(()=>{s&&pe()},[s]),t.useEffect(()=>{U&&me(U)},[U]),t.useEffect(()=>{if(!s)return;const z=je==="ALL"?F:F.filter(A=>(A.category||"OTHER")===je);fe(z.length>0?z[0].id:"")},[je,F,s]);const pe=async()=>{try{const A=(await Ce.assetLibraries.getAll({includeShared:"true"})).data||[];if(ye(A),A.length>0&&!U){const I=je==="ALL"?A:A.filter(G=>(G.category||"OTHER")===je);fe((I[0]||A[0]).id)}}catch{f.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const z=A=>{var G;const I=((G=A==null?void 0:A.detail)==null?void 0:G.libraryId)||U;pe(),I&&me(I)};return window.addEventListener("asset-library-updated",z),()=>window.removeEventListener("asset-library-updated",z)},[U]);const de=z=>(/^https?:\/\//.test(z)?z:`${fn}${z}`).replace(".oss-oss-",".oss-"),me=async z=>{var A,I,G,m,c;he(!0);try{const S=F.find($=>$.id===z);if(S&&(S.category||"OTHER")==="ROLE"){const N=(await Ce.assetLibraries.roles.list(z)).data||[],O=[];for(const r of N){const v=r.metadata||{},g=[(A=v.images)==null?void 0:A.frontAssetId,(I=v.images)==null?void 0:I.sideAssetId,(G=v.images)==null?void 0:G.backAssetId,(m=v.images)==null?void 0:m.faceAssetId].filter(Boolean),a=[];for(const d of g)try{const p=(await Ce.assets.getById(d)).data;a.push({id:p.id,url:de(p.url),name:p.name})}catch{}const y=r.thumbnail?de(r.thumbnail):((c=a[0])==null?void 0:c.url)||"";O.push({id:r.id,name:r.name,coverUrl:y,images:a})}ce(O),re([])}else{const N=(await Ce.assetLibraries.getAssets(z)).data||[];re(N),ce([])}}catch{f.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{he(!1)}},Ee=z=>{fe(z)},Z=z=>{n?(n(z),setTimeout(()=>{pe(),U&&me(U)},0)):f.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:j}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-neutral-500/20 via-neutral-400/30 to-neutral-500/20"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:j,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:F.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(z=>e.jsx("button",{onClick:()=>ae(z),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${te===z?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:z==="IMAGE"?"å›¾ç‰‡":z==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},z))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-5 gap-1",children:["ROLE","SCENE","PROP","AUDIO","OTHER"].map(z=>e.jsx("button",{onClick:()=>ne(z),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${je===z?"bg-neutral-800 dark:bg-white text-white dark:text-black text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-neutral-400 dark:hover:border-neutral-400/50"}`,children:z==="ROLE"?"è§’è‰²":z==="SCENE"?"åœºæ™¯":z==="PROP"?"é“å…·":z==="AUDIO"?"éŸ³é¢‘":"å…¶ä»–"},z))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const z=je==="ALL"?F:F.filter(A=>(A.category||"OTHER")===je);return e.jsx("select",{value:U,onChange:A=>Ee(A.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-neutral-500",children:z.map(A=>{var I;return e.jsxs("option",{value:A.id,children:[A.isShared?`[å…±äº«] ${A.name}`:A.name," (",A._count.assets,")",A.isShared&&((I=A.owner)!=null&&I.nickname)?` - ${A.owner.nickname}`:""]},A.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Ue?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const z=F.find(G=>G.id===U);if(z&&(z.category||"OTHER")==="ROLE")return K.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:K.map(G=>e.jsxs("div",{onClick:()=>n&&n(G),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[G.coverUrl?e.jsx("img",{src:G.coverUrl,alt:G.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:G.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[G.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},G.id))});const I=Q.filter(G=>te==="ALL"||G.type===te);return I.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:I.map(G=>e.jsxs("div",{onClick:()=>Z(G),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[G.type==="IMAGE"?e.jsx("img",{src:de(G.url),alt:G.name,className:"w-full h-full object-cover"}):G.type==="VIDEO"?e.jsx("video",{src:de(G.url),className:"w-full h-full object-cover"}):G.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:G.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:G.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:G.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(G.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:G.type==="IMAGE"?"image":G.type==="VIDEO"?"video_file":G.type==="AUDIO"?"audio_file":"description"})})]},G.id))})})()})]})})]})]}):null},xn={agent:fo,aiImage:Ja,aiVideo:ur,soraVideo:Co,soraCharacter:_o,aiVideo_t2v:Ka,aiVideo_i2v_first:Qa,aiVideo_i2v_last:to,aiVideo_first_last:ro,aiVideo_reference:oo,aiVideo_swap:io,aiVideo_lipsync:co,aiVideo_style:ho,upload:xo,assetSelector:wo,imagePreview:ko,videoPreview:No,textPreview:Io,midjourney:So,audioVoice:Uo,voiceClone:$o,audioSynthesize:Do,audioDesign:Vo,audioPreview:Oo,superCanvas:Fo,videoUpscale:Bo,commercialVideo:Xo,textAnnotation:Yo,imageEditing:Zo,hdUpscale:on,imageFusion:cn,smartStoryboard:pn},bn={aurora:Lo},wn=()=>{const{id:s,projectId:j,episodeId:n,workflowId:F}=xa(),ye=!!F,U=ba(),fe=Sr(),Q=t.useMemo(()=>new URLSearchParams(fe.search),[fe.search]),re=t.useMemo(()=>{const o=Number(Q.get("scene"));return Number.isFinite(o)&&o>0?o:void 0},[Q]),K=t.useMemo(()=>{const o=Number(Q.get("shot"));return Number.isFinite(o)&&o>0?o:void 0},[Q]),ce=t.useMemo(()=>{try{const o=Q.get("assets");if(o)return JSON.parse(decodeURIComponent(o))}catch{}return[]},[Q]),{screenToFlowPosition:Ue,setCenter:he,getViewport:te,fitView:ae}=Zt(),{setTitle:je}=ya(),ne=Er(o=>o.user),[pe,de]=t.useState(null),[me,Ee]=t.useState(null),[Z,z]=t.useState(!0),[A,I,G]=Na([]),[m,c,S]=ja([]),[P,$]=t.useState(!1),N=t.useRef(!1),[O,r]=t.useState(null),[v,g]=t.useState(null),[a,y]=t.useState(!0),d=t.useRef(null),[x,p]=t.useState(!1),w=t.useRef(null),R=t.useRef(null),[W,_]=t.useState(!1),[h,l]=t.useState(null),[i,B]=t.useState([]),[M,X]=t.useState([]),[V,ie]=t.useState(null),[xe,oe]=t.useState(null),k=t.useRef(null),u=t.useRef(null),E=V==="video",b=V==="edit",q=V==="imageEdit",ue=o=>ie(null),H=o=>ie(o?"video":null),ge=o=>ie(o?"edit":null),Ie=o=>ie(o?"imageEdit":null),Ne=k,Re=xe==="agent",Ae=o=>oe(o?"agent":null),_e=u,$e=u,le=t.useCallback(o=>{const C=(o||"").toLowerCase().replace(/[_\-\s]+/g," ");return C?C.includes("æ–‡ç”Ÿ")||C.includes("text to video")||C.includes("t2v")||C.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":C.includes("é¦–å°¾")||C.includes("first last")||C.includes("two frame")||C.includes("frame pair")||C.includes("first-last")?"é¦–å°¾å¸§":C.includes("é¦–å¸§")||C.includes("first frame")||C.includes("start frame")||C.includes("initial frame")||C.includes("keyframe")?"é¦–å¸§":C.includes("å°¾å¸§")||C.includes("last frame")||C.includes("end frame")||C.includes("final frame")?"å°¾å¸§":C.includes("ä¸»ä½“å‚è€ƒ")||C.includes("subject reference")||C.includes("å‚è€ƒ")||C.includes("reference image")||C.includes("image reference")||C.includes("ref image")?"å‚è€ƒå›¾":o||"":""},[]),Ge=t.useMemo(()=>{const o=new Set;return(i||[]).filter(D=>(D.type||"")==="VIDEO_GENERATION").forEach(D=>{var ee;(Array.isArray((ee=D==null?void 0:D.config)==null?void 0:ee.supportedGenerationTypes)?D.config.supportedGenerationTypes:[]).forEach(ve=>{const De=le(ve);De&&o.add(De)})}),o},[i,le]),Qe=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Wt=t.useCallback(o=>{const C=(i||[]).filter(ee=>(ee.type||"")==="VIDEO_EDITING").filter(ee=>{var ve;return Array.isArray((ve=ee==null?void 0:ee.config)==null?void 0:ve.supportedEditingCapabilities)&&ee.config.supportedEditingCapabilities.includes(o)}),D=(i||[]).filter(ee=>(ee.type||"")==="VIDEO_GENERATION").filter(ee=>{var He,Fe;if(o!=="è§†é¢‘æ¢äºº")return!1;const ve=((He=ee==null?void 0:ee.config)==null?void 0:He.supportsVideoEditing)===!0,Le=(Array.isArray((Fe=ee==null?void 0:ee.config)==null?void 0:Fe.supportedGenerationTypes)?ee.config.supportedGenerationTypes:[]).some(rt=>le(rt)==="è§†é¢‘æ¢äºº");return ve||Le}),J={};return[...C,...D].forEach(ee=>{J[ee.id]||(J[ee.id]=ee)}),Object.values(J)},[i,le]),[Ct,_t]=t.useState(!1),[ct,gt]=t.useState(null),vt=t.useRef(null),it=t.useRef(),[Ye,yt]=t.useState([]),[Be,wt]=t.useState(null),[Yt,vs]=t.useState(null),[Is,Ss]=t.useState(!1),[Ns,Bs]=t.useState(null),[hs,Qs]=t.useState(null),[Hs,nr]=t.useState(null),Tt=t.useRef([]),Xs=t.useRef(null),[bs,er]=t.useState(!1),[ws,tr]=t.useState(!1),[sr,rr]=t.useState(0),Ls=t.useRef(null),Y=t.useRef(null),se=t.useRef([]),Me=t.useRef([]),Ve=t.useRef(0),qe=!!n,Oe=qe&&!!re&&!!K,tt=ye?F:Oe?`${n}-${re}-${K}`:qe?n:s,bt=Oe,[T,L]=t.useState(!1),be=t.useRef(new Set),Te=t.useRef(new Set),Se=t.useRef(new Set),we=t.useRef(new Set),et=t.useRef(new Map),st=t.useRef(new Set),kt=t.useCallback((o,C)=>{C!==d.current&&(be.current.add(o.id),I(D=>D.some(J=>J.id===o.id)?D:[...D,{...o,data:{...o.data,models:i}}]))},[i,I]),ht=t.useCallback((o,C,D)=>{D!==d.current&&(st.current.add(o),I(J=>J.map(ee=>ee.id===o?{...ee,data:{...ee.data,...C}}:ee)),setTimeout(()=>st.current.delete(o),100))},[I]),We=t.useCallback((o,C)=>{C!==d.current&&(I(D=>D.filter(J=>J.id!==o)),c(D=>D.filter(J=>J.source!==o&&J.target!==o)))},[I,c]),Dt=t.useCallback((o,C,D)=>{D!==d.current&&I(J=>J.map(ee=>ee.id===o?{...ee,position:C}:ee))},[I]),Xt=t.useCallback((o,C)=>{C!==d.current&&I(D=>D.map(J=>{const ee=o.find(ve=>ve.id===J.id);return ee?{...J,position:ee.position}:J}))},[I]),Pt=t.useCallback((o,C)=>{C!==d.current&&(Te.current.add(o.id),c(D=>D.some(J=>J.id===o.id)?D:[...D,o]))},[c]),zt=t.useCallback((o,C)=>{C!==d.current&&c(D=>D.filter(J=>J.id!==o))},[c]),At=t.useCallback((o,C)=>{C!==d.current&&(yt(o),Tt.current=o)},[]),{emitNodeAdd:Ut,emitNodeUpdate:Vt,emitNodeDelete:Ft,emitNodesMove:ts,emitEdgeAdd:rs,emitEdgeDelete:ys,emitGroupsUpdate:Js,onlineUsers:Es}=Ba({workflowId:w.current,isSharedWorkflow:x,isReadOnly:P,onNodeAdd:kt,onNodeUpdate:ht,onNodeDelete:We,onNodeMove:Dt,onNodesMove:Xt,onEdgeAdd:Pt,onEdgeDelete:zt,onGroupsUpdate:At});t.useEffect(()=>{Tt.current=Ye},[Ye]),t.useEffect(()=>{se.current=A,Ve.current=A.length},[A]),t.useEffect(()=>{Me.current=m},[m]),t.useEffect(()=>{if(!T){Se.current=new Set(A.map(ee=>ee.id));const J=new Map;A.forEach(ee=>{var ve;try{J.set(ee.id,JSON.stringify(((ve=ee.data)==null?void 0:ve.config)||{}))}catch{J.set(ee.id,"{}")}}),et.current=J;return}if(!x||N.current){Se.current=new Set(A.map(J=>J.id));return}const o=new Set(A.map(J=>J.id)),C=Se.current;A.forEach(J=>{var ee,ve;if(!C.has(J.id))be.current.has(J.id)||Ut(J);else if(!st.current.has(J.id))try{const De=JSON.stringify(((ee=J.data)==null?void 0:ee.config)||{}),Le=et.current.get(J.id)||"{}";De!==Le&&Vt(J.id,{config:(ve=J.data)==null?void 0:ve.config})}catch{}}),Se.current=o;const D=new Map;A.forEach(J=>{var ee;try{D.set(J.id,JSON.stringify(((ee=J.data)==null?void 0:ee.config)||{}))}catch{D.set(J.id,"{}")}}),et.current=D,be.current=new Set([...be.current].filter(J=>o.has(J)))},[A,x,T,Ut,Vt]),t.useEffect(()=>{if(!T){we.current=new Set(m.map(D=>D.id));return}if(!x||N.current){we.current=new Set(m.map(D=>D.id));return}const o=new Set(m.map(D=>D.id)),C=we.current;m.forEach(D=>{C.has(D.id)||Te.current.has(D.id)||rs(D)}),we.current=o,Te.current=new Set([...Te.current].filter(D=>o.has(D)))},[m,x,T,rs]);const ps=t.useCallback(o=>{var ee;if(N.current)return!1;if(a)return!0;if(Tt.current.some(ve=>{var De;return!ve.hidden&&((De=ve.nodeIds)==null?void 0:De.includes(o.id))}))return!1;if(Oe)return!0;const D=(ee=o.data)==null?void 0:ee.createdBy;return(typeof D=="object"?D==null?void 0:D.id:D)===d.current},[a,Oe]),Bt=t.useMemo(()=>{const o=new Set(Ye.filter(C=>!C.hidden).flatMap(C=>C.nodeIds||[]));return A.map(C=>{const D=o.has(C.id),J=D?!1:a?!0:ps(C);return{...C,draggable:C.draggable!==!1,connectable:D?!1:C.connectable!==!1,data:{...C.data,_canEdit:J,_isGrouped:D,_currentUserId:v,_isSharedWorkflow:x}}})},[A,Ye,a,ps,v,x,P]),Jt=t.useRef(null),as=t.useRef(new Map),ds=t.useCallback(o=>{if(N.current){G(o);return}const C=o.filter(J=>{var He;if(J.type!=="position")return!0;if(Tt.current.find(Fe=>{var rt;return!Fe.hidden&&((rt=Fe.nodeIds)==null?void 0:rt.includes(J.id))}))return a;if(a)return!0;const ve=se.current.find(Fe=>Fe.id===J.id);if(!ve)return!0;const De=(He=ve.data)==null?void 0:He.createdBy;return(typeof De=="object"?De==null?void 0:De.id:De)===d.current});G(C);const D=C.filter(J=>J.type==="position"&&J.position);D.length>0&&(D.forEach(J=>{as.current.set(J.id,J.position)}),Jt.current&&clearTimeout(Jt.current),Jt.current=setTimeout(()=>{const J=Array.from(as.current.entries()).map(([ee,ve])=>({id:ee,position:ve}));J.length>0&&(ts(J),as.current.clear())},100))},[a,G,ts]);t.useEffect(()=>{Xs.current=hs},[hs]),t.useEffect(()=>{const o=C=>{C.key==="Escape"&&(bs&&er(!1),ws&&tr(!1))};return window.addEventListener("keydown",o),()=>{window.removeEventListener("keydown",o)}},[bs,ws]),t.useEffect(()=>{tt&&(_(!1),L(!1),Os(),Jr(),qr(),ss().finally(()=>{L(!0)}))},[tt]),t.useEffect(()=>{if(!Z&&!W&&A.length>0){const o=setTimeout(()=>{ae({padding:.1,duration:800,maxZoom:1.5}),_(!0)},100);return()=>clearTimeout(o)}},[Z,W,A.length,ae]),t.useEffect(()=>{var J;if(!Oe||!me||!pe||!T)return;const o=Ye.find(ee=>ee.scene===re&&ee.shot===K),C=`${re}-${K}`;if(o){vs(o.id),wt(o.id);try{if(R.current===C)return;if(Array.isArray(ce)&&ce.length>0){R.current=C;const ee=A,ve=[],De=280,Le=320,He=350,Fe={role:0,scene:0,prop:0,audio:0};ee.forEach(Pe=>{var ft;if(Pe.type==="assetSelector"){const Lt=((ft=Pe.data)==null?void 0:ft.label)||"";Lt.startsWith("è§’è‰²")?Fe.role++:Lt.startsWith("åœºæ™¯")?Fe.scene++:Lt.startsWith("é“å…·")?Fe.prop++:Lt.startsWith("éŸ³é¢‘")&&Fe.audio++}});const rt={...Fe},Xe=[];ce.forEach((Pe,ft)=>{const Lt=Pe.thumbnail||Pe.url||"";let Rt=null;const Ot=ee.some(ot=>{var Mt,Ke;if(ot.type!=="assetSelector")return!1;const Ze=(Mt=ot.data)==null?void 0:Mt.config,ke=Ze==null?void 0:Ze.selectedAsset;if((ke==null?void 0:ke.id)===Pe.id)return Rt=ot.id,!0;const Je=((Ke=ot.data)==null?void 0:Ke.label)||"",jt=Pe.type==="role"?"è§’è‰²":Pe.type==="scene"?"åœºæ™¯":"é“å…·";return Je===`${jt}: ${Pe.name}`||(ke==null?void 0:ke.name)===Pe.name?(Rt=ot.id,!0):!1});if(Ot&&Rt&&Lt&&Xe.push({nodeId:Rt,newUrl:Lt}),Ot)return;const pt=Pe.type,mt=pt==="role"?0:pt==="scene"?1:pt==="prop"?2:3,Nt=rt[pt]||0;rt[pt]=(rt[pt]||0)+1;const Ht={x:mt*De,y:He+Nt*Le},lt=Pe.thumbnail||Pe.url||"",ze=`assetSelector-${Date.now()}-${ft}`,nt=pt==="role"?"è§’è‰²":pt==="scene"?"åœºæ™¯":pt==="prop"?"é“å…·":"éŸ³é¢‘",dt=Pe.metadata,at=pt==="role"&&(dt==null?void 0:dt.images);let qt=[];if(at){const ot=dt.images;ot.frontUrl&&qt.push({id:"front",url:ot.frontUrl,name:`${Pe.name}-æ­£é¢`}),ot.sideUrl&&qt.push({id:"side",url:ot.sideUrl,name:`${Pe.name}-ä¾§é¢`}),ot.backUrl&&qt.push({id:"back",url:ot.backUrl,name:`${Pe.name}-èƒŒé¢`}),ot.faceUrl&&qt.push({id:"face",url:ot.faceUrl,name:`${Pe.name}-é¢éƒ¨`})}let $t;at&&qt.length>0?$t={selectedInput:{id:Pe.id,name:Pe.name,coverUrl:lt,images:qt}}:pt==="audio"?$t={selectedAsset:{id:Pe.id,name:Pe.name,originalName:Pe.name,url:Pe.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:$t={selectedAsset:{id:Pe.id,name:Pe.name,originalName:Pe.name,url:lt,type:"IMAGE",mimeType:"image/png",size:0}},ve.push({id:ze,type:"assetSelector",position:Ht,data:{id:ze,label:`${nt}: ${Pe.name}`,config:$t,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:pe,episode:me,nodeGroup:o,nodeGroups:Ye}}})}),Xe.length>0&&I(Pe=>Pe.map(ft=>{var Rt;const Lt=Xe.find(Ot=>Ot.nodeId===ft.id);if(Lt&&ft.type==="assetSelector"){const Ot=((Rt=ft.data)==null?void 0:Rt.config)||{},pt=Ot.selectedAsset||{};return{...ft,data:{...ft.data,config:{...Ot,selectedAsset:{...pt,url:Lt.newUrl}}}}}return ft})),ve.length>0&&I(Pe=>[...Pe,...ve])}}catch{}return}if(R.current===C)return;const D={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${re}å¹•-ç¬¬${K}é•œ`,scene:re,shot:K,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};yt(ee=>[...ee,D]),Tt.current=[...Tt.current,D],vs(D.id),wt(D.id),R.current=C;try{const ee=((J=me==null?void 0:me.scriptJson)==null?void 0:J.acts)||[],ve=Array.isArray(ee)?ee.find(ze=>Number(ze.actIndex)===Number(re)):null,De=ve?(ve.shots||[]).find(ze=>Number(ze.shotIndex)===Number(K)):null,He=De?[`ç”»é¢ï¼š${(De.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(De["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(De["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(De["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(De.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=De&&(De.æç¤ºè¯||"").trim()||"",rt=500,Xe=40,Pe=280,ft=320,Lt=350,Rt={x:0,y:0},Ot={x:rt+Xe,y:0},pt=`textPreview-${Date.now()}-a`,mt=`textPreview-${Date.now()}-b`,Nt=[{id:pt,type:"textPreview",position:Rt,data:{content:He||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:pt,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:pe,episode:me,nodeGroup:D,nodeGroups:[...Ye,D]}}},{id:mt,type:"textPreview",position:Ot,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:mt,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:pe,episode:me,nodeGroup:D,nodeGroups:[...Ye,D]}}}],Ht=[];if(Array.isArray(ce)&&ce.length>0){const ze={role:0,scene:0,prop:0,audio:0};ce.forEach((nt,dt)=>{const at=nt.type,qt=at==="role"?0:at==="scene"?1:at==="prop"?2:3,$t=ze[at]||0;ze[at]=(ze[at]||0)+1;const ot={x:qt*Pe,y:Lt+$t*ft},Ze=`assetSelector-${Date.now()}-${dt}`;Ht.push(Ze);const ke=at==="role"?"è§’è‰²":at==="scene"?"åœºæ™¯":at==="prop"?"é“å…·":"éŸ³é¢‘",Je=nt.thumbnail||nt.url||"",jt=nt.metadata,Mt=at==="role"&&(jt==null?void 0:jt.images);let Ke=[];if(Mt){const xt=jt.images;xt.frontUrl&&Ke.push({id:"front",url:xt.frontUrl,name:`${nt.name}-æ­£é¢`}),xt.sideUrl&&Ke.push({id:"side",url:xt.sideUrl,name:`${nt.name}-ä¾§é¢`}),xt.backUrl&&Ke.push({id:"back",url:xt.backUrl,name:`${nt.name}-èƒŒé¢`}),xt.faceUrl&&Ke.push({id:"face",url:xt.faceUrl,name:`${nt.name}-é¢éƒ¨`})}let It;Mt&&Ke.length>0?It={selectedInput:{id:nt.id,name:nt.name,coverUrl:Je,images:Ke}}:at==="audio"?It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:nt.url||"",type:"AUDIO",mimeType:"audio/mpeg",size:0}}:It={selectedAsset:{id:nt.id,name:nt.name,originalName:nt.name,url:Je,type:"IMAGE",mimeType:"image/png",size:0}},Nt.push({id:Ze,type:"assetSelector",position:ot,data:{id:Ze,label:`${ke}: ${nt.name}`,config:It,freeDrag:!0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:pe,episode:me,nodeGroup:D,nodeGroups:[...Ye,D]}}})})}I(ze=>[...ze,...Nt]);const lt=[pt,mt,...Ht];yt(ze=>ze.map(nt=>{if(nt.id!==D.id)return nt;const dt=Array.from(new Set([...nt.nodeIds||[],...lt])),at=nt.bounds;return{...nt,nodeIds:dt,bounds:at}})),Tt.current=Tt.current.map(ze=>{if(ze.id!==D.id)return ze;const nt=Array.from(new Set([...ze.nodeIds||[],...lt])),dt=ze.bounds;return{...ze,nodeIds:nt,bounds:dt}})}catch{}},[qe,re,K,me,pe,Ye,I,T,ce]),t.useEffect(()=>{if(pe)if(qe&&me){const o=`${pe.name} - ${me.name||`ç¬¬${me.episodeNumber}é›†`}`,C=re&&K?`ç¬¬${re}å¹•ç¬¬${K}é•œ`:"";je(Oe?o:`${o} ${C}`.trim())}else je(pe.name);return()=>je("")},[pe,me,qe,Oe,re,K,je]),t.useEffect(()=>{if(!(!tt||Z||N.current))return it.current&&clearTimeout(it.current),it.current=setTimeout(()=>{qs()},2e3),()=>{it.current&&clearTimeout(it.current)}},[A,m,Ye]);const ss=async()=>{var o,C,D,J,ee,ve;try{let De;if(ye&&F)De=await Ce.workflows.getById(F);else if(Oe)De=await Ce.workflows.getOrCreateByShot(j,n,re,K);else if(qe)De=await Ce.workflows.getOrCreateByEpisode(j,n);else{if(!s)return;De=await Ce.workflows.getOrCreateByProject(s)}const Le=De.data;Le.canEdit===!1||Le.canEdit===void 0&&Le.isOwner===!1?($(!0),N.current=!0,(o=Le.shareInfo)!=null&&o.owner&&r(Le.shareInfo.owner)):($(!1),N.current=!1,r(null)),Le.currentUserId&&(g(Le.currentUserId),d.current=Le.currentUserId);const Fe=Le.isOwner!==!1||Oe&&Le.canEdit===!0;y(Fe);const rt=ye||Le.hasCollaborators===!0;if(p(rt),w.current=Le.id,ye&&de({id:Le.projectId||F,name:Le.name||"å…±äº«å·¥ä½œæµ",description:Le.description,type:"QUICK",status:"DRAFT"}),Le.data){const{nodes:Xe,edges:Pe,nodeGroups:ft}=Le.data;if(ft&&ft.length>0&&(yt(ft),Tt.current=ft),Xe&&Xe.length>0){let Lt=Xe;if(Oe&&((C=me==null?void 0:me.scriptJson)!=null&&C.acts))try{const Nt=me.scriptJson.acts.find(ze=>Number(ze.actIndex)===Number(re)),Ht=(D=Nt==null?void 0:Nt.shots)==null?void 0:D.find(ze=>Number(ze.shotIndex)===Number(K)),lt=new Set;Ht&&(Array.isArray(Ht.mediaList)&&Ht.mediaList.forEach(ze=>{ze.nodeId&&lt.add(ze.nodeId)}),(J=Ht.media)!=null&&J.nodeId&&lt.add(Ht.media.nodeId)),Lt=Xe.map(ze=>{var nt;return ze.type==="videoPreview"&&((nt=ze.data)!=null&&nt.addedToStoryboard)&&!lt.has(ze.id)?{...ze,data:{...ze.data,addedToStoryboard:!1}}:ze})}catch{}let Rt;if(Oe&&((ee=me==null?void 0:me.scriptJson)!=null&&ee.acts))try{const Nt=me.scriptJson.acts.find(lt=>Number(lt.actIndex)===Number(re)),Ht=(ve=Nt==null?void 0:Nt.shots)==null?void 0:ve.find(lt=>Number(lt.shotIndex)===Number(K));Rt=Ht==null?void 0:Ht.æç¤ºè¯}catch{}const Ot=new Set((ft||[]).filter(mt=>!mt.hidden).flatMap(mt=>mt.nodeIds||[])),pt=Lt.map(mt=>{const Nt=ft?ft.find(ze=>ze.nodeIds.includes(mt.id)):null,Ht=i.length>0?i:mt.data.models||[],lt=mt.type==="agent"&&Rt?{...mt.data,output:Rt,lastOutput:Rt}:mt.data;return{...mt,data:{...lt,models:Ht,onOpenAssetPanel:mt.type==="assetSelector"?mt.data.onOpenAssetPanel||ar:mt.data.onOpenAssetPanel,workflowContext:{project:pe,episode:me,nodeGroup:Nt,nodeGroups:ft||[]}},draggable:mt.draggable!==!1,connectable:Ot.has(mt.id)?!1:mt.connectable!==!1,deletable:Ot.has(mt.id)?!1:mt.deletable!==!1}});I(pt)}if(Pe&&Pe.length>0){const Lt=new Set(Xe.map(pt=>pt.id)),Rt=new Map(Xe.map(pt=>[pt.id,pt.type])),Ot=Pe.filter(pt=>{if(!Lt.has(pt.source)||!Lt.has(pt.target))return!1;const mt=Rt.get(pt.target),Nt=Rt.get(pt.source);return!(mt==="midjourney"&&pt.targetHandle==="text-input"&&Nt!=="agent")}).map(pt=>({...pt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:pt.targetHandle||void 0}));c(Ot)}}}catch{}};t.useEffect(()=>{i.length>0&&A.length>0&&I(o=>o.map(C=>({...C,data:{...C.data,models:i},draggable:C.draggable!==void 0?C.draggable:!0,deletable:C.deletable!==void 0?C.deletable:!0})))},[i,A.length]),t.useEffect(()=>{if(!pe&&!me||A.length===0)return;if(A.some(C=>{var De,Le;const D=C.data.workflowContext,J=((De=D==null?void 0:D.project)==null?void 0:De.id)!==(pe==null?void 0:pe.id),ee=((Le=D==null?void 0:D.episode)==null?void 0:Le.id)!==(me==null?void 0:me.id),ve=(D==null?void 0:D.nodeGroups)!==Tt.current;return!D||J||ee||ve})){const C=re&&K&&Tt.current.find(D=>D.scene===re&&D.shot===K)||null;I(D=>D.map(J=>{const ee=Tt.current.find(De=>De.nodeIds.includes(J.id))||null,ve=C||ee;return{...J,data:{...J.data,workflowContext:{project:pe,episode:me,nodeGroup:ve,nodeGroups:Tt.current}}}}))}},[pe,me,re,K,A.length,Ye]);const Ps=async(o,C,D)=>{var J;if(!(!j||!n))try{const ee=o.find(Fe=>Fe.type==="agent");if(!ee)return;const ve=((J=ee.data)==null?void 0:J.output)||"",Le=(await Ce.episodes.getById(j,n)).scriptJson;if(!Le||!Le.acts)return;const He=Le.acts.map(Fe=>{var rt;return Fe.actIndex===C?{...Fe,shots:(rt=Fe.shots)==null?void 0:rt.map(Xe=>Xe.shotIndex===D&&Xe.æç¤ºè¯!==ve?{...Xe,æç¤ºè¯:ve}:Xe)}:Fe});await Ce.episodes.update(j,n,{scriptJson:{acts:He}})}catch{}},ks=async()=>{if(!(P||N.current)&&!(se.current.length===0&&Me.current.length===0))try{const o=se.current.map(D=>{const{data:J,...ee}=D,{workflowContext:ve,_canEdit:De,_currentUserId:Le,...He}=J||{};return{...ee,data:He}}),C=Me.current.map(D=>({id:D.id,source:D.source,target:D.target,sourceHandle:D.sourceHandle,targetHandle:D.targetHandle,type:D.type}));if(Oe){await Ce.workflows.saveShot(j,n,re,K,{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}});try{await Ps(se.current,re,K)}catch{}}else qe?await Ce.workflows.saveEpisode(j,n,{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}}):ye&&F?await Ce.workflows.update(F,{data:{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}}}):s&&await Ce.workflows.save(s,{nodes:o,edges:C,nodeGroups:Tt.current,viewport:{x:0,y:0,zoom:1}})}catch{}},fs=t.useRef(null),qs=t.useCallback(()=>{fs.current&&clearTimeout(fs.current),fs.current=setTimeout(()=>{ks()},2e3)},[]);t.useEffect(()=>{const o=()=>{N.current||(it.current&&clearTimeout(it.current),setTimeout(()=>{ks()},100))};return window.addEventListener("workflow:save",o),()=>{window.removeEventListener("workflow:save",o)}},[]),t.useEffect(()=>{if(pe||me){let o=Tt.current;Oe&&re&&K&&(o=Tt.current.filter(C=>C.scene===re&&C.shot===K)),window.__workflowContext={project:pe,episode:me,nodeGroups:o}}},[pe,me,Ye,Oe,re,K]);const Os=async()=>{try{if(ye){window.__workflowContext={project:null,episode:null,nodeGroups:Tt.current};return}if(qe){const[o,C]=await Promise.all([Ce.episodes.getById(j,n),Ce.projects.getById(j)]);Ee(o.data),de(C.data);let D=Tt.current;Oe&&re&&K&&(D=Tt.current.filter(J=>J.scene===re&&J.shot===K)),window.__workflowContext={project:C.data,episode:o.data,nodeGroups:D}}else{const o=await Ce.projects.getById(s);de(o.data);let C=Tt.current;Oe&&re&&K&&(C=Tt.current.filter(D=>D.scene===re&&D.shot===K)),window.__workflowContext={project:o.data,episode:null,nodeGroups:C}}}catch{f.error(qe?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),U("/quick")}finally{z(!1)}},Jr=async()=>{try{const o=await Ce.get("/ai/models",{params:{isActive:"true"}});B(o||[])}catch{}};t.useEffect(()=>{I(o=>o.map(C=>{const D=String(C.type||"");return!D.startsWith("aiVideo")&&D!=="audioVoice"&&D!=="voiceClone"&&D!=="audioSynthesize"&&D!=="audioDesign"?C:{...C,data:{...C.data,models:i}}}))},[i,I]);const qr=async()=>{try{const C=(await Ce.agents.getAll()).filter(D=>D.isActive&&(!D.usageScene||D.usageScene==="workflow"));X(C)}catch{}};t.useEffect(()=>{I(o=>o.map(C=>{var Le,He,Fe,rt,Xe;if(C.type!=="agent")return C;const D=(He=(Le=C.data)==null?void 0:Le.config)==null?void 0:He.agentId,J=M.find(Pe=>Pe.id===D),ee=J==null?void 0:J.aiModelId,ve=i.find(Pe=>Pe.id===ee);let De=(Fe=ve==null?void 0:ve.config)==null?void 0:Fe.acceptedInputs;if((!De||De.length===0)&&ve){const Pe=(ve.provider||"").toLowerCase(),ft=(ve.name||"").toLowerCase();(Pe.includes("google")||ft.includes("gemini"))&&(De=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(De)&&De.length>0){const Pe=(Xe=(rt=C.data)==null?void 0:rt.config)==null?void 0:Xe.acceptedInputs,ft=Lt=>Lt.map(Rt=>Rt.toUpperCase()).sort().join(",");if(!Pe||ft(Pe)!==ft(De))return{...C,data:{...C.data,config:{...C.data.config,acceptedInputs:De}}}}return C}))},[M,i,I]);const Yr=t.useCallback(o=>{var Le,He,Fe,rt,Xe,Pe,ft,Lt,Rt,Ot,pt,mt,Nt,Ht,lt,ze,nt;Qt.current=!1;const C=Tt.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.source||""))}),D=Tt.current.some(dt=>{var at;return!dt.hidden&&((at=dt.nodeIds)==null?void 0:at.includes(o.target||""))});if(C||D){f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Qt.current=!1;return}const J=A.find(dt=>dt.id===o.source),ee=A.find(dt=>dt.id===o.target);if(J&&ee){const dt=$t=>{var ke,Je,jt;const ot=$t.type,Ze=$t.data;if(ot==="upload"&&Array.isArray((ke=Ze.config)==null?void 0:ke.uploadedFiles)&&Ze.config.uploadedFiles.length>0){const Mt=Ze.config.uploadedFiles,Ke=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="VIDEO"||js.startsWith("video/")}),It=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="IMAGE"||js.startsWith("image/")}),xt=Mt.some(Et=>{const Kt=((Et==null?void 0:Et.type)||"").toUpperCase(),js=((Et==null?void 0:Et.mimeType)||"").toLowerCase();return Kt==="AUDIO"||js.startsWith("audio/")});return(ee==null?void 0:ee.type)==="aiVideo_swap"?Ke?"VIDEO":It?"IMAGE":xt?"AUDIO":null:It?"IMAGE":Ke?"VIDEO":xt?"AUDIO":null}if(ot==="assetSelector"){if((Je=Ze.config)!=null&&Je.subjects)return"IMAGE";if((jt=Ze.config)!=null&&jt.selectedAsset){const Mt=Ze.config.selectedAsset,Ke=(Mt.type||"").toUpperCase(),It=(Mt.mimeType||"").toLowerCase();return Ke==="IMAGE"||It.startsWith("image/")?"IMAGE":Ke==="VIDEO"||It.startsWith("video/")?"VIDEO":Ke==="AUDIO"||It.startsWith("audio/")?"AUDIO":Ke||null}}return ot==="aiImage"||ot==="imagePreview"?"IMAGE":(ot||"").startsWith("aiVideo")||ot==="videoPreview"?"VIDEO":ot==="agent"?"TEXT":null},at=dt(J);let qt=(Le=ee.data.config)==null?void 0:Le.acceptedInputs;if(ee.type==="aiVideo_t2v"&&at&&at!=="TEXT"){const $t={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};f.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${$t[at]||at}è¾“å…¥`),Qt.current=!1;return}if((!qt||qt.length===0)&&ee.data.type==="agent"){const $t=(He=ee.data.config)==null?void 0:He.agentId,ot=M.find(jt=>jt.id===$t),Ze=ot==null?void 0:ot.aiModelId,ke=i.find(jt=>jt.id===Ze),Je=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(Je)&&Je.length>0)qt=Je;else{const jt=((rt=ke==null?void 0:ke.provider)==null?void 0:rt.toLowerCase())||"",Mt=((ke==null?void 0:ke.name)||"").toLowerCase();(jt.includes("google")||Mt.includes("gemini"))&&(qt=["TEXT","IMAGE","DOCUMENT"])}}if(ee.type!=="agent"){if(!ee.type.startsWith("aiVideo")&&qt&&qt.length>0&&at){const $t=qt.map(Ze=>typeof Ze=="string"?Ze.toUpperCase():Ze),ot=typeof at=="string"?at.toUpperCase():at;if(!$t.includes(ot)){const Ze={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};f.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${Ze[ot]||ot}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${$t.map(ke=>Ze[ke]||ke).join("ã€")}ï¼‰`),Qt.current=!1;return}}}if(ee.type==="aiVideo_swap"){const $t=m.filter(jt=>jt.target===ee.id),ot=$t.filter(jt=>{const Mt=A.find(It=>It.id===jt.source);return dt(Mt)==="VIDEO"}).length,Ze=$t.filter(jt=>{const Mt=A.find(It=>It.id===jt.source);return dt(Mt)==="IMAGE"}).length,ke=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="IMAGE"?1:0);if(ke>1||Je>1||at!=="VIDEO"&&at!=="IMAGE"){f.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Qt.current=!1;return}}if(ee.type==="aiVideo_lipsync"){const $t=m.filter(Mt=>Mt.target===ee.id),ot=$t.filter(Mt=>{const Ke=A.find(xt=>xt.id===Mt.source);return dt(Ke)==="VIDEO"}).length,Ze=$t.filter(Mt=>{const Ke=A.find(xt=>xt.id===Mt.source);return dt(Ke)==="AUDIO"}).length,ke=ot+(at==="VIDEO"?1:0),Je=Ze+(at==="AUDIO"?1:0),jt=at==="VIDEO"||at==="AUDIO"||at==="IMAGE";if(ke>1||Je>1||!jt){f.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Qt.current=!1;return}}if(ee.type.startsWith("aiVideo")&&ee.type!=="aiVideo_swap"&&at==="IMAGE"){const ot=(Ze=>{const ke=(Ze||"").toLowerCase().replace(/[_\-\s]+/g," ");return ke?ke.includes("æ–‡ç”Ÿ")||ke.includes("text to video")||ke.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")||ke.includes("first last")||ke.includes("two frame")||ke.includes("frame pair")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")||ke.includes("first frame")||ke.includes("start frame")||ke.includes("initial frame")||ke.includes("keyframe")?"é¦–å¸§":ke.includes("å°¾å¸§")||ke.includes("last frame")||ke.includes("end frame")||ke.includes("final frame")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")||ke.includes("subject reference")||ke.includes("å‚è€ƒ")||ke.includes("reference image")||ke.includes("image reference")||ke.includes("ref image")?"å‚è€ƒå›¾":Ze||"":""})((Pe=(Xe=ee.data)==null?void 0:Xe.config)==null?void 0:Pe.generationType);if(ee.type==="aiVideo_t2v"||ot==="æ–‡ç”Ÿè§†é¢‘"){f.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Qt.current=!1;return}if((ot==="é¦–å¸§"||ot==="å°¾å¸§")&&J.type==="assetSelector"){const Ze=((ft=J.data)==null?void 0:ft.config)||{};if(Ze.subjects&&Ze.subjects.length>0&&(Ze.subjects[0].images||[]).length>1){f.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Qt.current=!1;return}}if(ot==="é¦–å°¾å¸§"&&J.type==="assetSelector"){const Ze=((Lt=J.data)==null?void 0:Lt.config)||{};if(Ze.subjects&&Ze.subjects.length>0){f.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Qt.current=!1;return}}}if(ee.type==="aiVideo_style"){const Ze=m.filter(ke=>ke.target===ee.id).filter(ke=>{const Je=A.find(Mt=>Mt.id===ke.source);return dt(Je)==="VIDEO"}).length+(at==="VIDEO"?1:0);if(at!=="VIDEO"){f.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Qt.current=!1;return}if(Ze>1){f.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Qt.current=!1;return}}if(ee.type.startsWith("aiVideo")&&at==="TEXT"&&m.filter(Ze=>Ze.target===ee.id).find(Ze=>{const ke=A.find(Je=>Je.id===Ze.source);return(ke==null?void 0:ke.type)==="agent"})){f.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}if(ee.type==="aiImage"){if(at==="TEXT"){if(m.filter(Ze=>Ze.target===ee.id).some(Ze=>{const ke=A.find(Je=>Je.id===Ze.source);return(ke==null?void 0:ke.type)==="agent"})){f.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}}else if(at==="IMAGE"){const ot=m.filter(Ke=>Ke.target===ee.id).reduce((Ke,It)=>{var Kt,js,es,Rs,Cs,$r,Mr;const xt=A.find(cs=>cs.id===It.source),Et=(xt==null?void 0:xt.type)||"";if(Et==="upload"){const cs=((es=(js=(Kt=xt==null?void 0:xt.data)==null?void 0:Kt.config)==null?void 0:js.uploadedFiles)==null?void 0:es[0])||null,fa=((cs==null?void 0:cs.type)||"").toUpperCase(),ma=((cs==null?void 0:cs.mimeType)||"").toLowerCase();return Ke+(fa==="IMAGE"||ma.startsWith("image/")?1:0)}if(Et==="assetSelector"){const cs=((Rs=xt==null?void 0:xt.data)==null?void 0:Rs.config)||{};return cs.selectedAsset&&(Ke+=(cs.selectedAsset.type||"").toUpperCase()==="IMAGE"||(cs.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(cs.subjects)&&cs.subjects.length>0?Ke+((cs.subjects[0].images||[]).length||0):Ke}if(Et==="aiImage"){const cs=($r=(Cs=xt==null?void 0:xt.data)==null?void 0:Cs.config)==null?void 0:$r.generatedImageUrl;return Ke+(cs?1:0)}if(Et==="imagePreview"){const cs=(Mr=xt==null?void 0:xt.data)==null?void 0:Mr.imageUrl;return Ke+(cs?1:0)}return Ke},0);let Ze=1;if(J.type==="assetSelector"){const Ke=((Rt=J==null?void 0:J.data)==null?void 0:Rt.config)||{};Ke.selectedAsset?Ze=(Ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(Ke.subjects)&&Ke.subjects.length>0&&(Ze=(Ke.subjects[0].images||[]).length||0)}else if(J.type==="upload"){const Ke=((mt=(pt=(Ot=J==null?void 0:J.data)==null?void 0:Ot.config)==null?void 0:pt.uploadedFiles)==null?void 0:mt[0])||null,It=((Ke==null?void 0:Ke.type)||"").toUpperCase(),xt=((Ke==null?void 0:Ke.mimeType)||"").toLowerCase();Ze=It==="IMAGE"||xt.startsWith("image/")?1:0}else J.type==="aiImage"?Ze=((Ht=(Nt=J==null?void 0:J.data)==null?void 0:Nt.config)==null?void 0:Ht.generatedImageUrl)?1:0:J.type==="imagePreview"&&(Ze=((lt=J==null?void 0:J.data)==null?void 0:lt.imageUrl)?1:0);const ke=(nt=(ze=ee==null?void 0:ee.data)==null?void 0:ze.config)==null?void 0:nt.modelId,Je=i.find(Ke=>Ke.id===ke),jt=(Je==null?void 0:Je.config)||{},Mt=jt.maxReferenceImages||jt.supportedReferenceImagesLimit||jt.referenceImagesLimit||10;if(ot+Ze>Mt){f.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Mt}å¼ ï¼‰`),Qt.current=!1;return}}}}try{const dt=A.find(ot=>ot.id===o.target),at=A.find(ot=>ot.id===o.source),qt=ot=>{var ke,Je,jt,Mt;if(!ot)return null;const Ze=String(ot.type||"").toLowerCase();if(Ze==="upload"){const Ke=(((Je=(ke=ot.data)==null?void 0:ke.config)==null?void 0:Je.uploadedFiles)||[]).find(It=>{const xt=((It==null?void 0:It.type)||"").toUpperCase(),Et=((It==null?void 0:It.mimeType)||"").toLowerCase();return xt==="AUDIO"||Et.startsWith("audio/")});return(Ke==null?void 0:Ke.url)||null}if(Ze==="assetSelector"){const Ke=(Mt=(jt=ot.data)==null?void 0:jt.config)==null?void 0:Mt.selectedAsset,It=((Ke==null?void 0:Ke.type)||"").toUpperCase(),xt=((Ke==null?void 0:Ke.mimeType)||"").toLowerCase();if(It==="AUDIO"||xt.startsWith("audio/"))return(Ke==null?void 0:Ke.url)||null}return null};if(String((dt==null?void 0:dt.type)||"")==="audioVoice"){const ot=qt(at);ot&&I(Ze=>Ze.map(ke=>ke.id===dt.id?{...ke,data:{...ke.data,config:{...ke.data.config,audioUrl:ot}}}:ke))}}catch{}const De={id:`edge-${o.source}-${o.target}-${Date.now()}`,source:o.source,target:o.target,sourceHandle:o.sourceHandle,targetHandle:o.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{c(dt=>Ia(De,dt)),rs(De)},0),ms.current=null,Qt.current=!0},[c,A,M,i,m,rs]),Kr=t.useCallback((o,C)=>{const D=Tt.current.some(ee=>{var ve;return!ee.hidden&&((ve=ee.nodeIds)==null?void 0:ve.includes(C.source))}),J=Tt.current.some(ee=>{var ve;return!ee.hidden&&((ve=ee.nodeIds)==null?void 0:ve.includes(C.target))});if(D||J){f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}c(ee=>ee.filter(ve=>ve.id!==C.id)),ys(C.id),f.success("å·²æ–­å¼€è¿æ¥")},[c,ys]),yr=t.useCallback(o=>{var J,ee,ve,De,Le,He,Fe,rt,Xe,Pe,ft,Lt,Rt,Ot,pt;it.current&&clearTimeout(it.current);try{const mt=localStorage.getItem("suppressedPreviewTasks")||"[]",Nt=JSON.parse(mt),Ht=ze=>{Nt.push(ze)};for(const ze of Array.isArray(o)?o:[])if((ze==null?void 0:ze.type)==="imagePreview"){const nt=(ee=(J=ze==null?void 0:ze.data)==null?void 0:J.midjourneyData)==null?void 0:ee.sourceNodeId,dt=(De=(ve=ze==null?void 0:ze.data)==null?void 0:ve.midjourneyData)==null?void 0:De.taskId,at=(He=(Le=ze==null?void 0:ze.data)==null?void 0:Le.midjourneyData)==null?void 0:He.messageId;if(nt||dt||at)Ht({sourceNodeId:nt,taskId:dt,messageId:at});else{const qt=Me.current.find($t=>$t.target===ze.id);if(qt){const $t=se.current.find(Ze=>Ze.id===qt.source),ot=(rt=(Fe=$t==null?void 0:$t.data)==null?void 0:Fe.config)==null?void 0:rt.taskId;ot&&Ht({taskId:ot})}}}else if((ze==null?void 0:ze.type)==="videoPreview"){const nt=Me.current.find(dt=>dt.target===ze.id);if(nt){const dt=se.current.find(qt=>qt.id===nt.source),at=(Pe=(Xe=dt==null?void 0:dt.data)==null?void 0:Xe.config)==null?void 0:Pe.taskId;at&&Ht({taskId:at})}}const lt=Nt.slice(Math.max(0,Nt.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(lt))}catch{}try{const mt=[];for(const Nt of Array.isArray(o)?o:[]){const Ht=(Rt=(Lt=(ft=Nt==null?void 0:Nt.data)==null?void 0:ft.workflowContext)==null?void 0:Lt.project)==null?void 0:Rt.name;(Nt==null?void 0:Nt.type)==="imagePreview"&&((Ot=Nt==null?void 0:Nt.data)!=null&&Ot.imageUrl)?mt.push(Ce.post("/assets/recycle/record",{url:Nt.data.imageUrl,type:"IMAGE",projectName:Ht})):(Nt==null?void 0:Nt.type)==="videoPreview"&&((pt=Nt==null?void 0:Nt.data)!=null&&pt.videoUrl)&&mt.push(Ce.post("/assets/recycle/record",{url:Nt.data.videoUrl,type:"VIDEO",projectName:Ht}))}mt.length>0&&Promise.allSettled(mt).then(()=>{})}catch{}const C=Array.isArray(o)?o.length:0,D=Ve.current;setTimeout(()=>{const mt=se.current.length,Nt=Math.max(D-C,0);mt===Nt&&ks()},100)},[]),Zr=t.useCallback(o=>{const C=o.filter(J=>Tt.current.some(ve=>{var De;return!ve.hidden&&((De=ve.nodeIds)==null?void 0:De.includes(J.id))})?(f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(C.length===0)return;if(a){yr(C),C.forEach(J=>Ft(J.id));return}const D=C.filter(J=>{var De;const ee=(De=J.data)==null?void 0:De.createdBy;return(typeof ee=="object"?ee==null?void 0:ee.id:ee)===d.current});D.length>0&&(yr(D),D.forEach(J=>Ft(J.id)))},[a,yr,Ft]),Ar=t.useCallback(o=>{it.current&&clearTimeout(it.current),setTimeout(()=>{qs()},250)},[]),Qr=t.useCallback(o=>{const C=o.filter(D=>{if(D.type!=="remove")return!0;const J=Me.current.find(De=>De.id===D.id);if(!J)return!0;const ee=Tt.current.some(De=>{var Le;return!De.hidden&&((Le=De.nodeIds)==null?void 0:Le.includes(J.source))}),ve=Tt.current.some(De=>{var Le;return!De.hidden&&((Le=De.nodeIds)==null?void 0:Le.includes(J.target))});return ee||ve?(f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});S(C)},[S]),ea=t.useCallback(o=>{const C=o.filter(D=>{const J=Tt.current.some(ve=>{var De;return!ve.hidden&&((De=ve.nodeIds)==null?void 0:De.includes(D.source))}),ee=Tt.current.some(ve=>{var De;return!ve.hidden&&((De=ve.nodeIds)==null?void 0:De.includes(D.target))});return J||ee?(f.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});C.length>0&&(Ar(C),C.forEach(D=>ys(D.id)))},[Ar,ys]),ta=t.useCallback(o=>{if(o.preventDefault(),P)return;const C=200,D=400,J=10;let ee=o.clientX,ve=o.clientY;ee+C+J>window.innerWidth&&(ee=window.innerWidth-C-J),ve+D+J>window.innerHeight&&(ve=window.innerHeight-D-J),ee=Math.max(J,ee),ve=Math.max(J,ve),l({x:ee,y:ve})},[P]),gr=t.useCallback(()=>{l(null),ue(),H(!1)},[]),ar=t.useCallback(o=>{gt(o),_t(!0)},[]);t.useEffect(()=>{A.length>0&&A.some(C=>C.type==="assetSelector"&&!C.data.onOpenAssetPanel)&&I(C=>C.map(D=>D.type==="assetSelector"&&!D.data.onOpenAssetPanel?{...D,data:{...D.data,onOpenAssetPanel:ar,models:D.data.models||i}}:D))},[A.length,ar,i]);const sa=t.useCallback(o=>{ct&&(I(C=>C.map(J=>J.id===ct?{...J,data:{...J.data,config:{...J.data.config,...o.images?o.images.length===1?{selectedInput:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},selectedAsset:{id:o.images[0].id,name:o.images[0].name,originalName:o.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:o.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:o,subjects:[{name:o.name,images:o.images.map(ee=>ee.url)}],referenceImages:o.images.map(ee=>({id:ee.id,url:ee.url,name:ee.name}))}:{selectedInput:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},selectedAsset:{id:o.id,name:o.name,originalName:o.originalName,type:o.type,mimeType:o.mimeType,size:o.size,url:o.url},subjects:void 0,referenceImages:void 0}}}}:J)),_t(!1),gt(null),f.success(`å·²é€‰æ‹©ç´ æï¼š${o.name}`))},[ct,I]),_r=o=>{const D={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[o]||"æ–‡ç”Ÿè§†é¢‘",J=D==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:D==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:D==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:D==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],ee=i.filter(He=>He.type==="VIDEO_GENERATION"),ve=i.filter(He=>He.type==="VIDEO_EDITING"),De=He=>{const Fe=(He||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":He};let Le=null;return D==="è§†é¢‘æ¢äºº"?Le=ve.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||ee.find(He=>{var rt,Xe;return(Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Pe=>De(Pe)):[]).includes("è§†é¢‘æ¢äºº")&&((Xe=He==null?void 0:He.config)==null?void 0:Xe.supportsVideoEditing)===!0}):D==="å¯¹å£å‹"?Le=ve.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:D==="é£æ ¼è½¬æ¢"?Le=ve.find(He=>{var Fe;return Array.isArray((Fe=He==null?void 0:He.config)==null?void 0:Fe.supportedEditingCapabilities)&&He.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:Le=ee.find(He=>{var rt;const Fe=Array.isArray((rt=He==null?void 0:He.config)==null?void 0:rt.supportedGenerationTypes)?He.config.supportedGenerationTypes.map(Xe=>De(Xe)):[];return D==="é¦–å¸§"||D==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(D)}),{modelId:Le==null?void 0:Le.id,modelName:Le==null?void 0:Le.name,generationType:D,lockedGenerationType:D,hideGenerationTypeSelector:!0,acceptedInputs:J}},ns=(o,C,D,J,ee,ve,De,Le)=>{if(!h)return;const He=Ue({x:h.x,y:h.y}),Fe=`${o}-${Date.now()}`,rt=Yt?Ye.find(Rt=>Rt.id===Yt)||null:Ye.find(Rt=>Rt.nodeIds.includes(Fe))||null,Xe=D==="aiImage"||D.startsWith("aiVideo")||D==="midjourney",Pe=D.startsWith("aiVideo")?_r(D):{},ft=J?{agentId:J}:Pe;D.startsWith("aiVideo"),D.startsWith("aiVideo")&&Le&&Object.assign(ft,Le);const Lt={id:Fe,type:D,position:He,data:{label:ee||C,type:o,config:ft,models:i,isExpanded:Xe,onOpenAssetPanel:D==="assetSelector"?ar:void 0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:pe,episode:me,nodeGroup:rt,nodeGroups:Ye}}};I(Rt=>[...Rt,Lt]),Ut(Lt),Yt&&(yt(Rt=>Rt.map(Ot=>{if(Ot.id!==Yt)return Ot;const pt=Array.from(new Set([...Ot.nodeIds||[],Fe])),mt=mr(pt)||Ot.bounds;return{...Ot,nodeIds:pt,bounds:mt}})),Tt.current=Tt.current.map(Rt=>{if(Rt.id!==Yt)return Rt;const Ot=Array.from(new Set([...Rt.nodeIds||[],Fe])),pt=mr(Ot)||Rt.bounds;return{...Rt,nodeIds:Ot,bounds:pt}})),gr(),f.success(`å·²æ·»åŠ ${ee||C}èŠ‚ç‚¹`),D==="assetSelector"&&setTimeout(()=>{ar(Lt.id)},100)},[is,Ys]=t.useState(null),Qt=t.useRef(!1),ms=t.useRef(null),Ks=t.useMemo(()=>{var Le,He,Fe,rt;const o={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!is)return o;const C=is.handleType==="target",D=Xe=>{const Pe=(Xe||"").toLowerCase().replace(/[_\-\s]+/g," ");return Pe?Pe.includes("æ–‡ç”Ÿ")||Pe.includes("text to video")||Pe.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Pe.includes("é¦–å°¾")||Pe.includes("first last")||Pe.includes("two frame")||Pe.includes("frame pair")?"é¦–å°¾å¸§":Pe.includes("é¦–å¸§")||Pe.includes("first frame")||Pe.includes("start frame")||Pe.includes("initial frame")||Pe.includes("keyframe")?"é¦–å¸§":Pe.includes("å°¾å¸§")||Pe.includes("last frame")||Pe.includes("end frame")||Pe.includes("final frame")?"å°¾å¸§":Pe.includes("ä¸»ä½“å‚è€ƒ")||Pe.includes("subject reference")||Pe.includes("å‚è€ƒ")||Pe.includes("reference image")||Pe.includes("image reference")||Pe.includes("ref image")?"å‚è€ƒå›¾":Xe||"":""};if(C){const Xe=A.find(Ot=>Ot.id===is.sourceNodeId),Pe=(Xe==null?void 0:Xe.type)||"",ft=Pe.startsWith("aiVideo"),Lt=D((He=(Le=Xe==null?void 0:Xe.data)==null?void 0:Le.config)==null?void 0:He.generationType),Rt=Pe==="aiVideo_t2v"||Lt==="æ–‡ç”Ÿè§†é¢‘";if(Pe==="aiImage"){const Ot=m.filter(nt=>nt.target===(Xe==null?void 0:Xe.id)),pt=Ot.some(nt=>{const dt=A.find(at=>at.id===nt.source);return((dt==null?void 0:dt.type)||"")==="agent"}),mt=Ot.reduce((nt,dt)=>{var $t,ot,Ze,ke;const at=A.find(Je=>Je.id===dt.source),qt=(at==null?void 0:at.type)||"";if(qt==="upload"){const Je=((Ze=(ot=($t=at==null?void 0:at.data)==null?void 0:$t.config)==null?void 0:ot.uploadedFiles)==null?void 0:Ze[0])||null,jt=((Je==null?void 0:Je.type)||"").toUpperCase(),Mt=((Je==null?void 0:Je.mimeType)||"").toLowerCase();return nt+(jt==="IMAGE"||Mt.startsWith("image/")?1:0)}if(qt==="assetSelector"){const Je=((ke=at==null?void 0:at.data)==null?void 0:ke.config)||{};if(Je.selectedAsset)return nt+((Je.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Je.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Je.subjects&&Je.subjects.length>0)return nt+((Je.subjects[0].images||[]).length||0)}return nt},0),Nt=(rt=(Fe=Xe==null?void 0:Xe.data)==null?void 0:Fe.config)==null?void 0:rt.modelId,Ht=i.find(nt=>nt.id===Nt),lt=(Ht==null?void 0:Ht.config)||{},ze=lt.maxReferenceImages||lt.supportedReferenceImagesLimit||lt.referenceImagesLimit||10;return pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=ze?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(ft){const Ot=m.filter(ze=>ze.target===(Xe==null?void 0:Xe.id)),pt=Ot.some(ze=>{const nt=A.find(dt=>dt.id===ze.source);return((nt==null?void 0:nt.type)||"")==="agent"}),mt=Ot.reduce((ze,nt)=>{var qt,$t,ot,Ze;const dt=A.find(ke=>ke.id===nt.source),at=(dt==null?void 0:dt.type)||"";if(at==="aiImage"||at==="imagePreview")return ze+1;if(at==="upload"){const ke=((ot=($t=(qt=dt==null?void 0:dt.data)==null?void 0:qt.config)==null?void 0:$t.uploadedFiles)==null?void 0:ot[0])||null,Je=((ke==null?void 0:ke.type)||"").toUpperCase(),jt=((ke==null?void 0:ke.mimeType)||"").toLowerCase();return ze+(Je==="IMAGE"||jt.startsWith("image/")?1:0)}if(at==="assetSelector"){const ke=((Ze=dt==null?void 0:dt.data)==null?void 0:Ze.config)||{};if(ke.selectedAsset)return ze+((ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ke.subjects&&ke.subjects.length>0)return ze+((ke.subjects[0].images||[]).length||0)}return ze},0);return Rt?pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Pe==="aiVideo_i2v_first"||Pe==="aiVideo_i2v_last"||Lt==="é¦–å¸§"||Lt==="å°¾å¸§"?pt&&mt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Pe==="aiVideo_first_last"||Lt==="é¦–å°¾å¸§"?pt&&mt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:mt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Pe==="aiVideo_reference"||Lt==="å‚è€ƒå›¾"?pt&&mt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:mt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return o}const J=A.find(Xe=>Xe.id===is.sourceNodeId),ve=(Xe=>{var Lt,Rt,Ot;if(!Xe)return null;const Pe=Xe.type,ft=Xe.data;if(Pe==="upload"&&Array.isArray((Lt=ft.config)==null?void 0:Lt.uploadedFiles)&&ft.config.uploadedFiles.length>0){const pt=ft.config.uploadedFiles;return pt.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="IMAGE"||nt.startsWith("image/")})?"IMAGE":pt.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="VIDEO"||nt.startsWith("video/")})?"VIDEO":pt.some(lt=>{const ze=((lt==null?void 0:lt.type)||"").toUpperCase(),nt=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return ze==="AUDIO"||nt.startsWith("audio/")})?"AUDIO":null}if(Pe==="assetSelector"){if((Rt=ft.config)!=null&&Rt.subjects)return"IMAGE";if((Ot=ft.config)!=null&&Ot.selectedAsset){const pt=ft.config.selectedAsset,mt=(pt.type||"").toUpperCase(),Nt=(pt.mimeType||"").toLowerCase();return mt==="IMAGE"||Nt.startsWith("image/")?"IMAGE":mt==="VIDEO"||Nt.startsWith("video/")?"VIDEO":mt==="AUDIO"||Nt.startsWith("audio/")?"AUDIO":mt||null}}return Pe==="aiImage"||Pe==="imagePreview"||Pe==="midjourney"?"IMAGE":(Pe||"").startsWith("aiVideo")||Pe==="videoPreview"?"VIDEO":Pe==="agent"||Pe==="textPreview"?"TEXT":null})(J),De=J==null?void 0:J.type;return De==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:De==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:ve==="TEXT",showAiImage:ve==="IMAGE"||ve==="TEXT",showAudio:ve==="AUDIO",showVideo:ve==="VIDEO"||ve==="IMAGE"||ve==="TEXT",showEdit:ve==="VIDEO",showImageEditing:ve==="IMAGE",showMidjourney:ve==="IMAGE"||ve==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:ve==="IMAGE"}},[is,A,m,i]),ra=t.useCallback((o,{nodeId:C,handleType:D})=>{if(!C){ms.current=null;return}if(D==="target"){const J=A.find(ve=>ve.id===C),ee=(J==null?void 0:J.type)||"";if(ee==="agent"||ee==="aiImage"||ee==="midjourney"||ee.startsWith("aiVideo")){f.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),ms.current=null;return}}if(D==="source"){const J=A.find(ee=>ee.id===C);if(J&&(J.type==="aiImage"||J.type.startsWith("aiVideo"))){ms.current=null;return}}Qt.current=!1,ms.current={nodeId:C,handleType:D==="target"?"target":"source"},gr(),Ys(null)},[gr,A]),aa=t.useCallback(o=>{const C=ms.current;if(!C)return;let D=0,J=0;"changedTouches"in o&&o.changedTouches.length>0?(D=o.changedTouches[0].clientX,J=o.changedTouches[0].clientY):"clientX"in o&&(D=o.clientX,J=o.clientY),setTimeout(()=>{if(Qt.current){Qt.current=!1,ms.current=null;return}const ee=o.target,ve=!!ee&&!!ee.closest(".react-flow__pane"),De=!!ee&&(ee.closest(".react-flow__node")||ee.closest(".react-flow__handle"));if(!ve||De){Qt.current=!1,ms.current=null;return}Ys({x:D,y:J,sourceNodeId:C.nodeId,handleType:C.handleType}),Qt.current=!1},100),ms.current=null},[]),ls=(o,C,D,J,ee,ve)=>{var Lt,Rt,Ot,pt,mt,Nt,Ht;if(!is)return;const De=Ue({x:is.x,y:is.y}),Le=`${D}-${Date.now()}`,He=A.find(lt=>lt.id===is.sourceNodeId),Fe=He?Ye.find(lt=>lt.nodeIds.includes(He.id)):null,rt=o==="aiImage"||o.startsWith("aiVideo")||o==="midjourney",Xe=o.startsWith("aiVideo")?_r(o):{},Pe=J?{agentId:J}:Xe;o.startsWith("aiVideo")&&ve&&Object.assign(Pe,ve);const ft={id:Le,type:o,position:De,data:{label:ee||C,type:D,config:Pe,models:i,isExpanded:rt,onOpenAssetPanel:o==="assetSelector"?ar:void 0,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0,workflowContext:{project:pe,episode:me,nodeGroup:Fe,nodeGroups:Ye}}};if(I(lt=>[...lt,ft]),Fe&&(yt(lt=>lt.map(ze=>{if(ze.id!==Fe.id)return ze;const nt=Array.from(new Set([...ze.nodeIds,Le]));return{...ze,nodeIds:nt}})),Tt.current=Tt.current.map(lt=>{if(lt.id!==Fe.id)return lt;const ze=Array.from(new Set([...lt.nodeIds,Le]));return{...lt,nodeIds:ze}})),is.handleType==="source"){const lt=A.find(ke=>ke.id===is.sourceNodeId),ze=ft,nt=ke=>{const Je=(ke||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":ke||"":""},dt=ke=>{var Mt,Ke,It;const Je=ke.type,jt=ke.data;if(Je==="upload"&&Array.isArray((Mt=jt.config)==null?void 0:Mt.uploadedFiles)&&jt.config.uploadedFiles.length>0){const xt=jt.config.uploadedFiles,Et=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),Cs=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="VIDEO"||Cs.startsWith("video/")}),Kt=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),Cs=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="IMAGE"||Cs.startsWith("image/")}),js=xt.some(es=>{const Rs=((es==null?void 0:es.type)||"").toUpperCase(),Cs=((es==null?void 0:es.mimeType)||"").toLowerCase();return Rs==="AUDIO"||Cs.startsWith("audio/")});return(ze==null?void 0:ze.type)==="aiVideo_swap"?Et?"VIDEO":Kt?"IMAGE":js?"AUDIO":null:Kt?"IMAGE":Et?"VIDEO":js?"AUDIO":null}if(Je==="assetSelector"){if((Ke=jt.config)!=null&&Ke.subjects)return"IMAGE";if((It=jt.config)!=null&&It.selectedAsset){const xt=jt.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Kt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}}return Je==="aiImage"||Je==="imagePreview"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"?"TEXT":null},at=ke=>{var jt,Mt,Ke;if(dt(ke)!=="IMAGE")return 0;if(ke.type==="upload")return(((Mt=(jt=ke.data)==null?void 0:jt.config)==null?void 0:Mt.uploadedFiles)||[]).filter(xt=>xt.type==="IMAGE"||(xt.mimeType||"").startsWith("image/")).length;if(ke.type==="assetSelector"){const It=((Ke=ke.data)==null?void 0:Ke.config)||{};return It.subjects&&It.subjects.length>0?(It.subjects[0].images||[]).length:It.selectedAsset&&It.selectedAsset.type==="IMAGE"?1:0}return ke.type==="imagePreview"||ke.type==="aiImage",1},qt=ke=>{var xt,Et,Kt,js,es,Rs;const Je=nt((Et=(xt=ke.data)==null?void 0:xt.config)==null?void 0:Et.generationType);if(Je==="æ–‡ç”Ÿè§†é¢‘")return 0;if(Je==="é¦–å¸§"||Je==="å°¾å¸§")return 1;if(Je==="é¦–å°¾å¸§")return 2;if(Je==="å‚è€ƒå›¾"||Je==="ä¸»ä½“å‚è€ƒ")return 7;const jt=(js=(Kt=ke.data)==null?void 0:Kt.config)==null?void 0:js.modelId,Ke=(((es=ke.data)==null?void 0:es.models)||i).find(Cs=>Cs.id===jt),It=Array.isArray((Rs=Ke==null?void 0:Ke.config)==null?void 0:Rs.supportedGenerationTypes)?Ke.config.supportedGenerationTypes.map(Cs=>nt(Cs)):[];return It.includes("å‚è€ƒå›¾")||It.includes("ä¸»ä½“å‚è€ƒ")?7:It.includes("é¦–å°¾å¸§")?2:It.includes("é¦–å¸§")||It.includes("å°¾å¸§")?1:(It.includes("æ–‡ç”Ÿè§†é¢‘"),0)},$t=lt?dt(lt):null;if(ze.type.startsWith("aiVideo")&&$t==="IMAGE"){if(nt((Rt=(Lt=ze.data)==null?void 0:Lt.config)==null?void 0:Rt.generationType)==="é¦–å°¾å¸§"&&lt&&lt.type==="assetSelector"){const xt=((Ot=lt.data)==null?void 0:Ot.config)||{};if(xt.subjects&&(((pt=xt.subjects[0])==null?void 0:pt.images)||[]).length>0){f.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),ms.current=null,Qt.current=!1;return}}const Je=m.filter(xt=>xt.target===ze.id);let jt=0;Je.forEach(xt=>{const Et=A.find(Kt=>Kt.id===xt.source);Et&&(jt+=at(Et))});const Mt=lt?at(lt):0,Ke=qt(ze),It=jt+Mt;if(Ke===0){f.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Ys(null),ms.current=null,Qt.current=!1;return}if(It>Ke){f.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${Ke}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${It}å¼ ï¼‰`),Ys(null),ms.current=null,Qt.current=!1;return}}let ot;ft.type==="superCanvas"?ot="input-image":ft.type==="midjourney"&&($t==="IMAGE"?ot="omni-ref":$t==="TEXT"&&(ot="text-input"));const Ze={id:`edge-${is.sourceNodeId}-${ft.id}`,source:is.sourceNodeId,target:ft.id,targetHandle:ot,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};c(ke=>[...ke,Ze])}else if(is.handleType==="target"){const lt=A.find(Ze=>Ze.id===is.sourceNodeId),ze=(lt==null?void 0:lt.type)||"";if(ze==="agent"||ze==="aiImage"||ze==="midjourney"||ze.startsWith("aiVideo")){f.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Ys(null),ms.current=null,Qt.current=!1;return}const nt=ft,dt=A.find(Ze=>Ze.id===is.sourceNodeId),at=Ze=>{const ke=(Ze||"").toLowerCase();return ke?ke.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")?"é¦–å¸§":ke.includes("å°¾å¸§")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ke.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ke.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("first-last")?"é¦–å°¾å¸§":ke.includes("first")?"é¦–å¸§":ke.includes("last")?"å°¾å¸§":ke.includes("subject")?"ä¸»ä½“å‚è€ƒ":ke.includes("reference")?"å‚è€ƒå›¾":Ze||"":""},$t=(Ze=>{var jt,Mt,Ke,It;const ke=Ze.type,Je=Ze.data;if(ke==="upload"&&((Mt=(jt=Je.config)==null?void 0:jt.uploadedFiles)==null?void 0:Mt.length)>0){const xt=Je.config.uploadedFiles[0],Et=(xt.type||"").toUpperCase(),Kt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}if(ke==="assetSelector"){if((Ke=Je.config)!=null&&Ke.subjects)return"IMAGE";if((It=Je.config)!=null&&It.selectedAsset){const xt=Je.config.selectedAsset,Et=(xt.type||"").toUpperCase(),Kt=(xt.mimeType||"").toLowerCase();return Et==="IMAGE"||Kt.startsWith("image/")?"IMAGE":Et==="VIDEO"||Kt.startsWith("video/")?"VIDEO":Et==="AUDIO"||Kt.startsWith("audio/")?"AUDIO":Et||null}}return ke==="aiImage"||ke==="imagePreview"?"IMAGE":ke==="aiVideo"||ke==="videoPreview"?"VIDEO":ke==="agent"?"TEXT":null})(nt);if(dt&&dt.type==="aiVideo"&&$t==="IMAGE"&&at((Nt=(mt=dt.data)==null?void 0:mt.config)==null?void 0:Nt.generationType)==="é¦–å°¾å¸§"&&nt&&nt.type==="assetSelector"){const ke=((Ht=nt.data)==null?void 0:Ht.config)||{};if(ke.subjects&&ke.subjects.length>0){f.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Ys(null),ms.current=null,Qt.current=!1;return}}const ot={id:`edge-${ft.id}-${is.sourceNodeId}`,source:ft.id,sourceHandle:ft.type==="superCanvas"?"output-image":void 0,target:is.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};c(Ze=>[...Ze,ot])}Ys(null),ms.current=null,Qt.current=!1,f.success(`å·²æ·»åŠ ${C}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),o==="assetSelector"&&setTimeout(()=>{ar(ft.id)},100)},mr=t.useCallback(o=>{const C=A.filter(Le=>o.includes(Le.id));if(C.length===0)return null;const D=50;let J=1/0,ee=1/0,ve=-1/0,De=-1/0;return C.forEach(Le=>{const He=Le.position.x,Fe=Le.position.y,rt=Le.width||320,Xe=Le.height||200;J=Math.min(J,He),ee=Math.min(ee,Fe),ve=Math.max(ve,He+rt),De=Math.max(De,Fe+Xe)}),{x:J-D,y:ee-D,width:ve-J+D*2,height:De-ee+D*2}},[A]),oa=t.useCallback(()=>{tr(o=>!o),er(!1)},[]),Tr=t.useCallback((o,C)=>{const D={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:o-100,y:C-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:ne?{id:ne.id,nickname:ne.nickname,avatar:ne.avatar}:void 0}};I(J=>[...J,D]),tr(!1)},[I,ne]),na=t.useCallback(()=>{if(!a){f.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const o=A.filter(ve=>ve.selected);if(o.length===0){f.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(o.length<2){f.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const C=o.map(ve=>ve.id);if(Ye.some(ve=>ve.nodeIds.some(De=>C.includes(De)))){f.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const J=mr(C);if(!J){f.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const ee={id:`group-${Date.now()}`,nodeIds:C,bounds:J};yt(ve=>{const De=[...ve,ee];return Js(De),setTimeout(()=>{qs()},100),De}),wt(ee.id),I(ve=>{const De=new Set;return m.forEach(Le=>{if(C.includes(Le.source)){const He=ve.find(Fe=>Fe.id===Le.target);He&&(He.type==="imagePreview"||He.type==="videoPreview")&&De.add(Le.target)}}),ve.map(Le=>C.includes(Le.id)?{...Le,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...Le.data,workflowContext:{...Le.data.workflowContext,nodeGroup:ee,nodeGroups:[...Ye,ee]}}}:De.has(Le.id)?{...Le,data:{...Le.data,workflowContext:{...Le.data.workflowContext,nodeGroup:ee,nodeGroups:[...Ye,ee]}}}:Le)}),f.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${C.length} ä¸ªèŠ‚ç‚¹`)},[A,mr,Ye,I]),ia=t.useCallback(()=>{if(!a){f.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Be){f.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const o=Ye.find(C=>C.id===Be);o&&(I(C=>C.map(D=>o.nodeIds.includes(D.id)?{...D,draggable:!0,connectable:!0,deletable:!0,data:{...D.data,workflowContext:{...D.data.workflowContext,nodeGroup:null,nodeGroups:Ye.filter(J=>J.id!==Be)}}}:D)),yt(C=>{const D=C.filter(J=>J.id!==Be);return Js(D),setTimeout(()=>{qs()},100),D}),wt(null),f.success("å·²è§£é™¤ç¼–ç»„"))},[Be,Ye,I,Js]),la=t.useCallback(()=>{if(!Be){f.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}Bs(Be),Ss(!0)},[Be]),Ur=t.useCallback((o,C)=>{o.stopPropagation(),o.preventDefault(),Qs(null),wt(C),nr(null)},[]);t.useEffect(()=>{if(!hs||!Hs)return;let o=Hs.x,C=Hs.y;const D=ee=>{const ve=Xs.current;if(!ve)return;const De=te(),Le=(ee.clientX-o)/De.zoom,He=(ee.clientY-C)/De.zoom;if(Math.abs(Le)<.01&&Math.abs(He)<.01)return;const Fe=Tt.current.find(rt=>rt.id===ve);Fe&&(yt(rt=>rt.map(Xe=>Xe.id===ve?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+Le,y:Xe.bounds.y+He}}:Xe)),I(rt=>rt.map(Xe=>Fe.nodeIds.includes(Xe.id)?{...Xe,position:{x:Xe.position.x+Le,y:Xe.position.y+He}}:Xe)),o=ee.clientX,C=ee.clientY)},J=()=>{Qs(null),nr(null)};return document.addEventListener("mousemove",D),document.addEventListener("mouseup",J),()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",J)}},[hs,Hs]);const ca=t.useCallback(o=>{if(ws){const C=Ue({x:o.clientX,y:o.clientY});Tr(C.x,C.y);return}gr(),Ys(null),ms.current=null,wt(null),Qt.current=!1},[gr,ws,Ue,Tr]),kr=t.useRef(null),da=t.useCallback(()=>{Ye.length>0&&!kr.current&&(kr.current=window.requestAnimationFrame(()=>{rr(o=>o+1),kr.current=null}))},[Ye.length]),ir=t.useCallback(o=>Ye.find(C=>C.nodeIds.includes(o))||null,[Ye]),ua=t.useCallback((o,C)=>{var J;if(bt||(J=C==null?void 0:C.data)!=null&&J.freeDrag)return;const D=ir(C.id);if(D){if(!D.hidden&&!a)return;Ls.current=C.id,Y.current={x:C.position.x,y:C.position.y}}},[ir,a]),ga=t.useCallback((o,C)=>{var ee;if(bt||(ee=C==null?void 0:C.data)!=null&&ee.freeDrag||!Y.current||Ls.current!==C.id)return;const D=ir(C.id);if(!D)return;const J=!D.hidden;if(!(J&&!a))if(J){const ve=C.position.x-Y.current.x,De=C.position.y-Y.current.y,Le=[],He=D.nodeIds||[];se.current.forEach(Fe=>{if(He.includes(Fe.id)){const rt={x:Fe.id===C.id?C.position.x:Fe.position.x+ve,y:Fe.id===C.id?C.position.y:Fe.position.y+De};Le.push({id:Fe.id,position:rt})}}),I(Fe=>Fe.map(rt=>{const Xe=Le.find(Pe=>Pe.id===rt.id);return Xe?{...rt,position:Xe.position}:rt})),Le.length>0&&ts(Le),yt(Fe=>{const rt=Fe.map(Xe=>Xe.id===D.id?{...Xe,bounds:{...Xe.bounds,x:Xe.bounds.x+ve,y:Xe.bounds.y+De}}:Xe);return Tt.current=rt,rt}),Y.current={x:C.position.x,y:C.position.y}}else{const ve=D.bounds.x,De=D.bounds.y,Le=D.bounds.width,He=D.bounds.height,Fe=(Pe,ft,Lt)=>Math.max(ft,Math.min(Pe,Lt)),rt=Fe(C.position.x,ve+10,ve+Le-10),Xe=Fe(C.position.y,De+10,De+He-10);I(Pe=>Pe.map(ft=>ft.id===C.id?{...ft,position:{x:rt,y:Xe}}:ft)),Y.current={x:rt,y:Xe}}},[I,yt,ir,a,ts]),ha=t.useCallback(()=>{Ls.current=null,Y.current=null,Xs.current=null,Ls.current=null,Y.current=null,Xs.current=null,Qs(null),Tt.current.length>0&&Js(Tt.current)},[Js]),pa=t.useCallback((o,C)=>{const D=ir(C.id);D&&wt(D.id)},[ir]);if(t.useEffect(()=>{if(m.length===0||A.length===0)return;const o=m.filter(C=>{const D=A.find(ee=>ee.id===C.source),J=A.find(ee=>ee.id===C.target);return(J==null?void 0:J.type)==="midjourney"&&C.targetHandle==="text-input"&&(D==null?void 0:D.type)!=="agent"});o.length>0&&(c(C=>C.filter(D=>!o.some(J=>J.id===D.id))),f.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[m,A,c]),Z)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!pe)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Rr=A.filter(o=>o.selected).length>=2,xr=!!Be;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:vt,className:"flex-1 relative overflow-hidden",children:[P&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:O?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${O.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),pe&&e.jsx("div",{className:`absolute left-1/2 -translate-x-1/2 ${P?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:qe&&me?`${pe.name} ç¬¬${me.episodeNumber}é›†${!Oe&&re&&K?` ç¬¬${re}å¹•ç¬¬${K}é•œ`:""}`:pe.name})}),!Oe&&Ye.filter(o=>o.scene!==void 0&&o.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-[100px] top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Ye.filter(o=>o.scene!==void 0&&o.shot!==void 0).sort((o,C)=>o.scene!==C.scene?(o.scene||0)-(C.scene||0):(o.shot||0)-(C.shot||0)).map(o=>e.jsx("button",{onClick:()=>{wt(o.id);const C=o.bounds.x+o.bounds.width/2,D=o.bounds.y+o.bounds.height/2,J=vt.current;if(J){const ee=J.clientWidth,ve=J.clientHeight,De=.2,Le=ee*(1-De),He=ve*(1-De),Fe=Le/o.bounds.width,rt=He/o.bounds.height,Xe=Math.min(Fe,rt,1.5),Pe=Math.max(Xe,.3);he(C,D,{zoom:Pe,duration:800})}else he(C,D,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Be===o.id?"bg-neutral-800 dark:bg-white text-white dark:text-black shadow-lg":"bg-[#deeaef]/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-[#deeaef] dark:hover:bg-white/20"}`,children:o.name},o.id))})}),!1,e.jsxs("div",{className:"fixed right-[24px] top-1/2 -translate-y-1/2 z-[100] flex flex-col gap-1 p-2 rounded-2xl bg-[#deeaef] dark:bg-[#18181b] shadow-[0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_30px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{onClick:()=>{if(qe&&j&&n){const o=Oe&&re&&K?`?shot=${K}`:"";U(`/projects/${j}/episodes/${n}${o}`)}else U("/quick")},className:"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white",title:qe?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"arrow_back"})}),e.jsx("div",{className:"h-px bg-neutral-200 dark:bg-neutral-700 my-1"}),!P&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!bt&&a&&er(!bs)},disabled:bt||!a,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":bs?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:bs?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!bt&&a&&na()},disabled:bt||!a||!Rr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!Rr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_work"})}),e.jsx("button",{onClick:()=>{!bt&&a&&ia()},disabled:bt||!a||!xr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!xr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"group_off"})}),e.jsx("button",{onClick:()=>{!bt&&a&&la()},disabled:bt||!a||!xr,className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${bt||!a||!xr?"text-neutral-300 dark:text-neutral-600 cursor-not-allowed":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:a?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"edit"})}),e.jsx("button",{onClick:()=>oa(),className:`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${ws?"bg-black dark:bg-white text-white dark:text-black":"text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white"}`,title:ws?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 300'},children:"text_fields"})})]})]}),x&&Es.length>0&&e.jsxs("div",{className:`absolute ${P?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:Es.slice(0,8).map(o=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center overflow-hidden shadow-sm",title:o.nickname||"ç”¨æˆ·",children:o.avatar?e.jsx("img",{src:o.avatar.startsWith("http")?o.avatar:`https://api.waule.com${o.avatar}`,alt:o.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-neutral-600 dark:text-neutral-300",children:"person"})},o.id))}),Es.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",Es.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${bs?"cursor-crosshair":""} ${ws?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(Sa,{nodes:Bt,edges:m,onNodesChange:P?void 0:ds,onEdgesChange:P?void 0:Qr,onNodesDelete:P?void 0:Zr,onEdgesDelete:P?void 0:ea,onConnect:P?void 0:Yr,onConnectStart:P?void 0:ra,onConnectEnd:P?void 0:aa,onEdgeDoubleClick:P?void 0:Kr,onPaneContextMenu:P?void 0:ta,onPaneClick:P?void 0:ca,onMove:da,onNodeClick:P?void 0:pa,onNodeDragStart:P?void 0:ua,onNodeDrag:P?void 0:ga,onNodeDragStop:P?void 0:ha,nodeTypes:xn,edgeTypes:bn,nodesDraggable:!P,nodesConnectable:!P,elementsSelectable:!P,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${bs?"cursor-crosshair":""} ${P?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#525252",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:P?!1:bs,panOnDrag:bs?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(Ea,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#525252"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#404040"})]})}),Ye.filter(o=>!o.hidden).map(o=>{const C=te(),D=o.bounds.x*C.zoom+C.x,J=o.bounds.y*C.zoom+C.y,ee=o.bounds.width*C.zoom,ve=o.bounds.height*C.zoom,De=12*C.zoom,Le=Math.max(1.25,1.25*C.zoom),He=document.documentElement.classList.contains("dark"),Fe=Be===o.id;return e.jsxs("g",{children:[e.jsx("rect",{x:D,y:J,width:ee,height:ve,rx:De,ry:De,fill:"none",stroke:Fe?"url(#group-border-gradient)":He?"#e5e7eb":"#4b5563",strokeWidth:Le,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:D,y:J,width:ee,height:ve,rx:De,ry:De,fill:"transparent",stroke:"transparent",strokeWidth:Le*3,style:{pointerEvents:"stroke",cursor:hs===o.id?"grabbing":"grab"},onMouseDown:rt=>{rt.stopPropagation(),rt.preventDefault(),Ur(rt,o.id)},onClick:rt=>{rt.stopPropagation(),wt(o.id)}})]},o.id)})]})},sr),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Ye.filter(o=>!o.hidden).map(o=>{if(!o.name)return null;const C=te(),D=o.bounds.x*C.zoom+C.x,J=o.bounds.y*C.zoom+C.y,ee=40*C.zoom,ve=10*C.zoom,De=15*C.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:Le=>{Le.stopPropagation(),Ur(Le,o.id)},onClick:Le=>{Le.stopPropagation(),wt(o.id)},style:{left:D+ve,top:J-ee-ve-De,fontSize:`${ee}px`,cursor:hs===o.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:o.name},`label-${o.id}`)})},`labels-${sr}`),h&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:h.x,top:h.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("agent")},onMouseLeave:()=>{k.current=window.setTimeout(()=>{ie(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>ie("agent"),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("agent")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),V==="agent"&&e.jsx("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("agent")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(k.current=window.setTimeout(()=>{ie(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),ns("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ns("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),Ie(!0)},onMouseLeave:()=>{k.current=window.setTimeout(()=>{Ie(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ie("imageEdit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("imageEdit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("imageEdit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),q&&e.jsxs("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),Ie(!0)},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(k.current=window.setTimeout(()=>{Ie(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("hdUpscale","é«˜æ¸…æ”¾å¤§","hdUpscale")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("imageFusion","æ™ºèƒ½æº¶å›¾","imageFusion")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("smartStoryboard","æ™ºèƒ½åˆ†é•œ","smartStoryboard")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),H(!0)},onMouseLeave:()=>{Ne.current=window.setTimeout(()=>{H(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{ie("video")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("video")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),E&&e.jsxs("div",{onMouseEnter:()=>{Ne.current&&(clearTimeout(Ne.current),Ne.current=null),H(!0)},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(Ne.current=window.setTimeout(()=>{H(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),Ge.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ge.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ge.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ge.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ge.has("å‚è€ƒå›¾")||Ge.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ge.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ns("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("edit")},onMouseLeave:()=>{k.current=window.setTimeout(()=>{ie(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{ie("edit")},onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ie("edit")},onClick:o=>{o.preventDefault(),o.stopPropagation(),ie("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),V==="edit"&&e.jsxs("div",{onMouseEnter:()=>{k.current&&(clearTimeout(k.current),k.current=null),ie("edit")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(k.current=window.setTimeout(()=>{ie(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Qe.filter(o=>Wt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),o==="å¯¹å£å‹"?ns("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):o==="é£æ ¼è½¬æ¢"?ns("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ns("video",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:o}),ge(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},o)),Qe.every(o=>Wt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ns("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ns("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ns("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]})]}),is&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:is.x+5,top:is.y+5},children:[Ks.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>Ae(!0),onMouseLeave:()=>Ae(!1),onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},onClick:o=>{o.preventDefault(),o.stopPropagation(),Ae(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),Re&&e.jsx("div",{onMouseEnter:()=>{_e.current&&(clearTimeout(_e.current),_e.current=null),Ae(!0)},onMouseLeave:()=>{_e.current=window.setTimeout(()=>{Ae(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:M.length>0?M.map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),ls("agent",o.name,"agent",o.id,o.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:o.name}),o.description&&e.jsx("div",{className:"text-xs text-neutral-400 truncate",children:o.description})]})]},o.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Ks.showAiImage&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),Ks.showImageEditing&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("imageEdit")},onMouseLeave:()=>{u.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("imageEdit"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"edit"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),xe==="imageEdit"&&e.jsxs("div",{onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("imageEdit")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(u.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("hdUpscale","é«˜æ¸…æ”¾å¤§","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"high_quality"}),e.jsx("div",{className:"text-sm",children:"é«˜æ¸…æ”¾å¤§"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("imageFusion","æ™ºèƒ½æº¶å›¾","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½æº¶å›¾"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("smartStoryboard","æ™ºèƒ½åˆ†é•œ","image")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"grid_view"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½åˆ†é•œ"})]}),e.jsxs("button",{onMouseDown:o=>{o.preventDefault(),o.stopPropagation(),ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),Ks.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("video")},onMouseLeave:()=>{u.current=window.setTimeout(()=>{oe(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>oe("video"),onClick:o=>o.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),xe==="video"&&e.jsxs("div",{onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),oe("video")},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&(u.current=window.setTimeout(()=>{oe(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ls("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),Ge.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ls("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),Ge.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),Ge.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),Ge.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ls("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(Ge.has("å‚è€ƒå›¾")||Ge.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ls("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),Ge.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ls("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Ks.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe(null),$e.current&&(clearTimeout($e.current),$e.current=null),ge(!0)},onMouseLeave:()=>{$e.current=window.setTimeout(()=>{ge(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>ge(!0),onMouseLeave:()=>ge(!1),onClick:o=>{o.preventDefault(),o.stopPropagation(),ge(!0)},onMouseOver:()=>oe(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),b&&e.jsxs("div",{onMouseEnter:()=>{$e.current&&(clearTimeout($e.current),$e.current=null),ge(!0)},onMouseLeave:o=>{const C=o.currentTarget.parentElement,D=o.relatedTarget;(!C||!C.contains(D))&&($e.current=window.setTimeout(()=>{ge(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Qe.filter(o=>Wt(o).length>0).map(o=>e.jsxs("button",{onMouseDown:C=>{C.preventDefault(),C.stopPropagation(),o==="å¯¹å£å‹"?ls("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):o==="é£æ ¼è½¬æ¢"?ls("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ls("aiVideo_swap",o==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${o}`,"video"),ge(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:o})]},`conn-${o}`)),Qe.every(o=>Wt(o).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-neutral-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showUpload&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Ks.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Ks.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>oe(null),onClick:()=>ls("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(mn,{isOpen:Ct,onClose:()=>{_t(!1),gt(null)},onAssetSelect:sa}),Is&&Ns&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>Ss(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-neutral-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Ss(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const o=document.getElementById("scene-input"),C=document.getElementById("shot-input"),D=parseInt((o==null?void 0:o.value)||"0"),J=parseInt((C==null?void 0:C.value)||"0");if(D>0&&J>0){if(Ye.find(ve=>ve.id!==Ns&&ve.scene===D&&ve.shot===J)){f.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${D}å¹•-ç¬¬${J}é•œ`);return}yt(ve=>{const De=ve.map(He=>He.id===Ns?{...He,scene:D,shot:J,name:`ç¬¬${D}å¹•-ç¬¬${J}é•œ`}:He),Le=De.find(He=>He.id===Ns);return Le&&I(He=>{const Fe=new Set;return m.forEach(rt=>{if(Le.nodeIds.includes(rt.source)){const Xe=He.find(Pe=>Pe.id===rt.target);Xe&&(Xe.type==="imagePreview"||Xe.type==="videoPreview")&&Fe.add(rt.target)}}),He.map(rt=>Le.nodeIds.includes(rt.id)||Fe.has(rt.id)?{...rt,data:{...rt.data,workflowContext:{...rt.data.workflowContext,nodeGroup:Le,nodeGroups:De}}}:rt)}),setTimeout(()=>{qs()},100),De}),Ss(!1),Bs(null),f.success(`å·²å‘½åä¸ºï¼šç¬¬${D}å¹•-ç¬¬${J}é•œ`)}else f.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-neutral-800 dark:bg-white text-white dark:text-black hover:shadow-lg rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},En=()=>e.jsx(va,{children:e.jsx(wn,{})});export{En as default};
