const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cp0uMTfX.js","assets/react-vendor-CnSaCHf4.js","assets/react-vendor-Fd0xVSp_.css","assets/reactflow-COwzeFBM.js","assets/utils-BcyDR7Vi.js","assets/index-BauPnFGN.css"])))=>i.map(i=>d[i]);
import{r as t,j as e,n as Dt,u as Pr,e as ia,d as la}from"./react-vendor-CnSaCHf4.js";import{u as kr,l as ca,c as Me,_ as gs,b as g,e as da}from"./index-Cp0uMTfX.js";import{P as dt,H as Xs,a as ts,b as Ds,d as dr,e as Fs,g as ua,R as pa,f as fa,h as ga,i as ha,j as ma,C as xa}from"./reactflow-COwzeFBM.js";import{C as ba,L as Qs,S as hr,I as Tr,V as wa}from"./video-DBLD6CTd.js";import{c as Is}from"./createLucideIcon-Dx_rwhFP.js";import{f as Ws,g as Ts}from"./assetNaming-PUktT1IV.js";import{X as ya,j as Hs,L as Vs,o as Rr,a as ka,v as sr,U as Ur,b as va,N as Na}from"./fabric-BRmUkGAC.js";import"./utils-BcyDR7Vi.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=Is("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ia=Is("Brush",[["path",{d:"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08",key:"1styjt"}],["path",{d:"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z",key:"z0l1mu"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=Is("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=Is("Crop",[["path",{d:"M6 2v14a2 2 0 0 0 2 2h14",key:"ron5a4"}],["path",{d:"M18 22V8a2 2 0 0 0-2-2H2",key:"7s9ehn"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=Is("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Aa=Is("Film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=Is("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yr=Is("MousePointer2",[["path",{d:"m4 4 7.07 17 2.51-7.39L21 11.07z",key:"1vqm48"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ta=Is("MoveDown",[["path",{d:"M8 18L12 22L16 18",key:"cskvfv"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ra=Is("MoveUp",[["path",{d:"M8 6L12 2L16 6",key:"1yvkyx"}],["path",{d:"M12 2V22",key:"r89rzk"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Or=Is("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gr=Is("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ua=Is("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),$a="https://api.waule.com";function Ma(s){const{workflowId:C,isSharedWorkflow:u,isReadOnly:Q,onNodeAdd:Ie,onNodeUpdate:$,onNodeDelete:ve,onNodeMove:ee,onNodesMove:de,onEdgeAdd:Z,onEdgeDelete:ge,onGroupsUpdate:Oe,onUserJoin:he}=s,ne=t.useRef(null),se=t.useRef(!1),{token:fe}=kr(),[ce,Ce]=t.useState([]);t.useEffect(()=>{if(!u||!C||!fe)return;const x=ca($a,{auth:{token:fe},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return ne.current=x,x.on("connect",()=>{se.current=!0,x.emit("join-workflow",C),x.emit("user:join",{workflowId:C})}),x.on("disconnect",m=>{se.current=!1}),x.on("connect_error",m=>{}),x.on("node:add",m=>{Ie==null||Ie(m.node,m.userId)}),x.on("node:update",m=>{$==null||$(m.nodeId,m.changes,m.userId)}),x.on("node:delete",m=>{ve==null||ve(m.nodeId,m.userId)}),x.on("node:move",m=>{ee==null||ee(m.nodeId,m.position,m.userId)}),x.on("nodes:move",m=>{de==null||de(m.nodes,m.userId)}),x.on("edge:add",m=>{Z==null||Z(m.edge,m.userId)}),x.on("edge:delete",m=>{ge==null||ge(m.edgeId,m.userId)}),x.on("groups:update",m=>{Oe==null||Oe(m.groups,m.userId)}),x.on("user:join",m=>{he==null||he(m.user)}),x.on("users:online",m=>{Ce(m.users)}),()=>{ne.current&&(ne.current.emit("leave-workflow",C),ne.current.disconnect(),ne.current=null),se.current=!1,Ce([])}},[C,u,fe]);const K=t.useCallback(x=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("node:add",{workflowId:C,node:x})},[C,Q]),De=t.useCallback((x,m)=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("node:update",{workflowId:C,nodeId:x,changes:m})},[C,Q]),we=t.useCallback(x=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("node:delete",{workflowId:C,nodeId:x})},[C,Q]),ie=t.useCallback((x,m)=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("node:move",{workflowId:C,nodeId:x,position:m})},[C,Q]),R=t.useCallback(x=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("nodes:move",{workflowId:C,nodes:x})},[C,Q]),M=t.useCallback(x=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("edge:add",{workflowId:C,edge:x})},[C,Q]),P=t.useCallback(x=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("edge:delete",{workflowId:C,edgeId:x})},[C,Q]),T=t.useCallback(x=>{ne.current&&se.current&&C&&!Q&&ne.current.emit("groups:update",{workflowId:C,groups:x})},[C,Q]);return{isConnected:se.current,onlineUsers:ce,emitNodeAdd:K,emitNodeUpdate:De,emitNodeDelete:we,emitNodeMove:ie,emitNodesMove:R,emitEdgeAdd:M,emitEdgeDelete:P,emitGroupsUpdate:T}}const vr=1920,Vr=(s,C=vr,u=.9)=>new Promise((Q,Ie)=>{const $=new Image,ve=URL.createObjectURL(s);$.onload=()=>{URL.revokeObjectURL(ve);let{width:ee,height:de}=$;if(ee>C||de>C){const he=C/Math.max(ee,de);ee=Math.round(ee*he),de=Math.round(de*he)}const Z=document.createElement("canvas");Z.width=ee,Z.height=de;const ge=Z.getContext("2d");if(!ge){Ie(new Error("Failed to get canvas context"));return}ge.drawImage($,0,0,ee,de);const Oe=Z.toDataURL("image/jpeg",u);Q(Oe)},$.onerror=()=>{URL.revokeObjectURL(ve),Ie(new Error("Failed to load image for compression"))},$.src=ve}),$r=s=>s?[/^https?:\/\/localhost/i,/^https?:\/\/127\.0\.0\.1/i,/^https?:\/\/0\.0\.0\.0/i,/^https?:\/\/192\.168\./i,/^https?:\/\/10\./i,/^https?:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\./i,/^\/uploads\//i].some(u=>u.test(s)):!1,Da=async s=>{try{const C=s.startsWith("/uploads/")?`https://api.waule.com${s}`:s,Q=await(await fetch(C)).blob();return await Vr(Q,vr,.9)}catch(C){throw C}},Nr=async s=>{if(!s)throw new Error("Image URL is required");if(s.startsWith("data:image/")){if(s.length>500*1024)try{const u=await(await fetch(s)).blob();return await Vr(u,vr,.9)}catch{return s}return s}return s.includes("aliyuncs.com")||s.includes("oss-cn-")||s.startsWith("https://")&&!$r(s)?s:$r(s)?await Da(s):s},vt=({type:s,position:C,id:u,className:Q="",label:Ie,isConnectable:$,disabled:ve,style:ee,...de})=>{const Z=C===dt.Left,ge=$===!1||ve?"!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-purple-300 pointer-events-none opacity-60 rounded-full shadow-[0_0_5px_rgba(255,255,255,0.5)]":`!w-3.5 !h-3.5 bg-white dark:bg-black !border-2 !border-purple-300 pointer-events-auto rounded-full ${s==="target"?"opacity-70 cursor-default":"cursor-pointer hover:scale-125"} ${Q}`;return e.jsxs("div",{className:`absolute ${Z?"left-0 -translate-x-full":"right-0 translate-x-full"} top-1/2 -translate-y-1/2 flex items-center gap-1 pointer-events-none z-[10000]`,style:{zIndex:1e4,...ee||{}},children:[Z&&Ie&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:Ie}),e.jsx(Xs,{type:s,position:C,id:u,isConnectable:ve?!1:$,style:{position:"relative",[Z?"left":"right"]:"10px",transform:"none",zIndex:10001,cursor:s==="target"?"default":"pointer"},className:`${ge} !z-[10001]`,...de}),!Z&&Ie&&e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:Ie})]})},rs=({value:s,onChange:C,options:u,className:Q=""})=>{const[Ie,$]=t.useState(!1),ve=t.useRef(null);t.useEffect(()=>{if(!Ie)return;const Z=ge=>{ve.current&&!ve.current.contains(ge.target)&&$(!1)};return document.addEventListener("mousedown",Z,!0),()=>document.removeEventListener("mousedown",Z,!0)},[Ie]);const ee=u.find(Z=>Z.value===s),de=Z=>{Z.stopPropagation(),$(!Ie)};return e.jsxs("div",{className:`relative ${Q}`,ref:ve,children:[e.jsxs("div",{onClick:de,onMouseDown:Z=>Z.stopPropagation(),className:"nodrag flex justify-between items-center p-2 rounded-md border cursor-pointer text-xs transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 border-slate-200 dark:border-white/10 text-slate-800 dark:text-white",children:[e.jsx("span",{children:(ee==null?void 0:ee.label)||s}),e.jsx(ba,{size:12,className:`transition-transform ${Ie?"rotate-90":""}`})]}),Ie&&e.jsx("div",{className:"absolute top-full left-0 w-full mt-1 rounded-md border overflow-hidden z-[9999] shadow-xl bg-white/90 dark:bg-[#1a1a1a]/90 backdrop-blur-xl border-slate-200 dark:border-white/10",children:u.map(Z=>e.jsxs("div",{onClick:ge=>{ge.stopPropagation(),C(Z.value),$(!1)},onMouseDown:ge=>ge.stopPropagation(),className:"nodrag px-3 py-2 text-xs cursor-pointer flex items-center justify-between transition-colors hover:bg-slate-100 dark:hover:bg-white/10 text-slate-800 dark:text-white",children:[Z.label,s===Z.value&&e.jsx(Sa,{size:10,className:"text-purple-500"})]},Z.value))})]})},Ls=s=>{const[C,u]=t.useState(null),[Q,Ie]=t.useState(!1),[$,ve]=t.useState(!1),[ee,de]=t.useState(0),[Z,ge]=t.useState(0),Oe=t.useCallback(()=>{ge(he=>he+1)},[]);return t.useEffect(()=>{(async()=>{if(!s.aiModelId&&!s.nodeType&&!s.moduleType){u(null),ve(!1),de(0);return}try{Ie(!0);const se=(await Me.post("/billing/estimate",s)).data,fe=(se==null?void 0:se.data)??se,ce=(fe==null?void 0:fe.originalCredits)??(fe==null?void 0:fe.credits)??0;u(ce),ve((fe==null?void 0:fe.isFreeUsage)??!1),de((fe==null?void 0:fe.freeUsageRemaining)??0)}catch{u(null),ve(!1),de(0)}finally{Ie(!1)}})()},[s.aiModelId,s.nodeType,s.moduleType,s.quantity,s.duration,s.resolution,s.mode,s.operationType,s.characterCount,Z]),{credits:C,loading:Q,isFreeUsage:$,freeUsageRemaining:ee,refetch:Oe}},fs=({createdBy:s,isSharedWorkflow:C})=>{if(!C||!s||typeof s=="string")return null;const{nickname:u,avatar:Q}=s;return e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 z-10",title:u||"æœªçŸ¥ç”¨æˆ·",children:Q?e.jsx("img",{src:Q,alt:u||"",className:"w-12 h-12 rounded-full object-cover border-2 border-white dark:border-slate-700 shadow-md"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-lg font-medium border-2 border-white dark:border-slate-700 shadow-md",children:(u||"?")[0].toUpperCase()})})},La=({data:s,selected:C,id:u})=>{var le;const[Q,Ie]=t.useState(s.isExpanded!==!1),[$,ve]=t.useState(null),[ee,de]=t.useState(s.config.prompt||""),[Z,ge]=t.useState(s.config.ratio||""),[Oe,he]=t.useState(s.config.imageSize||"2K"),[ne,se]=t.useState(s.config.maxImages||1),[fe,ce]=t.useState(!1),[,Ce]=t.useState(0),[,K]=t.useState(s.config.taskId||""),[De,we]=t.useState(s.config.referenceImages||[]),[ie,R]=t.useState(null),M=t.useRef(null),P=t.useRef(!1),{setNodes:T,setEdges:x,getNode:m,getEdges:j,getNodes:te}=ts(),L=Ds(),A=dr(S=>S.edges.filter(f=>f.target===u)),O=t.useRef(""),r=t.useRef(""),{credits:b,loading:l,isFreeUsage:n,freeUsageRemaining:o,refetch:a}=Ls({aiModelId:$==null?void 0:$.id,quantity:1,resolution:Oe}),c=t.useMemo(()=>(s.models||[]).filter(S=>S.type==="IMAGE_GENERATION"&&S.isActive&&!S.name.toLowerCase().includes("midjourney")),[s.models]);t.useEffect(()=>{if(s.config.modelId){const S=c.find(f=>f.id===s.config.modelId);if(S){ve(S);const f=S.config;f!=null&&f.supportedRatios&&f.supportedRatios.length>0&&!Z&&ge(f.supportedRatios[0]),s.config.acceptedInputs||d({acceptedInputs:(f==null?void 0:f.acceptedInputs)||["TEXT","IMAGE"]})}}else if(c.length>0){ve(c[0]);const S=c[0].config;S!=null&&S.supportedRatios&&S.supportedRatios.length>0&&!Z&&ge(S.supportedRatios[0]),s.config.acceptedInputs||d({acceptedInputs:(S==null?void 0:S.acceptedInputs)||["TEXT","IMAGE"]})}},[s.config.modelId,c]),t.useEffect(()=>{const S=s.config.taskId;(async()=>{if(S)try{const h=(await Me.tasks.getTaskStatus(S)).task;if(h.status==="SUCCESS"){ce(!1),Ce(100);const W=h.resultUrl;if(!W){ce(!1),Ce(0),d({taskId:""}),Dt.error("ç”Ÿæˆå®Œæˆï¼Œä½†å›¾ç‰‡è·å–å¤±è´¥ï¼Œè¯·é‡è¯•");return}const ue=s.config.ratio||"1:1";d({prompt:s.config.prompt||ee,ratio:ue,modelId:s.config.modelId||($==null?void 0:$.id),generatedImageUrl:W,taskId:""});const q=te(),be=j();if(q.filter(_e=>_e.type==="imagePreview"&&be.some(je=>je.source===u&&je.target===_e.id)).find(_e=>_e.data.imageUrl===W)){d({taskId:""}),Dt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");return}Dt.success("å›¾ç‰‡ç”Ÿæˆå·²å®Œæˆï¼");try{const _e=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(_e).some(Re=>Re.taskId&&Re.taskId===S||Re.sourceNodeId&&Re.sourceNodeId===u)||oe(W,ue)}catch{oe(W,ue)}}else h.status==="PROCESSING"||h.status==="PENDING"?(ce(!0),Ce(h.progress||0),J(S)):h.status==="FAILURE"&&(ce(!1),Ce(0),d({taskId:""}),Dt.error(h.errorMessage?`å¾ˆæŠ±æ­‰ï¼Œç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${h.errorMessage}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{ce(!1),Ce(0),d({taskId:""}),Dt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const w=()=>{if(!$)return[];const S=$.config;return(S==null?void 0:S.supportedRatios)||[]},I=()=>{var h;const S=(h=s==null?void 0:s.config)==null?void 0:h.modelId,f=c.find(W=>W.id===S)||c[0],k=(f==null?void 0:f.config)||{};return k.maxReferenceImages||k.supportedReferenceImagesLimit||k.referenceImagesLimit||10};function D(S){var k,h,W,ue,q,be,Se;const f=(S==null?void 0:S.type)||"";if(f==="upload")return(((h=(k=S==null?void 0:S.data)==null?void 0:k.config)==null?void 0:h.uploadedFiles)||[]).reduce((_e,je)=>{const Te=((je==null?void 0:je.type)||"").toUpperCase(),Re=((je==null?void 0:je.mimeType)||"").toLowerCase();return _e+(Te==="IMAGE"||Re.startsWith("image/")?1:0)},0);if(f==="assetSelector"){const ye=((W=S==null?void 0:S.data)==null?void 0:W.config)||{};if(ye.selectedAsset){const _e=(ye.selectedAsset.type||"").toUpperCase(),je=(ye.selectedAsset.mimeType||"").toLowerCase();return _e==="IMAGE"||je.startsWith("image/")?1:0}return Array.isArray(ye.subjects)&&ye.subjects.length>0&&(((ue=ye.subjects[0])==null?void 0:ue.images)||[]).length>0?1:0}return f==="aiImage"?((be=(q=S==null?void 0:S.data)==null?void 0:q.config)==null?void 0:be.generatedImageUrl)?1:0:f==="imagePreview"&&((Se=S==null?void 0:S.data)==null?void 0:Se.imageUrl)?1:0}function B(S){var h,W,ue,q;const f=(S==null?void 0:S.type)||"",k=S==null?void 0:S.data;if(f==="upload"&&((W=(h=k==null?void 0:k.config)==null?void 0:h.uploadedFiles)==null?void 0:W.length)>0){const be=k.config.uploadedFiles[0],Se=(be.type||"").toUpperCase(),ye=(be.mimeType||"").toLowerCase();return Se==="IMAGE"||ye.startsWith("image/")?"IMAGE":Se==="VIDEO"||ye.startsWith("video/")?"VIDEO":Se==="AUDIO"||ye.startsWith("audio/")?"AUDIO":Se||null}if(f==="assetSelector"){if((ue=k==null?void 0:k.config)!=null&&ue.subjects)return"IMAGE";if((q=k==null?void 0:k.config)!=null&&q.selectedAsset){const be=k.config.selectedAsset,Se=(be.type||"").toUpperCase(),ye=(be.mimeType||"").toLowerCase();return Se==="IMAGE"||ye.startsWith("image/")?"IMAGE":Se==="VIDEO"||ye.startsWith("video/")?"VIDEO":Se==="AUDIO"||ye.startsWith("audio/")?"AUDIO":Se||null}}return f==="aiImage"||f==="imagePreview"?"IMAGE":(f||"").startsWith("aiVideo")||f==="videoPreview"?"VIDEO":f==="agent"?"TEXT":null}const v=t.useMemo(()=>{const S=A,f=S.some(W=>{const ue=m(W.source);return((ue==null?void 0:ue.type)||"")==="agent"}),k=I(),h=S.reduce((W,ue)=>W+D(m(ue.source)),0);return f&&h>=k},[A,m]),p=S=>{const f=m(S.source);if(!f)return!1;const k=f.type||"",h=j().filter(ye=>ye.target===u),W=B(f);if(W==="VIDEO"||W==="AUDIO"||W==="DOCUMENT")return!1;const ue=h.some(ye=>{const _e=m(ye.source);return((_e==null?void 0:_e.type)||"")==="agent"});if(k==="agent"||k==="textPreview")return!ue;const q=h.reduce((ye,_e)=>ye+D(m(_e.source)),0),be=D(f),Se=I();return q+be<=Se};t.useEffect(()=>{const S=A;let k=I();const h=[];S.forEach(W=>{const ue=m(W.source),q=D(ue);q<=0||(k-q>=0?k-=q:h.push(W.id))}),h.length>0&&(x(W=>W.filter(ue=>!h.includes(ue.id))),Dt.error("å‚è€ƒå›¾æ•°é‡å·²è¾¾ä¸Šé™ï¼Œå¤šä½™çš„è¿æ¥å·²è‡ªåŠ¨æ–­å¼€"))},[A,m,x]),t.useEffect(()=>{const S=A,f=[];S.forEach(k=>{const h=m(k.source),W=B(h);(W==="VIDEO"||W==="AUDIO"||W==="DOCUMENT")&&f.push(k.id)}),f.length>0&&(x(k=>k.filter(h=>!f.includes(h.id))),Dt.error("å›¾ç‰‡ç”ŸæˆèŠ‚ç‚¹ä»…æ”¯æŒå›¾ç‰‡å’Œæ–‡æœ¬è¾“å…¥å“¦"))},[A,m,x]),t.useEffect(()=>{const S=A.map(ue=>{var ye,_e,je,Te,Re;const q=m(ue.source);if(!q)return`${ue.id}-${ue.source}`;const be=q.data||{};let Se=[];if(q.type==="assetSelector"){const re=(ye=be.config)==null?void 0:ye.subjects;if(re&&re.length>0){const Be=(_e=re[0].images)==null?void 0:_e[0];Se=Be?[Be]:[]}else(je=be.config)!=null&&je.selectedAsset&&be.config.selectedAsset.type==="IMAGE"&&(Se=[be.config.selectedAsset.url])}else if(q.type==="upload")Se=(((Te=be.config)==null?void 0:Te.uploadedFiles)||[]).filter(Be=>Be.type==="IMAGE").map(Be=>Be.url);else if(q.type==="aiImage"||q.type==="imagePreview"){const re=((Re=be.config)==null?void 0:Re.generatedImageUrl)||be.imageUrl;re&&(Se=[re])}return`${ue.id}-${ue.source}-${Se.join("|")}`}).sort().join(",");if(S===O.current)return;O.current=S;const f=[];let k="";A.forEach(ue=>{var be,Se,ye,_e,je,Te;const q=m(ue.source);if(q){const Re=q.data;if(q.type==="agent"&&((be=Re.config)!=null&&be.generatedText)?k||(k=Re.config.generatedText):q.type==="textPreview"&&Re.content&&(k||(k=Re.content)),q.type==="assetSelector"&&((Se=Re.config)!=null&&Se.subjects)&&Re.config.subjects.length>0){const Be=(ye=Re.config.subjects[0].images)==null?void 0:ye[0];Be&&!f.includes(Be)&&f.push(Be)}let re=((_e=Re.config)==null?void 0:_e.generatedImageUrl)||Re.imageUrl||"";if(!re&&((je=Re.config)!=null&&je.selectedAsset)){const Be=Re.config.selectedAsset;Be.type==="IMAGE"&&(re=Be.url)}if(!re&&((Te=Re.config)!=null&&Te.uploadedFiles)&&Re.config.uploadedFiles.length>0){const Be=Re.config.uploadedFiles[0];Be.type==="IMAGE"&&(re=Be.url)}re&&!f.includes(re)&&f.push(re)}});const h=I(),W=f.slice(0,Math.max(0,h));we(W),d({referenceImages:W}),k&&k!==ee&&(de(k),d({prompt:k}))},[A,m,u,ee,L]),t.useEffect(()=>{if(A.length===0)return;let S="",f="";A.forEach(k=>{var W;const h=L.find(ue=>ue.id===k.source);if(h&&h.type==="agent"){const ue=h.data;(W=ue.config)!=null&&W.generatedText&&(S=ue.config.generatedText,f=`${h.id}-${ue.config.generatedText.substring(0,50)}`)}}),S&&f!==r.current&&(r.current=f,de(S),d({prompt:S}))},[L,A,u]),t.useEffect(()=>{const S=M.current;S&&Q&&requestAnimationFrame(()=>{S.style.height="auto";const f=Math.max(60,Math.min(S.scrollHeight,600));S.style.height=`${f}px`})},[ee,Q]),t.useEffect(()=>{const S=setTimeout(()=>{ee!==s.config.prompt&&d({prompt:ee})},300);return()=>clearTimeout(S)},[ee]),t.useEffect(()=>{s.config.prompt&&s.config.prompt!==ee&&de(s.config.prompt)},[s.config.prompt]),t.useEffect(()=>{Z&&Z!==s.config.ratio&&d({ratio:Z})},[Z]),t.useEffect(()=>{Oe&&Oe!==s.config.imageSize&&d({imageSize:Oe})},[Oe]),t.useEffect(()=>{var S;if(($==null?void 0:$.modelId)==="gemini-3-pro-image-preview"){const f=((S=$==null?void 0:$.config)==null?void 0:S.supportedResolutions)||[];(f.length>0&&!f.includes(Oe)||f.length===1)&&he(f[0])}},[$]),t.useEffect(()=>{ne!==s.config.maxImages&&d({maxImages:ne})},[ne]);const d=S=>{m(u)&&T(k=>k.map(h=>h.id===u?{...h,data:{...h.data,config:{...h.data.config,...S}}}:h))},E=S=>{R(S)},Y=(S,f)=>{if(S.preventDefault(),ie===null||ie===f)return;const k=[...De],h=k[ie];k.splice(ie,1),k.splice(f,0,h),we(k),R(f)},X=()=>{R(null),d({referenceImages:De})},J=async S=>{let k=0;const h=async()=>{var W;try{k++;const q=(await Me.tasks.getTaskStatus(S)).task;if(Ce(q.progress||0),q.status==="SUCCESS"){ce(!1),Ce(100);const be=q.resultUrl,Se=(W=q.metadata)==null?void 0:W.allImageUrls;d({prompt:ee,ratio:Z,modelId:$==null?void 0:$.id,generatedImageUrl:be,taskId:""}),Se&&Se.length>1?(ae(Se,Z),Dt.success(`ğŸ‰ åˆ›ä½œå®Œæˆï¼å…±ç”Ÿæˆ ${Se.length} å¼ ç²¾ç¾å›¾ç‰‡`)):(oe(be,Z),Dt.success("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼"));return}else if(q.status==="FAILURE"){ce(!1),Ce(0),d({taskId:""});const{useAuthStore:be}=await gs(async()=>{const{useAuthStore:ye}=await import("./index-Cp0uMTfX.js").then(_e=>_e.f);return{useAuthStore:ye}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Se}=be.getState();await Se(),Dt.error(q.errorMessage||"ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(q.status==="PROCESSING"||q.status==="PENDING")&&(k<600?setTimeout(h,1e3):(ce(!1),Ce(0),d({taskId:""}),Dt.error("ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{ce(!1),Ce(0),d({taskId:""}),Dt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};h()},F=async()=>{var S,f,k,h,W;if(!(!ee.trim()||!$)){ce(!0),Ce(0);try{let ue=[];if(De.length>0)try{for(const Re of De){const re=await Nr(Re);ue.push(re)}}catch{}let q=ee.trim();$.modelId==="doubao-seedream-4-5-251128"&&ne>1&&(q=`ç”Ÿæˆä¸€ç»„å…±${ne}å¼ è¿è´¯å›¾ç‰‡ï¼Œ${q}`),$.modelId==="gemini-3-pro-image-preview"&&Z&&(q=`${q}ï¼Œç”Ÿæˆ${Z}çš„æ¯”ä¾‹`);const be={modelId:$.id,prompt:q,ratio:Z||"1:1",referenceImages:ue.length>0?ue:void 0};$.modelId==="gemini-3-pro-image-preview"&&(be.imageSize=Oe),$.modelId==="doubao-seedream-4-5-251128"&&ne>1&&(be.maxImages=ne);const Se=await Me.tasks.createImageTask(be),ye=Se.taskId,_e=Se.creditsCharged||0,je=Se.isFreeUsage,Te=Se.freeUsageRemaining??0;if(K(ye),d({prompt:ee,ratio:Z,modelId:$.id,taskId:ye}),je)Dt.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${Te} æ¬¡æœºä¼š`),a();else if(_e>0){const{useAuthStore:Re}=await gs(async()=>{const{useAuthStore:Be}=await import("./index-Cp0uMTfX.js").then(qe=>qe.f);return{useAuthStore:Be}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:re}=Re.getState();await re(),Dt.success(`âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${_e} ç§¯åˆ†`),a()}else Dt.success("âœ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");J(ye)}catch(ue){if(ce(!1),Ce(0),((S=ue.response)==null?void 0:S.status)===403){const q=((k=(f=ue.response)==null?void 0:f.data)==null?void 0:k.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";Dt.error(q)}else{const q=((W=(h=ue.response)==null?void 0:h.data)==null?void 0:W.error)||ue.message||"æœªçŸ¥åŸå› ";Dt.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${q}ï¼Œè¯·ç¨åé‡è¯•`)}}}},ae=(S,f)=>{!S||S.length===0||S.forEach((k,h)=>{setTimeout(()=>{oe(k,f,h)},h*100)})},oe=(S,f,k)=>{const h=m(u);if(!h)return;const W=1,ue=te(),q=j(),be=ue.filter(Ot=>Ot.type==="imagePreview"&&q.some(tt=>tt.source===u&&tt.target===Ot.id));if(be.find(Ot=>Ot.data.imageUrl===S))return;const ye=400,_e=(Ot,tt=300)=>{if(!Ot||!/^[0-9]+\s*:\s*[0-9]+$/.test(Ot))return tt;const[_t,Kt]=Ot.split(":").map(bs=>parseFloat(bs));return!_t||!Kt?tt:Math.round(ye*(Kt/_t))},je=document.querySelector(`.react-flow__node[data-id="${u}"]`),Te=(je==null?void 0:je.getBoundingClientRect().width)||400,Re=Math.round(Te/W),re=200,Be=100,qe=_e(f,300),Ft=h.position.x+Re+re,at=h.position.y,ot=k!==void 0?be.length+k:be.length,Le=Ft,ut=at+ot*(qe+Be),Et=Date.now(),nt={id:`preview-${u}-${Et}`,type:"imagePreview",position:{x:Le,y:ut},data:{imageUrl:S,width:ye,ratio:f,workflowContext:h.data.workflowContext,createdBy:h.data.createdBy}};T(Ot=>[...Ot,nt]);const yt={id:`edge-${u}-${nt.id}`,source:u,target:nt.id,targetHandle:`${nt.id}-target`,type:"aurora"};x(Ot=>Ot.find(_t=>_t.source===u&&_t.target===nt.id)?Ot:[...Ot,yt])};if(t.useEffect(()=>{s.isExpanded!==void 0&&Ie(s.isExpanded)},[s.isExpanded]),!Q&&s.config.generatedImageUrl){const[S,f]=(s.config.ratio||"1:1").split(":").map(Number),k=S/f,h=320,W=h/k;return e.jsxs("div",{className:"relative cursor-pointer",style:{width:h,height:W},onDoubleClick:()=>{Ie(!0),m(u)&&T(q=>q.map(be=>be.id===u?{...be,data:{...be.data,isExpanded:!0}}:be))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]",isConnectable:!0,disabled:v,isValidConnection:p}),e.jsx("img",{src:s.config.generatedImageUrl,alt:"",className:"w-full h-full object-cover rounded-2xl"}),ee&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 rounded-b-2xl",children:e.jsx("p",{className:"truncate",title:ee,children:ee})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] !z-[10000]"})]})}return!Q&&!s.config.generatedImageUrl?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},onDoubleClick:()=>{Ie(!0),m(u)&&T(f=>f.map(k=>k.id===u?{...k,data:{...k.data,isExpanded:!0}}:k))},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:v,isValidConnection:p}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:ee?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("p",{className:"text-xs text-slate-800 dark:text-white line-clamp-6 whitespace-pre-wrap break-words",children:ee})]}):e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]}):e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:!0,disabled:v,isValidConnection:p}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"image"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4 space-y-4",children:Q?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:($==null?void 0:$.id)||"",onChange:S=>{const f=c.find(k=>k.id===S);if(ve(f||null),f){const k=f.config;k!=null&&k.supportedRatios&&k.supportedRatios.length>0&&ge(k.supportedRatios[0]),d({modelId:f.id,acceptedInputs:(k==null?void 0:k.acceptedInputs)||["TEXT","IMAGE"]})}},options:c.map(S=>({value:S.id,label:S.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:M,value:ee,onChange:S=>{P.current=!0,de(S.target.value)},className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨çš„åˆ›æ„",style:{minHeight:"60px"}})]}),De.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",De.length,")"]}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:"repeat(5, 1fr)",width:"100%"},children:De.map((S,f)=>e.jsxs("div",{draggable:!0,onDragStart:k=>{k.stopPropagation(),E(f)},onDragEnd:k=>{k.stopPropagation(),X()},onDragOver:k=>{k.stopPropagation(),Y(k,f)},className:`nodrag relative group cursor-move aspect-square ${ie===f?"opacity-50":""}`,children:[e.jsx("img",{src:S,alt:`å›¾ç‰‡${f+1}`,className:"w-full h-full object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"}),e.jsx("div",{className:"absolute top-0 left-0 bg-purple-600 text-white text-xs px-1.5 py-0.5 rounded-br",children:f+1})]},f))})]}),($==null?void 0:$.modelId)==="gemini-3-pro-image-preview"&&(()=>{var f;const S=((f=$==null?void 0:$.config)==null?void 0:f.supportedResolutions)||[];return S.length<=1?null:e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆ†è¾¨ç‡"}),e.jsx("div",{className:`grid grid-cols-${S.length} gap-2`,children:S.map(k=>e.jsx("button",{onClick:()=>he(k),className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-colors border ${Oe===k?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent dark:border-white/10":"bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white/70 border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:k==="4K"?"4k":"hd"}),e.jsx("span",{children:k})]})},k))})]})})(),($==null?void 0:$.modelId)==="doubao-seedream-4-5-251128"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‡ºå›¾æ•°é‡"}),e.jsxs("span",{className:"text-xs font-mono text-purple-500 dark:text-purple-400",children:[ne," å¼ "]})]}),e.jsx("input",{type:"range",min:"1",max:"15",value:ne,onChange:S=>se(Number(S.target.value)),className:"nodrag w-full h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-500"}),e.jsxs("div",{className:"flex justify-between text-[9px] text-slate-400 dark:text-white/40",children:[e.jsx("span",{children:"1å¼ "}),e.jsx("span",{children:"15å¼ "})]}),ne>1&&e.jsx("p",{className:"text-[9px] text-amber-500 dark:text-amber-400",children:"ğŸ’¡ ç»„å›¾æ¨¡å¼ï¼šç”Ÿæˆä¸€ç»„è¿è´¯çš„å›¾ç‰‡ï¼Œç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰"})]}),w().length>0&&e.jsx("div",{className:"space-y-1",children:((le=$==null?void 0:$.provider)==null?void 0:le.toLowerCase())==="sora"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>ge("16:9"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Z==="16:9"?"bg-purple-600 text-white border-purple-500":"bg-purple-950/50 text-purple-300 border-purple-700/30 hover:bg-purple-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>ge("9:16"),className:`nodrag py-2 rounded text-sm font-medium transition-colors border ${Z==="9:16"?"bg-purple-600 text-white border-purple-500":"bg-purple-950/50 text-purple-300 border-purple-700/30 hover:bg-purple-900/50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å›¾ç‰‡æ¯”ä¾‹"}),e.jsx(rs,{value:Z,onChange:S=>ge(S),options:w().map(S=>{const[f,k]=S.split(":");return{value:S,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[S]||`${f}:${k}`}})})]})}),e.jsx("button",{onClick:F,onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),disabled:fe||!ee.trim()||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${fe?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:fe?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),!l&&(n?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",o,"æ¬¡"]}):b!==null&&b>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[b,"ç§¯åˆ†"]}):null)]})})]}):null}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Pa=t.memo(La),cr="https://api.waule.com",Oa=({data:s,selected:C,id:u})=>{var ms,Es,Ys,G,z,Pe,Ue,Xe,We,Ye,ct;const[Q,Ie]=t.useState(!0),[,$]=t.useState(0),[ve,ee]=t.useState(s.config.taskId||""),de=s.config.modelId,Z=s.config.duration||5,ge=s.config.resolution||"720p",{credits:Oe,loading:he,isFreeUsage:ne,freeUsageRemaining:se,refetch:fe}=Ls({aiModelId:de,duration:Z,resolution:ge});t.useEffect(()=>{},[ve]);const{setNodes:ce,setEdges:Ce,getNode:K,getNodes:De,getEdges:we}=ts(),ie=Fs(),R=Ds(),M=t.useRef(""),P=(ms=s.config)==null?void 0:ms.selectedEditingCapability,T=t.useMemo(()=>{const N=(s.models||[]).filter(_=>{var pe;return((pe=_.provider)==null?void 0:pe.toLowerCase())!=="sora"&&_.id!=="sora-video"});if(P){const _=N.filter(Ne=>Ne.type==="VIDEO_EDITING").filter(Ne=>{var me;return Array.isArray((me=Ne==null?void 0:Ne.config)==null?void 0:me.supportedEditingCapabilities)&&Ne.config.supportedEditingCapabilities.includes(P)}),pe=N.filter(Ne=>Ne.type==="VIDEO_GENERATION").filter(Ne=>{var xt,it;if(P!=="è§†é¢‘æ¢äºº")return!1;const me=((xt=Ne==null?void 0:Ne.config)==null?void 0:xt.supportsVideoEditing)===!0,Ze=(Array.isArray((it=Ne==null?void 0:Ne.config)==null?void 0:it.supportedGenerationTypes)?Ne.config.supportedGenerationTypes:[]).some(Ge=>(Ge||"").toLowerCase().includes("æ¢äºº")||(Ge||"").includes("è§†é¢‘æ¢äºº"));return me||Ze}),Ae={};return[..._,...pe].forEach(Ne=>{Ae[Ne.id]||(Ae[Ne.id]=Ne)}),Object.values(Ae)}return N.filter(_=>_.type==="VIDEO_GENERATION")},[s.models,P]),[x,m]=t.useState(s.config.prompt||""),j=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==x&&m(s.config.prompt)},[s.config.prompt]);const[te,L]=t.useState(s.config.modelId||((Es=T[0])==null?void 0:Es.id)||""),[A,O]=t.useState(s.config.ratio||"16:9"),[r,b]=t.useState(s.config.resolution||""),l=t.useCallback(N=>{const _=(N||"").toLowerCase();return _?_.includes("æ–‡ç”Ÿ")||_.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":_.includes("é¦–å°¾")?"é¦–å°¾å¸§":_.includes("é¦–å¸§")||_.includes("first frame")||_.includes("start frame")||_.includes("initial frame")||_.includes("keyframe")?"é¦–å¸§":_.includes("å°¾å¸§")||_.includes("last frame")||_.includes("end frame")||_.includes("final frame")?"å°¾å¸§":_.includes("ä¸»ä½“å‚è€ƒ")||_.includes("å‚è€ƒ")||_.includes("reference image")||_.includes("image reference")||_.includes("ref image")?"å‚è€ƒå›¾":_.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":_.includes("first-last")||_.includes("two-frame")||_.includes("frame pair")?"é¦–å°¾å¸§":_.includes("first")?"é¦–å¸§":_.includes("last")?"å°¾å¸§":_.includes("subject")||_.includes("reference")?"å‚è€ƒå›¾":N||"":""},[]),[n,o]=t.useState((s.config.lockedGenerationType?l(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[a,c]=t.useState(s.config.duration||5),[w,I]=t.useState(s.config.audio||!1),[D,B]=t.useState(s.config.movementAmplitude||"auto"),[v,p]=t.useState(!1),[d,E]=t.useState([]),[Y,X]=t.useState(null),[J,F]=t.useState(!1),[ae]=t.useState(""),[oe]=t.useState("confirm"),[le]=t.useState(null),[S,f]=t.useState(!1),[k,h]=t.useState([]),[W,ue]=t.useState(""),[q,be]=t.useState(0),[Se,ye]=t.useState(0),[_e,je]=t.useState({}),[Te,Re]=t.useState([]),re=T.find(N=>N.id===te);t.useEffect(()=>{var N,_;if(!T.find(pe=>pe.id===te)){const pe=((N=T[0])==null?void 0:N.id)||"";L(pe),Le({modelId:pe,modelName:(_=T[0])==null?void 0:_.name})}},[T]),t.useEffect(()=>{var N;if((N=re==null?void 0:re.config.supportedResolutions)!=null&&N.length){const _=re.config.supportedResolutions;if(!r||!_.includes(r)){const pe=_[0];b(pe),Le({resolution:pe})}}},[re==null?void 0:re.id]),t.useEffect(()=>{var pe;const N=(pe=re==null?void 0:re.modelId)==null?void 0:pe.includes("viduq2"),_=l(n)==="é¦–å°¾å¸§";N&&_&&a>8&&(c(8),Le({duration:8}))},[n,re==null?void 0:re.modelId]);const Be=((Ys=re==null?void 0:re.provider)==null?void 0:Ys.toLowerCase())==="sora",qe=t.useMemo(()=>{var N,_,pe,Ae;if((N=re==null?void 0:re.config.supportedDurations)!=null&&N.length){let Ne=re.config.supportedDurations;const me=(_=re.modelId)==null?void 0:_.includes("viduq2"),Qe=l(n)==="é¦–å°¾å¸§";return me&&Qe&&(Ne=Ne.filter(xt=>xt<=8)),(((pe=re.provider)==null?void 0:pe.toLowerCase())==="minimax"||((Ae=re.modelId)==null?void 0:Ae.toLowerCase().includes("minimax")))&&r&&r.includes("1080")&&(Ne=Ne.filter(xt=>xt===6)),Ne}return[a||5]},[re,a,n,l,r]),Ft=t.useMemo(()=>{var N;return(N=re==null?void 0:re.config.supportedResolutions)!=null&&N.length?re.config.supportedResolutions:[]},[re]),at=!re||!((G=re.config.supportedDurations)!=null&&G.length),ot=!re||!((z=re.config.supportedResolutions)!=null&&z.length),Le=t.useCallback(N=>{K(u)&&ce(pe=>pe.map(Ae=>Ae.id===u?{...Ae,data:{...Ae.data,config:{...Ae.data.config,...N}}}:Ae))},[K,u,ce]);t.useEffect(()=>{if(qe.length>0&&!qe.includes(a)){const N=qe[0];c(N),Le({duration:N})}},[qe,a,Le]);const ut=(N,_)=>{const pe=(xt,it)=>it===0?xt:pe(it,xt%it),Ae=pe(N,_),Ne=N/Ae,me=_/Ae,Qe={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},Ze=`${Ne}:${me}`;return Qe[Ze]||Ze},Et=()=>{const N=ie.filter(Qe=>Qe.target===u),_=[];N.forEach(Qe=>{var xt;const Ze=K(Qe.source);if(Ze&&Ze.type==="upload"&&(((xt=Ze.data.config)==null?void 0:xt.uploadedFiles)||[]).forEach(Ge=>{const Rt=Ge.type||Ge.mimeType||"";(Rt==="IMAGE"||Rt.startsWith("image/"))&&_.push({id:Ge.id||Ge.name,url:Ge.url,name:Ge.name||Ge.originalName,width:Ge.width,height:Ge.height,aspectRatio:Ge.width&&Ge.height?ut(Ge.width,Ge.height):"16:9"})}),Ze&&Ze.type==="assetSelector"){const it=Ze.data.config||{},Ge=it.subjects,Rt=it.selectedAsset,Bt=l(n);Ge&&Ge.length>0?Bt==="é¦–å°¾å¸§"||(Ge[0].images||[]).forEach((Gt,wt)=>{_.push({id:`${Ze.id}-subject-${wt}`,url:Gt,name:Ge[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):Rt&&Rt.type==="IMAGE"&&_.push({id:Rt.id,url:Rt.url,name:Rt.name||Rt.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(Ze&&Ze.type==="imagePreview"){const it=Ze.data.imageUrl,Ge=Ze.data.width,Rt=Ze.data.height;it&&_.push({id:Ze.id,url:it,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:Ge,height:Rt,aspectRatio:Ge&&Rt?ut(Ge,Rt):"16:9"})}});const pe=new Set,Ae=[];_.forEach(Qe=>{const Ze=Qe.url;pe.has(Ze)||(pe.add(Ze),Ae.push(Qe))});const Ne=l(n);let me=[];return Ne==="æ–‡ç”Ÿè§†é¢‘"?me=[]:Ne==="é¦–å¸§"||Ne==="å°¾å¸§"?me=Ae.slice(0,1):Ne==="é¦–å°¾å¸§"?me=Ae.slice(0,2):Ne==="å‚è€ƒå›¾"?me=Ae.slice(0,7):me=Ae,me},nt=t.useMemo(()=>Et(),[ie,R,n,u]),yt=N=>{if(!j.current)return;const _=j.current,pe=_.selectionStart||x.length,Ae=x.slice(0,pe),Ne=x.slice(pe),me=`@${N} `,Qe=Ae+me+Ne;m(Qe),je(Ze=>({...Ze,[N]:`image-${N}`})),setTimeout(()=>{const Ze=pe+me.length;_.setSelectionRange(Ze,Ze),_.focus()},0)},Ot=t.useCallback(async()=>{var N;if(!(Te.length>0))try{const _=await Me.assetLibraries.getAll({includeShared:"true"}),pe=_.data||_||[],Ae=[];for(const Ne of pe)if(Ne.category==="ROLE")try{const me=await Me.assetLibraries.roles.list(Ne.id),Qe=me.data||me||[];for(const Ze of Qe)Ae.push({id:Ze.id,name:((N=Ze.metadata)==null?void 0:N.name)||Ze.name||"",thumbnail:Ze.thumbnail})}catch{}Re(Ae)}catch{}},[Te.length]),tt=t.useCallback(N=>{if(!N){h(Te.slice(0,5));return}const _=Te.filter(pe=>pe.name.toLowerCase().includes(N.toLowerCase())).slice(0,5);h(_),ye(0)},[Te]),_t=t.useCallback(N=>{const _=N.target.value,pe=N.target.selectionStart||0;m(_);const Ne=_.substring(0,pe).match(/@([^@\s]*)$/);if(Ne){const me=Ne[1];ue(me),be(pe-me.length-1),f(!0),Ot().then(()=>tt(me))}else f(!1),h([])},[Ot,tt]),Kt=t.useCallback(N=>{const _=x.substring(0,q),pe=x.substring(q+W.length+1),Ae=`@${N.name} `,Ne=_+Ae+pe;m(Ne),je(me=>({...me,[N.name]:N.id})),f(!1),h([]),ue(""),setTimeout(()=>{if(j.current){j.current.focus();const me=_.length+Ae.length;j.current.setSelectionRange(me,me)}},0)},[x,q,W]),bs=t.useCallback(N=>{!S||k.length===0||(N.key==="ArrowDown"?(N.preventDefault(),ye(_=>_<k.length-1?_+1:_)):N.key==="ArrowUp"?(N.preventDefault(),ye(_=>_>0?_-1:_)):N.key==="Enter"&&k[Se]?(N.preventDefault(),Kt(k[Se])):N.key==="Escape"&&f(!1))},[S,k,Se,Kt]);t.useEffect(()=>{const N=s.config.taskId;(async()=>{if(N){try{const Ae=(await Me.tasks.getTaskStatus(N)).task;if(Ae.status==="SUCCESS"){p(!1),$(100);const Ne=Ae.resultUrl;if(!Ne){p(!1),$(0),Le({taskId:""}),ee(""),g.error("ä»»åŠ¡å®Œæˆä½†æœªæ‰¾åˆ°ç»“æœ");return}const me=s.config.ratio||"16:9";Le({prompt:s.config.prompt||x,ratio:me,modelId:s.config.modelId,modelName:s.config.modelName,generatedVideoUrl:Ne,taskId:""}),ee("");const Qe=De(),Ze=we();if(Qe.filter(Ge=>Ge.type==="videoPreview"&&Ze.some(Rt=>Rt.source===u&&Rt.target===Ge.id)).find(Ge=>Ge.data.videoUrl===Ne)){setTimeout(()=>$(0),1e3);return}g.success("è§†é¢‘ç”Ÿæˆå·²å®Œæˆï¼");try{const Ge=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(Ge).some($t=>$t.taskId&&$t.taskId===N||$t.sourceNodeId&&$t.sourceNodeId===u)||Ss(Ne,me)}catch{Ss(Ne,me)}setTimeout(()=>$(0),1e3)}else if(Ae.status==="PROCESSING"||Ae.status==="PENDING"){p(!0),$(Ae.progress||0),Js(N);return}else Ae.status==="FAILURE"&&(p(!1),$(0),Le({taskId:""}),ee(""),g.error(`ç”Ÿæˆå¤±è´¥: ${Ae.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{p(!1),$(0),Le({taskId:""}),ee(""),g.error("ä»»åŠ¡æ¢å¤å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}return}})()},[]),t.useEffect(()=>{const N=ie.filter(pe=>pe.target===u);let _="";N.forEach(pe=>{var Ne;const Ae=K(pe.source);if(Ae){const me=Ae.data;Ae.type==="agent"&&((Ne=me.config)!=null&&Ne.generatedText)?_||(_=me.config.generatedText):Ae.type==="textPreview"&&me.content&&(_||(_=me.content))}}),_&&_!==x&&(m(_),Le({prompt:_}))},[ie,u,K,x,Le]),t.useEffect(()=>{const N=ie.filter(Ae=>Ae.target===u);if(N.length===0)return;let _="",pe="";N.forEach(Ae=>{var me;const Ne=R.find(Qe=>Qe.id===Ae.source);if(Ne&&Ne.type==="agent"){const Qe=Ne.data;(me=Qe.config)!=null&&me.generatedText&&(_=Qe.config.generatedText,pe=`${Ne.id}-${Qe.config.generatedText.substring(0,50)}`)}}),_&&pe!==M.current&&(M.current=pe,m(_),Le({prompt:_}))},[R,ie,u,Le]),t.useEffect(()=>{const N=JSON.stringify(nt),_=JSON.stringify(d);N!==_&&E(nt)},[nt]);const cs=t.useMemo(()=>{const N=d.length,_=l(n);return N===0?!0:N===1?_==="å‚è€ƒå›¾":N===2?_==="é¦–å°¾å¸§"?!1:_==="å‚è€ƒå›¾":N>2?_==="å‚è€ƒå›¾":!1},[d.length,n,l]),Rs=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),ws=t.useMemo(()=>{const N=l(n);return P?T:T.filter(_=>{var Ae;const pe=(((Ae=_.config)==null?void 0:Ae.supportedGenerationTypes)||[]).map(Ne=>l(Ne));return N==="é¦–å¸§"||N==="å°¾å¸§"?pe.includes("é¦–å¸§")||pe.includes("å°¾å¸§"):pe.includes(N)})},[T,n,l,P]),zs=t.useMemo(()=>{const N=P?T:ws;return N.length>0?N:P?(s.models||[]).filter(pe=>(pe.type||"")==="VIDEO_EDITING"):N},[P,T,ws,s.models]);t.useEffect(()=>{var _,pe;if(!zs.find(Ae=>Ae.id===te)){const Ae=((_=zs[0])==null?void 0:_.id)||"";L(Ae),Le({modelId:Ae||void 0,modelName:Ae?(pe=zs[0])==null?void 0:pe.name:void 0})}},[zs]);const Nt=t.useCallback(N=>{const _=l(N);return P?["IMAGE","VIDEO"]:_==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:["TEXT","IMAGE"]},[l,P]);t.useEffect(()=>{if(!cs&&d.length>0){const N=d[0].aspectRatio;N&&A!==N&&(O(N),setTimeout(()=>{Le({ratio:N})},0))}},[cs,d,A]),t.useEffect(()=>{if(!P&&Rs.length>0&&!Rs.includes(n)){const N="æ–‡ç”Ÿè§†é¢‘";o(N),setTimeout(()=>{Le({generationType:N,acceptedInputs:Nt(N)})},0)}},[Rs,n,Nt,P]),t.useEffect(()=>{l(n)==="é¦–å°¾å¸§"&&w&&(I(!1),Le({audio:!1}))},[n,l]),t.useEffect(()=>{const N=l(n);if(N==="æ–‡ç”Ÿè§†é¢‘")return;const _=ie.filter(me=>me.target===u),pe=[],Ae=[];_.forEach(me=>{var xt,it,Ge,Rt,Bt;const Qe=K(me.source);if(!Qe)return;const Ze=Qe.type;if((Ze||"").startsWith("aiVideo")||Ze==="videoPreview"){Ae.push(me.id);return}if(Ze==="upload"){const $t=(Ge=(it=(xt=Qe.data)==null?void 0:xt.config)==null?void 0:it.uploadedFiles)==null?void 0:Ge[0],Gt=(($t==null?void 0:$t.type)||"").toUpperCase(),wt=(($t==null?void 0:$t.mimeType)||"").toLowerCase();if(Gt==="VIDEO"||wt.startsWith("video/")){Ae.push(me.id);return}(Gt==="IMAGE"||wt.startsWith("image/"))&&pe.push(me.id);return}if(Ze==="assetSelector"){const $t=((Rt=Qe.data)==null?void 0:Rt.config)||{};if($t.selectedAsset){const Gt=($t.selectedAsset.type||"").toUpperCase(),wt=($t.selectedAsset.mimeType||"").toLowerCase();Gt==="VIDEO"||wt.startsWith("video/")?Ae.push(me.id):(Gt==="IMAGE"||wt.startsWith("image/"))&&pe.push(me.id)}else if($t.subjects&&$t.subjects.length>0){const Gt=(((Bt=$t.subjects[0])==null?void 0:Bt.images)||[]).length;N==="å‚è€ƒå›¾"||N==="é¦–å°¾å¸§"?pe.push(me.id):(N==="é¦–å¸§"||N==="å°¾å¸§")&&(Gt>1?Ae.push(me.id):pe.push(me.id))}return}(Ze==="aiImage"||Ze==="imagePreview")&&pe.push(me.id)});let Ne=new Set([...Ae]);N==="é¦–å¸§"||N==="å°¾å¸§"?pe.slice(1).forEach(me=>Ne.add(me)):N==="é¦–å°¾å¸§"&&pe.slice(2).forEach(me=>Ne.add(me)),Ne.size>0&&Ce(me=>me.filter(Qe=>!Ne.has(Qe.id)))},[n,ie,u,K,Ce,l]),t.useEffect(()=>{const N=s.config.generationType;if(!N||l(N)!==l(n)){const _=l(n)||"æ–‡ç”Ÿè§†é¢‘";Le({generationType:_,acceptedInputs:Nt(_)})}},[]),t.useEffect(()=>{const N=Nt(n);Le({acceptedInputs:N})},[n,Nt]);const Ps=N=>{X(N)},ys=N=>{N.preventDefault()},Zs=N=>{if(Y===null)return;const _=[...d],[pe]=_.splice(Y,1);_.splice(N,0,pe),E(_),X(null),Le({referenceImages:_})};t.useEffect(()=>{const N=j.current;N&&Q&&requestAnimationFrame(()=>{N.style.height="auto";const _=Math.max(60,Math.min(N.scrollHeight,600));N.style.height=`${_}px`})},[x,Q]),t.useEffect(()=>{if(x===s.config.prompt)return;const N=setTimeout(()=>{Le({prompt:x})},500);return()=>clearTimeout(N)},[x]);const hs=N=>{var pe,Ae,Ne;L(N);const _=ws.find(me=>me.id===N);if(_){const me=(pe=_.config.supportedRatios)!=null&&pe.length?_.config.supportedRatios:["16:9"],Qe=_.config.supportedResolutions||[],Ze=(Ae=_.config.supportedGenerationTypes)!=null&&Ae.length?_.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],xt=(Ne=_.config.supportedDurations)!=null&&Ne.length?_.config.supportedDurations:[5],it=me[0],Ge=Qe.length>0?Qe[0]:r,Rt=l(n||Ze[0]),Bt=xt[0],$t=_.config.supportsAudioOutput?w:!1;O(it),b(Ge),o(Rt),c(Bt),_.config.supportsAudioOutput||I(!1),Le({modelId:N,modelName:_.name,ratio:it,resolution:Ge,generationType:Rt,duration:Bt,audio:$t,acceptedInputs:Nt(Rt)})}};t.useEffect(()=>{var _;const N=(_=s==null?void 0:s.config)==null?void 0:_.generatedVideoUrl;N&&Ss(N,s.config.ratio||"16:9")},[(Pe=s==null?void 0:s.config)==null?void 0:Pe.generatedVideoUrl]);const Js=async N=>{let pe=0;const Ae=async()=>{try{pe++;const me=(await Me.tasks.getTaskStatus(N)).task;if($(me.progress||0),me.status==="SUCCESS"||me.status==="COMPLETED"||me.status==="DONE"){p(!1),$(100);const Qe=me.resultUrl;Ss(Qe,s.config.ratio||"16:9"),Le({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,modelName:s.config.modelName,taskId:"",generatedVideoUrl:Qe}),ee(""),g.success("è§†é¢‘ç”ŸæˆæˆåŠŸï¼"),setTimeout(()=>$(0),1e3);return}else if(me.status==="FAILURE"){p(!1),$(0),Le({taskId:""});const{useAuthStore:Qe}=await gs(async()=>{const{useAuthStore:xt}=await import("./index-Cp0uMTfX.js").then(it=>it.f);return{useAuthStore:xt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Ze}=Qe.getState();await Ze(),g.error(me.errorMessage||"è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜");return}else(me.status==="PROCESSING"||me.status==="PENDING")&&(pe<600?setTimeout(Ae,1e3):(p(!1),$(0),Le({taskId:""}),g.error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{p(!1),$(0),Le({taskId:""}),g.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};Ae()},qs=async()=>{var pe,Ae,Ne,me,Qe,Ze,xt;if(l(n)==="æ–‡ç”Ÿè§†é¢‘"&&!x.trim()){g.error("è¯·è¾“å…¥æç¤ºè¯");return}p(!0);const _=Et();Le({referenceImages:_}),$(0);try{let it=[],Ge;const Rt=d.length;if(d.length>0)try{for(const xs of d){let zt=xs.url;!zt.startsWith("data:")&&!zt.startsWith("http")&&(zt=`${cr}${zt}`),zt=zt.replace(/^https?:\/\/localhost(?::\d+)?/i,cr);const Xt=await Nr(zt);it.push(Xt)}}catch{g.error("å‚è€ƒå›¾å¤„ç†å¤±è´¥")}const Bt=ie.filter(xs=>xs.target===u);let $t=[];if(l(n)==="å‚è€ƒå›¾"){const xs=/@(\S+)/g,Xt=[...x.matchAll(xs)].map(is=>is[1]);for(const is of Xt){const qt=_e[is];qt&&$t.push(qt)}const as=new Map;for(const is of Bt){const qt=K(is.source);if((qt==null?void 0:qt.type)==="assetSelector"){const Os=(pe=qt.data.config)==null?void 0:pe.roleIds;if(Os&&Os.length>0)for(const ks of Os)$t.includes(ks)||$t.push(ks);const js=(Ae=qt.data.config)==null?void 0:Ae.subjects;if(js&&js.length>0){for(const ks of js)if(!as.has(ks.name)){const ir=(ks.images||[]).map(Gs=>Gs.startsWith("http")||Gs.startsWith("data:")?Gs:`${cr}${Gs}`);as.set(ks.name,ir)}}}}if(as.size>0){const is=Array.from(as.entries());let qt=0;const Os=[];for(const[js,ks]of is){if(qt>=7)break;const ir=7-qt,Gs=ks.slice(0,Math.max(0,ir));Gs.length>0&&(Os.push({name:js,images:Gs}),qt+=Gs.length)}Ge=Os,is.some(([,js])=>js.length>0)&&qt<is.reduce((js,[,ks])=>js+ks.length,0)&&g.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ï¼ˆåŒ…å«è§’è‰²å›¾ç‰‡ï¼‰")}if(it.length>0){const is=nt.filter(qt=>!qt.id.includes("subject"));is.length>0&&(Ge||(Ge=[]),is.forEach((qt,Os)=>{const js=`å›¾${Os+1}`,ks=qt.url.startsWith("http")||qt.url.startsWith("data:")?qt.url:`${cr}${qt.url}`;Ge.push({name:js,images:[ks]})}))}}const Gt=Ge&&Ge.length>0?Ge.reduce((xs,zt)=>{var Xt;return xs+(((Xt=zt.images)==null?void 0:Xt.length)||0)},0):Rt,wt=$t.length>0;let It=n;if(It==="é¦–å¸§"||It==="å°¾å¸§"){if(Gt!==1&&!wt){g.error("å½“å‰ç”Ÿæˆæ–¹æ³•éœ€è¦ä¸”ä»…æ¥å—1å¼ å›¾ç‰‡"),p(!1),$(0);return}}else if(It==="é¦–å°¾å¸§"){if(Gt===1)It="é¦–å¸§";else if(Gt!==2&&!wt){g.error("é¦–å°¾å¸§ç”Ÿæˆéœ€è¦ä¸”ä»…æ¥å—2å¼ å›¾ç‰‡"),p(!1),$(0);return}Ge&&Ge.length>0?Ge=[{...Ge[0],images:Ge[0].images.slice(0,2)}]:it=it.slice(0,2)}else if(It==="å‚è€ƒå›¾"||It==="ä¸»ä½“å‚è€ƒ"){if(Gt<1&&!wt){g.error("å‚è€ƒç”Ÿæˆéœ€è¦è‡³å°‘1å¼ å›¾ç‰‡æˆ–è§’è‰²"),p(!1),$(0);return}if(Ge&&Ge.length>0){if(Ge.reduce((zt,Xt)=>{var as;return zt+(((as=Xt.images)==null?void 0:as.length)||0)},0)>7){let zt=7;Ge=Ge.map(Xt=>({...Xt,images:Xt.images.slice(0,Math.max(0,zt-=Xt.images.length,Xt.images.length))})),zt=7,Ge=Ge.map(Xt=>{const as=Xt.images.slice(0,Math.min(Xt.images.length,zt));return zt-=as.length,{...Xt,images:as}}).filter(Xt=>Xt.images.length>0),g.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ ")}}else it.length>7&&(it=it.slice(0,7),g.info("å·²é™åˆ¶å‚è€ƒå›¾ä¸ºå‰7å¼ "))}le==="dropImages"&&(it=[],Ge=void 0),(l(n)==="é¦–å¸§"||l(n)==="å°¾å¸§")&&le==="useFirstImage"&&it.length>=2&&(it=[it[0]]),l(n)==="é¦–å°¾å¸§"&&le==="useFirstTwoImages"&&it.length>=3&&(it=it.slice(0,2));const Mt={modelId:te,ratio:A,referenceImages:Ge&&Ge.length>0?void 0:it.length>0?it:void 0,roleIds:$t.length>0?$t:void 0,generationType:It,sourceNodeId:u,metadata:{duration:a,resolution:r,audio:w,movementAmplitude:D,roleIds:$t.length>0?$t:void 0},...Ge?{subjects:Ge}:{}};Ge&&Ge.length>0;const Lt=l(It);if(Lt==="æ–‡ç”Ÿè§†é¢‘"){if(!x.trim()){g.error("è¯·è¾“å…¥æç¤ºè¯"),p(!1),$(0);return}Mt.prompt=x.trim()}else if(Lt==="å‚è€ƒå›¾"){if(!x.trim()){g.error("è¯·è¾“å…¥å‚è€ƒå›¾æç¤ºè¯"),p(!1),$(0);return}Mt.prompt=x.trim()}else x.trim()&&(Mt.prompt=x.trim());const es=await Me.tasks.createVideoTask(Mt),ns=es.taskId,Cs=es.creditsCharged||0,er=es.isFreeUsage,Us=es.freeUsageRemaining??0;if(ee(ns),Le({prompt:x,ratio:A,resolution:r,generationType:n,duration:a,modelId:te,taskId:ns}),er)g.success(`å…è´¹ç”Ÿæˆï¼Œä»Šæ—¥è¿˜å‰© ${Us} æ¬¡`),fe();else if(Cs>0){const{useAuthStore:xs}=await gs(async()=>{const{useAuthStore:Xt}=await import("./index-Cp0uMTfX.js").then(as=>as.f);return{useAuthStore:Xt}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:zt}=xs.getState();await zt(),g.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${Cs} ç§¯åˆ†ï¼‰`),fe()}else g.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");Js(ns)}catch(it){if(p(!1),$(0),((Ne=it.response)==null?void 0:Ne.status)===403){const Ge=((Qe=(me=it.response)==null?void 0:me.data)==null?void 0:Qe.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";g.error(Ge)}else g.error(`æäº¤å¤±è´¥: ${((xt=(Ze=it.response)==null?void 0:Ze.data)==null?void 0:xt.error)||it.message}`)}},rr=async()=>{const N=l(n),_=Et(),pe=_.length,Ae=(()=>{var Qe;const me=ie.filter(Ze=>Ze.target===u);for(const Ze of me){const xt=K(Ze.source);if((xt==null?void 0:xt.type)==="assetSelector"){const it=(Qe=xt.data.config)==null?void 0:Qe.subjects;if(it&&it.length>0)return!0}}return!1})(),Ne=Object.keys(_e).length>0;if((Ae||Ne)&&(N==="é¦–å¸§"||N==="å°¾å¸§"||N==="é¦–å°¾å¸§")){g.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼ä¸æ”¯æŒä¼ å…¥è§’è‰²å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if((N==="é¦–å¸§"||N==="å°¾å¸§")&&pe===0&&!Ne){g.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(N==="é¦–å°¾å¸§"&&pe===0&&!Ne){g.error("æ‚¨é€‰æ‹©çš„ç”Ÿæˆæ¨¡å¼éœ€è¦æ‚¨ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ");return}if(N==="å‚è€ƒå›¾"&&pe===0&&!Ne){g.error("å‚è€ƒå›¾æ¨¡å¼éœ€è¦ä¼ å…¥å›¾ç‰‡æˆ–ä½¿ç”¨ @ æåŠè§’è‰²");return}if(N==="æ–‡ç”Ÿè§†é¢‘"&&pe>0&&!window.confirm("å½“å‰é€‰æ‹©çš„æ¨¡å¼æ˜¯æ–‡ç”Ÿè§†é¢‘ï¼Œç»§ç»­æ‰§è¡Œä¼šåˆ é™¤ä¼ å…¥çš„å›¾ç‰‡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){g.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if((N==="é¦–å¸§"||N==="å°¾å¸§")&&pe>=2&&!window.confirm("å½“å‰æ¨¡å¼åªèƒ½ä¼ å…¥1å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„ç¬¬1å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){g.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(N==="é¦–å°¾å¸§"&&pe>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼åªèƒ½ä¼ å…¥2å¼ å›¾ç‰‡ï¼Œç»§ç»­æ‰§è¡Œå°†åªä½¿ç”¨æ‚¨æä¾›çš„å‰ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")){g.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼");return}if(N==="æ–‡ç”Ÿè§†é¢‘"&&!x.trim()){g.error("è¯·è¾“å…¥æç¤ºè¯");return}if(!te){g.error("è¯·é€‰æ‹©è§†é¢‘ç”Ÿæˆæ¨¡å‹");return}E(_),Le({referenceImages:_}),p(!0),$(0),await qs()},Ss=(N,_)=>{const pe=K(u);if(!pe||!N)return;const Ae=_||A||"16:9",Ne=De(),me=we(),Qe=Ne.filter(zt=>zt.type==="videoPreview"&&me.some(Xt=>Xt.source===u&&Xt.target===zt.id));if(Qe.find(zt=>zt.data.videoUrl===N))return;const xt=1,it=400,Ge=(zt,Xt=300)=>{if(!zt||!/^[0-9]+\s*:\s*[0-9]+$/.test(zt))return Xt;const[as,is]=zt.split(":").map(qt=>parseFloat(qt));return!as||!is?Xt:Math.round(it*(is/as))},Rt=document.querySelector(`.react-flow__node[data-id="${u}"]`),Bt=Rt==null?void 0:Rt.getBoundingClientRect(),$t=Math.round(((Bt==null?void 0:Bt.width)||400)/xt),Gt=100,wt=200,It=Ge(Ae,300),Mt=Qe.length,Lt=pe.position.x+$t+wt,es=pe.position.y,ns=Lt,Cs=es+Mt*(It+Gt),er=Date.now(),Us={id:`preview-${u}-${er}`,type:"videoPreview",position:{x:ns,y:Cs},data:{videoUrl:N,width:it,ratio:Ae,workflowContext:pe.data.workflowContext,createdBy:pe.data.createdBy}};ce(zt=>[...zt,Us]);const xs={id:`edge-${u}-${Us.id}`,source:u,target:Us.id,targetHandle:`${Us.id}-target`,type:"aurora"};Ce(zt=>zt.find(as=>as.source===u&&as.target===Us.id)?zt:[...zt,xs])},Ns=N=>{const _=N.target;if(_.tagName==="INPUT"||_.tagName==="TEXTAREA"||_.tagName==="SELECT"||_.tagName==="BUTTON"||_.closest("button")||_.closest("input")||_.closest("textarea")||_.closest("select"))return;const pe=!Q;Ie(pe),ce(Ae=>Ae.map(Ne=>Ne.id===u?{...Ne,data:{...Ne.data,isExpanded:pe}}:Ne))};return e.jsxs("div",{onDoubleClick:Ns,className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var it;const N=((it=K(u))==null?void 0:it.type)||"",_=l(n),pe=_==="æ–‡ç”Ÿè§†é¢‘"||N==="aiVideo_t2v",Ae=N==="aiVideo_i2v_first"||N==="aiVideo_i2v_last"||_==="é¦–å¸§"||_==="å°¾å¸§",Ne=N==="aiVideo_first_last"||_==="é¦–å°¾å¸§",me=N==="aiVideo_reference"||_==="å‚è€ƒå›¾",Qe=ie.filter(Ge=>Ge.target===u),Ze=Qe.some(Ge=>{const Rt=K(Ge.source);return(Rt==null?void 0:Rt.type)==="agent"}),xt=Qe.reduce((Ge,Rt)=>{var Gt,wt,It,Mt;const Bt=K(Rt.source),$t=(Bt==null?void 0:Bt.type)||"";if($t==="aiImage"||$t==="imagePreview")return Ge+1;if($t==="upload"){const Lt=(It=(wt=(Gt=Bt==null?void 0:Bt.data)==null?void 0:Gt.config)==null?void 0:wt.uploadedFiles)==null?void 0:It[0],es=((Lt==null?void 0:Lt.type)||"").toUpperCase(),ns=((Lt==null?void 0:Lt.mimeType)||"").toLowerCase();return Ge+(es==="IMAGE"||ns.startsWith("image/")?1:0)}if($t==="assetSelector"){const Lt=((Mt=Bt==null?void 0:Bt.data)==null?void 0:Mt.config)||{};if(Lt.selectedAsset)return Ge+((Lt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Lt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Lt.subjects&&Lt.subjects.length>0)return Ge+((Lt.subjects[0].images||[]).length||0)}return Ge},0);return pe?!Ze:Ae?!(Ze&&xt>=1):Ne?!(Ze&&xt>=2):me?!(Ze&&xt>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),J&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:ae}),oe==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{F(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{F(!1),g.info("è¯·åœ¨é¢æ¿ä¸­é€‰æ‹©åˆé€‚çš„ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{F(!1),await qs()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(rs,{value:te,onChange:N=>hs(N),options:ws.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:ws.map(N=>({value:N.id,label:N.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:Be?"è§†é¢‘æç¤ºè¯":"æç¤ºè¯"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:j,value:x,onChange:N=>{var Ne;const _=(Ne=re==null?void 0:re.modelId)==null?void 0:Ne.includes("viduq2"),pe=l(n)==="å‚è€ƒå›¾";_&&pe?_t(N):(m(N.target.value),f(!1))},onKeyDown:N=>{var Ae;const _=(Ae=re==null?void 0:re.modelId)==null?void 0:Ae.includes("viduq2"),pe=l(n)==="å‚è€ƒå›¾";_&&pe&&bs(N)},placeholder:(Ue=re==null?void 0:re.modelId)!=null&&Ue.includes("viduq2")&&l(n)==="å‚è€ƒå›¾"?"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...ï¼ˆè¾“å…¥ @ å¯é€‰æ‹©è§’è‰²ï¼‰":"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),S&&k.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-black/90 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:k.map((N,_)=>e.jsxs("button",{type:"button",onClick:()=>Kt(N),className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${_===Se?"bg-purple-100 dark:bg-purple-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[N.thumbnail?e.jsx("img",{src:N.thumbnail,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-200 dark:bg-purple-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-purple-600 dark:text-purple-300",children:"person"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:["@",N.name]})})]},N.id))})]})]}),Object.keys(_e).length>0&&((Xe=re==null?void 0:re.modelId)==null?void 0:Xe.includes("viduq2"))&&l(n)==="å‚è€ƒå›¾"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å·²æåŠè§’è‰²"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Object.keys(_e).map(N=>e.jsxs("div",{className:"nodrag px-2 py-1 rounded-md bg-purple-500/10 dark:bg-purple-500/20 border border-purple-400/50 dark:border-purple-400/30 flex items-center gap-1 group relative",children:[e.jsx("span",{className:"material-symbols-outlined text-purple-500 dark:text-purple-400",style:{fontSize:"12px"},children:"person"}),e.jsx("span",{className:"text-[10px] font-medium text-purple-700 dark:text-purple-300",children:N}),e.jsx("button",{type:"button",onClick:()=>{je(Ae=>{const Ne={...Ae};return delete Ne[N],Ne});const _=new RegExp(`@${N}\\s*`,"g"),pe=x.replace(_,"");m(pe)},className:"ml-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"material-symbols-outlined text-purple-500 dark:text-purple-400 hover:text-red-500 dark:hover:text-red-400",style:{fontSize:"12px"},children:"close"})})]},N))}),e.jsx("p",{className:"text-[9px] text-slate-500 dark:text-gray-500",children:"ğŸ’¡ è¿™äº›è§’è‰²çš„å›¾ç‰‡ä¼šè‡ªåŠ¨ç”¨äºç”Ÿæˆè§†é¢‘"})]}),!Be&&d.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:[(We=d[0])!=null&&We.name&&d[0].id.includes("subject")?"è§’è‰²å›¾ç‰‡":"å‚è€ƒå›¾"," ",n==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)",l(n)==="å‚è€ƒå›¾"&&d.some(N=>!N.id.includes("subject"))&&e.jsx("span",{className:"ml-2 text-[9px] font-normal text-blue-500 dark:text-blue-400",children:"ç‚¹å‡»å›¾ç‰‡æ’å…¥æåŠ"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:d.map((N,_)=>{const pe=d.slice(0,_+1).filter(me=>!me.id.includes("subject")).length,Ae=!N.id.includes("subject"),Ne=Ae?`å›¾${pe}`:N.name;return e.jsxs("div",{draggable:n==="é¦–å°¾å¸§",onDragStart:()=>Ps(_),onDragOver:ys,onDrop:()=>Zs(_),onClick:()=>{Ae&&l(n)==="å‚è€ƒå›¾"&&yt(Ne)},className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${n==="é¦–å°¾å¸§"?"cursor-move":Ae&&l(n)==="å‚è€ƒå›¾"?"cursor-pointer":""} ${Y===_?"opacity-50":""} ${N.id.includes("subject")?"border-purple-400 dark:border-purple-400/50":"border-blue-400 dark:border-blue-400/50"} hover:border-purple-400 dark:hover:border-purple-400/50 ${Ae&&l(n)==="å‚è€ƒå›¾"?"hover:scale-105":""}`,title:Ae&&l(n)==="å‚è€ƒå›¾"?`ç‚¹å‡»æ’å…¥ @${Ne}`:N.name,children:[e.jsx("img",{src:`${N.url.startsWith("http")||N.url.startsWith("data:")?N.url:cr+N.url}`,alt:N.name,className:"w-full h-full object-cover"}),N.id.includes("subject")&&e.jsxs("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"person"}),N.name]}),Ae&&n!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"absolute top-0 left-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br flex items-center gap-0.5",children:[e.jsx("span",{className:"material-symbols-outlined",style:{fontSize:"10px"},children:"image"}),Ne]}),n==="é¦–å°¾å¸§"&&!N.id.includes("subject")&&e.jsx("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:_===0?"é¦–":_===1?"å°¾":_+1})]},N.id)})})]}),re&&!Be&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",at?"(æœªé…ç½®)":""]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:qe.map(N=>e.jsxs("button",{type:"button",onClick:()=>{c(N),Le({duration:N})},disabled:at,className:`nodrag px-3 py-1.5 text-[10px] font-medium rounded-md border transition-all ${a===N?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"} disabled:opacity-50 disabled:cursor-not-allowed`,children:[N,"ç§’"]},N))})]}),cs&&(((Ye=re==null?void 0:re.config.supportedRatios)==null?void 0:Ye.length)||0)>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),Be?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{O("16:9"),Le({ratio:"16:9"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${A==="16:9"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{O("9:16"),Le({ratio:"9:16"})},className:`nodrag py-2 rounded-lg text-xs font-bold transition-all border ${A==="9:16"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(rs,{value:A,onChange:N=>{O(N),Le({ratio:N})},options:((re==null?void 0:re.config.supportedRatios)||[]).map(N=>{const[_,pe]=N.split(":");return{value:N,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[N]||`${_}:${pe}`}})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",ot?"(æœªé…ç½®)":""]}),e.jsx(rs,{value:r,onChange:N=>{b(N),Le({resolution:N})},options:Ft.map(N=>({value:N,label:N})),className:ot?"opacity-50 pointer-events-none":""})]}),((ct=re==null?void 0:re.provider)==null?void 0:ct.toLowerCase())==="vidu"&&(re==null?void 0:re.modelId)!=="viduq2"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¿åŠ¨å¹…åº¦"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["auto","small","medium","large"].map(N=>e.jsx("button",{type:"button",onClick:()=>{B(N),Le({movementAmplitude:N})},className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${D===N?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:N==="auto"?"è‡ªåŠ¨":N==="small"?"å°":N==="medium"?"ä¸­":"å¤§"},N))})]}),(re==null?void 0:re.config.supportsAudioOutput)&&l(n)!=="é¦–å°¾å¸§"&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³é¢‘ç›´å‡º"}),e.jsx("button",{type:"button",onClick:()=>{const N=!w;I(N),Le({audio:N})},className:`nodrag relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${w?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50":"bg-slate-300 dark:bg-slate-600"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${w?"translate-x-5":"translate-x-0.5"}`})})]})]}),e.jsx("button",{onClick:rr,disabled:v||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${v?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:v?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!he&&(ne?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",se,"æ¬¡"]}):Oe!==null&&Oe>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[Oe,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:x?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-purple-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-purple-300 line-clamp-6 whitespace-pre-wrap break-words",children:x})]}):e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},nr=t.memo(Oa),Ga=s=>{const{data:C}=s;return e.jsx(nr,{...s,data:{...C,config:{...C==null?void 0:C.config,lockedGenerationType:"æ–‡ç”Ÿè§†é¢‘",hideGenerationTypeSelector:!0,generationType:"æ–‡ç”Ÿè§†é¢‘"}}})},Va=t.memo(Ga),Wa=s=>{const{data:C}=s;return e.jsx(nr,{...s,data:{...C,config:{...C==null?void 0:C.config,lockedGenerationType:"é¦–å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å¸§"}}})},Fa=t.memo(Wa),za=s=>{const{data:C}=s;return e.jsx(nr,{...s,data:{...C,config:{...C==null?void 0:C.config,lockedGenerationType:"å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"å°¾å¸§"}}})},Ba=t.memo(za),Ha=s=>{const{data:C}=s;return e.jsx(nr,{...s,data:{...C,config:{...C==null?void 0:C.config,lockedGenerationType:"é¦–å°¾å¸§",hideGenerationTypeSelector:!0,generationType:"é¦–å°¾å¸§"}}})},Xa=t.memo(Ha),Ja=s=>{const C=(s==null?void 0:s.data)||{},u=C.config||{};return e.jsx(nr,{...s,data:{...C,config:{...u,generationType:(u==null?void 0:u.lockedGenerationType)||(u==null?void 0:u.generationType)||"å‚è€ƒå›¾",lockedGenerationType:(u==null?void 0:u.lockedGenerationType)||"å‚è€ƒå›¾",hideGenerationTypeSelector:!0,acceptedInputs:(u==null?void 0:u.lockedGenerationType)==="è§†é¢‘æ¢äºº"||(u==null?void 0:u.generationType)==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:["TEXT","IMAGE"]}}})},qa=t.memo(Ja),or="https://api.waule.com",Ya=({data:s,selected:C,id:u})=>{var L,A,O,r,b,l;const[Q]=t.useState(!0),[Ie,$]=t.useState(!1),[ve]=t.useState(""),[ee,de]=t.useState("wan-std"),[Z,ge]=t.useState(0),Oe=t.useRef(null),{setNodes:he,setEdges:ne,getNode:se,getNodes:fe,getEdges:ce}=ts(),Ce=Fs(),K=s.config.modelId,{credits:De,loading:we}=Ls({aiModelId:K,duration:Z,mode:ee==="wan-pro"?"pro":"standard"}),ie=t.useMemo(()=>{var a;const n=s.models||[],o=(a=s==null?void 0:s.config)==null?void 0:a.selectedEditingCapability;return n.filter(c=>{var w;return(c.type||"")==="VIDEO_EDITING"&&Array.isArray((w=c.config)==null?void 0:w.supportedEditingCapabilities)&&(o?c.config.supportedEditingCapabilities.includes(o):c.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")||c.config.supportedEditingCapabilities.includes("åŠ¨ä½œå…‹éš†"))})},[s.models,(L=s==null?void 0:s.config)==null?void 0:L.selectedEditingCapability]),[R,M]=t.useState(s.config.modelId||((A=ie[0])==null?void 0:A.id)||""),P=t.useMemo(()=>ie.find(n=>n.id===R),[ie,R]);t.useEffect(()=>{var n;if(!ie.find(o=>o.id===R)){const o=((n=ie[0])==null?void 0:n.id)||"";M(o),he(a=>a.map(c=>{var w;return c.id===u?{...c,data:{...c.data,config:{...c.data.config,modelId:o||void 0,modelName:o?(w=ie[0])==null?void 0:w.name:void 0}}}:c}))}},[ie]),t.useEffect(()=>{},[P]);const T=t.useMemo(()=>{var D,B,v,p,d,E,Y,X,J,F,ae,oe,le,S,f,k;const n=Ce.filter(h=>h.target===u);let o=null,a=0,c=null,w=null,I=null;for(const h of n){const W=se(h.source);if(!W)continue;const ue=String(W.type||"");if(ue==="upload"){const q=(v=(B=(D=W.data)==null?void 0:D.config)==null?void 0:B.uploadedFiles)==null?void 0:v[0];if(!q)continue;const be=String(q.mimeType||"").toLowerCase(),Se=String(q.type||"").toUpperCase(),ye=q.url.startsWith("http")||q.url.startsWith("data:")?q.url:`${or}${q.url}`;!c&&(Se==="VIDEO"||be.startsWith("video/"))&&(c=ye,I=h.id),!o&&(Se==="IMAGE"||be.startsWith("image/"))&&(o=ye,a=q.size||0,w=h.id)}else if(ue==="assetSelector"){const q=(d=(p=W.data)==null?void 0:p.config)==null?void 0:d.selectedAsset;if(q){const Se=String(q.mimeType||"").toLowerCase(),ye=String(q.type||"").toUpperCase(),_e=q.url.startsWith("http")||q.url.startsWith("data:")?q.url:`${or}${q.url}`;!c&&(ye==="VIDEO"||Se.startsWith("video/"))&&(c=_e,I=h.id),!o&&(ye==="IMAGE"||Se.startsWith("image/"))&&(o=_e,a=q.size||0,w=h.id)}const be=((Y=(E=W.data)==null?void 0:E.config)==null?void 0:Y.subjects)||[];if(!o&&Array.isArray(be)&&be.length>0){const ye=(((X=be[0])==null?void 0:X.images)||[])[0];ye&&(o=ye.startsWith("http")||ye.startsWith("data:")?ye:`${or}${ye}`,w=h.id)}}else if(ue==="aiImage"){const q=(F=(J=W.data)==null?void 0:J.config)==null?void 0:F.generatedImageUrl;!o&&q&&(o=q.startsWith("http")||q.startsWith("data:")?q:`${or}${q}`,w=h.id)}else if(ue==="imagePreview"){const q=((ae=W.data)==null?void 0:ae.imageUrl)||((oe=W.data)==null?void 0:oe.url);!o&&q&&(o=q.startsWith("http")||q.startsWith("data:")?q:`${or}${q}`,w=h.id)}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const q=((le=W.data)==null?void 0:le.videoUrl)||((S=W.data)==null?void 0:S.url)||((k=(f=W.data)==null?void 0:f.config)==null?void 0:k.generatedVideoUrl);!c&&q&&(c=q.startsWith("http")||q.startsWith("data:")?q:`${or}${q}`,I=h.id)}if(o&&c)break}return{imageUrl:o,videoUrl:c,imageSize:a,imageEdgeId:w,videoEdgeId:I}},[Ce,u,se]);t.useEffect(()=>{if(T.imageSize>5*1024*1024){const o=(T.imageSize/1024/1024).toFixed(2);g.error(`å›¾ç‰‡å¤ªå¤§å•¦ï¼ˆå½“å‰${o}MBï¼‰ï¼Œè¯·ä½¿ç”¨ 5MB ä»¥å†…çš„å›¾ç‰‡`),T.imageEdgeId&&ne(a=>a.filter(c=>c.id!==T.imageEdgeId))}if(!T.videoUrl){ge(0);return}const n=document.createElement("video");n.src=T.videoUrl,n.onloadedmetadata=()=>{const o=n.duration||0,a=n.videoWidth,c=n.videoHeight;ge(o);let w="";o<2||o>30?w=`è§†é¢‘æ—¶é•¿éœ€åœ¨2-30ç§’ä¹‹é—´ï¼ˆå½“å‰${o.toFixed(1)}ç§’ï¼‰`:(a>2048||c>2048)&&(w=`è§†é¢‘åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2048x2048ï¼ˆå½“å‰${a}x${c}ï¼‰`),w&&(g.error(w+"ï¼Œè¿æ¥å·²æ–­å¼€"),T.videoEdgeId&&ne(I=>I.filter(D=>D.id!==T.videoEdgeId)))},n.onerror=()=>ge(0),n.load()},[T.videoUrl,T.imageSize,T.videoEdgeId,T.imageEdgeId,ne]);const x=t.useMemo(()=>!!R&&!!T.videoUrl&&!!T.imageUrl,[R,T.videoUrl,T.imageUrl]),m=t.useCallback(n=>{var S,f,k;const o=se(u);if(!o||!n)return;const a=fe(),c=ce(),w=a.filter(h=>h.type==="videoPreview"&&c.some(W=>W.source===u&&W.target===h.id));if(w.find(h=>{var W;return((W=h.data)==null?void 0:W.videoUrl)===n}))return;const D=400,B=(h,W=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(h))return W;const[ue,q]=h.split(":").map(be=>parseFloat(be));return!ue||!q?W:Math.round(D*(q/ue))},v=200,p=100,d=B("16:9",300),E=document.querySelector(`.react-flow__node[data-id="${u}"]`),Y=Math.round((E==null?void 0:E.getBoundingClientRect().width)||400),X=(((S=o.position)==null?void 0:S.x)||0)+Y+v,J=((f=o.position)==null?void 0:f.y)||0,F=w.length,ae=X,oe=J+F*(d+p),le={id:`preview-${u}-${Date.now()}`,type:"videoPreview",position:{x:ae,y:oe},data:{videoUrl:n,width:D,ratio:"16:9",workflowContext:o.data.workflowContext,createdBy:(k=o.data)==null?void 0:k.createdBy}};he(h=>[...h,le]),ne(h=>[...h,{id:`edge-${u}-${le.id}`,source:u,target:le.id,type:"aurora"}])},[u,se,fe,ce,he,ne]);t.useEffect(()=>{var o;const n=(o=s==null?void 0:s.config)==null?void 0:o.generatedVideoUrl;n&&m(n)},[(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl]),t.useEffect(()=>{const n=s.config.taskId;(async()=>{var c,w;let a=!1;if(n)try{const D=(await Me.tasks.getTaskStatus(n)).task;if(D.status==="SUCCESS"){const B=D.resultUrl||((c=D.previewNodeData)==null?void 0:c.url);if(B){let v=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";v=JSON.parse(p).some(E=>E.taskId&&E.taskId===n||E.sourceNodeId&&E.sourceNodeId===u)}catch{}v||m(B),he(p=>p.map(d=>d.id===u?{...d,data:{...d.data,config:{...d.data.config,generatedVideoUrl:B,taskId:n}}}:d))}$(!1),a=!0}else if(D.status==="PROCESSING"||D.status==="PENDING"){$(!0),await j(n);return}else D.status==="FAILURE"&&($(!1),he(B=>B.map(v=>v.id===u?{...v,data:{...v.data,config:{...v.data.config,taskId:""}}}:v)))}catch{$(!1)}if(!a)try{const I=await Me.tasks.getPendingPreviewNodes(u);if(Array.isArray(I.tasks)&&I.tasks.length>0)for(const D of I.tasks){const B=(w=D.previewNodeData)==null?void 0:w.url;if(B){let v=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";v=JSON.parse(p).some(E=>E.taskId&&E.taskId===D.id||E.sourceNodeId&&E.sourceNodeId===u)}catch{}v||m(B),await Me.tasks.markPreviewNodeCreated(D.id)}}}catch{}})()},[]);const j=async n=>{let o=0;const a=600,c=async()=>{var w;try{o++;const D=(await Me.tasks.getTaskStatus(n)).task;if(D.status==="SUCCESS"){const B=D.resultUrl||((w=D.previewNodeData)==null?void 0:w.url);if(B){let v=!1;try{const p=localStorage.getItem("suppressedPreviewTasks")||"[]";v=JSON.parse(p).some(E=>E.taskId&&E.taskId===n||E.sourceNodeId&&E.sourceNodeId===u)}catch{}v||m(B),he(p=>p.map(d=>d.id!==u?d:{...d,data:{...d.data,config:{...d.data.config,generatedVideoUrl:B,taskId:n}}}))}$(!1),g.success("ğŸ¬ è§†é¢‘ç¼–è¾‘å®Œæˆï¼Œå¿«å»çœ‹çœ‹å§ï¼");return}else if(D.status==="PROCESSING"||D.status==="PENDING")if(o<a)setTimeout(c,5e3);else{$(!1),g.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),he(B=>B.map(v=>v.id===u?{...v,data:{...v.data,config:{...v.data.config,taskId:""}}}:v));return}else if(D.status==="FAILURE"){$(!1);try{const{useAuthStore:B}=await gs(async()=>{const{useAuthStore:p}=await import("./index-Cp0uMTfX.js").then(d=>d.f);return{useAuthStore:p}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:v}=B.getState();await v()}catch{}g.error(D.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),he(B=>B.map(v=>v.id===u?{...v,data:{...v.data,config:{...v.data.config,taskId:""}}}:v));return}else{$(!1),g.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),he(B=>B.map(v=>v.id===u?{...v,data:{...v.data,config:{...v.data.config,taskId:""}}}:v));return}}catch{$(!1),g.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),he(D=>D.map(B=>B.id===u?{...B,data:{...B.data,config:{...B.data.config,taskId:""}}}:B));return}};c()},te=async()=>{var n,o;if(!x){g.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 å¼ äººç‰©å›¾ç‰‡~");return}$(!0);try{const a=await Me.post("/tasks/video-edit",{modelId:R,prompt:ve||"",referenceImages:T.imageUrl?[T.imageUrl]:[],sourceNodeId:u,duration:Z,metadata:{videoUrl:T.videoUrl,wanMode:ee,duration:Z}}),c=a.taskId,w=a.creditsCharged||0;if(w>0)try{const{useAuthStore:I}=await gs(async()=>{const{useAuthStore:B}=await import("./index-Cp0uMTfX.js").then(v=>v.f);return{useAuthStore:B}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:D}=I.getState();await D(),g.success(`ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${w} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{g.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else g.success("ğŸ¬ ç¼–è¾‘å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");he(I=>I.map(D=>D.id===u?{...D,data:{...D.data,config:{...D.data.config,taskId:c}}}:D)),await j(c)}catch(a){$(!1);const c=((o=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:o.error)||a.message||"æœªçŸ¥åŸå› ";g.error(`å¯åŠ¨å¤±è´¥ï¼š${c}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie_edit"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:((r=s==null?void 0:s.config)==null?void 0:r.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":"è§†é¢‘æ¢äºº"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(rs,{value:R,onChange:n=>{M(n),he(o=>o.map(a=>{var c;return a.id===u?{...a,data:{...a.data,config:{...a.data.config,modelId:n,modelName:(c=ie.find(w=>w.id===n))==null?void 0:c.name}}}:a}))},options:ie.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:ie.map(n=>({value:n.id,label:n.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œæ›¿æ¢äººç‰©å›¾ç‰‡"}),e.jsx("p",{children:"2. è§†é¢‘æ—¶é•¿2-30ç§’"}),e.jsx("p",{children:"3. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡ä¸è¶…è¿‡2048x2048"}),e.jsx("p",{children:"4. å›¾ç‰‡æœ€å¤§ä¸è¶…è¿‡5MB"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>de("wan-std"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${ee==="wan-std"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"æ ‡å‡†"}),e.jsx("button",{type:"button",onClick:()=>de("wan-pro"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all ${ee==="wan-pro"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border border-slate-200 dark:border-white/10"}`,children:"ä¸“ä¸š"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((b=s==null?void 0:s.config)==null?void 0:b.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œè§†é¢‘":"åŸå§‹è§†é¢‘"}),T.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:Oe,src:T.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:n=>{const o=n.currentTarget;o.duration&&o.duration!==1/0&&ge(o.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:((l=s==null?void 0:s.config)==null?void 0:l.selectedEditingCapability)==="åŠ¨ä½œå…‹éš†"?"äººç‰©å›¾ç‰‡":"æ›¿æ¢äººç‰©"}),T.imageUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",children:e.jsx("img",{src:T.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:120},draggable:!1})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]})]}),e.jsx("button",{onClick:te,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"æ¢äººä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹æ¢äºº"}),!we&&(De!==null&&De>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[De,"ç§¯åˆ†"]}):Z===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Ka=t.memo(Ya),fr="https://api.waule.com",Qa=({data:s,selected:C,id:u})=>{var B,v;const[Q]=t.useState(!0),[Ie,$]=t.useState(!1),[ve,ee]=t.useState(!1),de=t.useRef(null),Z=t.useRef(null),ge=t.useRef(null),[Oe,he]=t.useState(!1),[ne,se]=t.useState(0),[fe,ce]=t.useState(0),[Ce,K]=t.useState(0),[De,we]=t.useState(null),{setNodes:ie,setEdges:R,getNode:M,getNodes:P,getEdges:T}=ts(),x=Fs(),m=Ds(),j=t.useMemo(()=>`lipSyncTask:${u}`,[u]),te=t.useMemo(()=>(s.models||[]).filter(d=>{var E;return(d.type||"")==="VIDEO_EDITING"&&Array.isArray((E=d.config)==null?void 0:E.supportedEditingCapabilities)&&d.config.supportedEditingCapabilities.includes("å¯¹å£å‹")}),[s.models]),[L,A]=t.useState(s.config.modelId||((B=te[0])==null?void 0:B.id)||"");t.useEffect(()=>{var p;if(!te.find(d=>d.id===L)){const d=((p=te[0])==null?void 0:p.id)||"";A(d),ie(E=>E.map(Y=>{var X;return Y.id===u?{...Y,data:{...Y.data,config:{...Y.data.config,modelId:d||void 0,modelName:d?(X=te[0])==null?void 0:X.name:void 0}}}:Y}))}},[te]);const O=t.useMemo(()=>!fe||!ne?0:fe>=ne||ve?ne:fe,[fe,ne,ve]),{credits:r,loading:b}=Ls({aiModelId:L,duration:O,mode:"standard",operationType:"video_retalk"}),l=t.useMemo(()=>{var X,J,F,ae,oe,le,S,f,k;const p=x.filter(h=>h.target===u);let d=null,E=null,Y=null;for(const h of p){const W=m.find(q=>q.id===h.source);if(!W)continue;const ue=String(W.type||"");if(ue==="upload"){const q=(F=(J=(X=W.data)==null?void 0:X.config)==null?void 0:J.uploadedFiles)==null?void 0:F[0];if(!q)continue;const be=String(q.mimeType||"").toLowerCase(),Se=String(q.type||"").toUpperCase(),ye=q.url.startsWith("http")||q.url.startsWith("data:")?q.url:`${fr}${q.url}`;!d&&(Se==="VIDEO"||be.startsWith("video/"))&&(d=ye),!E&&(Se==="AUDIO"||be.startsWith("audio/"))&&(E=ye),!Y&&(Se==="IMAGE"||be.startsWith("image/"))&&(Y=ye)}else if(ue==="assetSelector"){const q=(oe=(ae=W.data)==null?void 0:ae.config)==null?void 0:oe.selectedAsset;if(q){const be=String(q.mimeType||"").toLowerCase(),Se=String(q.type||"").toUpperCase(),ye=q.url.startsWith("http")||q.url.startsWith("data:")?q.url:`${fr}${q.url}`;!d&&(Se==="VIDEO"||be.startsWith("video/"))&&(d=ye),!E&&(Se==="AUDIO"||be.startsWith("audio/"))&&(E=ye),!Y&&(Se==="IMAGE"||be.startsWith("image/"))&&(Y=ye)}}else if(ue==="videoPreview"||ue.startsWith("aiVideo")){const q=((le=W.data)==null?void 0:le.videoUrl)||((S=W.data)==null?void 0:S.url)||((k=(f=W.data)==null?void 0:f.config)==null?void 0:k.generatedVideoUrl);!d&&q&&(d=q.startsWith("http")||q.startsWith("data:")?q:`${fr}${q}`)}if(d&&E&&Y)break}return{videoUrl:d,audioUrl:E,imageUrl:Y}},[x,u,m]),n=t.useMemo(()=>{var d;const p=te.find(E=>E.id===L);return((d=p==null?void 0:p.modelId)==null?void 0:d.toLowerCase().includes("videoretalk"))||!1},[L,te]),o=t.useMemo(()=>!!L&&!!l.videoUrl&&!!l.audioUrl&&!De,[L,l.videoUrl,l.audioUrl,De]);t.useEffect(()=>{const p=de.current;if(!p||!l.audioUrl)return;p.src=l.audioUrl,p.load();const d=()=>{se(p.duration||0)},E=()=>K(p.duration?p.currentTime/p.duration:0),Y=()=>he(!1);return p.addEventListener("loadedmetadata",d),p.addEventListener("timeupdate",E),p.addEventListener("ended",Y),()=>{p.removeEventListener("loadedmetadata",d),p.removeEventListener("timeupdate",E),p.removeEventListener("ended",Y)}},[l.audioUrl]),t.useEffect(()=>{if(!l.videoUrl){ce(0);return}const p=document.createElement("video");p.src=l.videoUrl,p.onloadedmetadata=()=>{if(ce(p.duration||0),n){const d=p.videoWidth,E=p.videoHeight;d>2048||E>2048?(we(`è§†é¢‘åˆ†è¾¨ç‡ ${d}x${E} è¶…å‡ºé™åˆ¶ï¼ˆå•è¾¹æœ€å¤§ 2048ï¼‰`),g.error(`è§†é¢‘åˆ†è¾¨ç‡è¶…å‡ºé™åˆ¶ï¼ˆå½“å‰ ${d}x${E}ï¼Œæœ€å¤§ 2048ï¼‰ï¼Œè¿æ¥å·²æ–­å¼€`),R(Y=>Y.filter(X=>{var ae,oe,le,S,f,k,h,W;if(X.target!==u)return!0;const J=m.find(ue=>ue.id===X.source);return J?!(J.type==="upload"&&((S=(le=(oe=(ae=J.data)==null?void 0:ae.config)==null?void 0:oe.uploadedFiles)==null?void 0:le[0])==null?void 0:S.type)==="VIDEO"||J.type==="assetSelector"&&((h=(k=(f=J.data)==null?void 0:f.config)==null?void 0:k.selectedAsset)==null?void 0:h.type)==="VIDEO"||J.type==="videoPreview"||((W=J.type)==null?void 0:W.startsWith("aiVideo"))):!0}))):De!=null&&De.includes("è§†é¢‘åˆ†è¾¨ç‡")&&we(null)}},p.onerror=()=>ce(0),p.load()},[l.videoUrl,n,u,m,R]),t.useEffect(()=>{const p=l.audioUrl,d=ge.current;if(!p||!d)return;const E=X=>{const J=d.getContext("2d");if(!J)return;const F=d.width,ae=d.height;J.clearRect(0,0,F,ae);const oe="#1a1033",le="#7a0fe8";J.fillStyle=oe,J.fillRect(0,0,F,ae);const S=X.length,f=2,k=Math.max(1,Math.floor((F-(S-1)*f)/S));for(let h=0;h<S;h++){const W=Math.min(1,Math.max(0,X[h])),ue=Math.max(2,Math.floor(W*ae)),q=h*(k+f),be=Math.floor((ae-ue)/2);J.fillStyle=le,J.fillRect(q,be,k,ue)}if(Ce>0){const h=Math.floor(F*Ce);J.fillStyle="#ffffff88",J.fillRect(h,0,2,ae)}};(async()=>{try{let X=p;p.includes("aliyuncs.com")&&(X=`https://api.waule.com/proxy/audio?url=${encodeURIComponent(p)}`);const F=await(await fetch(X,{mode:(p.includes("aliyuncs.com"),"cors"),credentials:p.includes("aliyuncs.com")?"include":"omit"})).arrayBuffer(),ae=window.AudioContext||window.webkitAudioContext,S=(await new ae().decodeAudioData(F)).getChannelData(0),f=120,k=Math.max(1,Math.floor(S.length/f)),h=new Float32Array(f);for(let W=0;W<f;W++){let ue=0,q=0;const be=W*k,Se=Math.min(S.length,be+k);for(let ye=be;ye<Se;ye++)ue+=Math.abs(S[ye]),q++;h[W]=q?ue/q:0}E(h)}catch{const J=new Float32Array(120);for(let F=0;F<120;F++)J[F]=(Math.sin(F/5)+1)/2;E(J)}})()},[l.audioUrl,Ce]);const a=()=>{const p=de.current;p&&(Oe?(p.pause(),he(!1)):(p.play(),he(!0)))},c=p=>{if(!p||!isFinite(p))return"0:00";const d=Math.floor(p/60),E=Math.floor(p%60);return`${d}:${E.toString().padStart(2,"0")}`},w=t.useCallback(p=>{var _e,je,Te;const d=M(u);if(!d||!p)return;const E=p.startsWith("http")||p.startsWith("data:")?p:`${fr}${p}`,Y=P(),X=T(),J=Y.filter(Re=>Re.type==="videoPreview"&&X.some(re=>re.source===u&&re.target===Re.id));if(J.find(Re=>{var re;return((re=Re.data)==null?void 0:re.videoUrl)===E}))return;const ae=400,oe=(Re,re=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(Re))return re;const[Be,qe]=Re.split(":").map(Ft=>parseFloat(Ft));return!Be||!qe?re:Math.round(ae*(qe/Be))},le=200,S=100,f=oe("16:9",300),k=document.querySelector(`.react-flow__node[data-id="${u}"]`),h=Math.round((k==null?void 0:k.getBoundingClientRect().width)||400),W=(((_e=d.position)==null?void 0:_e.x)||0)+h+le,ue=((je=d.position)==null?void 0:je.y)||0,q=J.length,be=W,Se=ue+q*(f+S),ye={id:`preview-${u}-${Date.now()}`,type:"videoPreview",position:{x:be,y:Se},data:{videoUrl:E,ratio:"16:9",workflowContext:d.data.workflowContext,createdBy:(Te=d.data)==null?void 0:Te.createdBy}};ie(Re=>[...Re,ye]),R(Re=>[...Re,{id:`edge-${u}-${ye.id}`,source:u,target:ye.id,type:"aurora"}])},[u,M,P,T,ie,R]);t.useEffect(()=>{var d;const p=(d=s==null?void 0:s.config)==null?void 0:d.generatedVideoUrl;p&&w(p)},[(v=s==null?void 0:s.config)==null?void 0:v.generatedVideoUrl]),t.useEffect(()=>{const p=s.config.taskId||(()=>{try{return localStorage.getItem(j)||""}catch{return""}})();(async()=>{var Y,X;let E=!1;if(p)try{const F=(await Me.tasks.getTaskStatus(p)).task;if(F.status==="PROCESSING"||F.status==="PENDING"){const ae=new Date(F.createdAt);if((new Date().getTime()-ae.getTime())/(1e3*60*60)>1){$(!1),ie(S=>S.map(f=>f.id===u?{...f,data:{...f.data,config:{...f.data.config,taskId:""}}}:f));try{localStorage.removeItem(j)}catch{}return}}if(F.status==="SUCCESS"||F.status==="COMPLETED"||F.status==="DONE"){const ae=F.resultUrl||((Y=F.previewNodeData)==null?void 0:Y.url);if(ae){let oe=!1;try{const le=localStorage.getItem("suppressedPreviewTasks")||"[]";oe=JSON.parse(le).some(f=>f.taskId&&f.taskId===p||f.sourceNodeId&&f.sourceNodeId===u)}catch{}oe||w(ae),ie(le=>le.map(S=>S.id===u?{...S,data:{...S.data,config:{...S.data.config,generatedVideoUrl:ae,taskId:p}}}:S))}$(!1);try{localStorage.removeItem(j)}catch{}E=!0}else if(F.status==="PROCESSING"||F.status==="PENDING"){$(!0),await I(p);return}else if(F.status==="FAILURE"||F.status==="FAILED"){$(!1),ie(ae=>ae.map(oe=>oe.id===u?{...oe,data:{...oe.data,config:{...oe.data.config,taskId:""}}}:oe));try{localStorage.removeItem(j)}catch{}}}catch{$(!1);try{localStorage.removeItem(j)}catch{}}if(!E)try{const J=await Me.tasks.getPendingPreviewNodes(u);if(Array.isArray(J.tasks)&&J.tasks.length>0)for(const F of J.tasks){const ae=(X=F.previewNodeData)==null?void 0:X.url;if(ae){let oe=!1;try{const le=localStorage.getItem("suppressedPreviewTasks")||"[]";oe=JSON.parse(le).some(f=>f.taskId&&f.taskId===F.id||f.sourceNodeId&&f.sourceNodeId===u)}catch{}oe||w(ae),await Me.tasks.markPreviewNodeCreated(F.id)}}}catch{}})()},[j,u,w]);const I=async p=>{let d=0;const E=600;let Y=-1,X=0;const J=60,F=async()=>{var ae;try{d++;const le=(await Me.tasks.getTaskStatus(p)).task;if(le.status==="PROCESSING"||le.status==="PENDING"){const S=le.progress||0;if(S===Y){if(X++,X>=J){$(!1),g.error("ä»»åŠ¡è¿›åº¦åœæ»ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°å°è¯•"),ie(f=>f.map(k=>k.id===u?{...k,data:{...k.data,config:{...k.data.config,taskId:""}}}:k));try{localStorage.removeItem(j)}catch{}return}}else Y=S,X=0}if(le.status==="SUCCESS"||le.status==="COMPLETED"||le.status==="DONE"){const S=le.resultUrl||((ae=le.previewNodeData)==null?void 0:ae.url);S&&(w(S),ie(f=>f.map(k=>k.id===u?{...k,data:{...k.data,config:{...k.data.config,generatedVideoUrl:S,taskId:p}}}:k))),$(!1),g.success("ğŸ¬ å¯¹å£å‹å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼");try{localStorage.removeItem(j)}catch{}return}else if(le.status==="PROCESSING"||le.status==="PENDING")if(d<E)setTimeout(F,5e3);else{$(!1),g.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ie(S=>S.map(f=>f.id===u?{...f,data:{...f.data,config:{...f.data.config,taskId:""}}}:f));try{localStorage.removeItem(j)}catch{}return}else if(le.status==="FAILURE"||le.status==="FAILED"){$(!1);try{const{useAuthStore:S}=await gs(async()=>{const{useAuthStore:k}=await import("./index-Cp0uMTfX.js").then(h=>h.f);return{useAuthStore:k}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:f}=S.getState();await f()}catch{}g.error(le.errorMessage||"å¤„ç†é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ie(S=>S.map(f=>f.id===u?{...f,data:{...f.data,config:{...f.data.config,taskId:""}}}:f));try{localStorage.removeItem(j)}catch{}return}else{$(!1),g.error("ä»»åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"),ie(S=>S.map(f=>f.id===u?{...f,data:{...f.data,config:{...f.data.config,taskId:""}}}:f));try{localStorage.removeItem(j)}catch{}return}}catch{$(!1),g.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ie(le=>le.map(S=>S.id===u?{...S,data:{...S.data,config:{...S.data.config,taskId:""}}}:S));try{localStorage.removeItem(j)}catch{}return}};F()},D=async()=>{var p,d;if(!o){g.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘å’Œ 1 ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰~");return}$(!0);try{const E=await Me.post("/tasks/video-edit",{modelId:L,prompt:"",referenceImages:l.imageUrl?[l.imageUrl]:[],sourceNodeId:u,generationType:"å¯¹å£å‹",duration:O,metadata:{videoUrl:l.videoUrl,audioUrl:l.audioUrl,videoExtension:ve,duration:O}}),Y=E.taskId,X=E.creditsCharged||0;if(X>0)try{const{useAuthStore:J}=await gs(async()=>{const{useAuthStore:ae}=await import("./index-Cp0uMTfX.js").then(oe=>oe.f);return{useAuthStore:ae}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:F}=J.getState();await F(),g.success(`ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${X} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{g.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else g.success("ğŸ¬ å¯¹å£å‹å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ie(J=>J.map(F=>F.id===u?{...F,data:{...F.data,config:{...F.data.config,taskId:Y}}}:F));try{localStorage.setItem(j,Y)}catch{}await I(Y)}catch(E){$(!1);const Y=((d=(p=E==null?void 0:E.response)==null?void 0:p.data)==null?void 0:d.error)||E.message||"æœªçŸ¥åŸå› ";g.error(`å¯åŠ¨å¤±è´¥ï¼š${Y}ï¼Œè¯·ç¨åé‡è¯•`);try{localStorage.removeItem(j)}catch{}}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"mic"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¯¹å£å‹"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç¼–è¾‘æ¨¡å‹"}),e.jsx(rs,{value:L,onChange:p=>{A(p),ie(d=>d.map(E=>{var Y;return E.id===u?{...E,data:{...E.data,config:{...E.data.config,modelId:p,modelName:(Y=te.find(X=>X.id===p))==null?void 0:Y.name}}}:E}))},options:te.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:te.map(p=>({value:p.id,label:p.name}))}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¾“å…¥åŸå§‹è§†é¢‘å’Œé…éŸ³å³å¯å¯¹å£å‹"}),e.jsx("p",{children:"2. å¤šäººåœºæ™¯å¯ä¸Šä¼ äººç‰©å¤´åƒæŒ‡å®šäººç‰©"}),e.jsx("p",{children:"3. æ—¶é•¿2-120ç§’ï¼Œå»ºè®®é…éŸ³ä¸è§†é¢‘æ—¶é•¿æ¥è¿‘"}),e.jsx("p",{children:"4. è§†é¢‘æœ€å¤§åˆ†è¾¨ç‡2048ï¼ŒéŸ³é¢‘æœ€å¤§30MB"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:l.videoUrl?e.jsx("video",{src:l.videoUrl,controls:!0,muted:!0,playsInline:!0,className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},l.videoUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å‚è€ƒå›¾ï¼ˆé€‰ï¼‰"}),e.jsx("div",{className:"bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden flex items-center justify-center",style:{width:"100%",height:100},children:l.imageUrl?e.jsx("img",{src:l.imageUrl,alt:"",className:"object-cover",style:{width:"100%",height:"100%"},draggable:!1},l.imageUrl):e.jsx("span",{className:"text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­éŸ³éŸ³é¢‘"}),l.audioUrl?e.jsxs("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",style:{height:140},children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("button",{onClick:a,className:"nodrag w-7 h-7 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg flex items-center justify-center transition-all active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:Oe?"pause":"play_arrow"})}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white",children:c(ne)})]}),e.jsx("div",{className:"px-2 pb-2",children:e.jsx("canvas",{ref:ge,width:280,height:70,className:"w-full"})}),e.jsx("audio",{ref:de,src:l.audioUrl,className:"hidden"}),e.jsx("video",{ref:Z,className:"hidden",muted:!0,onLoadedMetadata:p=>{const d=p.currentTarget;d.duration&&d.duration!==1/0&&ce(d.duration)}})]}):e.jsx("div",{className:"w-full h-16 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"nodrag",checked:ve,onChange:p=>ee(p.target.checked)}),e.jsx("span",{className:"text-[10px] text-slate-600 dark:text-white",children:"éŸ³é¢‘æ›´é•¿æ—¶æ‰©å±•è§†é¢‘"})]}),e.jsx("button",{onClick:D,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹å¯¹å£å‹"}),!b&&(r!==null&&r>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[r,"ç§¯åˆ†"]}):O===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Za=t.memo(Qa),br="https://api.waule.com",eo=[{id:0,name:"æ—¥å¼æ¼«ç”»"},{id:1,name:"ç¾å¼æ¼«ç”»"},{id:2,name:"æ¸…æ–°æ¼«ç”»"},{id:3,name:"3Då¡é€š"},{id:4,name:"å›½é£å¡é€š"},{id:5,name:"çº¸è‰ºé£æ ¼"},{id:6,name:"ç®€æ˜“æ’ç”»"},{id:7,name:"å›½é£æ°´å¢¨"}],to=({data:s,selected:C,id:u})=>{var te,L;const[Q]=t.useState(!0),[Ie,$]=t.useState(!1),[ve,ee]=t.useState(typeof s.config.styleId=="number"?s.config.styleId:0),[de,Z]=t.useState(s.config.videoFps||15),[ge,Oe]=t.useState(0),he=t.useRef(null),{setNodes:ne,setEdges:se,getNode:fe,getNodes:ce,getEdges:Ce}=ts(),K=Fs(),De=t.useMemo(()=>(s.models||[]).filter(O=>{var r;return(O.type||"")==="VIDEO_EDITING"&&Array.isArray((r=O.config)==null?void 0:r.supportedEditingCapabilities)&&O.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")}),[s.models]),[we,ie]=t.useState(s.config.modelId||((te=De[0])==null?void 0:te.id)||""),{credits:R,loading:M}=Ls({aiModelId:we,duration:ge});t.useMemo(()=>De.find(A=>A.id===we),[De,we]),t.useEffect(()=>{var A;if(!De.find(O=>O.id===we)){const O=((A=De[0])==null?void 0:A.id)||"";ie(O),ne(r=>r.map(b=>{var l;return b.id===u?{...b,data:{...b.data,config:{...b.data.config,modelId:O||void 0,modelName:O?(l=De[0])==null?void 0:l.name:void 0}}}:b}))}},[De]);const P=t.useMemo(()=>{var r,b,l,n,o,a,c,w,I;const A=K.filter(D=>D.target===u);let O=null;for(const D of A){const B=fe(D.source);if(!B)continue;const v=String(B.type||"");if(v==="upload"){const p=(l=(b=(r=B.data)==null?void 0:r.config)==null?void 0:b.uploadedFiles)==null?void 0:l[0];if(!p)continue;const d=String(p.mimeType||"").toLowerCase(),E=String(p.type||"").toUpperCase(),Y=p.url.startsWith("http")||p.url.startsWith("data:")?p.url:`${br}${p.url}`;!O&&(E==="VIDEO"||d.startsWith("video/"))&&(O=Y)}else if(v==="assetSelector"){const p=(o=(n=B.data)==null?void 0:n.config)==null?void 0:o.selectedAsset;if(p){const d=String(p.mimeType||"").toLowerCase(),E=String(p.type||"").toUpperCase(),Y=p.url.startsWith("http")||p.url.startsWith("data:")?p.url:`${br}${p.url}`;!O&&(E==="VIDEO"||d.startsWith("video/"))&&(O=Y)}}else if(v==="videoPreview"||v.startsWith("aiVideo")){const p=((a=B.data)==null?void 0:a.videoUrl)||((c=B.data)==null?void 0:c.url)||((I=(w=B.data)==null?void 0:w.config)==null?void 0:I.generatedVideoUrl);!O&&p&&(O=p.startsWith("http")||p.startsWith("data:")?p:`${br}${p}`)}if(O)break}return{videoUrl:O}},[K,u,fe]);t.useEffect(()=>{if(!P.videoUrl){Oe(0);return}const A=document.createElement("video");A.crossOrigin="anonymous",A.preload="metadata",A.onloadedmetadata=()=>{A.duration&&A.duration!==1/0&&Oe(A.duration)},A.onerror=()=>Oe(0),A.src=P.videoUrl},[P.videoUrl]);const T=t.useMemo(()=>!!we&&!!P.videoUrl,[we,P.videoUrl]),x=t.useCallback(A=>{var J,F,ae;const O=fe(u);if(!O||!A)return;const r=ce(),b=Ce(),l=r.filter(oe=>oe.type==="videoPreview"&&b.some(le=>le.source===u&&le.target===oe.id));if(l.find(oe=>{var le;return((le=oe.data)==null?void 0:le.videoUrl)===A}))return;const o=400,a=(oe,le=300)=>{if(!/^[0-9]+\s*:\s*[0-9]+$/.test(oe))return le;const[S,f]=oe.split(":").map(k=>parseFloat(k));return!S||!f?le:Math.round(o*(f/S))},c=200,w=100,I=a("16:9",300),D=document.querySelector(`.react-flow__node[data-id="${u}"]`),B=Math.round((D==null?void 0:D.getBoundingClientRect().width)||400),v=(((J=O.position)==null?void 0:J.x)||0)+B+c,p=((F=O.position)==null?void 0:F.y)||0,d=l.length,E=v,Y=p+d*(I+w),X={id:`preview-${u}-${Date.now()}`,type:"videoPreview",position:{x:E,y:Y},data:{videoUrl:A,width:o,ratio:"16:9",workflowContext:O.data.workflowContext,createdBy:(ae=O.data)==null?void 0:ae.createdBy}};ne(oe=>[...oe,X]),se(oe=>[...oe,{id:`edge-${u}-${X.id}`,source:u,target:X.id,type:"aurora"}])},[u,fe,ce,Ce,ne,se]);t.useEffect(()=>{var O;const A=(O=s==null?void 0:s.config)==null?void 0:O.generatedVideoUrl;A&&x(A)},[(L=s==null?void 0:s.config)==null?void 0:L.generatedVideoUrl]),t.useEffect(()=>{const A=s.config.taskId;(async()=>{var b,l;let r=!1;if(A)try{const o=(await Me.tasks.getTaskStatus(A)).task;if(o.status==="SUCCESS"){const a=o.resultUrl||((b=o.previewNodeData)==null?void 0:b.url);if(a){let c=!1;try{const w=localStorage.getItem("suppressedPreviewTasks")||"[]";c=JSON.parse(w).some(D=>D.taskId&&D.taskId===A||D.sourceNodeId&&D.sourceNodeId===u)}catch{}c||x(a),ne(w=>w.map(I=>I.id===u?{...I,data:{...I.data,config:{...I.data.config,generatedVideoUrl:a,taskId:A}}}:I))}$(!1),r=!0}else if(o.status==="PROCESSING"||o.status==="PENDING"){$(!0),await m(A);return}else o.status==="FAILURE"&&($(!1),ne(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c)))}catch{$(!1)}if(!r)try{const n=await Me.tasks.getPendingPreviewNodes(u);if(Array.isArray(n.tasks)&&n.tasks.length>0)for(const o of n.tasks){const a=(l=o.previewNodeData)==null?void 0:l.url;if(a){let c=!1;try{const w=localStorage.getItem("suppressedPreviewTasks")||"[]";c=JSON.parse(w).some(D=>D.taskId&&D.taskId===o.id||D.sourceNodeId&&D.sourceNodeId===u)}catch{}c||x(a),await Me.tasks.markPreviewNodeCreated(o.id)}}}catch{}})()},[]);const m=async A=>{let O=0;const r=600,b=async()=>{var l;try{O++;const o=(await Me.tasks.getTaskStatus(A)).task;if(o.status==="SUCCESS"){const a=o.resultUrl||((l=o.previewNodeData)==null?void 0:l.url);a&&(x(a),ne(c=>c.map(w=>w.id!==u?w:{...w,data:{...w.data,config:{...w.data.config,generatedVideoUrl:a,taskId:A}}}))),$(!1),g.success("ğŸ¨ é£æ ¼è½¬æ¢å®Œæˆï¼Œå¿«å»çœ‹çœ‹æ•ˆæœå§ï¼")}else o.status==="PROCESSING"||o.status==="PENDING"?O<r?setTimeout(b,5e3):($(!1),g.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ne(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c))):o.status==="FAILURE"&&($(!1),g.error(o.errorMessage||"è½¬æ¢é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²è‡ªåŠ¨é€€è¿˜"),ne(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,taskId:""}}}:c)))}catch{$(!1),g.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"),ne(o=>o.map(a=>a.id===u?{...a,data:{...a.data,config:{...a.data.config,taskId:""}}}:a))}};b()},j=async()=>{var A,O;if(!T){g.error("è¯·å…ˆè¿æ¥ 1 ä¸ªè§†é¢‘~");return}$(!0);try{const r=await Me.post("/tasks/video-edit",{modelId:we,prompt:"",referenceImages:[],sourceNodeId:u,generationType:"é£æ ¼è½¬æ¢",duration:ge,metadata:{videoUrl:P.videoUrl,styleId:ve,videoFps:de,duration:ge}}),b=r.taskId,l=r.creditsCharged||0;if(l>0)try{const{useAuthStore:n}=await gs(async()=>{const{useAuthStore:a}=await import("./index-Cp0uMTfX.js").then(c=>c.f);return{useAuthStore:a}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:o}=n.getState();await o(),g.success(`ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œæ¶ˆè€— ${l} ç§¯åˆ†ã€‚è§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~`)}catch{g.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~")}else g.success("ğŸ¨ é£æ ¼è½¬æ¢å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~");ne(n=>n.map(o=>o.id===u?{...o,data:{...o.data,config:{...o.data.config,taskId:b,styleId:ve,videoFps:de}}}:o)),await m(b)}catch(r){$(!1);const b=((O=(A=r==null?void 0:r.response)==null?void 0:A.data)==null?void 0:O.error)||r.message||"æœªçŸ¥åŸå› ";g.error(`å¯åŠ¨å¤±è´¥ï¼š${b}ï¼Œè¯·ç¨åé‡è¯•`)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"palette"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"é£æ ¼è½¬æ¢"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘è½¬ç»˜æ¨¡å‹"}),e.jsx(rs,{value:we,onChange:A=>{ie(A),ne(O=>O.map(r=>{var b;return r.id===u?{...r,data:{...r.data,config:{...r.data.config,modelId:A,modelName:(b=De.find(l=>l.id===A))==null?void 0:b.name}}}:r}))},options:De.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:De.map(A=>({value:A.id,label:A.name}))}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"é£æ ¼"}),e.jsx(rs,{value:String(ve),onChange:A=>{const O=parseInt(A,10);ee(O),ne(r=>r.map(b=>b.id===u?{...b,data:{...b.data,config:{...b.data.config,styleId:O}}}:b))},options:eo.map(A=>({value:String(A.id),label:A.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å¸§ç‡"}),e.jsx("input",{type:"number",value:de,min:15,max:25,onChange:A=>{let O=parseInt(A.target.value,10)||15;O<15&&(O=15),O>25&&(O=25),Z(O),ne(r=>r.map(b=>b.id===u?{...b,data:{...b.data,config:{...b.data.config,videoFps:O}}}:b))},className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white"})]})]}),e.jsxs("div",{className:"mt-2 space-y-0.5 text-[10px] text-slate-600 dark:text-slate-400",children:[e.jsx("p",{children:"1. è¿æ¥åŸå§‹è§†é¢‘"}),e.jsx("p",{children:"2. 8ç§é£æ ¼é¢„è®¾"}),e.jsx("p",{children:"3. æ—¶é•¿â‰¤30ç§’ï¼Œåˆ†è¾¨ç‡â‰¤4096"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åŸå§‹è§†é¢‘"}),P.videoUrl?e.jsx("div",{className:"w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md overflow-hidden",children:e.jsx("video",{ref:he,src:P.videoUrl,controls:!0,muted:!0,playsInline:!0,crossOrigin:"anonymous",className:"w-full object-cover",style:{height:120},draggable:!1,onLoadedMetadata:A=>{const O=A.currentTarget;O.duration&&O.duration!==1/0&&Oe(O.duration)}})}):e.jsx("div",{className:"w-full h-20 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md flex items-center justify-center text-slate-400 dark:text-white/30 text-[10px]",children:"æœªè¿æ¥"})]}),e.jsx("button",{onClick:j,disabled:Ie||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${Ie?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"è½¬ç»˜ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"å¼€å§‹è½¬ç»˜"}),!M&&(R!==null&&R>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[R,"ç§¯åˆ†"]}):ge===0?e.jsx("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:"10ç§¯åˆ†/ç§’"}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},so=t.memo(to),ro=({data:s,selected:C,id:u})=>{const[Q,Ie]=t.useState(null),[$,ve]=t.useState(!1),[ee,de]=t.useState(s.config.prompt||""),[Z,ge]=t.useState(""),Oe=t.useRef(null),he=t.useRef(!1),[ne,se]=t.useState(!1),{setNodes:fe,setEdges:ce,getNode:Ce,getNodes:K,getEdges:De}=ts(),we=dr(n=>n.edges.filter(o=>o.target===u)),ie=Ds(),[R,M]=t.useState([]),[P,T]=t.useState([]),x=t.useRef(""),m=t.useMemo(()=>((Q==null?void 0:Q.roles)||[]).find(n=>n.id===Z),[Q,Z]),{credits:j,loading:te,isFreeUsage:L,freeUsageRemaining:A}=Ls({aiModelId:m==null?void 0:m.aiModelId,quantity:1});t.useEffect(()=>{s.config.agentId&&O(s.config.agentId)},[s.config.agentId]);const O=async n=>{var o,a,c,w,I;try{ve(!0);const D=await Me.agents.getById(n);let B=[];try{B=await Me.agents.roles.listByAgent(n)||[],Ie({...D,roles:B});const p=((o=s==null?void 0:s.config)==null?void 0:o.roleId)||"";ge(p||((a=B[0])==null?void 0:a.id)||"")}catch{Ie(D)}try{const v=await Me.agents.getAvailableModels(),p=(B||[]).find(d=>{var E;return d.id===((E=s==null?void 0:s.config)==null?void 0:E.roleId)});if(p){const d=(v||[]).find(Y=>Y.id===p.aiModelId),E=((c=d==null?void 0:d.config)==null?void 0:c.acceptedInputs)||((d==null?void 0:d.type)==="TEXT_GENERATION"&&((I=(w=d==null?void 0:d.provider)==null?void 0:w.toLowerCase())!=null&&I.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:E})}else r({acceptedInputs:["TEXT"]})}catch{}}catch{g.error("åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯å¤±è´¥")}finally{ve(!1)}};t.useEffect(()=>{r({roleId:Z}),(async()=>{var n,o,a;if(Q)try{const c=await Me.agents.getAvailableModels(),w=(Q.roles||[]).find(I=>I.id===Z);if(w){const I=(c||[]).find(B=>B.id===w.aiModelId),D=((n=I==null?void 0:I.config)==null?void 0:n.acceptedInputs)||((I==null?void 0:I.type)==="TEXT_GENERATION"&&((a=(o=I==null?void 0:I.provider)==null?void 0:o.toLowerCase())!=null&&a.includes("google"))?["TEXT","IMAGE","DOCUMENT"]:["TEXT"]);r({acceptedInputs:D})}else r({acceptedInputs:["TEXT"]})}catch{}})()},[Z,Q]);const r=n=>{Ce(u)&&fe(a=>a.map(c=>c.id===u?{...c,data:{...c.data,config:{...c.data.config,...n}}}:c))};t.useEffect(()=>{const n=Oe.current;n&&requestAnimationFrame(()=>{n.style.height="auto";const o=Math.max(60,Math.min(n.scrollHeight,600));n.style.height=`${o}px`})},[ee]),t.useEffect(()=>{const n=setTimeout(()=>{ee!==s.config.prompt&&r({prompt:ee})},500);return()=>clearTimeout(n)},[ee,s.config.prompt]),t.useEffect(()=>{const n=we;if(!n||n.length===0)return;let o="";n.some(a=>{const c=ie.find(I=>I.id===a.source);if(!c)return!1;const w=c.data||{};return c.type==="textPreview"&&typeof w.content=="string"&&w.content.trim()?(o=w.content.trim(),!0):!1}),o&&!he.current&&(de(o),r({prompt:o}))},[we,ie]),t.useEffect(()=>{const n=we.map(c=>`${c.id}-${c.source}`).sort().join(",");if(n===x.current)return;x.current=n;const o=[],a=[];we.forEach(c=>{var D,B,v;const w=Ce(c.source);if(!w)return;const I=w.data||{};if(w.type==="upload")(((D=I.config)==null?void 0:D.uploadedFiles)||[]).forEach(d=>{d.type==="IMAGE"&&o.push(d.url),d.type==="DOCUMENT"&&a.push({name:d.originalName,url:d.url})});else if(w.type==="assetSelector"){const p=(B=I.config)==null?void 0:B.subjects;if(p&&p.length>0)(p[0].images||[]).map(E=>{const Y="https://api.waule.com";return E.startsWith("data:")?E:E.startsWith("http")?E.replace(/^https?:\/\/localhost(?::\d+)?/i,Y):`${Y}${E}`}).forEach(E=>o.push(E));else{const d=(v=I.config)==null?void 0:v.selectedAsset;if(d){const E="https://api.waule.com",Y=X=>X.startsWith("http")?X.replace(/^https?:\/\/localhost(?::\d+)?/i,E):`${E}${X}`;d.type==="IMAGE"&&o.push(Y(d.url)),d.type==="DOCUMENT"&&a.push({name:d.originalName,url:Y(d.url)})}}}else w.type==="imagePreview"&&I.imageUrl&&o.push(I.imageUrl)}),M(o),T(a)},[we,Ce,ie]);const b=()=>{if(!Q)return null;const n=(Q.roles||[]).find(o=>o.id===Z);return n?{systemPrompt:n.systemPrompt,aiModelId:n.aiModelId,temperature:n.temperature,maxTokens:n.maxTokens}:null},l=async()=>{var o,a,c,w,I,D,B,v,p,d,E,Y,X,J;if(!Q){g.error("æ™ºèƒ½ä½“ä¿¡æ¯æœªåŠ è½½");return}if(!ee.trim()){g.error("è¯·è¾“å…¥ç”»é¢æè¿°");return}let n=(Q.roles||[]).find(F=>F.id===Z)||(Q.roles||[])[0];if(!n){g.error("è¯¥æ™ºèƒ½ä½“æ²¡æœ‰å¯ç”¨è§’è‰²");return}(!Z||Z!==n.id)&&(ge(n.id),r({roleId:n.id}));try{se(!0);const ae=De().filter(je=>je.target===u);let oe="";const le="https://api.waule.com",S=[],f=[],k=[];for(const je of ae){const Te=Ce(je.source);if(Te)if(Te.type==="upload"){const Re=((a=(o=Te.data)==null?void 0:o.config)==null?void 0:a.uploadedFiles)||[];for(const re of Re)if(re.type==="DOCUMENT")S.push({filePath:re.url,mimeType:re.mimeType}),oe+=`[æ–‡æ¡£æ–‡ä»¶: ${re.originalName}]
`;else if(re.type==="IMAGE"){const Be=re.url.startsWith("http")?re.url:`${le}${re.url}`;f.push(Be),oe+=`[å›¾ç‰‡æ–‡ä»¶: ${re.originalName}]
`}else if(re.type==="VIDEO"){const Be=re.url.startsWith("http")?re.url:`${le}${re.url}`;k.push(Be),oe+=`[è§†é¢‘æ–‡ä»¶: ${re.originalName}]
`}else re.type==="AUDIO"&&(oe+=`[éŸ³é¢‘æ–‡ä»¶: ${re.originalName}]
`)}else if(Te.type==="assetSelector"){const Re=(w=(c=Te.data)==null?void 0:c.config)==null?void 0:w.subjects;if(Re&&Re.length>0){const re=(Re[0].images||[]).map(Be=>Be.startsWith("http")?Be:`${le}${Be}`).map(Be=>Be.replace(/^https?:\/\/localhost(?::\d+)?/i,le));re.forEach(Be=>f.push(Be)),oe+=`[å‚è€ƒå›¾ç‰‡ç»„: ${re.length} å¼ ]
`}else{const re=(D=(I=Te.data)==null?void 0:I.config)==null?void 0:D.selectedAsset;if(re){if(re.type==="DOCUMENT")S.push({filePath:re.url,mimeType:re.mimeType}),oe+=`[æ–‡æ¡£æ–‡ä»¶: ${re.originalName}]
`;else if(re.type==="IMAGE"){let Be=re.url.startsWith("http")?re.url:`${le}${re.url}`;Be=Be.replace(/^https?:\/\/localhost(?::\d+)?/i,le),f.push(Be),oe+=`[å›¾ç‰‡æ–‡ä»¶: ${re.originalName}]
`}else if(re.type==="VIDEO"){let Be=re.url.startsWith("http")?re.url:`${le}${re.url}`;Be=Be.replace(/^https?:\/\/localhost(?::\d+)?/i,le),k.push(Be),oe+=`[è§†é¢‘æ–‡ä»¶: ${re.originalName}]
`}}}}else if(Te.type==="aiImage"){const Re=(v=(B=Te.data)==null?void 0:B.config)==null?void 0:v.generatedImageUrl;if(Re){const re=Re.startsWith("http")?Re:`${le}${Re}`;f.push(re),oe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`}}else if(Te.type==="imagePreview"){const Re=Te.data.imageUrl;Re&&(f.push(Re),oe+=`[AIç”Ÿæˆçš„å›¾ç‰‡]
`)}else if(Te.type==="videoPreview"){const Re=Te.data.videoUrl;if(Re){const re=Re.startsWith("http")?Re:`${le}${Re}`;k.push(re),oe+=`[AIç”Ÿæˆçš„è§†é¢‘]
`}}else Te.type==="textPreview"&&Te.data.content&&(oe+=Te.data.content+`

`)}const h=b();if(!h)return;let W=h.systemPrompt;oe&&(W+=`

ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${oe}`),W+=`

ç”¨æˆ·æŒ‡ä»¤ï¼š
${ee}`;const ue=await Me.ai.text.generate({modelId:n.aiModel.id||h.aiModelId,prompt:W,systemPrompt:n.systemPrompt||h.systemPrompt,temperature:n.temperature??h.temperature,maxTokens:n.maxTokens??h.maxTokens,documentFiles:S.length>0?S:void 0,imageUrls:f.length>0?f:void 0,videoUrls:k.length>0?k:void 0}),q=ue&&(((p=ue.data)==null?void 0:p.text)||(ue==null?void 0:ue.text))||"";if(!q||q.trim()===""){g.error("AIè¿”å›äº†ç©ºå†…å®¹ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®æˆ–é‡è¯•");return}r({generatedText:q});const be=De().filter(je=>je.source===u),Se=K(),ye=be.filter(je=>{const Te=Se.find(Re=>Re.id===je.target);return Te&&Te.type!=="textPreview"});if(ye.length>0)fe(je=>{const Te=new Set(ye.map(Re=>Re.target));return je.map(Re=>{var Be;if(!Te.has(Re.id))return Re;const re=((Be=Re.data)==null?void 0:Be.config)||{};return Re.type==="midjourney"?{...Re,data:{...Re.data,prompt:q}}:{...Re,data:{...Re.data,config:{...re,prompt:q}}}})});else{const je=Ce(u);if(je){const Te=Date.now(),Re=`text-preview-${u}-${Te}`,re=be.filter(ut=>{const Et=Se.find(nt=>nt.id===ut.target);return Et&&Et.type==="textPreview"}),Be=document.querySelector(`.react-flow__node[data-id="${u}"]`),qe=(Be==null?void 0:Be.getBoundingClientRect().width)||300,Ft=je.position.x+qe+100,at=je.position.y+re.length*700,ot={id:Re,type:"textPreview",position:{x:Ft,y:at},data:{label:"æ–‡æœ¬é¢„è§ˆ",title:"æç¤ºè¯",content:q,createdBy:(d=je.data)==null?void 0:d.createdBy}},Le={id:`edge-${u}-${Re}`,source:u,target:Re,type:"aurora"};fe(ut=>[...ut,ot]),setTimeout(()=>{ce(ut=>[...ut,Le])},50)}}const _e=(ue==null?void 0:ue.creditsCharged)||0;if(_e>0){const{useAuthStore:je}=await gs(async()=>{const{useAuthStore:Re}=await import("./index-Cp0uMTfX.js").then(re=>re.f);return{useAuthStore:Re}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:Te}=je.getState();await Te(),g.success(`æ‰§è¡ŒæˆåŠŸï¼ˆå·²æ‰£é™¤ ${_e} ç§¯åˆ†ï¼‰`)}else g.success("æ‰§è¡ŒæˆåŠŸ")}catch(F){const ae=((Y=(E=F==null?void 0:F.response)==null?void 0:E.data)==null?void 0:Y.message)||((J=(X=F==null?void 0:F.response)==null?void 0:X.data)==null?void 0:J.error)||(F==null?void 0:F.message)||"æœªçŸ¥é”™è¯¯";g.error("æ‰§è¡Œå¤±è´¥ï¼š"+ae)}finally{se(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"psychology"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:$?"LOADING...":((Q==null?void 0:Q.name)||s.label).toUpperCase()})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[Q&&(Q.roles||[]).length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²/é£æ ¼"}),e.jsx(rs,{value:Z,onChange:n=>ge(n),options:[...Q.roles||[]].sort((n,o)=>(n.order??0)-(o.order??0)).map(n=>({value:n.id,label:n.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æè¿°"}),e.jsx("textarea",{ref:Oe,value:ee,onChange:n=>{he.current=!0,de(n.target.value)},onMouseDown:n=>n.stopPropagation(),onTouchStart:n=>n.stopPropagation(),className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",placeholder:"è¾“å…¥æ‚¨å¯¹äºç”»é¢çš„åˆæ­¥æƒ³æ³•",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:l,disabled:ne||$||!Q||!ee.trim()||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg dark:hover:from-purple-500/60 dark:hover:to-pink-500/60 border-transparent dark:border-white/10",children:ne?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"}),e.jsx("span",{children:"æ‰§è¡Œä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-white/90",style:{fontSize:"12px"},dangerouslySetInnerHTML:{__html:"&#xe1e1;"}}),e.jsx("span",{children:"æ‰§è¡Œæ™ºèƒ½ä½“"}),!te&&(L?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",A,"æ¬¡"]}):j!==null&&j>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[j,"ç§¯åˆ†"]}):null)]})}),R.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ç‰‡ (",R.length,")"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:R.map((n,o)=>e.jsx("div",{className:"relative group",children:e.jsx("img",{src:n,alt:"ref",className:"w-full h-12 object-cover rounded-md border border-slate-200 dark:border-white/10 group-hover:border-purple-400 dark:group-hover:border-purple-400 transition-colors"})},o))})]}),P.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒæ–‡æ¡£ (",P.length,")"]}),e.jsx("div",{className:"space-y-1",children:P.map((n,o)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"description"}),e.jsx("span",{className:"truncate",title:n.name,children:n.name})]},o))})]})]}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ao=t.memo(ro),wr="https://api.waule.com",_s=400,oo=({data:s,id:C,selected:u})=>{const[Q,Ie]=t.useState(!1),[$,ve]=t.useState(0),[ee,de]=t.useState(s.config.uploadedFiles||[]),[Z,ge]=t.useState(null),[Oe,he]=t.useState(null);t.useEffect(()=>()=>{},[C]),t.useEffect(()=>{},[Z]),t.useEffect(()=>{},[Oe]);const[ne,se]=t.useState(null),fe=t.useRef(null),ce=t.useRef(null),Ce=t.useRef(null),[K,De]=t.useState(!1),[we,ie]=t.useState(0),[R,M]=t.useState(0),[P,T]=t.useState(!1),x=t.useRef(null),{setNodes:m,getNode:j,setEdges:te,getEdges:L}=ts(),A=t.useRef(!1);t.useEffect(()=>{s._currentUserId;const v=s.createdBy;if(typeof v=="object"&&(v==null||v.id),A.current)return;const p=s.config.uploadedFiles||[];!Q&&JSON.stringify(p)!==JSON.stringify(ee)&&(de(p),ge(null),he(null))},[s.config.uploadedFiles,Q,s._currentUserId,s.createdBy]);const O=()=>{x.current&&(x.current.paused?(x.current.play(),T(!0)):(x.current.pause(),T(!1)))},r=v=>{j(C)&&(A.current=!0,m(d=>d.map(E=>E.id===C?{...E,data:{...E.data,config:{...E.data.config,uploadedFiles:v}}}:E)))},b=async v=>{var d,E;if(!v||v.length===0)return;Ie(!0);const p=[];try{for(let Y=0;Y<v.length;Y++){const X=v[Y];if(!["image/png","image/jpeg","image/jpg","video/mp4","video/quicktime","video/avi","video/x-msvideo","audio/mpeg","audio/wav","audio/mp4","audio/x-m4a","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"].includes(X.type)){g.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${X.name}`);continue}const F=await Me.assets.upload(X,void 0,{onUploadProgress:ae=>{const oe=(ae==null?void 0:ae.total)||0,le=(ae==null?void 0:ae.loaded)||0;if(oe>0){const S=Math.round(le/oe*100);ve(S)}}});if(F.data){const ae=(F.data.type||"").toUpperCase(),oe=(F.data.mimeType||"").toLowerCase(),le=ae==="IMAGE"||ae==="VIDEO"||ae==="AUDIO"?ae:oe.startsWith("image/")?"IMAGE":oe.startsWith("video/")?"VIDEO":oe.startsWith("audio/")?"AUDIO":ae||"",S=F.data.url;p.push({id:F.data.id,name:F.data.name,originalName:F.data.originalName,type:le,mimeType:F.data.mimeType,size:F.data.size,url:S})}}if(p.length>0){let Y=[];const X=p[0].type;if(ne!==null)Y=[...ee],Y[ne]=p[0];else{const F={};for(const ae of ee)F[ae.id]=ae;for(const ae of p)F[ae.id]=ae;Y=Object.values(F)}if(j(C)){const F=L().filter(oe=>oe.source===C),ae=[];if(F.forEach(oe=>{var f;const le=j(oe.target);if(!le||le.type.startsWith("aiVideo"))return;const S=(f=le.data.config)==null?void 0:f.acceptedInputs;if(S&&S.length>0){const k=X.toUpperCase();S.map(W=>typeof W=="string"?W.toUpperCase():W).includes(k)||ae.push(oe.id)}}),ae.length>0){te(le=>le.filter(S=>!ae.includes(S.id)));const oe={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};g.warning(`å·²æ–­å¼€ ${ae.length} ä¸ªä¸å…¼å®¹çš„è¿æ¥ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸æ¥å—${oe[X]||X}ç±»å‹ï¼‰`)}}ge(null),he(null),de(Y),r(Y);try{const F=L().filter(oe=>oe.source===C);if(F.some(oe=>{const le=j(oe.target);return(le==null?void 0:le.type)==="aiVideo"})){const oe=localStorage.getItem("workflow:nodes"),le=oe?JSON.parse(oe):[],S=F.filter(k=>{var h;return((h=j(k.target))==null?void 0:h.type)==="aiVideo"}).map(k=>k.target),f=le.filter(k=>S.includes(k.id));f.length>0&&m(k=>k.map(h=>f.find(W=>W.id===h.id)?{...h,data:{...h.data,config:{...h.data.config,_updatedAt:Date.now()}}}:h))}}catch{}g.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")}}catch(Y){g.error(`ä¸Šä¼ å¤±è´¥: ${((E=(d=Y.response)==null?void 0:d.data)==null?void 0:E.message)||Y.message}`)}finally{Ie(!1),ve(0),fe.current&&(fe.current.value=""),se(null)}},l=()=>{m(v=>v.filter(p=>p.id!==C)),te(v=>v.filter(p=>p.source!==C&&p.target!==C)),g.success("èŠ‚ç‚¹å·²åˆ é™¤")},n=()=>{var v;se(0),(v=fe.current)==null||v.click()},o=v=>v<1024?v+" B":v<1024*1024?(v/1024).toFixed(2)+" KB":(v/(1024*1024)).toFixed(2)+" MB",a=v=>v.startsWith("image/")?{icon:"image",color:"text-tiffany-400"}:v.startsWith("video/")?{icon:"movie",color:"text-green-400"}:v.startsWith("audio/")?{icon:"audio_file",color:"text-blue-400"}:{icon:"description",color:"text-tiffany-400"};t.useEffect(()=>{if(ee.length>0){const v=ee[0],p=(v.url.startsWith("http")||v.url.startsWith("data:")?v.url:`${wr}${v.url}`).replace(".oss-oss-",".oss-");if(v.type==="IMAGE"){const d=new Image;d.onload=()=>{const E=d.width/d.height,Y=_s/E;ge({width:_s,height:Y})},d.onerror=E=>{ge({width:_s,height:_s*.75})},d.src=p}else if(v.type==="VIDEO"){const d=document.createElement("video");d.onloadedmetadata=()=>{const E=d.videoWidth/d.videoHeight,Y=_s/E;he({width:_s,height:Y})},d.onerror=E=>{he({width:_s,height:_s*.5625})},d.src=p}}},[ee]);const c=()=>{const v=ce.current;v&&(K?(v.pause(),De(!1)):(v.play(),De(!0)))};t.useEffect(()=>{const v=ce.current;if(!v)return;const p=()=>ie(v.duration||0),d=()=>M(v.duration?v.currentTime/v.duration:0),E=()=>De(!1);return v.addEventListener("loadedmetadata",p),v.addEventListener("timeupdate",d),v.addEventListener("ended",E),()=>{v.removeEventListener("loadedmetadata",p),v.removeEventListener("timeupdate",d),v.removeEventListener("ended",E)}},[ee]),t.useEffect(()=>{const v=ee[0];if(!v||v.type!=="AUDIO")return;const p=(v.url.startsWith("http")||v.url.startsWith("data:")?v.url:`${wr}${v.url}`).replace(".oss-oss-",".oss-"),d=(p.includes("aliyuncs.com"),p),E=Ce.current;if(!E)return;const Y=J=>{const F=E.getContext("2d");if(!F)return;const ae=E.width,oe=E.height;F.clearRect(0,0,ae,oe);const le=J.length,S=2,f=Math.max(1,Math.floor((ae-(le-1)*S)/le)),k=F.createLinearGradient(0,0,ae,0);k.addColorStop(0,"#a855f7"),k.addColorStop(.5,"#d946ef"),k.addColorStop(1,"#ec4899");for(let h=0;h<le;h++){const W=Math.min(1,Math.max(0,J[h])),ue=Math.max(2,Math.floor(W*oe)),q=h*(f+S),be=Math.floor((oe-ue)/2);F.fillStyle=k,F.fillRect(q,be,f,ue)}if(R>0){const h=Math.floor(ae*R);F.fillStyle="#ffffff88",F.fillRect(h,0,2,oe)}};(async()=>{try{let J;/https:\/\/.*aliyuncs\.com\//.test(d)?J=await Me.assets.proxyDownload(d):J=await(await fetch(d,{mode:"cors"})).arrayBuffer();const F=window.AudioContext||window.webkitAudioContext,le=(await new F().decodeAudioData(J)).getChannelData(0),S=120,f=Math.max(1,Math.floor(le.length/S)),k=new Float32Array(S);for(let h=0;h<S;h++){let W=0,ue=0;const q=h*f,be=Math.min(le.length,q+f);for(let Se=q;Se<be;Se++)W+=Math.abs(le[Se]),ue++;k[h]=ue?W/ue:0}Y(k)}catch{const F=new Float32Array(120);for(let ae=0;ae<120;ae++)F[ae]=(Math.sin(ae/5)+1)/2;Y(F)}})()},[ee,R]);const w=v=>{if(!v||!isFinite(v))return"0:00";const p=Math.floor(v/60),d=Math.floor(v%60);return`${p}:${d.toString().padStart(2,"0")}`},I=[{type:"image",formats:["PNG","JPG","JPEG"],icon:"image",color:"tiffany"},{type:"video",formats:["MP4","MOV"],icon:"movie",color:"green"},{type:"audio",formats:["MP3","WAV"],icon:"audio_file",color:"blue"},{type:"document",formats:["PDF","DOCX","XLSX","TXT"],icon:"description",color:"tiffany"}],D=ee[0],B=D?(D.url.startsWith("http")||D.url.startsWith("data:")?D.url:`${wr}${D.url}`).replace(".oss-oss-",".oss-"):"";return D&&D.type==="IMAGE"&&Z?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:B,alt:"",className:"w-full object-cover",draggable:!1,style:{width:_s,height:Z.height,pointerEvents:"none"}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:v=>b(v.target.files),className:"hidden"})]}):D&&D.type==="VIDEO"&&Oe?e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:_s},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${P?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:v=>{v.stopPropagation(),O()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:P?"pause":"play_arrow"})})}),e.jsx("video",{ref:x,src:B,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:_s,height:Oe.height},onEnded:()=>T(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:v=>b(v.target.files),className:"hidden"})]}):D&&D.type==="AUDIO"?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:c,className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:K?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:w(we)})]}),e.jsx("div",{className:"",children:e.jsx("canvas",{ref:Ce,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ce,src:B,className:"hidden"}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})})]}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:v=>b(v.target.files),className:"hidden"})]}):D&&D.type==="DOCUMENT"?e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:"material-symbols-outlined text-red-400 text-6xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"picture_as_pdf"}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:D.originalName,children:D.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:o(D.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:n,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°ä¸Šä¼ ",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"upload"})})}),e.jsx("input",{ref:fe,type:"file",accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:v=>b(v.target.files),className:"hidden"})]}):e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"upload_file"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:fe,type:"file",multiple:!0,accept:".png,.jpg,.jpeg,.mp4,.mov,.mp3,.wav,.pdf,.docx,.xlsx,.txt",onChange:v=>b(v.target.files),className:"hidden"}),e.jsx("div",{onClick:()=>{var v;s._canEdit!==!1&&((v=fe.current)==null||v.click())},onDragOver:v=>{v.preventDefault(),v.stopPropagation()},onDrop:v=>{v.preventDefault(),v.stopPropagation(),s._canEdit!==!1&&b(v.dataTransfer.files)},className:`nodrag w-full p-6 bg-slate-100 dark:bg-white/5 border-2 border-dashed border-slate-300 dark:border-white/20 rounded-xl cursor-pointer hover:border-purple-400 dark:hover:border-purple-400/50 transition-colors ${Q||s._canEdit===!1?"opacity-50 pointer-events-none":""}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-400 dark:text-white/50 text-4xl mb-2 block",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:Q?"hourglass_empty":"cloud_upload"}),e.jsx("p",{className:"text-sm text-slate-800 dark:text-white font-medium mb-1",children:Q?`ä¸Šä¼ ä¸­... ${$}%`:"ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶"}),Q&&e.jsx("div",{className:"w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all",style:{width:`${$}%`}})}),e.jsx("p",{className:"text-xs text-slate-400 dark:text-white/50",children:"æ”¯æŒå¤šç§æ ¼å¼ï¼Œæœ€å¤§100MB"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ”¯æŒçš„æ ¼å¼"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:I.map(v=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`material-symbols-outlined text-${v.color}-400 text-sm`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:v.icon}),e.jsx("span",{className:"text-slate-600 dark:text-slate-400 text-[10px]",children:v.formats.join(", ")})]},v.type))})]}),ee.length>0&&e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[e.jsxs("p",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å·²ä¸Šä¼  (",ee.length,")"]}),ee.map(v=>{const{icon:p,color:d}=a(v.mimeType);return e.jsxs("div",{className:"nodrag flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md hover:bg-slate-200 dark:hover:bg-white/10 transition-colors",children:[e.jsx("span",{className:`material-symbols-outlined ${d} text-base flex-shrink-0`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:p}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-800 dark:text-white truncate",title:v.originalName,children:v.originalName}),e.jsx("p",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:o(v.size)})]}),e.jsx("button",{onClick:l,className:"nodrag p-1 hover:bg-red-500/20 rounded flex-shrink-0 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 dark:text-red-400 text-base",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},v.id)})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},no=t.memo(oo),Mr="https://api.waule.com",Ms=320,io=({data:s,id:C,selected:u})=>{const[Q,Ie]=t.useState(s.config.selectedInput||s.config.selectedAsset||null),[$,ve]=t.useState([]),{setNodes:ee,getNode:de}=ts(),[Z,ge]=t.useState(null),[Oe,he]=t.useState(null),ne=t.useRef(null),se=t.useRef(null),[fe,ce]=t.useState(!1),[Ce,K]=t.useState(0),[De,we]=t.useState(0),ie=t.useRef(null),[R,M]=t.useState(!1),[P,T]=t.useState(!1),x=t.useRef(null),m=()=>{x.current&&(x.current.paused?(x.current.play(),T(!0)):(x.current.pause(),T(!1)))},j=t.useRef(!1);t.useEffect(()=>{const l=s._currentUserId,n=s.createdBy,o=typeof n=="object"?n==null?void 0:n.id:n;if(l&&o&&l===o&&j.current)return;const a=s.config.selectedInput||s.config.selectedAsset||null;if(!a)return;const c=Q;(()=>{if(!c)return!1;const I=c.images&&!c.type,D=a.images&&!a.type;if(I&&D){const B=c.images||[],v=a.images||[];if(B.length!==v.length)return!1;for(let p=0;p<B.length;p++)if(B[p].id!==v[p].id||B[p].url!==v[p].url)return!1;return!0}if(c.id&&a.id)return c.id===a.id&&c.url===a.url&&c.type===a.type;try{return JSON.stringify(c)===JSON.stringify(a)}catch{return!1}})()||Ie(a)},[s.config.selectedInput,s.config.selectedAsset,s._currentUserId,s.createdBy]),t.useEffect(()=>{var n,o,a;if(Q&&Q.images&&!Q.type){const c=Q,w=(a=(o=(n=de(C))==null?void 0:n.data)==null?void 0:o.config)==null?void 0:a.referenceImages;Array.isArray(w)&&w.length>0?ve(w.map(I=>({id:I.id,url:I.url,name:I.name}))):ve(c.images||[])}else ve([])},[Q,de,C]);const te=l=>{const n=de(C);n&&(j.current=!0,ee(o=>o.map(a=>a.id===C?{...a,data:{...a.data,config:{...a.data.config,...l}}}:a)),Ie((l==null?void 0:l.selectedInput)??(l==null?void 0:l.selectedAsset)??n.data.config.selectedInput??n.data.config.selectedAsset))},L=l=>/^https?:\/\//.test(l)||l.startsWith("data:"),A=l=>!l||l.startsWith("data:")?l:/^https?:\/\/localhost(?::\d+)?\//i.test(l)?l.replace(/^https?:\/\/localhost(?::\d+)?/i,Mr):L(l)?l:`${Mr}${l}`;t.useEffect(()=>{var v,p,d,E,Y,X,J,F,ae;if(!(Q&&Q.images&&!Q.type))return;const n=Q,o=$.length?$:n.images||[];if(o.length===1){const oe=o[0],le={id:oe.id,name:oe.name,originalName:oe.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:oe.url};te({selectedInput:le,selectedAsset:le,subjects:void 0,referenceImages:void 0,roleIds:void 0});return}const a=[{name:n.name,images:o.map(oe=>A(oe.url))}],c=o.map(oe=>({id:oe.id,url:oe.url,name:oe.name})),w=[n.id],I=(d=(p=(v=de(C))==null?void 0:v.data)==null?void 0:p.config)==null?void 0:d.subjects,D=(X=(Y=(E=de(C))==null?void 0:E.data)==null?void 0:Y.config)==null?void 0:X.referenceImages,B=(ae=(F=(J=de(C))==null?void 0:J.data)==null?void 0:F.config)==null?void 0:ae.roleIds;(JSON.stringify(I)!==JSON.stringify(a)||JSON.stringify(D)!==JSON.stringify(c)||JSON.stringify(B)!==JSON.stringify(w))&&te({subjects:a,referenceImages:c,roleIds:w})},[$]);const O=l=>{if(!(Q&&Q.images&&!Q.type))return;const o=Q,a=[...$];if(l<0||l>=a.length)return;if(a.splice(l,1),ve(a),g.success("å·²åˆ é™¤å‚è€ƒå›¾"),a.length===0){Ie(null),te({selectedInput:void 0,selectedAsset:void 0,subjects:void 0,referenceImages:void 0,roleIds:void 0}),g.info("å·²æ¸…ç©ºè§’è‰²å›¾ç‰‡");return}if(a.length===1){const B=a[0],v={id:B.id,name:B.name,originalName:B.name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:B.url};Ie(v),te({selectedInput:v,selectedAsset:v,subjects:void 0,referenceImages:void 0,roleIds:void 0}),g.success("å·²åˆ‡æ¢ä¸ºå•å¼ å›¾ç‰‡è¾“å‡º");return}const c={id:o.id,name:o.name,coverUrl:A(a[0].url),images:a};Ie(c);const w=[{name:c.name,images:a.map(B=>A(B.url))}],I=a.map(B=>({id:B.id,url:B.url,name:B.name})),D=[c.id];te({selectedInput:c,subjects:w,referenceImages:I,roleIds:D}),g.success("å·²æ›´æ–°å›¾ç‰‡ç»„")},r=()=>{s._canEdit!==!1&&s.onOpenAssetPanel&&s.onOpenAssetPanel(C)};t.useEffect(()=>{if(Q&&Q.type){const l=Q;if(l.type==="IMAGE"){const n=new Image;n.onload=()=>{const o=n.width/n.height,a=Ms/o;ge({width:Ms,height:a})},n.src=A(l.url)}else if(l.type==="VIDEO"){const n=document.createElement("video");n.onloadedmetadata=()=>{const o=n.videoWidth/n.videoHeight,a=Ms/o;he({width:Ms,height:a})},n.src=A(l.url)}}},[Q]),t.useEffect(()=>{if(!(Q&&Q.type==="AUDIO")){M(!1);return}const o=A(Q.url),a=ne.current,c=se.current;if(!a||!c)return;a.src=o,we(0),M(!1);const w=()=>K(a.duration||0),I=()=>we(a.duration?a.currentTime/a.duration:0),D=()=>ce(!1);return a.addEventListener("loadedmetadata",w),a.addEventListener("timeupdate",I),a.addEventListener("ended",D),(async()=>{try{const p=await(await fetch(o,{mode:"cors"})).arrayBuffer(),d=window.AudioContext||window.webkitAudioContext,X=(await new d().decodeAudioData(p)).getChannelData(0),J=120,F=Math.max(1,Math.floor(X.length/J)),ae=new Float32Array(J);for(let oe=0;oe<J;oe++){let le=0,S=0;const f=oe*F,k=Math.min(X.length,f+F);for(let h=f;h<k;h++)le+=Math.abs(X[h]),S++;ae[oe]=S?le/S:0}ie.current=ae,M(!0)}catch{const p=new Float32Array(120);for(let d=0;d<120;d++)p[d]=(Math.sin(d/5)+1)/2;ie.current=p,M(!0)}})(),()=>{a.removeEventListener("loadedmetadata",w),a.removeEventListener("timeupdate",I),a.removeEventListener("ended",D)}},[Q]),t.useEffect(()=>{if(!(Q&&Q.type==="AUDIO")||!R)return;const n=se.current,o=ie.current;if(!n||!o)return;const a=n.getContext("2d");if(!a)return;const c=n.width,w=n.height;a.clearRect(0,0,c,w);const I=o.length,D=2,B=Math.max(1,Math.floor((c-(I-1)*D)/I)),v=a.createLinearGradient(0,0,c,0);v.addColorStop(0,"#a855f7"),v.addColorStop(.5,"#d946ef"),v.addColorStop(1,"#ec4899");for(let p=0;p<I;p++){const d=Math.min(1,Math.max(0,o[p])),E=Math.max(2,Math.floor(d*w)),Y=p*(B+D),X=Math.floor((w-E)/2);a.fillStyle=v,a.fillRect(Y,X,B,E)}if(De>0){const p=Math.floor(c*De);a.fillStyle="#ffffff88",a.fillRect(p,0,2,w)}},[Q,De,R]);const b=l=>l<1024?l+" B":l<1024*1024?(l/1024).toFixed(2)+" KB":(l/(1024*1024)).toFixed(2)+" MB";if(Q){if(Q.images&&!Q.type){const a=Q;return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group flex flex-col gap-4",children:[e.jsx("div",{className:"nodrag nopan w-full overflow-hidden rounded-xl border-2 border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 relative",style:{height:Ms*.5625},children:$[0]?e.jsxs(e.Fragment,{children:[e.jsx("img",{draggable:!1,onDragStart:c=>c.preventDefault(),src:A($[0].url),alt:a.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:c=>{c.preventDefault(),c.stopPropagation(),c.nativeEvent&&typeof c.nativeEvent.stopImmediatePropagation=="function"&&c.nativeEvent.stopImmediatePropagation(),O(0)},onClick:c=>{c.preventDefault(),c.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"delete"})})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"person"})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"text-slate-800 dark:text-white font-bold mb-2",children:a.name}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:$.slice(1).map((c,w)=>e.jsxs("div",{className:"nodrag nopan w-20 h-20 rounded border-2 border-slate-200 dark:border-white/10 overflow-hidden relative pointer-events-auto",children:[e.jsx("img",{draggable:!1,onDragStart:I=>I.preventDefault(),src:A(c.url),alt:c.name,className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onPointerDown:I=>{I.preventDefault(),I.stopPropagation(),I.nativeEvent&&typeof I.nativeEvent.stopImmediatePropagation=="function"&&I.nativeEvent.stopImmediatePropagation(),O(w+1)},onClick:I=>{I.preventDefault(),I.stopPropagation()},style:{pointerEvents:"auto"},className:"nodrag absolute z-[10002] top-0.5 right-0.5 w-5 h-5 flex items-center justify-center bg-red-500/80 hover:bg-red-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md pointer-events-auto",children:e.jsx("span",{className:"material-symbols-outlined text-xs",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]},c.id))}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]})]})}const n=Q,o=A(n.url);if(n.type==="IMAGE"&&Z)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:o,alt:n.name,className:"w-full object-cover",style:{width:Ms,height:Z.height}}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(n.type==="VIDEO"&&Oe)return e.jsxs("div",{className:`relative border rounded-2xl overflow-hidden shadow-lg transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${P?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:a=>{a.stopPropagation(),m()},children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:P?"pause":"play_arrow"})})}),e.jsx("video",{ref:x,src:o,playsInline:!0,className:"w-full object-cover rounded-2xl",draggable:!1,style:{width:Ms,height:Oe.height},onEnded:()=>T(!1)}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})]});if(n.type==="AUDIO")return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-center text-slate-800 dark:text-white truncate",children:n.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{const a=ne.current;a&&(fe?(a.pause(),ce(!1)):(a.play(),ce(!0)))},className:"nodrag w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg flex items-center justify-center transition-all shadow-md active:scale-95",children:e.jsx("span",{className:"material-symbols-outlined text-white text-lg",style:{fontVariationSettings:'"FILL" 1, "wght" 400'},children:fe?"pause":"play_arrow"})}),e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:(()=>{const a=Ce;if(!a||!isFinite(a))return"0:00";const c=Math.floor(a/60),w=Math.floor(a%60);return`${c}:${w.toString().padStart(2,"0")}`})()})]}),e.jsx("div",{children:e.jsx("canvas",{ref:se,width:360,height:90,className:"w-full"})}),e.jsx("audio",{ref:ne,src:o,className:"hidden"})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]});if(n.type==="DOCUMENT"){const a=I=>I.includes("pdf")?{icon:"picture_as_pdf",color:"text-red-400"}:I.includes("word")?{icon:"description",color:"text-blue-400"}:I.includes("excel")||I.includes("spreadsheet")?{icon:"table_chart",color:"text-green-400"}:{icon:"insert_drive_file",color:"text-gray-400"},{icon:c,color:w}=a(n.mimeType);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-4 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:400},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("span",{className:`material-symbols-outlined ${w} text-6xl`,style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:c}),e.jsx("p",{className:"text-slate-800 dark:text-white text-sm text-center px-2",title:n.originalName,children:n.originalName}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-xs",children:b(n.size)})]}),e.jsx("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10",children:e.jsx("button",{onClick:r,className:"w-7 h-7 flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"é‡æ–°é€‰æ‹©",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"swap_horiz"})})})]})}}return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-lg transition-all p-6 ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:Ms},children:[e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-6xl text-slate-400 dark:text-white/50",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"photo_library"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-800 dark:text-white mb-1",children:"èµ„äº§é€‰æ‹©å™¨"}),e.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"ä»èµ„äº§åº“é€‰æ‹©ç´ æ"})]}),e.jsxs("button",{onClick:r,className:"nodrag w-full px-4 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg text-white rounded-md transition-all flex items-center justify-center gap-2 font-medium active:scale-95",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"folder_open"}),e.jsx("span",{children:"é€‰æ‹©ç´ æ"})]})]})]})},lo=t.memo(io),co=({data:s,id:C})=>{var n;const{setNodes:u,setEdges:Q,getNodes:Ie}=ts(),$=kr(o=>o.refreshUser),[ve,ee]=t.useState(!1),[de,Z]=t.useState([]),[ge,Oe]=t.useState(""),[he,ne]=t.useState("ALL"),[se,fe]=t.useState(""),[ce,Ce]=t.useState(!1),K=s.width||400,[De,we]=t.useState(null);t.useEffect(()=>{ve&&(O(),setTimeout(()=>{r()},100))},[ve]);const ie=t.useRef(null),R=t.useRef(!1);t.useEffect(()=>{const o=s.pendingButtonAction;if(o){try{const w=localStorage.getItem("suppressedPreviewTasks")||"[]",I=JSON.parse(w),D=localStorage.getItem("createdPreviewTasks")||"[]",B=JSON.parse(D),v=I.some(Y=>Y.taskId&&Y.taskId===o.newTaskId||Y.sourceNodeId&&Y.sourceNodeId===o.sourceNodeId),d=Ie().some(Y=>{var X,J,F,ae;return Y.type==="imagePreview"&&((J=(X=Y.data)==null?void 0:X.midjourneyData)==null?void 0:J.sourceNodeId)===o.sourceNodeId&&((ae=(F=Y.data)==null?void 0:F.midjourneyData)==null?void 0:ae.taskId)===o.newTaskId}),E=B.some(Y=>Y.taskId&&Y.taskId===o.newTaskId);if(v||E&&d){we(null),u(Y=>Y.map(X=>X.id===o.sourceNodeId?{...X,data:{...X.data,pendingButtonAction:void 0}}:X));return}}catch{}if(R.current)return;if(R.current=!0,Ie().some(w=>{var I,D,B,v;return w.type==="imagePreview"&&((D=(I=w.data)==null?void 0:I.midjourneyData)==null?void 0:D.sourceNodeId)===o.sourceNodeId&&((v=(B=w.data)==null?void 0:B.midjourneyData)==null?void 0:v.taskId)===o.newTaskId})){we(null),u(w=>w.map(I=>I.id===o.sourceNodeId?{...I,data:{...I.data,pendingButtonAction:void 0}}:I)),R.current=!1;return}we(o.buttonCustomId),M(o.newTaskId,o.buttonLabel,o.sourceNodeId)}return()=>{R.current=!1,ie.current&&(clearTimeout(ie.current),ie.current=null)}},[]);const M=async(o,a,c)=>{const w=c||C;let I=0;const D=150,B=2e3;R.current=!0;const v=/^[UV]\d$/.test(a)||a.includes("Vary")||a.includes("Upscale")&&a!=="Upscale"||a.includes("Zoom")||a.includes("Pan")||a.includes("Make")||a.includes("Remaster"),p=async()=>{var d,E,Y,X,J,F,ae,oe;if(R.current)try{const le=await Me.midjourney.fetchTask(o);if(!R.current)return;const S=le.task;if(S.status==="SUCCESS"){if(v&&s.imageUrl&&((d=s.midjourneyData)!=null&&d.messageId)){const at=S.imageUrl===s.imageUrl,ot=((E=S.properties)==null?void 0:E.messageId)===((Y=s.midjourneyData)==null?void 0:Y.messageId);if(at&&ot){I++;try{const Le=localStorage.getItem("createdPreviewTasks")||"[]";if(JSON.parse(Le).some(nt=>{var yt;return nt.taskId&&nt.taskId===o||nt.messageId&&nt.messageId===((yt=S.properties)==null?void 0:yt.messageId)})){we(null),u(nt=>nt.map(yt=>yt.id===w?{...yt,data:{...yt.data,pendingButtonAction:void 0}}:yt));return}}catch{}I<D?ie.current=setTimeout(p,B):(g.error(`${a} å¤±è´¥ï¼šæœåŠ¡å™¨é‡å¯åæ— æ³•è·å–æ–°å›¾ç‰‡`),we(null),u(Le=>Le.map(ut=>ut.id===w?{...ut,data:{...ut.data,pendingButtonAction:void 0}}:ut)));return}}if(g.success(`${a} å®Œæˆï¼`),we(null),u(at=>at.map(ot=>ot.id===w?{...ot,data:{...ot.data,pendingButtonAction:void 0}}:ot)),Ie().find(at=>{var ot,Le,ut,Et,nt;return at.type==="imagePreview"&&((ot=at.data.midjourneyData)==null?void 0:ot.sourceNodeId)===w&&(((Le=at.data.midjourneyData)==null?void 0:Le.taskId)===o||((ut=S.properties)==null?void 0:ut.messageId)&&((Et=at.data.midjourneyData)==null?void 0:Et.messageId)===((nt=S.properties)==null?void 0:nt.messageId))})){g.info("ä»»åŠ¡å·²å®Œæˆï¼Œé¢„è§ˆèŠ‚ç‚¹å·²å­˜åœ¨");return}const h=Ie().find(at=>at.id===w);if(!h)return;if(!S.imageUrl){g.error("æ— æ³•åˆ›å»ºé¢„è§ˆèŠ‚ç‚¹ï¼šç¼ºå°‘å›¾ç‰‡URL");return}const W=200,ue=100,q=s.width||400,Se=((at,ot=300)=>{if(!at||!/^[0-9]+\s*:\s*[0-9]+$/.test(at))return ot;const[Le,ut]=at.split(":").map(Et=>parseFloat(Et));return!Le||!ut?ot:Math.round(q*(ut/Le))})(s.ratio,300),ye=document.querySelector(`.react-flow__node[data-id="${h.id}"]`),_e=Math.round((ye==null?void 0:ye.getBoundingClientRect().width)||((X=h.data)==null?void 0:X.width)||400),je=Ie().filter(at=>{var ot,Le;return at.type==="imagePreview"&&((Le=(ot=at.data)==null?void 0:ot.midjourneyData)==null?void 0:Le.sourceNodeId)===w}),Te=h.position.x+_e+W,Re=h.position.y,re=Te,Be=Re+je.length*(Se+ue),qe=`preview-${Date.now()}`,Ft={id:qe,type:"imagePreview",position:{x:re,y:Be},data:{imageUrl:S.imageUrl,width:q,height:Se,ratio:s.ratio,workflowContext:s.workflowContext,createdBy:(J=h.data)==null?void 0:J.createdBy,midjourneyData:{taskId:o,messageId:(F=S.properties)==null?void 0:F.messageId,messageHash:(ae=S.properties)==null?void 0:ae.messageHash,sourceNodeId:w,buttons:S.buttons,action:S.action}}};u(at=>[...at,Ft]),Q(at=>{const ot={id:`${w}-${qe}`,source:w,target:qe,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};return[...at,ot]}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{const ot=Ie().find(Le=>Le.id===qe)})});try{const at=localStorage.getItem("createdPreviewTasks")||"[]",Le=[...JSON.parse(at),{taskId:o,messageId:(oe=S.properties)==null?void 0:oe.messageId}].slice(-500);localStorage.setItem("createdPreviewTasks",JSON.stringify(Le))}catch{}g.success(`å·²åˆ›å»º${a}é¢„è§ˆèŠ‚ç‚¹`);return}if(S.status==="FAILURE"){g.error(`${a} å¤±è´¥: ${S.failReason||"æœªçŸ¥é”™è¯¯"}`),we(null),u(f=>f.map(k=>k.id===w?{...k,data:{...k.data,pendingButtonAction:void 0}}:k));return}if(S.status==="NOT_FOUND"){if(Ie().some(h=>{var W,ue,q,be;return h.type==="imagePreview"&&((ue=(W=h.data)==null?void 0:W.midjourneyData)==null?void 0:ue.sourceNodeId)===w&&((be=(q=h.data)==null?void 0:q.midjourneyData)==null?void 0:be.taskId)===o})){we(null),u(h=>h.map(W=>W.id===w?{...W,data:{...W.data,pendingButtonAction:void 0}}:W));return}g.error(`${a} ä»»åŠ¡ä¸å­˜åœ¨`),we(null),u(h=>h.map(W=>W.id===w?{...W,data:{...W.data,pendingButtonAction:void 0}}:W));return}I++,I<D?ie.current=setTimeout(p,B):(g.error(`${a} è¶…æ—¶`),we(null),u(f=>f.map(k=>k.id===C?{...k,data:{...k.data,pendingButtonAction:void 0}}:k)))}catch(le){g.error(`${a} å¤±è´¥: ${le.message}`),we(null),u(S=>S.map(f=>f.id===C?{...f,data:{...f.data,pendingButtonAction:void 0}}:f))}};p()},P=()=>{try{const o=localStorage.getItem("midjourneyButtonConfig");if(o)return JSON.parse(o)}catch{}return{}},T=o=>{const a=P();if(Object.keys(a).length===0)return!0;const c=o.label.replace(/\s+/g,"_");return a.hasOwnProperty(c)?a[c]===!0:!0},x=o=>{if(!o)return"";let a=o.trim();return/^upscale_\d+\s/i.test(a)&&(a=a.replace(/^upscale_\d+\s+/i,"")),a},m=(((n=s.midjourneyData)==null?void 0:n.buttons)||[]).map(o=>String(o.label||"").toLowerCase()),j=m.some(o=>/^[uv][1-4]$/i.test(o)),te=m.some(o=>o.includes("redo")),L=!j&&!te&&m.some(o=>o.includes("upscale")),A=o=>{const a=String(o.label||""),c=a.toLowerCase(),w=String(o.customId||"").toLowerCase(),I=/ğŸ‘|â¤ï¸|â¤/.test(a);return c.includes("animate")||c.includes("web")||w.includes("web")||c.includes("browser")||c.includes("open in web")||c.includes("open web")||c.includes("like")||w.includes("like")||I?!1:j?/^U[1-4]$/i.test(a):L?c.includes("upscale"):!1};t.useEffect(()=>{ve&&(O(),r())},[ve]);const O=async()=>{try{const o=he==="ALL"?void 0:{category:he},c=(await Me.assetLibraries.getAll(o)).data||[];if(Z(c),c.length>0){const w=c.find(I=>I.id===ge);Oe(w?w.id:c[0].id)}else Oe("")}catch{g.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},r=()=>{const o=window.__workflowContext;if(!o||!o.project||!o.nodeGroups){g.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const a=Ws(C,o.nodeGroups);if(!a&&o.nodeGroups.length>0){const w=o.nodeGroups[0],I=Ts({project:o.project,episode:o.episode,nodeGroup:w,assetType:"image"});I?(fe(I),g.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${I}`)):g.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const c=Ts({project:o.project,episode:o.episode,nodeGroup:a,assetType:"image"});c?(fe(c),g.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${c}`)):g.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},b=async()=>{var o,a;if(!ge){g.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!se.trim()){g.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{Ce(!0),await Me.assetLibraries.addFromUrl(ge,s.imageUrl,se.trim());const c=window.__workflowContext;if(c&&c.project&&c.nodeGroups){const w=Ws(C,c.nodeGroups)||c.nodeGroups[0];w&&Ts({project:c.project,episode:c.episode,nodeGroup:w,nodeId:C,assetType:"image",preview:!1})}g.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ee(!1),fe("");try{u(w=>w.map(I=>I.id===C?{...I,data:{...I.data,addedToLibrary:!0}}:I))}catch{}try{const w=new CustomEvent("asset-library-updated",{detail:{libraryId:ge}});window.dispatchEvent(w)}catch{}}catch(c){g.error(((a=(o=c.response)==null?void 0:o.data)==null?void 0:a.message)||"æ·»åŠ å¤±è´¥")}finally{Ce(!1)}},l=async()=>{var o;try{const a=s.imageUrl;let c=`image-${Date.now()}.jpg`;const w=window.__workflowContext;if(w&&w.project&&w.nodeGroups){const d=Ws(C,w.nodeGroups)||w.nodeGroups[0];if(d){const E=Ts({project:w.project,episode:w.episode,nodeGroup:d,nodeId:C,assetType:"image",preview:!0});if(E&&(c=E,!c.includes("."))){const Y=((o=a.match(/\.(jpg|jpeg|png|gif|webp)$/i))==null?void 0:o[0])||".jpg";c+=Y}}}g.info("æ­£åœ¨ä¸‹è½½å›¾ç‰‡...");const I=`/assets/proxy-download-with-name?url=${encodeURIComponent(a)}&filename=${encodeURIComponent(c)}`,D=await Me.get(I,{responseType:"blob"}),B=D instanceof Blob?D:D==null?void 0:D.data;if(!B||!(B instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const v=window.URL.createObjectURL(B),p=document.createElement("a");p.href=v,p.download=c,document.body.appendChild(p),p.click(),document.body.removeChild(p),setTimeout(()=>{window.URL.revokeObjectURL(v)},100),g.success(`å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼š${c}`)}catch(a){g.error(`æ“ä½œå¤±è´¥: ${a instanceof Error?a.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,isConnectable:!1,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),(()=>{const a=(s.midjourneyData?(s.midjourneyData.buttons||[]).filter(c=>T(c)&&A(c)):[]).length>0;return e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 shadow-xl overflow-hidden",style:{width:K,borderRadius:a?"12px 12px 0 0":"12px"},children:[e.jsx("img",{src:s.imageUrl,alt:"é¢„è§ˆ",className:"block w-full h-auto",style:{backgroundColor:"#000"}}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{ee(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"add_photo_alternate"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:l,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½å›¾ç‰‡",children:e.jsx("span",{className:"material-symbols-outlined text-sm",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"download"})})]})]})})(),s.midjourneyData&&(()=>{const o=(s.midjourneyData.buttons||[]).filter(a=>T(a)&&A(a));return o.length===0?null:e.jsxs("div",{className:"nodrag bg-white/80 dark:bg-black/60 backdrop-blur-xl border-2 border-t-0 border-slate-200 dark:border-white/10 rounded-b-xl p-3 space-y-2 shadow-lg",style:{width:K},children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"Midjourney æ“ä½œ"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:o.map((a,c)=>{var p;const w=x(a.label),I=((p=s.clickedButtons)==null?void 0:p.includes(a.label))||!1,D=De===a.customId,B=s._canEdit===!1,v=De!==null&&De!==a.customId||I||B;return e.jsx("button",{onClick:async()=>{var d,E,Y,X,J,F;if(!((d=s.midjourneyData)!=null&&d.taskId)){g.error("ç¼ºå°‘ä»»åŠ¡ID");return}if(I){g.warning("è¯¥æŒ‰é’®å·²è¢«ç‚¹å‡»è¿‡");return}we(a.customId);try{g.info(`æ­£åœ¨æ‰§è¡Œ ${a.label}...`);const ae=await Me.midjourney.action({taskId:s.midjourneyData.taskId,customId:a.customId,messageId:s.midjourneyData.messageId,nodeId:C,mode:s.midjourneyData.mode||"relax"});if(!ae.success){g.error(ae.description||"æ“ä½œå¤±è´¥"),we(null);return}const oe=ae.taskId;if(ae.creditsCharged&&ae.creditsCharged>0&&$(),!oe){g.error("æœªæ”¶åˆ°æ–°ä»»åŠ¡ID"),we(null);return}u(le=>le.map(S=>S.id===C?{...S,data:{...S.data,pendingButtonAction:{buttonLabel:a.label,buttonCustomId:a.customId,newTaskId:oe,sourceNodeId:C},clickedButtons:[...S.data.clickedButtons||[],a.label]}}:S)),g.info(`${w} å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†...`),M(oe,w)}catch(ae){if(((E=ae.response)==null?void 0:E.status)===429)g.warning(((X=(Y=ae.response)==null?void 0:Y.data)==null?void 0:X.error)||"æ¯ä½ç”¨æˆ·åªå…è®¸åŒæ—¶æ‰§è¡Œä¸€ä¸ªMidjourneyä»»åŠ¡");else{const oe=((F=(J=ae.response)==null?void 0:J.data)==null?void 0:F.error)||ae.message;g.error(oe)}we(null)}},disabled:v,className:`
                        px-3 py-1.5 text-[10px] font-bold rounded-md transition-all border
                        ${I?"bg-slate-400 dark:bg-slate-600 cursor-not-allowed opacity-50 text-white border-transparent":D?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 cursor-wait text-white border-transparent shadow-md":De!==null?"bg-slate-300 dark:bg-slate-700 cursor-not-allowed opacity-50 text-white border-transparent":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg active:scale-95 text-white border-transparent dark:border-white/10"}
                      `,title:I?`${w} (å·²ç‚¹å‡»)`:w,children:e.jsxs("span",{className:"flex items-center gap-1",children:[D&&e.jsx(Qs,{className:"w-3 h-3 animate-spin"}),a.emoji&&!/^upscale_\d+$/i.test(a.emoji)&&e.jsx("span",{children:a.emoji}),w,I&&e.jsx("span",{className:"ml-1",children:"âœ“"})]})},c)})})]})})(),ve&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ee(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:se,onChange:o=>fe(o.target.value),onMouseDown:o=>o.stopPropagation(),onTouchStart:o=>o.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const o=he==="ALL"?de:de.filter(a=>(a.category||"OTHER")===he);return o.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:he==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:ge,onChange:a=>Oe(a.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:o.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a._count.assets," ä¸ªèµ„äº§)"]},a.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(o=>e.jsx("button",{type:"button",onClick:()=>{ne(o);const a=de.filter(c=>(c.category||"OTHER")===o);Oe(a.length>0?a[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${he===o?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:o==="ROLE"?"person":o==="SCENE"?"landscape":o==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:o==="ROLE"?"è§’è‰²åº“":o==="SCENE"?"åœºæ™¯åº“":o==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},o))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ee(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:b,disabled:ce||de.length===0||!se.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:ce?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},uo=t.memo(co),po=({data:s,id:C})=>{var te;const u="https://api.waule.com",[Q,Ie]=t.useState(!1),[$,ve]=t.useState([]),[ee,de]=t.useState(""),[Z,ge]=t.useState("ALL"),[Oe,he]=t.useState(""),[ne,se]=t.useState(!1),{setNodes:fe}=ts(),[ce]=t.useState(s.width||400),[Ce,K]=t.useState(null),[De,we]=t.useState(!1),ie=t.useRef(null),R=Pr(),M=!!((te=s==null?void 0:s.workflowContext)!=null&&te.episode)||R.pathname.includes("/episodes/");t.useEffect(()=>{Q&&(T(),setTimeout(()=>{x()},100))},[Q]),t.useEffect(()=>{const L=ie.current;if(!L)return;const A=()=>{const l=L.videoWidth||0,n=L.videoHeight||0;if(l>0&&n>0){const o=l/n;K(Math.round(ce/o))}},O=()=>we(!0),r=()=>we(!1),b=()=>we(!1);return L.addEventListener("loadedmetadata",A),L.addEventListener("play",O),L.addEventListener("pause",r),L.addEventListener("ended",b),()=>{L.removeEventListener("loadedmetadata",A),L.removeEventListener("play",O),L.removeEventListener("pause",r),L.removeEventListener("ended",b)}},[ce,s.videoUrl]);const P=L=>{L.stopPropagation();const A=ie.current;A&&(A.paused?A.play():A.pause())};t.useEffect(()=>{try{const L=localStorage.getItem("suppressedPreviewTasks")||"[]",A=JSON.parse(L),O=s==null?void 0:s.pendingButtonAction;if(O&&A.some(b=>b.taskId&&b.taskId===O.newTaskId||b.sourceNodeId&&b.sourceNodeId===O.sourceNodeId)){Ie(!1);return}}catch{}},[]);const T=async()=>{try{const L=await Me.assetLibraries.getAll();ve(L.data),L.data.length>0&&de(L.data[0].id)}catch{g.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},x=()=>{const L=window.__workflowContext;if(!L||!L.project||!L.nodeGroups){g.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const A=Ws(C,L.nodeGroups);if(!A&&L.nodeGroups.length>0){const r=L.nodeGroups[0],b=Ts({project:L.project,episode:L.episode,nodeGroup:r,assetType:"video"});b?(he(b),g.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${b}`)):g.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const O=Ts({project:L.project,episode:L.episode,nodeGroup:A,assetType:"video"});O?(he(O),g.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${O}`)):g.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°")},m=async()=>{var L,A;if(!ee){g.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!Oe.trim()){g.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{se(!0),await Me.assetLibraries.addFromUrl(ee,s.videoUrl,Oe.trim());const O=window.__workflowContext;if(O&&O.project&&O.nodeGroups){const r=Ws(C,O.nodeGroups)||O.nodeGroups[0];r&&Ts({project:O.project,episode:O.episode,nodeGroup:r,nodeId:C,assetType:"video",preview:!1})}g.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),Ie(!1),he("");try{fe(r=>r.map(b=>b.id===C?{...b,data:{...b.data,addedToLibrary:!0}}:b))}catch{}try{const r=new CustomEvent("asset-library-updated",{detail:{libraryId:ee}});window.dispatchEvent(r)}catch{}}catch(O){g.error(((A=(L=O.response)==null?void 0:L.data)==null?void 0:A.message)||"æ·»åŠ å¤±è´¥")}finally{se(!1)}},j=async()=>{var L;try{const A=s.videoUrl;let O=`video-${Date.now()}.mp4`;const r=window.__workflowContext;if(r&&r.project&&r.nodeGroups){const c=Ws(C,r.nodeGroups)||r.nodeGroups[0];if(c){const w=Ts({project:r.project,episode:r.episode,nodeGroup:c,nodeId:C,assetType:"video",preview:!0});if(w&&(O=w,!O.includes("."))){const I=((L=A.match(/\.(mp4|mov|avi|webm)$/i))==null?void 0:L[0])||".mp4";O+=I}}}g.info("æ­£åœ¨ä¸‹è½½è§†é¢‘...");const b=`/assets/proxy-download-with-name?url=${encodeURIComponent(A)}&filename=${encodeURIComponent(O)}`,l=await Me.get(b,{responseType:"blob"}),n=l instanceof Blob?l:l==null?void 0:l.data;if(!n||!(n instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const o=window.URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=O,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>{window.URL.revokeObjectURL(o)},100),g.success(`è§†é¢‘ä¸‹è½½æˆåŠŸï¼š${O}`)}catch(A){g.error(`æ“ä½œå¤±è´¥: ${A instanceof Error?A.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:ce},children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 z-10 cursor-move flex items-center justify-center",children:e.jsx("button",{className:`nodrag w-16 h-16 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-all backdrop-blur-sm ${De?"opacity-0 hover:opacity-100":"opacity-100"}`,onClick:P,children:e.jsx("span",{className:"material-symbols-outlined text-4xl",style:{fontVariationSettings:'"FILL" 1'},children:De?"pause":"play_arrow"})})}),e.jsx("video",{ref:ie,src:s.videoUrl&&(s.videoUrl.startsWith("http")||s.videoUrl.startsWith("data:"))?s.videoUrl:`${u}${s.videoUrl}`,className:"nodrag block w-full h-auto",style:{width:"100%",height:Ce?`${Ce}px`:"auto",objectFit:"cover"},playsInline:!0}),s.resolution&&e.jsx("div",{className:"absolute top-2 right-2 px-2 py-0.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90 rounded text-[10px] font-bold text-white shadow-lg backdrop-blur-sm z-10",children:s.resolution}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 z-10 opacity-0 group-hover:opacity-100 transition-opacity",children:[M&&e.jsxs("button",{onClick:async()=>{var L,A;try{const O=s.videoUrl,r=s.workflowContext||{},b=r.episode,l=(()=>{try{const J=new URLSearchParams(window.location.search);return{scene:Number(J.get("scene")),shot:Number(J.get("shot"))}}catch{return{scene:void 0,shot:void 0}}})(),n=r.nodeGroup||Ws(C,r.nodeGroups||[]),o=(n==null?void 0:n.scene)??l.scene,a=(n==null?void 0:n.shot)??l.shot,c=(()=>{try{const J=R.pathname.split("/").filter(Boolean),F=J.indexOf("projects"),ae=J.indexOf("episodes"),oe=F>=0?J[F+1]:void 0,le=ae>=0?J[ae+1]:void 0;return{pid:oe,eid:le}}catch{return{pid:void 0,eid:void 0}}})(),w=((L=r.project)==null?void 0:L.id)||(b==null?void 0:b.projectId)||c.pid,I=(b==null?void 0:b.id)||c.eid;if(!w||!I||!o||!a){g.error("ç¼ºå°‘å‰§é›†æˆ–ç¼–ç»„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å†™å›åˆ†é•œ");return}const D=await Me.episodes.getById(w,I),B=(D==null?void 0:D.data)??D,v=(B==null?void 0:B.data)??B,p=Array.isArray((A=v==null?void 0:v.scriptJson)==null?void 0:A.acts)?[...v.scriptJson.acts]:[];let d=p.find(J=>Number(J.actIndex)===Number(o));d||(d={actIndex:Number(o),shots:[]},p.push(d)),d.shots=Array.isArray(d.shots)?[...d.shots]:[];let E=d.shots.find(J=>Number(J.shotIndex)===Number(a));E||(E={shotIndex:Number(a),mediaList:[]},d.shots.push(E));const Y=Array.isArray(E.mediaList)?E.mediaList.slice():[];if(Y.length>=4){g.error("è¯¥åˆ†é•œå·²è¾¾åˆ°4ä¸ªè§†é¢‘ä¸Šé™");return}Y.push({type:"video",url:O,nodeId:C}),E.mediaList=Y;const X={...v.scriptJson||{},acts:p};await Me.episodes.update(w,I,{scriptJson:X});try{fe(J=>J.map(F=>F.id===C?{...F,data:{...F.data,addedToStoryboard:!0}}:F))}catch{}g.success("å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬")}catch(O){g.error((O==null?void 0:O.message)||"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬å¤±è´¥")}},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToStoryboard?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToStoryboard?"å·²æ·»åŠ åˆ°åˆ†é•œè„šæœ¬":"æ·»åŠ åˆ°åˆ†é•œè„šæœ¬",disabled:s==null?void 0:s.addedToStoryboard,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"playlist_add"}),(s==null?void 0:s.addedToStoryboard)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsxs("button",{onClick:()=>{Ie(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"video_library"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:j,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½è§†é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),Q&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl",onClick:L=>L.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>Ie(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:Oe,onChange:L=>he(L.target.value),onMouseDown:L=>L.stopPropagation(),onTouchStart:L=>L.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const L=Z==="ALL"?$:$.filter(A=>(A.category||"OTHER")===Z);return L.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Z==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:ee,onChange:A=>de(A.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:L.map(A=>e.jsxs("option",{value:A.id,children:[A.name," (",A._count.assets," ä¸ªèµ„äº§)"]},A.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(L=>e.jsx("button",{type:"button",onClick:()=>{ge(L);const A=$.filter(O=>(O.category||"OTHER")===L);de(A.length>0?A[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Z===L?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:L==="ROLE"?"person":L==="SCENE"?"landscape":L==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:L==="ROLE"?"è§’è‰²åº“":L==="SCENE"?"åœºæ™¯åº“":L==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},L))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>Ie(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:m,disabled:ne||$.length===0||!Oe.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:ne?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`})]})},fo=t.memo(po),go=({data:s,id:C,selected:u})=>{const{getNodes:Q,getEdges:Ie,setEdges:$,setNodes:ve,getNode:ee}=ts(),[de,Z]=t.useState(s.content||""),ge=t.useRef(null),Oe=t.useRef(null),he=t.useRef(null),ne=t.useRef(null);t.useEffect(()=>{const P=j=>{j.stopPropagation()},T=Oe.current,x=he.current;T&&T.addEventListener("wheel",P,{passive:!0}),x&&x.addEventListener("wheel",P,{passive:!0});const m=ne.current;return m&&m.addEventListener("wheel",P,{passive:!0}),()=>{T&&T.removeEventListener("wheel",P),x&&x.removeEventListener("wheel",P),m&&m.removeEventListener("wheel",P)}},[]);const se=t.useRef(null),fe=async P=>{var T,x;try{const m=(s==null?void 0:s.workflowContext)||{},j=m.episode,te=m.nodeGroup||Array.isArray(m.nodeGroups)&&m.nodeGroups.find(I=>(I.nodeIds||[]).includes(C))||null;let L=te==null?void 0:te.scene,A=te==null?void 0:te.shot;try{const I=new URLSearchParams(window.location.search),D=Number(I.get("scene")),B=Number(I.get("shot"));Number.isFinite(D)&&D>0&&(L=L??D),Number.isFinite(B)&&B>0&&(A=A??B)}catch{}const O=((T=m.project)==null?void 0:T.id)||(j==null?void 0:j.projectId),r=j==null?void 0:j.id;if(!O||!r||!L||!A)return;const b=await Me.episodes.getById(O,r),l=(b==null?void 0:b.data)??b,n=(l==null?void 0:l.data)??l,o=Array.isArray((x=n==null?void 0:n.scriptJson)==null?void 0:x.acts)?[...n.scriptJson.acts]:[];let a=o.find(I=>Number(I.actIndex)===Number(L));a||(a={actIndex:Number(L),shots:[]},o.push(a)),a.shots=Array.isArray(a.shots)?[...a.shots]:[];let c=a.shots.find(I=>Number(I.shotIndex)===Number(A));c||(c={shotIndex:Number(A)},a.shots.push(c)),Object.keys(P).forEach(I=>{c[I]=P[I]||""});const w={...n.scriptJson||{},acts:o};await Me.episodes.update(O,r,{scriptJson:w})}catch(m){g.error((m==null?void 0:m.message)||"ä¿å­˜å¤±è´¥")}},ce=()=>{var P,T,x;try{const m=Q(),j=Ie(),te=m.find(l=>l.id===C),L=j.filter(l=>l.source===C).map(l=>l.target),A=m.filter(l=>l.type==="agent");let O="";const r=A.find(l=>L.includes(l.id));if(r)O=r.id;else if(te&&A.length>0)O=((T=(P=A.map(n=>{var o,a,c,w;return{a:n,dx:(((o=n.position)==null?void 0:o.x)??0)-(((a=te.position)==null?void 0:a.x)??0),dy:Math.abs((((c=n.position)==null?void 0:c.y)??0)-(((w=te.position)==null?void 0:w.y)??0))}}).sort((n,o)=>(n.dx>=0&&o.dx>=0,n.dx-o.dx||n.dy-o.dy))[0])==null?void 0:P.a)==null?void 0:T.id)||A[0].id;else{const l=m.findIndex(n=>n.id===C);O=((x=m[l+1])==null?void 0:x.id)||""}if(!O)return;$(l=>l.some(o=>o.source===C&&o.target===O)?l:[...l,{id:`e-${Date.now()}`,source:C,target:O}]);const b=de||String((s==null?void 0:s.content)||"");ve(l=>l.map(n=>{if(n.id!==O)return n;const o=n.data||{};return n.type==="agent"?{...n,data:{...o,config:{...o.config||{},prompt:b}}}:n.type==="midjourney"?{...n,data:{...o,prompt:b}}:n.type==="aiImage"?{...n,data:{...o,config:{...o.config||{},prompt:b}}}:n.type==="textPreview"?{...n,data:{...o,content:b}}:{...n,data:{...o,config:{...o.config||{},prompt:b}}}}))}catch{}},Ce=(s.title||"")==="åˆ†é•œè®¾è®¡",K=(s.title||"")==="æç¤ºè¯",De=(()=>{if(!Ce)return[];const P=String(s.content||""),T=P.split(/\r?\n/).map(A=>A.trim()),x=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),m=[];let j=null;for(const A of T){if(!A)continue;const O=A.match(/^(.+?)[ï¼š:]\s*(.*)$/);if(O&&x.has(O[1])){j&&m.push(j),j={label:O[1],content:O[2]||""};continue}if(x.has(A)){j&&m.push(j),j={label:A,content:""};continue}j?j.content=j.content?`${j.content}
${A}`:A:j={label:"æ–‡æœ¬",content:A}}if(j&&m.push(j),m.length===0)return[{label:"æ–‡æœ¬",content:P}];const te=["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿","æ–‡æœ¬"],L=new Map(te.map((A,O)=>[A,O]));return m.filter(A=>A.content&&A.content.trim().length>0).sort((A,O)=>(L.get(A.label)??999)-(L.get(O.label)??999))})(),[we,ie]=t.useState(De),R=t.useRef(null),M=t.useRef([]);return t.useEffect(()=>{ie(De)},[s.content,Ce]),t.useEffect(()=>{requestAnimationFrame(()=>{M.current.forEach(P=>{P&&(P.style.height="auto",P.style.height=`${P.scrollHeight}px`)})})},[we]),t.useEffect(()=>{K&&Z(s.content||"")},[s.content,K]),e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:340},children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"assignment"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.title||"åˆ†é•œè®¾è®¡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsx("div",{className:"px-3 pb-3",children:Ce?e.jsx("div",{ref:he,className:"space-y-2 nowheel",children:we.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-white/60",children:"æš‚æ— å†…å®¹"}):we.map((P,T)=>e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 dark:text-white/90 mb-1",children:P.label}),e.jsx("textarea",{value:P.content,onChange:x=>{const m=x.target.value;x.target.style.height="auto",x.target.style.height=`${x.target.scrollHeight}px`,ie(j=>{const te=j.map((O,r)=>r===T?{...O,content:m}:O),L=te.map(O=>`${O.label}ï¼š${O.content}`).join(`
`);return ee(C)&&ve(O=>O.map(r=>r.id===C?{...r,data:{...r.data,content:L}}:r)),R.current&&(clearTimeout(R.current),R.current=null),R.current=window.setTimeout(async()=>{const O=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),r={};te.forEach(b=>{O.has(b.label)&&(r[b.label]=b.content)}),await fe(r)},600),te})},onBlur:async x=>{const m=new Set(["ç”»é¢","æ™¯åˆ«/é•œå¤´","å†…å®¹/åŠ¨ä½œ","å£°éŸ³/å¯¹è¯","æ—¶é•¿"]),j={};j[P.label]=x.currentTarget.value,m.has(P.label)&&await fe(j)},onMouseDown:x=>x.stopPropagation(),onTouchStart:x=>x.stopPropagation(),ref:x=>{M.current[T]=x,x&&(x.style.height="auto",x.style.height=`${x.scrollHeight}px`,x.style.overflow="hidden",x.style.wordBreak="break-word")},className:"nodrag w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap leading-snug focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors",placeholder:`å¡«å†™${P.label}...`})]},`sec-${T}`))}):K?e.jsxs("div",{ref:Oe,className:"flex flex-col pt-2 nowheel",children:[e.jsx("textarea",{value:de,onChange:P=>{const T=P.target.value;Z(T);const x=440;P.target.style.height="auto";const m=Math.min(P.target.scrollHeight,x);P.target.style.height=`${m}px`,P.target.style.overflowY=P.target.scrollHeight>x?"auto":"hidden",ee(C)&&ve(te=>te.map(L=>L.id===C?{...L,data:{...L.data,content:T}}:L)),se.current&&(clearTimeout(se.current),se.current=null),se.current=window.setTimeout(async()=>{await fe({æç¤ºè¯:T})},600)},onBlur:async P=>{const T=P.currentTarget.value;await fe({æç¤ºè¯:T})},onMouseDown:P=>P.stopPropagation(),onTouchStart:P=>P.stopPropagation(),ref:P=>{if(ge.current=P,P){P.style.wordBreak="break-word",P.style.height="auto";const x=Math.min(P.scrollHeight,440);P.style.height=`${x}px`,P.style.overflowY=P.scrollHeight>440?"auto":"hidden"}},className:"nodrag nowheel w-full bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-lg text-slate-800 dark:text-white text-sm p-2 resize-none whitespace-pre-wrap break-words focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors scrollbar-hide",style:{minHeight:"60px",maxHeight:"440px"},placeholder:"è¾“å…¥æç¤ºè¯..."}),e.jsx("button",{onClick:ce,onPointerDown:P=>P.stopPropagation(),onMouseDown:P=>P.stopPropagation(),disabled:!de.trim(),className:"nodrag relative w-full mt-2 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 hover:shadow-lg disabled:from-gray-600 disabled:to-gray-700 disabled:opacity-50 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all overflow-hidden flex-shrink-0",children:e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"send"}),e.jsx("span",{children:"å‘é€"})]})})]}):e.jsx("div",{ref:ne,className:"text-sm text-slate-800 dark:text-white whitespace-pre-wrap nowheel overflow-y-auto scrollbar-hide",style:{maxHeight:"calc(540px - 48px)"},children:s.content||"æš‚æ— å†…å®¹"})}),!s.noHandles&&e.jsx(vt,{type:"target",position:dt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),!s.noHandles&&e.jsx(vt,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},ho=t.memo(go),mo=({data:s,selected:C,id:u})=>{const{setNodes:Q,setEdges:Ie,getNode:$,getNodes:ve,getEdges:ee,getViewport:de}=ts(),Z=Fs(),ge=Ds(),[Oe]=t.useState(s.isExpanded??!0),[he,ne]=t.useState(s.prompt||""),[se,fe]=t.useState(s.ratio||"16:9"),[ce,Ce]=t.useState(s.mode||"relax"),[K,De]=t.useState(s.chaos??0),[we,ie]=t.useState(s.stylize??100),[R,M]=t.useState(s.weird??0),[P,T]=t.useState(s.quality??1),[x,m]=t.useState(s.styleRaw??!1),[j,te]=t.useState(s.omniWeight??100),[L,A]=t.useState(s.styleWeight??100),[,O]=t.useState(s.taskId||""),[r,b]=t.useState(s.status||"idle"),[l,n]=t.useState(s.progress||""),[o,a]=t.useState(s.omniReferenceImages||[]),[c,w]=t.useState(s.styleReferenceImages||[]),[I,D]=t.useState(!0);t.useEffect(()=>{(async()=>{var h;try{const W=await Me.midjourney.getSettings();D(((h=W.settings)==null?void 0:h.fastEnabled)??!0)}catch{}})()},[]);const{credits:B,isFreeUsage:v,freeUsageRemaining:p,refetch:d}=Ls({moduleType:"midjourney",operationType:"imagine",mode:ce}),E=t.useRef(null),Y=t.useRef(!1),X=t.useRef(()=>{});t.useEffect(()=>{typeof s.prompt=="string"&&s.prompt!==he&&ne(s.prompt)},[s.prompt]);const J=k=>{Q(h=>h.map(W=>W.id===u?{...W,data:{...W.data,...k}}:W))};t.useEffect(()=>{const k=s.taskId,h=s.status;(async()=>{var ue,q;if(k&&(h==="processing"||h==="submitting"))try{const Se=(await Me.midjourney.fetchTask(k)).task;if(Se.status==="SUCCESS"){const ye=Se.imageUrl||"",_e=((ue=Se.properties)==null?void 0:ue.messageId)||"",je=((q=Se.properties)==null?void 0:q.messageHash)||"",Te=s.ratio||"16:9";if(b("idle"),n(""),J({status:"idle",progress:"",taskId:""}),ve().find(Be=>{var qe,Ft,at;return Be.type==="imagePreview"&&((qe=Be.data.midjourneyData)==null?void 0:qe.sourceNodeId)===u&&(((Ft=Be.data.midjourneyData)==null?void 0:Ft.taskId)===k||_e&&((at=Be.data.midjourneyData)==null?void 0:at.messageId)===_e)})){g.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}g.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),le(ye,"4å®«æ ¼",Te,{taskId:k,messageId:_e,messageHash:je,mode:s.mode||"relax",buttons:Se.buttons,action:Se.action})}else Se.status==="IN_PROGRESS"||Se.status==="SUBMITTED"?(b("processing"),setTimeout(()=>{X.current(k)},100)):Se.status==="FAILURE"?(b("error"),n(""),J({status:"error",progress:"",taskId:""}),g.error(Se.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Se.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•")):Se.status==="NOT_FOUND"&&(b("idle"),n(""),J({status:"idle",progress:"",taskId:""}))}catch{b("idle"),n(""),J({status:"idle",progress:"",taskId:""}),g.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°ç”Ÿæˆ")}})()},[]);const F=t.useCallback(()=>{const k=Z.filter(ye=>ye.target===u),h=[],W=[];let ue="";k.forEach(ye=>{var je,Te,Re,re,Be,qe,Ft,at;const _e=$(ye.source);if(_e){const ot=_e.data,Le=ye.targetHandle||"omni-ref";if(Le==="text-input"){if(_e.type==="agent"){const ut=((je=ot.config)==null?void 0:je.generatedText)||"";ut&&typeof ut=="string"&&(ue=ut)}}else{let ut=ot.imageUrl||"";if(!ut&&((Te=ot.config)!=null&&Te.selectedAsset)){const Et=ot.config.selectedAsset;Et.type==="IMAGE"&&(ut=`https://api.waule.com${Et.url}`.replace(".oss-oss-",".oss-"))}if(!ut&&((Re=ot.config)!=null&&Re.generatedImageUrl)&&(ut=ot.config.generatedImageUrl),_e.type==="assetSelector"){const Et="https://api.waule.com",nt=tt=>{let _t=tt||"";return _t&&(!_t.startsWith("http")&&!_t.startsWith("data:")&&(_t=`${Et}${_t}`),_t=_t.replace(".oss-oss-",".oss-"),_t.replace(/^https?:\/\/localhost(?::\d+)?/i,Et))},yt=(re=ot.config)==null?void 0:re.subjects,Ot=(Be=ot.config)==null?void 0:Be.referenceImages;if(Le==="omni-ref"){let tt="";yt&&yt.length>0&&yt[0].images&&yt[0].images.length>0?tt=nt(yt[0].images[0]):Ot&&Ot.length>0?tt=nt(Ot[0].url):(qe=ot.config)!=null&&qe.selectedAsset&&ot.config.selectedAsset.type==="IMAGE"&&(tt=nt(ot.config.selectedAsset.url)),tt&&!h.includes(tt)&&h.length<1&&h.push(tt)}else if(Le==="style-ref"){let tt="";yt&&yt.length>0&&yt[0].images&&yt[0].images.length>0?tt=nt(yt[0].images[0]):Ot&&Ot.length>0?tt=nt(Ot[0].url):(Ft=ot.config)!=null&&Ft.selectedAsset&&ot.config.selectedAsset.type==="IMAGE"&&(tt=nt(ot.config.selectedAsset.url)),tt&&!W.includes(tt)&&W.length<1&&W.push(tt)}}if(_e.type==="upload"){const Et="https://api.waule.com",nt=tt=>{let _t=tt||"";return _t&&(!_t.startsWith("http")&&!_t.startsWith("data:")&&(_t=`${Et}${_t}`),_t=_t.replace(".oss-oss-",".oss-"),_t.replace(/^https?:\/\/localhost(?::\d+)?/i,Et))},Ot=(((at=ot.config)==null?void 0:at.uploadedFiles)||[]).find(tt=>tt.type==="IMAGE"||(tt.mimeType||"").startsWith("image/"));if(Ot){const tt=nt(Ot.url);Le==="omni-ref"?tt&&!h.includes(tt)&&h.length<1&&h.push(tt):Le==="style-ref"&&tt&&!W.includes(tt)&&W.length<1&&W.push(tt)}}ut&&(Le==="omni-ref"&&!h.includes(ut)?h.push(ut):Le==="style-ref"&&!W.includes(ut)&&W.push(ut))}}}),ue&&ue!==he&&!Y.current&&(ne(ue),J({prompt:ue}));const q=ye=>{if(!ye||typeof ye!="string")return!1;const _e=ye.trim();return _e?!!(_e.startsWith("data:image/")||/^https?:\/\//.test(_e)||_e.startsWith("/")):!1},be=h.filter(q).slice(0,1),Se=W.filter(q).slice(0,1);JSON.stringify(be)!==JSON.stringify(o)&&(a(be),J({omniReferenceImages:be})),JSON.stringify(Se)!==JSON.stringify(c)&&(w(Se),J({styleReferenceImages:Se}))},[Z,u,$,ge,he,Y.current]);t.useEffect(()=>{F()},[F]),t.useEffect(()=>{const k=E.current;k&&Oe&&requestAnimationFrame(()=>{k.style.height="auto";const h=Math.max(60,Math.min(k.scrollHeight,600));k.style.height=`${h}px`})},[he,Oe]);const ae=k=>{try{const h=new URL(k),W=new URLSearchParams(h.search);return W.has("width")||W.has("height")?(W.delete("width"),W.delete("height"),h.search=W.toString(),h.toString()):k}catch{return k}},oe=k=>{const[W,ue]=k.split(":").map(Number);if(!W||!ue)return{width:512,height:512};const q=W/ue;return q>=1?{width:512,height:Math.round(512/q)}:{width:Math.round(512*q),height:512}},le=t.useCallback((k,h,W,ue)=>{const q=$(u);if(!q)return;const be=h.startsWith("U")?ae(k):k,Se=ve(),ye=ee();if(Se.filter(tt=>tt.type==="imagePreview"&&ye.some(_t=>_t.source===u&&_t.target===tt.id)).find(tt=>tt.data.imageUrl===be))return;const Te=400,Re=200,re=100,Be=tt=>{const _t=de().zoom||1,Kt=document.querySelector(`.react-flow__node[data-id="${tt.id}"]`),bs=(Kt==null?void 0:Kt.getBoundingClientRect().width)||tt.data&&tt.data.width||400,cs=(Kt==null?void 0:Kt.getBoundingClientRect().height)||tt.data&&tt.data.height||300,Rs=Math.round(bs/_t),ws=Math.round(cs/_t);return{w:Rs,h:ws}},qe=(tt,_t=300)=>{if(!tt||!/^[0-9]+\s*:\s*[0-9]+$/.test(tt))return _t;const[Kt,bs]=tt.split(":").map(cs=>parseFloat(cs));return!Kt||!bs?_t:Math.round(Te*(bs/Kt))},Ft=Be(q),at=qe(W,300),ot=q.position.x+Ft.w+Re,Le=q.position.y,ut=ve().filter(tt=>{var _t,Kt;return tt.type==="imagePreview"&&((Kt=(_t=tt.data)==null?void 0:_t.midjourneyData)==null?void 0:Kt.sourceNodeId)===u}).length,Et=ot,nt=Le+ut*(at+re),yt=`preview-${Date.now()}`,Ot={id:yt,type:"imagePreview",position:{x:Et,y:nt},data:{imageUrl:be,width:Te,ratio:W,workflowContext:q.data.workflowContext,createdBy:q.data.createdBy,midjourneyData:ue?{taskId:ue.taskId,messageId:ue.messageId,messageHash:ue.messageHash,sourceNodeId:u,mode:ue.mode,buttons:ue.buttons,action:ue.action}:void 0}};Q(tt=>[...tt,Ot]),Ie(tt=>[...tt,{id:`${u}-${yt}`,source:u,target:yt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}}]),g.success(`âœ¨ å·²åˆ›å»º${h}é¢„è§ˆèŠ‚ç‚¹`)},[u,$,ve,ee,Q,Ie,ae,oe]),S=t.useCallback(async()=>{var k,h,W,ue,q,be,Se,ye,_e,je,Te,Re;if(!he.trim()){g.error("è¯·å…ˆè¾“å…¥åˆ›ä½œæè¿°~");return}b("submitting"),n(""),J({status:"submitting",progress:""});try{const re=["--ar","--v","--version","--fast","--relax","--turbo","--style","--chaos","--c","--stylize","--s","--weird","--w","--quality","--q","--no","--seed"],Be=he.toLowerCase(),qe=re.find(nt=>Be.includes(nt));if(qe){g.error(`æ£€æµ‹åˆ°å‚æ•° "${qe}"ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹çš„é…ç½®é€‰é¡¹æ¥è®¾ç½®`,{duration:4e3}),b("idle"),J({status:"idle",progress:"",taskId:""});return}b("submitting");let Ft=he;try{g.info("æ­£åœ¨æ™ºèƒ½ç¿»è¯‘ä¸­...");const nt=await Me.translation.smartTranslate({text:he});nt.success&&(Ft=nt.translatedText,nt.needsTranslation&&g.success("âœ¨ å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡",{duration:3e3}))}catch{g.warning("ç¿»è¯‘æš‚ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åŸå§‹æè¿°",{duration:3e3})}g.info("ğŸ¨ æ­£åœ¨æäº¤åˆ›ä½œä»»åŠ¡...");let at=Ft.trim();if(se&&se!=="1:1"&&!at.includes("--ar")&&(at+=` --ar ${se}`),!at.includes("--v")&&!at.includes("--version")&&(at+=" --v 7.0"),ce==="fast"&&!at.includes("--fast")?at+=" --fast":ce==="relax"&&!at.includes("--relax")&&(at+=" --relax"),K>0&&(at+=` --chaos ${K}`),we!==100&&(at+=` --stylize ${we}`),R>0&&(at+=` --weird ${R}`),P!==1&&(at+=` --quality ${P}`),x&&(at+=" --style raw"),o.length>0){g.info(`æ­£åœ¨ä¸Šä¼  ${o.length} å¼ å‚è€ƒå›¾...`);const nt=[];for(let yt=0;yt<o.length;yt++){const Ot=o[yt];try{const tt=await Me.midjourney.uploadReferenceImage({imageUrl:Ot});if(tt.success&&tt.discordUrl)nt.push(tt.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{g.error(`å‚è€ƒå›¾ ${yt+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),b("idle");return}}at+=` --oref ${nt.join(" ")}`,j!==100&&(at+=` --ow ${j}`),g.success("âœ… å‚è€ƒå›¾ä¸Šä¼ å®Œæˆ")}if(c.length>0){g.info(`æ­£åœ¨ä¸Šä¼  ${c.length} å¼ é£æ ¼å›¾...`);const nt=[];for(let yt=0;yt<c.length;yt++){const Ot=c[yt];try{const tt=await Me.midjourney.uploadReferenceImage({imageUrl:Ot});if(tt.success&&tt.discordUrl)nt.push(tt.discordUrl);else throw new Error("ä¸Šä¼ å¤±è´¥ï¼šæœªè¿”å› Discord URL")}catch{g.error(`é£æ ¼å›¾ ${yt+1} ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼`),b("idle");return}}at+=` --sref ${nt.join(" ")}`,L!==100&&(at+=` --sw ${L}`),g.success("âœ… é£æ ¼å›¾ä¸Šä¼ å®Œæˆ")}const ot=await Me.midjourney.imagine({prompt:at,nodeId:u,mode:ce});if(!ot.success)throw new Error(ot.description||"ä»»åŠ¡æäº¤å¤±è´¥");const Le=ot.taskId;O(Le),b("processing"),J({taskId:Le,status:"processing",progress:"",prompt:he,ratio:se,mode:ce,chaos:K,stylize:we,weird:R,quality:P,styleRaw:x,omniWeight:j,styleWeight:L});const ut=ot.isFreeUsage,Et=ot.creditsCharged||0;if(ut)g.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${p} æ¬¡æœºä¼š`),d();else if(Et>0){const{useAuthStore:nt}=await gs(async()=>{const{useAuthStore:Ot}=await import("./index-Cp0uMTfX.js").then(tt=>tt.f);return{useAuthStore:Ot}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:yt}=nt.getState();await yt(),g.success(`ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œæ¶ˆè€— ${Et} ç§¯åˆ†`),d()}else g.success("ğŸ¨ åˆ›ä½œå·²å¼€å§‹ï¼Œè¯·ç¨å€™...");X.current(Le)}catch(re){if(b("error"),n(""),J({status:"error",progress:"",taskId:""}),((k=re.response)==null?void 0:k.status)===403){const Ft=((W=(h=re.response)==null?void 0:h.data)==null?void 0:W.error)||"å½“å‰è´¦æˆ·æš‚æ—  Midjourney åŠŸèƒ½æƒé™";g.error(Ft);return}if(((ue=re.response)==null?void 0:ue.status)===429){g.warning(((be=(q=re.response)==null?void 0:q.data)==null?void 0:be.error)||"æ‚¨å·²æœ‰ä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•");return}const Be=((ye=(Se=re.response)==null?void 0:Se.data)==null?void 0:ye.description)||((je=(_e=re.response)==null?void 0:_e.data)==null?void 0:je.error)||re.message,qe=(Re=(Te=re.response)==null?void 0:Te.data)==null?void 0:Re.bannedWord;qe?g.error(`æ£€æµ‹åˆ°æ•æ„Ÿè¯ "${qe}"ï¼Œè¯·ä¿®æ”¹æè¿°`,{duration:5e3}):g.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${Be}ï¼Œè¯·ç¨åé‡è¯•`)}},[he,se,ce,K,we,R,P,x,o,j,c,L,J,v,p,d]),f=t.useCallback(async k=>{let h=0;const W=150,ue=2e3,q=async()=>{var be,Se,ye,_e;try{const Te=(await Me.midjourney.fetchTask(k)).task;if(Te.status==="SUCCESS"){const re=Te.imageUrl||"",Be=((be=Te.properties)==null?void 0:be.messageId)||"",qe=((Se=Te.properties)==null?void 0:Se.messageHash)||"";if(b("idle"),n(""),J({status:"idle",taskId:"",progress:""}),ve().find(ot=>{var Le,ut,Et;return ot.type==="imagePreview"&&((Le=ot.data.midjourneyData)==null?void 0:Le.sourceNodeId)===u&&(((ut=ot.data.midjourneyData)==null?void 0:ut.taskId)===k||Be&&((Et=ot.data.midjourneyData)==null?void 0:Et.messageId)===Be)})){g.info("ä»»åŠ¡å·²å®Œæˆï¼Œå›¾ç‰‡å·²åœ¨é¢„è§ˆèŠ‚ç‚¹ä¸­");return}g.success("ğŸ¨ Midjourney å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼"),le(re,"4å®«æ ¼",se,{taskId:k,messageId:Be,messageHash:qe,mode:ce,buttons:Te.buttons,action:Te.action});return}const Re=Te.progress||"";if(n(Re),(Te.status==="IN_PROGRESS"||Te.status==="SUBMITTED")&&(b("processing"),J({status:"processing",progress:Re})),Te.status==="FAILURE"){b("error"),n(""),J({status:"error",progress:"",taskId:""}),g.error(Te.failReason?`ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${Te.failReason}`:"ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•");return}if(Te.status==="NOT_FOUND"){b("error"),n(""),J({status:"error",progress:"",taskId:""}),g.error("ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ");return}h++,h<W?setTimeout(q,ue):(b("error"),n(""),J({status:"error",progress:"",taskId:""}),g.error("ä»»åŠ¡ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ"))}catch(je){if((je.code==="ECONNABORTED"||je.code==="ERR_NETWORK"||((ye=je.message)==null?void 0:ye.includes("aborted"))||((_e=je.message)==null?void 0:_e.includes("Network Error")))&&h<W-1){h++,setTimeout(q,ue*2);return}b("error"),n(""),J({status:"error",progress:"",taskId:""}),g.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};q()},[u,se,le,J,ve]);return X.current=f,e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"auto_awesome"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"Midjourney"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),Oe&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{ref:E,value:he,onChange:k=>{Y.current=!0,ne(k.target.value)},onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),placeholder:"æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"},disabled:r==="processing"||r==="submitting"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”Ÿæˆæ¨¡å¼"}),e.jsxs("div",{className:"nodrag flex gap-2",onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:()=>Ce("relax"),disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${ce==="relax"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"} disabled:opacity-50 disabled:cursor-not-allowed`,children:"æ…¢é€Ÿ"}),e.jsxs("button",{type:"button",onClick:()=>{if(!I){g.warning("å¿«é€Ÿæ¨¡å¼é¢åº¦å·²ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒè½»æ¾æ¨¡å¼~");return}Ce("fast")},disabled:r==="processing"||r==="submitting",className:`nodrag flex-1 px-3 py-2 text-xs font-medium rounded-md border transition-all ${I?ce==="fast"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50":"bg-slate-200 dark:bg-white/10 text-slate-400 dark:text-white/30 border-slate-200 dark:border-white/10 cursor-not-allowed"} disabled:opacity-50 disabled:cursor-not-allowed`,title:I?"":"Fastæ¨¡å¼å·²ç»ç”¨å®Œï¼Œç›®å‰ä»…æ”¯æŒRelaxæ¨¡å¼",children:["å¿«é€Ÿ",!I&&" (ä¸å¯ç”¨)"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"å®½é«˜æ¯”"}),e.jsx(rs,{value:se,onChange:k=>fe(k),options:[{value:"21:9",label:"21:9 è¶…å®½å±"},{value:"16:9",label:"16:9 å®½å±"},{value:"4:3",label:"4:3 æ ‡å‡†æ¨ªå±"},{value:"3:2",label:"3:2 æ¨ªå±"},{value:"1:1",label:"1:1 æ­£æ–¹å½¢"},{value:"2:3",label:"2:3 ç«–å±"},{value:"3:4",label:"3:4 æ ‡å‡†ç«–å±"},{value:"9:16",label:"9:16 ç«–å±"}],className:r==="processing"||r==="submitting"?"opacity-50 pointer-events-none":""})]}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50",children:"é«˜çº§å‚æ•°"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ··ä¹±åº¦ Chaos"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:K})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:K,onChange:k=>De(Number(k.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${K/2}%, #06b6d4 ${K}%, var(--range-bg-color) ${K}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼åŒ– Stylize"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:we})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:we,onChange:k=>ie(Number(k.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${we/1e3*50}%, #06b6d4 ${we/1e3*100}%, var(--range-bg-color) ${we/1e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"æ€ªå¼‚åº¦ Weird"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:R})]}),e.jsx("input",{type:"range",min:"0",max:"3000",step:"100",value:R,onChange:k=>M(Number(k.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${R/3e3*50}%, #06b6d4 ${R/3e3*100}%, var(--range-bg-color) ${R/3e3*100}%, var(--range-bg-color) 100%)`}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"è´¨é‡ Quality"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:P})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"1",value:P===.25?0:P===.5?1:P===1?2:3,onChange:k=>{const h=Number(k.target.value);T(h===0?.25:h===1?.5:h===2?1:2)},disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${(P===.25?0:P===.5?1:P===1?2:3)/3*50}%, #06b6d4 ${(P===.25?0:P===.5?1:P===1?2:3)/3*100}%, var(--range-bg-color) ${(P===.25?0:P===.5?1:P===1?2:3)/3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"è‰å›¾"}),e.jsx("span",{children:"ä½"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"é«˜"})]})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"åŸå§‹é£æ ¼ Style Raw"}),e.jsx("button",{type:"button",onClick:()=>m(!x),disabled:r==="processing"||r==="submitting",className:`nodrag relative inline-flex h-6 w-11 items-center rounded-full transition-all focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed ${x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 border-2 border-transparent":"bg-slate-100 dark:bg-white/5 border-2 border-purple-500 dark:border-purple-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full transition-transform ${x?"translate-x-6 bg-white shadow-md":"translate-x-0.5 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600"}`})})]})})]}),o.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Tr,{className:"w-3 h-3"}),"è§’è‰²/ç‰©ä½“å‚è€ƒ (",o.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:o.map((k,h)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:k,alt:`Reference ${h+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["å‚è€ƒ ",h+1]})})]},h))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"å‚è€ƒæƒé‡ Omni Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:j})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:j,onChange:k=>te(Number(k.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${j/1e3*50}%, #06b6d4 ${j/1e3*100}%, var(--range-bg-color) ${j/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"é£æ ¼è½¬æ¢"}),e.jsx("span",{children:"å¹³è¡¡"}),e.jsx("span",{children:"ç»†èŠ‚"})]})]})]}),c.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-slate-200 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("label",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-white/50 flex items-center gap-1",children:[e.jsx(Tr,{className:"w-3 h-3"}),"é£æ ¼å‚è€ƒ (",c.length,")"]})}),e.jsx("div",{className:"space-y-1",children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:c.map((k,h)=>e.jsxs("div",{className:"relative group w-16 h-16 rounded-md overflow-hidden",children:[e.jsx("img",{src:k,alt:`Style ${h+1}`,className:"w-full h-full object-cover border-2 border-slate-200 dark:border-white/10"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center",children:e.jsxs("span",{className:"text-[10px] text-white",children:["é£æ ¼ ",h+1]})})]},h))})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] text-slate-600 dark:text-slate-400",children:"é£æ ¼æƒé‡ Style Weight"}),e.jsx("span",{className:"text-[10px] text-slate-800 dark:text-white font-bold",children:L})]}),e.jsx("input",{type:"range",min:"0",max:"1000",step:"50",value:L,onChange:k=>A(Number(k.target.value)),disabled:r==="processing"||r==="submitting",className:"nodrag w-full h-2 rounded-lg appearance-none cursor-pointer",style:{background:`linear-gradient(to right, #ec4899 0%, #a855f7 ${L/1e3*50}%, #06b6d4 ${L/1e3*100}%, var(--range-bg-color) ${L/1e3*100}%, var(--range-bg-color) 100%)`}}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-600 dark:text-slate-400 mt-1",children:[e.jsx("span",{children:"å¾®å¦™"}),e.jsx("span",{children:"æ ‡å‡†"}),e.jsx("span",{children:"å¼ºçƒˆ"})]})]})]}),e.jsxs("button",{onClick:S,onPointerDown:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),disabled:r==="processing"||r==="submitting"||s._canEdit===!1,className:"nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 relative overflow-hidden bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:opacity-50 disabled:cursor-wait",children:[r==="processing"&&l&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400/30 to-accent-400/30 transition-all duration-300",style:{width:l}}),e.jsx("span",{className:"relative z-10 flex items-center gap-2",children:r==="submitting"?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:"æäº¤ä¸­..."})]}):r==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3.5 h-3.5 animate-spin"}),e.jsx("span",{children:!l||l===""||l==="0%"?ce==="relax"?"æ’é˜Ÿä¸­...":"ç”Ÿæˆä¸­...":`${l}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"ç”Ÿæˆå›¾ç‰‡"}),v?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",p,"æ¬¡"]}):B!==null&&B>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-blue-500/30 text-blue-200 rounded text-[9px]",children:[B,"ç§¯åˆ†"]})]})})]}),r==="error"&&e.jsx("div",{className:"text-[10px] text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700/30 rounded-md px-2 py-1",children:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"})]}),e.jsxs("div",{className:"absolute left-0 top-[15%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"æ–‡æœ¬"}),e.jsx(Xs,{type:"target",position:dt.Left,id:"text-input",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:k=>{const h=$(k.source||"");return!!h&&h.type==="agent"}})]}),e.jsxs("div",{className:"absolute left-0 top-[35%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded whitespace-nowrap",children:"è§’è‰²/ç‰©ä½“"}),e.jsx(Xs,{type:"target",position:dt.Left,id:"omni-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:k=>!Z.some(W=>W.target===u&&W.targetHandle==="omni-ref")})]}),e.jsxs("div",{className:"absolute left-0 top-[55%] -translate-x-full flex items-center gap-1 pointer-events-none",children:[e.jsx("span",{className:"text-xs text-gray-900 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-900/80 px-2 py-0.5 rounded",children:"é£æ ¼"}),e.jsx(Xs,{type:"target",position:dt.Left,id:"style-ref",style:{position:"relative",left:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto",isValidConnection:k=>!Z.some(W=>W.target===u&&W.targetHandle==="style-ref")})]}),e.jsx("div",{className:"absolute right-0 top-1/2 translate-x-full -translate-y-1/2 flex items-center gap-1 pointer-events-none",children:e.jsx(Xs,{type:"source",position:dt.Right,style:{position:"relative",right:"8px",transform:"none"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)] pointer-events-auto"})})]})},gr="https://api.waule.com",xo=({data:s,selected:C,id:u})=>{var qs,rr,Ss,Ns,ms,Es,Ys;const[Q,Ie]=t.useState(!0),[,$]=t.useState(0),[ve,ee]=t.useState(s.config.taskId||"");t.useEffect(()=>{},[ve]);const{setNodes:de,setEdges:Z,getNode:ge,getNodes:Oe,getEdges:he}=ts(),ne=Fs(),se=Ds(),fe=t.useRef(""),ce=(qs=s.config)==null?void 0:qs.selectedEditingCapability,Ce=t.useMemo(()=>(s.models||[]).filter(z=>{var Pe;return z.type==="VIDEO_GENERATION"&&((Pe=z.provider)==null?void 0:Pe.toLowerCase())==="sora"}),[s.models]),[K,De]=t.useState(s.config.prompt||""),we=t.useRef(null);t.useEffect(()=>{s.config.prompt&&s.config.prompt!==K&&De(s.config.prompt)},[s.config.prompt]);const[ie,R]=t.useState(s.config.modelId||((rr=Ce[0])==null?void 0:rr.id)||""),[M,P]=t.useState(s.config.ratio||"16:9"),[T,x]=t.useState(s.config.resolution||"1080P"),m=t.useCallback(G=>{const z=(G||"").toLowerCase();return z?z.includes("æ–‡ç”Ÿ")||z.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":z.includes("é¦–å°¾")?"é¦–å°¾å¸§":z.includes("é¦–å¸§")||z.includes("first frame")||z.includes("start frame")||z.includes("initial frame")||z.includes("keyframe")?"é¦–å¸§":z.includes("å°¾å¸§")||z.includes("last frame")||z.includes("end frame")||z.includes("final frame")?"å°¾å¸§":z.includes("ä¸»ä½“å‚è€ƒ")||z.includes("å‚è€ƒ")||z.includes("reference image")||z.includes("image reference")||z.includes("ref image")?"å‚è€ƒå›¾":z.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":z.includes("first-last")||z.includes("two-frame")||z.includes("frame pair")?"é¦–å°¾å¸§":z.includes("first")?"é¦–å¸§":z.includes("last")?"å°¾å¸§":z.includes("subject")||z.includes("reference")?"å‚è€ƒå›¾":G||"":""},[]),[j,te]=t.useState((s.config.lockedGenerationType?m(s.config.lockedGenerationType):s.config.generationType)||"æ–‡ç”Ÿè§†é¢‘"),[L,A]=t.useState(s.config.duration||10),[O,r]=t.useState(s.config.isGenerating||!1),[b,l]=t.useState([]),[n,o]=t.useState(null),[a,c]=t.useState(!1),[w]=t.useState(""),[I]=t.useState("confirm"),[D]=t.useState(null),[B,v]=t.useState(!1),[p,d]=t.useState([]),[E,Y]=t.useState(""),[X,J]=t.useState(0),[F,ae]=t.useState(0),oe=t.useRef(!1),[le,S]=t.useState(!1),f=Ce.find(G=>G.id===ie)||Ce[0],{credits:k,loading:h,isFreeUsage:W,freeUsageRemaining:ue,refetch:q}=Ls({aiModelId:f==null?void 0:f.id,duration:L,resolution:T});t.useEffect(()=>{var G,z;if(!Ce.find(Pe=>Pe.id===ie)){const Pe=((G=Ce[0])==null?void 0:G.id)||"";R(Pe),qe({modelId:Pe,modelName:(z=Ce[0])==null?void 0:z.name})}},[Ce]);const be=((Ss=f==null?void 0:f.provider)==null?void 0:Ss.toLowerCase())==="sora",Se=t.useMemo(()=>{var z;if((z=f==null?void 0:f.config.supportedDurations)!=null&&z.length)return f.config.supportedDurations;const G=((f==null?void 0:f.provider)||"").toLowerCase();return G==="sora"?[10,15]:G==="minimaxi"?[6,10]:[L||10]},[f,L]),ye=t.useMemo(()=>{var z;return(z=f==null?void 0:f.config.supportedResolutions)!=null&&z.length?f.config.supportedResolutions:((f==null?void 0:f.provider)||"").toLowerCase()==="minimaxi"?["768P","1080P"]:["720P","1080P","2K","4K"]},[f]),_e=t.useMemo(()=>Math.min(...Se),[Se]),je=t.useMemo(()=>Math.max(...Se),[Se]),Te=t.useMemo(()=>Math.max(1,je-_e),[je,_e]),Re=t.useMemo(()=>{const G=(L-_e)/Te*100;return Number.isNaN(G)?0:Math.min(100,Math.max(0,G))},[L,_e,Te]),re=!f||!((Ns=f.config.supportedDurations)!=null&&Ns.length),Be=!f||!((ms=f.config.supportedResolutions)!=null&&ms.length),qe=t.useCallback(G=>{ge(u)&&de(Pe=>Pe.map(Ue=>Ue.id===u?{...Ue,data:{...Ue.data,config:{...Ue.data.config,...G}}}:Ue))},[ge,u,de]),Ft=(G,z)=>{const Pe=(N,_)=>_===0?N:Pe(_,N%_),Ue=Pe(G,z),Xe=G/Ue,We=z/Ue,Ye={"16:9":"16:9","9:16":"9:16","4:3":"4:3","3:4":"3:4","1:1":"1:1","21:9":"21:9"},ct=`${Xe}:${We}`;return Ye[ct]||ct},at=()=>{const G=ne.filter(We=>We.target===u),z=[];G.forEach(We=>{var ct;const Ye=ge(We.source);if(Ye&&Ye.type==="upload"&&(((ct=Ye.data.config)==null?void 0:ct.uploadedFiles)||[]).forEach(_=>{const pe=_.type||_.mimeType||"";(pe==="IMAGE"||pe.startsWith("image/"))&&z.push({id:_.id||_.name,url:_.url,name:_.name||_.originalName,width:_.width,height:_.height,aspectRatio:_.width&&_.height?Ft(_.width,_.height):"16:9"})}),Ye&&Ye.type==="assetSelector"){const N=Ye.data.config||{},_=N.subjects,pe=N.selectedAsset,Ae=m(j);_&&_.length>0?Ae==="é¦–å°¾å¸§"||(_[0].images||[]).forEach((me,Qe)=>{z.push({id:`${Ye.id}-subject-${Qe}`,url:me,name:_[0].name,width:void 0,height:void 0,aspectRatio:"16:9"})}):pe&&pe.type==="IMAGE"&&z.push({id:pe.id,url:pe.url,name:pe.name||pe.originalName,width:void 0,height:void 0,aspectRatio:"16:9"})}if(Ye&&Ye.type==="imagePreview"){const N=Ye.data.imageUrl,_=Ye.data.width,pe=Ye.data.height;N&&z.push({id:Ye.id,url:N,name:"ç”Ÿæˆçš„å›¾ç‰‡",width:_,height:pe,aspectRatio:_&&pe?Ft(_,pe):"16:9"})}});const Pe=new Set,Ue=[];z.forEach(We=>{const Ye=We.url;Pe.has(Ye)||(Pe.add(Ye),Ue.push(We))});const Xe=m(j);return Xe==="æ–‡ç”Ÿè§†é¢‘"?be?Ue:[]:Xe==="é¦–å¸§"||Xe==="å°¾å¸§"?Ue.slice(0,1):Xe==="é¦–å°¾å¸§"?Ue.slice(0,2):Xe==="å‚è€ƒå›¾"?Ue.slice(0,7):Ue},ot=t.useMemo(()=>at(),[ne,se,j,u,be]);t.useEffect(()=>{const G=s.config.taskId;(async()=>{let Pe=!1;if(s.config.isGenerating||!G)try{const Ue=await Me.tasks.getActiveTask(u);if(Ue.task){const Xe=Ue.task;ee(Xe.id),r(!0),$(Xe.progress||0),Ps(Xe.id);return}else s.config.isGenerating&&(r(!1),qe({isGenerating:!1}))}catch{}if(G){const Ue=Oe(),Xe=he(),We=Ue.find(Ye=>Ye.type==="videoPreview"&&Xe.some(ct=>ct.source===u&&ct.target===Ye.id));if(We&&We.data.videoUrl){Pe=!0,G&&(qe({taskId:""}),ee(""));return}try{const ct=(await Me.tasks.getTaskStatus(G)).task;if(ct.status==="SUCCESS"){const N=ct.resultUrl;$(100),setTimeout(()=>$(0),1e3);try{const _=localStorage.getItem("suppressedPreviewTasks")||"[]";JSON.parse(_).some(Ne=>Ne.taskId&&Ne.taskId===G||Ne.sourceNodeId&&Ne.sourceNodeId===u)||hs(N,s.config.ratio||"16:9")}catch{hs(N,s.config.ratio||"16:9")}Pe=!0,qe({taskId:""}),ee(""),g.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼")}else if(ct.status==="PROCESSING"||ct.status==="PENDING"){r(!0),$(ct.progress||0),Ps(G);return}else ct.status==="FAILURE"&&($(0),qe({taskId:""}),g.error(ct.errorMessage?`è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼š${ct.errorMessage}`:"è§†é¢‘ç”Ÿæˆæœªèƒ½å®Œæˆï¼Œè¯·ç¨åé‡è¯•"))}catch{$(0),qe({taskId:""})}}if(!Pe)try{const Ue=await Me.tasks.getPendingPreviewNodes(u);if(Ue.tasks&&Ue.tasks.length>0)for(const Xe of Ue.tasks){const{previewNodeData:We}=Xe;if(We&&We.url){const Ye=We.ratio||s.config.ratio||"16:9";let ct=!1;try{const N=localStorage.getItem("suppressedPreviewTasks")||"[]";ct=JSON.parse(N).some(pe=>pe.taskId&&pe.taskId===Xe.id||pe.sourceNodeId&&pe.sourceNodeId===u)}catch{}ct||hs(We.url,Ye),await Me.tasks.markPreviewNodeCreated(Xe.id)}}}catch{}})()},[]),t.useEffect(()=>{const G=ne.filter(Pe=>Pe.target===u);let z="";G.forEach(Pe=>{var Xe;const Ue=ge(Pe.source);if(Ue){const We=Ue.data;Ue.type==="agent"&&((Xe=We.config)!=null&&Xe.generatedText)?z||(z=We.config.generatedText):Ue.type==="textPreview"&&We.content&&(z||(z=We.content))}}),z&&z!==K&&(De(z),qe({prompt:z}))},[ne,u,ge,K,qe]),t.useEffect(()=>{const G=ne.filter(Ue=>Ue.target===u);if(G.length===0)return;let z="",Pe="";G.forEach(Ue=>{var We;const Xe=se.find(Ye=>Ye.id===Ue.source);if(Xe&&Xe.type==="agent"){const Ye=Xe.data;(We=Ye.config)!=null&&We.generatedText&&(z=Ye.config.generatedText,Pe=`${Xe.id}-${Ye.config.generatedText.substring(0,50)}`)}}),z&&Pe!==fe.current&&(fe.current=Pe,De(z),qe({prompt:z}))},[se,ne,u,qe]),t.useEffect(()=>{const G=JSON.stringify(ot),z=JSON.stringify(b);G!==z&&l(ot)},[ot]);const Le=t.useMemo(()=>{if(be)return!0;const G=b.length,z=m(j);return G===0?!0:G===1?z==="å‚è€ƒå›¾":G===2?z==="é¦–å°¾å¸§"?!1:z==="å‚è€ƒå›¾":G>2?z==="å‚è€ƒå›¾":!1},[b.length,j,m,be]),ut=t.useMemo(()=>["æ–‡ç”Ÿè§†é¢‘","é¦–å¸§","å°¾å¸§","é¦–å°¾å¸§","å‚è€ƒå›¾"],[]),Et=t.useMemo(()=>{const G=m(j);return ce?Ce:Ce.filter(z=>{var Ue;const Pe=(((Ue=z.config)==null?void 0:Ue.supportedGenerationTypes)||[]).map(Xe=>m(Xe));return G==="é¦–å¸§"||G==="å°¾å¸§"?Pe.includes("é¦–å¸§")||Pe.includes("å°¾å¸§"):Pe.includes(G)})},[Ce,j,m,ce]),nt=t.useMemo(()=>{const G=ce?Ce:Et;return G.length>0?G:ce?(s.models||[]).filter(Pe=>(Pe.type||"")==="VIDEO_EDITING"):G},[ce,Ce,Et,s.models]);t.useEffect(()=>{var z,Pe;if(!nt.find(Ue=>Ue.id===ie)){const Ue=((z=nt[0])==null?void 0:z.id)||"";R(Ue),qe({modelId:Ue||void 0,modelName:Ue?(Pe=nt[0])==null?void 0:Pe.name:void 0})}},[nt]);const yt=t.useCallback(G=>{const z=m(G);return ce?["IMAGE","VIDEO"]:z==="æ–‡ç”Ÿè§†é¢‘"?be?["TEXT","IMAGE"]:["TEXT"]:["TEXT","IMAGE"]},[m,ce,be]);t.useEffect(()=>{if(!Le&&b.length>0){const G=b[0].aspectRatio;G&&M!==G&&(P(G),setTimeout(()=>{qe({ratio:G})},0))}},[Le,b,M]),t.useEffect(()=>{if(!ce&&ut.length>0&&!ut.includes(j)){const G="æ–‡ç”Ÿè§†é¢‘";te(G),setTimeout(()=>{qe({generationType:G,acceptedInputs:yt(G)})},0)}},[ut,j,yt,ce]),t.useEffect(()=>{const G=m(j);if(G==="æ–‡ç”Ÿè§†é¢‘")return;const z=ne.filter(We=>We.target===u),Pe=[],Ue=[];z.forEach(We=>{var N,_,pe,Ae,Ne;const Ye=ge(We.source);if(!Ye)return;const ct=Ye.type;if((ct||"").startsWith("aiVideo")||ct==="videoPreview"){Ue.push(We.id);return}if(ct==="upload"){const me=(pe=(_=(N=Ye.data)==null?void 0:N.config)==null?void 0:_.uploadedFiles)==null?void 0:pe[0],Qe=((me==null?void 0:me.type)||"").toUpperCase(),Ze=((me==null?void 0:me.mimeType)||"").toLowerCase();if(Qe==="VIDEO"||Ze.startsWith("video/")){Ue.push(We.id);return}(Qe==="IMAGE"||Ze.startsWith("image/"))&&Pe.push(We.id);return}if(ct==="assetSelector"){const me=((Ae=Ye.data)==null?void 0:Ae.config)||{};if(me.selectedAsset){const Qe=(me.selectedAsset.type||"").toUpperCase(),Ze=(me.selectedAsset.mimeType||"").toLowerCase();Qe==="VIDEO"||Ze.startsWith("video/")?Ue.push(We.id):(Qe==="IMAGE"||Ze.startsWith("image/"))&&Pe.push(We.id)}else if(me.subjects&&me.subjects.length>0){const Qe=(((Ne=me.subjects[0])==null?void 0:Ne.images)||[]).length;G==="å‚è€ƒå›¾"||G==="é¦–å°¾å¸§"?Pe.push(We.id):(G==="é¦–å¸§"||G==="å°¾å¸§")&&(Qe>1?Ue.push(We.id):Pe.push(We.id))}return}(ct==="aiImage"||ct==="imagePreview")&&Pe.push(We.id)});let Xe=new Set([...Ue]);G==="é¦–å¸§"||G==="å°¾å¸§"?Pe.slice(1).forEach(We=>Xe.add(We)):G==="é¦–å°¾å¸§"&&Pe.slice(2).forEach(We=>Xe.add(We)),Xe.size>0&&Z(We=>We.filter(Ye=>!Xe.has(Ye.id)))},[j,ne,u,ge,Z,m]),t.useEffect(()=>{const G=s.config.generationType;if(!G||m(G)!==m(j)){const z=m(j)||"æ–‡ç”Ÿè§†é¢‘";qe({generationType:z,acceptedInputs:yt(z)})}},[]),t.useEffect(()=>{const G=yt(j);qe({acceptedInputs:G})},[j,yt]);const Ot=G=>{o(G)},tt=G=>{G.preventDefault()},_t=G=>{if(n===null)return;const z=[...b],[Pe]=z.splice(n,1);z.splice(G,0,Pe),l(z),o(null),qe({referenceImages:z})};t.useEffect(()=>{const G=we.current;G&&Q&&requestAnimationFrame(()=>{G.style.height="auto";const z=Math.max(60,Math.min(G.scrollHeight,600));G.style.height=`${z}px`})},[K,Q]),t.useEffect(()=>{if(K===s.config.prompt)return;const G=setTimeout(()=>{qe({prompt:K})},500);return()=>clearTimeout(G)},[K]);const Kt=t.useCallback(async G=>{if(!G){d([]);return}try{const z=await Me.soraCharacters.search(G,5);d(z.characters||[]),ae(0)}catch{d([])}},[]),bs=t.useCallback(G=>{const z=G.target.value,Pe=G.target.selectionStart||0;if(De(z),oe.current)return;const Xe=z.substring(0,Pe).match(/@([^@\s#]*)$/);if(Xe){const We=Xe[1];Y(We),J(Pe-We.length-1),v(!0),Kt(We)}else v(!1),d([])},[Kt]),cs=t.useCallback(G=>{const z=K.substring(0,X),Pe=K.substring(X+E.length+1),Ue=`@#${G.customName}#`,Xe=z+Ue+Pe;De(Xe),v(!1),d([]),Y(""),setTimeout(()=>{if(we.current){we.current.focus();const We=z.length+Ue.length;we.current.setSelectionRange(We,We)}},0)},[K,X,E]),Rs=t.useCallback(G=>{!B||p.length===0||(G.key==="ArrowDown"?(G.preventDefault(),ae(z=>z<p.length-1?z+1:z)):G.key==="ArrowUp"?(G.preventDefault(),ae(z=>z>0?z-1:z)):G.key==="Enter"&&p[F]?(G.preventDefault(),cs(p[F])):G.key==="Escape"&&v(!1))},[B,p,F,cs]),ws=t.useCallback(async G=>{var Xe;const z=/@#([^#]+)#/g,Pe=[...G.matchAll(z)];if(Pe.length===0)return G;let Ue=G;for(const We of Pe){const Ye=We[1];try{const ct=await Me.soraCharacters.getByCustomName(Ye);(Xe=ct.character)!=null&&Xe.characterName&&(Ue=Ue.replace(We[0],` ${ct.character.characterName} `))}catch{}}return Ue},[]),zs=G=>{var Pe,Ue,Xe,We;R(G);const z=Et.find(Ye=>Ye.id===G);if(z){const Ye=(Pe=z.config.supportedRatios)!=null&&Pe.length?z.config.supportedRatios:["16:9"],ct=(Ue=z.config.supportedResolutions)!=null&&Ue.length?z.config.supportedResolutions:["1080P"],N=(Xe=z.config.supportedGenerationTypes)!=null&&Xe.length?z.config.supportedGenerationTypes:["æ–‡ç”Ÿè§†é¢‘"],_=(z.provider||"").toLowerCase(),pe=(We=z.config.supportedDurations)!=null&&We.length?z.config.supportedDurations:_==="sora"?[10,15]:_==="minimaxi"?[6,10]:[10],Ae=Ye[0],Ne=ct[0],me=m(j||N[0]),Qe=pe[0];P(Ae),x(Ne),te(me),A(Qe),qe({modelId:G,modelName:z.name,ratio:Ae,resolution:Ne,generationType:me,duration:Qe,acceptedInputs:yt(me)})}},Nt=t.useMemo(()=>{const G=m(j),z=b.length,Xe=ne.filter(We=>We.target===u).filter(We=>{var N,_,pe,Ae,Ne;const Ye=ge(We.source),ct=Ye==null?void 0:Ye.type;if(!Ye)return!1;if(ct==="upload"){const me=(pe=(_=(N=Ye.data)==null?void 0:N.config)==null?void 0:_.uploadedFiles)==null?void 0:pe[0],Qe=((me==null?void 0:me.mimeType)||"").toLowerCase();return((me==null?void 0:me.type)||"").toUpperCase()==="VIDEO"||Qe.startsWith("video/")}if(ct==="assetSelector"){const me=(Ne=(Ae=Ye.data)==null?void 0:Ae.config)==null?void 0:Ne.selectedAsset,Qe=((me==null?void 0:me.mimeType)||"").toLowerCase();return((me==null?void 0:me.type)||"").toUpperCase()==="VIDEO"||Qe.startsWith("video/")}return!!((ct||"").startsWith("aiVideo")||ct==="videoPreview")}).length;return ie?G==="æ–‡ç”Ÿè§†é¢‘"?be?!0:!!K.trim():G==="é¦–å¸§"||G==="å°¾å¸§"?z>=1:G==="é¦–å°¾å¸§"?z>=2:G==="å‚è€ƒå›¾"?z>=1:G==="è§†é¢‘æ¢äºº"?Xe>=1&&z>=1:G==="å¯¹å£å‹"||G==="é£æ ¼è½¬æ¢"?Xe>=1:!1:!1},[j,b.length,K,O,ne,u,ge,m,be]);t.useEffect(()=>{var z;const G=(z=s==null?void 0:s.config)==null?void 0:z.generatedVideoUrl;G&&hs(G,s.config.ratio||"16:9")},[(Es=s==null?void 0:s.config)==null?void 0:Es.generatedVideoUrl]);const Ps=async G=>{let Pe=0;const Ue=async()=>{try{Pe++;const We=(await Me.tasks.getTaskStatus(G)).task;if($(We.progress||0),We.status==="SUCCESS"||We.status==="COMPLETED"||We.status==="DONE"){$(100);const Ye=We.resultUrl;r(!1),hs(Ye,s.config.ratio||"16:9");try{await Me.tasks.markPreviewNodeCreated(G)}catch{}qe({prompt:s.config.prompt,ratio:s.config.ratio,modelId:s.config.modelId,generatedVideoUrl:Ye,taskId:"",isGenerating:!1}),ee(""),g.success("ğŸ¬ è§†é¢‘åˆ›ä½œå®Œæˆï¼Œå¿«å»æ¬£èµå§ï¼"),setTimeout(()=>$(0),1e3);return}else if(We.status==="FAILURE"){r(!1),$(0),qe({taskId:"",isGenerating:!1}),g.error(We.errorMessage||"è§†é¢‘ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(We.status==="PROCESSING"||We.status==="PENDING")&&(Pe<600?setTimeout(Ue,1e3):(r(!1),$(0),qe({taskId:"",isGenerating:!1}),g.error("è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{r(!1),$(0),qe({taskId:"",isGenerating:!1}),g.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç”Ÿæˆç»“æœ")}};Ue()},ys=async()=>{var Pe,Ue,Xe,We,Ye,ct;if(m(j)==="æ–‡ç”Ÿè§†é¢‘"&&!K.trim()){g.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°ï¼Œå‘Šè¯‰ AI æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„ç”»é¢~");return}r(!0);const z=at();qe({referenceImages:z}),$(0);try{let N=[],_;const pe=z.length;if(z.length>0)try{for(const Gt of z){let wt=Gt.url;!wt.startsWith("data:")&&!wt.startsWith("http")&&(wt=`${gr}${wt}`),wt=wt.replace(/^https?:\/\/localhost(?::\d+)?/i,gr);const It=await Nr(wt);N.push(It)}}catch{g.error("å‚è€ƒå›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ")}const Ae=ne.filter(Gt=>Gt.target===u);if(m(j)==="å‚è€ƒå›¾"){const Gt=new Map;for(const wt of Ae){const It=ge(wt.source);if((It==null?void 0:It.type)==="assetSelector"){const Mt=(Pe=It.data.config)==null?void 0:Pe.subjects;if(Mt&&Mt.length>0){for(const Lt of Mt)if(!Gt.has(Lt.name)){const es=(Lt.images||[]).map(ns=>ns.startsWith("http")||ns.startsWith("data:")?ns:`${gr}${ns}`);Gt.set(Lt.name,es)}}}}if(Gt.size>0){const wt=Array.from(Gt.entries());let It=0;const Mt=[];for(const[Lt,es]of wt){if(It>=7)break;const ns=7-It,Cs=es.slice(0,Math.max(0,ns));Cs.length>0&&(Mt.push({name:Lt,images:Cs}),It+=Cs.length)}_=Mt,wt.some(([,Lt])=>Lt.length>0)&&It<wt.reduce((Lt,[,es])=>Lt+es.length,0)&&g.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}const Ne=_&&_.length>0?_.reduce((Gt,wt)=>{var It;return Gt+(((It=wt.images)==null?void 0:It.length)||0)},0):pe;let me=j;if(me==="é¦–å¸§"||me==="å°¾å¸§"){if(Ne!==1){g.error("æ­¤æ¨¡å¼éœ€è¦è¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºå‚è€ƒ"),r(!1),$(0);return}}else if(me==="é¦–å°¾å¸§"){if(Ne===1)me="é¦–å¸§";else if(Ne!==2){g.error("é¦–å°¾å¸§æ¨¡å¼éœ€è¦è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§å’Œç»“æŸå¸§ï¼‰"),r(!1),$(0);return}_&&_.length>0?_=[{..._[0],images:_[0].images.slice(0,2)}]:N=N.slice(0,2)}else if(me==="å‚è€ƒå›¾"||me==="ä¸»ä½“å‚è€ƒ"){if(Ne<1){g.error("å‚è€ƒæ¨¡å¼éœ€è¦è‡³å°‘è¿æ¥ 1 å¼ å›¾ç‰‡"),r(!1),$(0);return}if(_&&_.length>0){if(_.reduce((wt,It)=>{var Mt;return wt+(((Mt=It.images)==null?void 0:Mt.length)||0)},0)>7){let wt=7;_=_.map(It=>({...It,images:It.images.slice(0,Math.max(0,wt-=It.images.length,It.images.length))})),wt=7,_=_.map(It=>{const Mt=It.images.slice(0,Math.min(It.images.length,wt));return wt-=Mt.length,{...It,images:Mt}}).filter(It=>It.images.length>0),g.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ ")}}else N.length>7&&(N=N.slice(0,7),g.info("å‚è€ƒå›¾è¾ƒå¤šï¼Œå·²è‡ªåŠ¨é€‰å–å‰ 7 å¼ "))}D==="dropImages"&&(N=[],_=void 0),(m(j)==="é¦–å¸§"||m(j)==="å°¾å¸§")&&D==="useFirstImage"&&N.length>=2&&(N=[N[0]]),m(j)==="é¦–å°¾å¸§"&&D==="useFirstTwoImages"&&N.length>=3&&(N=N.slice(0,2));const Qe={modelId:ie,ratio:M,duration:L,referenceImages:N.length>0&&!_?N:void 0,generationType:me,sourceNodeId:u,..._?{subjects:_}:{}},Ze=m(me);let xt=K.trim();if(xt&&xt.includes("@#")&&(xt=await ws(xt)),!le&&xt&&(xt="No BGM. "+xt),Ze==="æ–‡ç”Ÿè§†é¢‘"){if(!xt){g.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~"),r(!1),$(0);return}Qe.prompt=xt}else if(Ze==="å‚è€ƒå›¾"){if(!xt){g.error("è¯·æè¿°æ‚¨å¸Œæœ›å‚è€ƒå›¾å‘ˆç°çš„æ•ˆæœ~"),r(!1),$(0);return}Qe.prompt=xt}else xt&&(Qe.prompt=xt);const it=await Me.tasks.createVideoTask(Qe),Ge=it.taskId,Rt=it.creditsCharged||0,Bt=it.isFreeUsage,$t=it.freeUsageRemaining??0;if(ee(Ge),qe({prompt:K,ratio:M,resolution:T,generationType:j,duration:L,modelId:ie,taskId:Ge,isGenerating:!0}),Bt)g.success(`ğŸ å…è´¹åˆ›ä½œä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${$t} æ¬¡ã€‚è§†é¢‘ç”Ÿæˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‚¨å¯ä»¥å…ˆå¤„ç†å…¶ä»–å†…å®¹~`),q();else if(Rt>0){const{useAuthStore:Gt}=await gs(async()=>{const{useAuthStore:It}=await import("./index-Cp0uMTfX.js").then(Mt=>Mt.f);return{useAuthStore:It}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:wt}=Gt.getState();await wt(),g.success(`ğŸ¬ åˆ›ä½œå·²å¯åŠ¨ï¼Œæ¶ˆè€— ${Rt} ç§¯åˆ†ã€‚AI æ­£åœ¨ç²¾å¿ƒåˆ¶ä½œæ‚¨çš„è§†é¢‘ï¼Œè¯·è€å¿ƒç­‰å¾…~`),q()}else g.success("ğŸ¬ è§†é¢‘åˆ›ä½œå·²å¯åŠ¨ï¼ŒAI æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å…¶ä»–èŠ‚ç‚¹~");Ps(Ge)}catch(N){if(r(!1),$(0),((Ue=N.response)==null?void 0:Ue.status)===403){const _=((We=(Xe=N.response)==null?void 0:Xe.data)==null?void 0:We.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";g.error(_)}else{const _=((ct=(Ye=N.response)==null?void 0:Ye.data)==null?void 0:ct.error)||N.message||"æœªçŸ¥åŸå› ";g.error(`åˆ›ä½œå¯åŠ¨å¤±è´¥ï¼š${_}ï¼Œè¯·ç¨åé‡è¯•`)}}},Zs=async()=>{const G=m(j),z=at(),Pe=z.length;if((()=>{var We;const Xe=ne.filter(Ye=>Ye.target===u);for(const Ye of Xe){const ct=ge(Ye.source);if((ct==null?void 0:ct.type)==="assetSelector"){const N=(We=ct.data.config)==null?void 0:We.subjects;if(N&&N.length>0)return!0}}return!1})()&&(G==="é¦–å¸§"||G==="å°¾å¸§"||G==="é¦–å°¾å¸§")){g.error('å½“å‰æ¨¡å¼ä¸æ”¯æŒè§’è‰²å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°"å‚è€ƒå›¾"æ¨¡å¼');return}if((G==="é¦–å¸§"||G==="å°¾å¸§")&&Pe===0){g.error("è¯·å…ˆè¿æ¥ 1 å¼ å›¾ç‰‡ä½œä¸ºèµ·å§‹ç”»é¢");return}if(G==="é¦–å°¾å¸§"&&Pe===0){g.error("è¯·è¿æ¥ 2 å¼ å›¾ç‰‡ï¼ˆèµ·å§‹å¸§ + ç»“æŸå¸§ï¼‰");return}if(G==="å‚è€ƒå›¾"&&Pe===0){g.error("è¯·å…ˆè¿æ¥å‚è€ƒå›¾ç‰‡");return}if(G==="æ–‡ç”Ÿè§†é¢‘"&&Pe>0&&!be&&!window.confirm('å½“å‰æ˜¯"æ–‡ç”Ÿè§†é¢‘"æ¨¡å¼ï¼Œè¿æ¥çš„å›¾ç‰‡å°†è¢«å¿½ç•¥ã€‚å¦‚éœ€ä½¿ç”¨å›¾ç‰‡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){g.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if((G==="é¦–å¸§"||G==="å°¾å¸§")&&Pe>=2&&!window.confirm("å½“å‰æ¨¡å¼ä»…æ”¯æŒ 1 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨ç¬¬ 1 å¼ ä½œä¸ºèµ·å§‹ç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){g.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(G==="é¦–å°¾å¸§"&&Pe>=3&&!window.confirm("é¦–å°¾å¸§æ¨¡å¼ä»…æ”¯æŒ 2 å¼ å›¾ç‰‡ï¼Œå°†ä½¿ç”¨å‰ 2 å¼ ä½œä¸ºèµ·å§‹å’Œç»“æŸç”»é¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")){g.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼");return}if(G==="æ–‡ç”Ÿè§†é¢‘"&&!K.trim()){g.error("è¯·å…ˆè¾“å…¥è§†é¢‘æè¿°~");return}if(!ie){g.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ¨¡å‹");return}l(z),qe({referenceImages:z}),r(!0),$(0),await ys()},hs=(G,z)=>{const Pe=ge(u);if(!Pe||!G)return null;const Ue=z||M||"16:9",Xe=Oe(),We=he(),Ye=Xe.filter(Mt=>Mt.type==="videoPreview"&&We.some(Lt=>Lt.source===u&&Lt.target===Mt.id)),ct=Ye.find(Mt=>Mt.data.videoUrl===G);if(ct)return ct.id;const N=1,_=400,pe=(Mt,Lt=300)=>{if(!Mt||!/^[0-9]+\s*:\s*[0-9]+$/.test(Mt))return Lt;const[es,ns]=Mt.split(":").map(Cs=>parseFloat(Cs));return!es||!ns?Lt:Math.round(_*(ns/es))},Ae=document.querySelector(`.react-flow__node[data-id="${u}"]`),Ne=Ae==null?void 0:Ae.getBoundingClientRect(),me=Math.round(((Ne==null?void 0:Ne.width)||400)/N),Qe=100,Ze=200,xt=pe(Ue,300),it=Ye.length,Ge=Pe.position.x+me+Ze,Rt=Pe.position.y,Bt=Ge,$t=Rt+it*(xt+Qe),Gt=Date.now(),wt={id:`preview-${u}-${Gt}`,type:"videoPreview",position:{x:Bt,y:$t},data:{videoUrl:G,width:_,ratio:Ue,workflowContext:Pe.data.workflowContext,createdBy:Pe.data.createdBy}};de(Mt=>[...Mt,wt]);const It={id:`edge-${u}-${wt.id}`,source:u,target:wt.id,targetHandle:`${wt.id}-target`,type:"aurora"};return Z(Mt=>Mt.find(es=>es.source===u&&es.target===wt.id)?Mt:[...Mt,It]),wt.id},Js=G=>{const z=G.target;if(z.tagName==="INPUT"||z.tagName==="TEXTAREA"||z.tagName==="SELECT"||z.tagName==="BUTTON"||z.closest("button")||z.closest("input")||z.closest("textarea")||z.closest("select"))return;const Pe=!Q;Ie(Pe),de(Ue=>Ue.map(Xe=>Xe.id===u?{...Xe,data:{...Xe.data,isExpanded:Pe}}:Xe))};return e.jsxs("div",{onDoubleClick:Js,className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${u}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]",isConnectable:(()=>{var _;const G=((_=ge(u))==null?void 0:_.type)||"",z=m(j),Pe=z==="æ–‡ç”Ÿè§†é¢‘"||G==="aiVideo_t2v",Ue=G==="aiVideo_i2v_first"||G==="aiVideo_i2v_last"||z==="é¦–å¸§"||z==="å°¾å¸§",Xe=G==="aiVideo_first_last"||z==="é¦–å°¾å¸§",We=G==="aiVideo_reference"||z==="å‚è€ƒå›¾",Ye=ne.filter(pe=>pe.target===u),ct=Ye.some(pe=>{const Ae=ge(pe.source);return(Ae==null?void 0:Ae.type)==="agent"}),N=Ye.reduce((pe,Ae)=>{var Qe,Ze,xt,it;const Ne=ge(Ae.source),me=(Ne==null?void 0:Ne.type)||"";if(me==="aiImage"||me==="imagePreview")return pe+1;if(me==="upload"){const Ge=(xt=(Ze=(Qe=Ne==null?void 0:Ne.data)==null?void 0:Qe.config)==null?void 0:Ze.uploadedFiles)==null?void 0:xt[0],Rt=((Ge==null?void 0:Ge.type)||"").toUpperCase(),Bt=((Ge==null?void 0:Ge.mimeType)||"").toLowerCase();return pe+(Rt==="IMAGE"||Bt.startsWith("image/")?1:0)}if(me==="assetSelector"){const Ge=((it=Ne==null?void 0:Ne.data)==null?void 0:it.config)||{};if(Ge.selectedAsset)return pe+((Ge.selectedAsset.type||"").toUpperCase()==="IMAGE"||(Ge.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(Ge.subjects&&Ge.subjects.length>0)return pe+((Ge.subjects[0].images||[]).length||0)}return pe},0);return Pe?be||!ct:Ue?!(ct&&N>=1):Xe?!(ct&&N>=2):We?!(ct&&N>=7):!0})()}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"movie"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center",children:e.jsxs("div",{className:"bg-card-dark border border-border-dark rounded-xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"text-lg font-bold text-text-dark-primary mb-4",children:"æç¤º"}),e.jsx("div",{className:"text-text-dark-primary mb-6 text-sm",children:w}),I==="alert"?e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{c(!1)},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"å¥½çš„"})}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>{c(!1),g.info("æ‚¨å¯ä»¥åœ¨é¢æ¿ä¸­åˆ‡æ¢ç”Ÿæˆæ¨¡å¼")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg",children:"é€‰æ‹©æ¨¡å¼"}),e.jsx("button",{onClick:async()=>{c(!1),await ys()},className:"px-4 py-2 bg-tiffany-500 hover:bg-tiffany-600 text-white rounded-lg",children:"ç¡®è®¤æ‰§è¡Œ"})]})]})}),e.jsx("div",{className:"p-4",children:Q?e.jsxs("div",{className:"space-y-3",children:[!be&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘ç”Ÿæˆæ¨¡å‹"}),e.jsx(rs,{value:ie,onChange:G=>zs(G),options:Et.length===0?[{value:"",label:"æš‚æ— å¯ç”¨æ¨¡å‹"}]:Et.map(G=>({value:G.id,label:G.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æç¤ºè¯ ",e.jsx("span",{className:"text-purple-400 font-normal",children:"ï¼ˆè¾“å…¥@è°ƒç”¨è§’è‰²ï¼‰"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:we,value:K,onChange:bs,onKeyDown:Rs,onCompositionStart:()=>{oe.current=!0},onCompositionEnd:G=>{oe.current=!1,bs(G)},placeholder:"æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯...è¾“å…¥@è°ƒç”¨è§’è‰²",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}}),B&&p.length>0&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-1 z-50 bg-white dark:bg-[#1a1a2e] border border-slate-200 dark:border-white/10 rounded-lg shadow-xl max-h-48 overflow-y-auto",children:p.map((G,z)=>e.jsxs("button",{type:"button",onMouseDown:Pe=>{Pe.preventDefault(),Pe.stopPropagation(),cs(G)},className:`nodrag w-full px-3 py-2 flex items-center gap-2 text-left transition-colors ${z===F?"bg-purple-100 dark:bg-purple-900/30":"hover:bg-slate-100 dark:hover:bg-white/5"}`,children:[G.avatarUrl?e.jsx("img",{src:G.avatarUrl,alt:"",className:"w-6 h-6 rounded-full object-cover object-top"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-200 dark:bg-purple-800 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-xs text-purple-600 dark:text-purple-300",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-slate-700 dark:text-white truncate",children:G.customName}),e.jsx("div",{className:"text-[10px] text-purple-500 dark:text-purple-400 font-mono truncate",children:G.characterName})]})]},G.id))})]})]}),b.length>=1&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["å‚è€ƒå›¾ ",j==="é¦–å°¾å¸§"&&"(æ‹–åŠ¨è°ƒæ•´)"]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:b.map((G,z)=>e.jsxs("div",{draggable:j==="é¦–å°¾å¸§",onDragStart:()=>Ot(z),onDragOver:tt,onDrop:()=>_t(z),className:`nodrag relative w-16 h-16 rounded-md border-2 overflow-hidden transition-all ${j==="é¦–å°¾å¸§"?"cursor-move":""} ${n===z?"opacity-50":""} border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50`,children:[e.jsx("img",{src:`${G.url.startsWith("http")||G.url.startsWith("data:")?G.url:gr+G.url}`,alt:G.name,className:"w-full h-full object-cover"}),j==="é¦–å°¾å¸§"&&e.jsx("div",{className:"absolute top-0 left-0 bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-br",children:z===0?"é¦–":z===1?"å°¾":z+1})]},G.id))})]}),f&&!be&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"flex items-center justify-between text-[10px] uppercase font-bold tracking-wider",children:[e.jsxs("span",{className:"text-slate-400 dark:text-white/50",children:["è§†é¢‘æ—¶é•¿",re?"(æœªé…ç½®)":""]}),e.jsxs("span",{className:"text-slate-600 dark:text-white",children:[L,"ç§’"]})]}),e.jsx("div",{className:"relative py-1.5",children:e.jsx("input",{type:"range",min:_e,max:je,step:"1",value:L,onChange:G=>{const z=parseInt(G.target.value,10);A(z),qe({duration:z})},disabled:re,className:"nodrag w-full appearance-none cursor-pointer disabled:cursor-not-allowed disabled:opacity-60 bg-transparent [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-md [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-purple-500 [&::-moz-range-thumb]:border-0 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:shadow-md [&::-webkit-slider-runnable-track]:w-full [&::-webkit-slider-runnable-track]:h-1 [&::-webkit-slider-runnable-track]:rounded-full [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:w-full [&::-moz-range-track]:h-1 [&::-moz-range-track]:rounded-full [&::-moz-range-track]:bg-transparent",style:{backgroundImage:`linear-gradient(to right, #a855f7 ${Re}%, #3b0764 ${Re}%)`,backgroundSize:"100% 4px",backgroundPosition:"center",backgroundRepeat:"no-repeat"}})})]}),f&&Le&&(be||(((Ys=f==null?void 0:f.config.supportedRatios)==null?void 0:Ys.length)||0)>0)&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç”»é¢æ¯”ä¾‹"}),be?e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const G="landscape",z=L===15?15:10,Pe=`sora-video-${G}-${z}s`,Ue=Ce.find(We=>{var Ye;return((Ye=We.modelId)==null?void 0:Ye.toLowerCase())===Pe})||Ce[0],Xe=(Ue==null?void 0:Ue.id)||"";R(Xe),P("16:9"),qe({modelId:Xe,ratio:"16:9",modelName:(Ue==null?void 0:Ue.name)||`Sora Video (Landscape ${z}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${M==="16:9"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_landscape"}),e.jsx("span",{children:"æ¨ªå±"})]})}),e.jsx("button",{onClick:()=>{const G="portrait",z=L===15?15:10,Pe=`sora-video-${G}-${z}s`,Ue=Ce.find(We=>{var Ye;return((Ye=We.modelId)==null?void 0:Ye.toLowerCase())===Pe})||Ce[0],Xe=(Ue==null?void 0:Ue.id)||"";R(Xe),P("9:16"),qe({modelId:Xe,ratio:"9:16",modelName:(Ue==null?void 0:Ue.name)||`Sora Video (Portrait ${z}s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${M==="9:16"?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"crop_portrait"}),e.jsx("span",{children:"ç«–å±"})]})})]}):e.jsx(rs,{value:M,onChange:G=>{P(G),qe({ratio:G})},options:((f==null?void 0:f.config.supportedRatios)||[]).map(G=>{const[z,Pe]=G.split(":");return{value:G,label:{"21:9":"21:9 è¶…å®½å±","16:9":"16:9 å®½å±","4:3":"4:3 æ ‡å‡†æ¨ªå±","3:2":"3:2 æ¨ªå±","5:4":"5:4 æ¥è¿‘æ­£æ–¹å½¢","1:1":"1:1 æ­£æ–¹å½¢","4:5":"4:5 æ¥è¿‘æ­£æ–¹ç«–å±","2:3":"2:3 ç«–å±","3:4":"3:4 æ ‡å‡†ç«–å±","9:16":"9:16 ç«–å±"}[G]||`${z}:${Pe}`}})})]}),f&&be&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ—¶é•¿"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>{const G=M==="9:16"?"portrait":"landscape",z=`sora-video-${G}-10s`,Pe=Ce.find(Xe=>{var We;return((We=Xe.modelId)==null?void 0:We.toLowerCase())===z})||Ce[0],Ue=(Pe==null?void 0:Pe.id)||"";A(10),R(Ue),qe({duration:10,modelId:Ue,modelName:(Pe==null?void 0:Pe.name)||`Sora Video (${G==="landscape"?"Landscape":"Portrait"} 10s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${L===10?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"10ç§’"})]})}),e.jsx("button",{onClick:()=>{const G=M==="9:16"?"portrait":"landscape",z=`sora-video-${G}-15s`,Pe=Ce.find(Xe=>{var We;return((We=Xe.modelId)==null?void 0:We.toLowerCase())===z})||Ce[0],Ue=(Pe==null?void 0:Pe.id)||"";A(15),R(Ue),qe({duration:15,modelId:Ue,modelName:(Pe==null?void 0:Pe.name)||`Sora Video (${G==="landscape"?"Landscape":"Portrait"} 15s)`})},className:`nodrag py-2 rounded-lg text-[10px] font-bold transition-all border ${L===15?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md border-transparent":"bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-white border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"timer"}),e.jsx("span",{children:"15ç§’"})]})})]})]}),f&&be&&e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"èƒŒæ™¯éŸ³ä¹"}),e.jsx("button",{onClick:()=>S(!le),className:`nodrag relative w-10 h-5 rounded-full transition-all ${le?"bg-gradient-to-r from-purple-500 to-pink-500":"bg-slate-300 dark:bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all ${le?"left-5":"left-0.5"}`})})]}),f&&!be&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["åˆ†è¾¨ç‡",Be?"(æœªé…ç½®)":""]}),e.jsx(rs,{value:T,onChange:G=>{x(G),qe({resolution:G})},options:ye.map(G=>({value:G,label:G})),className:Be?"opacity-50 pointer-events-none":""})]}),e.jsx("button",{onClick:Zs,disabled:O||!Nt||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${O||!Nt?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:O?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"ç”Ÿæˆè§†é¢‘"}),!h&&(W?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",ue,"æ¬¡"]}):k!==null&&k>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[k,"ç§¯åˆ†"]}):null)]})})]}):e.jsx("div",{className:"py-2 px-2",children:K?e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-purple-400 font-medium",children:"æç¤ºè¯ï¼š"}),e.jsx("p",{className:"text-xs text-purple-300 line-clamp-6 whitespace-pre-wrap break-words",children:K})]}):e.jsx("p",{className:"text-xs text-purple-400 text-center italic",children:"åŒå‡»å±•å¼€é…ç½®"})})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${u}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},bo=t.memo(xo),Dr="https://api.waule.com",wo=({data:s,selected:C,id:u})=>{var A,O;const[Q,Ie]=t.useState(!0),[$,ve]=t.useState(s.config.customName||""),[ee,de]=t.useState(!1),[Z,ge]=t.useState(0),[Oe,he]=t.useState(s.config.taskId||""),[ne,se]=t.useState(null),{credits:fe,loading:ce}=Ls({nodeType:"sora_character"}),{setNodes:Ce,getNode:K,setEdges:De}=ts(),we=Fs(),ie=Ds(),R=t.useCallback(r=>{var n;if(!r)return!1;const b=r.type||"",l=((n=r.data)==null?void 0:n.config)||{};if(b==="upload")return(l.uploadedFiles||l.files||[]).some(a=>(a.mimeType||a.type||"").toLowerCase().startsWith("video/"));if(b==="videoPreview")return!!l.url;if(b==="assetSelector"){const o=l.selectedAsset;return((o==null?void 0:o.mimeType)||"").toLowerCase().startsWith("video/")&&!!(o!=null&&o.url)}return b.startsWith("aiVideo")||b==="soraVideo"?!!l.generatedVideoUrl:!1},[]);t.useEffect(()=>{const r=we.filter(n=>n.target===u);if(r.length===0)return;const b=[],l=[];for(const n of r){const o=ie.find(a=>a.id===n.source)||K(n.source);R(o)?b.push(n.id):l.push(n.id)}b.length>1&&(l.push(...b.slice(1)),g.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—1ä¸ªè§†é¢‘è¾“å…¥")),l.length>0&&(De(n=>n.filter(o=>!l.includes(o.id))),l.length>0&&b.length<=1&&r.some(o=>{const a=ie.find(c=>c.id===o.source)||K(o.source);return!R(a)})&&g.error("è§’è‰²ç”Ÿæˆå™¨åªæ¥å—è§†é¢‘è¾“å…¥"))},[we,u,ie,K,De,R]);const M=t.useMemo(()=>we.filter(b=>b.target===u).map(b=>{var n;const l=ie.find(o=>o.id===b.source);return(n=l==null?void 0:l.data)==null?void 0:n.config}),[we,u,ie]),P=t.useMemo(()=>(s.models||[]).filter(b=>{var l;return b.type==="VIDEO_GENERATION"&&((l=b.provider)==null?void 0:l.toLowerCase())==="sora"}),[s.models]),T=((A=P.find(r=>{var b;return(b=r.modelId)==null?void 0:b.includes("landscape-10s")}))==null?void 0:A.id)||((O=P[0])==null?void 0:O.id)||"",x=t.useCallback(r=>{Ce(b=>b.map(l=>l.id===u?{...l,data:{...l.data,config:{...l.data.config,...r}}}:l))},[u,Ce]);t.useEffect(()=>{s.config.characterName&&s.config.customName&&!ee&&(se({id:"",customName:s.config.customName,characterName:s.config.characterName,avatarUrl:s.config.avatarUrl}),ve(s.config.customName))},[s.config.characterName,s.config.customName,s.config.avatarUrl,ee]);const m=t.useMemo(()=>{var b;const r=we.filter(l=>l.target===u);for(const l of r){const n=ie.find(c=>c.id===l.source)||K(l.source);if(!n)continue;const o=n.type||"",a=((b=n.data)==null?void 0:b.config)||{};if(o==="upload"){const w=(a.uploadedFiles||a.files||[]).find(I=>(I.mimeType||I.type||"").toLowerCase().startsWith("video/"));if(w!=null&&w.url)return{url:w.url,thumbnail:w.thumbnail||w.url,name:w.name||w.originalName||"è§†é¢‘"}}if(o==="videoPreview"&&a.url)return{url:a.url,thumbnail:a.thumbnail||a.url,name:a.name||"è§†é¢‘"};if(o==="assetSelector"){const c=a.selectedAsset;if(((c==null?void 0:c.mimeType)||"").toLowerCase().startsWith("video/")&&(c!=null&&c.url))return{url:c.url,thumbnail:c.thumbnail||c.url,name:c.name||"è§†é¢‘"}}if((o.startsWith("aiVideo")||o==="soraVideo")&&a.generatedVideoUrl)return{url:a.generatedVideoUrl,thumbnail:a.generatedVideoUrl,name:"ç”Ÿæˆè§†é¢‘"}}return null},[we,u,ie,M,K]),j=!!m,te=async r=>{let l=0;const n=async()=>{try{l++;const a=(await Me.tasks.getTaskStatus(r)).task;if(ge(a.progress||0),a.status==="SUCCESS"||a.status==="COMPLETED"||a.status==="DONE"){de(!1),ge(100);const c=a.metadata||{},w=c.characterName||"",I=c.avatarUrl||a.resultUrl||"";if(!w){g.error("æœªèƒ½è·å–è§’è‰²åç§°"),x({taskId:""}),he("");return}try{const B=(await Me.soraCharacters.create({customName:$||w,characterName:w,avatarUrl:I,sourceVideoUrl:(m==null?void 0:m.url)||void 0})).character;se({id:B.id,customName:B.customName,characterName:B.characterName,avatarUrl:B.avatarUrl}),x({customName:B.customName,characterName:B.characterName,avatarUrl:B.avatarUrl,taskId:""}),g.success(`è§’è‰²åˆ›å»ºæˆåŠŸ: ${B.customName}`)}catch(D){se({id:"",customName:$||w,characterName:w,avatarUrl:I}),g.error(`è§’è‰²åˆ›å»ºæˆåŠŸä½†ä¿å­˜å¤±è´¥: ${D.message}`)}he(""),setTimeout(()=>ge(0),1e3);return}else if(a.status==="FAILURE"){de(!1),ge(0),x({taskId:""}),g.error(a.errorMessage||"è§’è‰²åˆ›å»ºå¤±è´¥");return}else(a.status==="PROCESSING"||a.status==="PENDING")&&(l<600?setTimeout(n,1e3):(de(!1),ge(0),x({taskId:""}),g.error("åˆ›å»ºè¶…æ—¶")))}catch{de(!1),ge(0),x({taskId:""}),g.error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥")}};n()},L=async()=>{var b,l,n,o,a;if(!m){g.error("è¯·å…ˆè¿æ¥è§†é¢‘è¾“å…¥");return}if(!$.trim()){g.error("è¯·è¾“å…¥è§’è‰²è‡ªå®šä¹‰åç§°");return}if(!T){g.error("Soraæ¨¡å‹æœªé…ç½®");return}const r=m.url;if(!r){g.error("æœªæ‰¾åˆ°è§†é¢‘è¾“å…¥");return}try{const c=await Me.soraCharacters.getByCustomName($.trim());if(c!=null&&c.character){g.error(`è‡ªå®šä¹‰åç§°"${$.trim()}"å·²è¢«ä½¿ç”¨ï¼Œè¯·æ›´æ¢åç§°`);return}}catch{}de(!0),ge(5),se(null);try{const c=await Me.tasks.createVideoTask({modelId:T,prompt:"",ratio:"16:9",referenceImages:[r],generationType:"è§’è‰²åˆ›å»º",sourceNodeId:u,metadata:{isCharacterCreation:!0,customName:$.trim(),referenceType:"video",nodeType:"sora_character"}}),w=c.taskId,I=c.creditsCharged||0;if(he(w),x({customName:$.trim(),taskId:w}),I>0)try{const{useAuthStore:D}=await gs(async()=>{const{useAuthStore:v}=await import("./index-Cp0uMTfX.js").then(p=>p.f);return{useAuthStore:v}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:B}=D.getState();await B(),g.success(`è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${I} ç§¯åˆ†ï¼‰`)}catch{g.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤")}else g.success("è§’è‰²åˆ›å»ºä»»åŠ¡å·²æäº¤");te(w)}catch(c){if(de(!1),ge(0),((b=c.response)==null?void 0:b.status)===403){const w=((n=(l=c.response)==null?void 0:l.data)==null?void 0:n.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤åŠŸèƒ½";g.error(w)}else g.error(`æäº¤å¤±è´¥: ${((a=(o=c.response)==null?void 0:o.data)==null?void 0:a.error)||c.message}`)}};return t.useEffect(()=>{Oe&&!ee&&(de(!0),te(Oe))},[]),e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:300},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:"video-input",className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between cursor-pointer select-none rounded-t-2xl border-b border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",onClick:()=>Ie(!Q),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"face"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label||"SORAè§’è‰²ç”Ÿæˆå™¨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"}),e.jsx("span",{className:`material-symbols-outlined text-slate-400 dark:text-white/50 transition-transform text-sm ${Q?"rotate-180":""}`,children:"expand_more"})]})]}),Q&&e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${j?"bg-green-500":"bg-slate-300 dark:bg-white/20"}`}),e.jsx("span",{className:j?"text-green-600 dark:text-green-400":"text-slate-400 dark:text-white/50",children:j?"å·²è¿æ¥è§†é¢‘":"è¯·è¿æ¥è§†é¢‘è¾“å…¥"})]}),m&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-slate-200 dark:border-white/10",children:[e.jsx("video",{src:`${m.url.startsWith("http")||m.url.startsWith("data:")?m.url:Dr+m.url}`,className:"w-full h-24 object-cover bg-black",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute bottom-1 left-1 bg-black/70 text-white text-[10px] px-1.5 py-0.5 rounded",children:m.name}),e.jsxs("div",{className:"absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx("span",{className:"material-symbols-outlined text-xs",children:"videocam"}),"å·²è¿æ¥"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§’è‰²è‡ªå®šä¹‰åç§°"}),e.jsx("input",{type:"text",value:$,onChange:r=>ve(r.target.value),placeholder:"è¾“å…¥ä¾¿äºè®°å¿†çš„åç§°...",className:"nodrag w-full px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-white/5 text-slate-700 dark:text-white placeholder-slate-400 dark:placeholder-white/30 focus:outline-none focus:border-purple-400 dark:focus:border-purple-400/50 transition-colors",disabled:ee})]}),ne&&!ee&&e.jsx("div",{className:"p-3 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[ne.avatarUrl?e.jsx("div",{className:"w-14 h-14 rounded-full overflow-hidden border-2 border-purple-400 dark:border-purple-400/50 flex-shrink-0",children:e.jsx("img",{src:ne.avatarUrl.startsWith("http")?ne.avatarUrl:`${Dr}${ne.avatarUrl}`,alt:"è§’è‰²å¤´åƒ",className:"w-full h-full object-cover object-top",onError:r=>{r.target.style.display="none"}})}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-200 dark:bg-white/10 flex items-center justify-center border-2 border-purple-400 dark:border-purple-400/50 flex-shrink-0",children:e.jsx("span",{className:"material-symbols-outlined text-slate-500 dark:text-white/50",children:"face"})}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsx("div",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:ne.customName}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-white/50 font-mono truncate",children:ne.characterName})]}),e.jsx("span",{className:"material-symbols-outlined text-green-500 dark:text-green-400 text-lg flex-shrink-0",children:"check_circle"})]})}),ee&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-white/50",children:[e.jsx("span",{children:"åˆ›å»ºä¸­..."}),e.jsxs("span",{children:[Z,"%"]})]}),e.jsx("div",{className:"h-1.5 bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300",style:{width:`${Z}%`}})})]}),e.jsx("button",{onClick:L,disabled:ee||!j||!$.trim()||s._canEdit===!1,className:`nodrag w-full py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 ${ee||!j||!$.trim()||s._canEdit===!1?"bg-slate-300 dark:bg-white/10 text-slate-500 dark:text-white/30 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg active:scale-95"}`,children:ee?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm animate-spin",children:"progress_activity"}),e.jsx("span",{children:"åˆ›å»ºä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"auto_awesome"}),e.jsx("span",{children:"åˆ›å»ºè§’è‰²"}),!ce&&fe!==null&&fe>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[10px]",children:[fe,"ç§¯åˆ†"]})]})}),e.jsx("div",{className:"text-[10px] text-slate-400 dark:text-white/40 text-center",children:"è¿æ¥åŒ…å«äººç‰©çš„è§†é¢‘ï¼Œè‡ªåŠ¨æå–è§’è‰²ä¿¡æ¯"})]})]})},yo=t.memo(wo),ko=({data:s,id:C,selected:u})=>{const{setNodes:Q,getNode:Ie}=ts(),[$,ve]=t.useState(s.config.modelId||""),[ee,de]=t.useState(s.config.voiceId||""),[Z,ge]=t.useState(s.config.text||"æ­å–œï¼Œå·²æˆåŠŸå¤åˆ»å¹¶åˆæˆäº†å±äºè‡ªå·±çš„å£°éŸ³ï¼"),[Oe,he]=t.useState(s.config.status||""),[ne,se]=t.useState(!1),[fe,ce]=t.useState([]),[Ce]=t.useState(void 0),[K]=t.useState("mp3"),[De]=t.useState(void 0),[we]=t.useState(void 0),[ie]=t.useState(void 0),[R]=t.useState("hex");t.useEffect(()=>{s.config.modelId&&!$&&ve(s.config.modelId)},[s.config.modelId,$]),t.useEffect(()=>{!ee&&s.config.voiceId&&de(String(s.config.voiceId))},[s.config.voiceId,ee]),t.useEffect(()=>{if(!$){const m=(s.models||[]).filter(j=>j.type==="AUDIO_SYNTHESIS"&&j.isActive)[0];m&&(ve(m.id),P({modelId:m.id}))}},[s.models,$]),t.useEffect(()=>{M()},[]);const M=async()=>{try{const x=await Me.get("/ai/audio/voices"),m=(x==null?void 0:x.data)??x;ce(Array.isArray(m)?m:[])}catch{}},P=x=>{Ie(C)&&Q(j=>j.map(te=>te.id===C?{...te,data:{...te.data,config:{...te.data.config,...x}}}:te))},T=async()=>{var te,L,A,O;const x=(ee||s.config.voiceId||"").trim(),m=(Z||"").trim();if(!x||!m){g.error("è¯·å…ˆé€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let j=$;if(!j){const r=(s.models||[]).filter(b=>b.type==="AUDIO_SYNTHESIS"&&b.isActive);if(r[0])j=r[0].id,ve(j),P({modelId:j});else{g.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}se(!0);try{if(Oe!=="OK"){let n=0,o=!1;for(;n<12;){n++;try{const a=await Me.ai.audio.queryVoice({voiceId:x,modelId:j}),c=((te=a.data)==null?void 0:te.status)||a.status;if(he(c),P({status:c}),c==="OK"){o=!0;break}if(c==="UNDEPLOYED")break}catch{}await new Promise(a=>setTimeout(a,2500))}if(!o){g.error("éŸ³è‰²æœªå°±ç»ªï¼Œç¨åé‡è¯•"),se(!1);return}}const r=await Me.ai.audio.synthesize({modelId:j,voiceId:x,text:m,format:K,sampleRate:Ce,volume:we,rate:De,pitch:ie,output_format:R}),b=((L=r.data)==null?void 0:L.url)||r.url;try{const l=b&&b.startsWith("http")?b:`https://api.waule.com${b}`;let n;l?n=await Me.assets.proxyDownload(l):n=await(await fetch(b,{mode:"cors"})).arrayBuffer();const o=URL.createObjectURL(new Blob([n],{type:K==="wav"?"audio/wav":"audio/mpeg"}));P({outputUrl:o})}catch{P({outputUrl:b})}g.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(r){const b=((O=(A=r==null?void 0:r.response)==null?void 0:A.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"è¯­éŸ³åˆæˆå¤±è´¥";/url error/i.test(b)?g.error("éŸ³é¢‘URLä¸å¯è¾¾æˆ–ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤ä¸Šä¼ éŸ³é¢‘å…¬ç½‘å¯è®¿é—®"):/è®¿é—®è¢«æ‹’ç»|Access denied/i.test(b)?g.error("è®¿é—®è¢«æ‹’ç»ï¼šè¯·ç¡®è®¤API Keyæœ‰æ•ˆã€è´¦å·çŠ¶æ€æ­£å¸¸ã€ä¸”å·²å¼€é€šå¯¹åº”CosyVoiceç‰ˆæœ¬ï¼ˆv3/v3-pluséœ€ç”³è¯·è·æ‰¹ï¼‰"):g.error(b)}se(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:$,onChange:x=>{ve(x),P({modelId:x})},options:(s.models||[]).filter(x=>x.type==="AUDIO_SYNTHESIS"&&x.isActive).map(x=>({value:x.id,label:x.name}))})]}),fe.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æˆ‘çš„éŸ³è‰² (",fe.length,")"]}),e.jsx(rs,{value:ee||"",onChange:x=>{de(x),P({voiceId:x})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...fe.map(x=>({value:x.voiceId,label:x.prefix||x.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"Voice ID"}),e.jsx("input",{value:ee,onChange:x=>{const m=x.target.value;de(m),P({voiceId:m})},placeholder:"è¾“å…¥ Voice ID",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{value:Z,onChange:x=>{ge(x.target.value),P({text:x.target.value})},placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsx("button",{onClick:T,disabled:ne||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${ne?"bg-gray-600 dark:bg-gray-700 text-white":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:ne?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"}),s.config.outputUrl&&e.jsx("audio",{controls:!0,src:s.config.outputUrl,className:"w-full"})]}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},vo=t.memo(ko),No=({data:s,id:C,selected:u})=>{const{setNodes:Q,setEdges:Ie,getNode:$}=ts(),[ve,ee]=t.useState(s.config.modelId||""),[de,Z]=t.useState(s.config.voiceId||""),[ge,Oe]=t.useState(s.config.voiceName||""),[he,ne]=t.useState(s.config.cloneAudioUrl||""),[se,fe]=t.useState(s.config.promptAudioUrl||""),[ce,Ce]=t.useState(s.config.promptText||""),[K,De]=t.useState(s.config.previewText||"æ¬¢è¿ä½¿ç”¨ MiniMax è¯­éŸ³å…‹éš†æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆæˆç¤ºä¾‹ã€‚"),[we,ie]=t.useState(!1);t.useEffect(()=>{const j=()=>`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;if(!de||!de.startsWith("Waule")&&!de.startsWith("Aivider")||de.startsWith("minimax-")){const te=j();Z(te),T({voiceId:te})}},[de]);const R=dr(j=>j.edges.filter(te=>te.target===C)),M=Ds(),P=t.useRef("");t.useEffect(()=>{if(!ve){const te=(s.models||[]).filter(L=>{if(L.type!=="AUDIO_SYNTHESIS"||!L.isActive)return!1;const A=String(L.provider||"").toLowerCase();return A.includes("minimaxi")||A.includes("hailuo")||A.includes("æµ·èº")})[0];te&&(ee(te.id),T({modelId:te.id}))}},[s.models,ve]),t.useEffect(()=>{try{const j=R.map(A=>`${A.id}-${A.source}-${A.targetHandle||""}`).sort().join(",");if(j===P.current)return;P.current=j;let te="",L="";for(const A of R){const O=$(A.source);if(!O)continue;const r=O.data||{},b=String(O.type||"").toLowerCase(),n=(()=>{var o,a;if(b==="upload"){const c=(((o=r.config)==null?void 0:o.uploadedFiles)||[]).find(w=>{const I=((w==null?void 0:w.type)||"").toUpperCase(),D=((w==null?void 0:w.mimeType)||"").toLowerCase();return I==="AUDIO"||D.startsWith("audio/")});return c==null?void 0:c.url}if(b==="assetSelector"){const c=(a=r.config)==null?void 0:a.selectedAsset,w=((c==null?void 0:c.type)||"").toUpperCase(),I=((c==null?void 0:c.mimeType)||"").toLowerCase();if(w==="AUDIO"||I.startsWith("audio/"))return c==null?void 0:c.url}return null})();n&&(A.targetHandle===`${C}-target-clone`&&(te=n),A.targetHandle===`${C}-target-prompt`&&(L=n))}te!==he&&(ne(te),T({cloneAudioUrl:te})),L!==se&&(fe(L),T({promptAudioUrl:L}))}catch{}},[R,M,$,C,he,se]);const T=j=>{Q(te=>te.map(L=>L.id===C?{...L,data:{...L.data,config:{...L.data.config,...j}}}:L))},x=async()=>{var j,te;if(!de||!ge){g.error("è¯·è¾“å…¥éŸ³è‰²åç§°");return}try{await Me.ai.audio.voices.add({voiceId:de,prefix:ge}),g.success("éŸ³è‰²å·²ä¿å­˜åˆ°è‡ªå®šä¹‰éŸ³è‰²åˆ—è¡¨")}catch(L){const A=((te=(j=L==null?void 0:L.response)==null?void 0:j.data)==null?void 0:te.message)||(L==null?void 0:L.message)||"ä¿å­˜å¤±è´¥";g.error(A)}},m=async()=>{var j,te,L;if(!ve||!ge||!he){g.error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šæ¨¡å‹ã€éŸ³è‰²åç§°ã€å…‹éš†éŸ³é¢‘");return}ie(!0),g.success("æ­£åœ¨æäº¤å…‹éš†ä»»åŠ¡...");try{const O=(s.models||[]).find(c=>c.id===ve),r=(O==null?void 0:O.modelId)||"speech-2.6-hd";let b=he;b.startsWith("http");const l=`Waule${Math.floor(Math.random()*1e16).toString().padStart(16,"0")}`;Z(l),T({voiceId:l});const n=await Me.ai.audio.createVoice({modelId:ve,targetModel:r,prefix:ge,url:b,promptUrl:se||void 0,promptText:ce||void 0,voiceId:l,previewText:K||void 0}),o=(n==null?void 0:n.data)||n,a=o==null?void 0:o.sampleUrl;if(a){T({sampleUrl:a,status:"OK",voiceName:ge}),g.success("å…‹éš†æˆåŠŸï¼Œè¯•å¬éŸ³é¢‘å·²ç”Ÿæˆ");const c=$(C);if(c){const w=`audioPreview-${Date.now()}`,I={id:w,type:"audioPreview",position:{x:c.position.x+450,y:c.position.y},data:{label:"éŸ³é¢‘é¢„è§ˆ",type:"audioPreview",audioUrl:a,config:{audioUrl:a,title:`${ge} - è¯•å¬`},models:s.models,createdBy:(j=c.data)==null?void 0:j.createdBy}};Q(B=>[...B,I]);const D={id:`e-${C}-source-${w}-target`,source:C,sourceHandle:`${C}-source`,target:w,targetHandle:`${w}-target`,type:"aurora"};Ie(B=>[...B,D])}}else T({status:"OK",voiceName:ge}),g.success("å…‹éš†ä»»åŠ¡å·²æäº¤")}catch(A){const O=((L=(te=A==null?void 0:A.response)==null?void 0:te.data)==null?void 0:L.message)||(A==null?void 0:A.message)||"åˆ›å»ºå¤±è´¥";g.error(O)}ie(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target-clone`,label:"å…‹éš†éŸ³é¢‘",style:{top:"30%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target-prompt`,label:"æç¤ºéŸ³é¢‘",style:{top:"50%"},className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"éŸ³è‰²å…‹éš†"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:ve,onChange:j=>{ee(j),T({modelId:j})},options:(s.models||[]).filter(j=>{if(j.type!=="AUDIO_SYNTHESIS"||!j.isActive)return!1;if(Array.isArray(j.capabilities))return j.capabilities.some(L=>L.capability==="éŸ³è‰²å…‹éš†"&&L.supported);const te=String(j.provider||"").toLowerCase();return te.includes("minimaxi")||te.includes("hailuo")||te.includes("æµ·èº")}).map(j=>({value:j.id,label:j.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:ge,onChange:j=>{Oe(j.target.value),T({voiceName:j.target.value})},placeholder:"è¾“å…¥éŸ³è‰²åç§°",className:"nodrag flex-1 p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",onMouseDown:j=>j.stopPropagation()}),e.jsx("button",{onClick:x,disabled:!de||!ge,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all whitespace-nowrap ${!de||!ge?"bg-gray-600 dark:bg-gray-700 text-white opacity-50":"bg-gradient-to-r from-green-500 to-emerald-500 dark:from-green-600/50 dark:to-emerald-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsxs("div",{className:"space-y-2 bg-slate-100/50 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"å…‹éš†éŸ³é¢‘:"}),e.jsx("span",{className:he?"text-green-500 dark:text-green-400":"text-red-500 dark:text-red-400",children:he?"âœ“ å·²è¿æ¥":"âœ• æœªè¿æ¥"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"æç¤ºéŸ³é¢‘:"}),e.jsx("span",{className:se?"text-green-500 dark:text-green-400":"text-slate-400 dark:text-slate-500",children:se?"âœ“ å·²è¿æ¥":"å¯é€‰"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºæ–‡æœ¬ (å¯é€‰)"}),e.jsx("textarea",{value:ce,onChange:j=>{Ce(j.target.value),T({promptText:j.target.value})},placeholder:"è¾“å…¥æç¤ºéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:j=>j.stopPropagation()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{value:K,onChange:j=>{De(j.target.value),T({previewText:j.target.value})},placeholder:"è¾“å…¥ç”¨äºç”Ÿæˆè¯•å¬éŸ³é¢‘çš„æ–‡æœ¬...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2,onMouseDown:j=>j.stopPropagation()})]}),e.jsx("button",{onClick:m,disabled:we||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${we||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white opacity-50 cursor-wait":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:we?"å…‹éš†ä¸­...":"å¼€å§‹å…‹éš†"})]}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},jo=t.memo(No),Lr=[{id:"male-qn-qingse",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´"},{id:"male-qn-jingying",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´"},{id:"male-qn-badao",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´"},{id:"male-qn-daxuesheng",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ"},{id:"female-shaonv",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³"},{id:"female-yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§"},{id:"female-chengshu",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§"},{id:"female-tianmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§"},{id:"male-qn-qingse-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’æ¶©é’å¹´(beta)"},{id:"male-qn-jingying-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç²¾è‹±é’å¹´(beta)"},{id:"male-qn-badao-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“é’å¹´(beta)"},{id:"male-qn-daxuesheng-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) é’å¹´å¤§å­¦ç”Ÿ(beta)"},{id:"female-shaonv-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å°‘å¥³(beta)"},{id:"female-yujie-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) å¾¡å§(beta)"},{id:"female-chengshu-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) æˆç†Ÿå¥³æ€§(beta)"},{id:"female-tianmei-jingpin",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³æ€§(beta)"},{id:"clever_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) èªæ˜ç”·ç«¥"},{id:"cute_boy",label:"ä¸­æ–‡ (æ™®é€šè¯) å¯çˆ±ç”·ç«¥"},{id:"lovely_girl",label:"ä¸­æ–‡ (æ™®é€šè¯) èŒèŒå¥³ç«¥"},{id:"cartoon_pig",label:"ä¸­æ–‡ (æ™®é€šè¯) å¡é€šçŒªå°çª"},{id:"bingjiao_didi",label:"ä¸­æ–‡ (æ™®é€šè¯) ç—…å¨‡å¼Ÿå¼Ÿ"},{id:"junlang_nanyou",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿Šæœ—ç”·å‹"},{id:"chunzhen_xuedi",label:"ä¸­æ–‡ (æ™®é€šè¯) çº¯çœŸå­¦å¼Ÿ"},{id:"lengdan_xiongzhang",label:"ä¸­æ–‡ (æ™®é€šè¯) å†·æ·¡å­¦é•¿"},{id:"badao_shaoye",label:"ä¸­æ–‡ (æ™®é€šè¯) éœ¸é“å°‘çˆ·"},{id:"tianxin_xiaoling",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œå¿ƒå°ç²"},{id:"qiaopi_mengmei",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¿çš®èŒå¦¹"},{id:"wumei_yujie",label:"ä¸­æ–‡ (æ™®é€šè¯) å¦©åªšå¾¡å§"},{id:"diadia_xuemei",label:"ä¸­æ–‡ (æ™®é€šè¯) å—²å—²å­¦å¦¹"},{id:"danya_xuejie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ·¡é›…å­¦å§"},{id:"Chinese (Mandarin)_Reliable_Executive",label:"ä¸­æ–‡ (æ™®é€šè¯) æ²‰ç¨³é«˜ç®¡"},{id:"Chinese (Mandarin)_News_Anchor",label:"ä¸­æ–‡ (æ™®é€šè¯) æ–°é—»å¥³å£°"},{id:"Chinese (Mandarin)_Mature_Woman",label:"ä¸­æ–‡ (æ™®é€šè¯) å‚²å¨‡å¾¡å§"},{id:"Chinese (Mandarin)_Unrestrained_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) ä¸ç¾é’å¹´"},{id:"Arrogant_Miss",label:"ä¸­æ–‡ (æ™®é€šè¯) åš£å¼ å°å§"},{id:"Robot_Armor",label:"ä¸­æ–‡ (æ™®é€šè¯) æœºæ¢°æˆ˜ç”²"},{id:"Chinese (Mandarin)_Kind-hearted_Antie",label:"ä¸­æ–‡ (æ™®é€šè¯) çƒ­å¿ƒå¤§å©¶"},{id:"Chinese (Mandarin)_HK_Flight_Attendant",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸¯æ™®ç©ºå§"},{id:"Chinese (Mandarin)_Humorous_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) æç¬‘å¤§çˆ·"},{id:"Chinese (Mandarin)_Gentleman",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æ¶¦ç”·å£°"},{id:"Chinese (Mandarin)_Warm_Bestie",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–é—ºèœœ"},{id:"Chinese (Mandarin)_Male_Announcer",label:"ä¸­æ–‡ (æ™®é€šè¯) æ’­æŠ¥ç”·å£°"},{id:"Chinese (Mandarin)_Sweet_Lady",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”œç¾å¥³å£°"},{id:"Chinese (Mandarin)_Southern_Young_Man",label:"ä¸­æ–‡ (æ™®é€šè¯) å—æ–¹å°å“¥"},{id:"Chinese (Mandarin)_Wise_Women",label:"ä¸­æ–‡ (æ™®é€šè¯) é˜…å†å§å§"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Warm_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æš–å°‘å¥³"},{id:"Chinese (Mandarin)_Kind-hearted_Elder",label:"ä¸­æ–‡ (æ™®é€šè¯) èŠ±ç”²å¥¶å¥¶"},{id:"Chinese (Mandarin)_Cute_Spirit",label:"ä¸­æ–‡ (æ™®é€šè¯) æ†¨æ†¨èŒå…½"},{id:"Chinese (Mandarin)_Radio_Host",label:"ä¸­æ–‡ (æ™®é€šè¯) ç”µå°ç”·ä¸»æ’­"},{id:"Chinese (Mandarin)_Lyrical_Voice",label:"ä¸­æ–‡ (æ™®é€šè¯) æŠ’æƒ…ç”·å£°"},{id:"Chinese (Mandarin)_Straightforward_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) ç‡çœŸå¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Sincere_Adult",label:"ä¸­æ–‡ (æ™®é€šè¯) çœŸè¯šé’å¹´"},{id:"Chinese (Mandarin)_Gentle_Senior",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸©æŸ”å­¦å§"},{id:"Chinese (Mandarin)_Stubborn_Friend",label:"ä¸­æ–‡ (æ™®é€šè¯) å˜´ç¡¬ç«¹é©¬"},{id:"Chinese (Mandarin)_Crisp_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…è„†å°‘å¥³"},{id:"Chinese (Mandarin)_Pure-hearted_Boy",label:"ä¸­æ–‡ (æ™®é€šè¯) æ¸…æ¾ˆé‚»å®¶å¼Ÿå¼Ÿ"},{id:"Chinese (Mandarin)_Soft_Girl",label:"ä¸­æ–‡ (æ™®é€šè¯) è½¯è½¯å¥³å­©"},{id:"Cantonese_ProfessionalHostï¼ˆF)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šå¥³ä¸»æŒ"},{id:"Cantonese_GentleLady",label:"ä¸­æ–‡ (ç²¤è¯­) æ¸©æŸ”å¥³å£°"},{id:"Cantonese_ProfessionalHostï¼ˆM)",label:"ä¸­æ–‡ (ç²¤è¯­) ä¸“ä¸šç”·ä¸»æŒ"},{id:"Cantonese_PlayfulMan",label:"ä¸­æ–‡ (ç²¤è¯­) æ´»æ³¼ç”·å£°"},{id:"Cantonese_CuteGirl",label:"ä¸­æ–‡ (ç²¤è¯­) å¯çˆ±å¥³å­©"},{id:"Cantonese_KindWoman",label:"ä¸­æ–‡ (ç²¤è¯­) å–„è‰¯å¥³å£°"},{id:"Santa_Claus",label:"è‹±æ–‡ Santa Claus"},{id:"Grinch",label:"è‹±æ–‡ Grinch"},{id:"Rudolph",label:"è‹±æ–‡ Rudolph"},{id:"Arnold",label:"è‹±æ–‡ Arnold"},{id:"Charming_Santa",label:"è‹±æ–‡ Charming Santa"},{id:"Charming_Lady",label:"è‹±æ–‡ Charming Lady"},{id:"Sweet_Girl",label:"è‹±æ–‡ Sweet Girl"},{id:"Cute_Elf",label:"è‹±æ–‡ Cute Elf"},{id:"Attractive_Girl",label:"è‹±æ–‡ Attractive Girl"},{id:"Serene_Woman",label:"è‹±æ–‡ Serene Woman"},{id:"English_Trustworthy_Man",label:"è‹±æ–‡ Trustworthy Man"},{id:"English_Graceful_Lady",label:"è‹±æ–‡ Graceful Lady"},{id:"English_Aussie_Bloke",label:"è‹±æ–‡ Aussie Bloke"},{id:"English_Whispering_girl",label:"è‹±æ–‡ Whispering girl"},{id:"English_Diligent_Man",label:"è‹±æ–‡ Diligent Man"},{id:"English_Gentle-voiced_man",label:"è‹±æ–‡ Gentle-voiced man"},{id:"Japanese_IntellectualSenior",label:"æ—¥æ–‡ Intellectual Senior"},{id:"Japanese_DecisivePrincess",label:"æ—¥æ–‡ Decisive Princess"},{id:"Japanese_LoyalKnight",label:"æ—¥æ–‡ Loyal Knight"},{id:"Japanese_DominantMan",label:"æ—¥æ–‡ Dominant Man"},{id:"Japanese_SeriousCommander",label:"æ—¥æ–‡ Serious Commander"},{id:"Japanese_ColdQueen",label:"æ—¥æ–‡ Cold Queen"},{id:"Japanese_DependableWoman",label:"æ—¥æ–‡ Dependable Woman"},{id:"Japanese_GentleButler",label:"æ—¥æ–‡ Gentle Butler"},{id:"Japanese_KindLady",label:"æ—¥æ–‡ Kind Lady"},{id:"Japanese_CalmLady",label:"æ—¥æ–‡ Calm Lady"},{id:"Japanese_OptimisticYouth",label:"æ—¥æ–‡ Optimistic Youth"},{id:"Japanese_GenerousIzakayaOwner",label:"æ—¥æ–‡ Generous Izakaya Owner"},{id:"Japanese_SportyStudent",label:"æ—¥æ–‡ Sporty Student"},{id:"Japanese_InnocentBoy",label:"æ—¥æ–‡ Innocent Boy"},{id:"Japanese_GracefulMaiden",label:"æ—¥æ–‡ Graceful Maiden"},{id:"Korean_SweetGirl",label:"éŸ©æ–‡ Sweet Girl"},{id:"Korean_CheerfulBoyfriend",label:"éŸ©æ–‡ Cheerful Boyfriend"},{id:"Korean_EnchantingSister",label:"éŸ©æ–‡ Enchanting Sister"},{id:"Korean_ShyGirl",label:"éŸ©æ–‡ Shy Girl"},{id:"Korean_ReliableSister",label:"éŸ©æ–‡ Reliable Sister"},{id:"Korean_StrictBoss",label:"éŸ©æ–‡ Strict Boss"}],Io=({data:s,id:C,selected:u})=>{const{setNodes:Q,getNode:Ie,setEdges:$}=ts(),[ve,ee]=t.useState(s.config.modelId||""),[de,Z]=t.useState(s.config.voiceId||""),[ge,Oe]=t.useState(s.config.text||"ä½ å¥½ï¼Œè¿™æ˜¯è¯­éŸ³åˆæˆé¢„è§ˆ"),he=t.useRef(null),[ne,se]=t.useState("zh"),fe=t.useRef(null),ce=t.useRef(null),Ce=t.useRef(null),K=t.useRef(null),De=t.useRef(null),[we,ie]=t.useState([]),R=async()=>{try{const l=await Me.ai.audio.voices.list(),n=(l==null?void 0:l.data)??l;ie(Array.isArray(n)?n:[])}catch{}},M=async()=>{try{const l=window.AudioContext||window.webkitAudioContext;K.current||(K.current=new l);const n=K.current;n.state==="suspended"&&await n.resume()}catch{}},[P,T]=t.useState(!1),[x]=t.useState(""),[m]=t.useState(void 0),[j]=t.useState("mp3"),[te]=t.useState(void 0),[L]=t.useState(void 0),[A]=t.useState(void 0),[O]=t.useState("url");t.useEffect(()=>{s.config.modelId&&!ve&&ee(s.config.modelId)},[s.config.modelId,ve]),t.useEffect(()=>{!de&&s.config.voiceId&&Z(String(s.config.voiceId))},[s.config.voiceId,de]),t.useEffect(()=>{if(!ve){const n=(s.models||[]).filter(o=>o.type==="AUDIO_SYNTHESIS"&&o.isActive)[0];n&&(ee(n.id),r({modelId:n.id}))}},[s.models,ve]),t.useEffect(()=>{R()},[]),t.useEffect(()=>{ne==="custom"&&R()},[ne]),t.useEffect(()=>{const l=he.current;l&&(l.style.height="auto",l.style.height=`${l.scrollHeight}px`)},[ge]);const r=l=>{Ie(C)&&Q(o=>o.map(a=>a.id===C?{...a,data:{...a.data,config:{...a.data.config,...l}}}:a))},b=async(l=!1)=>{var c,w,I,D,B;let n=(de||s.config.voiceId||"").trim();if(l&&!n)if(ne==="custom"){const v=we[0];v&&(n=String(v.voiceId),Z(n),r({voiceId:n}))}else{const v=Lr.find(p=>{const d=p.label;return ne==="zh"?d.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):ne==="yue"?d.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):ne==="en"?d.startsWith("è‹±æ–‡ "):ne==="ja"?d.startsWith("æ—¥æ–‡ "):ne==="ko"?d.startsWith("éŸ©æ–‡ "):!0});v&&(n=v.id,Z(n),r({voiceId:n}))}const o=l?"å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼":(ge||"").trim();if(!n||!o){g.error("è¯·é€‰æ‹©éŸ³è‰²å¹¶è¾“å…¥æ–‡æœ¬");return}let a=ve;if(!a){const v=(s.models||[]).filter(p=>p.type==="AUDIO_SYNTHESIS"&&p.isActive);if(v[0])a=v[0].id,ee(a),r({modelId:a});else{g.error("è¯·å…ˆåœ¨åå°é…ç½®è¯­éŸ³åˆæˆæ¨¡å‹");return}}T(!0);try{l&&await M();const v={};if(x)try{v.voice_modify={emotion:x}}catch{}const p=await Me.ai.audio.synthesize({modelId:a,voiceId:n,text:o,format:j,sampleRate:m,volume:L,rate:te,pitch:A,output_format:"hex",language_boost:"auto",audio_setting:{channel:2},...v}),d=((c=p==null?void 0:p.data)==null?void 0:c.url)||(p==null?void 0:p.url),E=window.location.origin,X=(h=>{if(!h)return"";try{if(h.startsWith("http://localhost:3000")||h.startsWith("http://127.0.0.1:3000")){const W=new URL(h).pathname;return`${E}${W}`}return h.startsWith("http")?h:h.startsWith("/")?`${E}${h}`:`${E}/${h}`}catch{return h}})(d);let J;const F=h=>{if(h.length>=12){if(h[0]===82&&h[1]===73&&h[2]===70&&h[3]===70&&h[8]===87&&h[9]===65&&h[10]===86&&h[11]===69)return"audio/wav";if(h[0]===73&&h[1]===68&&h[2]===51||h[0]===255&&(h[1]&224)===224)return"audio/mpeg"}return j==="wav"?"audio/wav":"audio/mpeg"},ae=h=>h.length>=12&&h[4]===102&&h[5]===116&&h[6]===121&&h[7]===112,oe=h=>h.length>=4&&h[0]===79&&h[1]===103&&h[2]===103&&h[3]===83,le=h=>h.length>=4&&h[0]===102&&h[1]===76&&h[2]===97&&h[3]===67,S=new Uint8Array(J||new ArrayBuffer(0));let f=F(S);(!f||f==="application/octet-stream")&&(ae(S)?f="audio/mp4":oe(S)?f="audio/ogg":le(S)&&(f="audio/flac"));let k;if(l){if(De.current){try{De.current.stop()}catch{}De.current.disconnect(),De.current=null}const h=ce.current||new Audio;h.preload="auto",h.autoplay=!0,h.playsInline=!0,h.crossOrigin="anonymous",ce.current=h;let W=!1;const ue=(q,be,Se=1500)=>new Promise(ye=>{let _e=!1;const je=()=>{_e||(_e=!0,Re(),ye(!0))},Te=()=>{_e||(_e=!0,Re(),ye(!1))},Re=()=>{q.removeEventListener(be,je),q.removeEventListener("error",Te)};q.addEventListener(be,je),q.addEventListener("error",Te),setTimeout(()=>{Te()},Se)});try{const q=ye=>{const _e=(ye||"").replace(/\s+/g,""),je=new Uint8Array(Math.floor(_e.length/2));for(let Te=0;Te<je.length;Te++)je[Te]=parseInt(_e.substr(Te*2,2),16);return je},be=((w=p==null?void 0:p.data)==null?void 0:w.hex)||(p==null?void 0:p.hex),Se=be?q(String(be)).buffer:void 0;if(Se&&Se.byteLength>0){const ye=new Uint8Array(Se),_e=F(ye),je=new Blob([Se],{type:_e}),Te=URL.createObjectURL(je);if(Ce.current)try{URL.revokeObjectURL(Ce.current)}catch{}if(Ce.current=Te,h.src=Te,h.load(),!await ue(h,"canplay"))throw new Error("blob not ready");await h.play(),W=!0}else throw new Error("no hex")}catch{W=!1}if(!W){try{const q=ye=>{const _e=(ye||"").replace(/\s+/g,""),je=new Uint8Array(Math.floor(_e.length/2));for(let Te=0;Te<je.length;Te++)je[Te]=parseInt(_e.substr(Te*2,2),16);return je},be=((I=p==null?void 0:p.data)==null?void 0:I.hex)||(p==null?void 0:p.hex),Se=be?q(String(be)).buffer:void 0;if(!Se||Se.byteLength===0){const ye=await Me.assets.proxyDownload(X);if(!ye||ye.byteLength===0)throw new Error("éŸ³é¢‘æ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´");const _e=new Uint8Array(ye),je=F(_e),Te=new Blob([ye],{type:je}),Re=URL.createObjectURL(Te);if(Ce.current)try{URL.revokeObjectURL(Ce.current)}catch{}if(Ce.current=Re,h.src=Re,h.load(),!await ue(h,"canplay"))throw new Error("blob not ready");await h.play(),W=!0}else{const ye=new Uint8Array(Se),_e=F(ye),je=new Blob([Se],{type:_e}),Te=URL.createObjectURL(je);if(Ce.current)try{URL.revokeObjectURL(Ce.current)}catch{}if(Ce.current=Te,h.src=Te,h.load(),!await ue(h,"canplay"))throw new Error("blob not ready");await h.play(),W=!0}}catch{}if(!W)throw new Error("éŸ³é¢‘æ‹‰å–å¤±è´¥")}}else try{const h=await Me.assets.proxyDownload(X),W=new Uint8Array(h),ue=F(W);k=URL.createObjectURL(new Blob([h],{type:ue}))}catch{}if(!l&&k){if(fe.current)try{URL.revokeObjectURL(fe.current)}catch{}fe.current=k;const h=X||k;r({outputUrl:h});try{const W=Ie(C);if(W){const q=document.querySelector(`.react-flow__node[data-id="${W.id}"]`),be=Math.round((q==null?void 0:q.getBoundingClientRect().width)||420),Se=W.position.x+be+160,ye=`audio-preview-${Date.now()}`;Q(_e=>{var re;const je=_e.filter(Be=>{var qe;return Be.type==="audioPreview"&&((qe=Be.data)==null?void 0:qe.sourceNodeId)===C}),Te=W.position.y,Re=je.length>0?Math.max(...je.map(Be=>{var qe;return((qe=Be.position)==null?void 0:qe.y)||Te}))+120:Te;return[..._e,{id:ye,type:"audioPreview",position:{x:Se,y:Re},data:{audioUrl:h,sourceNodeId:C,createdBy:(re=W.data)==null?void 0:re.createdBy}}]}),$(_e=>[..._e,{id:`${C}-${ye}`,source:C,target:ye}])}}catch{}}l&&ce.current&&!ce.current.paused?g.success("éŸ³è‰²é¢„è§ˆå·²ç”Ÿæˆå¹¶æ’­æ”¾"):!l&&k&&g.success("è¯­éŸ³åˆæˆæˆåŠŸ")}catch(v){const p=((B=(D=v==null?void 0:v.response)==null?void 0:D.data)==null?void 0:B.message)||(v==null?void 0:v.message)||(l?"é¢„è§ˆå¤±è´¥":"è¯­éŸ³åˆæˆå¤±è´¥");g.error(p)}T(!1)};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:ve,onChange:l=>{ee(l),r({modelId:l})},options:(s.models||[]).filter(l=>l.type==="AUDIO_SYNTHESIS"&&l.isActive).map(l=>({value:l.id,label:l.name}))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx(rs,{value:ne,onChange:l=>{se(l),l==="custom"&&R()},options:[{value:"zh",label:"ä¸­æ–‡(æ™®é€šè¯)"},{value:"yue",label:"ä¸­æ–‡(ç²¤è¯­)"},{value:"en",label:"è‹±æ–‡"},{value:"ja",label:"æ—¥æ–‡"},{value:"ko",label:"éŸ©æ–‡"},{value:"custom",label:"è‡ªå®šä¹‰éŸ³è‰²"}]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²"}),e.jsx(rs,{value:de,onChange:l=>{Z(l),r({voiceId:l})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...ne==="custom"?we.map(l=>({value:l.voiceId,label:l.prefix||l.voiceId})):Lr.filter(l=>{const n=l.label;return ne==="zh"?n.startsWith("ä¸­æ–‡ (æ™®é€šè¯)"):ne==="yue"?n.startsWith("ä¸­æ–‡ (ç²¤è¯­)"):ne==="en"?n.startsWith("è‹±æ–‡ "):ne==="ja"?n.startsWith("æ—¥æ–‡ "):ne==="ko"?n.startsWith("éŸ©æ–‡ "):!0}).map(l=>({value:l.id,label:l.label.replace(/^ä¸­æ–‡ \(æ™®é€šè¯\) |^ä¸­æ–‡ \(ç²¤è¯­\) |^è‹±æ–‡ |^æ—¥æ–‡ |^éŸ©æ–‡ /,"")}))]})]}),e.jsx("button",{onClick:()=>b(!0),disabled:P,className:`mt-auto w-9 h-9 rounded-full flex items-center justify-center text-white hover:shadow-lg ${P?"bg-gray-600 dark:bg-gray-700":""}`,style:P?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #a855f7, #ec4899)"},children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"play_arrow"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"åˆæˆæ–‡æœ¬"}),e.jsx("textarea",{ref:he,value:ge,onChange:l=>{Oe(l.target.value),r({text:l.target.value})},onMouseDown:l=>l.stopPropagation(),placeholder:"è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsx("button",{onClick:()=>b(!1),disabled:P||s._canEdit===!1,className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 text-white shadow-md hover:shadow-lg ${P||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700":"border-transparent dark:border-white/10"}`,style:P||s._canEdit===!1?void 0:{background:document.documentElement.classList.contains("dark")?"linear-gradient(to right, #4b1b77, #6f153f)":"linear-gradient(to right, #a855f7, #ec4899)"},children:P?"åˆæˆä¸­...":"ç”Ÿæˆè¯­éŸ³"})]}),e.jsx("audio",{ref:ce,className:"hidden"}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},So=t.memo(Io),Eo=t.memo(({id:s,sourceX:C,sourceY:u,targetX:Q,targetY:Ie,sourcePosition:$,targetPosition:ve,selected:ee,markerEnd:de})=>{const[Z]=ua({sourceX:C,sourceY:u,targetX:Q,targetY:Ie,sourcePosition:$,targetPosition:ve});return e.jsxs("g",{className:"aurora-edge",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:`aurora-grad-${s}`,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ec4899",stopOpacity:.5}),e.jsx("stop",{offset:"50%",stopColor:"#a855f7",stopOpacity:1}),e.jsx("stop",{offset:"100%",stopColor:"#22d3ee",stopOpacity:.5})]}),e.jsxs("filter",{id:`aurora-glow-${s}`,children:[e.jsx("feGaussianBlur",{stdDeviation:"2",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{id:s,d:Z,fill:"none",stroke:ee?"#a855f7":"currentColor",strokeWidth:2,className:"opacity-30 dark:text-white/40 text-slate-300",style:{pointerEvents:"none"},markerEnd:de}),e.jsx("path",{d:Z,fill:"none",stroke:`url(#aurora-grad-${s})`,strokeWidth:2,strokeDasharray:"10 10",className:"aurora-edge-dash",style:{filter:`url(#aurora-glow-${s})`,pointerEvents:"none"},markerEnd:de}),e.jsx("circle",{r:3,className:"fill-slate-700 dark:fill-white",style:{pointerEvents:"none"},children:e.jsx("animateMotion",{dur:"2s",repeatCount:"indefinite",path:Z,calcMode:"linear"})}),e.jsx("path",{d:Z,fill:"none",stroke:"transparent",strokeWidth:40,strokeLinecap:"round",strokeLinejoin:"round",style:{pointerEvents:"stroke",cursor:"pointer"}})]})}),Co=({data:s,id:C})=>{const u=t.useRef(null),{getNode:Q,setNodes:Ie}=ts(),[$,ve]=t.useState(!1),[ee,de]=t.useState([]),[Z,ge]=t.useState(""),[Oe,he]=t.useState("ALL"),[ne,se]=t.useState(""),[fe,ce]=t.useState(!1),Ce=t.useMemo(()=>window.location.origin,[]),K=t.useMemo(()=>{var P;const M=s.audioUrl||"";if(M.startsWith("blob:")){const T=s.sourceNodeId?Q(s.sourceNodeId):null,x=((P=T==null?void 0:T.data)==null?void 0:P.outputUrl)||"";return x.startsWith("http")?x:x.startsWith("/")?`${Ce}${x}`:M}return M.startsWith("http")?`${Ce}/api/assets/proxy-stream?url=${encodeURIComponent(M)}`:M.startsWith("/")?`${Ce}${M}`:M},[s.audioUrl,s.sourceNodeId,Ce]);t.useEffect(()=>{const M=u.current;M&&(M.preload="auto",M.playsInline=!0,M.crossOrigin="anonymous",M.load())},[K]),t.useEffect(()=>{$&&(De(),setTimeout(()=>{we()},100))},[$]);const De=async()=>{try{const M=Oe==="ALL"?void 0:{category:Oe},T=(await Me.assetLibraries.getAll(M)).data||[];de(T);const x=Oe==="ALL"?T:T.filter(m=>(m.category||"OTHER")===Oe);if(x.length>0){const m=x.find(j=>j.id===Z);ge(m?m.id:x[0].id)}else ge("")}catch{g.error("åŠ è½½èµ„äº§åº“åˆ—è¡¨å¤±è´¥")}},we=()=>{const M=window.__workflowContext;if(!M||!M.project||!M.nodeGroups){g.warning("å·¥ä½œæµä¿¡æ¯æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•");return}const P=Ws(C,M.nodeGroups);if(!P&&M.nodeGroups.length>0){const x=M.nodeGroups[0],m=Ts({project:M.project,episode:M.episode,nodeGroup:x,assetType:"audio"});m?(se(m),g.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${m}`)):g.warning("ç¼–ç»„ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å‘½å");return}const T=Ts({project:M.project,episode:M.episode,nodeGroup:P,assetType:"audio"});T?(se(T),g.success(`å·²è‡ªåŠ¨ç”Ÿæˆèµ„äº§åç§°ï¼š${T}`)):g.warning("è¯·å…ˆä¸ºç¼–ç»„å‘½åï¼ˆå¹•æ•°-é•œå¤´æ•°ï¼‰ï¼Œæ‰èƒ½è‡ªåŠ¨å‘½å")},ie=async()=>{var M,P;if(!Z){g.error("è¯·é€‰æ‹©èµ„äº§åº“");return}if(!ne.trim()){g.error("è¯·è¾“å…¥èµ„äº§åç§°");return}try{ce(!0),await Me.assetLibraries.addFromUrl(Z,s.audioUrl,ne.trim());const T=window.__workflowContext;if(T&&T.project&&T.nodeGroups){const x=Ws(C,T.nodeGroups)||T.nodeGroups[0];x&&Ts({project:T.project,episode:T.episode,nodeGroup:x,nodeId:C,assetType:"audio",preview:!1})}g.success("å·²æ·»åŠ åˆ°èµ„äº§åº“"),ve(!1),se("");try{Ie(x=>x.map(m=>m.id===C?{...m,data:{...m.data,addedToLibrary:!0}}:m))}catch{}try{const x=new CustomEvent("asset-library-updated",{detail:{libraryId:Z}});window.dispatchEvent(x)}catch{}}catch(T){g.error(((P=(M=T.response)==null?void 0:M.data)==null?void 0:P.message)||"æ·»åŠ å¤±è´¥")}finally{ce(!1)}},R=async()=>{var T;let M=`audio-${Date.now()}.mp3`;const P=window.__workflowContext;if(P&&P.project&&P.nodeGroups){const x=Ws(C,P.nodeGroups)||P.nodeGroups[0];if(x){const m=Ts({project:P.project,episode:P.episode,nodeGroup:x,assetType:"audio",preview:!0});if(m&&(M=m,!M.includes("."))){const j=((T=s.audioUrl.match(/\.(mp3|wav|ogg|m4a|flac)$/i))==null?void 0:T[0])||".mp3";M+=j}}}try{g.info("æ­£åœ¨ä¸‹è½½éŸ³é¢‘...");const x=`/assets/proxy-download-with-name?url=${encodeURIComponent(s.audioUrl)}&filename=${encodeURIComponent(M)}`,m=await Me.get(x,{responseType:"blob"}),j=m instanceof Blob?m:m==null?void 0:m.data;if(!j||!(j instanceof Blob))throw new Error("ä¸‹è½½å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”æ•°æ®");const te=window.URL.createObjectURL(j),L=document.createElement("a");L.href=te,L.download=M,document.body.appendChild(L),L.click(),document.body.removeChild(L),setTimeout(()=>{window.URL.revokeObjectURL(te)},100),g.success(`éŸ³é¢‘ä¸‹è½½æˆåŠŸï¼š${M}`)}catch(x){g.error(`ä¸‹è½½å¤±è´¥: ${x instanceof Error?x.message:"æœªçŸ¥é”™è¯¯"}`)}};return e.jsxs("div",{className:"relative group",style:{width:360},children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"}),e.jsxs("div",{className:"relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border border-slate-200 dark:border-white/10 rounded-xl shadow-xl overflow-hidden py-4 px-3",children:[e.jsx("audio",{ref:u,controls:!0,src:K,className:"w-full nodrag"}),e.jsxs("div",{className:"nodrag absolute bottom-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsxs("button",{onClick:()=>{ve(!0)},className:`w-7 h-7 flex items-center justify-center ${s!=null&&s.addedToLibrary?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/90 dark:to-pink-600/90"} hover:shadow-lg text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95 relative`,title:s!=null&&s.addedToLibrary?"å·²æ·»åŠ åˆ°èµ„äº§åº“":"æ·»åŠ åˆ°èµ„äº§åº“",disabled:s==null?void 0:s.addedToLibrary,children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"audio_file"}),(s==null?void 0:s.addedToLibrary)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 w-3.5 h-3.5 bg-white rounded-full flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"material-symbols-outlined text-green-600 leading-none",style:{fontVariationSettings:'"FILL" 1, "wght" 300',fontSize:"10px"},children:"check_circle"})})]}),e.jsx("button",{onClick:R,className:"w-7 h-7 flex items-center justify-center bg-slate-800/90 dark:bg-slate-700/90 hover:bg-slate-900 dark:hover:bg-slate-600 text-white rounded-full transition-all backdrop-blur-sm shadow-md active:scale-95",title:"ä¸‹è½½éŸ³é¢‘",children:e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"})})]})]}),$&&e.jsx("div",{className:"nodrag fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto",onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary",children:"æ·»åŠ åˆ°èµ„äº§åº“"}),e.jsx("button",{onClick:()=>ve(!1),className:"p-1.5 rounded-md text-slate-400 dark:text-text-dark-secondary hover:bg-slate-100 dark:hover:bg-white/10 transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-base",children:"close"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"èµ„äº§åç§° *"}),e.jsx("input",{type:"text",value:ne,onChange:M=>se(M.target.value),onMouseDown:M=>M.stopPropagation(),onTouchStart:M=>M.stopPropagation(),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary placeholder-slate-400 dark:placeholder-text-dark-secondary focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"è¾“å…¥èµ„äº§åç§°",maxLength:200})]}),e.jsxs("div",{className:"min-h-[72px]",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"é€‰æ‹©èµ„äº§åº“ *"}),(()=>{const M=Oe==="ALL"?ee:ee.filter(P=>(P.category||"OTHER")===Oe);return M.length===0?e.jsx("div",{className:"text-sm text-slate-600 dark:text-text-dark-secondary",children:Oe==="ALL"?"æš‚æ— èµ„äº§åº“ï¼Œè¯·å…ˆåˆ›å»º":"è¯¥ç±»å‹æš‚æ— èµ„äº§åº“"}):e.jsx("select",{value:Z,onChange:P=>ge(P.target.value),className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500",children:M.map(P=>e.jsxs("option",{value:P.id,children:[P.name," (",P._count.assets," ä¸ªèµ„äº§)"]},P.id))})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 dark:text-text-dark-secondary mb-2",children:"åº“ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:["ROLE","SCENE","PROP","OTHER"].map(M=>e.jsx("button",{type:"button",onClick:()=>{he(M);const P=ee.filter(T=>(T.category||"OTHER")===M);ge(P.length>0?P[0].id:"")},className:`px-3 py-2 rounded-lg border transition-all text-left ${Oe===M?"border-purple-500 bg-purple-500/10 dark:bg-purple-500/20":"border-slate-200 dark:border-border-dark hover:border-purple-400 dark:hover:border-purple-500"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-600 dark:text-text-dark-secondary",children:M==="ROLE"?"person":M==="SCENE"?"landscape":M==="PROP"?"inventory_2":"widgets"}),e.jsx("span",{className:"font-medium text-slate-900 dark:text-text-dark-primary",children:M==="ROLE"?"è§’è‰²åº“":M==="SCENE"?"åœºæ™¯åº“":M==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"})]})},M))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ve(!1),className:"flex-1 px-4 py-2 bg-slate-100 dark:bg-background-dark text-slate-900 dark:text-text-dark-primary rounded-lg hover:bg-slate-200 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-border-dark",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:ie,disabled:fe||ee.length===0||!ne.trim(),className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:fe?"æ·»åŠ ä¸­...":"ç¡®è®¤æ·»åŠ "})]})]})]})}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,isConnectable:!1,className:"!z-[10000] opacity-60 cursor-default"})]})},Ao=t.memo(Co),_o=({data:s,id:C,selected:u})=>{const{setNodes:Q,getNode:Ie,setEdges:$}=ts(),[ve,ee]=t.useState(s.config.modelId||""),[de,Z]=t.useState(s.config.prompt||""),[ge,Oe]=t.useState(s.config.previewText||""),[he,ne]=t.useState(s.config.voiceId||""),[se,fe]=t.useState(!1),ce=t.useRef(null),Ce=t.useRef(null),K=t.useRef(null),De=t.useRef(null),[we,ie]=t.useState([]);t.useEffect(()=>{if(!ve){const j=(s.models||[]).filter(te=>te.type==="AUDIO_SYNTHESIS"&&te.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(te.provider||"").toLowerCase())&&(Array.isArray(te.capabilities)?te.capabilities.some(L=>L.capability==="éŸ³è‰²è®¾è®¡"&&L.supported):!0))[0];j&&(ee(j.id),R({modelId:j.id}))}},[s.models,ve]);const R=m=>{Ie(C)&&Q(te=>te.map(L=>L.id===C?{...L,data:{...L.data,config:{...L.data.config,...m}}}:L))};t.useEffect(()=>{(async()=>{try{const m=await Me.ai.audio.voices.list(),j=(m==null?void 0:m.data)??m;ie(Array.isArray(j)?j:[])}catch{}})()},[]);const M=m=>{m&&(m.style.height="auto",m.style.height=`${m.scrollHeight}px`)};t.useEffect(()=>{M(Ce.current)},[de]),t.useEffect(()=>{M(K.current)},[ge]);const P=async m=>{if(!m)return!1;try{const j=(m||"").replace(/\s+/g,""),te=new Uint8Array(Math.floor(j.length/2));for(let b=0;b<te.length;b++)te[b]=parseInt(j.substr(b*2,2),16);const L=(()=>{const b=te;return b.length>=12&&b[0]===82&&b[1]===73&&b[2]===70&&b[3]===70&&b[8]===87&&b[9]===65&&b[10]===86&&b[11]===69?"audio/wav":(b.length>=3&&b[0]===73&&b[1]===68&&b[2]===51||b.length>=2&&b[0]===255&&(b[1]&224)===224,"audio/mpeg")})(),A=new Blob([te.buffer],{type:L}),O=URL.createObjectURL(A);if(De.current)try{URL.revokeObjectURL(De.current)}catch{}De.current=O;const r=ce.current||new Audio;return r.preload="auto",r.autoplay=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.src=O,ce.current=r,await r.play(),!0}catch{return!1}},T=async()=>{var j,te,L,A,O;if(!de.trim()){g.error("è¯·è¾“å…¥éŸ³è‰²æè¿°");return}let m=ve;if(!m){const r=(s.models||[]).filter(b=>b.type==="AUDIO_SYNTHESIS"&&b.isActive&&["minimaxi","hailuo","æµ·èº"].includes(String(b.provider||"").toLowerCase()));if(r[0])m=r[0].id,ee(m),R({modelId:m});else{g.error("è¯·å…ˆåœ¨åå°é…ç½® MiniMax è¯­éŸ³æ¨¡å‹");return}}fe(!0);try{const r=await Me.ai.audio.design({modelId:m,prompt:de,preview_text:ge,voice_id:he||void 0,aigc_watermark:!1}),b=((j=r==null?void 0:r.data)==null?void 0:j.voice_id)||(r==null?void 0:r.voice_id),l=((te=r==null?void 0:r.data)==null?void 0:te.trial_audio)||(r==null?void 0:r.trial_audio)||((L=r==null?void 0:r.data)==null?void 0:L.hex)||(r==null?void 0:r.hex);b&&(ne(String(b)),R({voiceId:String(b)})),l&&typeof l=="string"?(R({trialHex:l}),await P(l),g.success("éŸ³è‰²è®¾è®¡æˆåŠŸï¼Œå·²ç”Ÿæˆè¯•å¬")):g.success("éŸ³è‰²è®¾è®¡æˆåŠŸ");try{const n=Ie(C);if(n){const a=document.querySelector(`.react-flow__node[data-id="${n.id}"]`),c=Math.round((a==null?void 0:a.getBoundingClientRect().width)||420),w=n.position.x+c+160,I=`audio-preview-${Date.now()}`;Q(D=>{var B;return[...D,{id:I,type:"audioPreview",position:{x:w,y:n.position.y},data:{audioUrl:De.current||"",sourceNodeId:C,createdBy:(B=n.data)==null?void 0:B.createdBy}}]}),$(D=>[...D,{id:`${C}-${I}`,source:C,target:I}])}}catch{}}catch(r){const b=((O=(A=r==null?void 0:r.response)==null?void 0:A.data)==null?void 0:O.message)||(r==null?void 0:r.message)||"éŸ³è‰²è®¾è®¡å¤±è´¥";g.error(b)}fe(!1)},x=async()=>{var j,te;const m=(he||"").trim();if(!m){g.error("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥éŸ³è‰²ID");return}try{if(we.some(o=>String(o.voiceId)===String(m))){g.success("å·²ä¿å­˜åˆ°æˆ‘çš„éŸ³è‰²");return}const O=(s.models||[]).find(o=>o.id===ve),r=(O==null?void 0:O.modelId)||"cosyvoice-v2",b=(de||m).slice(0,40);await Me.ai.audio.voices.add({voiceId:m,prefix:b,targetModel:r,provider:String((O==null?void 0:O.provider)||"")});const l=await Me.ai.audio.voices.list(),n=(l==null?void 0:l.data)??l;ie(Array.isArray(n)?n:[]),g.success("å·²ä¿å­˜éŸ³è‰²")}catch(L){const A=((te=(j=L==null?void 0:L.response)==null?void 0:j.data)==null?void 0:te.message)||(L==null?void 0:L.message)||"ä¿å­˜å¤±è´¥";g.error(A)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"record_voice_over"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:s.label})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ¨¡å‹"}),e.jsx(rs,{value:ve,onChange:m=>{ee(m),R({modelId:m})},options:(s.models||[]).filter(m=>m.type!=="AUDIO_SYNTHESIS"||!m.isActive?!1:Array.isArray(m.capabilities)?m.capabilities.some(j=>j.capability==="éŸ³è‰²è®¾è®¡"&&j.supported):["minimaxi","hailuo","æµ·èº"].includes(String(m.provider||"").toLowerCase())).map(m=>({value:m.id,label:m.name}))})]}),we.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æˆ‘çš„éŸ³è‰²"}),e.jsx(rs,{value:he||"",onChange:m=>{ne(m),R({voiceId:m})},options:[{value:"",label:"é€‰æ‹©éŸ³è‰²"},...we.map(m=>({value:m.voiceId,label:m.prefix||m.voiceId}))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²åç§°"}),e.jsx("input",{value:he,onChange:m=>{const j=m.target.value;ne(j),R({voiceId:j})},placeholder:"å®šä¹‰éŸ³è‰²åç§°",className:"nodrag w-full p-2 text-xs rounded-md border outline-none transition-colors bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"éŸ³è‰²æè¿°"}),e.jsx("textarea",{ref:Ce,value:de,onChange:m=>{Z(m.target.value),R({prompt:m.target.value})},placeholder:"æè¿°ä½ æƒ³è¦çš„éŸ³è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šæ¸©æš–ã€äº²åˆ‡ã€ä½æ²‰",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:3})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯•å¬æ–‡æœ¬"}),e.jsx("textarea",{ref:K,value:ge,onChange:m=>{Oe(m.target.value),R({previewText:m.target.value})},placeholder:"è¾“å…¥è¯•å¬æ–‡æœ¬",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none overflow-hidden transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",rows:2})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:T,disabled:se||s._canEdit===!1,className:`nodrag flex-1 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 ${se||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:se?"è®¾è®¡ä¸­...":"è®¾è®¡éŸ³è‰²"}),e.jsx("button",{onClick:x,disabled:se||!he||s._canEdit===!1,className:`nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 ${se||!he||s._canEdit===!1?"bg-gray-600 dark:bg-gray-700 text-white opacity-50":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:"ä¿å­˜"})]})]}),e.jsx("audio",{ref:ce,className:"hidden"}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},To=t.memo(_o),Ro=({data:s,id:C,selected:u})=>{const Q=t.useRef(null),Ie=t.useRef(null),$=t.useRef(null),{getNodes:ve,getEdges:ee,setNodes:de,setEdges:Z,getNode:ge,getViewport:Oe}=ts(),he=Fs(),ne=Ds(),[se,fe]=t.useState(null),[ce,Ce]=t.useState("#7c3aed"),[K,De]=t.useState(100),we=t.useRef(!1),ie=t.useRef(null),R=t.useRef(null),M=t.useRef(null),P=t.useRef(new Set),T=t.useRef(null),x=t.useRef(null),m=t.useRef(null),j=4096,te=s.width||800,L=s.width||800,A=j,O=j;return t.useEffect(()=>{var p,d,E,Y;if(!Q.current||Ie.current)return;const r=document.createElement("canvas");r.width=A,r.height=O,Q.current.appendChild(r);const b=new ya(r,{width:A,height:O,backgroundColor:"transparent",selection:!1,preserveObjectStacking:!0}),l=new Hs({left:0,top:0,width:A,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});b.add(l),b.sendObjectToBack(l),b.perPixelTargetFind=!0,b.targetFindTolerance=8;const n=te/A;b.setDimensions({width:te,height:L}),b.setZoom(n),r.style.width=`${te} px`,r.style.height=`${L} px`,Ie.current=b,Vs.prototype.borderColor="#ff2d55",Vs.prototype.cornerColor="#ff2d55",Vs.prototype.cornerStrokeColor="#ff2d55",Vs.prototype.selectionBorderColor="#ff2d55",Vs.prototype.selectionColor="rgba(255,45,85,0.08)",Vs.prototype.transparentCorners=!1,Vs.prototype.cornerSize=12,Vs.prototype.selectionLineWidth=2,Vs.prototype.borderScaleFactor=2;const o=`url(\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='none' stroke='%23ff2d55' stroke-width='2'/><path d='M16 8l3 0-1.5-2.5' fill='%23ff2d55'/><path d='M8 16l-3 0 1.5 2.5' fill='%23ff2d55'/></svg>\\") 12 12, pointer`;b.rotationCursor=o;const a=Vs.prototype.controls||{};a.tl&&(a.tl.cursorStyle="nwse-resize",a.tl.cornerStyle="square"),a.br&&(a.br.cursorStyle="nwse-resize",a.br.cornerStyle="square"),a.tr&&(a.tr.cursorStyle="nesw-resize",a.tr.cornerStyle="square"),a.bl&&(a.bl.cursorStyle="nesw-resize",a.bl.cornerStyle="square"),a.mtr&&(a.mtr.cursorStyle=o,a.mtr.cornerStyle="circle");const c=X=>{X&&(X.borderColor="#ff2d55",X.cornerColor="#ff2d55",X.cornerStrokeColor="#ff2d55",X.transparentCorners=!1,X.cornerSize=12,X.hasBorders=!0,X.hasControls=!0)},w=()=>{const X=b.getActiveObject();X&&(X.type==="activeSelection"&&Array.isArray(X._objects)&&X._objects.forEach(c),c(X),b.requestRenderAll())};b.on("selection:created",w),b.on("selection:updated",w),b.freeDrawingBrush=new Rr(b);const I=()=>{const X=Ie.current;if(!X)return;const J=X.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(J.objects)&&(J.objects=J.objects.map(le=>(le&&le.type==="image"&&le.originalUrl&&(le.src=le.originalUrl),le)));const F={canvasJson:J,appliedCrop:m.current},ae=JSON.stringify(F);try{localStorage.setItem(`superCanvas:${C}`,ae)}catch{}ge(C)&&de(le=>le.map(S=>S.id===C?{...S,data:{...S.data,canvasState:ae}}:S))},D=()=>{x.current&&(clearTimeout(x.current),x.current=null),x.current=window.setTimeout(()=>{I()},300)};b.on("object:added",D),b.on("object:modified",D),b.on("object:removed",D),b.on("path:created",D);const B=((d=(p=ge(C))==null?void 0:p.data)==null?void 0:d.canvasState)||localStorage.getItem(`superCanvas:${C}`),v=(Y=(E=ge(C))==null?void 0:E.data)==null?void 0:Y.canvasJson;if(B||v)try{let X,J=null;if(B){const f=JSON.parse(B);f.canvasJson?(X=f.canvasJson,J=f.appliedCrop):X=f}else v&&(X=JSON.parse(v));const F=X,ae=f=>{var k,h,W,ue,q,be,Se,ye,_e;if(!f||typeof f!="object")return f;if(f.type==="image"){if(f.originalUrl)f.src=f.originalUrl;else if(f.sourceNodeId){const je=ge(f.sourceNodeId),Te=((k=je==null?void 0:je.data)==null?void 0:k.imageUrl)||((h=je==null?void 0:je.data)==null?void 0:h.url)||((W=je==null?void 0:je.data)==null?void 0:W.output)||((q=(ue=je==null?void 0:je.data)==null?void 0:ue.config)==null?void 0:q.generatedImageUrl)||((_e=(ye=(Se=(be=je==null?void 0:je.data)==null?void 0:be.config)==null?void 0:Se.uploadedFiles)==null?void 0:ye[0])==null?void 0:_e.url);Te&&(f.originalUrl=Te,f.src=Te)}return typeof f.src=="string"&&f.src.startsWith("blob:")?null:f}return Array.isArray(f.objects)&&(f.objects=f.objects.map(ae).filter(Boolean),f.type==="group"&&f.objects.length===0)?null:f},oe=f=>f&&(typeof(f==null?void 0:f.src)=="string"&&f.src.startsWith("blob:")?null:f.type==="image"?ae(f):f),le=f=>f&&(Array.isArray(f)?f.map(le).filter(Boolean):typeof f=="object"&&(f.type==="image"&&typeof f.src=="string"&&f.src.startsWith("blob:")||(Object.keys(f).forEach(k=>{const h=f[k];if(typeof h=="string"&&h.startsWith("blob:"))f[k]=void 0;else if(h&&typeof h=="object"){const W=le(h);W===null?delete f[k]:f[k]=W}}),Array.isArray(f.objects)&&(f.objects=f.objects.map(le).filter(Boolean),f.type==="group"&&f.objects.length===0)))?null:f);Array.isArray(F.objects)&&(F.objects=F.objects.map(ae).filter(Boolean)),F.backgroundImage&&(F.backgroundImage=oe(F.backgroundImage)),F.overlayImage&&(F.overlayImage=oe(F.overlayImage)),F.clipPath&&(F.clipPath=ae(F.clipPath));const S=le(F);b.loadFromJSON(S).then(()=>{const f=new Hs({left:0,top:0,width:A,height:O,fill:"#ffffff",selectable:!1,evented:!1,excludeFromExport:!0,name:"__background__"});b.add(f);const k=b.getObjects().find(h=>h.name==="__background__");if(k&&b.sendObjectToBack(k),J){m.current=J;const{left:h,top:W,width:ue,height:q}=J,be=new Hs({left:h,top:W,width:ue,height:q,absolutePositioned:!0});b.clipPath=be,k&&k.set({left:h,top:W,width:ue,height:q})}b.requestRenderAll()})}catch{}return Q.current&&Q.current.classList.add("nodrag"),()=>{b.dispose(),Ie.current=null,Q.current&&(Q.current.innerHTML="")}},[C,A,O,te]),t.useEffect(()=>{se==="brush"?(K<80||K>400)&&De(100):(se==="pencil"||se==="line"||se==="arrow")&&(K<10||K>30)&&De(15)},[se,K]),t.useEffect(()=>{const r=Ie.current;if(!r)return;const b="https://api.waule.com",l=he.filter(a=>a.target===C&&a.targetHandle==="input-image");l.forEach(async a=>{var v,p;const c=ne.find(d=>d.id===a.source);if(!c||P.current.has(c.id))return;let w;const I=c.data;if(c.type==="upload"){const d=(v=I==null?void 0:I.config)==null?void 0:v.uploadedFiles;if(d&&d.length>0){const E=d[0];(E.type==="IMAGE"||(p=E.mimeType)!=null&&p.startsWith("image/"))&&(w=E.url)}}else c.type==="imagePreview"?w=I==null?void 0:I.imageUrl:w=(I==null?void 0:I.imageUrl)||(I==null?void 0:I.output)||(I==null?void 0:I.url);if(!w)return;let D=w;if(!w.startsWith("http")&&!w.startsWith("data:")&&(D=`${b}${w}`),D=D.replace(/^https?:\/\/localhost(?::\d+)?/i,b),r.getObjects().find(d=>d.sourceNodeId===c.id)){P.current.add(c.id);return}P.current.add(c.id);try{const d=await Me.assets.proxyDownload(D),E=new Uint8Array(d);let Y="image/png";E.length>=4&&(E[0]===137&&E[1]===80&&E[2]===78&&E[3]===71?Y="image/png":E[0]===255&&E[1]===216&&E[2]===255?Y="image/jpeg":E[0]===71&&E[1]===73&&E[2]===70?Y="image/gif":E[0]===82&&E[1]===73&&E[2]===70&&E[3]===70&&E.length>=12&&E[8]===87&&E[9]===69&&E[10]===66&&E[11]===80&&(Y="image/webp"));const X=new Blob([d],{type:Y}),J=URL.createObjectURL(X),F=await ka.fromURL(J);if(!F){URL.revokeObjectURL(J);return}const ae=l.indexOf(a)*20;F.set({scaleX:1,scaleY:1,left:(A-F.width)/2+ae,top:(O-F.height)/2+ae,selectable:!0,lockScalingFlip:!0,lockUniScaling:!1,name:"__input_image__",sourceNodeId:c.id,originalUrl:D,borderColor:"#ff2d55",cornerColor:"#ff2d55",cornerStrokeColor:"#ff2d55",transparentCorners:!1,cornerSize:12}),F.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1}),r.add(F);const oe=r.getObjects().find(le=>le.name==="__background__");oe?(r.sendObjectToBack(F),r.sendObjectToBack(oe)):r.sendObjectToBack(F),r.requestRenderAll(),setTimeout(()=>URL.revokeObjectURL(J),1e3)}catch{}});const n=new Set(l.map(a=>{var c;return(c=ne.find(w=>w.id===a.source))==null?void 0:c.id}).filter(Boolean)),o=[];P.current.forEach(a=>{if(!n.has(a)){o.push(a);const c=r.getObjects().find(w=>w.sourceNodeId===a);c&&(r.remove(c),r.requestRenderAll())}}),o.forEach(a=>P.current.delete(a))},[he,ne,C,A,O]),t.useEffect(()=>{const r=Ie.current;if(!r)return;if(r.isDrawingMode=!1,r.defaultCursor="default",r.selection=!0,r.skipTargetFind=!1,se===null){if(r.isDrawingMode=!1,r.selection=!1,r.skipTargetFind=!0,r.defaultCursor="default",r.getObjects().forEach(o=>{o.name!=="__background__"&&o.name!=="__crop__"&&(o.selectable=!1,o.evented=!1)}),T.current&&(T.current.style.display="none"),m.current){const{left:o,top:a,width:c,height:w}=m.current,I=new Hs({left:o,top:a,width:c,height:w,absolutePositioned:!0});r.clipPath=I;const D=r.getObjects().find(B=>B.name==="__background__");D&&D.set({left:o,top:a,width:c,height:w})}return}const b=ce.startsWith("#")?`%23${ce.slice(1)}`:encodeURIComponent(ce),l=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M3 17L14 6l4 4L7 21H3z' fill='${b}' stroke='%23ffffff' stroke-width='1.2'/></svg>") 3 20, crosshair`,n=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='none' stroke='%23ff6b6b' stroke-width='2'/><path d='M12 6V18M6 12H18' stroke='%23ff6b6b' stroke-width='1.5'/><circle cx='12' cy='12' r='2' fill='%23ff6b6b'/></svg>") 12 12, crosshair`;if(se==="pencil"||se==="brush"){r.isDrawingMode=!0,r.freeDrawingBrush=new Rr(r);const o=(c,w)=>{const I=c.replace("#",""),D=parseInt(I.substring(0,2),16),B=parseInt(I.substring(2,4),16),v=parseInt(I.substring(4,6),16);return`rgba(${D},${B},${v},${w})`};if(r.freeDrawingBrush.color=o(ce,.7),r.freeDrawingBrush.width=K,m.current){const{left:c,top:w,width:I,height:D}=m.current,B=new Hs({left:c,top:w,width:I,height:D,absolutePositioned:!0});r.clipPath=B;const v=r.getObjects().find(p=>p.name==="__background__");v&&v.set({left:c,top:w,width:I,height:D})}const a=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${b}' stroke-width='2.2'/></svg>") 16 16, crosshair`;se==="pencil"?(r.freeDrawingCursor=l,r.defaultCursor=l,r.hoverCursor=l,r.moveCursor=l,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=l)):(r.freeDrawingCursor=a,r.defaultCursor=a,r.hoverCursor=a,r.moveCursor=a,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=a)),r.selection=!1,r.getObjects().forEach(c=>{c.name!=="__background__"&&c.name!=="__crop__"&&(c.selectable=!0,c.evented=!0)}),se==="brush"&&T.current&&(T.current.style.display="block"),se==="pencil"&&T.current&&(T.current.style.display="none")}else if(se==="crop"){r.selection=!1,r.defaultCursor="crosshair",r.clipPath=void 0;const o=r.getObjects().find(D=>D.name==="__background__");o&&o.set({left:0,top:0,width:A,height:O}),r.requestRenderAll();let a=M.current;const c=A*.1,w=A-c*2,I=O-c*2;if(!a||!r.getObjects().includes(a)){const D=m.current||{left:c,top:c,width:w,height:I};a=new Hs({left:D.left,top:D.top,width:D.width,height:D.height,fill:"rgba(0,0,0,0)",stroke:"#22d3ee",strokeWidth:8,cornerColor:"#22d3ee",cornerStrokeColor:"#0891b2",borderColor:"#22d3ee",cornerStyle:"circle",cornerSize:12,transparentCorners:!1,hasBorders:!0,hasControls:!0,lockRotation:!0,originX:"left",originY:"top",name:"__crop__",excludeFromExport:!0}),M.current=a,r.add(a)}a&&(a.visible=!0,a.selectable=!0,a.evented=!0,r.setActiveObject(a),r.requestRenderAll())}else if(se==="line"||se==="arrow"||se==="text"||se==="eraser"){if(r.selection=!1,m.current){const{left:a,top:c,width:w,height:I}=m.current,D=new Hs({left:a,top:c,width:w,height:I,absolutePositioned:!0});r.clipPath=D;const B=r.getObjects().find(v=>v.name==="__background__");B&&B.set({left:a,top:c,width:w,height:I})}const o=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M0 16 H32 M16 0 V32' stroke='%23000000' stroke-width='4'/><path d='M0 16 H32 M16 0 V32' stroke='${b}' stroke-width='2.2'/></svg>") 16 16, crosshair`;r.defaultCursor=se==="text"?"text":se==="eraser"?n:o,r.upperCanvasEl&&(r.upperCanvasEl.style.cursor=r.defaultCursor),se==="line"||se==="arrow"?(r.hoverCursor=o,r.moveCursor=o,r.skipTargetFind=!0,r.discardActiveObject(),r.getObjects().forEach(a=>{a.name!=="__background__"&&a.name!=="__crop__"&&(a.selectable=!1,a.evented=!1)}),T.current&&(T.current.style.display="none")):(r.skipTargetFind=!1,r.getObjects().forEach(a=>{a.name!=="__background__"&&a.name!=="__crop__"&&(a.selectable=!0,a.evented=!0)}),se==="eraser"&&T.current&&(T.current.style.display="none"),se==="eraser"&&(r.moveCursor=n,r.hoverCursor=n)),T.current&&(T.current.style.display="none")}else{if(M.current&&(M.current.visible=!1,r.discardActiveObject()),m.current){const{left:o,top:a,width:c,height:w}=m.current,I=new Hs({left:o,top:a,width:c,height:w,absolutePositioned:!0});r.clipPath=I;const D=r.getObjects().find(B=>B.name==="__background__");D&&D.set({left:o,top:a,width:c,height:w})}r.requestRenderAll(),r.skipTargetFind=!1,r.getObjects().forEach(o=>{o.name!=="__background__"&&o.name!=="__crop__"&&(o.selectable=!0,o.evented=!0)}),r.defaultCursor="default",r.hoverCursor="default",r.moveCursor="default",r.upperCanvasEl&&(r.upperCanvasEl.style.cursor="default"),T.current&&(T.current.style.display="none")}},[se,ce,K,A,O,te,L]),t.useEffect(()=>{const r=b=>{const l=Ie.current;if(l){if(b.key==="Escape")fe("select");else if(b.key==="Enter"&&se==="crop"){const n=M.current;if(n){const o=Math.max(0,Math.floor(n.left??0)),a=Math.max(0,Math.floor(n.top??0)),c=Math.max(1,Math.floor((n.width??0)*(n.scaleX??1))),w=Math.max(1,Math.floor((n.height??0)*(n.scaleY??1)));m.current={left:o,top:a,width:c,height:w};const I=new Hs({left:o,top:a,width:c,height:w,absolutePositioned:!0});l.clipPath=I;const D=l.getObjects().find(v=>v.name==="__background__");D&&D.set({left:o,top:a,width:c,height:w}),n.visible=!1,fe("select"),l.requestRenderAll();const B=Ie.current?()=>{const v=Ie.current;if(!v)return;const p=v.toJSON(["name","sourceNodeId","originalUrl"]);Array.isArray(p.objects)&&(p.objects=p.objects.map(X=>(X&&X.type==="image"&&X.originalUrl&&(X.src=X.originalUrl),X)));const d={canvasJson:p,appliedCrop:m.current},E=JSON.stringify(d);try{localStorage.setItem(`superCanvas:${C}`,E)}catch{}ge(C)&&de(X=>X.map(J=>J.id===C?{...J,data:{...J.data,canvasState:E}}:J))}:null;B&&B()}}}};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r)}},[se]),t.useEffect(()=>{const r=Ie.current;if(!r)return;const b=w=>{const I=r.getPointer(w.e);if(we.current=!0,ie.current={x:I.x,y:I.y},(se==="line"||se==="arrow")&&(r.discardActiveObject(),r.skipTargetFind=!0,r.getObjects().forEach(D=>{D.name!=="__background__"&&D.name!=="__crop__"&&(D.selectable=!1,D.evented=!1)})),se==="line"){const D=[I.x,I.y,I.x,I.y],B=new sr(D,{strokeWidth:K/2,fill:ce,stroke:ce,originX:"center",originY:"center",strokeLineCap:"round"});R.current=B,r.add(B)}else if(se==="arrow"){const D=[I.x,I.y,I.x,I.y],B=new sr(D,{strokeWidth:K/2,fill:ce,stroke:ce,originX:"center",originY:"center",strokeLineCap:"round",objectCaching:!1});R.current=B,r.add(B)}else if(se==="text"){const D=new Ur("Type here",{left:I.x,top:I.y,fontFamily:"Arial",fill:ce,fontSize:K*10,width:300,splitByGrapheme:!0});D.lockScalingY=!1,D.lockScalingFlip=!0,D.lockUniScaling=!1,D.setControlsVisibility({mt:!1,mb:!1}),r.add(D),r.setActiveObject(D),D.enterEditing(),fe("select")}else if(se==="eraser"){const D=r.getObjects();for(let B=D.length-1;B>=0;B--){const v=D[B];if(!(v.name==="__background__"||v.name==="__crop__"||v.name==="__input_image__"||v.sourceNodeId)&&v.containsPoint(I)){r.remove(v);break}}r.requestRenderAll()}},l=w=>{const I=r.getPointer(w.e);if(se==="brush"&&T.current){const B=r.getZoom(),v=K*B,p=v/2;T.current.style.width=`${v}px`,T.current.style.height=`${v}px`,T.current.style.left=`${I.x*B-p}px`,T.current.style.top=`${I.y*B-p}px`,T.current.style.borderColor=`rgba(${parseInt(ce.slice(1,3),16)},${parseInt(ce.slice(3,5),16)},${parseInt(ce.slice(5,7),16)},0.7)`,T.current.style.borderWidth="1px",T.current.style.background="transparent"}if(!we.current)return;const D=R.current;if(se==="line"&&D&&D instanceof sr)D.set({x2:I.x,y2:I.y}),D.setCoords(),r.requestRenderAll();else if(se==="arrow"&&D&&D instanceof sr)D.set({x2:I.x,y2:I.y}),D.setCoords(),r.requestRenderAll();else if(se==="eraser"){const B=r.getObjects();for(let v=B.length-1;v>=0;v--){const p=B[v];p.name==="__background__"||p.name==="__crop__"||p.name==="__input_image__"||p.sourceNodeId||p.containsPoint(I)&&r.remove(p)}r.requestRenderAll()}},n=()=>{if(we.current=!1,se==="arrow"&&R.current instanceof sr){const w=R.current,I=Math.atan2(w.y2-w.y1,w.x2-w.x1),D=Math.max(K*10,120),B=Math.PI/6,v=-Math.cos(I),p=-Math.sin(I),d=Math.cos(B),E=Math.sin(B),Y=w.x2+D*(v*d-p*E),X=w.y2+D*(v*E+p*d),J=w.x2+D*(v*d+p*E),F=w.y2+D*(-v*E+p*d),ae=w.strokeWidth||K/2,oe=new sr([w.x2,w.y2,Y,X],{stroke:ce,strokeWidth:ae,strokeLineCap:"round"}),le=new sr([w.x2,w.y2,J,F],{stroke:ce,strokeWidth:ae,strokeLineCap:"round"});r.add(oe),r.add(le);const S=new va([w,oe,le],{selectable:!0,evented:!0});r.remove(w),r.remove(oe),r.remove(le),r.add(S)}R.current=null,(se==="line"||se==="arrow")&&(r.skipTargetFind=!0,r.getObjects().forEach(w=>{w.name!=="__background__"&&w.name!=="__crop__"&&(w.selectable=!1,w.evented=!1)}))},o=w=>{var v;const I=w.target;if(!I)return;const D=I.type==="textbox"||I instanceof Ur,B=I.type==="i-text"||I instanceof Na;if(D||B){const p=(v=w==null?void 0:w.transform)==null?void 0:v.corner;if(p==="ml"||p==="mr"){const d=Math.max(50,(I.width||50)*(I.scaleX||1));I.set({width:d,scaleX:1,scaleY:1})}else{const d=I.scaleX||1,E=I.fontSize||40,Y=Math.max(6,Math.min(512,Math.round(E*d)));I.set({fontSize:Y,scaleX:1,scaleY:1})}I.setCoords(),r.requestRenderAll()}},a=()=>{se==="brush"&&T.current&&(T.current.style.display="block")},c=()=>{T.current&&(T.current.style.display="none")};return r.on("mouse:down",b),r.on("mouse:move",l),r.on("mouse:up",n),r.on("mouse:over",a),r.on("mouse:out",c),r.on("object:scaling",o),()=>{r.off("mouse:down",b),r.off("mouse:move",l),r.off("mouse:up",n),r.off("mouse:over",a),r.off("mouse:out",c),r.off("object:scaling",o)}},[se,ce,K]),e.jsxs("div",{ref:$,className:`relative flex flex-col w-[800px] h-auto bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-slate-200 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,children:[e.jsx("style",{children:`
                .super-color-input::-webkit-color-swatch-wrapper { padding: 0; }
                .super-color-input::-webkit-color-swatch { border: 1px solid #ffffff; }
                .super-color-input::-moz-color-swatch { border: 1px solid #ffffff; }
                `}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yr,{className:"text-slate-800 dark:text-white",size:16}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"è‡ªç”±ç”»å¸ƒ"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 p-4",children:[e.jsx("div",{ref:Q,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-white/10",children:e.jsx("div",{ref:T,className:"pointer-events-none absolute rounded-full border hidden z-10"})}),e.jsx("div",{className:"h-12 flex items-center gap-2",children:e.jsxs("div",{className:"flex-1 flex items-center gap-1 bg-slate-100 dark:bg-white/5 p-1 rounded-lg overflow-x-auto scrollbar-hide border border-slate-200 dark:border-white/10",children:[[{id:"select",icon:yr,label:"Select"},{id:"pencil",icon:Or,label:"Pencil"},{id:"brush",icon:Ia,label:"Brush"},{id:"line",icon:_a,label:"Line"},{id:"arrow",icon:ja,label:"Arrow"},{id:"text",icon:Ua,label:"Text"},{id:"eraser",icon:Ca,label:"Eraser"},{id:"crop",icon:Ea,label:"Crop"}].map(r=>e.jsx("button",{onClick:()=>fe(r.id),className:`p-2 rounded-lg transition-all ${se===r.id?"bg-purple-500/20 text-purple-400 shadow-sm":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,title:r.label,children:e.jsx(r.icon,{size:16})},r.id)),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{const r=Ie.current,b=r==null?void 0:r.getActiveObject();b&&(r==null||r.remove(b),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all",title:"Delete",children:e.jsx(Gr,{size:16})}),e.jsx("button",{onClick:()=>{const r=Ie.current,b=r==null?void 0:r.getActiveObject();b&&(r==null||r.bringObjectToFront(b),r==null||r.requestRenderAll())},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Bring to Front",children:e.jsx(Ra,{size:16})}),e.jsx("button",{onClick:()=>{const r=Ie.current,b=r==null?void 0:r.getActiveObject();if(b){r==null||r.sendObjectToBack(b);const l=r==null?void 0:r.getObjects().find(n=>n.name==="__background__");l&&(r==null||r.sendObjectToBack(l)),r==null||r.requestRenderAll()}},className:"p-2 rounded-lg text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all",title:"Send to Back",children:e.jsx(Ta,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Color"}),e.jsx("input",{type:"color",value:ce,onChange:r=>Ce(r.target.value),className:"super-color-input w-4 h-4 rounded cursor-pointer border border-slate-200 dark:border-white/10",title:"Brush Color"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400",children:"Size"}),e.jsx("input",{type:"range",min:se==="brush"?80:10,max:se==="brush"?400:30,value:K,onChange:r=>{const b=parseInt(r.target.value);De(b)},onMouseDown:r=>r.stopPropagation(),onTouchStart:r=>r.stopPropagation(),className:"nodrag w-10 h-2 bg-slate-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer",title:"Brush Size"}),e.jsx("span",{className:"text-[10px] text-gray-400 w-5 text-right",children:K})]}),e.jsx("div",{className:"w-px h-4 bg-white/10 mx-1"}),e.jsx("button",{disabled:se==="crop",onClick:async()=>{var be,Se,ye;const r=Ie.current;if(!r)return;r.discardActiveObject();const b=[...r.viewportTransform],l=r.getWidth(),n=r.getHeight();r.setViewportTransform([1,0,0,1,0,0]),r.setWidth(j),r.setHeight(j);const o=r.clipPath;r.clipPath=void 0;const a=m.current;let c="",w=A,I=O;a?(w=a.width,I=a.height,c=r.toDataURL({format:"png",quality:1,left:a.left,top:a.top,width:a.width,height:a.height,multiplier:1})):c=r.toDataURL({format:"png",quality:1,multiplier:1,left:0,top:0,width:A,height:O}),r.clipPath=o,r.setViewportTransform(b),r.setWidth(l),r.setHeight(n),r.requestRenderAll();const D=`${w}:${I}`,B=ge(C);if(!B)return;let v=c;try{const _e=c.split(",")[1],je=atob(_e),Te=new Array(je.length);for(let Ft=0;Ft<je.length;Ft++)Te[Ft]=je.charCodeAt(Ft);const Re=new Uint8Array(Te),re=new Blob([Re],{type:"image/png"}),Be=`canvas-export-${Date.now()}.png`,qe=await Me.post("/assets/presigned-url",{fileName:Be,contentType:"image/png"});if(qe.success&&qe.data){const{uploadUrl:Ft,publicUrl:at}=qe.data;await(await gs(async()=>{const{default:Le}=await import("./utils-BcyDR7Vi.js");return{default:Le}},[])).default.put(Ft,re,{headers:{"Content-Type":"image/png"},timeout:3e5}),v=at}}catch{}const p=Oe&&((be=Oe())==null?void 0:be.zoom)||1,d=document.querySelector(`.react-flow__node[data-id="${C}"]`),E=(d==null?void 0:d.getBoundingClientRect().width)||400,Y=Math.round(E/p),X=400,J=(_e,je=300)=>{if(!_e||!/^[0-9]+\s*:\s*[0-9]+$/.test(_e))return je;const[Te,Re]=_e.split(":").map(re=>parseFloat(re));return!Te||!Re?je:Math.round(X*(Re/Te))},F=200,ae=100,oe=J(D,300),le=ve(),S=ee(),k=le.filter(_e=>_e.type==="imagePreview"&&S.some(je=>je.source===C&&je.target===_e.id)).length,h=B.position.x+Y+F,W=B.position.y+k*(oe+ae),ue={id:`preview-${C}-${Date.now()}`,type:"imagePreview",position:{x:h,y:W},data:{imageUrl:v,width:X,ratio:D,workflowContext:(Se=B.data)==null?void 0:Se.workflowContext,createdBy:(ye=B.data)==null?void 0:ye.createdBy}};de(_e=>[..._e,ue]);const q={id:`edge-${C}-${ue.id}`,source:C,target:ue.id,targetHandle:`${ue.id}-target`,type:"aurora"};Z(_e=>_e.find(Te=>Te.source===C&&Te.target===ue.id)?_e:[..._e,q])},className:"nodrag px-3 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center whitespace-nowrap bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md",title:se==="crop"?"è¯·å…ˆå®Œæˆè£åˆ‡ï¼ˆæŒ‰Enterï¼‰":"å¯¼å‡ºå›¾ç‰‡",children:e.jsx("span",{children:"å¯¼å‡ºå›¾ç‰‡"})})]})}),e.jsx(vt,{type:"target",position:dt.Left,id:"input-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-purple-500 hover:!scale-125 !transition-transform !cursor-crosshair"}),e.jsx(vt,{type:"source",position:dt.Right,id:"output-image",style:{top:"50%"},className:"!w-4 !h-4 !border-2 !rounded-full !bg-[#0a0a0a] !border-purple-500 hover:!scale-125 !transition-transform !cursor-crosshair"})]})]})},Uo=t.memo(Ro),$o=({data:s,selected:C,id:u})=>{const[Q,Ie]=t.useState(s.config.upscaleResolution||"1080p"),[$,ve]=t.useState(!1),[ee,de]=t.useState(s.config.inputVideoUrl||""),[,Z]=t.useState(s.config.taskId||""),{setNodes:ge,setEdges:Oe}=ts(),he=Ds(),ne=Fs(),se=K=>{ge(De=>De.map(we=>we.id===u?{...we,data:{...we.data,config:{...we.data.config,...K}}}:we))};t.useEffect(()=>{var De,we,ie;const K=ne.filter(R=>R.target===u);if(K.length>0){const R=he.find(M=>M.id===K[0].source);if(R){const M=R.data,P=M.videoUrl||((De=M.config)==null?void 0:De.videoUrl)||((we=M.config)==null?void 0:we.outputVideoUrl)||((ie=M.config)==null?void 0:ie.resultUrl);P&&P!==ee&&(de(P),se({inputVideoUrl:P}))}}else ee&&(de(""),se({inputVideoUrl:""}))},[ne,he,u]),t.useEffect(()=>{const K=s.config.taskId;(async()=>{if(K)try{const ie=(await Me.get(`/tasks/${K}`)).task;if(ie.status==="SUCCESS"){const R=ie.resultUrl;se({outputVideoUrl:R,taskId:""}),ne.filter(x=>x.source===u).map(x=>he.find(m=>m.id===x.target)).filter(x=>x&&x.type==="videoPreview").find(x=>x.data.videoUrl===R)||ce(R),Dt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼"),ve(!1)}else ie.status==="PROCESSING"||ie.status==="PENDING"?(ve(!0),fe(K)):ie.status==="FAILURE"&&(ve(!1),se({taskId:""}),Dt.error(ie.errorMessage?`è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼š${ie.errorMessage}`:"è¶…æ¸…å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"))}catch{ve(!1),se({taskId:""}),Dt.error("æ— æ³•æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ï¼Œè¯·é‡æ–°å¤„ç†")}})()},[]);const fe=async K=>{let we=0;const ie=async()=>{try{we++;const M=(await Me.get(`/tasks/${K}`)).task;if(M.status==="SUCCESS"){const P=M.resultUrl;ve(!1),se({outputVideoUrl:P,taskId:""}),ce(P),Dt.success("ğŸ¬ æ™ºèƒ½è¶…æ¸…å®Œæˆï¼Œç”»è´¨æå‡æˆåŠŸï¼");return}else if(M.status==="FAILURE"){ve(!1),se({taskId:""}),Dt.error(M.errorMessage||"è¶…æ¸…å¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•");return}else(M.status==="PROCESSING"||M.status==="PENDING")&&(we<300?setTimeout(ie,3e3):(ve(!1),se({taskId:""}),Dt.error("ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")))}catch{ve(!1),se({taskId:""}),Dt.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};ie()},ce=K=>{var we;const De=he.find(ie=>ie.id===u);if(De){const ie=`preview-video-${Date.now()}`,R=Q==="1080p"?"HD":Q,M={id:ie,type:"videoPreview",position:{x:De.position.x+400,y:De.position.y},data:{label:"è¶…æ¸…è§†é¢‘",videoUrl:K,ratio:"16:9",resolution:R,createdBy:(we=De.data)==null?void 0:we.createdBy}},P={id:`edge-${u}-${ie}`,source:u,target:ie,type:"aurora"};ge(T=>[...T,M]),setTimeout(()=>{Oe(T=>[...T,P])},100)}},Ce=async()=>{var K,De;if(!ee){Dt.error("è¯·å…ˆè¿æ¥ä¸€ä¸ªè§†é¢‘~");return}ve(!0);try{const we=await Me.get("/ai/models?provider=vidu&isActive=true");if(!we||we.length===0){Dt.error("è¶…æ¸…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"),ve(!1);return}const ie=we[0],M=(await Me.post("/ai/video-upscale",{video_url:ee,upscale_resolution:Q,apiKey:ie.apiKey,apiUrl:ie.apiUrl})).taskId;Z(M),se({taskId:M,upscaleResolution:Q}),Dt.success("ğŸ¬ è¶…æ¸…å¤„ç†å·²å¯åŠ¨ï¼Œè§†é¢‘å¤„ç†éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…~"),fe(M)}catch(we){const ie=((De=(K=we.response)==null?void 0:K.data)==null?void 0:De.error)||we.message||"æœªçŸ¥åŸå› ";Dt.error(`å¯åŠ¨å¤±è´¥ï¼š${ie}ï¼Œè¯·ç¨åé‡è¯•`),ve(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(Xs,{type:"target",position:dt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"high_quality"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"æ™ºèƒ½è¶…æ¸…"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[ee&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-700",children:[e.jsx("video",{src:ee,className:"w-full h-32 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/50 rounded text-[10px] text-white",children:"è¾“å…¥è§†é¢‘"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç›®æ ‡åˆ†è¾¨ç‡"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:["1080p","2K","4K","8K"].map(K=>e.jsx("button",{type:"button",onClick:()=>{Ie(K),se({upscaleResolution:K})},disabled:$,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Q===K?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${$?"opacity-50 cursor-not-allowed":""}`,children:K},K))})]}),e.jsx("button",{type:"button",onClick:K=>{K.preventDefault(),K.stopPropagation(),Ce()},onMouseDown:K=>{K.stopPropagation()},disabled:$||!ee||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${$||!ee||s._canEdit===!1?"bg-slate-300 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[$?e.jsx(Qs,{className:"w-4 h-4 animate-spin"}):e.jsx(wa,{className:"w-4 h-4"}),e.jsx("span",{children:$?"å¤„ç†ä¸­...":"å¼€å§‹è¶…æ¸…"})]})})]}),e.jsx(Xs,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Mo=t.memo($o),Do=({data:s,selected:C,id:u})=>{const[Q,Ie]=t.useState(s.config.prompt||""),[$,ve]=t.useState(s.config.duration||30),[ee,de]=t.useState(s.config.ratio||"16:9"),[Z,ge]=t.useState(s.config.language||"zh"),[Oe,he]=t.useState(!1),[ne,se]=t.useState(s.config.images||[]),[,fe]=t.useState(s.config.taskId||""),{credits:ce,loading:Ce}=Ls({nodeType:"ad_composition",duration:$}),{setNodes:K,setEdges:De}=ts(),we=Ds(),ie=Fs(),R=x=>{K(m=>m.map(j=>j.id===u?{...j,data:{...j.data,config:{...j.data.config,...x}}}:j))};t.useEffect(()=>{const x=ie.filter(j=>j.target===u),m=[];x.forEach(j=>{var L,A,O,r,b,l,n,o,a,c;const te=we.find(w=>w.id===j.source);te&&(te.type==="imagePreview"&&((L=te.data)!=null&&L.imageUrl)?m.push(te.data.imageUrl):te.type==="aiImage"&&((O=(A=te.data)==null?void 0:A.config)!=null&&O.generatedImageUrl)?m.push(te.data.config.generatedImageUrl):te.type==="upload"&&((b=(r=te.data)==null?void 0:r.config)!=null&&b.uploadedFiles)?te.data.config.uploadedFiles.filter(I=>I.type==="IMAGE"||(I.mimeType||"").startsWith("image/")).forEach(I=>m.push(I.url)):te.type==="assetSelector"&&((n=(l=te.data)==null?void 0:l.config)!=null&&n.subjects?te.data.config.subjects.forEach(I=>{Array.isArray(I.images)&&I.images.forEach(D=>m.push(D.url))}):((c=(a=(o=te.data)==null?void 0:o.config)==null?void 0:a.selectedAsset)==null?void 0:c.type)==="IMAGE"&&m.push(te.data.config.selectedAsset.url)))}),JSON.stringify(m)!==JSON.stringify(ne)&&(se(m),R({images:m}))},[ie,we,u]),t.useEffect(()=>{const x=s.config.taskId;(async()=>{if(x)try{const te=(await Me.get(`/tasks/${x}`)).task;if(te.status==="SUCCESS"){const L=te.resultUrl;R({taskId:""}),he(!1)}else te.status==="PROCESSING"||te.status==="PENDING"?(he(!0),M(x)):te.status==="FAILURE"&&(he(!1),R({taskId:""}),Dt.error(`å¹¿å‘Šæˆç‰‡å¤±è´¥: ${te.errorMessage||"æœªçŸ¥é”™è¯¯"}`))}catch{he(!1),R({taskId:""})}})()},[]);const M=async x=>{let j=0;const te=async()=>{try{j++;const A=(await Me.get(`/tasks/${x}`)).task;if(A.status==="SUCCESS"){const O=A.resultUrl;he(!1),R({taskId:""}),P(O),Dt.success("å¹¿å‘Šæˆç‰‡å®Œæˆï¼");return}else if(A.status==="FAILURE"){he(!1),R({taskId:""}),Dt.error(A.errorMessage||"å¹¿å‘Šæˆç‰‡å¤±è´¥");return}else(A.status==="PROCESSING"||A.status==="PENDING")&&(j<120?setTimeout(te,1e4):(he(!1),R({taskId:""}),Dt.error("ä»»åŠ¡è¶…æ—¶ï¼Œè¯·é‡è¯•")))}catch{he(!1),R({taskId:""}),Dt.error("æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥")}};te()},P=x=>{var j;const m=we.find(te=>te.id===u);if(m){const te=`preview-video-${Date.now()}`,L={id:te,type:"videoPreview",position:{x:m.position.x+400,y:m.position.y},data:{label:"å¹¿å‘Šæˆç‰‡",videoUrl:x,ratio:ee,width:320,createdBy:(j=m.data)==null?void 0:j.createdBy}},A={id:`edge-${u}-${te}`,source:u,target:te,type:"aurora"};K(O=>[...O,L]),setTimeout(()=>{De(O=>[...O,A])},100)}},T=async()=>{var x,m,j,te,L;if(ne.length===0){Dt.error("è¯·å…ˆè¿æ¥è‡³å°‘ä¸€å¼ å›¾ç‰‡");return}if(ne.length>15){Dt.error("æœ€å¤šæ”¯æŒ15å¼ å›¾ç‰‡");return}if(!Q.trim()){Dt.error("è¯·è¾“å…¥æç¤ºè¯");return}he(!0);try{const A=await Me.get("/ai/models?provider=vidu&isActive=true");if(!A||A.length===0){Dt.error("æœªæ‰¾åˆ°å¯ç”¨çš„ Vidu æ¨¡å‹é…ç½®"),he(!1);return}const O=A[0],r={images:ne,prompt:Q,duration:$,ratio:ee,language:Z,apiKey:O.apiKey,apiUrl:O.apiUrl},b=await Me.post("/ai/commercial-video",r),l=b.taskId,n=b.creditsCharged||0;if(fe(l),R({taskId:l,images:ne,prompt:Q,duration:$,ratio:ee,language:Z}),n>0)try{const{useAuthStore:o}=await gs(async()=>{const{useAuthStore:c}=await import("./index-Cp0uMTfX.js").then(w=>w.f);return{useAuthStore:c}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:a}=o.getState();await a(),Dt.success(`ä»»åŠ¡å·²æäº¤ï¼ˆå·²æ‰£é™¤ ${n} ç§¯åˆ†ï¼‰`)}catch{Dt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...")}else Dt.success("ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆä¸­...");M(l)}catch(A){((x=A.response)==null?void 0:x.status)===403?Dt.error(((j=(m=A.response)==null?void 0:m.data)==null?void 0:j.error)||"æ‚¨æ²¡æœ‰æƒé™ä½¿ç”¨å¹¿å‘Šæˆç‰‡åŠŸèƒ½"):Dt.error(((L=(te=A.response)==null?void 0:te.data)==null?void 0:L.error)||A.message||"å¹¿å‘Šæˆç‰‡å¤±è´¥"),he(!1)}};return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${C?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(Xs,{type:"target",position:dt.Left,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 dark:from-pink-500/20 from-pink-200/50 via-purple-500/20 dark:via-purple-500/20 via-purple-200/50 to-cyan-500/20 dark:to-cyan-500/20 to-cyan-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"14px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"featured_video"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å¹¿å‘Šæˆç‰‡"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-[10px] text-slate-500 dark:text-slate-400",children:["å·²è¿æ¥å›¾ç‰‡ï¼š",ne.length,"/15"]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æç¤ºè¯"}),e.jsx("textarea",{value:Q,onChange:x=>{Ie(x.target.value),R({prompt:x.target.value}),x.target.style.height="auto",x.target.style.height=x.target.scrollHeight+"px"},onFocus:x=>{x.target.style.height="auto",x.target.style.height=x.target.scrollHeight+"px"},ref:x=>{x&&Q&&(x.style.height="auto",x.style.height=x.scrollHeight+"px")},disabled:Oe,placeholder:"æè¿°ä½ æƒ³è¦çš„å¹¿å‘Šå†…å®¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30 overflow-hidden",rows:2})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"æ—¶é•¿ï¼ˆç§’ï¼‰"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:[15,20,30,40,50,60].map(x=>e.jsxs("button",{type:"button",onClick:()=>{ve(x),R({duration:x})},disabled:Oe,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${$===x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Oe?"opacity-50 cursor-not-allowed":""}`,children:[x,"s"]},x))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è§†é¢‘æ¯”ä¾‹"}),e.jsx("div",{className:"grid grid-cols-3 gap-1",children:["16:9","9:16","1:1"].map(x=>e.jsx("button",{type:"button",onClick:()=>{de(x),R({ratio:x})},disabled:Oe,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${ee===x?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Oe?"opacity-50 cursor-not-allowed":""}`,children:x},x))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"è¯­è¨€"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:[{value:"zh",label:"ä¸­æ–‡"},{value:"en",label:"English"}].map(x=>e.jsx("button",{type:"button",onClick:()=>{ge(x.value),R({language:x.value})},disabled:Oe,className:`nodrag px-2 py-1 text-[10px] font-bold rounded-lg transition-all ${Z===x.value?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"} ${Oe?"opacity-50 cursor-not-allowed":""}`,children:x.label},x.value))})]}),e.jsx("button",{type:"button",onClick:T,disabled:Oe||ne.length===0||!Q.trim()||s._canEdit===!1,className:`w-full px-4 py-2.5 text-[11px] font-bold rounded-xl transition-all ${Oe||ne.length===0||!Q.trim()||s._canEdit===!1?"bg-slate-300 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[Oe?e.jsx(Qs,{className:"w-4 h-4 animate-spin"}):e.jsx(Aa,{className:"w-4 h-4"}),e.jsx("span",{children:Oe?"ç”Ÿæˆä¸­...":"å¼€å§‹ç”Ÿæˆ"}),!Oe&&!Ce&&ce!==null&&ce>0&&e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[ce,"ç§¯åˆ†"]})]})})]}),e.jsx(Xs,{type:"source",position:dt.Right,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"})]})},Lo=t.memo(Do),Po=[24,28,32,36,40,48,56,64,72,80,96,120,150,200],Oo=({data:s,selected:C,id:u})=>{const{setNodes:Q}=ts(),[Ie,$]=t.useState(s.text||"åŒå‡»ç¼–è¾‘æ–‡æœ¬"),[ve,ee]=t.useState(!1),[de,Z]=t.useState(!1),[ge,Oe]=t.useState(s.fontSize||36),[he,ne]=t.useState(s.width||200),[se,fe]=t.useState(s.bold||!1),ce=t.useRef(null),Ce=t.useRef(null),K=t.useCallback(ie=>{Q(R=>R.map(M=>M.id===u?{...M,data:{...M.data,...ie}}:M))},[u,Q]);t.useEffect(()=>{const ie=setTimeout(()=>{Ie!==s.text&&K({text:Ie})},300);return()=>clearTimeout(ie)},[Ie,s.text,K]),t.useEffect(()=>{K({fontSize:ge,width:he,bold:se})},[ge,he,se,K]);const De=()=>{ee(!0),setTimeout(()=>{ce.current&&(ce.current.focus(),ce.current.select(),ce.current.style.height="auto",ce.current.style.height=`${ce.current.scrollHeight}px`)},0)},we=()=>{ee(!1)};return t.useEffect(()=>{ve&&ce.current&&(ce.current.style.height="auto",ce.current.style.height=`${ce.current.scrollHeight}px`)},[ve,Ie]),t.useEffect(()=>{const ie=R=>{Ce.current&&!Ce.current.contains(R.target)&&Z(!1)};return de&&document.addEventListener("mousedown",ie),()=>document.removeEventListener("mousedown",ie)},[de]),e.jsxs("div",{className:`relative group ${C?"ring-2 ring-purple-400 ring-offset-2":""}`,style:{width:he},children:[e.jsx(fs,{createdBy:s.createdBy,isSharedWorkflow:s._isSharedWorkflow}),e.jsx("button",{onClick:ie=>{ie.stopPropagation(),Z(!de)},className:"absolute -top-8 right-0 w-6 h-6 rounded-md bg-white dark:bg-gray-800 shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-gray-100 dark:hover:bg-gray-700",title:"æ–‡æœ¬è®¾ç½®",children:e.jsx("span",{className:"material-symbols-outlined text-sm text-slate-600 dark:text-gray-300",children:"settings"})}),de&&e.jsxs("div",{ref:Ce,className:"absolute -top-2 left-full ml-2 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-slate-200 dark:border-white/10 p-3 min-w-[200px]",onClick:ie=>ie.stopPropagation(),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50 block mb-1",children:"å­—ä½“å¤§å°"}),e.jsx("select",{value:ge,onChange:ie=>Oe(Number(ie.target.value)),className:"nodrag w-full px-2 py-1.5 text-xs rounded-md border bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10 text-slate-700 dark:text-white focus:outline-none focus:border-purple-400",children:Po.map(ie=>e.jsxs("option",{value:ie,children:[ie,"px"]},ie))})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>fe(!se),className:`nodrag px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${se?"bg-purple-500 text-white":"bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/20"}`,children:[e.jsx("span",{className:"font-bold",children:"B"})," åŠ ç²—"]})})]}),ve?e.jsx("textarea",{ref:ce,value:Ie,onChange:ie=>$(ie.target.value),onBlur:we,onMouseDown:ie=>ie.stopPropagation(),onKeyDown:ie=>{ie.key==="Escape"&&ee(!1)},className:"nodrag w-full bg-transparent border-2 border-purple-400 rounded-lg p-2 resize-none focus:outline-none text-slate-900 dark:text-white",style:{fontSize:`${ge}px`,fontWeight:se?"bold":"normal"}}):e.jsx("div",{onDoubleClick:De,className:"w-full cursor-text select-none whitespace-pre-wrap break-words text-slate-900 dark:text-white",style:{fontSize:`${ge}px`,fontWeight:se?"bold":"normal"},children:Ie}),!ve&&e.jsx("div",{className:"nodrag absolute top-0 bottom-0 right-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",onMouseDown:ie=>{ie.stopPropagation(),ie.preventDefault();const R=ie.clientX,M=he,P=x=>{x.preventDefault();const m=Math.max(100,M+(x.clientX-R));ne(m)},T=()=>{document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",T)};document.addEventListener("mousemove",P),document.addEventListener("mouseup",T)},children:e.jsx("div",{className:"w-1 h-8 rounded-full bg-slate-300 dark:bg-white/30"})})]})},Go=t.memo(Oo),Vo=({data:s,id:C,selected:u})=>{const{getNode:Q,setNodes:Ie,setEdges:$}=ts(),ve=dr(t.useCallback(d=>d.edges.filter(E=>E.target===C),[C])),[ee,de]=t.useState(s.prompt||""),[Z,ge]=t.useState(s.points||[]),[Oe,he]=t.useState(!1),[ne,se]=t.useState(!1),[fe,ce]=t.useState(null),[Ce,K]=t.useState([]),[,De]=t.useState(s.generatedImageUrl||null),[we,ie]=t.useState(null),[,R]=t.useState(s.taskId||""),[,M]=t.useState(0),P=t.useRef(null),T=t.useRef(1),{credits:x,loading:m,isFreeUsage:j,freeUsageRemaining:te,refetch:L}=Ls({nodeType:"image_editing",quantity:1}),A=t.useCallback(d=>{Ie(E=>E.map(Y=>Y.id===C?{...Y,data:{...Y.data,...d}}:Y))},[C,Ie]),O=dr(t.useCallback(d=>d.edges.filter(E=>E.source===C),[C])),r=t.useCallback(d=>{var ae,oe;const E=Q(C);if(!E)return;const Y=O.find(le=>{const S=Q(le.target);return(S==null?void 0:S.type)==="imagePreview"});if(Y){const le=Y.target;Ie(S=>S.map(f=>f.id===le?{...f,data:{...f.data,imageUrl:d}}:f));return}const X=Date.now(),J=`preview-${C}-${X}`,F={id:J,type:"imagePreview",position:{x:(((ae=E==null?void 0:E.position)==null?void 0:ae.x)||0)+450,y:((oe=E==null?void 0:E.position)==null?void 0:oe.y)||0},data:{imageUrl:d,width:400}};setTimeout(()=>{Ie(S=>[...S,F]);const le={id:`edge-${C}-${J}`,source:C,target:J,targetHandle:`${J}-target`,type:"aurora"};$(S=>S.find(k=>k.source===C&&k.target===J)?S:[...S,le])},100)},[C,Q,Ie,$,O]),b=t.useRef({active:!1,timeoutId:null}),l=t.useCallback(async d=>{let Y=0;b.current.timeoutId&&clearTimeout(b.current.timeoutId),b.current.active=!0;const X=async()=>{if(b.current.active)try{Y++;const F=(await Me.tasks.getTaskStatus(d)).task;if(!b.current.active)return;if(M(F.progress||0),F.status==="SUCCESS"){b.current.active=!1,he(!1),M(100);const ae=F.resultUrl;A({generatedImageUrl:ae,taskId:""}),De(ae),g.success("ğŸ¨ ç¼–è¾‘å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼"),ae&&r(ae);return}else if(F.status==="FAILURE"){b.current.active=!1,he(!1),M(0),A({taskId:""}),g.error(F.errorMessage||"ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•");return}else(F.status==="PROCESSING"||F.status==="PENDING")&&(Y<300&&b.current.active?b.current.timeoutId=setTimeout(X,1e3):(b.current.active=!1,he(!1),M(0),A({taskId:""}),g.error("ç¼–è¾‘æ—¶é—´è¾ƒé•¿ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœæˆ–é‡æ–°å°è¯•")))}catch{b.current.active=!1,he(!1),M(0),A({taskId:""}),g.error("ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ")}};X()},[A,r]);t.useEffect(()=>()=>{b.current.active=!1,b.current.timeoutId&&clearTimeout(b.current.timeoutId)},[]),t.useEffect(()=>{const d=s.taskId;if(!d)return;(async()=>{try{const X=(await Me.tasks.getTaskStatus(d)).task;if(X.status==="SUCCESS"){he(!1),M(100);const J=X.resultUrl;J?(A({generatedImageUrl:J,taskId:""}),De(J),g.success("ğŸ¨ ç¼–è¾‘å·²å®Œæˆï¼Œå¿«æ¥çœ‹çœ‹æ•ˆæœå§ï¼")):A({taskId:""})}else X.status==="PROCESSING"||X.status==="PENDING"?(he(!0),M(X.progress||0),l(d)):X.status==="FAILURE"&&(he(!1),M(0),A({taskId:""}),g.error(X.errorMessage?`ç¼–è¾‘é‡åˆ°é—®é¢˜ï¼š${X.errorMessage}`:"ç¼–è¾‘æœªèƒ½å®Œæˆï¼Œè¯·é‡è¯•"))}catch{he(!1),M(0),A({taskId:""})}})()},[]);const n=t.useCallback(d=>{const E=new Image;E.onload=()=>{ie({width:E.naturalWidth,height:E.naturalHeight})},E.src=d},[]);t.useEffect(()=>{try{const d=[];ve.forEach(E=>{var F,ae,oe,le;const Y=Q(E.source);if(!Y)return;const X=Y.data;let J=null;X!=null&&X.url?J=X.url:X!=null&&X.imageUrl?J=X.imageUrl:X!=null&&X.output?J=X.output:(F=X==null?void 0:X.config)!=null&&F.generatedImageUrl?J=X.config.generatedImageUrl:(le=(oe=(ae=X==null?void 0:X.config)==null?void 0:ae.uploadedFiles)==null?void 0:oe[0])!=null&&le.url&&(J=X.config.uploadedFiles[0].url),J&&d.push(J)}),d.length>0?(ce(d[0]),K(d.slice(1)),n(d[0])):(ce(null),K([]),ie(null))}catch{}},[ve,Q,n]),t.useEffect(()=>{const d=setTimeout(()=>{Ie(E=>E.map(Y=>{if(Y.id!==C)return Y;const X=Y.data;return X.prompt===ee&&JSON.stringify(X.points)===JSON.stringify(Z)?Y:{...Y,data:{...Y.data,prompt:ee,points:Z}}}))},300);return()=>clearTimeout(d)},[ee,Z,C,Ie]);const o=t.useCallback(d=>{if(!d.ctrlKey&&!d.metaKey||!P.current)return;const E=P.current.getBoundingClientRect(),Y=(d.clientX-E.left)/E.width,X=(d.clientY-E.top)/E.height,J={id:T.current++,x:Math.max(0,Math.min(1,Y)),y:Math.max(0,Math.min(1,X))};ge(F=>[...F,J])},[]),a=t.useCallback(d=>{ge(E=>E.filter(Y=>Y.id!==d))},[]),c=t.useCallback((d,E)=>{ge(Y=>Y.map(X=>X.id===d?{...X,name:E}:X))},[]),w=t.useCallback((d,E)=>{d.stopPropagation();const Y=E.name?`@${E.name}`:`@ä½ç½®${E.id}`;d.dataTransfer.setData("text/plain",Y),d.dataTransfer.effectAllowed="copy"},[]),I=t.useCallback((d,E)=>{d.stopPropagation();const Y=`@å‚è€ƒå›¾${E+1}`;d.dataTransfer.setData("text/plain",Y),d.dataTransfer.effectAllowed="copy"},[]),D=t.useCallback(d=>{d.preventDefault(),d.stopPropagation(),d.dataTransfer.dropEffect="copy"},[]),B=t.useCallback(d=>{d.preventDefault(),d.stopPropagation();const E=d.dataTransfer.getData("text/plain");if(E){const Y=d.target,X=Y.selectionStart,J=Y.selectionEnd,F=ee.slice(0,X)+E+ee.slice(J);de(F),setTimeout(()=>{Y.selectionStart=Y.selectionEnd=X+E.length,Y.focus()},0)}},[ee]),v=t.useCallback(async()=>{var d;if(!(!fe||Z.length===0)){se(!0);try{const E=await Me.ai.imageEditing.identifyPoints({image:fe,points:Z.map(Y=>({id:Y.id,x:Y.x,y:Y.y}))});if(E.success&&((d=E.data)!=null&&d.points)){const Y=E.data.points;ge(X=>X.map(J=>{const F=Y.find(ae=>ae.id===J.id);return F?{...J,name:F.name}:J})),g.success("âœ¨ æ ‡è®°ç‚¹å·²è¯†åˆ«å®Œæˆ")}}catch{g.error("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{se(!1)}}},[fe,Z]),p=t.useCallback(async()=>{var d,E,Y,X,J;if(!fe){g.error("è¯·å…ˆè¿æ¥ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼–è¾‘å¯¹è±¡~");return}if(!ee.trim()){g.error("è¯·æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœ~");return}he(!0),M(0);try{const F=await Me.tasks.createImageEditTask({prompt:ee.trim(),mainImage:fe,referenceImages:Ce.length>0?Ce:void 0,points:Z.length>0?Z:void 0,sourceImageDimensions:we||void 0,sourceNodeId:C}),ae=F.taskId,oe=F.creditsCharged||0,le=F.isFreeUsage,S=F.freeUsageRemaining??0;if(R(ae),A({prompt:ee.trim(),points:Z,taskId:ae}),le)g.success(`ğŸ å…è´¹ç¼–è¾‘ä¸­ï¼Œä»Šæ—¥è¿˜å‰© ${S} æ¬¡æœºä¼š`),L();else if(oe>0){const{useAuthStore:f}=await gs(async()=>{const{useAuthStore:h}=await import("./index-Cp0uMTfX.js").then(W=>W.f);return{useAuthStore:h}},__vite__mapDeps([0,1,2,3,4,5])),{refreshUser:k}=f.getState();await k(),g.success(`âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œæ¶ˆè€— ${oe} ç§¯åˆ†`),L()}else g.success("âœ¨ ç¼–è¾‘å·²å¼€å§‹ï¼Œè¯·ç¨å€™...");l(ae)}catch(F){if(he(!1),M(0),((d=F.response)==null?void 0:d.status)===403){const ae=((Y=(E=F.response)==null?void 0:E.data)==null?void 0:Y.error)||"å½“å‰è´¦æˆ·æš‚æ— æ­¤åŠŸèƒ½æƒé™";g.error(ae)}else{const ae=((J=(X=F.response)==null?void 0:X.data)==null?void 0:J.error)||F.message||"æœªçŸ¥åŸå› ";g.error(`ç¼–è¾‘å¯åŠ¨å¤±è´¥ï¼š${ae}ï¼Œè¯·ç¨åé‡è¯•`)}}},[fe,ee,Ce,Z,we,C,A,l,L]);return e.jsxs("div",{className:`relative bg-white/80 dark:bg-black/60 backdrop-blur-xl border rounded-2xl shadow-xl transition-all ring-1 ${u?"border-purple-400 shadow-purple-400/50":"border-white/60 dark:border-white/10 ring-white/5 dark:ring-white/5 ring-black/5"}`,style:{width:320},children:[e.jsx(vt,{type:"target",position:dt.Left,id:`${C}-target`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsx(vt,{type:"source",position:dt.Right,id:`${C}-source`,className:"!w-3 !h-3 !border-2 !rounded-full !bg-white dark:!bg-black !border-slate-400 dark:!border-white hover:!scale-150 !transition-transform !cursor-crosshair !shadow-[0_0_5px_rgba(255,255,255,0.5)]"}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b rounded-t-2xl border-slate-200 dark:border-white/10 bg-gradient-to-r from-pink-500/20 from-pink-200/50 via-purple-500/20 via-purple-200/50 to-cyan-500/20 to-cyan-200/50 dark:from-pink-500/20 dark:via-purple-500/20 dark:to-cyan-500/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Or,{className:"w-4 h-4 text-slate-800 dark:text-white"}),e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase text-slate-800 dark:text-white",children:"å›¾ç‰‡ç¼–è¾‘"})]}),e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-green-400 animate-pulse shadow-[0_0_5px_currentColor]"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{ref:P,className:"relative w-full aspect-square bg-slate-100 dark:bg-white/5 rounded-lg overflow-hidden cursor-crosshair border border-slate-200 dark:border-white/10",onClick:o,children:fe?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:fe,alt:"Main",className:"w-full h-full object-contain",draggable:!1}),e.jsx("div",{className:"absolute bottom-2 left-2 right-2 text-center",children:e.jsx("span",{className:"px-2 py-1 bg-black/60 text-white text-[10px] rounded backdrop-blur-sm",children:"Ctrl+ç‚¹å‡» æ·»åŠ æ ‡è®°ç‚¹"})}),Z.map(d=>e.jsx("div",{className:"absolute w-6 h-6 -ml-3 -mt-3 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg border-2 border-white cursor-pointer hover:scale-110 transition-transform",style:{left:`${d.x*100}%`,top:`${d.y*100}%`},onClick:E=>{E.stopPropagation(),a(d.id)},title:d.name||`ç‚¹å‡»åˆ é™¤ #${d.id}`,children:d.id},d.id))]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-400 dark:text-white/30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(yr,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"è¿æ¥å›¾ç‰‡èŠ‚ç‚¹"}),e.jsx("p",{className:"text-[10px] mt-1 opacity-60",children:"Ctrl+ç‚¹å‡»æ·»åŠ æ ‡è®°ç‚¹"})]})})}),Ce.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-1",children:[Ce.map((d,E)=>e.jsx("img",{src:d,alt:`Ref ${E+1}`,draggable:!0,onDragStart:Y=>I(Y,E),className:"w-12 h-12 object-cover rounded border border-slate-200 dark:border-slate-700 flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥ @å‚è€ƒå›¾"},E)),e.jsxs("span",{className:"text-xs text-slate-500 self-center",children:["+",Ce.length," å‚è€ƒå›¾"]})]}),Z.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:["æ ‡è®°ç‚¹ (",Z.length,")"]}),e.jsxs("button",{onClick:v,disabled:ne||!fe,className:"text-[10px] text-purple-500 hover:text-purple-600 disabled:opacity-50 flex items-center gap-1",children:[ne?e.jsx(Qs,{className:"w-3 h-3 animate-spin"}):e.jsx(hr,{className:"w-3 h-3"}),"è‡ªåŠ¨è¯†åˆ«"]})]}),e.jsx("div",{className:"max-h-20 overflow-y-auto space-y-1",children:Z.map(d=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded text-xs",children:[e.jsx("span",{draggable:!0,onDragStart:E=>w(E,d),className:"w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 cursor-grab active:cursor-grabbing nodrag",title:"æ‹–åŠ¨åˆ°æŒ‡ä»¤æ¡†æ’å…¥æ ‡è®°",children:d.id}),e.jsx("input",{type:"text",placeholder:"ç‰©ä½“åç§°...",value:d.name||"",onChange:E=>c(d.id,E.target.value),className:"flex-1 px-2 py-1 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded text-slate-800 dark:text-white min-w-0 nodrag text-xs"}),e.jsx("button",{onClick:()=>a(d.id),className:"text-slate-400 hover:text-red-500",children:e.jsx(Gr,{className:"w-3 h-3"})})]},d.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold tracking-wider text-slate-400 dark:text-white/50",children:"ç¼–è¾‘æŒ‡ä»¤"}),e.jsx("textarea",{value:ee,onChange:d=>de(d.target.value),onDragOver:D,onDrop:B,placeholder:"æè¿°ä½ æƒ³è¦çš„ä¿®æ”¹...",className:"nodrag w-full p-2 text-xs rounded-md border outline-none resize-none transition-colors font-mono leading-relaxed bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 focus:bg-white dark:focus:bg-white/10 border-slate-200 dark:border-white/10 focus:border-purple-400 dark:focus:border-purple-400/50 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/30",style:{minHeight:"60px"}})]}),e.jsx("button",{onClick:p,onPointerDown:d=>d.stopPropagation(),onMouseDown:d=>d.stopPropagation(),disabled:Oe||!fe||!ee.trim(),className:`nodrag w-full mt-2 py-2 text-[10px] font-bold rounded-lg border transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${Oe?"bg-gray-600 dark:bg-gray-700 text-white cursor-wait border-transparent dark:border-white/10":"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600/50 dark:to-pink-600/50 text-white shadow-md hover:shadow-lg border-transparent dark:border-white/10"}`,children:Oe?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"ç¼–è¾‘ä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hr,{className:"w-3 h-3"}),e.jsx("span",{children:"æ‰§è¡Œç¼–è¾‘"}),!m&&(j?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-amber-500/40 text-amber-200 rounded text-[9px]",children:["å…è´¹ï¼Œä»Šæ—¥å‰©",te,"æ¬¡"]}):x!==null&&x>0?e.jsxs("span",{className:"ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px]",children:[x,"ç§¯åˆ†"]}):null)]})})]})]})},Wo=t.memo(Vo),Fo="https://api.waule.com",zo=({isOpen:s,onClose:C,onAssetSelect:u})=>{const[Q,Ie]=t.useState([]),[$,ve]=t.useState(""),[ee,de]=t.useState([]),[Z,ge]=t.useState([]),[Oe,he]=t.useState(!1),[ne,se]=t.useState("ALL"),[fe,ce]=t.useState("ALL");t.useEffect(()=>{s&&Ce()},[s]),t.useEffect(()=>{$&&De($)},[$]),t.useEffect(()=>{if(!s)return;const R=fe==="ALL"?Q:Q.filter(M=>(M.category||"OTHER")===fe);ve(R.length>0?R[0].id:"")},[fe,Q,s]);const Ce=async()=>{try{const M=(await Me.assetLibraries.getAll({includeShared:"true"})).data||[];if(Ie(M),M.length>0&&!$){const P=fe==="ALL"?M:M.filter(T=>(T.category||"OTHER")===fe);ve((P[0]||M[0]).id)}}catch{g.error("åŠ è½½èµ„äº§åº“å¤±è´¥")}};t.useEffect(()=>{const R=M=>{var T;const P=((T=M==null?void 0:M.detail)==null?void 0:T.libraryId)||$;Ce(),P&&De(P)};return window.addEventListener("asset-library-updated",R),()=>window.removeEventListener("asset-library-updated",R)},[$]);const K=R=>(/^https?:\/\//.test(R)?R:`${Fo}${R}`).replace(".oss-oss-",".oss-"),De=async R=>{var M,P,T,x,m;he(!0);try{const j=Q.find(L=>L.id===R);if(j&&(j.category||"OTHER")==="ROLE"){const A=(await Me.assetLibraries.roles.list(R)).data||[],O=[];for(const r of A){const b=r.metadata||{},l=[(M=b.images)==null?void 0:M.frontAssetId,(P=b.images)==null?void 0:P.sideAssetId,(T=b.images)==null?void 0:T.backAssetId,(x=b.images)==null?void 0:x.faceAssetId].filter(Boolean),n=[];for(const a of l)try{const w=(await Me.assets.getById(a)).data;n.push({id:w.id,url:K(w.url),name:w.name})}catch{}const o=r.thumbnail?K(r.thumbnail):((m=n[0])==null?void 0:m.url)||"";O.push({id:r.id,name:r.name,coverUrl:o,images:n})}ge(O),de([])}else{const A=(await Me.assetLibraries.getAssets(R)).data||[];de(A),ge([])}}catch{g.error("åŠ è½½èµ„äº§å¤±è´¥")}finally{he(!1)}},we=R=>{ve(R)},ie=R=>{u?(u(R),setTimeout(()=>{Ce(),$&&De($)},0)):g.info("è¯·åœ¨å·¥ä½œæµé¡µé¢ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")};return s?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:".no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}"}),e.jsx("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-40",onClick:C}),e.jsxs("div",{className:"fixed right-0 top-0 h-screen w-[520px] bg-card-light dark:bg-card-dark shadow-2xl z-50 flex flex-col animate-in slide-in-from-right duration-300 relative",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-purple-500/30 via-pink-500/50 to-cyan-500/30"}),e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-slate-800 dark:text-white",style:{fontSize:"20px",fontVariationSettings:'"FILL" 0, "wght" 200, "GRAD" 0, "opsz" 20'},children:"photo_library"}),e.jsx("h3",{className:"text-xl font-bold text-text-light-primary dark:text-text-dark-primary",children:"èµ„äº§åº“"})]}),e.jsx("button",{onClick:C,className:"p-2 rounded-lg text-text-light-secondary dark:text-text-dark-secondary hover:bg-card-light-hover dark:hover:bg-card-dark-hover transition-colors",children:e.jsx("span",{className:"material-symbols-outlined text-xl",style:{fontVariationSettings:'"FILL" 0, "wght" 200'},children:"close"})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:Q.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"photo_library"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary mb-2",children:"æš‚æ— èµ„äº§åº“"}),e.jsx("p",{className:"text-sm text-text-light-tertiary dark:text-text-dark-tertiary",children:"è¯·å…ˆåˆ›å»ºèµ„äº§åº“"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§ç±»å‹"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["IMAGE","VIDEO","AUDIO"].map(R=>e.jsx("button",{onClick:()=>se(R),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${ne===R?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"}`,children:R==="IMAGE"?"å›¾ç‰‡":R==="VIDEO"?"è§†é¢‘":"éŸ³é¢‘"},R))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"åº“ç±»åˆ«"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:["ROLE","SCENE","PROP","OTHER"].map(R=>e.jsx("button",{onClick:()=>ce(R),className:`h-8 w-full px-3 rounded-md text-xs font-medium transition-all flex items-center justify-center gap-1 border ${fe===R?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white border-transparent shadow-md":"bg-slate-100 dark:bg-white/5 text-slate-800 dark:text-white border-slate-200 dark:border-white/10 hover:border-purple-400 dark:hover:border-purple-400/50"}`,children:R==="ROLE"?"è§’è‰²åº“":R==="SCENE"?"åœºæ™¯åº“":R==="PROP"?"é“å…·åº“":"åˆ†é•œèµ„äº§"},R))})]}),e.jsxs("div",{className:"grid grid-cols-[96px,1fr] gap-2 items-center",children:[e.jsx("label",{className:"text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary whitespace-nowrap",children:"èµ„äº§åº“"}),(()=>{const R=fe==="ALL"?Q:Q.filter(M=>(M.category||"OTHER")===fe);return e.jsx("select",{value:$,onChange:M=>we(M.target.value),className:"flex-1 h-8 px-3 text-xs bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-md text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:R.map(M=>{var P;return e.jsxs("option",{value:M.id,children:[M.isShared?`[å…±äº«] ${M.name}`:M.name," (",M._count.assets,")",M.isShared&&((P=M.owner)!=null&&P.nickname)?` - ${M.owner.nickname}`:""]},M.id)})})})()]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 no-scrollbar",children:Oe?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-tiffany-500 animate-spin",children:"progress_activity"}),e.jsx("p",{className:"text-text-light-secondary dark:text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})}):(()=>{const R=Q.find(T=>T.id===$);if(R&&(R.category||"OTHER")==="ROLE")return Z.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"è¯¥è§’è‰²åº“æš‚æ— è§’è‰²"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:Z.map(T=>e.jsxs("div",{onClick:()=>u&&u(T),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[T.coverUrl?e.jsx("img",{src:T.coverUrl,alt:T.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-4xl text-text-light-secondary dark:text-text-dark-secondary",children:"person"})}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:T.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[T.images.length," å¼ å‚è€ƒå›¾"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:"groups"})})]},T.id))});const P=ee.filter(T=>ne==="ALL"||T.type===ne);return P.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("span",{className:"material-symbols-outlined text-7xl text-gray-400 mb-4",children:"folder_open"}),e.jsx("p",{className:"text-lg text-text-light-secondary dark:text-text-dark-secondary",children:"æ²¡æœ‰åŒ¹é…çš„èµ„äº§"})]}):e.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:P.map(T=>e.jsxs("div",{onClick:()=>ie(T),className:"w-[150px] h-[150px] bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-tiffany-400 hover:scale-105 transition-all duration-200 group relative shadow-md",children:[T.type==="IMAGE"?e.jsx("img",{src:K(T.url),alt:T.name,className:"w-full h-full object-cover"}):T.type==="VIDEO"?e.jsx("video",{src:K(T.url),className:"w-full h-full object-cover"}):T.type==="AUDIO"?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-blue-400 mb-2",children:"audio_file"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:T.name})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-3",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 mb-2",children:"description"}),e.jsx("p",{className:"text-xs text-center text-text-light-primary dark:text-text-dark-primary truncate w-full px-1",children:T.name})]}),e.jsxs("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-xs font-medium text-white truncate",children:T.name}),e.jsxs("p",{className:"text-xs text-white/70",children:[(T.size/(1024*1024)).toFixed(2)," MB"]})]}),e.jsx("div",{className:"absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-black/70 backdrop-blur-sm rounded",children:e.jsx("span",{className:"material-symbols-outlined text-white text-sm",children:T.type==="IMAGE"?"image":T.type==="VIDEO"?"video_file":T.type==="AUDIO"?"audio_file":"description"})})]},T.id))})})()})]})})]})]}):null},Bo={agent:ao,aiImage:Pa,aiVideo:nr,soraVideo:bo,soraCharacter:yo,aiVideo_t2v:Va,aiVideo_i2v_first:Fa,aiVideo_i2v_last:Ba,aiVideo_first_last:Xa,aiVideo_reference:qa,aiVideo_swap:Ka,aiVideo_lipsync:Za,aiVideo_style:so,upload:no,assetSelector:lo,imagePreview:uo,videoPreview:fo,textPreview:ho,midjourney:mo,audioVoice:vo,voiceClone:jo,audioSynthesize:So,audioDesign:To,audioPreview:Ao,superCanvas:Uo,videoUpscale:Mo,commercialVideo:Lo,textAnnotation:Go,imageEditing:Wo},Ho={aurora:Eo},Xo=()=>{const{id:s,projectId:C,episodeId:u,workflowId:Q}=ia(),Ie=!!Q,$=la(),ve=Pr(),ee=t.useMemo(()=>new URLSearchParams(ve.search),[ve.search]),de=t.useMemo(()=>{const i=Number(ee.get("scene"));return Number.isFinite(i)&&i>0?i:void 0},[ee]),Z=t.useMemo(()=>{const i=Number(ee.get("shot"));return Number.isFinite(i)&&i>0?i:void 0},[ee]),{screenToFlowPosition:ge,setCenter:Oe,getViewport:he,fitView:ne}=ts(),{setTitle:se}=da(),fe=kr(i=>i.user),[ce,Ce]=t.useState(null),[K,De]=t.useState(null),[we,ie]=t.useState(!0),[R,M,P]=fa([]),[T,x,m]=ga([]),[j,te]=t.useState(!1),L=t.useRef(!1),[A,O]=t.useState(null),[r,b]=t.useState(null),[l,n]=t.useState(!0),o=t.useRef(null),[a,c]=t.useState(!1),w=t.useRef(null),[I,D]=t.useState(!1),[B,v]=t.useState(null),[p,d]=t.useState([]),[E,Y]=t.useState([]),[X,J]=t.useState(null),[F,ae]=t.useState(null),oe=t.useRef(null),le=t.useRef(null),S=X==="video",f=X==="edit",k=i=>J(null),h=i=>J(i?"video":null),W=i=>J(i?"edit":null),ue=oe,q=F==="agent",be=i=>ae(i?"agent":null),Se=le,ye=le,_e=t.useCallback(i=>{const y=(i||"").toLowerCase().replace(/[_\-\s]+/g," ");return y?y.includes("æ–‡ç”Ÿ")||y.includes("text to video")||y.includes("t2v")||y.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":y.includes("é¦–å°¾")||y.includes("first last")||y.includes("two frame")||y.includes("frame pair")||y.includes("first-last")?"é¦–å°¾å¸§":y.includes("é¦–å¸§")||y.includes("first frame")||y.includes("start frame")||y.includes("initial frame")||y.includes("keyframe")?"é¦–å¸§":y.includes("å°¾å¸§")||y.includes("last frame")||y.includes("end frame")||y.includes("final frame")?"å°¾å¸§":y.includes("ä¸»ä½“å‚è€ƒ")||y.includes("subject reference")||y.includes("å‚è€ƒ")||y.includes("reference image")||y.includes("image reference")||y.includes("ref image")?"å‚è€ƒå›¾":i||"":""},[]),je=t.useMemo(()=>{const i=new Set;return(p||[]).filter(U=>(U.type||"")==="VIDEO_GENERATION").forEach(U=>{var H;(Array.isArray((H=U==null?void 0:U.config)==null?void 0:H.supportedGenerationTypes)?U.config.supportedGenerationTypes:[]).forEach(xe=>{const Ee=_e(xe);Ee&&i.add(Ee)})}),i},[p,_e]),Te=t.useMemo(()=>["è§†é¢‘æ¢äºº","åŠ¨ä½œå…‹éš†","è§†é¢‘æ¢èƒŒæ™¯","é£æ ¼è½¬æ¢","å¯¹å£å‹"],[]),Re=t.useCallback(i=>{const y=(p||[]).filter(H=>(H.type||"")==="VIDEO_EDITING").filter(H=>{var xe;return Array.isArray((xe=H==null?void 0:H.config)==null?void 0:xe.supportedEditingCapabilities)&&H.config.supportedEditingCapabilities.includes(i)}),U=(p||[]).filter(H=>(H.type||"")==="VIDEO_GENERATION").filter(H=>{var ze,Fe;if(i!=="è§†é¢‘æ¢äºº")return!1;const xe=((ze=H==null?void 0:H.config)==null?void 0:ze.supportsVideoEditing)===!0,$e=(Array.isArray((Fe=H==null?void 0:H.config)==null?void 0:Fe.supportedGenerationTypes)?H.config.supportedGenerationTypes:[]).some(Ke=>_e(Ke)==="è§†é¢‘æ¢äºº");return xe||$e}),V={};return[...y,...U].forEach(H=>{V[H.id]||(V[H.id]=H)}),Object.values(V)},[p,_e]),[re,Be]=t.useState(!1),[qe,Ft]=t.useState(null),at=t.useRef(null),ot=t.useRef(),[Le,ut]=t.useState([]),[Et,nt]=t.useState(null),[yt,Ot]=t.useState(null),[tt,_t]=t.useState(!1),[Kt,bs]=t.useState(null),[cs,Rs]=t.useState(null),[ws,zs]=t.useState(null),Nt=t.useRef([]),Ps=t.useRef(null),[ys,Zs]=t.useState(!1),[hs,Js]=t.useState(!1),[qs,rr]=t.useState(0),Ss=t.useRef(null),Ns=t.useRef(null),ms=t.useRef([]),Es=t.useRef([]),Ys=t.useRef(0),G=!!u,z=G&&!!de&&!!Z,Pe=Ie?Q:z?`${u}-${de}-${Z}`:G?u:s,Ue=z,[Xe,We]=t.useState(!1),Ye=t.useRef(new Set),ct=t.useRef(new Set),N=t.useRef(new Set),_=t.useRef(new Set),pe=t.useRef(new Map),Ae=t.useRef(new Set),Ne=t.useCallback((i,y)=>{y!==o.current&&(Ye.current.add(i.id),M(U=>U.some(V=>V.id===i.id)?U:[...U,{...i,data:{...i.data,models:p}}]))},[p,M]),me=t.useCallback((i,y,U)=>{U!==o.current&&(Ae.current.add(i),M(V=>V.map(H=>H.id===i?{...H,data:{...H.data,...y}}:H)),setTimeout(()=>Ae.current.delete(i),100))},[M]),Qe=t.useCallback((i,y)=>{y!==o.current&&(M(U=>U.filter(V=>V.id!==i)),x(U=>U.filter(V=>V.source!==i&&V.target!==i)))},[M,x]),Ze=t.useCallback((i,y,U)=>{U!==o.current&&M(V=>V.map(H=>H.id===i?{...H,position:y}:H))},[M]),xt=t.useCallback((i,y)=>{y!==o.current&&M(U=>U.map(V=>{const H=i.find(xe=>xe.id===V.id);return H?{...V,position:H.position}:V}))},[M]),it=t.useCallback((i,y)=>{y!==o.current&&(ct.current.add(i.id),x(U=>U.some(V=>V.id===i.id)?U:[...U,i]))},[x]),Ge=t.useCallback((i,y)=>{y!==o.current&&x(U=>U.filter(V=>V.id!==i))},[x]),Rt=t.useCallback((i,y)=>{y!==o.current&&(ut(i),Nt.current=i)},[]),{emitNodeAdd:Bt,emitNodeUpdate:$t,emitNodeDelete:Gt,emitNodesMove:wt,emitEdgeAdd:It,emitEdgeDelete:Mt,emitGroupsUpdate:Lt,onlineUsers:es}=Ma({workflowId:w.current,isSharedWorkflow:a,isReadOnly:j,onNodeAdd:Ne,onNodeUpdate:me,onNodeDelete:Qe,onNodeMove:Ze,onNodesMove:xt,onEdgeAdd:it,onEdgeDelete:Ge,onGroupsUpdate:Rt});t.useEffect(()=>{Nt.current=Le},[Le]),t.useEffect(()=>{ms.current=R,Ys.current=R.length},[R]),t.useEffect(()=>{Es.current=T},[T]),t.useEffect(()=>{if(!Xe){N.current=new Set(R.map(H=>H.id));const V=new Map;R.forEach(H=>{var xe;try{V.set(H.id,JSON.stringify(((xe=H.data)==null?void 0:xe.config)||{}))}catch{V.set(H.id,"{}")}}),pe.current=V;return}if(!a||L.current){N.current=new Set(R.map(V=>V.id));return}const i=new Set(R.map(V=>V.id)),y=N.current;R.forEach(V=>{var H,xe;if(!y.has(V.id))Ye.current.has(V.id)||Bt(V);else if(!Ae.current.has(V.id))try{const Ee=JSON.stringify(((H=V.data)==null?void 0:H.config)||{}),$e=pe.current.get(V.id)||"{}";Ee!==$e&&$t(V.id,{config:(xe=V.data)==null?void 0:xe.config})}catch{}}),N.current=i;const U=new Map;R.forEach(V=>{var H;try{U.set(V.id,JSON.stringify(((H=V.data)==null?void 0:H.config)||{}))}catch{U.set(V.id,"{}")}}),pe.current=U,Ye.current=new Set([...Ye.current].filter(V=>i.has(V)))},[R,a,Xe,Bt,$t]),t.useEffect(()=>{if(!Xe){_.current=new Set(T.map(U=>U.id));return}if(!a||L.current){_.current=new Set(T.map(U=>U.id));return}const i=new Set(T.map(U=>U.id)),y=_.current;T.forEach(U=>{y.has(U.id)||ct.current.has(U.id)||It(U)}),_.current=i,ct.current=new Set([...ct.current].filter(U=>i.has(U)))},[T,a,Xe,It]);const ns=t.useCallback(i=>{var H;if(L.current)return!1;if(l)return!0;if(Nt.current.some(xe=>{var Ee;return!xe.hidden&&((Ee=xe.nodeIds)==null?void 0:Ee.includes(i.id))}))return!1;if(z)return!0;const U=(H=i.data)==null?void 0:H.createdBy;return(typeof U=="object"?U==null?void 0:U.id:U)===o.current},[l,z]),Cs=t.useMemo(()=>{const i=new Set(Le.filter(y=>!y.hidden).flatMap(y=>y.nodeIds||[]));return R.map(y=>{const U=i.has(y.id),V=U?!1:l?!0:ns(y);return{...y,draggable:y.draggable!==!1,connectable:U?!1:y.connectable!==!1,data:{...y.data,_canEdit:V,_isGrouped:U,_currentUserId:r,_isSharedWorkflow:a}}})},[R,Le,l,ns,r,a,j]),er=t.useRef(null),Us=t.useRef(new Map),xs=t.useCallback(i=>{if(L.current){P(i);return}const y=i.filter(V=>{var ze;if(V.type!=="position")return!0;if(Nt.current.find(Fe=>{var Ke;return!Fe.hidden&&((Ke=Fe.nodeIds)==null?void 0:Ke.includes(V.id))}))return l;if(l)return!0;const xe=ms.current.find(Fe=>Fe.id===V.id);if(!xe)return!0;const Ee=(ze=xe.data)==null?void 0:ze.createdBy;return(typeof Ee=="object"?Ee==null?void 0:Ee.id:Ee)===o.current});P(y);const U=y.filter(V=>V.type==="position"&&V.position);U.length>0&&(U.forEach(V=>{Us.current.set(V.id,V.position)}),er.current&&clearTimeout(er.current),er.current=setTimeout(()=>{const V=Array.from(Us.current.entries()).map(([H,xe])=>({id:H,position:xe}));V.length>0&&(wt(V),Us.current.clear())},100))},[l,P,wt]);t.useEffect(()=>{Ps.current=cs},[cs]),t.useEffect(()=>{const i=y=>{y.key==="Escape"&&(ys&&Zs(!1),hs&&Js(!1))};return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[ys,hs]),t.useEffect(()=>{Pe&&(D(!1),We(!1),Os(),js(),ks(),zt().finally(()=>{We(!0)}))},[Pe]),t.useEffect(()=>{if(!we&&!I&&R.length>0){const i=setTimeout(()=>{ne({padding:.1,duration:800,maxZoom:1.5}),D(!0)},100);return()=>clearTimeout(i)}},[we,I,R.length,ne]),t.useEffect(()=>{var U,V;if(!z||!K||!ce||!Xe)return;const i=Le.find(H=>H.scene===de&&H.shot===Z);if(i){Ot(i.id),nt(i.id);try{const H=((U=K==null?void 0:K.scriptJson)==null?void 0:U.acts)||[],xe=Array.isArray(H)?H.find(Ke=>Number(Ke.actIndex)===Number(de)):null,Ee=xe?(xe.shots||[]).find(Ke=>Number(Ke.shotIndex)===Number(Z)):null,ze=Ee?[`ç”»é¢ï¼š${(Ee.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(Ee["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(Ee["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(Ee["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(Ee.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=Ee&&(Ee.æç¤ºè¯||"").trim()||"";M(Ke=>Ke.map(Ve=>{var ht;if(Ve.type!=="textPreview")return Ve;const Je=((ht=Ve.data)==null?void 0:ht.title)||"";return Je==="åˆ†é•œè®¾è®¡"?{...Ve,data:{...Ve.data,content:ze||"æš‚æ— åˆ†é•œæ–‡æœ¬"}}:Je==="æç¤ºè¯"?{...Ve,data:{...Ve.data,content:Fe||"æš‚æ— æç¤ºè¯"}}:Ve}))}catch{}return}const y={id:`group-${Date.now()}`,nodeIds:[],name:`ç¬¬${de}å¹•-ç¬¬${Z}é•œ`,scene:de,shot:Z,bounds:{x:-5e4,y:-5e4,width:1e5,height:1e5},hidden:!0};ut(H=>[...H,y]),Nt.current=[...Nt.current,y],Ot(y.id),nt(y.id);try{const H=((V=K==null?void 0:K.scriptJson)==null?void 0:V.acts)||[],xe=Array.isArray(H)?H.find(kt=>Number(kt.actIndex)===Number(de)):null,Ee=xe?(xe.shots||[]).find(kt=>Number(kt.shotIndex)===Number(Z)):null,ze=Ee?[`ç”»é¢ï¼š${(Ee.ç”»é¢||"").trim()}`,`æ™¯åˆ«/é•œå¤´ï¼š${(Ee["æ™¯åˆ«/é•œå¤´"]||"").trim()}`,`å†…å®¹/åŠ¨ä½œï¼š${(Ee["å†…å®¹/åŠ¨ä½œ"]||"").trim()}`,`å£°éŸ³/å¯¹è¯ï¼š${(Ee["å£°éŸ³/å¯¹è¯"]||"").trim()}`,`æ—¶é•¿ï¼š${(Ee.æ—¶é•¿||"").trim()}`].join(`
`):"",Fe=Ee&&(Ee.æç¤ºè¯||"").trim()||"",Ke={x:0,y:0},Ve={x:560,y:0},Je=`textPreview-${Date.now()}-a`,ht=`textPreview-${Date.now()}-b`,Ht=[{id:Je,type:"textPreview",position:Ke,data:{content:ze||"æš‚æ— åˆ†é•œæ–‡æœ¬",timestamp:Date.now(),title:"åˆ†é•œè®¾è®¡",id:Je,freeDrag:!0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:ce,episode:K,nodeGroup:y,nodeGroups:[...Le,y]}}},{id:ht,type:"textPreview",position:Ve,data:{content:Fe||"æš‚æ— æç¤ºè¯",timestamp:Date.now(),title:"æç¤ºè¯",id:ht,freeDrag:!0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:ce,episode:K,nodeGroup:y,nodeGroups:[...Le,y]}}}];M(kt=>[...kt,...Ht]),ut(kt=>kt.map(Pt=>{if(Pt.id!==y.id)return Pt;const St=Array.from(new Set([...Pt.nodeIds||[],Je,ht])),pt=Pt.bounds;return{...Pt,nodeIds:St,bounds:pt}})),Nt.current=Nt.current.map(kt=>{if(kt.id!==y.id)return kt;const Pt=Array.from(new Set([...kt.nodeIds||[],Je,ht])),St=kt.bounds;return{...kt,nodeIds:Pt,bounds:St}})}catch{}},[G,de,Z,K,ce,Le,M,Xe]),t.useEffect(()=>{if(ce)if(G&&K){const i=`${ce.name} - ${K.name||`ç¬¬${K.episodeNumber}é›†`}`,y=de&&Z?`ç¬¬${de}å¹•ç¬¬${Z}é•œ`:"";se(z?i:`${i} ${y}`.trim())}else se(ce.name);return()=>se("")},[ce,K,G,z,de,Z,se]),t.useEffect(()=>{if(!(!Pe||we||L.current))return ot.current&&clearTimeout(ot.current),ot.current=setTimeout(()=>{qt()},2e3),()=>{ot.current&&clearTimeout(ot.current)}},[R,T,Le]);const zt=async()=>{var i,y,U,V,H,xe;try{let Ee;if(Ie&&Q)Ee=await Me.workflows.getById(Q);else if(z)Ee=await Me.workflows.getOrCreateByShot(C,u,de,Z);else if(G)Ee=await Me.workflows.getOrCreateByEpisode(C,u);else{if(!s)return;Ee=await Me.workflows.getOrCreateByProject(s)}const $e=Ee.data;$e.canEdit===!1||$e.canEdit===void 0&&$e.isOwner===!1?(te(!0),L.current=!0,(i=$e.shareInfo)!=null&&i.owner&&O($e.shareInfo.owner)):(te(!1),L.current=!1,O(null)),$e.currentUserId&&(b($e.currentUserId),o.current=$e.currentUserId);const Fe=$e.isOwner!==!1||z&&$e.canEdit===!0;n(Fe);const Ke=Ie||$e.hasCollaborators===!0;if(c(Ke),w.current=$e.id,Ie&&Ce({id:$e.projectId||Q,name:$e.name||"å…±äº«å·¥ä½œæµ",description:$e.description,type:"QUICK",status:"DRAFT"}),$e.data){const{nodes:Ve,edges:Je,nodeGroups:ht}=$e.data;if(ht&&ht.length>0&&(ut(ht),Nt.current=ht),Ve&&Ve.length>0){let Ht=Ve;if(z&&((y=K==null?void 0:K.scriptJson)!=null&&y.acts))try{const Ct=K.scriptJson.acts.find(et=>Number(et.actIndex)===Number(de)),Jt=(U=Ct==null?void 0:Ct.shots)==null?void 0:U.find(et=>Number(et.shotIndex)===Number(Z)),lt=new Set;Jt&&(Array.isArray(Jt.mediaList)&&Jt.mediaList.forEach(et=>{et.nodeId&&lt.add(et.nodeId)}),(V=Jt.media)!=null&&V.nodeId&&lt.add(Jt.media.nodeId)),Ht=Ve.map(et=>{var Ut;return et.type==="videoPreview"&&((Ut=et.data)!=null&&Ut.addedToStoryboard)&&!lt.has(et.id)?{...et,data:{...et.data,addedToStoryboard:!1}}:et})}catch{}let kt;if(z&&((H=K==null?void 0:K.scriptJson)!=null&&H.acts))try{const Ct=K.scriptJson.acts.find(lt=>Number(lt.actIndex)===Number(de)),Jt=(xe=Ct==null?void 0:Ct.shots)==null?void 0:xe.find(lt=>Number(lt.shotIndex)===Number(Z));kt=Jt==null?void 0:Jt.æç¤ºè¯}catch{}const Pt=new Set((ht||[]).filter(pt=>!pt.hidden).flatMap(pt=>pt.nodeIds||[])),St=Ht.map(pt=>{const Ct=ht?ht.find(et=>et.nodeIds.includes(pt.id)):null,Jt=p.length>0?p:pt.data.models||[],lt=pt.type==="agent"&&kt?{...pt.data,output:kt,lastOutput:kt}:pt.data;return{...pt,data:{...lt,models:Jt,onOpenAssetPanel:pt.type==="assetSelector"?pt.data.onOpenAssetPanel||tr:pt.data.onOpenAssetPanel,workflowContext:{project:ce,episode:K,nodeGroup:Ct,nodeGroups:ht||[]}},draggable:pt.draggable!==!1,connectable:Pt.has(pt.id)?!1:pt.connectable!==!1,deletable:Pt.has(pt.id)?!1:pt.deletable!==!1}});M(St)}if(Je&&Je.length>0){const Ht=new Set(Ve.map(St=>St.id)),kt=new Map(Ve.map(St=>[St.id,St.type])),Pt=Je.filter(St=>{if(!Ht.has(St.source)||!Ht.has(St.target))return!1;const pt=kt.get(St.target),Ct=kt.get(St.source);return!(pt==="midjourney"&&St.targetHandle==="text-input"&&Ct!=="agent")}).map(St=>({...St,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2},targetHandle:St.targetHandle||void 0}));x(Pt)}}}catch{}};t.useEffect(()=>{p.length>0&&R.length>0&&M(i=>i.map(y=>({...y,data:{...y.data,models:p},draggable:y.draggable!==void 0?y.draggable:!0,deletable:y.deletable!==void 0?y.deletable:!0})))},[p,R.length]),t.useEffect(()=>{if(!ce&&!K||R.length===0)return;if(R.some(y=>{var Ee,$e;const U=y.data.workflowContext,V=((Ee=U==null?void 0:U.project)==null?void 0:Ee.id)!==(ce==null?void 0:ce.id),H=(($e=U==null?void 0:U.episode)==null?void 0:$e.id)!==(K==null?void 0:K.id),xe=(U==null?void 0:U.nodeGroups)!==Nt.current;return!U||V||H||xe})){const y=de&&Z&&Nt.current.find(U=>U.scene===de&&U.shot===Z)||null;M(U=>U.map(V=>{const H=Nt.current.find(Ee=>Ee.nodeIds.includes(V.id))||null,xe=y||H;return{...V,data:{...V.data,workflowContext:{project:ce,episode:K,nodeGroup:xe,nodeGroups:Nt.current}}}}))}},[ce,K,de,Z,R.length,Le]);const Xt=async(i,y,U)=>{var V;if(!(!C||!u))try{const H=i.find(Fe=>Fe.type==="agent");if(!H)return;const xe=((V=H.data)==null?void 0:V.output)||"",$e=(await Me.episodes.getById(C,u)).scriptJson;if(!$e||!$e.acts)return;const ze=$e.acts.map(Fe=>{var Ke;return Fe.actIndex===y?{...Fe,shots:(Ke=Fe.shots)==null?void 0:Ke.map(Ve=>Ve.shotIndex===U&&Ve.æç¤ºè¯!==xe?{...Ve,æç¤ºè¯:xe}:Ve)}:Fe});await Me.episodes.update(C,u,{scriptJson:{acts:ze}})}catch{}},as=async()=>{if(!(j||L.current)&&!(ms.current.length===0&&Es.current.length===0))try{const i=ms.current.map(U=>{const{data:V,...H}=U,{workflowContext:xe,_canEdit:Ee,_currentUserId:$e,...ze}=V||{};return{...H,data:ze}}),y=Es.current.map(U=>({id:U.id,source:U.source,target:U.target,sourceHandle:U.sourceHandle,targetHandle:U.targetHandle,type:U.type}));if(z){await Me.workflows.saveShot(C,u,de,Z,{nodes:i,edges:y,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}});try{await Xt(ms.current,de,Z)}catch{}}else G?await Me.workflows.saveEpisode(C,u,{nodes:i,edges:y,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}}):Ie&&Q?await Me.workflows.update(Q,{data:{nodes:i,edges:y,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}}}):s&&await Me.workflows.save(s,{nodes:i,edges:y,nodeGroups:Nt.current,viewport:{x:0,y:0,zoom:1}})}catch{}},is=t.useRef(null),qt=t.useCallback(()=>{is.current&&clearTimeout(is.current),is.current=setTimeout(()=>{as()},2e3)},[]);t.useEffect(()=>{if(ce||K){let i=Nt.current;z&&de&&Z&&(i=Nt.current.filter(y=>y.scene===de&&y.shot===Z)),window.__workflowContext={project:ce,episode:K,nodeGroups:i}}},[ce,K,Le,z,de,Z]);const Os=async()=>{try{if(Ie){window.__workflowContext={project:null,episode:null,nodeGroups:Nt.current};return}if(G){const[i,y]=await Promise.all([Me.episodes.getById(C,u),Me.projects.getById(C)]);De(i.data),Ce(y.data);let U=Nt.current;z&&de&&Z&&(U=Nt.current.filter(V=>V.scene===de&&V.shot===Z)),window.__workflowContext={project:y.data,episode:i.data,nodeGroups:U}}else{const i=await Me.projects.getById(s);Ce(i.data);let y=Nt.current;z&&de&&Z&&(y=Nt.current.filter(U=>U.scene===de&&U.shot===Z)),window.__workflowContext={project:i.data,episode:null,nodeGroups:y}}}catch{g.error(G?"åŠ è½½å‰§é›†å¤±è´¥":"åŠ è½½é¡¹ç›®å¤±è´¥"),$("/quick")}finally{ie(!1)}},js=async()=>{try{const i=await Me.get("/ai/models",{params:{isActive:"true"}});d(i||[])}catch{}};t.useEffect(()=>{M(i=>i.map(y=>{const U=String(y.type||"");return!U.startsWith("aiVideo")&&U!=="audioVoice"&&U!=="voiceClone"&&U!=="audioSynthesize"&&U!=="audioDesign"?y:{...y,data:{...y.data,models:p}}}))},[p,M]);const ks=async()=>{try{const y=(await Me.agents.getAll()).filter(U=>U.isActive);Y(y)}catch{}};t.useEffect(()=>{M(i=>i.map(y=>{var $e,ze,Fe,Ke,Ve;if(y.type!=="agent")return y;const U=(ze=($e=y.data)==null?void 0:$e.config)==null?void 0:ze.agentId,V=E.find(Je=>Je.id===U),H=V==null?void 0:V.aiModelId,xe=p.find(Je=>Je.id===H);let Ee=(Fe=xe==null?void 0:xe.config)==null?void 0:Fe.acceptedInputs;if((!Ee||Ee.length===0)&&xe){const Je=(xe.provider||"").toLowerCase(),ht=(xe.name||"").toLowerCase();(Je.includes("google")||ht.includes("gemini"))&&(Ee=["TEXT","IMAGE","DOCUMENT"])}if(Array.isArray(Ee)&&Ee.length>0){const Je=(Ve=(Ke=y.data)==null?void 0:Ke.config)==null?void 0:Ve.acceptedInputs,ht=Ht=>Ht.map(kt=>kt.toUpperCase()).sort().join(",");if(!Je||ht(Je)!==ht(Ee))return{...y,data:{...y.data,config:{...y.data.config,acceptedInputs:Ee}}}}return y}))},[E,p,M]);const ir=t.useCallback(i=>{var $e,ze,Fe,Ke,Ve,Je,ht,Ht,kt,Pt,St,pt,Ct,Jt,lt,et,Ut;Qt.current=!1;const y=Nt.current.some(gt=>{var ft;return!gt.hidden&&((ft=gt.nodeIds)==null?void 0:ft.includes(i.source||""))}),U=Nt.current.some(gt=>{var ft;return!gt.hidden&&((ft=gt.nodeIds)==null?void 0:ft.includes(i.target||""))});if(y||U){g.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸æ–°å»ºè¿æ¥"),Qt.current=!1;return}const V=R.find(gt=>gt.id===i.source),H=R.find(gt=>gt.id===i.target);if(V&&H){const gt=Wt=>{var ke,He,Tt;const mt=Wt.type,st=Wt.data;if(mt==="upload"&&Array.isArray((ke=st.config)==null?void 0:ke.uploadedFiles)&&st.config.uploadedFiles.length>0){const Vt=st.config.uploadedFiles,rt=Vt.some(jt=>{const Yt=((jt==null?void 0:jt.type)||"").toUpperCase(),vs=((jt==null?void 0:jt.mimeType)||"").toLowerCase();return Yt==="VIDEO"||vs.startsWith("video/")}),At=Vt.some(jt=>{const Yt=((jt==null?void 0:jt.type)||"").toUpperCase(),vs=((jt==null?void 0:jt.mimeType)||"").toLowerCase();return Yt==="IMAGE"||vs.startsWith("image/")}),bt=Vt.some(jt=>{const Yt=((jt==null?void 0:jt.type)||"").toUpperCase(),vs=((jt==null?void 0:jt.mimeType)||"").toLowerCase();return Yt==="AUDIO"||vs.startsWith("audio/")});return(H==null?void 0:H.type)==="aiVideo_swap"?rt?"VIDEO":At?"IMAGE":bt?"AUDIO":null:At?"IMAGE":rt?"VIDEO":bt?"AUDIO":null}if(mt==="assetSelector"){if((He=st.config)!=null&&He.subjects)return"IMAGE";if((Tt=st.config)!=null&&Tt.selectedAsset){const Vt=st.config.selectedAsset,rt=(Vt.type||"").toUpperCase(),At=(Vt.mimeType||"").toLowerCase();return rt==="IMAGE"||At.startsWith("image/")?"IMAGE":rt==="VIDEO"||At.startsWith("video/")?"VIDEO":rt==="AUDIO"||At.startsWith("audio/")?"AUDIO":rt||null}}return mt==="aiImage"||mt==="imagePreview"?"IMAGE":(mt||"").startsWith("aiVideo")||mt==="videoPreview"?"VIDEO":mt==="agent"?"TEXT":null},ft=gt(V);let ss=($e=H.data.config)==null?void 0:$e.acceptedInputs;if(H.type==="aiVideo_t2v"&&ft&&ft!=="TEXT"){const Wt={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};g.error(`æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—${Wt[ft]||ft}è¾“å…¥`),Qt.current=!1;return}if((!ss||ss.length===0)&&H.data.type==="agent"){const Wt=(ze=H.data.config)==null?void 0:ze.agentId,mt=E.find(Tt=>Tt.id===Wt),st=mt==null?void 0:mt.aiModelId,ke=p.find(Tt=>Tt.id===st),He=(Fe=ke==null?void 0:ke.config)==null?void 0:Fe.acceptedInputs;if(Array.isArray(He)&&He.length>0)ss=He;else{const Tt=((Ke=ke==null?void 0:ke.provider)==null?void 0:Ke.toLowerCase())||"",Vt=((ke==null?void 0:ke.name)||"").toLowerCase();(Tt.includes("google")||Vt.includes("gemini"))&&(ss=["TEXT","IMAGE","DOCUMENT"])}}if(H.type!=="agent"){if(!H.type.startsWith("aiVideo")&&ss&&ss.length>0&&ft){const Wt=ss.map(st=>typeof st=="string"?st.toUpperCase():st),mt=typeof ft=="string"?ft.toUpperCase():ft;if(!Wt.includes(mt)){const st={TEXT:"æ–‡æœ¬",IMAGE:"å›¾ç‰‡",VIDEO:"è§†é¢‘",AUDIO:"éŸ³ä¹",DOCUMENT:"æ–‡æ¡£"};g.error(`è¯¥èŠ‚ç‚¹ä¸æ¥å—${st[mt]||mt}ç±»å‹çš„è¾“å…¥ï¼ˆå…è®¸ï¼š${Wt.map(ke=>st[ke]||ke).join("ã€")}ï¼‰`),Qt.current=!1;return}}}if(H.type==="aiVideo_swap"){const Wt=T.filter(Tt=>Tt.target===H.id),mt=Wt.filter(Tt=>{const Vt=R.find(At=>At.id===Tt.source);return gt(Vt)==="VIDEO"}).length,st=Wt.filter(Tt=>{const Vt=R.find(At=>At.id===Tt.source);return gt(Vt)==="IMAGE"}).length,ke=mt+(ft==="VIDEO"?1:0),He=st+(ft==="IMAGE"?1:0);if(ke>1||He>1||ft!=="VIDEO"&&ft!=="IMAGE"){g.error("è§†é¢‘æ¢äººèŠ‚ç‚¹ä»…æ¥å—1ä¸ªè§†é¢‘å’Œ1å¼ å›¾ç‰‡çš„è¾“å…¥"),Qt.current=!1;return}}if(H.type==="aiVideo_lipsync"){const Wt=T.filter(Vt=>Vt.target===H.id),mt=Wt.filter(Vt=>{const rt=R.find(bt=>bt.id===Vt.source);return gt(rt)==="VIDEO"}).length,st=Wt.filter(Vt=>{const rt=R.find(bt=>bt.id===Vt.source);return gt(rt)==="AUDIO"}).length,ke=mt+(ft==="VIDEO"?1:0),He=st+(ft==="AUDIO"?1:0),Tt=ft==="VIDEO"||ft==="AUDIO"||ft==="IMAGE";if(ke>1||He>1||!Tt){g.error("å¯¹å£å‹èŠ‚ç‚¹éœ€ä¸”ä»…æ¥å—1ä¸ªè§†é¢‘ä¸1ä¸ªéŸ³é¢‘ï¼ˆå›¾ç‰‡å¯é€‰ï¼‰"),Qt.current=!1;return}}if(H.type.startsWith("aiVideo")&&H.type!=="aiVideo_swap"&&ft==="IMAGE"){const mt=(st=>{const ke=(st||"").toLowerCase().replace(/[_\-\s]+/g," ");return ke?ke.includes("æ–‡ç”Ÿ")||ke.includes("text to video")||ke.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")||ke.includes("first last")||ke.includes("two frame")||ke.includes("frame pair")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")||ke.includes("first frame")||ke.includes("start frame")||ke.includes("initial frame")||ke.includes("keyframe")?"é¦–å¸§":ke.includes("å°¾å¸§")||ke.includes("last frame")||ke.includes("end frame")||ke.includes("final frame")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")||ke.includes("subject reference")||ke.includes("å‚è€ƒ")||ke.includes("reference image")||ke.includes("image reference")||ke.includes("ref image")?"å‚è€ƒå›¾":st||"":""})((Je=(Ve=H.data)==null?void 0:Ve.config)==null?void 0:Je.generationType);if(H.type==="aiVideo_t2v"||mt==="æ–‡ç”Ÿè§†é¢‘"){g.error("æ–‡ç”Ÿè§†é¢‘èŠ‚ç‚¹ä¸æ¥å—å›¾ç‰‡è¾“å…¥"),Qt.current=!1;return}if((mt==="é¦–å¸§"||mt==="å°¾å¸§")&&V.type==="assetSelector"){const st=((ht=V.data)==null?void 0:ht.config)||{};if(st.subjects&&st.subjects.length>0&&(st.subjects[0].images||[]).length>1){g.error("é¦–å¸§/å°¾å¸§ä»…å…è®¸å•å›¾è§’è‰²æˆ–å•å¼ å›¾ç‰‡"),Qt.current=!1;return}}if(mt==="é¦–å°¾å¸§"&&V.type==="assetSelector"){const st=((Ht=V.data)==null?void 0:Ht.config)||{};if(st.subjects&&st.subjects.length>0){g.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Qt.current=!1;return}}}if(H.type==="aiVideo_style"){const st=T.filter(ke=>ke.target===H.id).filter(ke=>{const He=R.find(Vt=>Vt.id===ke.source);return gt(He)==="VIDEO"}).length+(ft==="VIDEO"?1:0);if(ft!=="VIDEO"){g.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…æ¥å—è§†é¢‘è¾“å…¥"),Qt.current=!1;return}if(st>1){g.error("é£æ ¼è½¬ç»˜èŠ‚ç‚¹ä»…å…è®¸è¿æ¥1ä¸ªè§†é¢‘"),Qt.current=!1;return}}if(H.type.startsWith("aiVideo")&&ft==="TEXT"&&T.filter(st=>st.target===H.id).find(st=>{const ke=R.find(He=>He.id===st.source);return(ke==null?void 0:ke.type)==="agent"})){g.error("è§†é¢‘èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}if(H.type==="aiImage"){if(ft==="TEXT"){if(T.filter(st=>st.target===H.id).some(st=>{const ke=R.find(He=>He.id===st.source);return(ke==null?void 0:ke.type)==="agent"})){g.error("å›¾ç‰‡èŠ‚ç‚¹ä»…å…è®¸ä¸€ä¸ªæ™ºèƒ½ä½“è¾“å…¥"),Qt.current=!1;return}}else if(ft==="IMAGE"){const mt=T.filter(rt=>rt.target===H.id).reduce((rt,At)=>{var Yt,vs,Zt,$s,As,Ar,_r;const bt=R.find(ls=>ls.id===At.source),jt=(bt==null?void 0:bt.type)||"";if(jt==="upload"){const ls=((Zt=(vs=(Yt=bt==null?void 0:bt.data)==null?void 0:Yt.config)==null?void 0:vs.uploadedFiles)==null?void 0:Zt[0])||null,oa=((ls==null?void 0:ls.type)||"").toUpperCase(),na=((ls==null?void 0:ls.mimeType)||"").toLowerCase();return rt+(oa==="IMAGE"||na.startsWith("image/")?1:0)}if(jt==="assetSelector"){const ls=(($s=bt==null?void 0:bt.data)==null?void 0:$s.config)||{};return ls.selectedAsset&&(rt+=(ls.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ls.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0),Array.isArray(ls.subjects)&&ls.subjects.length>0?rt+((ls.subjects[0].images||[]).length||0):rt}if(jt==="aiImage"){const ls=(Ar=(As=bt==null?void 0:bt.data)==null?void 0:As.config)==null?void 0:Ar.generatedImageUrl;return rt+(ls?1:0)}if(jt==="imagePreview"){const ls=(_r=bt==null?void 0:bt.data)==null?void 0:_r.imageUrl;return rt+(ls?1:0)}return rt},0);let st=1;if(V.type==="assetSelector"){const rt=((kt=V==null?void 0:V.data)==null?void 0:kt.config)||{};rt.selectedAsset?st=(rt.selectedAsset.type||"").toUpperCase()==="IMAGE"||(rt.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0:Array.isArray(rt.subjects)&&rt.subjects.length>0&&(st=(rt.subjects[0].images||[]).length||0)}else if(V.type==="upload"){const rt=((pt=(St=(Pt=V==null?void 0:V.data)==null?void 0:Pt.config)==null?void 0:St.uploadedFiles)==null?void 0:pt[0])||null,At=((rt==null?void 0:rt.type)||"").toUpperCase(),bt=((rt==null?void 0:rt.mimeType)||"").toLowerCase();st=At==="IMAGE"||bt.startsWith("image/")?1:0}else V.type==="aiImage"?st=((Jt=(Ct=V==null?void 0:V.data)==null?void 0:Ct.config)==null?void 0:Jt.generatedImageUrl)?1:0:V.type==="imagePreview"&&(st=((lt=V==null?void 0:V.data)==null?void 0:lt.imageUrl)?1:0);const ke=(Ut=(et=H==null?void 0:H.data)==null?void 0:et.config)==null?void 0:Ut.modelId,He=p.find(rt=>rt.id===ke),Tt=(He==null?void 0:He.config)||{},Vt=Tt.maxReferenceImages||Tt.supportedReferenceImagesLimit||Tt.referenceImagesLimit||10;if(mt+st>Vt){g.error(`å›¾ç‰‡èŠ‚ç‚¹å·²è¾¾åˆ°å›¾ç‰‡ä¸Šé™ï¼ˆ${Vt}å¼ ï¼‰`),Qt.current=!1;return}}}}try{const gt=R.find(mt=>mt.id===i.target),ft=R.find(mt=>mt.id===i.source),ss=mt=>{var ke,He,Tt,Vt;if(!mt)return null;const st=String(mt.type||"").toLowerCase();if(st==="upload"){const rt=(((He=(ke=mt.data)==null?void 0:ke.config)==null?void 0:He.uploadedFiles)||[]).find(At=>{const bt=((At==null?void 0:At.type)||"").toUpperCase(),jt=((At==null?void 0:At.mimeType)||"").toLowerCase();return bt==="AUDIO"||jt.startsWith("audio/")});return(rt==null?void 0:rt.url)||null}if(st==="assetSelector"){const rt=(Vt=(Tt=mt.data)==null?void 0:Tt.config)==null?void 0:Vt.selectedAsset,At=((rt==null?void 0:rt.type)||"").toUpperCase(),bt=((rt==null?void 0:rt.mimeType)||"").toLowerCase();if(At==="AUDIO"||bt.startsWith("audio/"))return(rt==null?void 0:rt.url)||null}return null};if(String((gt==null?void 0:gt.type)||"")==="audioVoice"){const mt=ss(ft);mt&&M(st=>st.map(ke=>ke.id===gt.id?{...ke,data:{...ke.data,config:{...ke.data.config,audioUrl:mt}}}:ke))}}catch{}const Ee={id:`edge-${i.source}-${i.target}-${Date.now()}`,source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};setTimeout(()=>{x(gt=>ha(Ee,gt)),It(Ee)},0),us.current=null,Qt.current=!0},[x,R,E,p,T,It]),Gs=t.useCallback((i,y)=>{const U=Nt.current.some(H=>{var xe;return!H.hidden&&((xe=H.nodeIds)==null?void 0:xe.includes(y.source))}),V=Nt.current.some(H=>{var xe;return!H.hidden&&((xe=H.nodeIds)==null?void 0:xe.includes(y.target))});if(U||V){g.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸æ–­å¼€");return}x(H=>H.filter(xe=>xe.id!==y.id)),Mt(y.id),g.success("å·²æ–­å¼€è¿æ¥")},[x,Mt]),mr=t.useCallback(i=>{var V,H,xe,Ee,$e,ze,Fe,Ke,Ve,Je,ht,Ht,kt,Pt,St;ot.current&&clearTimeout(ot.current);try{const pt=localStorage.getItem("suppressedPreviewTasks")||"[]",Ct=JSON.parse(pt),Jt=et=>{Ct.push(et)};for(const et of Array.isArray(i)?i:[])if((et==null?void 0:et.type)==="imagePreview"){const Ut=(H=(V=et==null?void 0:et.data)==null?void 0:V.midjourneyData)==null?void 0:H.sourceNodeId,gt=(Ee=(xe=et==null?void 0:et.data)==null?void 0:xe.midjourneyData)==null?void 0:Ee.taskId,ft=(ze=($e=et==null?void 0:et.data)==null?void 0:$e.midjourneyData)==null?void 0:ze.messageId;if(Ut||gt||ft)Jt({sourceNodeId:Ut,taskId:gt,messageId:ft});else{const ss=Es.current.find(Wt=>Wt.target===et.id);if(ss){const Wt=ms.current.find(st=>st.id===ss.source),mt=(Ke=(Fe=Wt==null?void 0:Wt.data)==null?void 0:Fe.config)==null?void 0:Ke.taskId;mt&&Jt({taskId:mt})}}}else if((et==null?void 0:et.type)==="videoPreview"){const Ut=Es.current.find(gt=>gt.target===et.id);if(Ut){const gt=ms.current.find(ss=>ss.id===Ut.source),ft=(Je=(Ve=gt==null?void 0:gt.data)==null?void 0:Ve.config)==null?void 0:Je.taskId;ft&&Jt({taskId:ft})}}const lt=Ct.slice(Math.max(0,Ct.length-500));localStorage.setItem("suppressedPreviewTasks",JSON.stringify(lt))}catch{}try{const pt=[];for(const Ct of Array.isArray(i)?i:[]){const Jt=(kt=(Ht=(ht=Ct==null?void 0:Ct.data)==null?void 0:ht.workflowContext)==null?void 0:Ht.project)==null?void 0:kt.name;(Ct==null?void 0:Ct.type)==="imagePreview"&&((Pt=Ct==null?void 0:Ct.data)!=null&&Pt.imageUrl)?pt.push(Me.post("/assets/recycle/record",{url:Ct.data.imageUrl,type:"IMAGE",projectName:Jt})):(Ct==null?void 0:Ct.type)==="videoPreview"&&((St=Ct==null?void 0:Ct.data)!=null&&St.videoUrl)&&pt.push(Me.post("/assets/recycle/record",{url:Ct.data.videoUrl,type:"VIDEO",projectName:Jt}))}pt.length>0&&Promise.allSettled(pt).then(()=>{})}catch{}const y=Array.isArray(i)?i.length:0,U=Ys.current;setTimeout(()=>{const pt=ms.current.length,Ct=Math.max(U-y,0);pt===Ct&&as()},100)},[]),Wr=t.useCallback(i=>{const y=i.filter(V=>Nt.current.some(xe=>{var Ee;return!xe.hidden&&((Ee=xe.nodeIds)==null?void 0:Ee.includes(V.id))})?(g.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤"),!1):!0);if(y.length===0)return;if(l){mr(y),y.forEach(V=>Gt(V.id));return}const U=y.filter(V=>{var Ee;const H=(Ee=V.data)==null?void 0:Ee.createdBy;return(typeof H=="object"?H==null?void 0:H.id:H)===o.current});U.length>0&&(mr(U),U.forEach(V=>Gt(V.id)))},[l,mr,Gt]),jr=t.useCallback(i=>{ot.current&&clearTimeout(ot.current),setTimeout(()=>{qt()},250)},[]),Fr=t.useCallback(i=>{const y=i.filter(U=>{if(U.type!=="remove")return!0;const V=Es.current.find(Ee=>Ee.id===U.id);if(!V)return!0;const H=Nt.current.some(Ee=>{var $e;return!Ee.hidden&&(($e=Ee.nodeIds)==null?void 0:$e.includes(V.source))}),xe=Nt.current.some(Ee=>{var $e;return!Ee.hidden&&(($e=Ee.nodeIds)==null?void 0:$e.includes(V.target))});return H||xe?(g.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});m(y)},[m]),zr=t.useCallback(i=>{const y=i.filter(U=>{const V=Nt.current.some(xe=>{var Ee;return!xe.hidden&&((Ee=xe.nodeIds)==null?void 0:Ee.includes(U.source))}),H=Nt.current.some(xe=>{var Ee;return!xe.hidden&&((Ee=xe.nodeIds)==null?void 0:Ee.includes(U.target))});return V||H?(g.error("ç¼–ç»„å†…çš„èŠ‚ç‚¹è¿æ¥ä¸å…è®¸åˆ é™¤"),!1):!0});y.length>0&&(jr(y),y.forEach(U=>Mt(U.id)))},[jr,Mt]),Br=t.useCallback(i=>{if(i.preventDefault(),j)return;const y=200,U=400,V=10;let H=i.clientX,xe=i.clientY;H+y+V>window.innerWidth&&(H=window.innerWidth-y-V),xe+U+V>window.innerHeight&&(xe=window.innerHeight-U-V),H=Math.max(V,H),xe=Math.max(V,xe),v({x:H,y:xe})},[j]),lr=t.useCallback(()=>{v(null),k(),h(!1)},[]),tr=t.useCallback(i=>{Ft(i),Be(!0)},[]);t.useEffect(()=>{R.length>0&&R.some(y=>y.type==="assetSelector"&&!y.data.onOpenAssetPanel)&&M(y=>y.map(U=>U.type==="assetSelector"&&!U.data.onOpenAssetPanel?{...U,data:{...U.data,onOpenAssetPanel:tr,models:U.data.models||p}}:U))},[R.length,tr,p]);const Hr=t.useCallback(i=>{qe&&(M(y=>y.map(V=>V.id===qe?{...V,data:{...V.data,config:{...V.data.config,...i.images?i.images.length===1?{selectedInput:{id:i.images[0].id,name:i.images[0].name,originalName:i.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:i.images[0].url},selectedAsset:{id:i.images[0].id,name:i.images[0].name,originalName:i.images[0].name,type:"IMAGE",mimeType:"image/jpeg",size:0,url:i.images[0].url},subjects:void 0,referenceImages:void 0}:{selectedInput:i,subjects:[{name:i.name,images:i.images.map(H=>H.url)}],referenceImages:i.images.map(H=>({id:H.id,url:H.url,name:H.name}))}:{selectedInput:{id:i.id,name:i.name,originalName:i.originalName,type:i.type,mimeType:i.mimeType,size:i.size,url:i.url},selectedAsset:{id:i.id,name:i.name,originalName:i.originalName,type:i.type,mimeType:i.mimeType,size:i.size,url:i.url},subjects:void 0,referenceImages:void 0}}}}:V)),Be(!1),Ft(null),g.success(`å·²é€‰æ‹©ç´ æï¼š${i.name}`))},[qe,M]),Ir=i=>{const U={aiVideo_t2v:"æ–‡ç”Ÿè§†é¢‘",aiVideo_i2v_first:"é¦–å¸§",aiVideo_i2v_last:"å°¾å¸§",aiVideo_first_last:"é¦–å°¾å¸§",aiVideo_reference:"å‚è€ƒå›¾",aiVideo_swap:"è§†é¢‘æ¢äºº",aiVideo_lipsync:"å¯¹å£å‹",aiVideo_style:"é£æ ¼è½¬æ¢"}[i]||"æ–‡ç”Ÿè§†é¢‘",V=U==="æ–‡ç”Ÿè§†é¢‘"?["TEXT"]:U==="è§†é¢‘æ¢äºº"?["TEXT","IMAGE","VIDEO"]:U==="å¯¹å£å‹"?["VIDEO","AUDIO","IMAGE","TEXT"]:U==="é£æ ¼è½¬æ¢"?["VIDEO"]:["TEXT","IMAGE"],H=p.filter(ze=>ze.type==="VIDEO_GENERATION"),xe=p.filter(ze=>ze.type==="VIDEO_EDITING"),Ee=ze=>{const Fe=(ze||"").toLowerCase();return Fe.includes("text")||Fe.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":Fe.includes("first-last")||Fe.includes("é¦–å°¾")?"é¦–å°¾å¸§":Fe.includes("first")||Fe.includes("é¦–å¸§")?"é¦–å¸§":Fe.includes("last")||Fe.includes("å°¾å¸§")?"å°¾å¸§":Fe.includes("å‚è€ƒ")?"å‚è€ƒå›¾":Fe.includes("æ¢äºº")?"è§†é¢‘æ¢äºº":ze};let $e=null;return U==="è§†é¢‘æ¢äºº"?$e=xe.find(ze=>{var Fe;return Array.isArray((Fe=ze==null?void 0:ze.config)==null?void 0:Fe.supportedEditingCapabilities)&&ze.config.supportedEditingCapabilities.includes("è§†é¢‘æ¢äºº")})||H.find(ze=>{var Ke,Ve;return(Array.isArray((Ke=ze==null?void 0:ze.config)==null?void 0:Ke.supportedGenerationTypes)?ze.config.supportedGenerationTypes.map(Je=>Ee(Je)):[]).includes("è§†é¢‘æ¢äºº")&&((Ve=ze==null?void 0:ze.config)==null?void 0:Ve.supportsVideoEditing)===!0}):U==="å¯¹å£å‹"?$e=xe.find(ze=>{var Fe;return Array.isArray((Fe=ze==null?void 0:ze.config)==null?void 0:Fe.supportedEditingCapabilities)&&ze.config.supportedEditingCapabilities.includes("å¯¹å£å‹")})||null:U==="é£æ ¼è½¬æ¢"?$e=xe.find(ze=>{var Fe;return Array.isArray((Fe=ze==null?void 0:ze.config)==null?void 0:Fe.supportedEditingCapabilities)&&ze.config.supportedEditingCapabilities.includes("é£æ ¼è½¬æ¢")})||null:$e=H.find(ze=>{var Ke;const Fe=Array.isArray((Ke=ze==null?void 0:ze.config)==null?void 0:Ke.supportedGenerationTypes)?ze.config.supportedGenerationTypes.map(Ve=>Ee(Ve)):[];return U==="é¦–å¸§"||U==="å°¾å¸§"?Fe.includes("é¦–å¸§")||Fe.includes("å°¾å¸§"):Fe.includes(U)}),{modelId:$e==null?void 0:$e.id,modelName:$e==null?void 0:$e.name,generationType:U,lockedGenerationType:U,hideGenerationTypeSelector:!0,acceptedInputs:V}},ds=(i,y,U,V,H,xe,Ee,$e)=>{if(!B)return;const ze=ge({x:B.x,y:B.y}),Fe=`${i}-${Date.now()}`,Ke=yt?Le.find(kt=>kt.id===yt)||null:Le.find(kt=>kt.nodeIds.includes(Fe))||null,Ve=U==="aiImage"||U.startsWith("aiVideo")||U==="midjourney",Je=U.startsWith("aiVideo")?Ir(U):{},ht=V?{agentId:V}:Je;U.startsWith("aiVideo"),U.startsWith("aiVideo")&&$e&&Object.assign(ht,$e);const Ht={id:Fe,type:U,position:ze,data:{label:H||y,type:i,config:ht,models:p,isExpanded:Ve,onOpenAssetPanel:U==="assetSelector"?tr:void 0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:ce,episode:K,nodeGroup:Ke,nodeGroups:Le}}};M(kt=>[...kt,Ht]),Bt(Ht),yt&&(ut(kt=>kt.map(Pt=>{if(Pt.id!==yt)return Pt;const St=Array.from(new Set([...Pt.nodeIds||[],Fe])),pt=ur(St)||Pt.bounds;return{...Pt,nodeIds:St,bounds:pt}})),Nt.current=Nt.current.map(kt=>{if(kt.id!==yt)return kt;const Pt=Array.from(new Set([...kt.nodeIds||[],Fe])),St=ur(Pt)||kt.bounds;return{...kt,nodeIds:Pt,bounds:St}})),lr(),g.success(`å·²æ·»åŠ ${H||y}èŠ‚ç‚¹`),U==="assetSelector"&&setTimeout(()=>{tr(Ht.id)},100)},[os,Bs]=t.useState(null),Qt=t.useRef(!1),us=t.useRef(null),Ks=t.useMemo(()=>{var $e,ze,Fe,Ke;const i={showAgent:!0,showAiImage:!0,showAudio:!0,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!0,showAssetSelector:!0,showSuperCanvas:!0};if(!os)return i;const y=os.handleType==="target",U=Ve=>{const Je=(Ve||"").toLowerCase().replace(/[_\-\s]+/g," ");return Je?Je.includes("æ–‡ç”Ÿ")||Je.includes("text to video")||Je.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":Je.includes("é¦–å°¾")||Je.includes("first last")||Je.includes("two frame")||Je.includes("frame pair")?"é¦–å°¾å¸§":Je.includes("é¦–å¸§")||Je.includes("first frame")||Je.includes("start frame")||Je.includes("initial frame")||Je.includes("keyframe")?"é¦–å¸§":Je.includes("å°¾å¸§")||Je.includes("last frame")||Je.includes("end frame")||Je.includes("final frame")?"å°¾å¸§":Je.includes("ä¸»ä½“å‚è€ƒ")||Je.includes("subject reference")||Je.includes("å‚è€ƒ")||Je.includes("reference image")||Je.includes("image reference")||Je.includes("ref image")?"å‚è€ƒå›¾":Ve||"":""};if(y){const Ve=R.find(Pt=>Pt.id===os.sourceNodeId),Je=(Ve==null?void 0:Ve.type)||"",ht=Je.startsWith("aiVideo"),Ht=U((ze=($e=Ve==null?void 0:Ve.data)==null?void 0:$e.config)==null?void 0:ze.generationType),kt=Je==="aiVideo_t2v"||Ht==="æ–‡ç”Ÿè§†é¢‘";if(Je==="aiImage"){const Pt=T.filter(Ut=>Ut.target===(Ve==null?void 0:Ve.id)),St=Pt.some(Ut=>{const gt=R.find(ft=>ft.id===Ut.source);return((gt==null?void 0:gt.type)||"")==="agent"}),pt=Pt.reduce((Ut,gt)=>{var Wt,mt,st,ke;const ft=R.find(He=>He.id===gt.source),ss=(ft==null?void 0:ft.type)||"";if(ss==="upload"){const He=((st=(mt=(Wt=ft==null?void 0:ft.data)==null?void 0:Wt.config)==null?void 0:mt.uploadedFiles)==null?void 0:st[0])||null,Tt=((He==null?void 0:He.type)||"").toUpperCase(),Vt=((He==null?void 0:He.mimeType)||"").toLowerCase();return Ut+(Tt==="IMAGE"||Vt.startsWith("image/")?1:0)}if(ss==="assetSelector"){const He=((ke=ft==null?void 0:ft.data)==null?void 0:ke.config)||{};if(He.selectedAsset)return Ut+((He.selectedAsset.type||"").toUpperCase()==="IMAGE"||(He.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(He.subjects&&He.subjects.length>0)return Ut+((He.subjects[0].images||[]).length||0)}return Ut},0),Ct=(Ke=(Fe=Ve==null?void 0:Ve.data)==null?void 0:Fe.config)==null?void 0:Ke.modelId,Jt=p.find(Ut=>Ut.id===Ct),lt=(Jt==null?void 0:Jt.config)||{},et=lt.maxReferenceImages||lt.supportedReferenceImagesLimit||lt.referenceImagesLimit||10;return St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:pt>=et?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}if(ht){const Pt=T.filter(et=>et.target===(Ve==null?void 0:Ve.id)),St=Pt.some(et=>{const Ut=R.find(gt=>gt.id===et.source);return((Ut==null?void 0:Ut.type)||"")==="agent"}),pt=Pt.reduce((et,Ut)=>{var ss,Wt,mt,st;const gt=R.find(ke=>ke.id===Ut.source),ft=(gt==null?void 0:gt.type)||"";if(ft==="aiImage"||ft==="imagePreview")return et+1;if(ft==="upload"){const ke=((mt=(Wt=(ss=gt==null?void 0:gt.data)==null?void 0:ss.config)==null?void 0:Wt.uploadedFiles)==null?void 0:mt[0])||null,He=((ke==null?void 0:ke.type)||"").toUpperCase(),Tt=((ke==null?void 0:ke.mimeType)||"").toLowerCase();return et+(He==="IMAGE"||Tt.startsWith("image/")?1:0)}if(ft==="assetSelector"){const ke=((st=gt==null?void 0:gt.data)==null?void 0:st.config)||{};if(ke.selectedAsset)return et+((ke.selectedAsset.type||"").toUpperCase()==="IMAGE"||(ke.selectedAsset.mimeType||"").toLowerCase().startsWith("image/")?1:0);if(ke.subjects&&ke.subjects.length>0)return et+((ke.subjects[0].images||[]).length||0)}return et},0);return kt?St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:Je==="aiVideo_i2v_first"||Je==="aiVideo_i2v_last"||Ht==="é¦–å¸§"||Ht==="å°¾å¸§"?St&&pt>=1?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt>=1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Je==="aiVideo_first_last"||Ht==="é¦–å°¾å¸§"?St&&pt>=2?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:pt>=2?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:pt===1?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:Je==="aiVideo_reference"||Ht==="å‚è€ƒå›¾"?St&&pt>=7?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:St?{showAgent:!1,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:pt>=7?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!1,showAssetSelector:!1}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}:{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showMidjourney:!1,showUpload:!0,showAssetSelector:!0}}return i}const V=R.find(Ve=>Ve.id===os.sourceNodeId),xe=(Ve=>{var Ht,kt,Pt;if(!Ve)return null;const Je=Ve.type,ht=Ve.data;if(Je==="upload"&&Array.isArray((Ht=ht.config)==null?void 0:Ht.uploadedFiles)&&ht.config.uploadedFiles.length>0){const St=ht.config.uploadedFiles;return St.some(lt=>{const et=((lt==null?void 0:lt.type)||"").toUpperCase(),Ut=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return et==="IMAGE"||Ut.startsWith("image/")})?"IMAGE":St.some(lt=>{const et=((lt==null?void 0:lt.type)||"").toUpperCase(),Ut=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return et==="VIDEO"||Ut.startsWith("video/")})?"VIDEO":St.some(lt=>{const et=((lt==null?void 0:lt.type)||"").toUpperCase(),Ut=((lt==null?void 0:lt.mimeType)||"").toLowerCase();return et==="AUDIO"||Ut.startsWith("audio/")})?"AUDIO":null}if(Je==="assetSelector"){if((kt=ht.config)!=null&&kt.subjects)return"IMAGE";if((Pt=ht.config)!=null&&Pt.selectedAsset){const St=ht.config.selectedAsset,pt=(St.type||"").toUpperCase(),Ct=(St.mimeType||"").toLowerCase();return pt==="IMAGE"||Ct.startsWith("image/")?"IMAGE":pt==="VIDEO"||Ct.startsWith("video/")?"VIDEO":pt==="AUDIO"||Ct.startsWith("audio/")?"AUDIO":pt||null}}return Je==="aiImage"||Je==="imagePreview"||Je==="midjourney"?"IMAGE":(Je||"").startsWith("aiVideo")||Je==="videoPreview"?"VIDEO":Je==="agent"||Je==="textPreview"?"TEXT":null})(V),Ee=V==null?void 0:V.type;return Ee==="videoPreview"?{showAgent:!0,showAiImage:!1,showAudio:!1,showVideo:!1,showEdit:!0,showMidjourney:!1,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!1}:Ee==="imagePreview"?{showAgent:!1,showAiImage:!0,showAudio:!1,showVideo:!0,showEdit:!0,showImageEditing:!0,showMidjourney:!0,showUpload:!1,showAssetSelector:!1,showSuperCanvas:!0}:{showAgent:xe==="TEXT",showAiImage:xe==="IMAGE"||xe==="TEXT",showAudio:xe==="AUDIO",showVideo:xe==="VIDEO"||xe==="IMAGE"||xe==="TEXT",showEdit:xe==="VIDEO",showImageEditing:xe==="IMAGE",showMidjourney:xe==="IMAGE"||xe==="TEXT",showUpload:!1,showAssetSelector:!1,showSuperCanvas:xe==="IMAGE"}},[os,R,T,p]),Xr=t.useCallback((i,{nodeId:y,handleType:U})=>{if(!y){us.current=null;return}if(U==="target"){const V=R.find(xe=>xe.id===y),H=(V==null?void 0:V.type)||"";if(H==="agent"||H==="aiImage"||H==="midjourney"||H.startsWith("aiVideo")){g.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),us.current=null;return}}if(U==="source"){const V=R.find(H=>H.id===y);if(V&&(V.type==="aiImage"||V.type.startsWith("aiVideo"))){us.current=null;return}}Qt.current=!1,us.current={nodeId:y,handleType:U==="target"?"target":"source"},lr(),Bs(null)},[lr,R]),Jr=t.useCallback(i=>{const y=us.current;if(!y)return;let U=0,V=0;"changedTouches"in i&&i.changedTouches.length>0?(U=i.changedTouches[0].clientX,V=i.changedTouches[0].clientY):"clientX"in i&&(U=i.clientX,V=i.clientY),setTimeout(()=>{if(Qt.current){Qt.current=!1,us.current=null;return}const H=i.target,xe=!!H&&!!H.closest(".react-flow__pane"),Ee=!!H&&(H.closest(".react-flow__node")||H.closest(".react-flow__handle"));if(!xe||Ee){Qt.current=!1,us.current=null;return}Bs({x:U,y:V,sourceNodeId:y.nodeId,handleType:y.handleType}),Qt.current=!1},100),us.current=null},[]),ps=(i,y,U,V,H,xe)=>{var Ht,kt,Pt,St,pt,Ct,Jt;if(!os)return;const Ee=ge({x:os.x,y:os.y}),$e=`${U}-${Date.now()}`,ze=R.find(lt=>lt.id===os.sourceNodeId),Fe=ze?Le.find(lt=>lt.nodeIds.includes(ze.id)):null,Ke=i==="aiImage"||i.startsWith("aiVideo")||i==="midjourney",Ve=i.startsWith("aiVideo")?Ir(i):{},Je=V?{agentId:V}:Ve;i.startsWith("aiVideo")&&xe&&Object.assign(Je,xe);const ht={id:$e,type:i,position:Ee,data:{label:H||y,type:U,config:Je,models:p,isExpanded:Ke,onOpenAssetPanel:i==="assetSelector"?tr:void 0,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0,workflowContext:{project:ce,episode:K,nodeGroup:Fe,nodeGroups:Le}}};if(M(lt=>[...lt,ht]),Fe&&(ut(lt=>lt.map(et=>{if(et.id!==Fe.id)return et;const Ut=Array.from(new Set([...et.nodeIds,$e]));return{...et,nodeIds:Ut}})),Nt.current=Nt.current.map(lt=>{if(lt.id!==Fe.id)return lt;const et=Array.from(new Set([...lt.nodeIds,$e]));return{...lt,nodeIds:et}})),os.handleType==="source"){const lt=R.find(ke=>ke.id===os.sourceNodeId),et=ht,Ut=ke=>{const He=(ke||"").toLowerCase().replace(/[_\-\s]+/g," ");return He?He.includes("æ–‡ç”Ÿ")||He.includes("text to video")||He.includes("t2v")?"æ–‡ç”Ÿè§†é¢‘":He.includes("é¦–å°¾")||He.includes("first last")||He.includes("two frame")||He.includes("frame pair")?"é¦–å°¾å¸§":He.includes("é¦–å¸§")||He.includes("first frame")||He.includes("start frame")||He.includes("initial frame")||He.includes("keyframe")?"é¦–å¸§":He.includes("å°¾å¸§")||He.includes("last frame")||He.includes("end frame")||He.includes("final frame")?"å°¾å¸§":He.includes("ä¸»ä½“å‚è€ƒ")||He.includes("subject reference")?"ä¸»ä½“å‚è€ƒ":He.includes("å‚è€ƒ")||He.includes("reference image")||He.includes("image reference")||He.includes("ref image")?"å‚è€ƒå›¾":ke||"":""},gt=ke=>{var Vt,rt,At;const He=ke.type,Tt=ke.data;if(He==="upload"&&Array.isArray((Vt=Tt.config)==null?void 0:Vt.uploadedFiles)&&Tt.config.uploadedFiles.length>0){const bt=Tt.config.uploadedFiles,jt=bt.some(Zt=>{const $s=((Zt==null?void 0:Zt.type)||"").toUpperCase(),As=((Zt==null?void 0:Zt.mimeType)||"").toLowerCase();return $s==="VIDEO"||As.startsWith("video/")}),Yt=bt.some(Zt=>{const $s=((Zt==null?void 0:Zt.type)||"").toUpperCase(),As=((Zt==null?void 0:Zt.mimeType)||"").toLowerCase();return $s==="IMAGE"||As.startsWith("image/")}),vs=bt.some(Zt=>{const $s=((Zt==null?void 0:Zt.type)||"").toUpperCase(),As=((Zt==null?void 0:Zt.mimeType)||"").toLowerCase();return $s==="AUDIO"||As.startsWith("audio/")});return(et==null?void 0:et.type)==="aiVideo_swap"?jt?"VIDEO":Yt?"IMAGE":vs?"AUDIO":null:Yt?"IMAGE":jt?"VIDEO":vs?"AUDIO":null}if(He==="assetSelector"){if((rt=Tt.config)!=null&&rt.subjects)return"IMAGE";if((At=Tt.config)!=null&&At.selectedAsset){const bt=Tt.config.selectedAsset,jt=(bt.type||"").toUpperCase(),Yt=(bt.mimeType||"").toLowerCase();return jt==="IMAGE"||Yt.startsWith("image/")?"IMAGE":jt==="VIDEO"||Yt.startsWith("video/")?"VIDEO":jt==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":jt||null}}return He==="aiImage"||He==="imagePreview"?"IMAGE":(He||"").startsWith("aiVideo")||He==="videoPreview"?"VIDEO":He==="agent"?"TEXT":null},ft=ke=>{var Tt,Vt,rt;if(gt(ke)!=="IMAGE")return 0;if(ke.type==="upload")return(((Vt=(Tt=ke.data)==null?void 0:Tt.config)==null?void 0:Vt.uploadedFiles)||[]).filter(bt=>bt.type==="IMAGE"||(bt.mimeType||"").startsWith("image/")).length;if(ke.type==="assetSelector"){const At=((rt=ke.data)==null?void 0:rt.config)||{};return At.subjects&&At.subjects.length>0?(At.subjects[0].images||[]).length:At.selectedAsset&&At.selectedAsset.type==="IMAGE"?1:0}return ke.type==="imagePreview"||ke.type==="aiImage",1},ss=ke=>{var bt,jt,Yt,vs,Zt,$s;const He=Ut((jt=(bt=ke.data)==null?void 0:bt.config)==null?void 0:jt.generationType);if(He==="æ–‡ç”Ÿè§†é¢‘")return 0;if(He==="é¦–å¸§"||He==="å°¾å¸§")return 1;if(He==="é¦–å°¾å¸§")return 2;if(He==="å‚è€ƒå›¾"||He==="ä¸»ä½“å‚è€ƒ")return 7;const Tt=(vs=(Yt=ke.data)==null?void 0:Yt.config)==null?void 0:vs.modelId,rt=(((Zt=ke.data)==null?void 0:Zt.models)||p).find(As=>As.id===Tt),At=Array.isArray(($s=rt==null?void 0:rt.config)==null?void 0:$s.supportedGenerationTypes)?rt.config.supportedGenerationTypes.map(As=>Ut(As)):[];return At.includes("å‚è€ƒå›¾")||At.includes("ä¸»ä½“å‚è€ƒ")?7:At.includes("é¦–å°¾å¸§")?2:At.includes("é¦–å¸§")||At.includes("å°¾å¸§")?1:(At.includes("æ–‡ç”Ÿè§†é¢‘"),0)},Wt=lt?gt(lt):null;if(et.type.startsWith("aiVideo")&&Wt==="IMAGE"){if(Ut((kt=(Ht=et.data)==null?void 0:Ht.config)==null?void 0:kt.generationType)==="é¦–å°¾å¸§"&&lt&&lt.type==="assetSelector"){const bt=((Pt=lt.data)==null?void 0:Pt.config)||{};if(bt.subjects&&(((St=bt.subjects[0])==null?void 0:St.images)||[]).length>0){g.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Bs(null),us.current=null,Qt.current=!1;return}}const He=T.filter(bt=>bt.target===et.id);let Tt=0;He.forEach(bt=>{const jt=R.find(Yt=>Yt.id===bt.source);jt&&(Tt+=ft(jt))});const Vt=lt?ft(lt):0,rt=ss(et),At=Tt+Vt;if(rt===0){g.error("è¯¥è§†é¢‘æ¨¡å‹ä»…æ”¯æŒæ–‡ç”Ÿè§†é¢‘ï¼Œä¸æ¥æ”¶å›¾ç‰‡"),Bs(null),us.current=null,Qt.current=!1;return}if(At>rt){g.error(`è¯¥è§†é¢‘æ¨¡å‹æœ€å¤šæ¥æ”¶${rt}å¼ å‚è€ƒå›¾ï¼ˆå½“å‰å°†æ¥å…¥${At}å¼ ï¼‰`),Bs(null),us.current=null,Qt.current=!1;return}}let mt;ht.type==="superCanvas"?mt="input-image":ht.type==="midjourney"&&(Wt==="IMAGE"?mt="omni-ref":Wt==="TEXT"&&(mt="text-input"));const st={id:`edge-${os.sourceNodeId}-${ht.id}`,source:os.sourceNodeId,target:ht.id,targetHandle:mt,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(ke=>[...ke,st])}else if(os.handleType==="target"){const lt=R.find(st=>st.id===os.sourceNodeId),et=(lt==null?void 0:lt.type)||"";if(et==="agent"||et==="aiImage"||et==="midjourney"||et.startsWith("aiVideo")){g.error("è¯·ä»ç´ æçš„è¾“å‡ºç«¯è¿æ¥åˆ°è¯¥èŠ‚ç‚¹çš„è¾“å…¥ç«¯"),Bs(null),us.current=null,Qt.current=!1;return}const Ut=ht,gt=R.find(st=>st.id===os.sourceNodeId),ft=st=>{const ke=(st||"").toLowerCase();return ke?ke.includes("æ–‡ç”Ÿ")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("é¦–å°¾")?"é¦–å°¾å¸§":ke.includes("é¦–å¸§")?"é¦–å¸§":ke.includes("å°¾å¸§")?"å°¾å¸§":ke.includes("ä¸»ä½“å‚è€ƒ")?"ä¸»ä½“å‚è€ƒ":ke.includes("å‚è€ƒ")?"å‚è€ƒå›¾":ke.includes("text-to-video")?"æ–‡ç”Ÿè§†é¢‘":ke.includes("first-last")?"é¦–å°¾å¸§":ke.includes("first")?"é¦–å¸§":ke.includes("last")?"å°¾å¸§":ke.includes("subject")?"ä¸»ä½“å‚è€ƒ":ke.includes("reference")?"å‚è€ƒå›¾":st||"":""},Wt=(st=>{var Tt,Vt,rt,At;const ke=st.type,He=st.data;if(ke==="upload"&&((Vt=(Tt=He.config)==null?void 0:Tt.uploadedFiles)==null?void 0:Vt.length)>0){const bt=He.config.uploadedFiles[0],jt=(bt.type||"").toUpperCase(),Yt=(bt.mimeType||"").toLowerCase();return jt==="IMAGE"||Yt.startsWith("image/")?"IMAGE":jt==="VIDEO"||Yt.startsWith("video/")?"VIDEO":jt==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":jt||null}if(ke==="assetSelector"){if((rt=He.config)!=null&&rt.subjects)return"IMAGE";if((At=He.config)!=null&&At.selectedAsset){const bt=He.config.selectedAsset,jt=(bt.type||"").toUpperCase(),Yt=(bt.mimeType||"").toLowerCase();return jt==="IMAGE"||Yt.startsWith("image/")?"IMAGE":jt==="VIDEO"||Yt.startsWith("video/")?"VIDEO":jt==="AUDIO"||Yt.startsWith("audio/")?"AUDIO":jt||null}}return ke==="aiImage"||ke==="imagePreview"?"IMAGE":ke==="aiVideo"||ke==="videoPreview"?"VIDEO":ke==="agent"?"TEXT":null})(Ut);if(gt&&gt.type==="aiVideo"&&Wt==="IMAGE"&&ft((Ct=(pt=gt.data)==null?void 0:pt.config)==null?void 0:Ct.generationType)==="é¦–å°¾å¸§"&&Ut&&Ut.type==="assetSelector"){const ke=((Jt=Ut.data)==null?void 0:Jt.config)||{};if(ke.subjects&&ke.subjects.length>0){g.error("é¦–å°¾å¸§ä¸æ¥å—è§’è‰²ç»„è¾“å…¥ï¼Œè¯·è¿æ¥ä¸¤å¼ å•å›¾"),Bs(null),us.current=null,Qt.current=!1;return}}const mt={id:`edge-${ht.id}-${os.sourceNodeId}`,source:ht.id,sourceHandle:ht.type==="superCanvas"?"output-image":void 0,target:os.sourceNodeId,type:"aurora",animated:!0,style:{stroke:"currentColor",strokeWidth:2}};x(st=>[...st,mt])}Bs(null),us.current=null,Qt.current=!1,g.success(`å·²æ·»åŠ ${y}èŠ‚ç‚¹å¹¶è‡ªåŠ¨è¿æ¥`),i==="assetSelector"&&setTimeout(()=>{tr(ht.id)},100)},ur=t.useCallback(i=>{const y=R.filter($e=>i.includes($e.id));if(y.length===0)return null;const U=50;let V=1/0,H=1/0,xe=-1/0,Ee=-1/0;return y.forEach($e=>{const ze=$e.position.x,Fe=$e.position.y,Ke=$e.width||320,Ve=$e.height||200;V=Math.min(V,ze),H=Math.min(H,Fe),xe=Math.max(xe,ze+Ke),Ee=Math.max(Ee,Fe+Ve)}),{x:V-U,y:H-U,width:xe-V+U*2,height:Ee-H+U*2}},[R]),qr=t.useCallback(()=>{Js(i=>!i),Zs(!1)},[]),Sr=t.useCallback((i,y)=>{const U={id:`text-annotation-${Date.now()}`,type:"textAnnotation",position:{x:i-100,y:y-20},data:{text:"åŒå‡»ç¼–è¾‘æ–‡æœ¬",fontSize:36,width:200,bold:!1,createdBy:fe?{id:fe.id,nickname:fe.nickname,avatar:fe.avatar}:void 0}};M(V=>[...V,U]),Js(!1)},[M,fe]),Yr=t.useCallback(()=>{if(!l){g.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥åˆ›å»ºç¼–ç»„");return}const i=R.filter(xe=>xe.selected);if(i.length===0){g.error('è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹ï¼ˆç‚¹å‡»é¡¶éƒ¨"é€‰æ‹©"æŒ‰é’®è¿›å…¥æ¡†é€‰æ¨¡å¼ï¼‰');return}if(i.length<2){g.error("ç¼–ç»„éœ€è¦è‡³å°‘2ä¸ªèŠ‚ç‚¹");return}const y=i.map(xe=>xe.id);if(Le.some(xe=>xe.nodeIds.some(Ee=>y.includes(Ee)))){g.error("é€‰ä¸­çš„èŠ‚ç‚¹å·²åœ¨å…¶ä»–ç¼–ç»„ä¸­ï¼Œè¯·å…ˆè§£é™¤ç¼–ç»„");return}const V=ur(y);if(!V){g.error("æ— æ³•è®¡ç®—ç¼–ç»„è¾¹ç•Œ");return}const H={id:`group-${Date.now()}`,nodeIds:y,bounds:V};ut(xe=>{const Ee=[...xe,H];return Lt(Ee),setTimeout(()=>{qt()},100),Ee}),nt(H.id),M(xe=>{const Ee=new Set;return T.forEach($e=>{if(y.includes($e.source)){const ze=xe.find(Fe=>Fe.id===$e.target);ze&&(ze.type==="imagePreview"||ze.type==="videoPreview")&&Ee.add($e.target)}}),xe.map($e=>y.includes($e.id)?{...$e,draggable:!0,connectable:!1,deletable:!1,selected:!1,data:{...$e.data,workflowContext:{...$e.data.workflowContext,nodeGroup:H,nodeGroups:[...Le,H]}}}:Ee.has($e.id)?{...$e,data:{...$e.data,workflowContext:{...$e.data.workflowContext,nodeGroup:H,nodeGroups:[...Le,H]}}}:$e)}),g.success(`å·²åˆ›å»ºç¼–ç»„ï¼ŒåŒ…å« ${y.length} ä¸ªèŠ‚ç‚¹`)},[R,ur,Le,M]),Kr=t.useCallback(()=>{if(!l){g.error("åªæœ‰å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥è§£é™¤ç¼–ç»„");return}if(!Et){g.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}const i=Le.find(y=>y.id===Et);i&&(M(y=>y.map(U=>i.nodeIds.includes(U.id)?{...U,draggable:!0,connectable:!0,deletable:!0,data:{...U.data,workflowContext:{...U.data.workflowContext,nodeGroup:null,nodeGroups:Le.filter(V=>V.id!==Et)}}}:U)),ut(y=>{const U=y.filter(V=>V.id!==Et);return Lt(U),setTimeout(()=>{qt()},100),U}),nt(null),g.success("å·²è§£é™¤ç¼–ç»„"))},[Et,Le,M,Lt]),Qr=t.useCallback(()=>{if(!Et){g.error("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¼–ç»„");return}bs(Et),_t(!0)},[Et]),Er=t.useCallback((i,y)=>{i.stopPropagation(),i.preventDefault(),Rs(null),nt(y),zs(null)},[]);t.useEffect(()=>{if(!cs||!ws)return;let i=ws.x,y=ws.y;const U=H=>{const xe=Ps.current;if(!xe)return;const Ee=he(),$e=(H.clientX-i)/Ee.zoom,ze=(H.clientY-y)/Ee.zoom;if(Math.abs($e)<.01&&Math.abs(ze)<.01)return;const Fe=Nt.current.find(Ke=>Ke.id===xe);Fe&&(ut(Ke=>Ke.map(Ve=>Ve.id===xe?{...Ve,bounds:{...Ve.bounds,x:Ve.bounds.x+$e,y:Ve.bounds.y+ze}}:Ve)),M(Ke=>Ke.map(Ve=>Fe.nodeIds.includes(Ve.id)?{...Ve,position:{x:Ve.position.x+$e,y:Ve.position.y+ze}}:Ve)),i=H.clientX,y=H.clientY)},V=()=>{Rs(null),zs(null)};return document.addEventListener("mousemove",U),document.addEventListener("mouseup",V),()=>{document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",V)}},[cs,ws]);const Zr=t.useCallback(i=>{if(hs){const y=ge({x:i.clientX,y:i.clientY});Sr(y.x,y.y);return}lr(),Bs(null),us.current=null,nt(null),Qt.current=!1},[lr,hs,ge,Sr]),xr=t.useRef(null),ea=t.useCallback(()=>{Le.length>0&&!xr.current&&(xr.current=window.requestAnimationFrame(()=>{rr(i=>i+1),xr.current=null}))},[Le.length]),ar=t.useCallback(i=>Le.find(y=>y.nodeIds.includes(i))||null,[Le]),ta=t.useCallback((i,y)=>{var V;if(Ue||(V=y==null?void 0:y.data)!=null&&V.freeDrag)return;const U=ar(y.id);if(U){if(!U.hidden&&!l)return;Ss.current=y.id,Ns.current={x:y.position.x,y:y.position.y}}},[ar,l]),sa=t.useCallback((i,y)=>{var H;if(Ue||(H=y==null?void 0:y.data)!=null&&H.freeDrag||!Ns.current||Ss.current!==y.id)return;const U=ar(y.id);if(!U)return;const V=!U.hidden;if(!(V&&!l))if(V){const xe=y.position.x-Ns.current.x,Ee=y.position.y-Ns.current.y,$e=[],ze=U.nodeIds||[];ms.current.forEach(Fe=>{if(ze.includes(Fe.id)){const Ke={x:Fe.id===y.id?y.position.x:Fe.position.x+xe,y:Fe.id===y.id?y.position.y:Fe.position.y+Ee};$e.push({id:Fe.id,position:Ke})}}),M(Fe=>Fe.map(Ke=>{const Ve=$e.find(Je=>Je.id===Ke.id);return Ve?{...Ke,position:Ve.position}:Ke})),$e.length>0&&wt($e),ut(Fe=>{const Ke=Fe.map(Ve=>Ve.id===U.id?{...Ve,bounds:{...Ve.bounds,x:Ve.bounds.x+xe,y:Ve.bounds.y+Ee}}:Ve);return Nt.current=Ke,Ke}),Ns.current={x:y.position.x,y:y.position.y}}else{const xe=U.bounds.x,Ee=U.bounds.y,$e=U.bounds.width,ze=U.bounds.height,Fe=(Je,ht,Ht)=>Math.max(ht,Math.min(Je,Ht)),Ke=Fe(y.position.x,xe+10,xe+$e-10),Ve=Fe(y.position.y,Ee+10,Ee+ze-10);M(Je=>Je.map(ht=>ht.id===y.id?{...ht,position:{x:Ke,y:Ve}}:ht)),Ns.current={x:Ke,y:Ve}}},[M,ut,ar,l,wt]),ra=t.useCallback(()=>{Ss.current=null,Ns.current=null,Ps.current=null,Ss.current=null,Ns.current=null,Ps.current=null,Rs(null),Nt.current.length>0&&Lt(Nt.current)},[Lt]),aa=t.useCallback((i,y)=>{const U=ar(y.id);U&&nt(U.id)},[ar]);if(t.useEffect(()=>{if(T.length===0||R.length===0)return;const i=T.filter(y=>{const U=R.find(H=>H.id===y.source),V=R.find(H=>H.id===y.target);return(V==null?void 0:V.type)==="midjourney"&&y.targetHandle==="text-input"&&(U==null?void 0:U.type)!=="agent"});i.length>0&&(x(y=>y.filter(U=>!i.some(V=>V.id===U.id))),g.error("Midjourney æ–‡æœ¬è¾“å…¥ä»…æ¥å—æ™ºèƒ½ä½“èŠ‚ç‚¹çš„è¿æ¥"))},[T,R,x]),we)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-tiffany-500 mb-4"}),e.jsx("p",{className:"text-text-dark-secondary",children:"åŠ è½½ä¸­..."})]})});if(!ce)return e.jsx("div",{className:"h-full flex items-center justify-center bg-background-light dark:bg-background-dark",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-red-400 mb-3",children:"warning"}),e.jsx("p",{className:"text-text-dark-secondary mb-2",children:"é¡¹ç›®æ•°æ®æœªåŠ è½½"}),e.jsx("p",{className:"text-text-dark-tertiary text-sm",children:"è¯·è¿”å›é¡¹ç›®åˆ—è¡¨é‡è¯•ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œ/ç™»å½•çŠ¶æ€"})]})});const Cr=R.filter(i=>i.selected).length>=2,pr=!!Et;return e.jsxs("div",{className:"h-full flex bg-background-light dark:bg-background-dark",children:[e.jsxs("div",{ref:at,className:"flex-1 relative overflow-hidden",children:[j&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-[200] bg-amber-500/90 backdrop-blur-sm text-white py-2 px-4 flex items-center justify-center gap-2 shadow-lg",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"visibility"}),e.jsx("span",{className:"text-sm font-medium",children:A?`åªè¯»æ¨¡å¼ - æ¥è‡ª ${A.nickname||"é¡¹ç›®æ‰€æœ‰è€…"} çš„å…±äº«å†…å®¹`:"åªè¯»æ¨¡å¼ - æ‚¨åªæœ‰æŸ¥çœ‹æƒé™ï¼Œæ— æ³•è¿›è¡Œç¼–è¾‘æ“ä½œ"})]}),ce&&e.jsx("div",{className:`absolute left-4 ${j?"top-14":"top-5"} z-[100] h-11 flex items-center`,children:e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:G&&K?`ã€Š${ce.name}ã€‹ç¬¬${K.episodeNumber}é›†${!z&&de&&Z?` ç¬¬${de}å¹•ç¬¬${Z}é•œ`:""}`:`ã€Š${ce.name}ã€‹`})}),!z&&Le.filter(i=>i.scene!==void 0&&i.shot!==void 0).length>0&&e.jsx("div",{className:"absolute left-4 top-20 bottom-4 z-[100] w-48 overflow-y-auto scrollbar-hide",children:e.jsx("div",{className:"space-y-2",children:Le.filter(i=>i.scene!==void 0&&i.shot!==void 0).sort((i,y)=>i.scene!==y.scene?(i.scene||0)-(y.scene||0):(i.shot||0)-(y.shot||0)).map(i=>e.jsx("button",{onClick:()=>{nt(i.id);const y=i.bounds.x+i.bounds.width/2,U=i.bounds.y+i.bounds.height/2,V=at.current;if(V){const H=V.clientWidth,xe=V.clientHeight,Ee=.2,$e=H*(1-Ee),ze=xe*(1-Ee),Fe=$e/i.bounds.width,Ke=ze/i.bounds.height,Ve=Math.min(Fe,Ke,1.5),Je=Math.max(Ve,.3);Oe(y,U,{zoom:Je,duration:800})}else Oe(y,U,{zoom:1,duration:800})},className:`w-full px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${Et===i.id?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white shadow-lg":"bg-white/90 dark:bg-white/10 text-slate-800 dark:text-slate-300 hover:bg-white dark:hover:bg-white/20"}`,children:i.name},i.id))})}),!1,e.jsxs("div",{className:`absolute ${j?"top-14":"top-5"} left-1/2 transform -translate-x-1/2 z-[100] flex gap-2`,children:[e.jsx("button",{onClick:()=>{$(G&&C&&u?`/projects/${C}/episodes/${u}`:"/quick")},className:"w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105",title:G?"è¿”å›å‰§é›†è¯¦æƒ…":"è¿”å›é¡¹ç›®åˆ—è¡¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"arrow_back"})}),!j&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{!Ue&&l&&Zs(!ys)},disabled:Ue||!l,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":ys?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105"}`,title:l?"æ¡†é€‰æ¨¡å¼ (Shift+æ‹–åŠ¨)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:ys?"check_box":"select_all"})}),e.jsx("button",{onClick:()=>{!Ue&&l&&Yr()},disabled:Ue||!l||!Cr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":Cr?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:l?"åˆ›å»ºç¼–ç»„ (éœ€é€‰ä¸­2ä¸ªä»¥ä¸ŠèŠ‚ç‚¹)":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"group_work"})}),e.jsx("button",{onClick:()=>{!Ue&&l&&Kr()},disabled:Ue||!l||!pr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":pr?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:l?"è§£é™¤ç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"group_off"})}),e.jsx("button",{onClick:()=>{!Ue&&l&&Qr()},disabled:Ue||!l||!pr,className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${Ue||!l?"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm":pr?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-slate-200/50 dark:bg-gray-800/50 text-slate-400 dark:text-gray-500 cursor-not-allowed shadow-sm"}`,title:l?"å‘½åç¼–ç»„":"ä»…æ‰€æœ‰è€…å¯ä½¿ç”¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"edit"})}),e.jsx("button",{onClick:()=>qr(),className:`w-11 h-11 rounded-xl flex items-center justify-center transition-all duration-200 ${hs?"bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white hover:shadow-lg shadow-md hover:scale-105":"bg-white/90 dark:bg-gray-800/80 text-slate-800 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-700/90 shadow-md hover:shadow-lg hover:scale-105"}`,title:hs?"ç‚¹å‡»ç”»å¸ƒæ’å…¥æ–‡æœ¬ï¼ˆæŒ‰ Esc å–æ¶ˆï¼‰":"æ·»åŠ æ–‡æœ¬æ ‡æ³¨",children:e.jsx("span",{className:"material-symbols-outlined text-xl",children:"text_fields"})})]})]}),a&&es.length>0&&e.jsxs("div",{className:`absolute ${j?"top-14":"top-5"} right-5 z-[100] flex items-center gap-1`,children:[e.jsx("div",{className:"flex gap-1",children:es.slice(0,8).map(i=>e.jsx("div",{className:"w-9 h-9 rounded-full border-2 border-white dark:border-gray-800 bg-purple-200 dark:bg-purple-800 flex items-center justify-center overflow-hidden shadow-sm",title:i.nickname||"ç”¨æˆ·",children:i.avatar?e.jsx("img",{src:i.avatar.startsWith("http")?i.avatar:`https://api.waule.com${i.avatar}`,alt:i.nickname||"ç”¨æˆ·",className:"w-full h-full object-cover"}):e.jsx("span",{className:"material-symbols-outlined text-sm text-purple-600 dark:text-purple-300",children:"person"})},i.id))}),es.length>8&&e.jsxs("div",{className:"w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm",children:["+",es.length-8]})]}),e.jsx("div",{className:`absolute inset-0 ${ys?"cursor-crosshair":""} ${hs?"cursor-text":""}`,style:{zIndex:1},children:e.jsx(ma,{nodes:Cs,edges:T,onNodesChange:j?void 0:xs,onEdgesChange:j?void 0:Fr,onNodesDelete:j?void 0:Wr,onEdgesDelete:j?void 0:zr,onConnect:j?void 0:ir,onConnectStart:j?void 0:Xr,onConnectEnd:j?void 0:Jr,onEdgeDoubleClick:j?void 0:Gs,onPaneContextMenu:j?void 0:Br,onPaneClick:j?void 0:Zr,onMove:ea,onNodeClick:j?void 0:aa,onNodeDragStart:j?void 0:ta,onNodeDrag:j?void 0:sa,onNodeDragStop:j?void 0:ra,nodeTypes:Bo,edgeTypes:Ho,nodesDraggable:!j,nodesConnectable:!j,elementsSelectable:!j,noDragClassName:"nodrag",className:`bg-background-light dark:bg-background-dark ${ys?"cursor-crosshair":""} ${j?"readonly-workflow":""}`,minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},defaultEdgeOptions:{type:"aurora",animated:!1,style:{stroke:"currentColor",strokeWidth:2}},connectionLineType:"bezier",connectionLineStyle:{stroke:"#a855f7",strokeWidth:2,strokeLinecap:"round"},selectionOnDrag:j?!1:ys,panOnDrag:ys?!1:[1,0],selectionKeyCode:null,multiSelectionKeyCode:null,proOptions:{hideAttribution:!0},elevateNodesOnSelect:!1,elevateEdgesOnSelect:!1,children:e.jsx(xa,{position:"bottom-right",showInteractive:!1})})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:5},children:e.jsxs("svg",{className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"group-border-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"#a855f7"}),e.jsx("stop",{offset:"50%",stopColor:"#d946ef"}),e.jsx("stop",{offset:"100%",stopColor:"#ec4899"})]})}),Le.filter(i=>!i.hidden).map(i=>{const y=he(),U=i.bounds.x*y.zoom+y.x,V=i.bounds.y*y.zoom+y.y,H=i.bounds.width*y.zoom,xe=i.bounds.height*y.zoom,Ee=12*y.zoom,$e=Math.max(1.25,1.25*y.zoom),ze=document.documentElement.classList.contains("dark"),Fe=Et===i.id;return e.jsxs("g",{children:[e.jsx("rect",{x:U,y:V,width:H,height:xe,rx:Ee,ry:Ee,fill:"none",stroke:Fe?"url(#group-border-gradient)":ze?"#e5e7eb":"#4b5563",strokeWidth:$e,style:{filter:Fe?"drop-shadow(0 0 20px rgba(168, 85, 247, 0.5))":"drop-shadow(0 0 15px rgba(168, 85, 255, 0.3))"}}),e.jsx("rect",{x:U,y:V,width:H,height:xe,rx:Ee,ry:Ee,fill:"transparent",stroke:"transparent",strokeWidth:$e*3,style:{pointerEvents:"stroke",cursor:cs===i.id?"grabbing":"grab"},onMouseDown:Ke=>{Ke.stopPropagation(),Ke.preventDefault(),Er(Ke,i.id)},onClick:Ke=>{Ke.stopPropagation(),nt(i.id)}})]},i.id)})]})},qs),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:Le.filter(i=>!i.hidden).map(i=>{if(!i.name)return null;const y=he(),U=i.bounds.x*y.zoom+y.x,V=i.bounds.y*y.zoom+y.y,H=40*y.zoom,xe=10*y.zoom,Ee=15*y.zoom;return e.jsx("div",{className:"absolute font-bold whitespace-nowrap pointer-events-auto select-none text-slate-900 dark:text-white",onMouseDown:$e=>{$e.stopPropagation(),Er($e,i.id)},onClick:$e=>{$e.stopPropagation(),nt(i.id)},style:{left:U+xe,top:V-H-xe-Ee,fontSize:`${H}px`,cursor:cs===i.id?"grabbing":"grab",textShadow:"0 2px 8px rgba(0, 0, 0, 0.5)"},children:i.name},`label-${i.id}`)})},`labels-${qs}`),B&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:B.x,top:B.y},children:[e.jsx("style",{children:`
                @keyframes submenuSlideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
                .menu-icon { font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 20; }
                button .text-sm, div .text-sm { font-weight: 400; }
              `}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe.current&&(clearTimeout(oe.current),oe.current=null),J("agent")},onMouseLeave:()=>{oe.current=window.setTimeout(()=>{J(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>J("agent"),onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),J("agent")},onClick:i=>{i.preventDefault(),i.stopPropagation(),J("agent")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),X==="agent"&&e.jsx("div",{onMouseEnter:()=>{oe.current&&(clearTimeout(oe.current),oe.current=null),J("agent")},onMouseLeave:i=>{const y=i.currentTarget.parentElement,U=i.relatedTarget;(!y||!y.contains(U))&&(oe.current=window.setTimeout(()=>{J(null)},300))},className:"absolute left-full top-0 bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 max-h-80 overflow-y-auto w-full",style:{animation:"submenuSlideDown 0.18s ease-out"},children:E.length>0?E.map(i=>e.jsxs("button",{onMouseDown:y=>{y.preventDefault(),y.stopPropagation(),ds("agent",i.name,"agent",i.id,i.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:i.name}),i.description&&e.jsx("div",{className:"text-xs text-purple-400 truncate",children:i.description})]})]},i.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),e.jsxs("button",{onClick:()=>ds("image","å›¾ç‰‡ç”Ÿæˆ","aiImage"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{ue.current&&(clearTimeout(ue.current),ue.current=null),h(!0)},onMouseLeave:()=>{ue.current=window.setTimeout(()=>{h(!1)},200)},children:[e.jsxs("button",{onMouseEnter:()=>{J("video")},onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),J("video")},onClick:i=>{i.preventDefault(),i.stopPropagation(),J("video")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),S&&e.jsxs("div",{onMouseEnter:()=>{ue.current&&(clearTimeout(ue.current),ue.current=null),h(!0)},onMouseLeave:i=>{const y=i.currentTarget.parentElement,U=i.relatedTarget;(!y||!y.contains(U))&&(ue.current=window.setTimeout(()=>{h(!1)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","Sora2Video","soraVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","Soraè§’è‰²ç”Ÿæˆ","soraCharacter")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"face"}),e.jsx("div",{className:"text-sm",children:"Soraè§’è‰²ç”Ÿæˆ"})]}),je.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","æ–‡ç”Ÿè§†é¢‘","aiVideo_t2v")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),je.has("é¦–å¸§")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","aiVideo_i2v_first")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),je.has("å°¾å¸§")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","aiVideo_i2v_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),je.has("é¦–å°¾å¸§")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","é¦–å°¾å¸§ç”Ÿæˆ","aiVideo_first_last")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(je.has("å‚è€ƒå›¾")||je.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å‚è€ƒå›¾ç”Ÿæˆ","aiVideo_reference")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),je.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","è§†é¢‘æ¢äºº","aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"})},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]}),e.jsxs("button",{onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),ds("video","å¹¿å‘Šæˆç‰‡","commercialVideo")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white border-t border-white/5 dark:border-white/5 border-gray-200",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"featured_video"}),e.jsx("div",{className:"text-sm",children:"å¹¿å‘Šæˆç‰‡"})]})]})]}),e.jsxs("div",{className:"relative",onMouseEnter:()=>{oe.current&&(clearTimeout(oe.current),oe.current=null),J("edit")},onMouseLeave:()=>{oe.current=window.setTimeout(()=>{J(null)},300)},children:[e.jsxs("button",{onMouseEnter:()=>{J("edit")},onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),J("edit")},onClick:i=>{i.preventDefault(),i.stopPropagation(),J("edit")},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),X==="edit"&&e.jsxs("div",{onMouseEnter:()=>{oe.current&&(clearTimeout(oe.current),oe.current=null),J("edit")},onMouseLeave:i=>{const y=i.currentTarget.parentElement,U=i.relatedTarget;(!y||!y.contains(U))&&(oe.current=window.setTimeout(()=>{J(null)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",style:{animation:"submenuSlideLR 0.22s ease-out"},children:[Te.filter(i=>Re(i).length>0).map(i=>e.jsxs("button",{onMouseDown:y=>{y.preventDefault(),y.stopPropagation(),i==="å¯¹å£å‹"?ds("video","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","aiVideo_lipsync"):i==="é£æ ¼è½¬æ¢"?ds("video","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","aiVideo_style"):ds("video",i==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${i}`,"aiVideo_swap",void 0,void 0,void 0,void 0,{selectedEditingCapability:i}),W(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:i})]},i)),Te.every(i=>Re(i).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:()=>ds("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ds("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),e.jsxs("button",{onClick:()=>ds("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),e.jsxs("button",{onClick:()=>ds("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]}),os&&e.jsxs("div",{className:"fixed z-[200] bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48",style:{left:os.x+5,top:os.y+5},children:[Ks.showAgent&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{ae(null),Se.current&&(clearTimeout(Se.current),Se.current=null),be(!0)},onMouseLeave:()=>{Se.current=window.setTimeout(()=>{be(!1)},1200)},children:[e.jsxs("button",{onMouseEnter:()=>be(!0),onMouseLeave:()=>be(!1),onMouseDown:i=>{i.preventDefault(),i.stopPropagation(),be(!0)},onClick:i=>{i.preventDefault(),i.stopPropagation(),be(!0)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"psychology"}),e.jsx("div",{className:"text-sm",children:"æ™ºèƒ½ä½“"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),q&&e.jsx("div",{onMouseEnter:()=>{Se.current&&(clearTimeout(Se.current),Se.current=null),be(!0)},onMouseLeave:()=>{Se.current=window.setTimeout(()=>{be(!1)},300)},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 min-w-48 max-h-80 overflow-y-auto",children:E.length>0?E.map(i=>e.jsxs("button",{onMouseDown:y=>{y.preventDefault(),y.stopPropagation(),ps("agent",i.name,"agent",i.id,i.name)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"smart_toy"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:i.name}),i.description&&e.jsx("div",{className:"text-xs text-purple-400 truncate",children:i.description})]})]},i.id)):e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— å¯ç”¨æ™ºèƒ½ä½“"})})]}),Ks.showAiImage&&e.jsxs("button",{onMouseEnter:()=>ae(null),onClick:()=>ps("aiImage","å›¾ç‰‡ç”Ÿæˆ","image"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"image"}),e.jsx("div",{className:"text-sm",children:"å›¾ç‰‡ç”Ÿæˆ"})]}),!1,Ks.showVideo&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{le.current&&(clearTimeout(le.current),le.current=null),ae("video")},onMouseLeave:()=>{le.current=window.setTimeout(()=>{ae(null)},200)},children:[e.jsxs("button",{onMouseEnter:()=>ae("video"),onClick:i=>i.stopPropagation(),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç”Ÿæˆ"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),F==="video"&&e.jsxs("div",{onMouseEnter:()=>{le.current&&(clearTimeout(le.current),le.current=null),ae("video")},onMouseLeave:i=>{const y=i.currentTarget.parentElement,U=i.relatedTarget;(!y||!y.contains(U))&&(le.current=window.setTimeout(()=>{ae(null)},120))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[e.jsxs("button",{onClick:()=>ps("soraVideo","Sora2Video","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"Sora2Video"})]}),je.has("æ–‡ç”Ÿè§†é¢‘")&&e.jsxs("button",{onClick:()=>ps("aiVideo_t2v","æ–‡ç”Ÿè§†é¢‘","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"æ–‡ç”Ÿè§†é¢‘"})]}),je.has("é¦–å¸§")&&e.jsxs("button",{onClick:()=>ps("aiVideo_i2v_first","å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆé¦–å¸§ï¼‰"})]}),je.has("å°¾å¸§")&&e.jsxs("button",{onClick:()=>ps("aiVideo_i2v_last","å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å›¾ç”Ÿè§†é¢‘ï¼ˆå°¾å¸§ï¼‰"})]}),je.has("é¦–å°¾å¸§")&&e.jsxs("button",{onClick:()=>ps("aiVideo_first_last","é¦–å°¾å¸§ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover-bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"é¦–å°¾å¸§ç”Ÿæˆ"})]}),(je.has("å‚è€ƒå›¾")||je.has("è§†é¢‘æ¢äºº"))&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ps("aiVideo_reference","å‚è€ƒå›¾ç”Ÿæˆ","video"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"å‚è€ƒå›¾ç”Ÿæˆ"})]}),je.has("è§†é¢‘æ¢äºº")&&e.jsxs("button",{onClick:()=>ps("aiVideo_swap","è§†é¢‘æ¢äºº","video",void 0,void 0,{selectedEditingCapability:"è§†é¢‘æ¢äºº"}),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘æ¢äºº"})]})]})]})]}),Ks.showEdit&&e.jsxs("div",{className:"relative",onMouseEnter:()=>{ae(null),ye.current&&(clearTimeout(ye.current),ye.current=null),W(!0)},onMouseLeave:()=>{ye.current=window.setTimeout(()=>{W(!1)},1800)},children:[e.jsxs("button",{onMouseEnter:()=>W(!0),onMouseLeave:()=>W(!1),onClick:i=>{i.preventDefault(),i.stopPropagation(),W(!0)},onMouseOver:()=>ae(null),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center justify-between text-gray-900 dark:text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:"è§†é¢‘ç¼–è¾‘"})]}),e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"chevron_right"})]}),f&&e.jsxs("div",{onMouseEnter:()=>{ye.current&&(clearTimeout(ye.current),ye.current=null),W(!0)},onMouseLeave:i=>{const y=i.currentTarget.parentElement,U=i.relatedTarget;(!y||!y.contains(U))&&(ye.current=window.setTimeout(()=>{W(!1)},300))},className:"absolute left-full top-0 -ml-px bg-[#171718] dark:bg-[#171718] bg-[#fcfdfe] backdrop-blur-xl border border-white/10 dark:border-white/10 border-gray-200 rounded-lg shadow-2xl py-1 w-full max-h-none overflow-y-visible",children:[Te.filter(i=>Re(i).length>0).map(i=>e.jsxs("button",{onMouseDown:y=>{y.preventDefault(),y.stopPropagation(),i==="å¯¹å£å‹"?ps("aiVideo_lipsync","è§†é¢‘ç¼–è¾‘Â·å¯¹å£å‹","video"):i==="é£æ ¼è½¬æ¢"?ps("aiVideo_style","è§†é¢‘ç¼–è¾‘Â·é£æ ¼è½¬æ¢","video"):ps("aiVideo_swap",i==="åŠ¨ä½œå…‹éš†"?"åŠ¨ä½œå…‹éš†":`è§†é¢‘ç¼–è¾‘Â·${i}`,"video"),W(!1)},className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"movie_edit"}),e.jsx("div",{className:"text-sm",children:i})]},`conn-${i}`)),Te.every(i=>Re(i).length===0)&&e.jsx("div",{className:"px-4 py-2 text-sm text-purple-400",children:"æš‚æ— æ”¯æŒè§†é¢‘ç¼–è¾‘èƒ½åŠ›çš„æ¨¡å‹"})]})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showMidjourney&&e.jsxs("button",{onMouseEnter:()=>ae(null),onClick:()=>ps("midjourney","Midjourney","midjourney"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"auto_awesome"}),e.jsx("div",{className:"text-sm",children:"Midjourney"})]}),e.jsx("div",{className:"h-px bg-white/10 dark:bg-white/10 bg-gray-200 my-1"}),Ks.showUpload&&e.jsxs("button",{onMouseEnter:()=>ae(null),onClick:()=>ps("upload","ä¸Šä¼ ç´ æ","upload"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"upload_file"}),e.jsx("div",{className:"text-sm",children:"ä¸Šä¼ ç´ æ"})]}),Ks.showAssetSelector&&e.jsxs("button",{onMouseEnter:()=>ae(null),onClick:()=>ps("assetSelector","èµ„äº§é€‰æ‹©å™¨","assetSelector"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"photo_library"}),e.jsx("div",{className:"text-sm",children:"èµ„äº§é€‰æ‹©å™¨"})]}),Ks.showSuperCanvas&&e.jsxs("button",{onMouseEnter:()=>ae(null),onClick:()=>ps("superCanvas","è‡ªç”±ç”»å¸ƒ","superCanvas"),className:"w-full px-4 py-2 text-left hover:bg-white/5 dark:hover:bg-white/5 hover:bg-gray-100 transition-colors flex items-center gap-3 text-gray-900 dark:text-white",children:[e.jsx("span",{className:"material-symbols-outlined menu-icon text-sm text-gray-400 dark:text-gray-400 text-gray-600",children:"brush"}),e.jsx("div",{className:"text-sm",children:"è‡ªç”±ç”»å¸ƒ"})]})]})]}),e.jsx(zo,{isOpen:re,onClose:()=>{Be(!1),Ft(null)},onAssetSelect:Hr}),tt&&Kt&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center",onClick:()=>_t(!1),children:e.jsxs("div",{className:"bg-white dark:bg-card-dark border border-slate-200 dark:border-border-dark rounded-xl p-6 w-96 shadow-2xl",onClick:i=>i.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-text-dark-primary mb-4",children:"å‘½åç¼–ç»„"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ å¹•"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥å¹•æ•°ï¼ˆæ•´æ•°ï¼‰",id:"scene-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-600 dark:text-text-dark-secondary mb-2",children:"ç¬¬å‡ é•œ"}),e.jsx("input",{type:"number",min:"1",placeholder:"è¾“å…¥é•œæ•°ï¼ˆæ•´æ•°ï¼‰",id:"shot-input",className:"w-full px-3 py-2 bg-slate-50 dark:bg-background-dark border border-slate-200 dark:border-border-dark rounded-lg text-slate-900 dark:text-text-dark-primary focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>_t(!1),className:"flex-1 px-4 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-700 text-slate-800 dark:text-white rounded-lg transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:()=>{const i=document.getElementById("scene-input"),y=document.getElementById("shot-input"),U=parseInt((i==null?void 0:i.value)||"0"),V=parseInt((y==null?void 0:y.value)||"0");if(U>0&&V>0){if(Le.find(xe=>xe.id!==Kt&&xe.scene===U&&xe.shot===V)){g.error(`å·²å­˜åœ¨ç›¸åŒçš„ç¼–ç»„åç§°ï¼šç¬¬${U}å¹•-ç¬¬${V}é•œ`);return}ut(xe=>{const Ee=xe.map(ze=>ze.id===Kt?{...ze,scene:U,shot:V,name:`ç¬¬${U}å¹•-ç¬¬${V}é•œ`}:ze),$e=Ee.find(ze=>ze.id===Kt);return $e&&M(ze=>{const Fe=new Set;return T.forEach(Ke=>{if($e.nodeIds.includes(Ke.source)){const Ve=ze.find(Je=>Je.id===Ke.target);Ve&&(Ve.type==="imagePreview"||Ve.type==="videoPreview")&&Fe.add(Ke.target)}}),ze.map(Ke=>$e.nodeIds.includes(Ke.id)||Fe.has(Ke.id)?{...Ke,data:{...Ke.data,workflowContext:{...Ke.data.workflowContext,nodeGroup:$e,nodeGroups:Ee}}}:Ke)}),setTimeout(()=>{qt()},100),Ee}),_t(!1),bs(null),g.success(`å·²å‘½åä¸ºï¼šç¬¬${U}å¹•-ç¬¬${V}é•œ`)}else g.error("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹•æ•°å’Œé•œæ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰")},className:"flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:shadow-lg text-white rounded-lg transition-all",children:"ç¡®å®š"})]})]})]})})]})},sn=()=>e.jsx(pa,{children:e.jsx(Xo,{})});export{sn as default};
