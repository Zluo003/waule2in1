# ğŸš€ AIVIDER æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## ä¸€ã€é—®é¢˜è¯Šæ–­

### åŸå§‹çŠ¶å†µ
- **CPU**: 30%ï¼ˆ6æ ¸ä»…ç”¨1æ ¸ï¼‰
- **å†…å­˜**: 5GB / 8GBï¼ˆå•è¿›ç¨‹å ç”¨è¿‡é«˜ï¼‰
- **åœ¨çº¿ç”¨æˆ·**: ~50äºº
- **ç—‡çŠ¶**: åŠ è½½å·¥ä½œæµå’Œé¡¹ç›®åˆ—è¡¨ç»å¸¸å¤±è´¥æŠ¥é”™

### æ ¹å› åˆ†æ

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ |
|-----|---------|------|
| PM2 å•å®ä¾‹ fork æ¨¡å¼ | ğŸ”´ è‡´å‘½ | 6æ ¸CPUåªç”¨1æ ¸ï¼Œæµªè´¹83%è®¡ç®—èƒ½åŠ› |
| PrismaClient å¤šå®ä¾‹ | ğŸ”´ è‡´å‘½ | å†…å­˜æ³„æ¼ï¼Œè¿æ¥æ± è€—å°½ |
| Socket.io æ— ç¼“å­˜ | ğŸŸ  ä¸¥é‡ | æ¯æ¬¡è¿æ¥éƒ½æŸ¥è¯¢æ•°æ®åº“ |
| å·¥ä½œæµæŸ¥è¯¢æ— ç¼“å­˜ | ğŸŸ  ä¸¥é‡ | N+1 æŸ¥è¯¢é—®é¢˜ |
| æ—¥å¿—è¿‡å¤š | ğŸŸ¡ ä¸­ç­‰ | IO å¼€é”€ï¼Œæ—¥å¿—æ–‡ä»¶è†¨èƒ€ |

---

## äºŒã€å·²å®æ–½ä¼˜åŒ–

### 1. PM2 é›†ç¾¤æ¨¡å¼ âœ…

**æ–‡ä»¶**: `ecosystem.config.js`

```javascript
{
  instances: 4,           // 4ä¸ªå®ä¾‹ï¼ˆä¿ç•™2æ ¸ç»™ç³»ç»Ÿå’ŒDBï¼‰
  exec_mode: 'cluster',   // é›†ç¾¤æ¨¡å¼
  max_memory_restart: '1500M',
  node_args: '--max-old-space-size=1400',
}
```

**é¢„æœŸæ•ˆæœ**:
- CPU åˆ©ç”¨ç‡æå‡ 4 å€
- å•å®ä¾‹å†…å­˜ä¸Šé™ 1.5GB
- æ€»å¹¶å‘èƒ½åŠ›æå‡ 4 å€

### 2. PrismaClient å•ä¾‹ âœ…

**æ–‡ä»¶**: `server/src/services/discord-reverse.service.ts`

```typescript
// ä¿®å¤å‰
const prisma = new PrismaClient();  // âŒ æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹

// ä¿®å¤å
import { prisma } from '../index';  // âœ… å…±äº«å®ä¾‹
```

**é¢„æœŸæ•ˆæœ**:
- å†…å­˜å ç”¨å‡å°‘ 500MB+
- æ•°æ®åº“è¿æ¥æ± ç¨³å®š

### 3. Socket.io Redis ç¼“å­˜ âœ…

**æ–‡ä»¶**: `server/src/index.ts`

**ç¼“å­˜ç­–ç•¥**:
- ç”¨æˆ·è®¤è¯ä¿¡æ¯ç¼“å­˜ 5 åˆ†é’Ÿ
- å·¥ä½œæµæƒé™ç¼“å­˜ 10 åˆ†é’Ÿ
- å‡å°‘ 90%+ çš„æ•°æ®åº“æŸ¥è¯¢

### 4. å·¥ä½œæµæŸ¥è¯¢ç¼“å­˜ âœ…

**æ–‡ä»¶**: `server/src/controllers/workflow.controller.ts`

**ç¼“å­˜ç­–ç•¥**:
- å·¥ä½œæµæ•°æ®ç¼“å­˜ 30 ç§’
- æƒé™ä¿¡æ¯ç¼“å­˜ 5 åˆ†é’Ÿ

### 5. ä»»åŠ¡é˜Ÿåˆ—å¹¶å‘æ§åˆ¶ âœ…

**æ–°æ–‡ä»¶**: `server/src/utils/taskQueue.ts`

**å¹¶å‘é™åˆ¶**:
- å›¾ç‰‡ç”Ÿæˆ: æœ€å¤§ 15 å¹¶å‘
- è§†é¢‘ç”Ÿæˆ: æœ€å¤§ 8 å¹¶å‘
- æ–‡æœ¬ç”Ÿæˆ: æœ€å¤§ 20 å¹¶å‘

### 6. æ—¥å¿—ä¼˜åŒ– âœ…

**æ–‡ä»¶**: `server/src/utils/logger.ts`

**ä¼˜åŒ–ç­–ç•¥**:
- ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«: `warn`
- æˆåŠŸè¯·æ±‚é‡‡æ ·ç‡: 10%
- æ…¢è¯·æ±‚å§‹ç»ˆè®°å½• (>1s)

---

## ä¸‰ã€éƒ¨ç½²æŒ‡å—

### æ­¥éª¤ 1: é‡æ–°æ„å»º

```bash
cd /home/luo/waule/server
npm run build
```

### æ­¥éª¤ 2: é‡å¯ PM2

```bash
# åœæ­¢æ—§è¿›ç¨‹
pm2 stop aivider-server

# åˆ é™¤æ—§è¿›ç¨‹
pm2 delete aivider-server

# ä½¿ç”¨æ–°é…ç½®å¯åŠ¨
pm2 start ecosystem.config.js --only aivider-server

# ä¿å­˜é…ç½®
pm2 save
```

### æ­¥éª¤ 3: éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ï¼ˆåº”æœ‰4ä¸ªå®ä¾‹ï¼‰
pm2 status

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
pm2 monit

# æŸ¥çœ‹æ—¥å¿—
pm2 logs aivider-server --lines 100
```

---

## å››ã€é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| CPU åˆ©ç”¨ç‡ | 30% (1æ ¸) | 60-80% (4æ ¸) | 4x |
| å†…å­˜å ç”¨ | 5GB | 2-3GB | -50% |
| å¹¶å‘ç”¨æˆ· | ~50 | ~200 | 4x |
| å·¥ä½œæµåŠ è½½ | 500ms+ | <100ms | 5x |
| é¡¹ç›®åˆ—è¡¨ | 300ms+ | <50ms | 6x |

---

## äº”ã€ç›‘æ§å»ºè®®

### PM2 ç›‘æ§å‘½ä»¤

```bash
# å®æ—¶ç›‘æ§
pm2 monit

# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
pm2 show aivider-server

# æŸ¥çœ‹æ‰€æœ‰å®ä¾‹
pm2 list
```

### å…³é”®æŒ‡æ ‡

1. **å†…å­˜**: å•å®ä¾‹ <1.5GB
2. **CPU**: å„å®ä¾‹å‡è¡¡åˆ†å¸ƒ
3. **é‡å¯æ¬¡æ•°**: åº”ä¿æŒä¸º 0
4. **å“åº”æ—¶é—´**: P95 <500ms

### å‘Šè­¦é˜ˆå€¼

- å†…å­˜ >1GB: è­¦å‘Š
- å†…å­˜ >1.3GB: ä¸¥é‡
- é‡å¯æ¬¡æ•° >3: è°ƒæŸ¥

---

## å…­ã€åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **æ•°æ®åº“è¿æ¥æ± **: åœ¨ Prisma é…ç½®ä¸­é™åˆ¶è¿æ¥æ•°
2. **Redis è¿æ¥æ± **: é…ç½® ioredis è¿æ¥æ± å¤§å°
3. **é™æ€èµ„æº CDN**: å°†å›¾ç‰‡/è§†é¢‘è¿ç§»åˆ° CDN

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰

1. **æ•°æ®åº“è¯»å†™åˆ†ç¦»**: ä¸»åº“å†™ï¼Œä»åº“è¯»
2. **æ¶ˆæ¯é˜Ÿåˆ—**: ä½¿ç”¨ BullMQ æ›¿ä»£å†…å­˜é˜Ÿåˆ—
3. **æ°´å¹³æ‰©å±•**: å¤šå°æœåŠ¡å™¨ + è´Ÿè½½å‡è¡¡

### é•¿æœŸï¼ˆ3-6æœˆï¼‰

1. **å¾®æœåŠ¡æ‹†åˆ†**: AI ç”ŸæˆæœåŠ¡ç‹¬ç«‹éƒ¨ç½²
2. **Kubernetes**: å®¹å™¨ç¼–æ’å’Œè‡ªåŠ¨æ‰©ç¼©
3. **ç›‘æ§ä½“ç³»**: Prometheus + Grafana

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹

1. **Redis å¿…é¡»å¯ç”¨**: ç¼“å­˜ä¾èµ– Redisï¼Œç¡®ä¿ Redis æœåŠ¡ç¨³å®š
2. **Socket.io ç²˜æ€§ä¼šè¯**: å¦‚ä½¿ç”¨ Nginx è´Ÿè½½å‡è¡¡ï¼Œéœ€é…ç½® `ip_hash`
3. **å®šæ—¶ä»»åŠ¡**: é›†ç¾¤æ¨¡å¼ä¸‹åªåœ¨ä¸»è¿›ç¨‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡

### Nginx é…ç½®ç¤ºä¾‹ï¼ˆå¦‚éœ€ï¼‰

```nginx
upstream aivider_backend {
    ip_hash;  # ç²˜æ€§ä¼šè¯
    server 127.0.0.1:3000;
}
```

---

*ä¼˜åŒ–å®Œæˆæ—¶é—´: 2024-11-29*
*ä¼˜åŒ–å·¥ç¨‹å¸ˆ: AI Assistant*
