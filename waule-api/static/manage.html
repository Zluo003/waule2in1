<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†æ§åˆ¶å° - Waule API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-slide-up{animation:slide-up .3s ease-out}
        .tab-btn{transition:all .2s ease}
    </style>
    <script>
        tailwind.config={theme:{extend:{colors:{border:"hsl(0 0% 89%)",input:"hsl(0 0% 89%)",ring:"hsl(0 0% 3.9%)",background:"hsl(0 0% 100%)",foreground:"hsl(0 0% 3.9%)",primary:{DEFAULT:"hsl(0 0% 9%)",foreground:"hsl(0 0% 98%)"},secondary:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 9%)"},muted:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 45.1%)"},destructive:{DEFAULT:"hsl(0 84.2% 60.2%)",foreground:"hsl(0 0% 98%)"}}}}}
    </script>
</head>
<body class="h-full bg-background text-foreground antialiased">
    <!-- å¯¼èˆªæ  -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-center gap-2">
                <div class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-primary">
                    <svg class="w-4 h-4 text-primary-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <span class="font-bold text-xl">Waule API</span>
            </div>
            <div class="flex flex-1 items-center justify-end gap-3">
                <button onclick="logout()" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    é€€å‡º
                </button>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <!-- Tab å¯¼èˆª -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('tokens')" id="tabTokens" class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">Token ç®¡ç†</button>
                <button onclick="switchTab('apikeys')" id="tabApikeys" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">API Key ç®¡ç†</button>
                <button onclick="switchTab('discord')" id="tabDiscord" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Discord(MJ)</button>
                <button onclick="switchTab('oss')" id="tabOss" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">å¹³å°OSS</button>
                <button onclick="switchTab('proxyapi')" id="tabProxyapi" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">å›¾ç‰‡ä¸­è½¬API</button>
                <button onclick="switchTab('soraproxy')" id="tabSoraproxy" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Soraä¸­è½¬</button>
                <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">ç³»ç»Ÿé…ç½®</button>
                <button onclick="switchTab('logs')" id="tabLogs" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">è¯·æ±‚æ—¥å¿—</button>
            </nav>
        </div>

        <!-- Token ç®¡ç†é¢æ¿ -->
        <div id="panelTokens">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid gap-4 grid-cols-2 md:grid-cols-5 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Token æ€»æ•°</p>
                    <h3 class="text-xl font-bold" id="statTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ´»è·ƒ Token</p>
                    <h3 class="text-xl font-bold text-green-600" id="statActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">ä»Šæ—¥å›¾ç‰‡/æ€»å›¾ç‰‡</p>
                    <h3 class="text-xl font-bold text-blue-600" id="statImages">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">ä»Šæ—¥è§†é¢‘/æ€»è§†é¢‘</p>
                    <h3 class="text-xl font-bold text-purple-600" id="statVideos">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">ä»Šæ—¥é”™è¯¯/æ€»é”™è¯¯</p>
                    <h3 class="text-xl font-bold text-destructive" id="statErrors">-</h3>
                </div>
            </div>

            <!-- Token åˆ—è¡¨ -->
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Token åˆ—è¡¨</h3>
                    <div class="flex items-center gap-3">
                        <!-- è‡ªåŠ¨åˆ·æ–°ATæ ‡ç­¾å’Œå¼€å…³ -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-muted-foreground">è‡ªåŠ¨åˆ·æ–°AT</span>
                            <div class="relative inline-flex items-center group">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="atAutoRefreshToggle" onchange="toggleATAutoRefresh()" class="sr-only peer">
                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                                <!-- æ‚¬æµ®æç¤º -->
                                <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs rounded px-2 py-1 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Tokenè·ç¦»è¿‡æœŸ<24hæ—¶è‡ªåŠ¨ä½¿ç”¨STæˆ–RTåˆ·æ–°AT
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                            </div>
                        </div>
                        <button onclick="refreshTokens()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="åˆ·æ–°">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                        <button onclick="exportTokens()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 h-8 px-3" title="å¯¼å‡ºæ‰€æœ‰Token">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span class="text-sm font-medium">å¯¼å‡º</span>
                        </button>
                        <button onclick="openImportModal()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 h-8 px-3" title="å¯¼å…¥Token">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span class="text-sm font-medium">å¯¼å…¥</span>
                        </button>
                        <button onclick="openAddModal()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span class="text-sm font-medium">æ–°å¢</span>
                        </button>
                    </div>
                </div>
                
                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">é‚®ç®±</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">çŠ¶æ€</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">è¿‡æœŸæ—¶é—´</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">è´¦æˆ·ç±»å‹</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Sora2</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">å¯ç”¨æ¬¡æ•°</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">å›¾ç‰‡</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">è§†é¢‘</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">é”™è¯¯</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">å¤‡æ³¨</th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="tokenTableBody" class="divide-y divide-border">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gemini é…ç½®é¢æ¿ -->
        <div id="panelGemini" class="hidden">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid gap-4 grid-cols-2 md:grid-cols-4 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">API Key æ€»æ•°</p>
                    <h3 class="text-xl font-bold" id="geminiStatTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ´»è·ƒ Key</p>
                    <h3 class="text-xl font-bold text-green-600" id="geminiStatActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ€»è¯·æ±‚æ•°</p>
                    <h3 class="text-xl font-bold text-blue-600" id="geminiStatRequests">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ€»é”™è¯¯æ•°</p>
                    <h3 class="text-xl font-bold text-destructive" id="geminiStatErrors">-</h3>
                </div>
            </div>

            <!-- Gemini API Keys åˆ—è¡¨ -->
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Gemini API Keys</h3>
                    <div class="flex items-center gap-3">
                        <button onclick="refreshGeminiKeys()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="åˆ·æ–°">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                        <button onclick="openAddGeminiKeyModal()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span class="text-sm font-medium">æ–°å¢</span>
                        </button>
                    </div>
                </div>
                
                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">ID</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">API Key</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">å¤‡æ³¨</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">çŠ¶æ€</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">è¯·æ±‚æ•°</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">é”™è¯¯æ•°</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">æœ€åä½¿ç”¨</th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="geminiKeysTableBody" class="divide-y divide-border">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æ‰¹é‡æ·»åŠ è¯´æ˜ -->
            <div class="mt-6 rounded-lg border border-border bg-background p-6">
                <h3 class="text-lg font-semibold mb-4">æ‰¹é‡æ·»åŠ  API Keys</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium mb-2 block">API Keysï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                        <textarea id="batchGeminiKeys" rows="5" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="AIzaSy...&#10;AIzaSy...&#10;AIzaSy..."></textarea>
                        <p class="text-xs text-muted-foreground mt-1">æ¯è¡Œè¾“å…¥ä¸€ä¸ª API Keyï¼Œä»¥ AIza å¼€å¤´</p>
                    </div>
                    <button onclick="batchAddGeminiKeys()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">æ‰¹é‡æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- å…¶ä»–API Keyç®¡ç†é¢æ¿ -->
        <div id="panelApikeys" class="hidden">
            <div class="grid gap-4 grid-cols-2 md:grid-cols-6 mb-6" id="providerStats"></div>
            <div class="rounded-lg border border-border bg-background">
                <div class="p-4 border-b border-border flex items-center justify-between">
                    <h3 class="font-semibold">å…¶ä»–ä¾›åº”å•† API Keyï¼ˆå­—èŠ‚è·³åŠ¨ã€é˜¿é‡Œäº‘ã€MiniMaxã€Viduï¼‰</h3>
                    <div class="flex items-center gap-3">
                        <select id="providerFilter" onchange="filterProvider()" class="h-9 rounded-md border border-input bg-background px-3 text-sm">
                            <option value="">å…¨éƒ¨ä¾›åº”å•†</option>
                        </select>
                        <button onclick="openAddKeyModal()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            <span class="text-sm">æ·»åŠ  Key</span>
                        </button>
                    </div>
                </div>
                <div id="apiKeysList" class="divide-y divide-border"></div>
            </div>
        </div>

        <!-- Discordè´¦å·ç®¡ç†é¢æ¿ï¼ˆMidjourneyï¼‰ -->
        <div id="panelDiscord" class="hidden">
            <div class="grid gap-4 grid-cols-2 md:grid-cols-4 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">è´¦å·æ€»æ•°</p>
                    <h3 class="text-xl font-bold" id="discordStatTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ´»è·ƒè´¦å·</p>
                    <h3 class="text-xl font-bold text-green-600" id="discordStatActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ€»è¯·æ±‚æ•°</p>
                    <h3 class="text-xl font-bold text-blue-600" id="discordStatRequests">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">æ€»é”™è¯¯æ•°</p>
                    <h3 class="text-xl font-bold text-destructive" id="discordStatErrors">-</h3>
                </div>
            </div>
            <div class="rounded-lg border border-border bg-background">
                <div class="p-4 border-b border-border flex items-center justify-between">
                    <h3 class="font-semibold">Discord è´¦å·åˆ—è¡¨ï¼ˆMidjourneyï¼‰</h3>
                    <button onclick="openAddDiscordModal()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                        <svg class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span class="text-sm">æ·»åŠ è´¦å·</span>
                    </button>
                </div>
                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">ID</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">å¤‡æ³¨</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">User Token</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Guild ID</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Channel ID</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">çŠ¶æ€</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">è¯·æ±‚/é”™è¯¯</th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="discordAccountsTableBody" class="divide-y divide-border"></tbody>
                    </table>
                </div>
            </div>

            <!-- Midjourney å‘½ä»¤é…ç½® -->
            <div class="rounded-lg border border-border bg-background mt-6">
                <div class="p-4 border-b border-border">
                    <h3 class="font-semibold">Midjourney å‘½ä»¤é…ç½®</h3>
                    <p class="text-sm text-muted-foreground mt-1">Discord /imagine å‘½ä»¤çš„ IDï¼Œéœ€è¦ä» DevTools è·å–</p>
                </div>
                <div class="p-4 grid gap-4 md:grid-cols-2">
                    <div>
                        <label class="text-sm font-medium mb-2 block">Command ID</label>
                        <input id="cfgMjCommandId" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="å¦‚ï¼š938956540159881230">
                        <p class="text-xs text-muted-foreground mt-1">data.id çš„å€¼</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">Version ID</label>
                        <input id="cfgMjVersionId" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="å¦‚ï¼š1237876415471554623">
                        <p class="text-xs text-muted-foreground mt-1">data.version çš„å€¼</p>
                    </div>
                </div>
                <div class="p-4 border-t border-border">
                    <button onclick="saveMjConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ Discordè´¦å·å¼¹çª— -->
        <div id="addDiscordModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
            <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
                <div class="flex items-center justify-between p-5 border-b border-border">
                    <h3 class="text-lg font-semibold">æ·»åŠ  Discord è´¦å·</h3>
                    <button onclick="closeAddDiscordModal()" class="text-muted-foreground hover:text-foreground">Ã—</button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="text-sm font-medium mb-2 block">å¤‡æ³¨åç§°ï¼ˆå¯é€‰ï¼‰</label>
                        <input id="addDiscordName" type="text" placeholder="å¦‚ï¼šè´¦å·1" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">User Token <span class="text-destructive">*</span></label>
                        <textarea id="addDiscordToken" rows="2" placeholder="Discordç”¨æˆ·Token" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"></textarea>
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">Guild ID (æœåŠ¡å™¨ID) <span class="text-destructive">*</span></label>
                        <input id="addDiscordGuildId" type="text" placeholder="å¦‚ï¼š1234567890123456789" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono">
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">Channel ID (é¢‘é“ID) <span class="text-destructive">*</span></label>
                        <input id="addDiscordChannelId" type="text" placeholder="å¦‚ï¼š1234567890123456789" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono">
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                    <button onclick="closeAddDiscordModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                    <button onclick="submitAddDiscord()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- å¹³å°OSSé…ç½®é¢æ¿ -->
        <div id="panelOss" class="hidden">
            <div class="rounded-lg border border-border bg-background p-6">
                <h3 class="text-lg font-semibold mb-4">é˜¿é‡Œäº‘ OSS é…ç½®</h3>
                <p class="text-sm text-muted-foreground mb-6">é…ç½®å¹³å°é»˜è®¤çš„é˜¿é‡Œäº‘OSSï¼Œç”¨äºå­˜å‚¨AIç”Ÿæˆçš„å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘æ–‡ä»¶ã€‚ä½¿ç”¨å¹³å°OSSçš„ç§Ÿæˆ·å°†ä½¿ç”¨æ­¤é…ç½®ã€‚</p>
                <div class="grid gap-6 md:grid-cols-2">
                    <div>
                        <label class="text-sm font-medium mb-2 block">Region</label>
                        <input id="ossRegion" type="text" placeholder="å¦‚ oss-cn-beijing" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">Bucket</label>
                        <input id="ossBucket" type="text" placeholder="Bucketåç§°" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">AccessKey ID</label>
                        <input id="ossAccessKeyId" type="text" placeholder="AccessKey ID" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">AccessKey Secret</label>
                        <input id="ossAccessKeySecret" type="password" placeholder="AccessKey Secretï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-medium mb-2 block">è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰</label>
                        <input id="ossCustomDomain" type="text" placeholder="å¦‚ https://cdn.example.com" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div class="md:col-span-2 flex items-center gap-2">
                        <input id="ossIsActive" type="checkbox" class="h-4 w-4">
                        <label for="ossIsActive" class="text-sm">å¯ç”¨å¹³å°OSS</label>
                    </div>
                </div>
                <div class="mt-6 flex gap-3">
                    <button onclick="testOss()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-4">æµ‹è¯•è¿æ¥</button>
                    <button onclick="saveOss()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡ä¸­è½¬APIé…ç½®é¢æ¿ (ç»Ÿä¸€) -->
        <div id="panelProxyapi" class="hidden">
            <!-- è¯´æ˜å¡ç‰‡ -->
            <div class="rounded-lg border border-blue-200 bg-blue-50 p-4 mb-6">
                <h3 class="font-semibold text-blue-800 mb-2">ğŸ–¼ï¸ Gemini 3 Pro Image å›¾ç‰‡ç”Ÿæˆé€šé“é…ç½®</h3>
                <p class="text-sm text-blue-700 mb-2">ä¸º Gemini 3 Pro Image Preview æ¨¡å‹é€‰æ‹©å›¾ç‰‡ç”Ÿæˆé€šé“ï¼š</p>
                <ul class="text-sm text-blue-700 list-disc list-inside space-y-1">
                    <li><strong>åŸç”Ÿ Google API</strong> - ç›´æ¥è°ƒç”¨ Google Gemini APIï¼ˆéœ€é…ç½® Google API Keyï¼‰</li>
                    <li><strong>My API Key CC</strong> - æ¨èçš„ä¸­è½¬æœåŠ¡ï¼Œæ”¯æŒæ–‡ç”Ÿå›¾/å›¾ç”Ÿå›¾</li>
                    <li><strong>Future API</strong> - å¤‡ç”¨ä¸­è½¬æœåŠ¡</li>
                </ul>
            </div>

            <div class="rounded-lg border border-border bg-background p-6">
                <h3 class="text-lg font-semibold mb-6">é€šé“é€‰æ‹©</h3>
                <div class="space-y-6">
                    <!-- ä¸‰é€‰ä¸€é€šé“ -->
                    <div class="grid gap-4 md:grid-cols-3">
                        <label class="relative flex flex-col cursor-pointer p-4 rounded-lg border-2 border-border hover:border-primary/50 transition-colors" id="channelCardNative">
                            <input type="radio" name="imageProxyChannel" value="native" class="sr-only" onchange="onImageChannelChange()">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </div>
                                <span class="font-semibold">åŸç”Ÿ Google API</span>
                            </div>
                            <p class="text-xs text-muted-foreground">ç›´æ¥è°ƒç”¨ Google Gemini API</p>
                            <p class="text-xs text-muted-foreground mt-1">éœ€è¦é…ç½® Google API Key</p>
                        </label>

                        <label class="relative flex flex-col cursor-pointer p-4 rounded-lg border-2 border-border hover:border-primary/50 transition-colors" id="channelCardGemini3">
                            <input type="radio" name="imageProxyChannel" value="gemini3" class="sr-only" onchange="onImageChannelChange()">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </div>
                                <div>
                                    <span class="font-semibold">My API Key CC</span>
                                    <span class="ml-2 text-xs bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded">æ¨è</span>
                                </div>
                            </div>
                            <p class="text-xs text-muted-foreground">my.api-key.cc ä¸­è½¬æœåŠ¡</p>
                            <p class="text-xs text-muted-foreground mt-1">æ”¯æŒæ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ã€å¤šåˆ†è¾¨ç‡</p>
                        </label>

                        <label class="relative flex flex-col cursor-pointer p-4 rounded-lg border-2 border-border hover:border-primary/50 transition-colors" id="channelCardFuture">
                            <input type="radio" name="imageProxyChannel" value="future" class="sr-only" onchange="onImageChannelChange()">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                </div>
                                <span class="font-semibold">Future API</span>
                            </div>
                            <p class="text-xs text-muted-foreground">future-api.vodeshop.com</p>
                            <p class="text-xs text-muted-foreground mt-1">å¤‡ç”¨ä¸­è½¬æœåŠ¡</p>
                        </label>
                    </div>

                    <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
                    <div class="p-4 rounded-lg bg-muted">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-medium">å½“å‰ç”Ÿæ•ˆé€šé“</span>
                                <p class="text-xs text-muted-foreground mt-1">Gemini 3 Pro Image æ¨¡å‹ä½¿ç”¨æ­¤é€šé“ç”Ÿæˆå›¾ç‰‡</p>
                            </div>
                            <div id="imageChannelBadge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-gray-100 text-gray-700">åŠ è½½ä¸­...</div>
                        </div>
                    </div>

                    <hr class="border-border">

                    <!-- My API Key CC é…ç½®åŒºåŸŸ -->
                    <div id="gemini3ConfigSection" class="space-y-4">
                        <h4 class="text-sm font-semibold flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            My API Key CC é…ç½®
                        </h4>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">API åœ°å€</label>
                                <input id="gemini3BaseUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://my.api-key.cc">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">API Key</label>
                                <input id="gemini3ApiKey" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="è¾“å…¥API Keyï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">æ¨¡å‹åç§°</label>
                                <input id="gemini3Model" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" value="gemini-3-pro-image-preview">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveGemini3Config()" class="inline-flex items-center justify-center rounded-md bg-emerald-600 text-white hover:bg-emerald-700 h-8 px-3 text-sm">ä¿å­˜</button>
                            <button onclick="testGemini3Connection()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm">æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>

                    <hr class="border-border">

                    <!-- Future API é…ç½®åŒºåŸŸ -->
                    <div id="futureConfigSection" class="space-y-4">
                        <h4 class="text-sm font-semibold flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            Future API é…ç½®
                        </h4>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">API åœ°å€</label>
                                <input id="futureBaseUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://future-api.vodeshop.com">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">API Key</label>
                                <input id="futureApiKey" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="è¾“å…¥API Keyï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰">
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">2Kæ¨¡å‹æ˜ å°„</label>
                                <input id="futureModel2k" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" value="gemini-2.5-flash-image">
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">4Kæ¨¡å‹æ˜ å°„</label>
                                <input id="futureModel4k" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" value="gemini-2.5-flash-image">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveFutureConfig()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 h-8 px-3 text-sm">ä¿å­˜</button>
                        </div>
                    </div>

                    <hr class="border-border">

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div>
                        <h4 class="text-sm font-semibold mb-4">ä½¿ç”¨ç»Ÿè®¡</h4>
                        <div class="grid gap-4 md:grid-cols-3">
                            <div class="rounded-lg border border-border bg-background p-4">
                                <p class="text-sm font-medium text-muted-foreground mb-2">æ€»è¯·æ±‚æ•°</p>
                                <h3 class="text-xl font-bold text-blue-600" id="imageProxyStatRequests">-</h3>
                            </div>
                            <div class="rounded-lg border border-border bg-background p-4">
                                <p class="text-sm font-medium text-muted-foreground mb-2">é”™è¯¯æ•°</p>
                                <h3 class="text-xl font-bold text-destructive" id="imageProxyStatErrors">-</h3>
                            </div>
                            <div class="rounded-lg border border-border bg-background p-4">
                                <p class="text-sm font-medium text-muted-foreground mb-2">æœ€åä½¿ç”¨</p>
                                <h3 class="text-sm font-medium" id="imageProxyStatLastUsed">-</h3>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Soraä¸­è½¬APIé…ç½®é¢æ¿ -->
        <div id="panelSoraproxy" class="hidden">
            <!-- è¯´æ˜å¡ç‰‡ -->
            <div class="rounded-lg border border-purple-200 bg-purple-50 p-4 mb-6">
                <h3 class="font-semibold text-purple-800 mb-2">ğŸ¬ Soraä¸­è½¬APIé…ç½®</h3>
                <p class="text-sm text-purple-700 mb-2">é…ç½®ç¬¬ä¸‰æ–¹Soraè§†é¢‘ç”Ÿæˆä¸­è½¬APIæœåŠ¡ï¼ˆfuture-api.vodeshop.comï¼‰</p>
                <ul class="text-sm text-purple-700 list-disc list-inside space-y-1">
                    <li><code class="bg-purple-100 px-1 rounded">/v1/video/create</code> - åˆ›å»ºè§†é¢‘ï¼ˆæ”¯æŒå›¾ç‰‡ã€è§’è‰²ï¼‰</li>
                    <li><code class="bg-purple-100 px-1 rounded">/v1/video/query</code> - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</li>
                    <li><code class="bg-purple-100 px-1 rounded">/sora/v1/characters</code> - åˆ›å»ºè§’è‰²</li>
                </ul>
            </div>

            <div class="rounded-lg border border-border bg-background p-6">
                <h3 class="text-lg font-semibold mb-6">Soraä¸­è½¬é…ç½®</h3>
                <div class="space-y-6">
                    <!-- é€šé“é€‰æ‹© -->
                    <div>
                        <h4 class="text-sm font-semibold mb-3">è§†é¢‘ç”Ÿæˆé€šé“</h4>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="soraChannel" value="sora2api" class="w-4 h-4 text-primary" onchange="updateSoraChannelBadge()">
                                <span class="text-sm">ç›´è¿ sora2api</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="soraChannel" value="future-sora-api" class="w-4 h-4 text-primary" onchange="updateSoraChannelBadge()">
                                <span class="text-sm">ä¸­è½¬API (future-api)</span>
                            </label>
                            <span id="soraChannelBadge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-green-100 text-green-700">ç›´è¿ sora2api</span>
                        </div>
                    </div>

                    <hr class="border-border">

                    <!-- ä¸­è½¬APIé…ç½® -->
                    <div>
                        <h4 class="text-sm font-semibold mb-4">ä¸­è½¬APIæœåŠ¡é…ç½®</h4>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">API åœ°å€</label>
                                <input id="soraProxyBaseUrl" type="text" value="https://future-api.vodeshop.com" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://future-api.vodeshop.com">
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium mb-2 block">API Key</label>
                                <input id="soraProxyApiKey" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="è¾“å…¥Soraä¸­è½¬APIçš„å¯†é’¥ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰">
                            </div>
                        </div>
                    </div>

                    <!-- å¯ç”¨çŠ¶æ€ -->
                    <div class="flex items-center justify-between p-4 rounded-lg border border-border">
                        <div>
                            <span class="text-sm font-medium">å¯ç”¨Soraä¸­è½¬API</span>
                            <p class="text-xs text-muted-foreground mt-1">å…³é—­åï¼Œå³ä½¿é€‰æ‹©"ä¸­è½¬API"é€šé“ä¹Ÿä¼šä½¿ç”¨sora2api</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="soraProxyIsActive" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>

                    <!-- ä¿å­˜æŒ‰é’® -->
                    <div class="flex gap-3">
                        <button onclick="saveSoraProxyConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">ä¿å­˜é…ç½®</button>
                        <button onclick="loadSoraProxyConfig()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-4">åˆ·æ–°</button>
                        <button onclick="testSoraProxyConnection()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-4">æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ API Keyå¼¹çª— -->
        <div id="addKeyModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
            <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
                <div class="flex items-center justify-between p-5 border-b border-border">
                    <h3 class="text-lg font-semibold">æ·»åŠ  API Key</h3>
                    <button onclick="closeAddKeyModal()" class="text-muted-foreground hover:text-foreground">Ã—</button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="text-sm font-medium mb-2 block">ä¾›åº”å•†</label>
                        <select id="addKeyProvider" class="flex h-9 w-full rounded-md border border-input bg-background px-3 text-sm"></select>
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">API Key</label>
                        <textarea id="addKeyValue" rows="3" placeholder="è¾“å…¥ API Keyï¼Œå¤šä¸ªKeyæ¢è¡Œåˆ†éš”" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"></textarea>
                    </div>
                    <div>
                        <label class="text-sm font-medium mb-2 block">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                        <input id="addKeyName" type="text" placeholder="ä»…é¦–ä¸ªKeyç”Ÿæ•ˆ" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                    <button onclick="closeAddKeyModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                    <button onclick="submitAddKey()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿé…ç½®é¢æ¿ -->
        <div id="panelSettings" class="hidden">
            <div class="grid gap-6 lg:grid-cols-2">
                <!-- å®‰å…¨é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">å®‰å…¨é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">ç®¡ç†å‘˜ç”¨æˆ·å</label>
                            <input id="cfgAdminUsername" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                            <p class="text-xs text-muted-foreground mt-1">ç®¡ç†å‘˜ç”¨æˆ·å</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">æ—§å¯†ç </label>
                            <input id="cfgOldPassword" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="è¾“å…¥æ—§å¯†ç ">
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">æ–°å¯†ç </label>
                            <input id="cfgNewPassword" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="è¾“å…¥æ–°å¯†ç ">
                        </div>
                        <button onclick="updateAdminPassword()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">ä¿®æ”¹å¯†ç </button>
                    </div>
                </div>

                <!-- API å¯†é’¥é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">API å¯†é’¥é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">å½“å‰ API Key</label>
                            <input id="cfgCurrentAPIKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" readonly disabled>
                            <p class="text-xs text-muted-foreground mt-1">å½“å‰ä½¿ç”¨çš„ API Keyï¼ˆåªè¯»ï¼‰</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">æ–° API Key</label>
                            <input id="cfgNewAPIKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="è¾“å…¥æ–°çš„ API Key">
                            <p class="text-xs text-muted-foreground mt-1">ç”¨äºå®¢æˆ·ç«¯è°ƒç”¨ API çš„å¯†é’¥</p>
                        </div>
                        <button onclick="updateAPIKey()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">æ›´æ–° API Key</button>
                    </div>
                </div>

                <!-- ä»£ç†é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">ä»£ç†é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgProxyEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">å¯ç”¨ä»£ç†</span>
                            </label>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">ä»£ç†åœ°å€</label>
                            <input id="cfgProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="http://127.0.0.1:7890 æˆ– socks5://127.0.0.1:1080">
                            <p class="text-xs text-muted-foreground mt-1">æ”¯æŒ HTTP å’Œ SOCKS5 ä»£ç†</p>
                        </div>
                        <button onclick="saveProxyConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <!-- é”™è¯¯å¤„ç†é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">é”™è¯¯å¤„ç†é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">é”™è¯¯å°ç¦é˜ˆå€¼</label>
                            <input id="cfgErrorBan" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="3">
                            <p class="text-xs text-muted-foreground mt-1">Token è¿ç»­é”™è¯¯è¾¾åˆ°æ­¤æ¬¡æ•°åè‡ªåŠ¨ç¦ç”¨</p>
                        </div>
                        <button onclick="saveAdminConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <!-- ç¼“å­˜é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">ç¼“å­˜é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgCacheEnabled" class="h-4 w-4 rounded border-input" onchange="toggleCacheOptions()">
                                <span class="text-sm font-medium">å¯ç”¨ç¼“å­˜</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-1">å…³é—­åï¼Œç”Ÿæˆçš„å›¾ç‰‡å’Œè§†é¢‘å°†ç›´æ¥è¾“å‡ºåŸå§‹é“¾æ¥ï¼Œä¸ä¼šç¼“å­˜åˆ°æœ¬åœ°</p>
                        </div>

                        <!-- ç¼“å­˜é…ç½®é€‰é¡¹ -->
                        <div id="cacheOptions" style="display: none;" class="space-y-4 pt-4 border-t border-border">
                            <div>
                                <label class="text-sm font-medium mb-2 block">ç¼“å­˜è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input id="cfgCacheTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="7200" min="60" max="86400">
                                <p class="text-xs text-muted-foreground mt-1">æ–‡ä»¶ç¼“å­˜è¶…æ—¶æ—¶é—´ï¼ŒèŒƒå›´ï¼š60-86400 ç§’ï¼ˆ1åˆ†é’Ÿ-24å°æ—¶ï¼‰</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">ç¼“å­˜æ–‡ä»¶è®¿é—®åŸŸå</label>
                                <input id="cfgCacheBaseUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://yourdomain.com">
                                <p class="text-xs text-muted-foreground mt-1">ç•™ç©ºåˆ™ä½¿ç”¨æœåŠ¡å™¨åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://yourdomain.com</p>
                            </div>
                            <div id="cacheEffectiveUrl" class="rounded-md bg-muted p-3 hidden">
                                <p class="text-xs text-muted-foreground">
                                    <strong>ğŸŒ å½“å‰ç”Ÿæ•ˆçš„è®¿é—®åœ°å€ï¼š</strong><code id="cacheEffectiveUrlValue" class="bg-background px-1 py-0.5 rounded"></code>
                                </p>
                            </div>
                        </div>

                        <button onclick="saveCacheConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <!-- ç”Ÿæˆè¶…æ—¶é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">ç”Ÿæˆè¶…æ—¶é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">å›¾ç‰‡ç”Ÿæˆè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                            <input id="cfgImageTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="300" min="60" max="3600">
                            <p class="text-xs text-muted-foreground mt-1">å›¾ç‰‡ç”Ÿæˆè¶…æ—¶æ—¶é—´ï¼ŒèŒƒå›´ï¼š60-3600 ç§’ï¼ˆ1åˆ†é’Ÿ-1å°æ—¶ï¼‰ï¼Œè¶…æ—¶åè‡ªåŠ¨é‡Šæ”¾Tokené”</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">è§†é¢‘ç”Ÿæˆè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                            <input id="cfgVideoTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="1500" min="60" max="7200">
                            <p class="text-xs text-muted-foreground mt-1">è§†é¢‘ç”Ÿæˆè¶…æ—¶æ—¶é—´ï¼ŒèŒƒå›´ï¼š60-7200 ç§’ï¼ˆ1åˆ†é’Ÿ-2å°æ—¶ï¼‰ï¼Œè¶…æ—¶åè¿”å›ä¸Šæ¸¸APIè¶…æ—¶é”™è¯¯</p>
                        </div>
                        <button onclick="saveGenerationTimeout()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <!-- æ— æ°´å°æ¨¡å¼é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">æ— æ°´å°æ¨¡å¼é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgWatermarkFreeEnabled" class="h-4 w-4 rounded border-input" onchange="toggleWatermarkFreeOptions()">
                                <span class="text-sm font-medium">å¼€å¯æ— æ°´å°æ¨¡å¼</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">å¼€å¯åç”Ÿæˆçš„è§†é¢‘å°†ä¼šè¢«å‘å¸ƒåˆ°soraå¹³å°å¹¶ä¸”æå–è¿”å›æ— æ°´å°çš„è§†é¢‘ï¼Œåœ¨ç¼“å­˜åˆ°æœ¬åœ°åä¼šè‡ªåŠ¨åˆ é™¤å‘å¸ƒçš„è§†é¢‘</p>
                        </div>

                        <!-- è§£ææ–¹å¼é€‰æ‹© -->
                        <div id="watermarkFreeOptions" style="display: none;" class="space-y-4 pt-4 border-t border-border">
                            <div>
                                <label class="text-sm font-medium">è§£ææ–¹å¼</label>
                                <select id="cfgParseMethod" class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground" onchange="toggleCustomParseOptions()">
                                    <option value="third_party">ç¬¬ä¸‰æ–¹è§£æ</option>
                                    <option value="custom">è‡ªå®šä¹‰è§£ææ¥å£</option>
                                </select>
                            </div>

                            <!-- è‡ªå®šä¹‰è§£æé…ç½® -->
                            <div id="customParseOptions" style="display: none;" class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium">è§£ææœåŠ¡å™¨åœ°å€</label>
                                    <input type="text" id="cfgCustomParseUrl" placeholder="è¯·è¾“å…¥è§£ææœåŠ¡å™¨åœ°å€ (ä¾‹å¦‚: http://example.com)" class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground">
                                    <p class="text-xs text-muted-foreground mt-1"><a href="https://github.com/tibbar213/sora-downloader" target="_blank" class="text-blue-600 hover:text-blue-800 underline">éƒ¨ç½²è‡ªå®šä¹‰è§£ææœåŠ¡å™¨</a></p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium">è®¿é—®å¯†é’¥</label>
                                    <input type="password" id="cfgCustomParseToken" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥" class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground">
                                </div>
                            </div>
                        </div>

                        <button onclick="saveWatermarkFreeConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <!-- è°ƒè¯•é…ç½® -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">è°ƒè¯•é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgDebugEnabled" class="h-4 w-4 rounded border-input" onchange="toggleDebugMode()">
                                <span class="text-sm font-medium">å¯ç”¨è°ƒè¯•æ¨¡å¼</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">å¼€å¯åï¼Œè¯¦ç»†çš„ä¸Šæ¸¸APIè¯·æ±‚å’Œå“åº”æ—¥å¿—å°†å†™å…¥ <code class="bg-muted px-1 py-0.5 rounded">logs.txt</code> æ–‡ä»¶ï¼Œé‡å¯ç”Ÿæ•ˆ</p>
                        </div>
                        <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/20 p-3 border border-yellow-200 dark:border-yellow-800">
                            <p class="text-xs text-yellow-800 dark:text-yellow-200">
                                âš ï¸ <strong>æ³¨æ„ï¼š</strong>è°ƒè¯•æ¨¡å¼ä¼šäº§ç”Ÿéå¸¸éå¸¸å¤§é‡çš„æ—¥å¿—ï¼Œä»…é™Debugæ—¶å€™å¼€å¯ï¼Œå¦åˆ™ç£ç›˜boom
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯·æ±‚æ—¥å¿—é¢æ¿ -->
        <div id="panelLogs" class="hidden">
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">è¯·æ±‚æ—¥å¿—</h3>
                    <button onclick="refreshLogs()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="åˆ·æ–°">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>
                <div class="relative w-full overflow-auto max-h-[600px]">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-background">
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">æ“ä½œ</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Tokené‚®ç®±</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">çŠ¶æ€ç </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">è€—æ—¶(ç§’)</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-border">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- æ·»åŠ  Token æ¨¡æ€æ¡† -->
    <div id="addModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">æ·»åŠ  Token</h3>
                <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <!-- Access Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Access Token (AT) <span class="text-red-500">*</span></label>
                    <textarea id="addTokenAT" rows="3" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="è¯·è¾“å…¥ Access Token æˆ–ä½¿ç”¨ä¸‹æ–¹ ST/RT è½¬æ¢"></textarea>
                    <p class="text-xs text-muted-foreground">æ ¼å¼: eyJh... (JWTæ ¼å¼)</p>
                </div>

                <!-- Session Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Session Token (ST) <span class="text-muted-foreground text-xs">- å¯é€‰</span></label>
                    <div class="flex gap-2">
                        <textarea id="addTokenST" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="è¾“å…¥ Session Token åç‚¹å‡»è½¬æ¢"></textarea>
                        <button onclick="convertST2AT()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 px-4 whitespace-nowrap h-auto">
                            STâ†’AT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">ä»æµè§ˆå™¨ Cookie ä¸­è·å– __Secure-next-auth.session-token</p>
                </div>

                <!-- Refresh Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Refresh Token (RT) <span class="text-muted-foreground text-xs">- å¯é€‰</span></label>
                    <div class="flex gap-2">
                        <textarea id="addTokenRT" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="è¾“å…¥ Refresh Token åç‚¹å‡»è½¬æ¢"></textarea>
                        <button onclick="convertRT2AT()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 px-4 whitespace-nowrap h-auto">
                            RTâ†’AT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">ä»ç§»åŠ¨ç«¯æˆ–å…¶ä»–å®¢æˆ·ç«¯è·å–</p>
                    <p id="addRTRefreshHint" class="text-xs text-green-600 font-medium hidden">âœ“ RTå·²è¢«åˆ·æ–°ï¼Œå·²å¡«å…¥æ›´æ–°åçš„RT</p>
                </div>

                <!-- Remark -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">å¤‡æ³¨ <span class="text-muted-foreground text-xs">- å¯é€‰</span></label>
                    <input id="addTokenRemark" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯">
                </div>

                <!-- åŠŸèƒ½å¼€å…³ -->
                <div class="space-y-3 pt-2 border-t border-border">
                    <label class="text-sm font-medium">åŠŸèƒ½å¼€å…³</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenImageEnabled" checked class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">å¯ç”¨å›¾ç‰‡ç”Ÿæˆ</span>
                            </label>
                            <input type="number" id="addTokenImageConcurrency" value="-1" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="å¹¶å‘æ•°" title="å¹¶å‘æ•°é‡é™åˆ¶ï¼šè®¾ç½®åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ã€‚-1è¡¨ç¤ºä¸é™åˆ¶">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenVideoEnabled" checked class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">å¯ç”¨è§†é¢‘ç”Ÿæˆ</span>
                            </label>
                            <input type="number" id="addTokenVideoConcurrency" value="-1" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="å¹¶å‘æ•°" title="å¹¶å‘æ•°é‡é™åˆ¶ï¼šè®¾ç½®åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ã€‚-1è¡¨ç¤ºä¸é™åˆ¶">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeAddModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                <button id="addTokenBtn" onclick="submitAddToken()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="addTokenBtnText">æ·»åŠ </span>
                    <svg id="addTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ Token æ¨¡æ€æ¡† -->
    <div id="editModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">ç¼–è¾‘ Token</h3>
                <button onclick="closeEditModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <input type="hidden" id="editTokenId">

                <!-- Access Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Access Token (AT) <span class="text-red-500">*</span></label>
                    <textarea id="editTokenAT" rows="3" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="è¯·è¾“å…¥ Access Token æˆ–ä½¿ç”¨ä¸‹æ–¹ ST/RT è½¬æ¢"></textarea>
                    <p class="text-xs text-muted-foreground">æ ¼å¼: eyJh... (JWTæ ¼å¼)</p>
                </div>

                <!-- Session Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Session Token (ST) <span class="text-muted-foreground text-xs">- å¯é€‰</span></label>
                    <div class="flex gap-2">
                        <textarea id="editTokenST" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="è¾“å…¥ Session Token åç‚¹å‡»è½¬æ¢"></textarea>
                        <button onclick="convertEditST2AT()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 px-4 whitespace-nowrap h-auto">
                            STâ†’AT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">ä»æµè§ˆå™¨ Cookie ä¸­è·å– __Secure-next-auth.session-token</p>
                </div>

                <!-- Refresh Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Refresh Token (RT) <span class="text-muted-foreground text-xs">- å¯é€‰</span></label>
                    <div class="flex gap-2">
                        <textarea id="editTokenRT" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="è¾“å…¥ Refresh Token åç‚¹å‡»è½¬æ¢"></textarea>
                        <button onclick="convertEditRT2AT()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 px-4 whitespace-nowrap h-auto">
                            RTâ†’AT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">ä»ç§»åŠ¨ç«¯æˆ–å…¶ä»–å®¢æˆ·ç«¯è·å–</p>
                    <p id="editRTRefreshHint" class="text-xs text-green-600 font-medium hidden">âœ“ RTå·²è¢«åˆ·æ–°ï¼Œå·²å¡«å…¥æ›´æ–°åçš„RT</p>
                </div>

                <!-- Remark -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">å¤‡æ³¨ <span class="text-muted-foreground text-xs">- å¯é€‰</span></label>
                    <input id="editTokenRemark" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯">
                </div>

                <!-- åŠŸèƒ½å¼€å…³ -->
                <div class="space-y-3 pt-2 border-t border-border">
                    <label class="text-sm font-medium">åŠŸèƒ½å¼€å…³</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenImageEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">å¯ç”¨å›¾ç‰‡ç”Ÿæˆ</span>
                            </label>
                            <input type="number" id="editTokenImageConcurrency" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="å¹¶å‘æ•°" title="å¹¶å‘æ•°é‡é™åˆ¶ï¼šè®¾ç½®åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ã€‚-1è¡¨ç¤ºä¸é™åˆ¶">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenVideoEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">å¯ç”¨è§†é¢‘ç”Ÿæˆ</span>
                            </label>
                            <input type="number" id="editTokenVideoConcurrency" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="å¹¶å‘æ•°" title="å¹¶å‘æ•°é‡é™åˆ¶ï¼šè®¾ç½®åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ã€‚-1è¡¨ç¤ºä¸é™åˆ¶">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeEditModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                <button id="editTokenBtn" onclick="submitEditToken()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="editTokenBtnText">ä¿å­˜</span>
                    <svg id="editTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Token å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">å¯¼å…¥ Token</h3>
                <button onclick="closeImportModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">é€‰æ‹© JSON æ–‡ä»¶</label>
                    <input type="file" id="importFile" accept=".json" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    <p class="text-xs text-muted-foreground mt-1">é€‰æ‹©å¯¼å‡ºçš„ Token JSON æ–‡ä»¶è¿›è¡Œå¯¼å…¥</p>
                </div>
                <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                    <p class="text-xs text-blue-800 dark:text-blue-200">
                        <strong>è¯´æ˜ï¼š</strong>å¦‚æœé‚®ç®±å­˜åœ¨åˆ™ä¼šè¦†ç›–æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™ä¼šæ–°å¢
                    </p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeImportModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                <button id="importBtn" onclick="submitImportTokens()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="importBtnText">å¯¼å…¥</span>
                    <svg id="importBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ  Gemini Key æ¨¡æ€æ¡† -->
    <div id="addGeminiKeyModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">æ·»åŠ  Gemini API Key</h3>
                <button onclick="closeAddGeminiKeyModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">API Key</label>
                    <input id="addGeminiApiKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="AIzaSy...">
                    <p class="text-xs text-muted-foreground mt-1">Google Gemini API Keyï¼Œä»¥ AIza å¼€å¤´</p>
                </div>
                <div>
                    <label class="text-sm font-medium mb-2 block">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="addGeminiKeyName" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="ä¾‹å¦‚ï¼šè´¦å·1">
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeAddGeminiKeyModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">å–æ¶ˆ</button>
                <button onclick="submitAddGeminiKey()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        let allTokens=[];
        let allGeminiKeys=[];
        let allProviders=[];
        let allProviderKeys={};
        let currentProvider='';
        let allDiscordAccounts=[];
        const GEMINI_API_BASE = '';
        // åŠ¨æ€è®¾ç½® GATEWAY_API_BASEï¼šaiadmin åŸŸåæˆ– 8000 ç«¯å£è®¿é—®æ—¶æŒ‡å‘ ai åŸŸåæˆ– 9000 ç«¯å£
        const GATEWAY_API_BASE = (function() {
          const host = window.location.hostname;
          const port = window.location.port;
          const protocol = window.location.protocol;
          // é€šè¿‡ aiadmin å­åŸŸåè®¿é—®æ—¶ï¼ŒæŒ‡å‘ ai å­åŸŸå
          if (host.startsWith('aiadmin.')) {
            return protocol + '//' + host.replace('aiadmin.', 'ai.');
          }
          // é€šè¿‡ 8000 ç«¯å£ç›´æ¥è®¿é—®æ—¶ï¼ŒæŒ‡å‘ 9000 ç«¯å£
          if (port === '8000') {
            return protocol + '//' + host + ':9000';
          }
          // å…¶ä»–æƒ…å†µä½¿ç”¨åŒåŸŸ
          return '';
        })();
        const $=(id)=>document.getElementById(id),
        checkAuth=()=>{const t=localStorage.getItem('adminToken');return t||(location.href='/login',null),t},
        apiRequest=async(url,opts={})=>{const t=checkAuth();if(!t)return null;const r=await fetch(url,{...opts,headers:{...opts.headers,Authorization:`Bearer ${t}`,'Content-Type':'application/json'}});return r.status===401?(localStorage.removeItem('adminToken'),location.href='/login',null):r},
        loadStats=async()=>{try{const r=await apiRequest('/api/stats');if(!r)return;const d=await r.json();$('statTotal').textContent=d.total_tokens||0;$('statActive').textContent=d.active_tokens||0;$('statImages').textContent=(d.today_images||0)+'/'+(d.total_images||0);$('statVideos').textContent=(d.today_videos||0)+'/'+(d.total_videos||0);$('statErrors').textContent=(d.today_errors||0)+'/'+(d.total_errors||0)}catch(e){console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:',e)}},
        loadTokens=async()=>{try{const r=await apiRequest('/api/tokens');if(!r)return;allTokens=await r.json();renderTokens()}catch(e){console.error('åŠ è½½Tokenå¤±è´¥:',e)}},
        formatExpiry=exp=>{if(!exp)return'-';const d=new Date(exp),now=new Date(),diff=d-now;const dateStr=d.toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-');const timeStr=d.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',hour12:false});if(diff<0)return`<span class="text-red-600">${dateStr} ${timeStr}</span>`;const days=Math.floor(diff/864e5);if(days<7)return`<span class="text-orange-600">${dateStr} ${timeStr}</span>`;return`${dateStr} ${timeStr}`},
        formatPlanType=type=>{if(!type)return'-';const typeMap={'chatgpt_team':'Team','chatgpt_plus':'Plus','chatgpt_pro':'Pro','chatgpt_free':'Free'};return typeMap[type]||type},
        formatSora2=(t)=>{if(t.sora2_supported===true){const remaining=t.sora2_total_count-t.sora2_redeemed_count;const tooltipText=`é‚€è¯·ç : ${t.sora2_invite_code||'æ— '}\nå¯ç”¨æ¬¡æ•°: ${remaining}/${t.sora2_total_count}\nå·²ç”¨æ¬¡æ•°: ${t.sora2_redeemed_count}`;return`<div class="inline-flex items-center gap-1"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-green-50 text-green-700 cursor-pointer" title="${tooltipText}" onclick="copySora2Code('${t.sora2_invite_code||''}')">æ”¯æŒ</span><span class="text-xs text-muted-foreground" title="${tooltipText}">${remaining}/${t.sora2_total_count}</span></div>`}else if(t.sora2_supported===false){return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-gray-100 text-gray-700 cursor-pointer" title="ç‚¹å‡»ä½¿ç”¨é‚€è¯·ç æ¿€æ´»" onclick="openSora2Modal(${t.id})">ä¸æ”¯æŒ</span>`}else{return'-'}},
        formatPlanTypeWithTooltip=(t)=>{const tooltipText=t.subscription_end?`å¥—é¤åˆ°æœŸ: ${new Date(t.subscription_end).toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-')} ${new Date(t.subscription_end).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',hour12:false})}`:'';return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-blue-50 text-blue-700 cursor-pointer" title="${tooltipText||t.plan_title||'-'}">${formatPlanType(t.plan_type)}</span>`},
        formatSora2Remaining=(t)=>{if(t.sora2_supported===true){const remaining=t.sora2_remaining_count||0;return`<span class="text-xs">${remaining}</span>`}else{return'-'}},
        renderTokens=()=>{const tb=$('tokenTableBody');tb.innerHTML=allTokens.map(t=>{const imageDisplay=t.image_enabled?`${t.image_count||0}`:'-';const videoDisplay=(t.video_enabled&&t.sora2_supported)?`${t.video_count||0}`:'-';return`<tr><td class="py-2.5 px-3">${t.email}</td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${t.is_active?'bg-green-50 text-green-700':'bg-gray-100 text-gray-700'}">${t.is_active?'æ´»è·ƒ':'ç¦ç”¨'}</span></td><td class="py-2.5 px-3 text-xs">${formatExpiry(t.expiry_time)}</td><td class="py-2.5 px-3 text-xs">${formatPlanTypeWithTooltip(t)}</td><td class="py-2.5 px-3 text-xs">${formatSora2(t)}</td><td class="py-2.5 px-3">${formatSora2Remaining(t)}</td><td class="py-2.5 px-3">${imageDisplay}</td><td class="py-2.5 px-3">${videoDisplay}</td><td class="py-2.5 px-3">${t.error_count||0}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${t.remark||'-'}</td><td class="py-2.5 px-3 text-right"><button onclick="testToken(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs mr-1">æµ‹è¯•</button><button onclick="openEditModal(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-green-50 hover:text-green-700 h-7 px-2 text-xs mr-1">ç¼–è¾‘</button><button onclick="toggleToken(${t.id},${t.is_active})" class="inline-flex items-center justify-center rounded-md hover:bg-accent h-7 px-2 text-xs mr-1">${t.is_active?'ç¦ç”¨':'å¯ç”¨'}</button><button onclick="deleteToken(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive h-7 px-2 text-xs">åˆ é™¤</button></td></tr>`}).join('')},
        refreshTokens=async()=>{await loadTokens();await loadStats()},
        openAddModal=()=>$('addModal').classList.remove('hidden'),
        closeAddModal=()=>{$('addModal').classList.add('hidden');$('addTokenAT').value='';$('addTokenST').value='';$('addTokenRT').value='';$('addTokenRemark').value='';$('addTokenImageEnabled').checked=true;$('addTokenVideoEnabled').checked=true;$('addTokenImageConcurrency').value='-1';$('addTokenVideoConcurrency').value='-1';$('addRTRefreshHint').classList.add('hidden')},
        openEditModal=(id)=>{const token=allTokens.find(t=>t.id===id);if(!token)return showToast('Tokenä¸å­˜åœ¨','error');$('editTokenId').value=token.id;$('editTokenAT').value=token.token||'';$('editTokenST').value=token.st||'';$('editTokenRT').value=token.rt||'';$('editTokenRemark').value=token.remark||'';$('editTokenImageEnabled').checked=token.image_enabled!==false;$('editTokenVideoEnabled').checked=token.video_enabled!==false;$('editTokenImageConcurrency').value=token.image_concurrency||'-1';$('editTokenVideoConcurrency').value=token.video_concurrency||'-1';$('editModal').classList.remove('hidden')},
        closeEditModal=()=>{$('editModal').classList.add('hidden');$('editTokenId').value='';$('editTokenAT').value='';$('editTokenST').value='';$('editTokenRT').value='';$('editTokenRemark').value='';$('editTokenImageEnabled').checked=true;$('editTokenVideoEnabled').checked=true;$('editTokenImageConcurrency').value='';$('editTokenVideoConcurrency').value='';$('editRTRefreshHint').classList.add('hidden')},
        submitEditToken=async()=>{const id=parseInt($('editTokenId').value),at=$('editTokenAT').value.trim(),st=$('editTokenST').value.trim(),rt=$('editTokenRT').value.trim(),remark=$('editTokenRemark').value.trim(),imageEnabled=$('editTokenImageEnabled').checked,videoEnabled=$('editTokenVideoEnabled').checked,imageConcurrency=$('editTokenImageConcurrency').value?parseInt($('editTokenImageConcurrency').value):null,videoConcurrency=$('editTokenVideoConcurrency').value?parseInt($('editTokenVideoConcurrency').value):null;if(!id)return showToast('Token IDæ— æ•ˆ','error');if(!at)return showToast('è¯·è¾“å…¥ Access Token','error');const btn=$('editTokenBtn'),btnText=$('editTokenBtnText'),btnSpinner=$('editTokenBtnSpinner');btn.disabled=true;btnText.textContent='ä¿å­˜ä¸­...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest(`/api/tokens/${id}`,{method:'PUT',body:JSON.stringify({token:at,st:st||null,rt:rt||null,remark:remark||null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:imageConcurrency,video_concurrency:videoConcurrency})});if(!r){btn.disabled=false;btnText.textContent='ä¿å­˜';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeEditModal();await refreshTokens();showToast('Tokenæ›´æ–°æˆåŠŸ','success')}else{showToast('æ›´æ–°å¤±è´¥: '+(d.detail||d.message||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æ›´æ–°å¤±è´¥: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='ä¿å­˜';btnSpinner.classList.add('hidden')}},
        convertST2AT=async()=>{const st=$('addTokenST').value.trim();if(!st)return showToast('è¯·å…ˆè¾“å…¥ Session Token','error');try{showToast('æ­£åœ¨è½¬æ¢ STâ†’AT...','info');const r=await apiRequest('/api/tokens/st2at',{method:'POST',body:JSON.stringify({st:st})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('addTokenAT').value=d.access_token;showToast('è½¬æ¢æˆåŠŸï¼ATå·²è‡ªåŠ¨å¡«å…¥','success')}else{showToast('è½¬æ¢å¤±è´¥: '+(d.message||d.detail||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('è½¬æ¢å¤±è´¥: '+e.message,'error')}},
        convertRT2AT=async()=>{const rt=$('addTokenRT').value.trim();if(!rt)return showToast('è¯·å…ˆè¾“å…¥ Refresh Token','error');const hint=$('addRTRefreshHint');hint.classList.add('hidden');try{showToast('æ­£åœ¨è½¬æ¢ RTâ†’AT...','info');const r=await apiRequest('/api/tokens/rt2at',{method:'POST',body:JSON.stringify({rt:rt})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('addTokenAT').value=d.access_token;if(d.refresh_token){$('addTokenRT').value=d.refresh_token;hint.classList.remove('hidden');showToast('è½¬æ¢æˆåŠŸï¼ATå·²è‡ªåŠ¨å¡«å…¥ï¼ŒRTå·²è¢«åˆ·æ–°å¹¶æ›´æ–°','success')}else{showToast('è½¬æ¢æˆåŠŸï¼ATå·²è‡ªåŠ¨å¡«å…¥','success')}}else{showToast('è½¬æ¢å¤±è´¥: '+(d.message||d.detail||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('è½¬æ¢å¤±è´¥: '+e.message,'error')}},
        convertEditST2AT=async()=>{const st=$('editTokenST').value.trim();if(!st)return showToast('è¯·å…ˆè¾“å…¥ Session Token','error');try{showToast('æ­£åœ¨è½¬æ¢ STâ†’AT...','info');const r=await apiRequest('/api/tokens/st2at',{method:'POST',body:JSON.stringify({st:st})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('editTokenAT').value=d.access_token;showToast('è½¬æ¢æˆåŠŸï¼ATå·²è‡ªåŠ¨å¡«å…¥','success')}else{showToast('è½¬æ¢å¤±è´¥: '+(d.message||d.detail||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('è½¬æ¢å¤±è´¥: '+e.message,'error')}},
        convertEditRT2AT=async()=>{const rt=$('editTokenRT').value.trim();if(!rt)return showToast('è¯·å…ˆè¾“å…¥ Refresh Token','error');const hint=$('editRTRefreshHint');hint.classList.add('hidden');try{showToast('æ­£åœ¨è½¬æ¢ RTâ†’AT...','info');const r=await apiRequest('/api/tokens/rt2at',{method:'POST',body:JSON.stringify({rt:rt})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('editTokenAT').value=d.access_token;if(d.refresh_token){$('editTokenRT').value=d.refresh_token;hint.classList.remove('hidden');showToast('è½¬æ¢æˆåŠŸï¼ATå·²è‡ªåŠ¨å¡«å…¥ï¼ŒRTå·²è¢«åˆ·æ–°å¹¶æ›´æ–°','success')}else{showToast('è½¬æ¢æˆåŠŸï¼ATå·²è‡ªåŠ¨å¡«å…¥','success')}}else{showToast('è½¬æ¢å¤±è´¥: '+(d.message||d.detail||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('è½¬æ¢å¤±è´¥: '+e.message,'error')}},
        submitAddToken=async()=>{const at=$('addTokenAT').value.trim(),st=$('addTokenST').value.trim(),rt=$('addTokenRT').value.trim(),remark=$('addTokenRemark').value.trim(),imageEnabled=$('addTokenImageEnabled').checked,videoEnabled=$('addTokenVideoEnabled').checked,imageConcurrency=parseInt($('addTokenImageConcurrency').value)||(-1),videoConcurrency=parseInt($('addTokenVideoConcurrency').value)||(-1);if(!at)return showToast('è¯·è¾“å…¥ Access Token æˆ–ä½¿ç”¨ ST/RT è½¬æ¢','error');const btn=$('addTokenBtn'),btnText=$('addTokenBtnText'),btnSpinner=$('addTokenBtnSpinner');btn.disabled=true;btnText.textContent='æ·»åŠ ä¸­...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest('/api/tokens',{method:'POST',body:JSON.stringify({token:at,st:st||null,rt:rt||null,remark:remark||null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:imageConcurrency,video_concurrency:videoConcurrency})});if(!r){btn.disabled=false;btnText.textContent='æ·»åŠ ';btnSpinner.classList.add('hidden');return}if(r.status===409){const d=await r.json();const msg=d.detail||'Token å·²å­˜åœ¨';btn.disabled=false;btnText.textContent='æ·»åŠ ';btnSpinner.classList.add('hidden');if(confirm(msg+'\n\næ˜¯å¦åˆ é™¤æ—§ Token åé‡æ–°æ·»åŠ ï¼Ÿ')){const existingToken=allTokens.find(t=>t.token===at);if(existingToken){const deleted=await deleteToken(existingToken.id,true);if(deleted){showToast('æ­£åœ¨é‡æ–°æ·»åŠ ...','info');setTimeout(()=>submitAddToken(),500)}else{showToast('åˆ é™¤æ—§ Token å¤±è´¥','error')}}}return}const d=await r.json();if(d.success){closeAddModal();await refreshTokens();showToast('Tokenæ·»åŠ æˆåŠŸ','success')}else{showToast('æ·»åŠ å¤±è´¥: '+(d.detail||d.message||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æ·»åŠ å¤±è´¥: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='æ·»åŠ ';btnSpinner.classList.add('hidden')}},
        testToken=async(id)=>{try{showToast('æ­£åœ¨æµ‹è¯•Token...','info');const r=await apiRequest(`/api/tokens/${id}/test`,{method:'POST'});if(!r)return;const d=await r.json();if(d.success&&d.status==='success'){let msg=`Tokenæœ‰æ•ˆï¼ç”¨æˆ·: ${d.email||'æœªçŸ¥'}`;if(d.sora2_supported){const remaining=d.sora2_total_count-d.sora2_redeemed_count;msg+=`\nSora2: æ”¯æŒ (${remaining}/${d.sora2_total_count})`;if(d.sora2_remaining_count!==undefined){msg+=`\nå¯ç”¨æ¬¡æ•°: ${d.sora2_remaining_count}`}}showToast(msg,'success');await refreshTokens()}else{showToast(`Tokenæ— æ•ˆ: ${d.message||'æœªçŸ¥é”™è¯¯'}`,'error')}}catch(e){showToast('æµ‹è¯•å¤±è´¥: '+e.message,'error')}},
        toggleToken=async(id,isActive)=>{const action=isActive?'disable':'enable';try{const r=await apiRequest(`/api/tokens/${id}/${action}`,{method:'POST'});if(!r)return;const d=await r.json();d.success?(await refreshTokens(),showToast(isActive?'Tokenå·²ç¦ç”¨':'Tokenå·²å¯ç”¨','success')):showToast('æ“ä½œå¤±è´¥','error')}catch(e){showToast('æ“ä½œå¤±è´¥: '+e.message,'error')}},
        toggleTokenStatus=async(id,active)=>{try{const r=await apiRequest(`/api/tokens/${id}/status`,{method:'PUT',body:JSON.stringify({is_active:active})});if(!r)return;const d=await r.json();d.success?(await refreshTokens(),showToast('çŠ¶æ€æ›´æ–°æˆåŠŸ','success')):showToast('æ›´æ–°å¤±è´¥','error')}catch(e){showToast('æ›´æ–°å¤±è´¥: '+e.message,'error')}},
        deleteToken=async(id,skipConfirm=false)=>{if(!skipConfirm&&!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªTokenå—?'))return;try{const r=await apiRequest(`/api/tokens/${id}`,{method:'DELETE'});if(!r)return;const d=await r.json();if(d.success){await refreshTokens();if(!skipConfirm)showToast('åˆ é™¤æˆåŠŸ','success');return true}else{if(!skipConfirm)showToast('åˆ é™¤å¤±è´¥','error');return false}}catch(e){if(!skipConfirm)showToast('åˆ é™¤å¤±è´¥: '+e.message,'error');return false}},
        openImportModal=()=>{$('importModal').classList.remove('hidden');$('importFile').value=''},
        closeImportModal=()=>{$('importModal').classList.add('hidden');$('importFile').value=''},
        exportTokens=()=>{if(allTokens.length===0){showToast('æ²¡æœ‰Tokenå¯å¯¼å‡º','error');return}const exportData=allTokens.map(t=>({email:t.email,access_token:t.token,session_token:t.st||null,refresh_token:t.rt||null,is_active:t.is_active,image_enabled:t.image_enabled!==false,video_enabled:t.video_enabled!==false,image_concurrency:t.image_concurrency||(-1),video_concurrency:t.video_concurrency||(-1)}));const dataStr=JSON.stringify(exportData,null,2);const dataBlob=new Blob([dataStr],{type:'application/json'});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');link.href=url;link.download=`tokens_${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);showToast(`å·²å¯¼å‡º ${allTokens.length} ä¸ªToken`,'success')},
        submitImportTokens=async()=>{const fileInput=$('importFile');if(!fileInput.files||fileInput.files.length===0){showToast('è¯·é€‰æ‹©æ–‡ä»¶','error');return}const file=fileInput.files[0];if(!file.name.endsWith('.json')){showToast('è¯·é€‰æ‹©JSONæ–‡ä»¶','error');return}try{const fileContent=await file.text();const importData=JSON.parse(fileContent);if(!Array.isArray(importData)){showToast('JSONæ ¼å¼é”™è¯¯ï¼šåº”ä¸ºæ•°ç»„','error');return}if(importData.length===0){showToast('JSONæ–‡ä»¶ä¸ºç©º','error');return}const btn=$('importBtn'),btnText=$('importBtnText'),btnSpinner=$('importBtnSpinner');btn.disabled=true;btnText.textContent='å¯¼å…¥ä¸­...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest('/api/tokens/import',{method:'POST',body:JSON.stringify({tokens:importData})});if(!r){btn.disabled=false;btnText.textContent='å¯¼å…¥';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeImportModal();await refreshTokens();const msg=`å¯¼å…¥æˆåŠŸï¼æ–°å¢: ${d.added||0}, æ›´æ–°: ${d.updated||0}`;showToast(msg,'success')}else{showToast('å¯¼å…¥å¤±è´¥: '+(d.detail||d.message||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('å¯¼å…¥å¤±è´¥: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='å¯¼å…¥';btnSpinner.classList.add('hidden')}}catch(e){showToast('æ–‡ä»¶è§£æå¤±è´¥: '+e.message,'error')}},
        loadAdminConfig=async()=>{try{const r=await apiRequest('/api/admin/config');if(!r)return;const d=await r.json();$('cfgErrorBan').value=d.error_ban_threshold||3;$('cfgAdminUsername').value=d.admin_username||'admin';$('cfgCurrentAPIKey').value=d.api_key||'';$('cfgDebugEnabled').checked=d.debug_enabled||false}catch(e){console.error('åŠ è½½é…ç½®å¤±è´¥:',e)}},
        saveAdminConfig=async()=>{try{const r=await apiRequest('/api/admin/config',{method:'POST',body:JSON.stringify({error_ban_threshold:parseInt($('cfgErrorBan').value)||3})});if(!r)return;const d=await r.json();d.success?showToast('é…ç½®ä¿å­˜æˆåŠŸ','success'):showToast('ä¿å­˜å¤±è´¥','error')}catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}},
        updateAdminPassword=async()=>{const username=$('cfgAdminUsername').value.trim(),oldPwd=$('cfgOldPassword').value.trim(),newPwd=$('cfgNewPassword').value.trim();if(!oldPwd||!newPwd)return showToast('è¯·è¾“å…¥æ—§å¯†ç å’Œæ–°å¯†ç ','error');if(newPwd.length<4)return showToast('æ–°å¯†ç è‡³å°‘4ä¸ªå­—ç¬¦','error');try{const r=await apiRequest('/api/admin/password',{method:'POST',body:JSON.stringify({username:username||undefined,old_password:oldPwd,new_password:newPwd})});if(!r)return;const d=await r.json();if(d.success){showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•','success');setTimeout(()=>{localStorage.removeItem('adminToken');location.href='/login'},2000)}else{showToast('ä¿®æ”¹å¤±è´¥: '+(d.detail||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('ä¿®æ”¹å¤±è´¥: '+e.message,'error')}},
        updateAPIKey=async()=>{const newKey=$('cfgNewAPIKey').value.trim();if(!newKey)return showToast('è¯·è¾“å…¥æ–°çš„ API Key','error');if(newKey.length<6)return showToast('API Key è‡³å°‘6ä¸ªå­—ç¬¦','error');if(!confirm('ç¡®å®šè¦æ›´æ–° API Key å—ï¼Ÿæ›´æ–°åéœ€è¦é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨æ–°å¯†é’¥ã€‚'))return;try{const r=await apiRequest('/api/admin/apikey',{method:'POST',body:JSON.stringify({new_api_key:newKey})});if(!r)return;const d=await r.json();if(d.success){showToast('API Key æ›´æ–°æˆåŠŸ','success');$('cfgCurrentAPIKey').value=newKey;$('cfgNewAPIKey').value=''}else{showToast('æ›´æ–°å¤±è´¥: '+(d.detail||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æ›´æ–°å¤±è´¥: '+e.message,'error')}},
        toggleDebugMode=async()=>{const enabled=$('cfgDebugEnabled').checked;try{const r=await apiRequest('/api/admin/debug',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r)return;const d=await r.json();if(d.success){showToast(enabled?'è°ƒè¯•æ¨¡å¼å·²å¼€å¯':'è°ƒè¯•æ¨¡å¼å·²å…³é—­','success')}else{showToast('æ“ä½œå¤±è´¥: '+(d.detail||'æœªçŸ¥é”™è¯¯'),'error');$('cfgDebugEnabled').checked=!enabled}}catch(e){showToast('æ“ä½œå¤±è´¥: '+e.message,'error');$('cfgDebugEnabled').checked=!enabled}},
        loadProxyConfig=async()=>{try{const r=await apiRequest('/api/proxy/config');if(!r)return;const d=await r.json();$('cfgProxyEnabled').checked=d.proxy_enabled||false;$('cfgProxyUrl').value=d.proxy_url||''}catch(e){console.error('åŠ è½½ä»£ç†é…ç½®å¤±è´¥:',e)}},
        saveProxyConfig=async()=>{try{const r=await apiRequest('/api/proxy/config',{method:'POST',body:JSON.stringify({proxy_enabled:$('cfgProxyEnabled').checked,proxy_url:$('cfgProxyUrl').value.trim()})});if(!r)return;const d=await r.json();d.success?showToast('ä»£ç†é…ç½®ä¿å­˜æˆåŠŸ','success'):showToast('ä¿å­˜å¤±è´¥','error')}catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}},
        loadWatermarkFreeConfig=async()=>{try{const r=await apiRequest('/api/watermark-free/config');if(!r)return;const d=await r.json();$('cfgWatermarkFreeEnabled').checked=d.watermark_free_enabled||false;$('cfgParseMethod').value=d.parse_method||'third_party';$('cfgCustomParseUrl').value=d.custom_parse_url||'';$('cfgCustomParseToken').value=d.custom_parse_token||'';toggleWatermarkFreeOptions();toggleCustomParseOptions()}catch(e){console.error('åŠ è½½æ— æ°´å°æ¨¡å¼é…ç½®å¤±è´¥:',e)}},
        saveWatermarkFreeConfig=async()=>{try{const enabled=$('cfgWatermarkFreeEnabled').checked,parseMethod=$('cfgParseMethod').value,customUrl=$('cfgCustomParseUrl').value.trim(),customToken=$('cfgCustomParseToken').value.trim();if(enabled&&parseMethod==='custom'){if(!customUrl)return showToast('è¯·è¾“å…¥è§£ææœåŠ¡å™¨åœ°å€','error');if(!customToken)return showToast('è¯·è¾“å…¥è®¿é—®å¯†é’¥','error')}const r=await apiRequest('/api/watermark-free/config',{method:'POST',body:JSON.stringify({watermark_free_enabled:enabled,parse_method:parseMethod,custom_parse_url:customUrl||null,custom_parse_token:customToken||null})});if(!r)return;const d=await r.json();d.success?showToast('æ— æ°´å°æ¨¡å¼é…ç½®ä¿å­˜æˆåŠŸ','success'):showToast('ä¿å­˜å¤±è´¥','error')}catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}},
        toggleWatermarkFreeOptions=()=>{const enabled=$('cfgWatermarkFreeEnabled').checked;$('watermarkFreeOptions').style.display=enabled?'block':'none'},
        toggleCustomParseOptions=()=>{const method=$('cfgParseMethod').value;$('customParseOptions').style.display=method==='custom'?'block':'none'},
        toggleCacheOptions=()=>{const enabled=$('cfgCacheEnabled').checked;$('cacheOptions').style.display=enabled?'block':'none'},
        loadCacheConfig=async()=>{try{console.log('å¼€å§‹åŠ è½½ç¼“å­˜é…ç½®...');const r=await apiRequest('/api/cache/config');if(!r){console.error('APIè¯·æ±‚å¤±è´¥');return}const d=await r.json();console.log('ç¼“å­˜é…ç½®æ•°æ®:',d);if(d.success&&d.config){const enabled=d.config.enabled!==false;const timeout=d.config.timeout||7200;const baseUrl=d.config.base_url||'';const effectiveUrl=d.config.effective_base_url||'';console.log('è®¾ç½®ç¼“å­˜å¯ç”¨:',enabled);console.log('è®¾ç½®è¶…æ—¶æ—¶é—´:',timeout);console.log('è®¾ç½®åŸŸå:',baseUrl);console.log('ç”Ÿæ•ˆURL:',effectiveUrl);$('cfgCacheEnabled').checked=enabled;$('cfgCacheTimeout').value=timeout;$('cfgCacheBaseUrl').value=baseUrl;if(effectiveUrl){$('cacheEffectiveUrlValue').textContent=effectiveUrl;$('cacheEffectiveUrl').classList.remove('hidden')}else{$('cacheEffectiveUrl').classList.add('hidden')}toggleCacheOptions();console.log('ç¼“å­˜é…ç½®åŠ è½½æˆåŠŸ')}else{console.error('ç¼“å­˜é…ç½®æ•°æ®æ ¼å¼é”™è¯¯:',d)}}catch(e){console.error('åŠ è½½ç¼“å­˜é…ç½®å¤±è´¥:',e);showToast('åŠ è½½ç¼“å­˜é…ç½®å¤±è´¥: '+e.message,'error')}},
        loadGenerationTimeout=async()=>{try{console.log('å¼€å§‹åŠ è½½ç”Ÿæˆè¶…æ—¶é…ç½®...');const r=await apiRequest('/api/generation/timeout');if(!r){console.error('APIè¯·æ±‚å¤±è´¥');return}const d=await r.json();console.log('ç”Ÿæˆè¶…æ—¶é…ç½®æ•°æ®:',d);if(d.success&&d.config){const imageTimeout=d.config.image_timeout||300;const videoTimeout=d.config.video_timeout||1500;console.log('è®¾ç½®å›¾ç‰‡è¶…æ—¶:',imageTimeout);console.log('è®¾ç½®è§†é¢‘è¶…æ—¶:',videoTimeout);$('cfgImageTimeout').value=imageTimeout;$('cfgVideoTimeout').value=videoTimeout;console.log('ç”Ÿæˆè¶…æ—¶é…ç½®åŠ è½½æˆåŠŸ')}else{console.error('ç”Ÿæˆè¶…æ—¶é…ç½®æ•°æ®æ ¼å¼é”™è¯¯:',d)}}catch(e){console.error('åŠ è½½ç”Ÿæˆè¶…æ—¶é…ç½®å¤±è´¥:',e);showToast('åŠ è½½ç”Ÿæˆè¶…æ—¶é…ç½®å¤±è´¥: '+e.message,'error')}},
        saveCacheConfig=async()=>{const enabled=$('cfgCacheEnabled').checked,timeout=parseInt($('cfgCacheTimeout').value)||7200,baseUrl=$('cfgCacheBaseUrl').value.trim();console.log('ä¿å­˜ç¼“å­˜é…ç½®:',{enabled,timeout,baseUrl});if(timeout<60||timeout>86400)return showToast('ç¼“å­˜è¶…æ—¶æ—¶é—´å¿…é¡»åœ¨ 60-86400 ç§’ä¹‹é—´','error');if(baseUrl&&!baseUrl.startsWith('http://')&&!baseUrl.startsWith('https://'))return showToast('åŸŸåå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´','error');try{console.log('ä¿å­˜ç¼“å­˜å¯ç”¨çŠ¶æ€...');const r0=await apiRequest('/api/cache/enabled',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r0){console.error('ä¿å­˜ç¼“å­˜å¯ç”¨çŠ¶æ€è¯·æ±‚å¤±è´¥');return}const d0=await r0.json();console.log('ç¼“å­˜å¯ç”¨çŠ¶æ€ä¿å­˜ç»“æœ:',d0);if(!d0.success){console.error('ä¿å­˜ç¼“å­˜å¯ç”¨çŠ¶æ€å¤±è´¥:',d0);return showToast('ä¿å­˜ç¼“å­˜å¯ç”¨çŠ¶æ€å¤±è´¥','error')}console.log('ä¿å­˜è¶…æ—¶æ—¶é—´...');const r1=await apiRequest('/api/cache/config',{method:'POST',body:JSON.stringify({timeout:timeout})});if(!r1){console.error('ä¿å­˜è¶…æ—¶æ—¶é—´è¯·æ±‚å¤±è´¥');return}const d1=await r1.json();console.log('è¶…æ—¶æ—¶é—´ä¿å­˜ç»“æœ:',d1);if(!d1.success){console.error('ä¿å­˜è¶…æ—¶æ—¶é—´å¤±è´¥:',d1);return showToast('ä¿å­˜è¶…æ—¶æ—¶é—´å¤±è´¥','error')}console.log('ä¿å­˜åŸŸå...');const r2=await apiRequest('/api/cache/base-url',{method:'POST',body:JSON.stringify({base_url:baseUrl})});if(!r2){console.error('ä¿å­˜åŸŸåè¯·æ±‚å¤±è´¥');return}const d2=await r2.json();console.log('åŸŸåä¿å­˜ç»“æœ:',d2);if(d2.success){showToast('ç¼“å­˜é…ç½®ä¿å­˜æˆåŠŸ','success');console.log('ç­‰å¾…é…ç½®æ–‡ä»¶å†™å…¥å®Œæˆ...');await new Promise(r=>setTimeout(r,200));console.log('é‡æ–°åŠ è½½é…ç½®...');await loadCacheConfig()}else{console.error('ä¿å­˜åŸŸåå¤±è´¥:',d2);showToast('ä¿å­˜åŸŸåå¤±è´¥','error')}}catch(e){console.error('ä¿å­˜å¤±è´¥:',e);showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}},
        saveGenerationTimeout=async()=>{const imageTimeout=parseInt($('cfgImageTimeout').value)||300,videoTimeout=parseInt($('cfgVideoTimeout').value)||1500;console.log('ä¿å­˜ç”Ÿæˆè¶…æ—¶é…ç½®:',{imageTimeout,videoTimeout});if(imageTimeout<60||imageTimeout>3600)return showToast('å›¾ç‰‡è¶…æ—¶æ—¶é—´å¿…é¡»åœ¨ 60-3600 ç§’ä¹‹é—´','error');if(videoTimeout<60||videoTimeout>7200)return showToast('è§†é¢‘è¶…æ—¶æ—¶é—´å¿…é¡»åœ¨ 60-7200 ç§’ä¹‹é—´','error');try{const r=await apiRequest('/api/generation/timeout',{method:'POST',body:JSON.stringify({image_timeout:imageTimeout,video_timeout:videoTimeout})});if(!r){console.error('ä¿å­˜è¯·æ±‚å¤±è´¥');return}const d=await r.json();console.log('ä¿å­˜ç»“æœ:',d);if(d.success){showToast('ç”Ÿæˆè¶…æ—¶é…ç½®ä¿å­˜æˆåŠŸ','success');await new Promise(r=>setTimeout(r,200));await loadGenerationTimeout()}else{console.error('ä¿å­˜å¤±è´¥:',d);showToast('ä¿å­˜å¤±è´¥','error')}}catch(e){console.error('ä¿å­˜å¤±è´¥:',e);showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}},
        toggleATAutoRefresh=async()=>{try{const enabled=$('atAutoRefreshToggle').checked;const r=await apiRequest('/api/token-refresh/enabled',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r){$('atAutoRefreshToggle').checked=!enabled;return}const d=await r.json();if(d.success){showToast(enabled?'ATè‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨':'ATè‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨','success')}else{showToast('æ“ä½œå¤±è´¥: '+(d.detail||'æœªçŸ¥é”™è¯¯'),'error');$('atAutoRefreshToggle').checked=!enabled}}catch(e){showToast('æ“ä½œå¤±è´¥: '+e.message,'error');$('atAutoRefreshToggle').checked=!enabled}},
        loadATAutoRefreshConfig=async()=>{try{const r=await apiRequest('/api/token-refresh/config');if(!r)return;const d=await r.json();if(d.success&&d.config){$('atAutoRefreshToggle').checked=d.config.at_auto_refresh_enabled||false}else{console.error('ATè‡ªåŠ¨åˆ·æ–°é…ç½®æ•°æ®æ ¼å¼é”™è¯¯:',d)}}catch(e){console.error('åŠ è½½ATè‡ªåŠ¨åˆ·æ–°é…ç½®å¤±è´¥:',e)}},
        loadLogs=async()=>{try{const r=await apiRequest('/api/logs?limit=100');if(!r)return;const logs=await r.json();const tb=$('logsTableBody');tb.innerHTML=logs.map(l=>`<tr><td class="py-2.5 px-3">${l.operation}</td><td class="py-2.5 px-3"><span class="text-xs ${l.token_email?'text-blue-600':'text-muted-foreground'}">${l.token_email||'æœªçŸ¥'}</span></td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${l.status_code===200?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}">${l.status_code}</span></td><td class="py-2.5 px-3">${l.duration.toFixed(2)}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${l.created_at?new Date(l.created_at).toLocaleString('zh-CN'):'-'}</td></tr>`).join('')}catch(e){console.error('åŠ è½½æ—¥å¿—å¤±è´¥:',e)}},
        refreshLogs=async()=>{await loadLogs()},
        showToast=(m,t='info')=>{const d=document.createElement('div'),bc={success:'bg-green-600',error:'bg-destructive',info:'bg-primary'};d.className=`fixed bottom-4 right-4 ${bc[t]||bc.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50 animate-slide-up`;d.textContent=m;document.body.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity .3s';setTimeout(()=>d.parentNode&&document.body.removeChild(d),300)},2000)},
        logout=()=>{if(!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—?'))return;localStorage.removeItem('adminToken');location.href='/login'},
        switchTab=t=>{const cap=n=>n.charAt(0).toUpperCase()+n.slice(1);['tokens','apikeys','discord','oss','proxyapi','soraproxy','settings','logs'].forEach(n=>{const active=n===t;$(`panel${cap(n)}`).classList.toggle('hidden',!active);$(`tab${cap(n)}`).classList.toggle('border-primary',active);$(`tab${cap(n)}`).classList.toggle('text-primary',active);$(`tab${cap(n)}`).classList.toggle('border-transparent',!active);$(`tab${cap(n)}`).classList.toggle('text-muted-foreground',!active)});if(t==='settings'){loadAdminConfig();loadProxyConfig();loadWatermarkFreeConfig();loadCacheConfig();loadGenerationTimeout();loadATAutoRefreshConfig()}else if(t==='logs'){loadLogs()}else if(t==='apikeys'){loadProviderKeys()}else if(t==='discord'){loadDiscordAccounts();loadMjConfig()}else if(t==='oss'){loadOssConfig()}else if(t==='proxyapi'){loadImageProxyConfig()}else if(t==='soraproxy'){loadSoraProxyConfig()}},
        // ========== Gemini API Keys ç®¡ç† ==========
        geminiApiRequest=async(url,opts={})=>{try{const r=await fetch(`${GEMINI_API_BASE}${url}`,{...opts,headers:{...opts.headers,'Content-Type':'application/json'}});return r}catch(e){console.error('Gemini APIè¯·æ±‚å¤±è´¥:',e);return null}},
        loadGeminiStats=async()=>{try{const r=await geminiApiRequest('/api/gemini-keys/stats');if(!r)return;const d=await r.json();if(d.success&&d.stats){$('geminiStatTotal').textContent=d.stats.total||0;$('geminiStatActive').textContent=d.stats.active||0;$('geminiStatRequests').textContent=d.stats.total_requests||0;$('geminiStatErrors').textContent=d.stats.total_errors||0}}catch(e){console.error('åŠ è½½Geminiç»Ÿè®¡å¤±è´¥:',e)}},
        loadGeminiKeys=async()=>{try{const r=await geminiApiRequest('/api/gemini-keys');if(!r)return;const d=await r.json();if(d.success){allGeminiKeys=d.keys||[];renderGeminiKeys()}}catch(e){console.error('åŠ è½½Gemini Keyså¤±è´¥:',e)}},
        renderGeminiKeys=()=>{const tb=$('geminiKeysTableBody');if(!allGeminiKeys.length){tb.innerHTML='<tr><td colspan="8" class="py-8 text-center text-muted-foreground">æš‚æ—  API Keyï¼Œç‚¹å‡»ä¸Šæ–¹"æ–°å¢"æŒ‰é’®æ·»åŠ </td></tr>';return}tb.innerHTML=allGeminiKeys.map(k=>`<tr><td class="py-2.5 px-3">${k.id}</td><td class="py-2.5 px-3 font-mono text-xs">${k.api_key_masked||'***'}</td><td class="py-2.5 px-3 text-xs">${k.name||'-'}</td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${k.is_active?'bg-green-50 text-green-700':'bg-gray-100 text-gray-700'}">${k.is_active?'æ´»è·ƒ':'ç¦ç”¨'}</span></td><td class="py-2.5 px-3">${k.request_count||0}</td><td class="py-2.5 px-3">${k.error_count||0}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${k.last_used_at?new Date(k.last_used_at).toLocaleString('zh-CN'):'-'}</td><td class="py-2.5 px-3 text-right"><button onclick="testGeminiKey(${k.id})" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs mr-1">æµ‹è¯•</button><button onclick="toggleGeminiKey(${k.id})" class="inline-flex items-center justify-center rounded-md hover:bg-accent h-7 px-2 text-xs mr-1">${k.is_active?'ç¦ç”¨':'å¯ç”¨'}</button><button onclick="deleteGeminiKey(${k.id})" class="inline-flex items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive h-7 px-2 text-xs">åˆ é™¤</button></td></tr>`).join('')},
        refreshGeminiKeys=async()=>{await loadGeminiKeys();await loadGeminiStats()},
        openAddGeminiKeyModal=()=>{$('addGeminiKeyModal').classList.remove('hidden');$('addGeminiApiKey').value='';$('addGeminiKeyName').value=''},
        closeAddGeminiKeyModal=()=>$('addGeminiKeyModal').classList.add('hidden'),
        submitAddGeminiKey=async()=>{const apiKey=$('addGeminiApiKey').value.trim(),name=$('addGeminiKeyName').value.trim();if(!apiKey)return showToast('è¯·è¾“å…¥ API Key','error');if(!apiKey.startsWith('AIza'))return showToast('API Key æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä»¥ AIza å¼€å¤´','error');try{const r=await geminiApiRequest('/api/gemini-keys',{method:'POST',body:JSON.stringify({api_key:apiKey,name:name||null})});if(!r)return showToast('æ·»åŠ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){closeAddGeminiKeyModal();await refreshGeminiKeys();showToast('API Key æ·»åŠ æˆåŠŸ','success')}else{showToast('æ·»åŠ å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æ·»åŠ å¤±è´¥: '+e.message,'error')}},
        batchAddGeminiKeys=async()=>{const text=$('batchGeminiKeys').value.trim();if(!text)return showToast('è¯·è¾“å…¥ API Keys','error');const lines=text.split('\n').map(l=>l.trim()).filter(l=>l.startsWith('AIza'));if(!lines.length)return showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ API Keyï¼ˆéœ€ä»¥ AIza å¼€å¤´ï¼‰','error');try{const r=await geminiApiRequest('/api/gemini-keys/batch',{method:'POST',body:JSON.stringify({keys:lines})});if(!r)return showToast('æ·»åŠ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){$('batchGeminiKeys').value='';await refreshGeminiKeys();showToast(`æ‰¹é‡æ·»åŠ å®Œæˆï¼šæˆåŠŸ ${d.added}ï¼Œè·³è¿‡ ${d.skipped}`,'success')}else{showToast('æ·»åŠ å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æ·»åŠ å¤±è´¥: '+e.message,'error')}},
        testGeminiKey=async(id)=>{try{showToast('æ­£åœ¨æµ‹è¯•...','info');const r=await geminiApiRequest(`/api/gemini-keys/${id}/test`,{method:'POST'});if(!r)return showToast('æµ‹è¯•å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){showToast(d.message||'Key æœ‰æ•ˆ','success')}else{showToast('Key æ— æ•ˆ: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æµ‹è¯•å¤±è´¥: '+e.message,'error')}},
        toggleGeminiKey=async(id)=>{try{const r=await geminiApiRequest(`/api/gemini-keys/${id}/toggle`,{method:'POST'});if(!r)return showToast('æ“ä½œå¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){await refreshGeminiKeys();showToast(d.is_active?'Key å·²å¯ç”¨':'Key å·²ç¦ç”¨','success')}else{showToast('æ“ä½œå¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æ“ä½œå¤±è´¥: '+e.message,'error')}},
        deleteGeminiKey=async(id)=>{if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª API Key å—?'))return;try{const r=await geminiApiRequest(`/api/gemini-keys/${id}`,{method:'DELETE'});if(!r)return showToast('åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){await refreshGeminiKeys();showToast('åˆ é™¤æˆåŠŸ','success')}else{showToast('åˆ é™¤å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('åˆ é™¤å¤±è´¥: '+e.message,'error')}},
        // ========== å…¶ä»–ä¾›åº”å•† API Keys ç®¡ç† ==========
        gatewayApiRequest=async(url,opts={})=>{try{const r=await fetch(`${GATEWAY_API_BASE}${url}`,{...opts,headers:{...opts.headers,'Content-Type':'application/json'}});return r}catch(e){console.error('Gateway APIè¯·æ±‚å¤±è´¥:',e);return null}},
        loadProviderKeys=async()=>{try{const[pRes,kRes,sRes]=await Promise.all([gatewayApiRequest('/api/provider-keys/providers'),gatewayApiRequest('/api/provider-keys'),gatewayApiRequest('/api/provider-keys/stats')]);const pData=await pRes.json(),kData=await kRes.json(),sData=await sRes.json();if(pData.success)allProviders=pData.providers;if(kData.success)allProviderKeys=kData.keys;renderProviderStats(sData.stats||{});renderProviderFilter();renderProviderKeys()}catch(e){console.error('åŠ è½½Provider Keyså¤±è´¥:',e)}},
        renderProviderStats=stats=>{$('providerStats').innerHTML=allProviders.map(p=>{const s=stats[p.id]||{total:0,active:0,requests:0};return`<div class="rounded-lg border border-border bg-background p-4"><p class="text-sm font-medium text-muted-foreground mb-1">${p.name}</p><h3 class="text-xl font-bold">${s.active||0}/<span class="text-muted-foreground">${s.total||0}</span></h3><p class="text-xs text-muted-foreground mt-1">è¯·æ±‚: ${s.requests||0}</p></div>`}).join('')},
        renderProviderFilter=()=>{$('providerFilter').innerHTML='<option value="">å…¨éƒ¨ä¾›åº”å•†</option>'+allProviders.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');$('addKeyProvider').innerHTML=allProviders.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')},
        filterProvider=()=>{currentProvider=$('providerFilter').value;renderProviderKeys()},
        renderProviderKeys=()=>{let html='';for(const p of allProviders){if(currentProvider&&p.id!==currentProvider)continue;const keys=allProviderKeys[p.id]||[];html+=`<div class="p-4"><div class="flex items-center justify-between mb-3"><h4 class="font-medium">${p.name} <span class="text-muted-foreground text-sm">(${keys.length})</span></h4></div>${keys.length?keys.map(k=>`<div class="flex items-center justify-between py-2 text-sm"><div class="flex items-center gap-3"><span class="font-mono text-xs bg-muted px-2 py-1 rounded">${k.api_key_masked}</span>${k.name?`<span class="text-muted-foreground">${k.name}</span>`:''}</div><div class="flex items-center gap-3"><span class="text-xs text-muted-foreground">è¯·æ±‚:${k.request_count}/é”™è¯¯:${k.error_count}</span><span class="text-xs ${k.is_active?'text-green-600':'text-red-600'}">${k.is_active?'å¯ç”¨':'ç¦ç”¨'}</span><button onclick="toggleProviderKey(${k.id})" class="text-xs text-primary hover:underline">${k.is_active?'ç¦ç”¨':'å¯ç”¨'}</button><button onclick="deleteProviderKey(${k.id})" class="text-xs text-destructive hover:underline">åˆ é™¤</button></div></div>`).join(''):`<p class="text-muted-foreground text-sm py-2">æš‚æ— Key</p>`}</div>`}$('apiKeysList').innerHTML=html||'<p class="p-4 text-muted-foreground">æš‚æ— æ•°æ®</p>'},
        openAddKeyModal=()=>{$('addKeyModal').classList.remove('hidden');$('addKeyValue').value='';$('addKeyName').value=''},
        closeAddKeyModal=()=>$('addKeyModal').classList.add('hidden'),
        submitAddKey=async()=>{const provider=$('addKeyProvider').value,keys=$('addKeyValue').value.trim(),name=$('addKeyName').value.trim();if(!keys){showToast('è¯·è¾“å…¥API Key','error');return}const keyList=keys.split('\n').map(k=>k.trim()).filter(k=>k);try{if(keyList.length===1){const r=await gatewayApiRequest('/api/provider-keys',{method:'POST',body:JSON.stringify({provider,api_key:keyList[0],name})});const d=await r.json();if(d.success){showToast('æ·»åŠ æˆåŠŸ','success');closeAddKeyModal();loadProviderKeys()}else showToast(d.error||'æ·»åŠ å¤±è´¥','error')}else{const r=await gatewayApiRequest('/api/provider-keys/batch',{method:'POST',body:JSON.stringify({provider,keys:keyList})});const d=await r.json();showToast(`æ·»åŠ ${d.added}ä¸ªï¼Œè·³è¿‡${d.skipped}ä¸ª`,'success');closeAddKeyModal();loadProviderKeys()}}catch(e){showToast('æ·»åŠ å¤±è´¥','error')}},
        toggleProviderKey=async id=>{try{await gatewayApiRequest(`/api/provider-keys/${id}/toggle`,{method:'POST'});loadProviderKeys()}catch(e){showToast('æ“ä½œå¤±è´¥','error')}},
        deleteProviderKey=async id=>{if(!confirm('ç¡®å®šåˆ é™¤?'))return;try{await gatewayApiRequest(`/api/provider-keys/${id}`,{method:'DELETE'});loadProviderKeys()}catch(e){showToast('åˆ é™¤å¤±è´¥','error')}},
        // ========== å›¾ç‰‡ä¸­è½¬APIç»Ÿä¸€é…ç½® ==========
        updateImageChannelUI=(channel)=>{
            ['Native','Gemini3','Future'].forEach(n=>{
                const card=$('channelCard'+n);
                if(card){
                    const isActive=(n==='Native'&&channel==='native')||(n==='Gemini3'&&channel==='gemini3')||(n==='Future'&&channel==='future');
                    card.classList.remove('border-primary','border-emerald-500','border-blue-500','bg-emerald-50','bg-blue-50','bg-green-50');
                    card.classList.add('border-border');
                    if(isActive){
                        card.classList.remove('border-border');
                        if(n==='Native'){card.classList.add('border-green-500','bg-green-50')}
                        else if(n==='Gemini3'){card.classList.add('border-emerald-500','bg-emerald-50')}
                        else if(n==='Future'){card.classList.add('border-blue-500','bg-blue-50')}
                    }
                    card.querySelector('input[type="radio"]').checked=isActive;
                }
            });
            const badge=$('imageChannelBadge');
            if(channel==='native'){badge.className='inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-green-100 text-green-700';badge.textContent='åŸç”Ÿ Google API'}
            else if(channel==='gemini3'){badge.className='inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-emerald-100 text-emerald-700';badge.textContent='My API Key CC'}
            else if(channel==='future'){badge.className='inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-blue-100 text-blue-700';badge.textContent='Future API'}
            else{badge.className='inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-green-100 text-green-700';badge.textContent='åŸç”Ÿ Google API'}
        },
        onImageChannelChange=async()=>{
            const selected=document.querySelector('input[name="imageProxyChannel"]:checked')?.value||'native';
            updateImageChannelUI(selected);
            try{
                if(selected==='native'){
                    await gatewayApiRequest('/api/gemini3-proxy-config',{method:'PUT',body:JSON.stringify({channel:'native',is_active:0})});
                    await gatewayApiRequest('/api/proxy-api-config',{method:'PUT',body:JSON.stringify({channel:'native',is_active:0})});
                }else if(selected==='gemini3'){
                    await gatewayApiRequest('/api/gemini3-proxy-config',{method:'PUT',body:JSON.stringify({channel:'proxy',is_active:1})});
                    await gatewayApiRequest('/api/proxy-api-config',{method:'PUT',body:JSON.stringify({channel:'native',is_active:0})});
                }else if(selected==='future'){
                    await gatewayApiRequest('/api/gemini3-proxy-config',{method:'PUT',body:JSON.stringify({channel:'native',is_active:0})});
                    await gatewayApiRequest('/api/proxy-api-config',{method:'PUT',body:JSON.stringify({channel:'proxy',is_active:1})});
                }
                showToast('é€šé“åˆ‡æ¢æˆåŠŸ','success');
            }catch(e){showToast('é€šé“åˆ‡æ¢å¤±è´¥: '+e.message,'error')}
        },
        loadImageProxyConfig=async()=>{
            try{
                const[g3Res,futureRes]=await Promise.all([gatewayApiRequest('/api/gemini3-proxy-config'),gatewayApiRequest('/api/proxy-api-config')]);
                let g3=null,future=null;
                try{g3=g3Res?await g3Res.json():null}catch(e){console.error('è§£ægemini3é…ç½®å¤±è´¥:',e)}
                try{future=futureRes?await futureRes.json():null}catch(e){console.error('è§£æfutureé…ç½®å¤±è´¥:',e)}
                let channel='native';
                if(g3&&g3.success&&g3.config&&g3.config.channel==='proxy'&&g3.config.is_active===1){channel='gemini3'}
                else if(future&&future.success&&future.config&&future.config.channel==='proxy'&&future.config.is_active===1){channel='future'}
                console.log('å½“å‰é€šé“:',channel,'g3:',g3,'future:',future);
                updateImageChannelUI(channel);
                if(g3&&g3.success&&g3.config){
                    $('gemini3BaseUrl').value=g3.config.base_url||'https://my.api-key.cc';
                    $('gemini3Model').value=g3.config.model||'gemini-3-pro-image-preview';
                    $('gemini3ApiKey').placeholder=g3.config.api_key_masked?`å·²ä¿å­˜: ${g3.config.api_key_masked}`:'è¾“å…¥API Keyï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰';
                    $('imageProxyStatRequests').textContent=g3.config.request_count||0;
                    $('imageProxyStatErrors').textContent=g3.config.error_count||0;
                    $('imageProxyStatLastUsed').textContent=g3.config.last_used_at?new Date(g3.config.last_used_at).toLocaleString():'ä»æœªä½¿ç”¨';
                }
                if(future&&future.success&&future.config){
                    $('futureBaseUrl').value=future.config.base_url||'https://future-api.vodeshop.com';
                    $('futureModel2k').value=future.config.model_2k||'gemini-2.5-flash-image';
                    $('futureModel4k').value=future.config.model_4k||'gemini-2.5-flash-image';
                    $('futureApiKey').placeholder=future.config.api_key_masked?`å·²ä¿å­˜: ${future.config.api_key_masked}`:'è¾“å…¥API Keyï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰';
                }
            }catch(e){console.error('åŠ è½½å›¾ç‰‡ä¸­è½¬é…ç½®å¤±è´¥:',e);updateImageChannelUI('native')}
        },
        saveGemini3Config=async()=>{
            const baseUrl=$('gemini3BaseUrl').value.trim();
            const model=$('gemini3Model').value.trim();
            const apiKey=$('gemini3ApiKey').value.trim();
            const body={base_url:baseUrl||'https://my.api-key.cc',model:model||'gemini-3-pro-image-preview',provider:'my-api-key-cc'};
            if(apiKey)body.api_key=apiKey;
            try{
                const r=await gatewayApiRequest('/api/gemini3-proxy-config',{method:'PUT',body:JSON.stringify(body)});
                if(!r)return showToast('ä¿å­˜å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');
                const d=await r.json();
                if(d.success){showToast('My API Key CC é…ç½®ä¿å­˜æˆåŠŸ','success');$('gemini3ApiKey').value='';await loadImageProxyConfig()}
                else showToast('ä¿å­˜å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error');
            }catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}
        },
        testGemini3Connection=async()=>{
            showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...','info');
            try{
                const r=await gatewayApiRequest('/api/gemini3-proxy-config/test',{method:'POST'});
                if(!r)return showToast('æµ‹è¯•å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');
                const d=await r.json();
                if(d.success){showToast(`è¿æ¥æˆåŠŸï¼Œå“åº”æ—¶é—´: ${d.duration}ms`,'success')}
                else showToast('è¿æ¥å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error');
            }catch(e){showToast('æµ‹è¯•å¤±è´¥: '+e.message,'error')}
        },
        saveFutureConfig=async()=>{
            const baseUrl=$('futureBaseUrl').value.trim();
            const model2k=$('futureModel2k').value.trim();
            const model4k=$('futureModel4k').value.trim();
            const apiKey=$('futureApiKey').value.trim();
            const body={base_url:baseUrl||'https://future-api.vodeshop.com',model_2k:model2k||'gemini-2.5-flash-image',model_4k:model4k||'gemini-2.5-flash-image'};
            if(apiKey)body.api_key=apiKey;
            try{
                const r=await gatewayApiRequest('/api/proxy-api-config',{method:'PUT',body:JSON.stringify(body)});
                if(!r)return showToast('ä¿å­˜å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');
                const d=await r.json();
                if(d.success){showToast('Future API é…ç½®ä¿å­˜æˆåŠŸ','success');$('futureApiKey').value='';await loadImageProxyConfig()}
                else showToast('ä¿å­˜å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error');
            }catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}
        },
        // ========== Soraä¸­è½¬APIé…ç½® ==========
        updateSoraChannelBadge=()=>{const channel=document.querySelector('input[name="soraChannel"]:checked')?.value||'sora2api';const badge=$('soraChannelBadge');if(channel==='future-sora-api'){badge.className='inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-purple-100 text-purple-700';badge.textContent='ä¸­è½¬API (future-api)'}else{badge.className='inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-green-100 text-green-700';badge.textContent='ç›´è¿ sora2api'}},
        loadSoraProxyConfig=async()=>{try{const r=await gatewayApiRequest('/api/sora-proxy-config');if(!r)return;const d=await r.json();if(d.success&&d.data){const config=d.data;$('soraProxyBaseUrl').value=config.base_url||'https://future-api.vodeshop.com';$('soraProxyIsActive').checked=!!config.is_active;const channel=config.channel||'sora2api';document.querySelectorAll('input[name="soraChannel"]').forEach(r=>{r.checked=r.value===channel});updateSoraChannelBadge()}}catch(e){console.error('åŠ è½½Soraä¸­è½¬é…ç½®å¤±è´¥:',e)}},
        saveSoraProxyConfig=async()=>{try{const channel=document.querySelector('input[name="soraChannel"]:checked')?.value||'sora2api';const baseUrl=$('soraProxyBaseUrl').value.trim();const apiKey=$('soraProxyApiKey').value.trim();const isActive=$('soraProxyIsActive').checked?1:0;const body={channel,base_url:baseUrl,is_active:isActive};if(apiKey)body.api_key=apiKey;const r=await gatewayApiRequest('/api/sora-proxy-config',{method:'PUT',body:JSON.stringify(body)});if(!r)return showToast('ä¿å­˜å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){showToast('Soraä¸­è½¬é…ç½®ä¿å­˜æˆåŠŸ','success');$('soraProxyApiKey').value='';await loadSoraProxyConfig()}else{showToast('ä¿å­˜å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}},
        testSoraProxyConnection=async()=>{try{showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...','info');const r=await gatewayApiRequest('/api/sora-proxy-config/test',{method:'POST'});if(!r)return showToast('æµ‹è¯•å¤±è´¥ï¼šç½‘ç»œé”™è¯¯','error');const d=await r.json();if(d.success){showToast('è¿æ¥æˆåŠŸ','success')}else{showToast('è¿æ¥å¤±è´¥: '+(d.error||'æœªçŸ¥é”™è¯¯'),'error')}}catch(e){showToast('æµ‹è¯•å¤±è´¥: '+e.message,'error')}},
        // ========== å¹³å°OSSé…ç½® ==========
        loadOssConfig=async()=>{try{const r=await gatewayApiRequest('/api/platform-oss');const d=await r.json();if(d.success&&d.config){$('ossRegion').value=d.config.region||'';$('ossBucket').value=d.config.bucket||'';$('ossAccessKeyId').value=d.config.access_key_id||'';$('ossCustomDomain').value=d.config.custom_domain||'';$('ossIsActive').checked=!!d.config.is_active}}catch(e){console.error('åŠ è½½OSSé…ç½®å¤±è´¥:',e)}},
        testOss=async()=>{const cfg={region:$('ossRegion').value,bucket:$('ossBucket').value,access_key_id:$('ossAccessKeyId').value,access_key_secret:$('ossAccessKeySecret').value};if(!cfg.region||!cfg.bucket||!cfg.access_key_id||!cfg.access_key_secret){showToast('è¯·å¡«å†™å®Œæ•´é…ç½®','error');return}try{const r=await gatewayApiRequest('/api/platform-oss/test',{method:'POST',body:JSON.stringify(cfg)});const d=await r.json();showToast(d.success?'è¿æ¥æˆåŠŸ':'è¿æ¥å¤±è´¥: '+d.error,d.success?'success':'error')}catch(e){showToast('æµ‹è¯•å¤±è´¥','error')}},
        saveOss=async()=>{const cfg={region:$('ossRegion').value,bucket:$('ossBucket').value,access_key_id:$('ossAccessKeyId').value,custom_domain:$('ossCustomDomain').value,is_active:$('ossIsActive').checked};const secret=$('ossAccessKeySecret').value;if(secret)cfg.access_key_secret=secret;try{const r=await gatewayApiRequest('/api/platform-oss',{method:'PUT',body:JSON.stringify(cfg)});const d=await r.json();showToast(d.success?'ä¿å­˜æˆåŠŸ':d.error||'ä¿å­˜å¤±è´¥',d.success?'success':'error')}catch(e){showToast('ä¿å­˜å¤±è´¥','error')}},
        // ========== Discord è´¦å·ç®¡ç†ï¼ˆMidjourneyï¼‰ ==========
        loadDiscordAccounts=async()=>{try{const[aRes,sRes]=await Promise.all([gatewayApiRequest('/api/discord-accounts'),gatewayApiRequest('/api/discord-accounts/stats')]);const aData=await aRes.json(),sData=await sRes.json();if(aData.success)allDiscordAccounts=aData.accounts||[];if(sData.success&&sData.stats){$('discordStatTotal').textContent=sData.stats.total||0;$('discordStatActive').textContent=sData.stats.active||0;$('discordStatRequests').textContent=sData.stats.total_requests||0;$('discordStatErrors').textContent=sData.stats.total_errors||0}renderDiscordAccounts()}catch(e){console.error('åŠ è½½Discordè´¦å·å¤±è´¥:',e)}},
        renderDiscordAccounts=()=>{const tb=$('discordAccountsTableBody');if(!allDiscordAccounts.length){tb.innerHTML='<tr><td colspan="8" class="py-8 text-center text-muted-foreground">æš‚æ—  Discord è´¦å·ï¼Œç‚¹å‡»"æ·»åŠ è´¦å·"æŒ‰é’®æ·»åŠ </td></tr>';return}tb.innerHTML=allDiscordAccounts.map(a=>`<tr><td class="py-2.5 px-3">${a.id}</td><td class="py-2.5 px-3 text-xs">${a.name||'-'}</td><td class="py-2.5 px-3 font-mono text-xs">${a.user_token_masked||'***'}</td><td class="py-2.5 px-3 font-mono text-xs">${a.guild_id}</td><td class="py-2.5 px-3 font-mono text-xs">${a.channel_id}</td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${a.is_active?'bg-green-50 text-green-700':'bg-gray-100 text-gray-700'}">${a.is_active?'æ´»è·ƒ':'ç¦ç”¨'}</span></td><td class="py-2.5 px-3 text-xs">${a.request_count||0}/${a.error_count||0}</td><td class="py-2.5 px-3 text-right"><button onclick="toggleDiscordAccount(${a.id})" class="inline-flex items-center justify-center rounded-md hover:bg-accent h-7 px-2 text-xs mr-1">${a.is_active?'ç¦ç”¨':'å¯ç”¨'}</button><button onclick="deleteDiscordAccount(${a.id})" class="inline-flex items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive h-7 px-2 text-xs">åˆ é™¤</button></td></tr>`).join('')},
        openAddDiscordModal=()=>{$('addDiscordModal').classList.remove('hidden');$('addDiscordName').value='';$('addDiscordToken').value='';$('addDiscordGuildId').value='';$('addDiscordChannelId').value=''},
        closeAddDiscordModal=()=>$('addDiscordModal').classList.add('hidden'),
        submitAddDiscord=async()=>{const name=$('addDiscordName').value.trim(),userToken=$('addDiscordToken').value.trim(),guildId=$('addDiscordGuildId').value.trim(),channelId=$('addDiscordChannelId').value.trim();if(!userToken||!guildId||!channelId){showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ','error');return}try{const r=await gatewayApiRequest('/api/discord-accounts',{method:'POST',body:JSON.stringify({name,user_token:userToken,guild_id:guildId,channel_id:channelId})});const d=await r.json();if(d.success){showToast('æ·»åŠ æˆåŠŸ','success');closeAddDiscordModal();loadDiscordAccounts()}else showToast(d.error||'æ·»åŠ å¤±è´¥','error')}catch(e){showToast('æ·»åŠ å¤±è´¥','error')}},
        toggleDiscordAccount=async id=>{try{await gatewayApiRequest(`/api/discord-accounts/${id}/toggle`,{method:'POST'});loadDiscordAccounts()}catch(e){showToast('æ“ä½œå¤±è´¥','error')}},
        deleteDiscordAccount=async id=>{if(!confirm('ç¡®å®šåˆ é™¤æ­¤Discordè´¦å·?'))return;try{await gatewayApiRequest(`/api/discord-accounts/${id}`,{method:'DELETE'});loadDiscordAccounts()}catch(e){showToast('åˆ é™¤å¤±è´¥','error')}},
        // ========== Midjourney é…ç½® ==========
        getMjConfigUrl=()=>GATEWAY_API_BASE,
        loadMjConfig=async()=>{try{const base=getMjConfigUrl();const[cmdRes,verRes]=await Promise.all([fetch(`${base}/api/config/mj_command_id`),fetch(`${base}/api/config/mj_version_id`)]);const cmdData=await cmdRes.json(),verData=await verRes.json();$('cfgMjCommandId').value=cmdData.value||'';$('cfgMjVersionId').value=verData.value||''}catch(e){console.error('åŠ è½½MJé…ç½®å¤±è´¥:',e)}},
        saveMjConfig=async()=>{const commandId=$('cfgMjCommandId').value.trim(),versionId=$('cfgMjVersionId').value.trim();if(!commandId||!versionId){showToast('è¯·å¡«å†™ Command ID å’Œ Version ID','error');return}try{const base=getMjConfigUrl();const[r1,r2]=await Promise.all([fetch(`${base}/api/config/mj_command_id`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:commandId})}),fetch(`${base}/api/config/mj_version_id`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:versionId})})]);const d1=await r1.json(),d2=await r2.json();if(d1.success&&d2.success){showToast('Midjourney é…ç½®ä¿å­˜æˆåŠŸ','success')}else{showToast('ä¿å­˜å¤±è´¥','error')}}catch(e){showToast('ä¿å­˜å¤±è´¥: '+e.message,'error')}};
        window.addEventListener('DOMContentLoaded',()=>{checkAuth();refreshTokens();loadATAutoRefreshConfig();loadImageProxyConfig()});
    </script>
</body>
</html>
